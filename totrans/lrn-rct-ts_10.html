<html><head></head><body>
		<div id="_idContainer154">
			<h1 id="_idParaDest-246" class="chapter-number"><a id="_idTextAnchor248"/>10</h1>
			<h1 id="_idParaDest-247"><a id="_idTextAnchor249"/>Interacting with GraphQL APIs</h1>
			<p>GraphQL APIs are web APIs that have a special language for interacting with them. These APIs are a very popular alternative to REST APIs with <span class="No-Break">React frontends.</span></p>
			<p>In this chapter, we’ll first understand the special GraphQL language, executing some basic queries on the GitHub GraphQL API. We will then build a React app that allows users to search for a GitHub repository and star it, experiencing the benefits of GraphQL <span class="No-Break">over REST.</span></p>
			<p>The app will use the browser’s <strong class="source-inline">fetch</strong> function with React Query to interact with the GitHub GraphQL API. We will then refactor the implementation of the app to use a specialized GraphQL client called <span class="No-Break"><strong class="bold">Apollo Client</strong></span><span class="No-Break">.</span></p>
			<p>We’ll cover the <span class="No-Break">following topics:</span></p>
			<ul>
				<li>Understanding the <span class="No-Break">GraphQL syntax</span></li>
				<li>Getting <span class="No-Break">set up</span></li>
				<li>Using the React Query <span class="No-Break">with fetch</span></li>
				<li>Using <span class="No-Break">Apollo Client</span></li>
			</ul>
			<h1 id="_idParaDest-248"><a id="_idTextAnchor250"/>Technical requirements</h1>
			<p>We will use the following technologies in <span class="No-Break">this chapter:</span></p>
			<ul>
				<li><strong class="bold">Node.js</strong> and <strong class="bold">npm</strong>: You can install them <span class="No-Break">at </span><a href="https://nodejs.org/en/download/"><span class="No-Break">https://nodejs.org/en/download/</span></a><span class="No-Break">.</span></li>
				<li><strong class="bold">Visual Studio Code</strong>: You can install it <span class="No-Break">at </span><a href="https://code.visualstudio.com/"><span class="No-Break">https://code.visualstudio.com/</span></a><span class="No-Break">.</span></li>
				<li><strong class="bold">GitHub</strong>: You’ll need a GitHub account. If you haven’t got an account, you can sign up at the following <span class="No-Break">link: </span><a href="https://github.com/join"><span class="No-Break">https://github.com/join</span></a><span class="No-Break">.</span></li>
				<li><strong class="bold">GitHub GraphQL API Explorer</strong>: We’ll use this tool to play with the syntax of GraphQL queries and mutations. The tool can be found <span class="No-Break">at </span><a href="https://docs.github.com/en/graphql/overview/explorer"><span class="No-Break">https://docs.github.com/en/graphql/overview/explorer</span></a><span class="No-Break">.</span></li>
			</ul>
			<p>All the code snippets in this chapter can be found online <span class="No-Break">at </span><a href="https://github.com/PacktPublishing/Learn-React-with-TypeScript-2nd-Edition/tree/main/Chapter10"><span class="No-Break">https://github.com/PacktPublishing/Learn-React-with-TypeScript-2nd-Edition/tree/main/Chapter10</span></a><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-249"><a id="_idTextAnchor251"/>Understanding the GraphQL syntax</h1>
			<p>Like React Query, GraphQL refers<a id="_idIndexMarker756"/> to a request to fetch data as a <strong class="bold">query</strong>. In the following<a id="_idIndexMarker757"/> subsections, we’ll learn how to write a basic GraphQL query that returns data <a id="_idIndexMarker758"/>from a couple of fields. These fields will have primitive values and so the result will be flat. We’ll then learn how to write a more advanced query containing object-based field values that have their own properties. Lastly, we will learn how to make queries more reusable <span class="No-Break">using parameters.</span></p>
			<h2 id="_idParaDest-250"><a id="_idTextAnchor252"/>Returning flat data</h2>
			<p>Carry out the following<a id="_idIndexMarker759"/> steps to use the GitHub GraphQL API Explorer to get information about your GitHub <span class="No-Break">user account:</span></p>
			<ol>
				<li>Open the following URL in a browser to open the GitHub GraphQL API <span class="No-Break">Explorer: </span><a href="https://docs.github.com/en/graphql/overview/explorer"><span class="No-Break">https://docs.github.com/en/graphql/overview/explorer</span></a><span class="No-Break">.</span></li>
				<li>Sign in using the <strong class="bold">Sign in with GitHub</strong> button if you aren’t signed in already. A GraphQL API Explorer page appears, <span class="No-Break">as follows:</span></li>
			</ol>
			<div>
				<div id="_idContainer141" class="IMG---Figure">
					<img src="image/B19051_10_01.jpg" alt="Figure 10.1 – GitHub GraphQL API Explorer"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.1 – GitHub GraphQL API Explorer</p>
			<ol>
				<li value="3">In the top-left panel<a id="_idIndexMarker760"/> of the GraphQL API Explorer, enter the <span class="No-Break">following query:</span><pre class="source-code">
query {</pre><pre class="source-code">
  viewer {</pre><pre class="source-code">
    name</pre><pre class="source-code">
  }</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>The query starts with the <strong class="source-inline">query</strong> keyword to specify that the operation is a query to fetch data (rather than update data). It is worth noting that the <strong class="source-inline">query</strong> keyword is optional because the operation defaults to <span class="No-Break">a query.</span></p>
			<p>After the operation, the data to be returned is specified by specifying the required objects and fields. In our example, we have specified that the <strong class="source-inline">name</strong> field in the <strong class="source-inline">viewer</strong> object <span class="No-Break">is returned.</span></p>
			<ol>
				<li value="4">Click the <strong class="bold">Execute Query</strong> button, which is the round button containing the <span class="No-Break">black triangle.</span></li>
			</ol>
			<p>The query result appears to the right of the query <span class="No-Break">as follows:</span></p>
			<div>
				<div id="_idContainer142" class="IMG---Figure">
					<img src="image/B19051_10_02.jpg" alt="Figure 10.2 – GitHub GraphQL"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.2 – GitHub GraphQL</p>
			<p>The data we requested is returned as a JSON object. The <strong class="source-inline">name</strong> field value should be your name stored in your <span class="No-Break">GitHub account.</span></p>
			<ol>
				<li value="5">On the right-hand side<a id="_idIndexMarker761"/> of the query results is <strong class="bold">Documentation Explorer</strong>. Expand this panel if it’s not <span class="No-Break">already expanded:</span></li>
			</ol>
			<div>
				<div id="_idContainer143" class="IMG---Figure">
					<img src="image/B19051_10_03.jpg" alt="Figure 10.3 – Documentation Explorer"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.3 – Documentation Explorer</p>
			<ol>
				<li value="6">Click on the <strong class="bold">Query</strong> link in <strong class="bold">Documentation Explorer</strong>. All the objects are shown that can be queried, including <strong class="source-inline">viewer</strong>, which is the one we just queried. The object type appears to the right of the object name, and the object description <span class="No-Break">appears underneath.</span></li>
			</ol>
			<p class="callout-heading">Note</p>
			<p class="callout">Like many languages, GraphQL’s fields have types – there are built-in types such as <strong class="source-inline">String</strong>, <strong class="source-inline">Int</strong>, and <strong class="source-inline">Boolean</strong>, as well as the ability to create custom types. See the following link for <a id="_idIndexMarker762"/>more <span class="No-Break">information: </span><a href="https://graphql.org/learn/schema/#type-language"><span class="No-Break">https://graphql.org/learn/schema/#type-language</span></a><span class="No-Break">.</span></p>
			<ol>
				<li value="7">Scroll down<a id="_idIndexMarker763"/> to the <strong class="source-inline">viewer</strong> object in <strong class="bold">Documentation Explorer</strong> (it should be right at <span class="No-Break">the bottom):</span></li>
			</ol>
			<div>
				<div id="_idContainer144" class="IMG---Figure">
					<img src="image/B19051_10_04.jpg" alt="Figure 10.4 – viewer object in Documentation Explorer"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.4 – viewer object in Documentation Explorer</p>
			<ol>
				<li value="8">Click on the <strong class="source-inline">User</strong> type next to the <strong class="source-inline">viewer</strong> object name in <strong class="bold">Documentation Explorer</strong>. All the fields available in the <strong class="source-inline">User</strong> type <span class="No-Break">are listed:</span></li>
			</ol>
			<div>
				<div id="_idContainer145" class="IMG---Figure">
					<img src="image/B19051_10_05.jpg" alt="Figure 10.5 – Fields in the User type"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.5 – Fields in the User type</p>
			<ol>
				<li value="9">Let’s add <strong class="source-inline">avatarUrl</strong> to our query, as this is an additional field<a id="_idIndexMarker764"/> available <span class="No-Break">to us:</span><pre class="source-code">
query {</pre><pre class="source-code">
  viewer {</pre><pre class="source-code">
    name</pre><pre class="source-code">
    <strong class="bold">avatarUrl</strong></pre><pre class="source-code">
  }</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>We simply add the <strong class="source-inline">avatarUrl</strong> field inside the <strong class="source-inline">viewer</strong> object with a carriage return between the <strong class="source-inline">name</strong> and <span class="No-Break"><strong class="source-inline">avatarUrl</strong></span><span class="No-Break"> fields.</span></p>
			<ol>
				<li value="10">The <strong class="source-inline">avatarUrl</strong> field is added to the JSON result if you execute the query. This should be a path to an image <span class="No-Break">of you:</span></li>
			</ol>
			<div>
				<div id="_idContainer146" class="IMG---Figure">
					<img src="image/B19051_10_06.jpg" alt="Figure 10.6 – Updated query result with avatarUrl"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.6 – Updated query result with avatarUrl</p>
			<p>That completes our first <span class="No-Break">graphQL query.</span></p>
			<ol>
				<li value="11">We are already<a id="_idIndexMarker765"/> seeing how flexible GraphQL is with being able to specify which fields we want to be returned in the response. Next, we’ll create another query that returns a <span class="No-Break">hierarchical structure.</span></li>
			</ol>
			<h2 id="_idParaDest-251"><a id="_idTextAnchor253"/>Returning hierarchical data</h2>
			<p>We will make a more complex<a id="_idIndexMarker766"/> query now by returning an object-based field rather than just fields with primitive values. This will mean the result will have a hierarchical structure rather than being flat. We’ll query for a GitHub repository, returning its name, description, and the number of stars it has. So, carry out the <span class="No-Break">following steps:</span></p>
			<ol>
				<li value="1">Start by entering the following query into the query panel of the GitHub GraphQL <span class="No-Break">API explorer:</span><pre class="source-code">
query {</pre><pre class="source-code">
  repository (owner:"facebook", name:"react") {</pre><pre class="source-code">
    id</pre><pre class="source-code">
    name</pre><pre class="source-code">
    description</pre><pre class="source-code">
  }</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>The query asks for the <strong class="source-inline">id</strong>, <strong class="source-inline">name</strong>, and <strong class="source-inline">description</strong> fields in the <strong class="source-inline">repository</strong> object. After the <strong class="source-inline">repository</strong> object is specified, two parameters for the <strong class="source-inline">owner</strong> and <strong class="source-inline">name</strong> of the repository <span class="No-Break">are specified.</span></p>
			<ol>
				<li value="2">Let’s now request the number<a id="_idIndexMarker767"/> of stars against the repository. To do this, add the <strong class="source-inline">totalCount</strong> field within the <strong class="source-inline">stargazers</strong> object <span class="No-Break">as follows:</span><pre class="source-code">
query {</pre><pre class="source-code">
  repository (owner:"facebook", name:"react") {</pre><pre class="source-code">
    id</pre><pre class="source-code">
    name</pre><pre class="source-code">
    description</pre><pre class="source-code">
    <strong class="bold">stargazers {</strong></pre><pre class="source-code">
<strong class="bold">      totalCount</strong></pre><pre class="source-code">
<strong class="bold">    }</strong></pre><pre class="source-code">
  }</pre><pre class="source-code">
}</pre></li>
				<li>If you execute the query, the result will appear like the <span class="No-Break">following screenshot:</span></li>
			</ol>
			<div>
				<div id="_idContainer147" class="IMG---Figure">
					<img src="image/B19051_10_07.jpg" alt="Figure 10.7 – Query for a specific repository"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.7 – Query for a specific repository</p>
			<p>That completes our second <span class="No-Break">GraphQL query.</span></p>
			<p>So, GraphQL allows us to make<a id="_idIndexMarker768"/> a single web request for different bits of data, returning just the fields that we require. Doing a similar thing with a REST API would probably require multiple requests and we’d get a lot more data than we need to return. It is in these types of queries where GraphQL shines <span class="No-Break">over REST.</span></p>
			<p>Next, we will learn how to allow query parameter values <span class="No-Break">to vary.</span></p>
			<h2 id="_idParaDest-252"><a id="_idTextAnchor254"/>Specifying query parameters</h2>
			<p>The query we <a id="_idIndexMarker769"/>have just made already has parameters for the repository name and owner. However, the <strong class="source-inline">owner</strong> parameter is hardcoded to have a value of <strong class="source-inline">"facebook"</strong>, and the <strong class="source-inline">name</strong> parameter to have a value <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">"react"</strong></span><span class="No-Break">.</span></p>
			<p>You may have noticed the <strong class="bold">QUERY VARIABLES</strong> panel under the query panel. This allows query parameter values to be specified. The query parameters then reference variable names instead of <span class="No-Break">hardcoded values.</span></p>
			<p>Carry out the following steps to adjust the repository query so that the query parameters <span class="No-Break">can vary:</span></p>
			<ol>
				<li value="1">Add the following query variables in the <strong class="bold">QUERY </strong><span class="No-Break"><strong class="bold">VARIABLES</strong></span><span class="No-Break"> panel:</span><pre class="source-code">
{</pre><pre class="source-code">
  "owner": "facebook",</pre><pre class="source-code">
  "name": "react"</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>As you can see, the variables are specified using JSON syntax. We have named the variable for the repository owner, <strong class="source-inline">owner</strong>, and the variable for the repository <span class="No-Break">name, </span><span class="No-Break"><strong class="source-inline">name</strong></span><span class="No-Break">.</span></p>
			<ol>
				<li value="2">Update the query to reference the query variables <span class="No-Break">as follows:</span><pre class="source-code">
query <strong class="bold">($owner: String!, $name: String!)</strong> {</pre><pre class="source-code">
  repository (owner:<strong class="bold">$owner</strong>, name:<strong class="bold">$name</strong>) {</pre><pre class="source-code">
    ...</pre><pre class="source-code">
  }</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>The query parameters are specified in parentheses after the <strong class="source-inline">query</strong> keyword. The parameter <a id="_idIndexMarker770"/>names must be prefixed with a dollar sign (<strong class="source-inline">$</strong>). The type for each parameter is specified after a colon (<strong class="source-inline">:</strong>) – both parameters are <strong class="source-inline">String</strong> in our case. The exclamation mark (<strong class="source-inline">!</strong>) after the type means it is a required query parameter. The parameters can then be referenced within the query, which, in our case, is where we request the <span class="No-Break">repository object.</span></p>
			<ol>
				<li value="3">If we execute the query, the JSON result will be the same as the query with the hardcoded repository owner and <span class="No-Break">name criteria.</span></li>
				<li>Now, change the variable values to target a different repository and rerun the query. The JSON result will contain the same fields but with values for the repository requested. The following is the query and result for the <span class="No-Break">TypeScript repository:</span></li>
			</ol>
			<div>
				<div id="_idContainer148" class="IMG---Figure">
					<img src="image/B19051_10_08.jpg" alt="Figure 10.8 – Query with parameters for the TypeScript repository"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.8 – Query with parameters for the TypeScript repository</p>
			<ol>
				<li value="5">We are now <a id="_idIndexMarker771"/>getting comfortable with reading data from a GraphQL server. Next, we’ll learn how to request changes to <span class="No-Break">GraphQL data.</span></li>
			</ol>
			<h2 id="_idParaDest-253"><a id="_idTextAnchor255"/>GraphQL mutations</h2>
			<p>A change to data in GraphQL is referred <a id="_idIndexMarker772"/>to as a <strong class="bold">mutation</strong>. Starring a repository is a change to the <a id="_idIndexMarker773"/>underlying data, so we can class this as an example of <span class="No-Break">a mutation.</span></p>
			<p>Carry out the following steps to create a mutation that stars a <span class="No-Break">GitHub repository:</span></p>
			<ol>
				<li value="1">In order to star a repository, we need the repository ID. So, copy the repository ID of the last query result into your clipboard. The following is the ID of the <span class="No-Break">TypeScript repository:</span><pre class="source-code">
"MDEwOlJlcG9zaXRvcnkyMDkyOTAyNQ=="</pre></li>
				<li>Replace the query variables with a variable for the repository ID we want <span class="No-Break">to star:</span><pre class="source-code">
{</pre><pre class="source-code">
  "repoId": "MDEwOlJlcG9zaXRvcnkyMDkyOTAyNQ=="</pre><pre class="source-code">
}</pre></li>
				<li>Replace the content in the query panel with the <span class="No-Break">following mutation:</span><pre class="source-code">
mutation ($repoId: ID!) {</pre><pre class="source-code">
  addStar(input: { starrableId: $repoId }) {</pre><pre class="source-code">
    starrable {</pre><pre class="source-code">
      stargazers {</pre><pre class="source-code">
        totalCount</pre><pre class="source-code">
      }</pre><pre class="source-code">
    }</pre><pre class="source-code">
  }</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>Let’s break <a id="_idIndexMarker774"/>down <span class="No-Break">this code:</span></p>
			<ul>
				<li>We prefix a mutation with the <span class="No-Break"><strong class="source-inline">mutation</strong></span><span class="No-Break"> keyword.</span></li>
				<li>We put parameters to be passed into the mutation after the <strong class="source-inline">mutation</strong> keyword in parentheses. In our case, we have a single parameter for the repository ID we want <span class="No-Break">to star.</span></li>
				<li><strong class="source-inline">addStar</strong> is the mutation function we call, which has a parameter called <strong class="source-inline">input</strong> that we need <span class="No-Break">to pass.</span></li>
				<li><strong class="source-inline">input</strong> is actually an object that has a field called <strong class="source-inline">starrableId</strong> that we need to include. The value of this is the repository ID we want to star, so we set it to our <strong class="source-inline">$repoId</strong> repository <span class="No-Break">ID variable.</span></li>
				<li>After the mutation parameters, we specify what we want to return in the response. In our case, we want to return the number of stars on <span class="No-Break">the repository.</span></li>
			</ul>
			<ol>
				<li value="4">If we execute the mutation, the star will be added to the repository, and the new total number of stars will <span class="No-Break">be returned:</span></li>
			</ol>
			<div>
				<div id="_idContainer149" class="IMG---Figure">
					<img src="image/B19051_10_09.jpg" alt="Figure 10.9 – Mutation to star the repository"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.9 – Mutation to star the repository</p>
			<p>That completes <a id="_idIndexMarker775"/>this section on getting comfortable with the GraphQL syntax. To recap, here are some <span class="No-Break">key points:</span></p>
			<ul>
				<li>A GraphQL query fetches data, and a mutation changes data. These operations are specified with the <strong class="source-inline">query</strong> and <strong class="source-inline">mutation</strong> <span class="No-Break">keywords, respectively.</span></li>
				<li>The data required in the response can be specified in the query/mutation, which helps the backend interactions <span class="No-Break">be efficient.</span></li>
				<li>Query parameter variables can be specified to allow a query/mutation to <span class="No-Break">be reusable.</span></li>
			</ul>
			<p>Next, we will set up a React project that will eventually interact with the GitHub <span class="No-Break">GraphQL API.</span></p>
			<h1 id="_idParaDest-254"><a id="_idTextAnchor256"/>Setting up the project</h1>
			<p>In this section, we will start <a id="_idIndexMarker776"/>by creating the project for the app we <a id="_idIndexMarker777"/>will build. We will build a React app that allows users to search for a GitHub repository and star it. It will use the GitHub GraphQL API, so we will generate a <strong class="bold">personal access token</strong> (<strong class="bold">PAT</strong>) for this and store it in an <span class="No-Break">environment variable.</span></p>
			<h2 id="_idParaDest-255"><a id="_idTextAnchor257"/>Creating the project</h2>
			<p>We will develop the app <a id="_idIndexMarker778"/>using Visual Studio Code and a new Create React App-based project setup. We’ve previously covered this several times, so we will not cover the steps in this chapter – instead, see <a href="B19051_03.xhtml#_idTextAnchor072"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, <em class="italic">Setting Up React </em><span class="No-Break"><em class="italic">and TypeScript</em></span><span class="No-Break">.</span></p>
			<p>We will style the app with Tailwind CSS. We have previously covered how to install and configure Tailwind in a Create React App in <a href="B19051_05.xhtml#_idTextAnchor127"><span class="No-Break"><em class="italic">Chapter 5</em></span></a>, <em class="italic">Approaches to Styling Frontends</em>. So, after you have created the React and TypeScript project, install and <span class="No-Break">configure Tailwind.</span></p>
			<p>We will use React Hook Form to implement the form that creates blog posts, and the <strong class="source-inline">@tailwindcss/forms</strong> plugin to style the form. So, install the <strong class="source-inline">@tailwindcss/forms</strong> plugin and React Hook Form (see <a href="B19051_07.xhtml#_idTextAnchor188"><span class="No-Break"><em class="italic">Chapter 7</em></span></a>, <em class="italic">Working with Forms,</em> if you can’t remember how to <span class="No-Break">do this).</span></p>
			<p>Now that the project is set up, next, we will gain access to the GitHub <span class="No-Break">GraphQL API.</span></p>
			<h2 id="_idParaDest-256"><a id="_idTextAnchor258"/>Creating a PAT for the GitHub GraphQL API</h2>
			<p>The GitHub GraphQL API <a id="_idIndexMarker779"/>is protected <a id="_idIndexMarker780"/>by a PAT, which is a string of characters <a id="_idIndexMarker781"/>and is a common mechanism for protecting web APIs. Carry out the following steps to generate <span class="No-Break">a PAT:</span></p>
			<ol>
				<li value="1">In a browser, go to <span class="No-Break">GitHub: </span><a href="https://github.com/"><span class="No-Break">https://github.com/</span></a><span class="No-Break">.</span></li>
				<li>Sign in to your GitHub account if you aren’t already signed in. You can create a GitHub account if you haven’t got one by using the <strong class="bold">Sign </strong><span class="No-Break"><strong class="bold">Up</strong></span><span class="No-Break"> button.</span></li>
				<li>Now, open the menu under your avatar and <span class="No-Break">click </span><span class="No-Break"><strong class="bold">Settings</strong></span><span class="No-Break">.</span></li>
				<li>Next, access the <strong class="bold">Developer Settings</strong> option at the bottom of the <span class="No-Break">left-hand bar.</span></li>
				<li>Go to the <strong class="bold">Personal access tokens</strong> page on the <span class="No-Break">left-hand bar.</span></li>
				<li>Click the <strong class="bold">Generate new token</strong> button to start creating the PAT. You will likely be prompted to input your password after clicking <span class="No-Break">the button.</span></li>
				<li>Before the <a id="_idIndexMarker782"/>token is generated, you will be asked to <a id="_idIndexMarker783"/>specify the scopes. Enter a token description, tick the repo and user scopes, and <a id="_idIndexMarker784"/>then click the <strong class="bold">Generate </strong><span class="No-Break"><strong class="bold">token</strong></span><span class="No-Break"> button.</span></li>
			</ol>
			<p>The token is then generated and displayed on the page. Take a copy of this because we’ll need this in the next section when building <span class="No-Break">our app.</span></p>
			<h2 id="_idParaDest-257"><a id="_idTextAnchor259"/>Creating environment variables</h2>
			<p>Before writing <a id="_idIndexMarker785"/>code that interacts with the <a id="_idIndexMarker786"/>GitHub GraphQL API, we will create environment variables for the API URL and <span class="No-Break">the PAT:</span></p>
			<ol>
				<li value="1">Let’s start by creating an environment file to store the URL for the GitHub GraphQL API. Create a file called <strong class="source-inline">.env</strong> in the root of the project containing this variable, <span class="No-Break">as follows:</span><pre class="source-code">
REACT_APP_GITHUB_URL = https://api.github.com/graphql</pre></li>
			</ol>
			<p>This environment variable is injected into the code at build time and can be accessed by code using <strong class="source-inline">process.env.REACT_APP_GITHUB_URL</strong>. Environment variables in Create React App projects must be prefixed <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">React_APP_</strong></span><span class="No-Break">.</span></p>
			<p>For more information on environment variables, see the following <span class="No-Break">link: </span><a href="https://create-react-app.dev/docs/adding-custom-environment-variables/"><span class="No-Break">https://create-react-app.dev/docs/adding-custom-environment-variables/</span></a><span class="No-Break">.</span></p>
			<ol>
				<li value="2">Now, we will create a second environment variable for the GitHub PAT token. However, we don’t want to commit this file to source code control, so place it in a file called <strong class="source-inline">.env.local</strong> at the root of <span class="No-Break">the project:</span><pre class="source-code">
REACT_APP_GITHUB_PAT = your-token</pre></li>
			</ol>
			<p><strong class="source-inline">.env.local</strong> is in the <strong class="source-inline">.gitignore</strong> file, so this file won’t get committed to source code control, reducing the risk of your PAT getting stolen. Replace <strong class="source-inline">your-token</strong> with your PAT token in the preceding <span class="No-Break">code snippet.</span></p>
			<p>That <a id="_idIndexMarker787"/>completes the creation of the <span class="No-Break">environment </span><span class="No-Break"><a id="_idIndexMarker788"/></span><span class="No-Break">variables.</span></p>
			<p>In the next section, we will start to build the app that will interact with the GitHub <span class="No-Break">GraphQL API.</span></p>
			<h1 id="_idParaDest-258"><a id="_idTextAnchor260"/>Using React Query with fetch</h1>
			<p>In this section, we <a id="_idIndexMarker789"/>will build an app containing a <a id="_idIndexMarker790"/>form that allows users to search and star GitHub repositories. The app will also have a header containing our name from GitHub. We will use the browser <strong class="source-inline">fetch</strong> function with React Query to interact with the GitHub GraphQL API. Let’s <span class="No-Break">get started.</span></p>
			<h2 id="_idParaDest-259"><a id="_idTextAnchor261"/>Creating the header</h2>
			<p>We will create the header <a id="_idIndexMarker791"/>for the app, which will contain our GitHub name. We will create a <strong class="source-inline">Header</strong> component containing this, which will be referenced from the <strong class="source-inline">App</strong> component. The <strong class="source-inline">Header</strong> component will use React Query to execute a function that gets our GitHub name calling the GitHub <span class="No-Break">GraphQL API.</span></p>
			<h3>Creating a function to get viewer information</h3>
			<p>Carry out the <a id="_idIndexMarker792"/>following steps to create a function that makes a request to the GitHub GraphQL API to get details about the <span class="No-Break">logged-in viewer:</span></p>
			<ol>
				<li value="1">We will start by creating a folder for the API calls. Create an <strong class="source-inline">api</strong> folder in the <span class="No-Break"><strong class="source-inline">src</strong></span><span class="No-Break"> folder.</span></li>
				<li>Now, we will create a type that the function will use. Create a file called <strong class="source-inline">types.ts</strong> in the <strong class="source-inline">src/api</strong> folder with the <span class="No-Break">following content:</span><pre class="source-code">
export type ViewerData = {</pre><pre class="source-code">
  name: string;</pre><pre class="source-code">
  avatarUrl: string;</pre><pre class="source-code">
};</pre></li>
			</ol>
			<p>This type represents the <span class="No-Break">logged-in viewer.</span></p>
			<ol>
				<li value="3">Create a file called <strong class="source-inline">getViewer.ts</strong> in the <strong class="source-inline">api</strong> folder that will contain the function <a id="_idIndexMarker793"/>we need to implement. Add an import statement for the type we <span class="No-Break">just created:</span><pre class="source-code">
import { ViewerData } from './types';</pre></li>
				<li>Under the import statement, add a constant assigned to the following <span class="No-Break">GraphQL query:</span><pre class="source-code">
export const GET_VIEWER_QUERY = `</pre><pre class="source-code">
  query {</pre><pre class="source-code">
    viewer {</pre><pre class="source-code">
      name</pre><pre class="source-code">
      avatarUrl</pre><pre class="source-code">
    }</pre><pre class="source-code">
  }</pre><pre class="source-code">
`;</pre></li>
			</ol>
			<p>This is the same query we used earlier in the chapter to get the current viewer’s name and <span class="No-Break">avatar URL.</span></p>
			<ol>
				<li value="5">Add the following type, which represents the response from the GraphQL API call within <span class="No-Break">this file:</span><pre class="source-code">
type GetViewerResponse = {</pre><pre class="source-code">
  data: {</pre><pre class="source-code">
    viewer: ViewerData;</pre><pre class="source-code">
  };</pre><pre class="source-code">
};</pre></li>
				<li>Start to implement the function <span class="No-Break">as follows:</span><pre class="source-code">
export async function getViewer() {</pre><pre class="source-code">
  const response = await fetch(</pre><pre class="source-code">
    process.env.REACT_APP_GITHUB_URL!</pre><pre class="source-code">
  );</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>We use the <strong class="source-inline">fetch</strong> function to make the request to the GraphQL API. We have used <a id="_idIndexMarker794"/>the <strong class="source-inline">REACT_APP_GITHUB_URL</strong> environment variable to specify the GraphQL API URL. Environment variable values can be <strong class="source-inline">undefined</strong>, but we know this isn’t the case, so we have added a not null assertion (<strong class="source-inline">!</strong>) <span class="No-Break">after it.</span></p>
			<ol>
				<li value="7">Specify the GraphQL query in the request body <span class="No-Break">as follows:</span><pre class="source-code">
export async function getViewer() {</pre><pre class="source-code">
  const response = await fetch(</pre><pre class="source-code">
    process.env.REACT_APP_GITHUB_URL!<strong class="bold">,</strong></pre><pre class="source-code">
<strong class="bold">    {</strong></pre><pre class="source-code">
<strong class="bold">      body: JSON.stringify({</strong></pre><pre class="source-code">
<strong class="bold">        query: GET_VIEWER_QUERY</strong></pre><pre class="source-code">
<strong class="bold">      }),</strong></pre><pre class="source-code">
<strong class="bold">      headers: {</strong></pre><pre class="source-code">
<strong class="bold">        'Content-Type': 'application/json'</strong></pre><pre class="source-code">
<strong class="bold">      }</strong></pre><pre class="source-code">
<strong class="bold">    }</strong></pre><pre class="source-code">
  );</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>GraphQL queries are specified in the request body in an object structure with a <strong class="source-inline">query</strong> property containing the GraphQL query string, which is <strong class="source-inline">GET_VIEWER_QUERY</strong> in our case. We have also specified that the request is in JSON format using the <strong class="source-inline">Content-Type</strong> <span class="No-Break">HTTP header.</span></p>
			<ol>
				<li value="8">The HTTP <strong class="source-inline">POST</strong> method must be used for GraphQL API requests. So, let’s specify this in <span class="No-Break">the request:</span><pre class="source-code">
export async function getViewer() {</pre><pre class="source-code">
  const response = await fetch(</pre><pre class="source-code">
    process.env.REACT_APP_GITHUB_URL!,</pre><pre class="source-code">
    {</pre><pre class="source-code">
      <strong class="bold">method: 'POST',</strong></pre><pre class="source-code">
      body: ...,</pre><pre class="source-code">
      headers: ...,</pre><pre class="source-code">
    }</pre><pre class="source-code">
  );</pre><pre class="source-code">
}</pre></li>
				<li>A PAT <a id="_idIndexMarker795"/>protects the GitHub GraphQL API, so let’s add this to <span class="No-Break">the request:</span><pre class="source-code">
export async function getViewer() {</pre><pre class="source-code">
  const response = await fetch(</pre><pre class="source-code">
    process.env.REACT_APP_GITHUB_URL!,</pre><pre class="source-code">
    {</pre><pre class="source-code">
      ...,</pre><pre class="source-code">
      headers: {</pre><pre class="source-code">
        'Content-Type': 'application/json',</pre><pre class="source-code">
<strong class="bold">        Authorization: `bearer ${process.env.REACT_APP_          GITHUB_PAT}`</strong></pre><pre class="source-code">
      },</pre><pre class="source-code">
    }</pre><pre class="source-code">
  );</pre><pre class="source-code">
}</pre></li>
				<li>The last steps in the function are to get the JSON response body and type it appropriately before <span class="No-Break">returning it:</span><pre class="source-code">
export async function getViewer() {</pre><pre class="source-code">
  const response = await fetch(</pre><pre class="source-code">
    ...</pre><pre class="source-code">
  );</pre><pre class="source-code">
  <strong class="bold">const body = (await response.json()) as unknown;</strong></pre><pre class="source-code">
<strong class="bold">  assertIsGetViewerResponse(body);</strong></pre><pre class="source-code">
<strong class="bold">  return body.data;</strong></pre><pre class="source-code">
}</pre></li>
				<li>We narrow <a id="_idIndexMarker796"/>the type of <strong class="source-inline">body</strong> using a type assertion function called <strong class="source-inline">assertIsGetViewerResponse</strong>. The implementation of this function is lengthy and follows the same pattern as the ones we implemented in <a href="B19051_09.xhtml#_idTextAnchor220"><span class="No-Break"><em class="italic">Chapter 9</em></span></a>, <em class="italic">Interacting with RESTful APIs</em>, so we won’t list it in this step, but see <a href="https://github.com/PacktPublishing/Learn-React-with-TypeScript-2nd-Edition/blob/main/Chapter10/Using-React-Query/src/api/getViewer.ts">https://github.com/PacktPublishing/Learn-React-with-TypeScript-2nd-Edition/blob/main/Chapter10/Using-React-Query/src/api/getViewer.ts</a> for the implementation of <span class="No-Break">this function.</span></li>
			</ol>
			<p>One difference is that the function’s parameter is of the <strong class="source-inline">any</strong> type rather than <strong class="source-inline">unknown</strong>. This is due to a known TypeScript issue of not being able to narrow the <strong class="source-inline">unknown</strong> type when it is an object. For more information on this, see the following <a id="_idIndexMarker797"/>link: <a href="https://github.com/microsoft/TypeScript/issues/25720">https://github.com/microsoft/TypeScript/issues/25720</a>. Using the <strong class="source-inline">any</strong> type is fine in this case – the <strong class="source-inline">assertIsGetViewerResponse</strong> function will work <span class="No-Break">perfectly fine.</span></p>
			<p>That completes the implementation of a function that gets the details of the logged-in <span class="No-Break">GitHub viewer.</span></p>
			<p>Next, we will create the component for <span class="No-Break">the header.</span></p>
			<h3>Creating the header component</h3>
			<p>We will create <a id="_idIndexMarker798"/>a component for the app header, which will call the <strong class="source-inline">getViewer</strong> function we just implemented and show the viewer’s name <span class="No-Break">and avatar:</span></p>
			<ol>
				<li value="1">We will use React Query to call <strong class="source-inline">getViewer</strong> and manage the data it returns. So, let’s start by installing this package by running the following command in <span class="No-Break">a terminal:</span><pre class="source-code">
npm i @tanstack/react-query</pre></li>
				<li>Create a file for the component called <strong class="source-inline">Header.tsx</strong> in the <span class="No-Break"><strong class="source-inline">src</strong></span><span class="No-Break"> folder.</span></li>
				<li>Add the following import statements in <strong class="source-inline">Header.tsx</strong> to import React Query’s <strong class="source-inline">useQuery</strong> hook and our <span class="No-Break"><strong class="source-inline">getViewer</strong></span><span class="No-Break"> function:</span><pre class="source-code">
import { useQuery } from '@tanstack/react-query';</pre><pre class="source-code">
import { getViewer } from './api/getViewer';</pre></li>
				<li>Start to implement the <strong class="source-inline">Header</strong> component <span class="No-Break">as follows:</span><pre class="source-code">
export function Header() {</pre><pre class="source-code">
  const { isLoading, data } = useQuery(['viewer'],     getViewer);</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>We use the <strong class="source-inline">useQuery</strong> hook to call <strong class="source-inline">getViewer</strong>. The data returned from <strong class="source-inline">getViewer</strong> will be in the destructured <strong class="source-inline">data</strong> variable. We have also destructured an <strong class="source-inline">isLoading</strong> variable to implement a loading indicator in the <span class="No-Break">next step.</span></p>
			<ol>
				<li value="5">Add a <a id="_idIndexMarker799"/>loading indicator <span class="No-Break">as follows:</span><pre class="source-code">
export function Header() {</pre><pre class="source-code">
  const { isLoading, data } = useQuery(['viewer'],     getViewer);</pre><pre class="source-code">
  <strong class="bold">if (isLoading || data === undefined) {</strong></pre><pre class="source-code">
<strong class="bold">    return &lt;div&gt;...&lt;/div&gt;;</strong></pre><pre class="source-code">
<strong class="bold">  }</strong></pre><pre class="source-code">
}</pre></li>
				<li>Finish the component implementation with the <span class="No-Break">following JSX:</span><pre class="source-code">
export function Header() {</pre><pre class="source-code">
  ...</pre><pre class="source-code">
  <strong class="bold">return (</strong></pre><pre class="source-code">
<strong class="bold">    &lt;header className="flex flex-col items-center text-      slate-50 bg-slate-900 h-40 p-5"&gt;</strong></pre><pre class="source-code">
<strong class="bold">      &lt;img</strong></pre><pre class="source-code">
<strong class="bold">        src={data.viewer.avatarUrl}</strong></pre><pre class="source-code">
<strong class="bold">        alt="Viewer"</strong></pre><pre class="source-code">
<strong class="bold">        className="rounded-full w-16 h-16"</strong></pre><pre class="source-code">
<strong class="bold">      /&gt;</strong></pre><pre class="source-code">
<strong class="bold">      &lt;div&gt;{data.viewer.name}&lt;/div&gt;</strong></pre><pre class="source-code">
<strong class="bold">      &lt;h1 className="text-xl font-bold"&gt;GitHub Search&lt;/        h1&gt;</strong></pre><pre class="source-code">
<strong class="bold">    &lt;/header&gt;</strong></pre><pre class="source-code">
<strong class="bold">  );</strong></pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>A <strong class="source-inline">header</strong> element with a very dark gray background is rendered. The <strong class="source-inline">header</strong> element <a id="_idIndexMarker800"/>contains the viewer’s avatar, name, and a heading of <strong class="bold">GitHub Search</strong>, all <span class="No-Break">horizontally centered.</span></p>
			<p>That completes the implementation of the header. Next, we will add it to the <span class="No-Break">component tree.</span></p>
			<h3>Adding the Header component to the app</h3>
			<p>Carry out <a id="_idIndexMarker801"/>the following steps to add <a id="_idIndexMarker802"/>the <strong class="source-inline">Header</strong> component to the <span class="No-Break"><strong class="source-inline">App</strong></span><span class="No-Break"> component:</span></p>
			<ol>
				<li value="1">Open <strong class="source-inline">App.tsx</strong> and remove all the <span class="No-Break">existing content.</span></li>
				<li>Add import statements for React Query’s provider component and client as well as our <span class="No-Break"><strong class="source-inline">Header</strong></span><span class="No-Break"> component:</span><pre class="source-code">
import {</pre><pre class="source-code">
  QueryClient,</pre><pre class="source-code">
  QueryClientProvider,</pre><pre class="source-code">
} from '@tanstack/react-query';</pre><pre class="source-code">
import { Header } from './Header';</pre></li>
				<li>Implement the component by wrapping React Query’s provider component around the <span class="No-Break"><strong class="source-inline">Header</strong></span><span class="No-Break"> component:</span><pre class="source-code">
const queryClient = new QueryClient();</pre><pre class="source-code">
function App() {</pre><pre class="source-code">
  return (</pre><pre class="source-code">
    &lt;QueryClientProvider client={queryClient}&gt;</pre><pre class="source-code">
      &lt;Header /&gt;</pre><pre class="source-code">
    &lt;/QueryClientProvider&gt;</pre><pre class="source-code">
  );</pre><pre class="source-code">
}</pre><pre class="source-code">
export default App;</pre></li>
				<li>Now, let’s <a id="_idIndexMarker803"/>try the app by running <strong class="source-inline">npm start</strong> in the terminal. A header containing your avatar and name <a id="_idIndexMarker804"/><span class="No-Break">should appear:</span></li>
			</ol>
			<div>
				<div id="_idContainer150" class="IMG---Figure">
					<img src="image/B19051_10_10.jpg" alt="Figure 10.10 – Header containing the viewer’s avatar and name"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.10 – Header containing the viewer’s avatar and name</p>
			<p>That completes the app header. Next, we will start to implement the main part of <span class="No-Break">the app.</span></p>
			<h2 id="_idParaDest-260"><a id="_idTextAnchor262"/>Creating the repository page</h2>
			<p>The main part <a id="_idIndexMarker805"/>of the app will be a page that allows a user to search for a GitHub repository <a id="_idIndexMarker806"/>and star it. The page component will be called <strong class="source-inline">RepoPage</strong> and will reference three other components, <span class="No-Break">as follows:</span></p>
			<div>
				<div id="_idContainer151" class="IMG---Figure">
					<img src="image/B19051_10_11.jpg" alt="Figure 10.11 – Repository page component structure"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.11 – Repository page component structure</p>
			<p>Here’s an explanation of <span class="No-Break">the components:</span></p>
			<ul>
				<li>The form that allows users to enter their search criteria will be contained in a <span class="No-Break"><strong class="source-inline">SearchRepoForm</strong></span><span class="No-Break"> component</span></li>
				<li>The <strong class="source-inline">FoundRepo</strong> component will <a id="_idIndexMarker807"/>render the matched repository after <span class="No-Break">a search</span></li>
				<li>The <strong class="source-inline">StarRepoButton</strong> component will render the button that the user can click to star <span class="No-Break">a repository</span></li>
				<li>The <strong class="source-inline">RepoPage</strong> component will use React Query to manage calls to the GitHub GraphQL API and store the <span class="No-Break">returned data</span></li>
			</ul>
			<p>Next, we <a id="_idIndexMarker808"/>will make a start on the repository page by implementing a function to do the <span class="No-Break">repository search.</span></p>
			<h3>Creating the search function</h3>
			<p>We will start by <a id="_idIndexMarker809"/>implementing the function <a id="_idIndexMarker810"/>that calls the GitHub GraphQL API to find a repository. Carry out the <span class="No-Break">following steps:</span></p>
			<ol>
				<li value="1">We will start by creating a couple of types that the function will use. Open <strong class="source-inline">src/api/types.ts</strong> and add the <span class="No-Break">following types:</span><pre class="source-code">
export type SearchCriteria = {</pre><pre class="source-code">
  org: string,</pre><pre class="source-code">
  repo: string,</pre><pre class="source-code">
};</pre><pre class="source-code">
export type RepoData = {</pre><pre class="source-code">
  repository: {</pre><pre class="source-code">
    id: string,</pre><pre class="source-code">
    name: string,</pre><pre class="source-code">
    description: string,</pre><pre class="source-code">
    viewerHasStarred: boolean,</pre><pre class="source-code">
    stargazers: {</pre><pre class="source-code">
      totalCount: number,</pre><pre class="source-code">
    },</pre><pre class="source-code">
  },</pre><pre class="source-code">
};</pre></li>
			</ol>
			<p>The <strong class="source-inline">SearchCriteria</strong> type represents the information we need in the GraphQL query parameters to find the GitHub repository. The <strong class="source-inline">RepoData</strong> type represents <a id="_idIndexMarker811"/>the data returned from <a id="_idIndexMarker812"/>the <span class="No-Break">repository search.</span></p>
			<ol>
				<li value="2">Create a file for the function called <strong class="source-inline">getRepo.ts</strong> in the <span class="No-Break"><strong class="source-inline">src/api</strong></span><span class="No-Break"> folder.</span></li>
				<li>Open <strong class="source-inline">getRepo.ts</strong> and start by importing the types <span class="No-Break">just created:</span><pre class="source-code">
import { RepoData, SearchCriteria } from './types';</pre></li>
				<li>Add a constant for the following <span class="No-Break">GraphQL query:</span><pre class="source-code">
export const GET_REPO = `</pre><pre class="source-code">
  query GetRepo($org: String!, $repo: String!) {</pre><pre class="source-code">
    repository(owner: $org, name: $repo) {</pre><pre class="source-code">
      id</pre><pre class="source-code">
      name</pre><pre class="source-code">
      description</pre><pre class="source-code">
      viewerHasStarred</pre><pre class="source-code">
      stargazers {</pre><pre class="source-code">
        totalCount</pre><pre class="source-code">
      }</pre><pre class="source-code">
    }</pre><pre class="source-code">
  }</pre><pre class="source-code">
`;</pre></li>
			</ol>
			<p>This is the <a id="_idIndexMarker813"/>same query we created <a id="_idIndexMarker814"/>earlier in the chapter in the GitHub GraphQL <span class="No-Break">API explorer.</span></p>
			<ol>
				<li value="5">Add the following type beneath <span class="No-Break">the constant:</span><pre class="source-code">
type GetRepoResponse = {</pre><pre class="source-code">
  data: RepoData;</pre><pre class="source-code">
};</pre></li>
			</ol>
			<p>The <strong class="source-inline">GetRepoResponse</strong> type represents the data returned from the GraphQL query – it references the <strong class="source-inline">RepoData</strong> type we created in <span class="No-Break"><em class="italic">step 1</em></span><span class="No-Break">.</span></p>
			<ol>
				<li value="6">Implement the function <span class="No-Break">as follows:</span><pre class="source-code">
export async function getRepo(searchCriteria: SearchCriteria) {</pre><pre class="source-code">
  const response = await fetch(process.env.REACT_APP_    GITHUB_URL!, {</pre><pre class="source-code">
    method: 'POST',</pre><pre class="source-code">
    body: JSON.stringify({</pre><pre class="source-code">
      query: GET_REPO,</pre><pre class="source-code">
      variables: {</pre><pre class="source-code">
        org: searchCriteria.org,</pre><pre class="source-code">
        repo: searchCriteria.repo,</pre><pre class="source-code">
      },</pre><pre class="source-code">
    }),</pre><pre class="source-code">
    headers: {</pre><pre class="source-code">
      'Content-Type': 'application/json',</pre><pre class="source-code">
      Authorization: `bearer ${process.env.REACT_APP_        GITHUB_PAT}`,</pre><pre class="source-code">
    },</pre><pre class="source-code">
  });</pre><pre class="source-code">
  const body = (await response.json()) as unknown;</pre><pre class="source-code">
  assertIsGetRepoResponse(body);</pre><pre class="source-code">
  return body.data;</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>This follows the same pattern as the function we created earlier to get the viewer’s information. One difference is that we have specified GraphQL query <strong class="source-inline">org</strong> and <strong class="source-inline">repo</strong> parameters, which are set to the properties in the <strong class="source-inline">searchCriteria</strong> <span class="No-Break">function parameter.</span></p>
			<ol>
				<li value="7">The <strong class="source-inline">assertIsGetRepoResponse</strong> type assertion function follows the same pattern <a id="_idIndexMarker815"/>as previous type assertion <a id="_idIndexMarker816"/>functions. The implementation is lengthy, so it isn’t listed here. You can find the implementation <span class="No-Break">here: </span><a href="https://github.com/PacktPublishing/Learn-React-with-TypeScript-2nd-Edition/blob/main/Chapter10/Using-React-Query/src/api/getRepo.ts"><span class="No-Break">https://github.com/PacktPublishing/Learn-React-with-TypeScript-2nd-Edition/blob/main/Chapter10/Using-React-Query/src/api/getRepo.ts</span></a><span class="No-Break">.</span></li>
			</ol>
			<p>That completes the implementation of a function that finds the <span class="No-Break">GitHub repository.</span></p>
			<p>Next, we will create the component for the repository <span class="No-Break">search form.</span></p>
			<h3>Creating the search form component</h3>
			<p>We will implement a form component that allows the user to search for a repository. The form <a id="_idIndexMarker817"/>will contain fields for the organization <a id="_idIndexMarker818"/>and repository name. The component won’t call the GitHub GraphQL API when the form is submitted; instead, it will pass the submitted search criteria back to a page component to <span class="No-Break">do this.</span></p>
			<p>We will use React Hook Form for implementation, which should already be installed. The pattern for the implementation is very similar to previous forms we have implemented, so the steps to do this implementation aren’t listed in detail here. The implemention for the <strong class="source-inline">SearchRepoForm</strong> component can be copied from the book’s GitHub repository <span class="No-Break">as follows:</span></p>
			<ol>
				<li value="1">Create a new folder called <strong class="source-inline">repoPage</strong> in the <strong class="source-inline">src</strong> folder and then create a new file called <strong class="source-inline">SearchRepoForm.tsx</strong> in <span class="No-Break">this folder.</span></li>
				<li>Open <strong class="source-inline">SearchRepoForm.tsx</strong> and copy and paste the contents into it <span class="No-Break">from </span><a href="https://github.com/PacktPublishing/Learn-React-with-TypeScript-2nd-Edition/blob/main/Chapter10/Using-React-Query/src/repoPage/SearchRepoForm.tsx"><span class="No-Break">https://github.com/PacktPublishing/Learn-React-with-TypeScript-2nd-Edition/blob/main/Chapter10/Using-React-Query/src/repoPage/SearchRepoForm.tsx</span></a><span class="No-Break">.</span></li>
			</ol>
			<p>The implementation for the <strong class="source-inline">SearchRepoForm</strong> component is now in place in <span class="No-Break">our project.</span></p>
			<p>Next, we will implement a component that renders the <span class="No-Break">found repository.</span></p>
			<h3>Creating the FoundRepo component</h3>
			<p>The <strong class="source-inline">FoundRepo</strong> component <a id="_idIndexMarker819"/>will display the <a id="_idIndexMarker820"/>repository name, description, and number of stars. Carry out the following steps to implement <span class="No-Break">this component:</span></p>
			<ol>
				<li value="1">Create a file in the <strong class="source-inline">src/repoPage</strong> folder <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">FoundRepo.tsx</strong></span><span class="No-Break">.</span></li>
				<li>Start the implementation by adding the following type for the <span class="No-Break">component props:</span><pre class="source-code">
type Props = {</pre><pre class="source-code">
  name: string;</pre><pre class="source-code">
  description: string;</pre><pre class="source-code">
  stars: number;</pre><pre class="source-code">
};</pre></li>
			</ol>
			<p>So, the <a id="_idIndexMarker821"/>repository name, description, and the <a id="_idIndexMarker822"/>number of stars will be passed into <span class="No-Break">the component.</span></p>
			<ol>
				<li value="3">Add the following <span class="No-Break">component implementation:</span><pre class="source-code">
export function FoundRepo({ name, description, stars }: Props) {</pre><pre class="source-code">
  return (</pre><pre class="source-code">
    &lt;div className="py-4"&gt;</pre><pre class="source-code">
      &lt;div className="flex flex-row items-center justify-        between mb-2"&gt;</pre><pre class="source-code">
        &lt;h2 className="text-xl font-bold"&gt;{name}&lt;/h2&gt;</pre><pre class="source-code">
        &lt;div className="px-4 py-2 rounded-xl text-          gray-800 bg-gray-200 font-semibold text-sm flex           align-center w-max"&gt;</pre><pre class="source-code">
          {stars} Stars</pre><pre class="source-code">
        &lt;/div&gt;</pre><pre class="source-code">
      &lt;/div&gt;</pre><pre class="source-code">
      &lt;p&gt;{description}&lt;/p&gt;</pre><pre class="source-code">
    &lt;/div&gt;</pre><pre class="source-code">
  );</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>The repository name is rendered as a bold heading. The number of stars is rendered in a gray rounded background to the right of the repository name. The description is rendered underneath <span class="No-Break">the name.</span></p>
			<p>That completes <a id="_idIndexMarker823"/>the implementation <a id="_idIndexMarker824"/>of the found <span class="No-Break">repository component.</span></p>
			<p>Next, we will implement the function that calls the GitHub GraphQL API to star <span class="No-Break">a repository.</span></p>
			<h3>Creating a function to star a repository</h3>
			<p>We will use <a id="_idIndexMarker825"/>the same GraphQL mutation <a id="_idIndexMarker826"/>we used earlier in the chapter to star the GitHub repository. The pattern used in the function will be similar to the <strong class="source-inline">getViewer</strong> function we created earlier. Carry out the <span class="No-Break">following steps:</span></p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">starRepo.ts</strong> in the <strong class="source-inline">src/api</strong> folder, with the following <span class="No-Break">GraphQL mutation:</span><pre class="source-code">
export const STAR_REPO = `</pre><pre class="source-code">
  mutation ($repoId: ID!) {</pre><pre class="source-code">
    addStar(input: { starrableId: $repoId }) {</pre><pre class="source-code">
      starrable {</pre><pre class="source-code">
        stargazers {</pre><pre class="source-code">
          totalCount</pre><pre class="source-code">
        }</pre><pre class="source-code">
      }</pre><pre class="source-code">
    }</pre><pre class="source-code">
  }</pre><pre class="source-code">
`;</pre></li>
			</ol>
			<p>This is the same mutation we created earlier in the chapter in the GitHub GraphQL <span class="No-Break">API explorer.</span></p>
			<ol>
				<li value="2">Add the function implementation <span class="No-Break">as follows:</span><pre class="source-code">
export async function starRepo(repoId: string) {</pre><pre class="source-code">
  const response = await fetch(process.env.REACT_APP_    GITHUB_URL!, {</pre><pre class="source-code">
    method: 'POST',</pre><pre class="source-code">
    body: JSON.stringify({</pre><pre class="source-code">
      query: STAR_REPO,</pre><pre class="source-code">
      variables: {</pre><pre class="source-code">
        repoId,</pre><pre class="source-code">
      },</pre><pre class="source-code">
    }),</pre><pre class="source-code">
    headers: {</pre><pre class="source-code">
      'Content-Type': 'application/json',</pre><pre class="source-code">
      Authorization: `bearer ${process.env.REACT_APP_        GITHUB_PAT}`,</pre><pre class="source-code">
    },</pre><pre class="source-code">
  });</pre><pre class="source-code">
  await response.json();</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>This follows the <a id="_idIndexMarker827"/>same pattern <a id="_idIndexMarker828"/>as the other functions that call the GitHub <span class="No-Break">GraphQL API.</span></p>
			<p>That completes the function that calls the GitHub GraphQL API to star <span class="No-Break">a repository.</span></p>
			<p>Next, we will implement the component for the <span class="No-Break">star button.</span></p>
			<h3>Creating the star button</h3>
			<p>The star <a id="_idIndexMarker829"/>button is a regular button styled to be black <a id="_idIndexMarker830"/>with <span class="No-Break">white text.</span></p>
			<p>Create a file called <strong class="source-inline">StarRepoButton.tsx</strong> in the <strong class="source-inline">src/repoPage</strong> folder and add the following implementation <span class="No-Break">to it:</span></p>
			<pre class="source-code">
type Props = {
  onClick: () =&gt; void;
};
export function StarRepoButton({ onClick }: Props) {
  return (
    &lt;button
      type="button"
      className="mt-2 h-10 px-6 font-semibold bg-black text-        white"
      onClick={onClick}
    &gt;
      Star
    &lt;/button&gt;
  );
}</pre>
			<p>That <a id="_idIndexMarker831"/>completes the implementation of the <span class="No-Break">star </span><span class="No-Break"><a id="_idIndexMarker832"/></span><span class="No-Break">button.</span></p>
			<p>Next, we will create the main page component for <span class="No-Break">the app.</span></p>
			<h3>Creating the repository page</h3>
			<p>The repository page component <a id="_idIndexMarker833"/>will reference the <strong class="source-inline">SearchRepoForm</strong>, <strong class="source-inline">FoundRepo</strong>, and <strong class="source-inline">StarRepoButton</strong> components we just created. This component will also call the <strong class="source-inline">getRepo</strong> and <strong class="source-inline">starRepo</strong> functions we created using React Query. To do this, carry out the <span class="No-Break">following steps:</span></p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">RepoPage.tsx</strong> in the <strong class="source-inline">src/repoPage</strong> folder with the following <span class="No-Break">import statements:</span><pre class="source-code">
import { useState } from 'react';</pre><pre class="source-code">
import {</pre><pre class="source-code">
  useQuery,</pre><pre class="source-code">
  useMutation,</pre><pre class="source-code">
  useQueryClient,</pre><pre class="source-code">
} from '@tanstack/react-query';</pre><pre class="source-code">
import { getRepo } from '../api/getRepo';</pre><pre class="source-code">
import { starRepo } from '../api/starRepo';</pre><pre class="source-code">
import { RepoData, SearchCriteria } from '../api/types';</pre><pre class="source-code">
import { SearchRepoForm } from './SearchRepoForm';</pre><pre class="source-code">
import { FoundRepo } from './FoundRepo';</pre><pre class="source-code">
import { StarRepoButton } from './StarRepoButton';</pre></li>
			</ol>
			<p>We have imported the components and the data functions we created earlier, along <a id="_idIndexMarker834"/>with React Query’s hooks and client. We have also imported React’s state hook because we need to store a piece of state outside <span class="No-Break">React Query.</span></p>
			<ol>
				<li value="2">Start the component implementation <span class="No-Break">as follows:</span><pre class="source-code">
export function RepoPage() {</pre><pre class="source-code">
  const [searchCriteria, setSearchCriteria] = useState&lt;</pre><pre class="source-code">
    SearchCriteria | undefined</pre><pre class="source-code">
  &gt;();</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>We store the search criteria in state so that we can feed it into <strong class="source-inline">useQuery</strong> in the next step. We will set this state when the search repository form is submitted in <span class="No-Break"><em class="italic">step 6</em></span><span class="No-Break">.</span></p>
			<ol>
				<li value="3">Next, call the <strong class="source-inline">useQuery</strong> hook to get the repository for the given search criteria <span class="No-Break">as follows:</span><pre class="source-code">
export function RepoPage() {</pre><pre class="source-code">
  const [searchCriteria, setSearchCriteria] = ...</pre><pre class="source-code">
<strong class="bold">  const { data } = useQuery(</strong></pre><pre class="source-code">
<strong class="bold">    ['repo', searchCriteria],</strong></pre><pre class="source-code">
<strong class="bold">    () =&gt; getRepo(searchCriteria as SearchCriteria),</strong></pre><pre class="source-code">
<strong class="bold">    {</strong></pre><pre class="source-code">
<strong class="bold">      enabled: searchCriteria !== undefined,</strong></pre><pre class="source-code">
<strong class="bold">    }</strong></pre><pre class="source-code">
<strong class="bold">  );</strong></pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>We don’t want the query to execute when the component is mounted, so we use the <strong class="source-inline">enabled</strong> option to only run the query when <strong class="source-inline">searchCriteria</strong> is set, which will be when the search repository form <span class="No-Break">is submitted.</span></p>
			<p>We use the search criteria in the query key as well and pass it to the <strong class="source-inline">getRepo</strong> function. We <a id="_idIndexMarker835"/>use a type assertion on the <strong class="source-inline">getRepo</strong> argument to remove <strong class="source-inline">undefined</strong> from it. This is safe because we know it can’t be <strong class="source-inline">undefined</strong> when <strong class="source-inline">getRepo</strong> is called because of the <strong class="source-inline">enabled</strong> <span class="No-Break">option expression.</span></p>
			<ol>
				<li value="4">Define the star mutation <span class="No-Break">as follows:</span><pre class="source-code">
export function RepoPage() {</pre><pre class="source-code">
  const [searchCriteria, setSearchCriteria] = ...</pre><pre class="source-code">
  const { data } = useQuery(...);</pre><pre class="source-code">
  <strong class="bold">const queryClient = useQueryClient();</strong></pre><pre class="source-code">
<strong class="bold">  const { mutate } = useMutation(starRepo, {</strong></pre><pre class="source-code">
<strong class="bold">    onSuccess: () =&gt; {</strong></pre><pre class="source-code">
<strong class="bold">      queryClient.setQueryData&lt;RepoData&gt;(</strong></pre><pre class="source-code">
<strong class="bold">        ['repo', searchCriteria],</strong></pre><pre class="source-code">
<strong class="bold">        (repo) =&gt; {</strong></pre><pre class="source-code">
<strong class="bold">          if (repo === undefined) {</strong></pre><pre class="source-code">
<strong class="bold">            return undefined;</strong></pre><pre class="source-code">
<strong class="bold">          }</strong></pre><pre class="source-code">
<strong class="bold">          return {</strong></pre><pre class="source-code">
<strong class="bold">            ...repo,</strong></pre><pre class="source-code">
<strong class="bold">            viewerHasStarred: true,</strong></pre><pre class="source-code">
<strong class="bold">          };</strong></pre><pre class="source-code">
<strong class="bold">        }</strong></pre><pre class="source-code">
<strong class="bold">      );</strong></pre><pre class="source-code">
<strong class="bold">    }</strong></pre><pre class="source-code">
<strong class="bold">  });</strong></pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>The <a id="_idIndexMarker836"/>mutation calls the <strong class="source-inline">getRepo</strong> function we created earlier. We use the mutation’s <strong class="source-inline">onSuccess</strong> option to update the React Query’s cached repository data with the <strong class="source-inline">viewerHasStarred</strong> property set <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">true</strong></span><span class="No-Break">.</span></p>
			<ol>
				<li value="5">Return the following JSX from <span class="No-Break">the component:</span><pre class="source-code">
export function RepoPage() {</pre><pre class="source-code">
  ...</pre><pre class="source-code">
  <strong class="bold">return (</strong></pre><pre class="source-code">
<strong class="bold">    &lt;main className="max-w-xs ml-auto mr-auto"&gt;</strong></pre><pre class="source-code">
<strong class="bold">      &lt;SearchRepoForm onSearch={handleSearch} /&gt;</strong></pre><pre class="source-code">
<strong class="bold">      {data &amp;&amp; (</strong></pre><pre class="source-code">
<strong class="bold">        &lt;&gt;</strong></pre><pre class="source-code">
<strong class="bold">          &lt;FoundRepo</strong></pre><pre class="source-code">
<strong class="bold">            name={data.repository.name}</strong></pre><pre class="source-code">
<strong class="bold">            description={data.repository.description}</strong></pre><pre class="source-code">
<strong class="bold">            stars={data.repository.stargazers.totalCount}</strong></pre><pre class="source-code">
<strong class="bold">          /&gt;</strong></pre><pre class="source-code">
<strong class="bold">          {!data.repository.viewerHasStarred &amp;&amp; (</strong></pre><pre class="source-code">
<strong class="bold">            &lt;StarRepoButton onClick={handleStarClick} /&gt;</strong></pre><pre class="source-code">
<strong class="bold">          )}</strong></pre><pre class="source-code">
<strong class="bold">        &lt;/&gt;</strong></pre><pre class="source-code">
<strong class="bold">      )}</strong></pre><pre class="source-code">
<strong class="bold">    &lt;/main&gt;</strong></pre><pre class="source-code">
<strong class="bold">  );</strong></pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>The component is wrapped in a <strong class="source-inline">main</strong> element, which centers its content. The repository <a id="_idIndexMarker837"/>search form is placed inside the <strong class="source-inline">main</strong> element. The found repository is rendered (if there is a found repository) along with a star button if the repository hasn’t already <span class="No-Break">been starred.</span></p>
			<p>We will implement the <strong class="source-inline">handleSearch</strong> and <strong class="source-inline">handleStarClick</strong> handlers in the <span class="No-Break">following steps.</span></p>
			<ol>
				<li value="6">Create the <strong class="source-inline">handleSearch</strong> handler <span class="No-Break">as follows:</span><pre class="source-code">
export function RepoPage() {</pre><pre class="source-code">
  ...</pre><pre class="source-code">
  <strong class="bold">function handleSearch(search: SearchCriteria) {</strong></pre><pre class="source-code">
<strong class="bold">    setSearchCriteria(search);</strong></pre><pre class="source-code">
<strong class="bold">  }</strong></pre><pre class="source-code">
  return ...</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>The handler <a id="_idIndexMarker838"/>sets the <strong class="source-inline">searchCriteria</strong> state, which triggers a re-render and the <strong class="source-inline">useQuery</strong> hook to call <strong class="source-inline">getRepo</strong> with the <span class="No-Break">search criteria.</span></p>
			<ol>
				<li value="7">Create the <strong class="source-inline">handleStarClick</strong> handler <span class="No-Break">as follows:</span><pre class="source-code">
export function RepoPage() {</pre><pre class="source-code">
  ...</pre><pre class="source-code">
  <strong class="bold">function handleStarClick() {</strong></pre><pre class="source-code">
<strong class="bold">    if (data) {</strong></pre><pre class="source-code">
<strong class="bold">      mutate(data.repository.id);</strong></pre><pre class="source-code">
<strong class="bold">    }</strong></pre><pre class="source-code">
<strong class="bold">  }</strong></pre><pre class="source-code">
  return ...</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>The handler <a id="_idIndexMarker839"/>calls the mutation with the found repository’s ID, which will call the <span class="No-Break"><strong class="source-inline">starRepo</strong></span><span class="No-Break"> function.</span></p>
			<p>This completes the implementation of the repository <span class="No-Break">page component.</span></p>
			<ol>
				<li value="8">Open <strong class="source-inline">App.tsx</strong> and add the <strong class="source-inline">RepoPage</strong> component we just created under the <span class="No-Break">app header:</span><pre class="source-code">
...</pre><pre class="source-code">
<strong class="bold">import { RepoPage } from './repoPage/RepoPage';</strong></pre><pre class="source-code">
...</pre><pre class="source-code">
function App() {</pre><pre class="source-code">
  return (</pre><pre class="source-code">
    &lt;QueryClientProvider client={queryClient}&gt;</pre><pre class="source-code">
      &lt;Header /&gt;</pre><pre class="source-code">
      <strong class="bold">&lt;RepoPage /&gt;</strong></pre><pre class="source-code">
    &lt;/QueryClientProvider&gt;</pre><pre class="source-code">
  );</pre><pre class="source-code">
}</pre></li>
				<li>Now, let’s try the app by running <strong class="source-inline">npm start</strong> in the terminal. The repository search form should appear, <span class="No-Break">as follows:</span></li>
			</ol>
			<div>
				<div id="_idContainer152" class="IMG---Figure">
					<img src="image/B19051_10_12.jpg" alt="Figure 10.12 – Repository search form"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.12 – Repository search form</p>
			<ol>
				<li value="10">Enter a GitHub <a id="_idIndexMarker840"/>organization and repository you haven’t starred and press <strong class="bold">Search</strong>. The found repository will appear with a <span class="No-Break"><strong class="bold">Star</strong></span><span class="No-Break"> button:</span></li>
			</ol>
			<div>
				<div id="_idContainer153" class="IMG---Figure">
					<img src="image/B19051_10_13.jpg" alt="Figure 10.13 – Found repository with a Star button"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.13 – Found repository with a Star button</p>
			<ol>
				<li value="11">Click the <strong class="bold">Star</strong> button to star the repository. The <strong class="bold">Star</strong> button will <span class="No-Break">then disappear.</span></li>
				<li>Stop the app from running before continuing by pressing <em class="italic">Ctrl</em> + <em class="italic">C</em> in <span class="No-Break">the terminal.</span></li>
			</ol>
			<p>That completes <a id="_idIndexMarker841"/>the first iteration of the app. Here’s a recap of the key points of using <strong class="source-inline">fetch</strong> and React Query to interact with a <span class="No-Break">GraphQL API:</span></p>
			<ul>
				<li>The <strong class="source-inline">fetch</strong> function can call a GraphQL API by putting the query or mutation in the request body and using the HTTP <span class="No-Break"><strong class="source-inline">POST</strong></span><span class="No-Break"> method.</span></li>
				<li>React Query can execute the function containing <strong class="source-inline">fetch</strong> and manage the <span class="No-Break">response data.</span></li>
				<li>The <strong class="source-inline">enabled</strong> option on <strong class="source-inline">useQuery</strong> and <strong class="source-inline">useMutation</strong> can execute the function containing <strong class="source-inline">fetch</strong> when the user interacts with the app. We used this feature to execute a query when the repository search form <span class="No-Break">was submitted.</span></li>
			</ul>
			<p>In the next section, we will refactor the code to use a specialized <span class="No-Break">GraphQL client.</span></p>
			<h1 id="_idParaDest-261"><a id="_idTextAnchor263"/>Using Apollo Client</h1>
			<p>In this section, we <a id="_idIndexMarker842"/>will learn about Apollo Client and use it within the app we have built, replacing the use of React Query <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">fetch</strong></span><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-262"><a id="_idTextAnchor264"/>Understanding Apollo Client</h2>
			<p>Apollo Client is a client <a id="_idIndexMarker843"/>library for interacting with GraphQL servers. It has query and <a id="_idIndexMarker844"/>mutation hooks called <strong class="source-inline">useQuery</strong> and <strong class="source-inline">useMutation</strong>, like React Query. Apollo Client <a id="_idIndexMarker845"/>also stores the data in a client cache like React Query and requires a provider component placed above the components requiring <span class="No-Break">GraphQL data.</span></p>
			<p>One thing that Apollo Client does that React Query doesn’t is that it interacts with the GraphQL API directly instead of requiring a function to <span class="No-Break">do this.</span></p>
			<h2 id="_idParaDest-263"><a id="_idTextAnchor265"/>Installing Apollo Client</h2>
			<p>Our first job <a id="_idIndexMarker846"/>is to install Apollo Client, which we can do by running the following command in <span class="No-Break">a terminal:</span></p>
			<pre class="source-code">
npm i @apollo/client graphql</pre>
			<p>This library includes TypeScript types, so no additional package is required to <span class="No-Break">be installed.</span></p>
			<h2 id="_idParaDest-264"><a id="_idTextAnchor266"/>Refactoring the App component</h2>
			<p>The first <a id="_idIndexMarker847"/>component we are going to refactor is the <strong class="source-inline">App</strong> component. Carry <a id="_idIndexMarker848"/>out the <span class="No-Break">following steps:</span></p>
			<ol>
				<li value="1">Open <strong class="source-inline">App.tsx</strong> and replace the React Query import with the following Apollo Client <span class="No-Break">import statement:</span><pre class="source-code">
import {</pre><pre class="source-code">
  ApolloClient,</pre><pre class="source-code">
  InMemoryCache,</pre><pre class="source-code">
  ApolloProvider,</pre><pre class="source-code">
} from '@apollo/client';</pre></li>
				<li>Update the <strong class="source-inline">queryClient</strong> variable assignment <span class="No-Break">as follows:</span><pre class="source-code">
const queryClient = <strong class="bold">new ApolloClient({</strong></pre><pre class="source-code">
<strong class="bold">  uri: process.env.REACT_APP_GITHUB_URL!,</strong></pre><pre class="source-code">
<strong class="bold">  cache: new InMemoryCache(),</strong></pre><pre class="source-code">
<strong class="bold">  headers: {</strong></pre><pre class="source-code">
<strong class="bold">    Authorization: `bearer ${process.env.REACT_APP_GITHUB_PAT}`,</strong></pre><pre class="source-code">
<strong class="bold">  }</strong></pre><pre class="source-code">
<strong class="bold">});</strong></pre></li>
			</ol>
			<p>We are now using Apollo Client. We have specified the URL to the API and the PAT because Apollo Client will directly call <span class="No-Break">the API.</span></p>
			<ol>
				<li value="3">The last <a id="_idIndexMarker849"/>step is to replace <strong class="source-inline">QueryClientProvider</strong> with <strong class="source-inline">ApolloProvider</strong> in <span class="No-Break">the JSX:</span><pre class="source-code">
&lt;<strong class="bold">ApolloProvider</strong> client={queryClient}&gt;</pre><pre class="source-code">
  &lt;Header /&gt;</pre><pre class="source-code">
  &lt;RepoPage /&gt;</pre><pre class="source-code">
&lt;/<strong class="bold">ApolloProvider</strong>&gt;</pre></li>
			</ol>
			<p>The <strong class="source-inline">App</strong> component is <a id="_idIndexMarker850"/>now using <span class="No-Break">Apollo Client.</span></p>
			<p>Next, we will refactor the <span class="No-Break"><strong class="source-inline">Header</strong></span><span class="No-Break"> component.</span></p>
			<h2 id="_idParaDest-265"><a id="_idTextAnchor267"/>Refactoring the Header component</h2>
			<p>Now, we will <a id="_idIndexMarker851"/>refactor the <strong class="source-inline">Header</strong> component <a id="_idIndexMarker852"/>to use Apollo Client. Carry out the <span class="No-Break">following steps:</span></p>
			<ol>
				<li value="1">Open <strong class="source-inline">getViewer.ts</strong>. The <strong class="source-inline">getViewer</strong> and <strong class="source-inline">assertIsGetViewerResponse</strong> functions and the <strong class="source-inline">GetViewerResponse</strong> type can be removed because Apollo Client doesn’t require these. The <strong class="source-inline">ViewerData</strong> import statement can also <span class="No-Break">be removed.</span></li>
				<li>Add the following import statement <span class="No-Break">into </span><span class="No-Break"><strong class="source-inline">getViewer.tsx</strong></span><span class="No-Break">:</span><pre class="source-code">
import { gql } from '@apollo/client';</pre></li>
			</ol>
			<p><strong class="source-inline">gql</strong> is a function that we will use in the next step to wrap around the GraphQL query <span class="No-Break">string constant.</span></p>
			<ol>
				<li value="3">Add the <strong class="source-inline">gql</strong> function in front of the GraphQL query string constant <span class="No-Break">as follows:</span><pre class="source-code">
export const GET_VIEWER_QUERY = <strong class="bold">gql</strong>`</pre><pre class="source-code">
  query {</pre><pre class="source-code">
    viewer {</pre><pre class="source-code">
      name</pre><pre class="source-code">
      avatarUrl</pre><pre class="source-code">
    }</pre><pre class="source-code">
  }</pre><pre class="source-code">
`;</pre></li>
			</ol>
			<p>So, <strong class="source-inline">GET_VIEWER_QUERY</strong> is now assigned to a tagged template literal rather than a plain string. We covered tagged template literals in <a href="B19051_05.xhtml#_idTextAnchor127"><span class="No-Break"><em class="italic">Chapter 5</em></span></a>, when we used Emotion’s <strong class="source-inline">css</strong> prop. The <strong class="source-inline">gql</strong> function converts the query string into a query object that Apollo Client <span class="No-Break">can use.</span></p>
			<ol>
				<li value="4">Open <strong class="source-inline">Header.tsx</strong> and update the <strong class="source-inline">useQuery</strong> import statement to come from <a id="_idIndexMarker853"/>Apollo Client. Also, import <a id="_idIndexMarker854"/>the constant we just exported from <strong class="source-inline">getViewer.ts</strong>. We no longer need to <span class="No-Break">import </span><span class="No-Break"><strong class="source-inline">getViewer</strong></span><span class="No-Break">.</span><pre class="source-code">
import { useQuery } from '<strong class="bold">@apollo/client</strong>';</pre><pre class="source-code">
import { <strong class="bold">GET_VIEWER_QUERY</strong> } from './api/getViewer';</pre></li>
				<li>Now update the <strong class="source-inline">useQuery</strong> hook <span class="No-Break">as follows:</span><pre class="source-code">
const { <strong class="bold">loading:</strong> isLoading, data } = useQuery(</pre><pre class="source-code">
  <strong class="bold">GET_VIEWER_QUERY</strong></pre><pre class="source-code">
);</pre></li>
			</ol>
			<p>Apollo Client’s <strong class="source-inline">useQuery</strong> hook takes in a parameter for the query definition object and returns useful state variables similar to React Query. We have aliased the <strong class="source-inline">loading</strong> state variable as <strong class="source-inline">isLoading</strong> so that the rendering of the loading indicator <span class="No-Break">remains unchanged.</span></p>
			<p>For <a id="_idIndexMarker855"/>more information on Apollo Client <a id="_idIndexMarker856"/>queries, see the following <span class="No-Break">link: </span><a href="https://www.apollographql.com/docs/react/data/queries/"><span class="No-Break">https://www.apollographql.com/docs/react/data/queries/</span></a><span class="No-Break">.</span></p>
			<p>That <a id="_idIndexMarker857"/>completes the <span class="No-Break"><strong class="source-inline">Header</strong></span><span class="No-Break"> component.</span></p>
			<p>Next, we will refactor the <span class="No-Break">repository page.</span></p>
			<h2 id="_idParaDest-266"><a id="_idTextAnchor268"/>Refactoring the repository page</h2>
			<p>Refactoring the <a id="_idIndexMarker858"/>repository page will be a similar <a id="_idIndexMarker859"/>process. Carry out the <span class="No-Break">following steps:</span></p>
			<ol>
				<li value="1">Open <strong class="source-inline">getRepo.ts</strong> and remove the <strong class="source-inline">getRepo</strong> and <strong class="source-inline">assertIsGetResponse</strong> functions and the <strong class="source-inline">GetRepoReponse</strong> type. Remove the imported <strong class="source-inline">RepoData</strong> and <strong class="source-inline">SearchCriteria</strong> types <span class="No-Break">as well.</span></li>
				<li>Import the <strong class="source-inline">gql</strong> function and add it in front of the <span class="No-Break">query string:</span><pre class="source-code">
<strong class="bold">import { gql } from '@apollo/client';</strong></pre><pre class="source-code">
export const GET_REPO = <strong class="bold">gql</strong>`</pre><pre class="source-code">
  query ...</pre><pre class="source-code">
`;</pre></li>
				<li>Open <strong class="source-inline">starRepo.ts</strong> and remove the <span class="No-Break"><strong class="source-inline">starRepo</strong></span><span class="No-Break"> function.</span></li>
				<li>Import the <strong class="source-inline">gql</strong> function and add it in front of the <span class="No-Break">query string:</span><pre class="source-code">
<strong class="bold">import { gql } from '@apollo/client';</strong></pre><pre class="source-code">
export const STAR_REPO = <strong class="bold">gql</strong>`</pre><pre class="source-code">
  mutation ...</pre><pre class="source-code">
`;</pre></li>
				<li>Open <strong class="source-inline">RepoPage.tsx</strong> and replace the React Query import statement with an Apollo Client import statement. Also, import the GraphQL query constants we just changed in the previous <span class="No-Break">two steps:</span><pre class="source-code">
<strong class="bold">import {</strong></pre><pre class="source-code">
<strong class="bold">  useLazyQuery,</strong></pre><pre class="source-code">
<strong class="bold">  useMutation,</strong></pre><pre class="source-code">
<strong class="bold">  useApolloClient,</strong></pre><pre class="source-code">
<strong class="bold">} from '@apollo/client';</strong></pre><pre class="source-code">
import { <strong class="bold">GET_REPO</strong> } from '../api/getRepo';</pre><pre class="source-code">
import { <strong class="bold">STAR_REPO</strong> } from '../api/starRepo';</pre></li>
			</ol>
			<p>We will use the <strong class="source-inline">useLazyQuery</strong> hook rather than <strong class="source-inline">useQuery</strong> because we want to trigger the query during form submission rather than when the <span class="No-Break">component mounts.</span></p>
			<ol>
				<li value="6">Replace the call to <strong class="source-inline">useQuery</strong> with the following call <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">useLazyQuery</strong></span><span class="No-Break">:</span><pre class="source-code">
const [getRepo, { data }] = useLazyQuery(GET_REPO);</pre></li>
			</ol>
			<p><strong class="source-inline">useLazyQuery</strong> returns a tuple, with the first element being a function that can be called to trigger the query. We have called this trigger function <strong class="source-inline">getRepo</strong>. The <a id="_idIndexMarker860"/>second tuple element is an object <a id="_idIndexMarker861"/>containing useful state variables, such as the data from the API response, which we <span class="No-Break">have destructured.</span></p>
			<p>For more <a id="_idIndexMarker862"/>information on <strong class="source-inline">useLazyQuery</strong>, see the following <span class="No-Break">link: </span><a href="https://www.apollographql.com/docs/react/data/queries/#manual-execution-with-uselazyquery"><span class="No-Break">https://www.apollographql.com/docs/react/data/queries/#manual-execution-with-uselazyquery</span></a><span class="No-Break">.</span></p>
			<ol>
				<li value="7">Next, replace the <strong class="source-inline">queryClient</strong> variable assignment and the <strong class="source-inline">useMutation</strong> call with <span class="No-Break">the following:</span><pre class="source-code">
const queryClient = <strong class="bold">useApolloClient()</strong>;</pre><pre class="source-code">
const <strong class="bold">[starRepo]</strong> = useMutation(<strong class="bold">STAR_REPO, {</strong></pre><pre class="source-code">
<strong class="bold">  onCompleted: () =&gt; {</strong></pre><pre class="source-code">
<strong class="bold">    queryClient.cache.writeQuery({</strong></pre><pre class="source-code">
<strong class="bold">      query: GET_REPO,</strong></pre><pre class="source-code">
<strong class="bold">      data: {</strong></pre><pre class="source-code">
<strong class="bold">        repository: {</strong></pre><pre class="source-code">
<strong class="bold">          ...data.repository,</strong></pre><pre class="source-code">
<strong class="bold">          viewerHasStarred: true,</strong></pre><pre class="source-code">
<strong class="bold">        },</strong></pre><pre class="source-code">
<strong class="bold">      },</strong></pre><pre class="source-code">
<strong class="bold">      variables: searchCriteria,</strong></pre><pre class="source-code">
<strong class="bold">    });</strong></pre><pre class="source-code">
<strong class="bold">  },</strong></pre><pre class="source-code">
<strong class="bold">}</strong>);</pre></li>
			</ol>
			<p>The first parameter in Apollo Client’s <strong class="source-inline">useMutation</strong> hook is the mutation definition object, which is <strong class="source-inline">STAR_REPO</strong> in our case. The second parameter contains options for the mutation. We have specified the <strong class="source-inline">onCompleted</strong> option, which <a id="_idIndexMarker863"/>is a function called after the <a id="_idIndexMarker864"/>mutation has been completed. We have used this option to update the data cache to indicate that the viewer has now starred <span class="No-Break">the repository.</span></p>
			<p>For <a id="_idIndexMarker865"/>more information on Apollo Client mutations, see the following <span class="No-Break">link: </span><a href="https://www.apollographql.com/docs/react/data/mutations"><span class="No-Break">https://www.apollographql.com/docs/react/data/mutations</span></a><span class="No-Break">.</span></p>
			<ol>
				<li value="8">Update the <strong class="source-inline">handleSearch</strong> function to call the <strong class="source-inline">useLazyQuery</strong> <span class="No-Break">trigger function:</span><pre class="source-code">
function handleSearch(search: SearchCriteria) {</pre><pre class="source-code">
  <strong class="bold">getRepo({</strong></pre><pre class="source-code">
<strong class="bold">    variables: { ...search },</strong></pre><pre class="source-code">
<strong class="bold">  });</strong></pre><pre class="source-code">
  setSearchCriteria(search);</pre><pre class="source-code">
}</pre></li>
				<li>Update the <strong class="source-inline">handleStarClick</strong> function to call the <strong class="source-inline">useMutation</strong> <span class="No-Break">trigger function:</span><pre class="source-code">
async function handleStarClick() {</pre><pre class="source-code">
  if (data) {</pre><pre class="source-code">
    <strong class="bold">starRepo({ variables: { repoId: data.repository.id } });</strong></pre><pre class="source-code">
  }</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>That completes the refactoring of the <span class="No-Break">repository page.</span></p>
			<ol>
				<li value="10">Now, try the app by running <strong class="source-inline">npm start</strong> in the terminal. Try searching for a repository <a id="_idIndexMarker866"/>and starring it – it should <a id="_idIndexMarker867"/>behave as it <span class="No-Break">previously did.</span></li>
			</ol>
			<p>That completes the second iteration of the app and our use of Apollo Client. Here are the key points on using <span class="No-Break">Apollo Client:</span></p>
			<ul>
				<li>Apollo Client is a specialized library for interacting with <span class="No-Break">GraphQL APIs</span></li>
				<li>Unlike React Query, Apollo Client interacts directly with the GraphQL API and, therefore, doesn’t require a separate function that <span class="No-Break">uses </span><span class="No-Break"><strong class="source-inline">fetch</strong></span></li>
				<li>Apollo Client’s <strong class="source-inline">ApolloProvider</strong> component needs to be placed high in the component tree above where backend data <span class="No-Break">is needed</span></li>
				<li>Apollo Client’s <strong class="source-inline">useQuery</strong> hook allows data to be fetched and cached <span class="No-Break">in state</span></li>
				<li>Apollo Client’s <strong class="source-inline">useMutation</strong> hook allows data to <span class="No-Break">be updated</span></li>
			</ul>
			<p>Next, we will summarize <span class="No-Break">the chapter.</span></p>
			<h1 id="_idParaDest-267"><a id="_idTextAnchor269"/>Summary</h1>
			<p>In this chapter, we started by learning the GraphQL syntax for queries and mutations. A great feature of GraphQL is the ability to request and receive only the required objects and fields. This can really help the performance of <span class="No-Break">our apps.</span></p>
			<p>We used React Query and <strong class="source-inline">fetch</strong> to interact with a GraphQL API. This is very similar to interacting with a REST API, but the HTTP method needs to be <strong class="source-inline">POST</strong>, and the query or mutation needs to be placed in the request body. A new feature we learned about in React Query is the ability to trigger queries when the user interacts with the app using the <span class="No-Break"><strong class="source-inline">enabled</strong></span><span class="No-Break"> option.</span></p>
			<p>We refactored the app to use Apollo Client, which is a specialized GraphQL client. It is very similar to React Query in that it has <strong class="source-inline">useQuery</strong> and <strong class="source-inline">useMutation</strong> hooks and a provider component. One advantage over React Query is that Apollo Client interacts directly with the GraphQL API, which means we write <span class="No-Break">less code.</span></p>
			<p>In the next chapter, we will cover patterns that help us build <span class="No-Break">reusable components.</span></p>
			<h1 id="_idParaDest-268"><a id="_idTextAnchor270"/>Questions</h1>
			<p>Answer the following questions to check what you have learned in <span class="No-Break">this chapter:</span></p>
			<ol>
				<li value="1">The following is an attempt at a GraphQL query to get a GitHub viewer’s name and <span class="No-Break">email address:</span><pre class="source-code">
viewer: {</pre><pre class="source-code">
  name,</pre><pre class="source-code">
  email</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>The query errors though – what is <span class="No-Break">the problem?</span></p>
			<ol>
				<li value="2">What is the mutation that would unstar a GitHub repository? The mutation should have a parameter for the <span class="No-Break">repository ID.</span></li>
				<li>The following use of <strong class="source-inline">fetch</strong> is an attempt to call a <span class="No-Break">GraphQL API:</span><pre class="source-code">
const response = await fetch(process.env.REACT_APP_API_URL!, {</pre><pre class="source-code">
  body: JSON.stringify({</pre><pre class="source-code">
    query: GET_DATA_QUERY,</pre><pre class="source-code">
  }),</pre><pre class="source-code">
});</pre></li>
			</ol>
			<p>This doesn’t work though – what is <span class="No-Break">the problem?</span></p>
			<ol>
				<li value="4">Where does the authorization access token in a protected GraphQL API get specified when using <span class="No-Break">Apollo Client?</span></li>
				<li>A component uses Apollo Client’s <strong class="source-inline">useQuery</strong> hook to fetch data from a GraphQL API, but the component errors with the <span class="No-Break">following error:</span></li>
			</ol>
			<p><strong class="bold">Could not find “client” in the context or passed in as an option. Wrap the root component in an &lt;ApolloProvider&gt;, or pass an ApolloClient instance in </strong><span class="No-Break"><strong class="bold">via options</strong></span></p>
			<p>What do you think the <span class="No-Break">problem is?</span></p>
			<ol>
				<li value="6">The following attempts to use Apollo Client’s <strong class="source-inline">useQuery</strong> hook to fetch data from a <span class="No-Break">GraphQL API:</span><pre class="source-code">
const { loading, data } = useQuery(`query {</pre><pre class="source-code">
  contact {</pre><pre class="source-code">
    name</pre><pre class="source-code">
    email</pre><pre class="source-code">
  }</pre><pre class="source-code">
}</pre><pre class="source-code">
`);</pre></li>
			</ol>
			<p>The call errors, though – what do you think the <span class="No-Break">problem is?</span></p>
			<ol>
				<li value="7">What state variable can be destructured from Apollo Client’s <strong class="source-inline">useMutation</strong> hook to determine whether the request has returned <span class="No-Break">an error?</span></li>
			</ol>
			<h1 id="_idParaDest-269"><a id="_idTextAnchor271"/>Answers</h1>
			<ol>
				<li value="1">The query syntax is incorrect – the syntax is like JSON but doesn’t have colons and commas. Also, the <strong class="source-inline">query</strong> keyword can be omitted, but it is best practice to include this. Here is the <span class="No-Break">corrected query:</span><pre class="source-code">
query {</pre><pre class="source-code">
  viewer {</pre><pre class="source-code">
    name</pre><pre class="source-code">
    email</pre><pre class="source-code">
  }</pre><pre class="source-code">
}</pre></li>
				<li>The following mutation will unstar a <span class="No-Break">GitHub repository:</span><pre class="source-code">
mutation ($repoId: ID!) {</pre><pre class="source-code">
  removeStar(input: { starrableId: $repoId }) {</pre><pre class="source-code">
    starrable {</pre><pre class="source-code">
      stargazers {</pre><pre class="source-code">
        totalCount</pre><pre class="source-code">
      }</pre><pre class="source-code">
    }</pre><pre class="source-code">
  }</pre><pre class="source-code">
}</pre></li>
				<li>The request is missing the HTTP <span class="No-Break"><strong class="source-inline">POST</strong></span><span class="No-Break"> method:</span><pre class="source-code">
const response = await fetch(process.env.REACT_APP_API_URL!, {</pre><pre class="source-code">
  <strong class="bold">method: 'POST',</strong></pre><pre class="source-code">
  body: JSON.stringify({</pre><pre class="source-code">
    query: GET_DATA_QUERY,</pre><pre class="source-code">
  }),</pre><pre class="source-code">
});</pre></li>
				<li>The authorization access token gets specified when Apollo Client is created, which is passed into the <span class="No-Break">provider component:</span><pre class="source-code">
const queryClient = new ApolloClient({</pre><pre class="source-code">
  ...,</pre><pre class="source-code">
  headers: {</pre><pre class="source-code">
    Authorization: `bearer ${process.env.REACT_APP_ACCESS_TOKEN}`,</pre><pre class="source-code">
  },</pre><pre class="source-code">
});</pre><pre class="source-code">
function App() {</pre><pre class="source-code">
  return (</pre><pre class="source-code">
    &lt;ApolloProvider</pre><pre class="source-code">
      client={queryClient}</pre><pre class="source-code">
    &gt;</pre><pre class="source-code">
      ...</pre><pre class="source-code">
    &lt;/ApolloProvider&gt;</pre><pre class="source-code">
  );</pre><pre class="source-code">
}</pre></li>
				<li>The problem is that Apollo Client’s <strong class="source-inline">ApolloProvider</strong> component hasn’t been placed above the component using <strong class="source-inline">useQuery</strong> in the <span class="No-Break">component tree.</span></li>
				<li>The <strong class="source-inline">gql</strong> function must be applied to the query string to convert it into the object format that Apollo <span class="No-Break">Client expects:</span><pre class="source-code">
const { loading, data } = useQuery(<strong class="bold">gql</strong>`</pre><pre class="source-code">
  query {</pre><pre class="source-code">
    viewer {</pre><pre class="source-code">
      name</pre><pre class="source-code">
      email</pre><pre class="source-code">
    }</pre><pre class="source-code">
  }</pre><pre class="source-code">
`);</pre></li>
				<li>The <strong class="source-inline">error</strong> state variable can be destructured from React Query’s <strong class="source-inline">useMutation</strong> hook to determine whether the HTTP request has returned <span class="No-Break">an error.</span></li>
			</ol>
		</div>
		<div>
			<div id="_idContainer155" class="IMG---Figure">
			</div>
		</div>
	

		<div>
			<div id="_idContainer156">
			</div>
		</div>
		<div id="_idContainer157" class="Content">
			<h1 id="_idParaDest-270"><a id="_idTextAnchor272"/>Part 4: Advanced React</h1>
			<p>In this part, we will learn about a number of different patterns to enable us to reuse a high amount of React and TypeScript code. We will also cover how to implement automated tests on React components, giving us the confidence to ship new features of <span class="No-Break">applications quickly.</span></p>
			<p>This part includes the <span class="No-Break">following chapters:</span></p>
			<ul>
				<li><a href="B19051_11.xhtml#_idTextAnchor273"><em class="italic">Chapter 11</em></a>, <em class="italic">Reusable Components</em></li>
				<li><a href="B19051_12.xhtml#_idTextAnchor294"><em class="italic">Chapter 12</em></a>, <em class="italic">Unit Testing with Jest and React Testing Library</em></li>
			</ul>
		</div>
		<div>
			<div id="_idContainer158">
			</div>
		</div>
	</body></html>