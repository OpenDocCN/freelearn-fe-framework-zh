<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;Creating a Shared App"><div class="titlepage"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Creating a Shared App</h1></div></div></div><p>Isomorphic apps<a class="indexterm" id="id623"/> are JavaScript applications that can run on both client side and server side. The idea is that the backend and the frontend should share as much code as possible. With a server-rendered app, you can also present content up front without waiting for the JavaScript code to initialize.</p><p>This chapter is divided into two parts:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In the first part, we'll extend the setup we created in <a class="link" href="ch08.html" title="Chapter 8. Deploying Your App to the Cloud">Chapter 8</a>, <span class="emphasis"><em>Deploying Your App to the Cloud</em></span>, so that it supports the pre-rendering of your components</li><li class="listitem" style="list-style-type: disc">In the second part, we'll add Redux and populate your app with data from the server environment</li></ul></div><p>In brief, these are the topics we'll cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Server rendering versus client rendering</li><li class="listitem" style="list-style-type: disc">Terminology confusion</li><li class="listitem" style="list-style-type: disc">Modifying the setup to enable server rendering</li><li class="listitem" style="list-style-type: disc">Streaming your pre-rendered components</li><li class="listitem" style="list-style-type: disc">Deploying a server-rendered app to the cloud</li></ul></div><div class="section" title="Server rendering versus client rendering"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec48"/>Server rendering versus client rendering</h1></div></div></div><p>Node.js<a class="indexterm" id="id624"/> makes it easy to write JavaScript<a class="indexterm" id="id625"/> on your backend as well as frontend. We've been writing server code all along, but until now, all our apps have been client-rendered.</p><p>Rendering your app as a client-rendered app means bundling your JavaScript files and distributing it with your images, CSS, and HTML files. It can be distributed on any kind of web server running on any kind of operating system.</p><p>A client-rendered app<a class="indexterm" id="id626"/> is generally loaded in two steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The initial request loads <code class="literal">index.html</code> and the CSS and JavaScript files either synchronously or asynchronously.</li><li class="listitem">Typically, the app then makes another request and generates the appropriate HTML based on the server response.</li></ol></div><p>With a server-rendered app, the second step is generally omitted. The initial requests load <code class="literal">index.html</code>, the<a class="indexterm" id="id627"/> CSS, the JavaScript, and the content in one<a class="indexterm" id="id628"/> go. The app is in memory and ready to serve, with no need to wait for the client to parse and execute the JavaScript.</p><p>You'll sometimes hear the argument that a server-rendered app is a necessity to serve users who don't have JavaScript on their device or simply have it turned off. This is not a valid argument, because all surveys and statistics known to me put the number of users at around 1 percent.</p><p>Another argument is to support search bots, who typically struggle with parsing JavaScript-based content. This argument is slightly more valid, but major players such as Google and Bing are able to do this, although you may need to add a meta tag in order for the content to be indexed.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note32"/>Note</h3><p>
<span class="strong"><strong>Verifying that bots can read your site</strong></span>
</p><p>You can use Google's own <span class="strong"><strong>Fetch as Googlebot</strong></span><a class="indexterm" id="id629"/> to verify that your <a class="indexterm" id="id630"/>content is being indexed properly. The tool is available at <a class="ulink" href="https://www.google.com/webmasters/tools/googlebot-fetch">https://www.google.com/webmasters/tools/googlebot-fetch</a>. Alternatively, you can refer to <a class="ulink" href="http://www.browseo.net/">http://www.browseo.net/</a>.</p></div></div><p>The benefits of a server-rendered app<a class="indexterm" id="id631"/> are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Users with a slow computer will not have to wait for the JavaScript code to parse.</li><li class="listitem" style="list-style-type: disc">It also provides us with predictable performance. You can measure the time it takes to load your web page when you have control of the rendering process.</li><li class="listitem" style="list-style-type: disc">Doesn't require the user to have a JavaScript runtime on their device.</li><li class="listitem" style="list-style-type: disc">Makes it easier for search bots to crawl your page.</li></ul></div><p>The benefits of a client-rendered app<a class="indexterm" id="id632"/> are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Less setup to deal with</li><li class="listitem" style="list-style-type: disc">No concurrency issues between the server and the client</li><li class="listitem" style="list-style-type: disc">Generally easier to <a class="indexterm" id="id633"/>develop</li></ul></div><p>Making a server-rendered app is more involving than writing a client-rendered app, but it comes with tangible benefits. We'll start by making our scaffold ready for the cloud before moving on to add server rendering. First of all, we need to clear up the terminology, as in the <a class="indexterm" id="id634"/>wild, you'll encounter several<a class="indexterm" id="id635"/> different terms to describe apps that share code between the server and the client.</p></div></div>
<div class="section" title="Terminology confusion"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec49"/>Terminology confusion</h1></div></div></div><p>The term <span class="strong"><strong>isomorphic</strong></span><a class="indexterm" id="id636"/> is made up of the Greek words <span class="emphasis"><em>isos</em></span> for <span class="emphasis"><em>equal</em></span> and <span class="emphasis"><em>morph</em></span> for <span class="emphasis"><em>shape</em></span>. The idea is that by using the term isomorphic, it's easy to understand this as code that's shared between the server and client.</p><p>In math, isomorphism<a class="indexterm" id="id637"/> is a one-to-one mapping function between two sets that preserve the relationships between the sets.</p><p>For instance, an isomorphic code example<a class="indexterm" id="id638"/> would look something like this:</p><div class="informalexample"><pre class="programlisting">// Module A
function foo(x, y) {
  return x * y;
} 

// Module B
function bar(y, x) {
  return y * x;
}

foo(10, 20) // 200
bar(20, 10) // 200</pre></div><p>These two functions are not the same, but they produce the same result and are thus isomorphic for multiplication.</p><p>Isomorphism may be a good term in math, but it's clearly not such a good fit for developing web apps. We've used the term here as the headline for this chapter because it's currently a recognized term for server-rendered apps in the JavaScript community. However, it's not a very good term, and the hunt is on for a better one.</p><p>In a search for a replacement, the term <span class="strong"><strong>Universal</strong></span><a class="indexterm" id="id639"/> has cropped up as the choice of many. Yet, this is not quite ideal either. For one, it's easy to misunderstand. The closest definition of Universal in relation to web apps is this: used or understood by all. Remember, the goal is to describe code sharing. But, Universal can also be understood as a term describing JavaScript apps that can run anywhere. This includes not only the Web, but also native devices and operating systems. This confusion is prevalent throughout the web development sphere.</p><p>The third term is <span class="strong"><strong>Shared</strong></span>, as in<a class="indexterm" id="id640"/> Shared JavaScript. This is more appropriate because it implies there is some meaning to your code. When you're writing Shared JavaScript, it's implied that the code you write is intended to be used in more than one environment.</p><p>When searching through the code on the Web, you'll find all these terms used interchangeably to describe the same pattern of developing web apps. Proper naming is important because it makes your code more understandable to the outside audience. Buzzwords are nice and sounds good on your resume, but the more buzzwords you use, the harder it will be for your code base to understand it.</p><p>In this chapter, we'll use the term server-rendered for code that renders HTML prior to serving it to the user. We'll use the term client-rendered for code that defers the rendering of the HTML to the user's device. And finally, we'll use the term shared code to describe code that is used interchangeably on both the server and the client.</p></div>
<div class="section" title="Developing a server-rendered app"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec50"/>Developing a server-rendered app</h1></div></div></div><p>Developing a Shared<a class="indexterm" id="id641"/> app in ReactJS requires more work than just building a client-rendered app. It also necessitates that you think about your data flow requirements.</p><p>There are two components that together make it possible to write a server-rendered app in ReactJS. It can be thought of like an equation:</p><p>
<span class="emphasis"><em>Pre-rendering components in your server instance + One-way data flow from the server to your components = good app and happy users</em></span>
</p><p>In this section, we'll look at the first part of the equation. We'll tackle the data flow issue in the final section of this chapter.</p><div class="section" title="Adding packages"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec83"/>Adding packages</h2></div></div></div><p>We're going to need a few <a class="indexterm" id="id642"/>more packages from <code class="literal">npm</code> to add them to our dependencies section. This is the list of dependencies that we need:</p><div class="informalexample"><pre class="programlisting">"devDependencies": {
  "react-transform-catch-errors": "^1.0.1",
  "react-transform-hmr": "^1.0.1",
  "redbox-react": "^1.2.0",
  "webpack-dev-middleware": "^1.4.0",
  "webpack-hot-middleware": "^2.6.0",
  "babel-cli": "^6.4.5",
  "babel-core": "^6.3.26",
  "babel-loader": "^6.2.0",
  "babel-plugin-react-transform": "^2.0.0",
  "babel-preset-es2015": "^6.3.13",
  "babel-preset-react": "^6.3.13",
  "compression": "^1.6.1",
  "cp-file": "^3.1.0",
  "cross-env": "^1.0.7",
  "exenv": "^1.2.0",
  "webpack": "^1.12.9"
},
"dependencies": {
  "express": "^4.13.3",
  "express-error-handler": "^1.0.1",
  "path": "^0.12.7",
  "react": "^15.1.0",
  "react-bootstrap": "^0.29.4",
  "react-breadcrumbs": "^1.3.5",
  "react-dom": "^15.1.0",
  "react-dom-stream": "^0.5.1",
  "react-router": "^2.4.1",
  "rimraf": "^2.5.1",
  "serve-static": "^1.11.0"
}</pre></div><p>Add any missing <a class="indexterm" id="id643"/>packages to <code class="literal">package.json</code> and update it by executing <code class="literal">npm install</code>.</p></div><div class="section" title="Adding CSS"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec84"/>Adding CSS</h2></div></div></div><p>We'll need to style our <a class="indexterm" id="id644"/>page, so we'll use a subset of what we used when developing <span class="strong"><strong>Reactagram</strong></span><a class="indexterm" id="id645"/> in <a class="link" href="ch07.html" title="Chapter 7. Reactagram">Chapter 7</a>, <span class="emphasis"><em>Reactagram</em></span>. Replace the contents of <code class="literal">assets/app.css</code> with this:</p><div class="informalexample"><pre class="programlisting">body { font-family: 'Bitter', serif; padding: 15px;
  margin-top: 50px; padding-bottom: 50px }

.header {  padding: 10px; font-size: 18px; margin: 5px; }

footer{ position:fixed; bottom:0; background: black; width:100%;
  padding:10px; color:white; left:0; text-align:center; }

h1 { font-size: 24px; }

h2 { font-size: 20px; }

h3 { font-size: 17px; }

ul { padding:0; list-style-type: none; }

.nav a:visited, .nav a:link { color: #999; }

.nav a:hover { color: #fff; text-decoration: none; }

.logo { padding-top: 16px; margin: 0 auto; text-align: center; }

#calculator{ min-width:240px; }

.calc { margin:3px; width:50px; }

.calc.wide { width:163px; }

.calcInput { width: 221px; }</pre></div></div><div class="section" title="Adding Bootstrap CDN to index.html"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec85"/>Adding Bootstrap CDN to index.html</h2></div></div></div><p>Since we're adding <a class="indexterm" id="id646"/>
<code class="literal">react-bootstrap</code>, we need to add the Bootstrap CDN files as well. Open <code class="literal">assets/index.html</code> and replace it with this content:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Shared App&lt;/title&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;
    &lt;meta name="viewport" content="width=device-width, 
    initial-scale=1, maximum-scale=1, user-scalable=no"&gt;
    &lt;link async rel="stylesheet" type="text/css"
    href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"&gt;
    &lt;link async rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" /&gt;
    &lt;link async href='https://fonts.googleapis.com/css?family=Bitter'
      rel='stylesheet' type='text/css'&gt;
    &lt;link async rel="stylesheet" href="/app.css"&gt;
    &lt;link rel="stylesheet" href="/app.css"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id="app"&gt;&lt;/div&gt;
    &lt;script src="/assets/bundle.js"&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div></div><div class="section" title="Creating components"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec86"/>Creating components</h2></div></div></div><p>We can't make an app <a class="indexterm" id="id647"/>without some content, so let's add a few pages and a route hierarchy. Start by removing <code class="literal">index.jsx</code> from the <code class="literal">source</code> folder and <code class="literal">index-production.html</code> from the <code class="literal">assets</code> folder. The tree structure will look like this when we're finished with this part of the chapter:</p><div class="informalexample"><pre class="programlisting">├── .babelrc
├── assets
│   ├── app.css
│   ├── favicon.ico
│   └── index.html
├── config.js
├── package.json
├── server-development.js
├── server-production.es6
├── server-production.js
├── source
│   ├── client
│   │   └── index.jsx
│   ├── routes
│   │   └── index.jsx
│   ├── server
│   │   └── index.js
│   └── shared
│       ├── components
│       │   ├── back.jsx
│       │   └── fontawesome.jsx
│       ├── settings.js
│       └── views
│           ├── about.jsx
│           ├── app.jsx
│           ├── calculator.jsx
│           ├── error.jsx
│           └── layout.jsx
├── Webpack-development.config.js
└── Webpack-production.config.js</pre></div><p>We need to be diligent in how we structure our app in order to make it easy to understand and notice how everything fits together with regards to client-side and server-side rendering.</p><p>Let's start by adding the <a class="indexterm" id="id648"/>source code for <code class="literal">client/index.jsx</code>:</p><div class="informalexample"><pre class="programlisting">import React from 'react';
import { render } from 'react-dom';
import { Router, browserHistory } from 'react-router';
import { routes } from '../routes';

render(
  &lt;Router routes={routes} history={ browserHistory } /&gt;,
  document.getElementById('app')
);</pre></div><p>The code structure should be very familiar at this point.</p><p>Let's add our routes. Create <code class="literal">routes/index.jsx</code> and add this code:</p><div class="informalexample"><pre class="programlisting">'use strict';

import React from 'react';

import { Router, Route, IndexRoute }
  from 'react-router'
import App from '../shared/views/app';
import Error from '../shared/views/error';
import Layout from '../shared/views/layout';
import About from '../shared/views/about';
import Calculator from '../shared/views/calculator';

const routes= &lt;Route path="/" name="Shared App" component={Layout} &gt;
  &lt;Route name="About" path="about" component={About} /&gt;
  &lt;Route name="Calculator" path="calculator"
    component={Calculator} /&gt;
  &lt;IndexRoute name="Welcome" component={App} /&gt;
  &lt;Route path="*" name="Error" component={Error} /&gt;
&lt;/Route&gt;

export { routes };</pre></div><p>The routes will respond to <code class="literal">/</code>, <code class="literal">/about</code>, and <code class="literal">/calculator</code>, and anything else will be routed to the <code class="literal">error</code> component. The <code class="literal">IndexRoute</code> function routes the app to the <code class="literal">Welcome</code> component if you visit the app without specifying a route (for instance, <code class="literal">http://localhost:8080</code> without the ending slash).</p><p>The routes are assigned to a few basic views that we're going to create next.</p><p>Create <code class="literal">shared/views/layout.jsx</code> and add this code:</p><div class="informalexample"><pre class="programlisting">import React from 'react'
import { Grid, Row, Col, Nav, Navbar } from 'react-bootstrap';
import Breadcrumbs from 'react-breadcrumbs';
import Settings from '../settings';
export default class Layout extends React.Component {
  render() {
    return (
      &lt;Grid&gt;
        &lt;Navbar componentClass="header"
          fixedTop inverse&gt;
          &lt;h1 center style={{color:"#fff"}} className="logo"&gt;
            {Settings.title}</pre></div><p>We'll fetch the title from the <code class="literal">Settings</code> component. The following component will create a link path that you can use as a navigation element:</p><div class="informalexample"><pre class="programlisting">          &lt;/h1&gt;
          &lt;Nav role="navigation" eventKey={0}
          pullRight&gt;
          &lt;/Nav&gt;
        &lt;/Navbar&gt;
        &lt;Breadcrumbs {...this.props} setDocumentTitle={true} /&gt;</pre></div><p>The <a class="indexterm" id="id649"/>parameter <code class="literal">setDocumentTitle</code> is an argument that will make the component change the document title of the window tab to the name of the <code class="literal">child</code> component you're on, let's put the following code:</p><div class="informalexample"><pre class="programlisting">        {this.props.children}
        &lt;footer&gt;
          Server-rendered Shared App
        &lt;/footer&gt;
      &lt;/Grid&gt;
    )
  }
}</pre></div><p>Create <code class="literal">shared/views/app.jsx</code> and add this code:</p><div class="informalexample"><pre class="programlisting">'use strict';
import React from 'react'
import { Row, Col } from 'react-bootstrap';

import { Link } from 'react-router'

export default class Index extends React.Component {
  render() {
    return (
      &lt;Row&gt;
        &lt;Col md={6}&gt;
          &lt;h2&gt;Welcome to my server-rendered app&lt;/h2&gt;
          &lt;h3&gt;Check out these links&lt;/h3&gt;
          &lt;ul&gt;
            &lt;li&gt;&lt;Link to="/calculator"&gt;Calculator&lt;/Link&gt;&lt;/li&gt;
            &lt;li&gt;&lt;Link to="/about"&gt;About&lt;/Link&gt;&lt;/li&gt;
          &lt;/ul&gt;
        &lt;/Col&gt;
      &lt;/Row&gt;
    )
  }
}</pre></div><p>This component<a class="indexterm" id="id650"/> creates a simple list with two links. The first goes to the <code class="literal">About</code> component and the second to the <code class="literal">Calculator</code> component.</p><p>Create <code class="literal">shared/views/error.jsx</code> and add this code:</p><div class="informalexample"><pre class="programlisting">'use strict';
import React from 'react'
import { Grid, Row, Col } from 'react-bootstrap';

export default class Error extends React.Component {
  render() {
    return (
      &lt;Grid&gt;
        &lt;Row&gt;
          &lt;Col md={6}&gt;
            &lt;h1&gt;Error!&lt;/h1&gt;
          &lt;/Col&gt;
        &lt;/Row&gt;

      {this.props.children}
      &lt;/Grid&gt;
    )
  }
}</pre></div><p>This component will show up if you manually enter a wrong path in the URL locator of your browser.</p><p>Create <code class="literal">shared/views/about.jsx</code> and <a class="indexterm" id="id651"/>add this code:</p><div class="informalexample"><pre class="programlisting">'use strict';
import React from 'react'
import { Row, Col } from 'react-bootstrap';

export default class About extends React.Component {
  render() {
    return (
      &lt;Row&gt;
        &lt;Col md={6}&gt;
          &lt;h2&gt;About&lt;/h2&gt;
          &lt;p&gt;
            This app is designed to work as either a client- or
            a server-rendered app. It's also designed to be 
            deployed to the cloud.
          &lt;/p&gt;
        &lt;/Col&gt;
      &lt;/Row&gt;
    )
  }
}</pre></div><p>The <code class="literal">About</code> component is a simple placeholder component in our app. You can use it to present some information about your app.</p><p>Create <code class="literal">shared/views/calculator.jsx</code> and add this code:</p><div class="informalexample"><pre class="programlisting">'use strict';
import React from 'react'
import { Row, Col, Button, Input, FormGroup, FormControl, InputGroup } from 'react-bootstrap';

export default class Calculator extends React.Component {
  constructor() {
    super();
    this.state={};
    this.state._input=0;
    this.state.__prev=0;
    this.state._toZero=false;
    this.state._symbol=null;
  }</pre></div><p>The <code class="literal">getInitialState</code> element is deprecated when using ES6 classes, so we'll need to set out the initial state in the constructor. We can do this by first making an empty <code class="literal">state</code> variable attached to <code class="literal">this</code>. Then, we add three states: <code class="literal">_input</code> is the calculator input text box, <code class="literal">_prev</code> is used to hold the number to calculate, <code class="literal">_toZero</code> is a flag that will be used to zero out the input when doing calculations, and <code class="literal">_symbol</code> is the mathematical operation symbol (plus, minus, division, and multiply), let's take a look at the following code:</p><div class="informalexample"><pre class="programlisting">  handlePercentage(){
    this.setState({_input:this.state._input/100, _toZero:true})
  }

  handleClear(){
      this.setState({_input:"0"})
  }

  handlePlusMinus(e){
        this.setState({_input:this.state._input&gt;0 ?
         -this.state._input:Math.abs(this.state._input)});
  }</pre></div><p>These three functions <a class="indexterm" id="id652"/>alter the input number directly. Let's move on to the next function:</p><div class="informalexample"><pre class="programlisting">  handleCalculate(e) {
    const value = this.refs.calcInput.props.value;
    if(this.state._symbol) {
      switch(this.state._symbol) {
        case "+":
          this.setState({_input:(Number(this.state._prev)||0)
          +Number(value),_symbol:null});
        break;
        case "-":
          this.setState({_input:(Number(this.state._prev)||0)
            -Number(value),_symbol:null});
        break;
        case "/":
          this.setState({_input:(Number(this.state._prev)||0)
            /Number(value),_symbol:null});
        break;
        case "*":
          this.setState({_input:(Number(this.state._prev)||0)
            *Number(value),_symbol:null});
        break;
      }
    }
  }</pre></div><p>This function is invoked when you press the <span class="strong"><strong>Calculate</strong></span> button (<span class="strong"><strong>=</strong></span>). It will check whether the user has activated a mathematical symbol, and if so, it will check which symbol is active and perform the calculation on the stored number and the current number, let's take a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">  handleClick(e) {
    let input=Number(this.state._input)||"";
    if(this.state._toZero) {
      this.setState({_toZero: false});
      input="";
    }</pre></div><p>If the input number <a class="indexterm" id="id653"/>needs to be turned into zero, this operation will do that and reset the <code class="literal">_toZero</code> flag. Now we move to <code class="literal">isNaN</code>:</p><div class="informalexample"><pre class="programlisting">    if(isNaN(e.target.value)) {
      this.setState({_toZero:true,
        _prev:this.state._input,
        _symbol:e.target.value
      })</pre></div><p>Using <code class="literal">isNaN</code> is an efficient way to check whether the variable is a number. If not, it's a mathematical symbol and we handle this by storing the symbol in the state, requiring the input number to be made zero (so that we don't calculate the wrong numbers) and set the current input as the <code class="literal">_prev</code> value (to be calculated on), let's take a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">    } else {
      this.setState({_input:input+e.target.value})</pre></div><p>If it's a number, we add it to the <code class="literal">_input</code> state, let's take a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">    }
  }

  handleChange(e) {
    this.setState({_input:e.target.value})
  }

  calc() {
    return (
      &lt;div id="calculator"&gt;
        &lt;Col md={12}&gt;
          &lt;FormGroup&gt;
            &lt;InputGroup className="calcInput" &gt;
              &lt;FormControl 
                ref="calcInput" 
                onChange={ this.handleChange.bind(this) }
                value={this.state._input}
              type="text" /&gt;
            &lt;/InputGroup&gt;
          &lt;/FormGroup&gt;
          &lt;Input type="text" className="calcInput"
            ref="calcInput" defaultValue="0"
            onChange={this.handleChange.bind(this)}
             value={this.state._input}/&gt;</pre></div><p>When using <code class="literal">React.createClass</code>, all functions are automatically bound to the component. Since we're using ES6 classes, we need to bind our functions manually, let's take a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">          &lt;Button className="calc"
            onClick={this.handleClear.bind(this)}&gt;C&lt;/Button&gt;
          &lt;Button className="calc"
            onClick={this.handlePlusMinus.bind(this)}&gt;
            {String.fromCharCode(177)}&lt;/Button&gt;
          &lt;Button className="calc"
            onClick={this.handlePercentage.bind(this)}&gt;%&lt;/Button&gt;
          &lt;Button className="calc" value="/"
            onClick={this.handleClick.bind(this)}&gt;
            {String.fromCharCode(247)}&lt;/Button&gt;</pre></div><p>Some characters are<a class="indexterm" id="id654"/> difficult to locate on the standard keyboard. Instead, we can render it using the Unicode character code. A list of character code and their respective images is readily available on the Internet, let's take a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">          &lt;br/&gt;
          &lt;Button className="calc" value="7"
            onClick={this.handleClick.bind(this)}&gt;7&lt;/Button&gt;
          &lt;Button className="calc" value="8"
            onClick={this.handleClick.bind(this)}&gt;8&lt;/Button&gt;
          &lt;Button className="calc" value="9"
            onClick={this.handleClick.bind(this)}&gt;9&lt;/Button&gt;
          &lt;Button className="calc" value="*"
            onClick={this.handleClick.bind(this)}&gt;
            {String.fromCharCode(215)}&lt;/Button&gt;
          &lt;br/&gt;
          &lt;Button className="calc" value="4"
            onClick={this.handleClick.bind(this)}&gt;4&lt;/Button&gt;
          &lt;Button className="calc" value="5"
            onClick={this.handleClick.bind(this)}&gt;5&lt;/Button&gt;
          &lt;Button className="calc" value="6"
            onClick={this.handleClick.bind(this)}&gt;6&lt;/Button&gt;
          &lt;Button className="calc" value="-"
            onClick={this.handleClick.bind(this)}&gt;-&lt;/Button&gt;
          &lt;br/&gt;
          &lt;Button className="calc" value="1"
            onClick={this.handleClick.bind(this)}&gt;1&lt;/Button&gt;
          &lt;Button className="calc" value="2"
            onClick={this.handleClick.bind(this)}&gt;2&lt;/Button&gt;
          &lt;Button className="calc" value="3"
            onClick={this.handleClick.bind(this)}&gt;3&lt;/Button&gt;
          &lt;Button className="calc" value="+"
            onClick={this.handleClick.bind(this)}&gt;+&lt;/Button&gt;
          &lt;br/&gt;
          &lt;Button className="calc wide" value="0"
            onClick={this.handleClick.bind(this)}&gt;0&lt;/Button&gt;
          &lt;Button className="calc"
            onClick={this.handleCalculate.bind(this)}&gt;=&lt;/Button&gt;
        &lt;/Col&gt;
      &lt;/div&gt;
    )
  }

  render() {
    return (
      &lt;Row&gt;
        &lt;Col md={12}&gt;
          &lt;h2&gt;Calculator&lt;/h2&gt;
          {this.calc()}
        &lt;/Col&gt;
      &lt;/Row&gt;
    )
  }
}</pre></div><p>The following screenshot shows the <a class="indexterm" id="id655"/>
<span class="strong"><strong>Calculator</strong></span> page we just created:</p><div class="mediaobject"><img alt="Creating components" src="graphics/B04943_09_01.jpg"/></div><p>Next, add two<a class="indexterm" id="id656"/> files: <code class="literal">config.js</code> to the <code class="literal">root</code> folder and <code class="literal">settings.js</code> to <code class="literal">source/shared</code>.</p><p>Add this code to <code class="literal">config.js</code>:</p><div class="informalexample"><pre class="programlisting">'use strict';
const config = {
  home: __dirname
};
module.exports = config;</pre></div><p>Then, add this code to <code class="literal">settings.js</code>:</p><div class="informalexample"><pre class="programlisting">'use strict';
import config from '../../config.js';

const settings = Object.assign({}, config, {
  title: 'Shared App'
});
module.exports = settings;</pre></div></div><div class="section" title="Setting up a server-rendered Express React server"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec87"/>Setting up a server-rendered Express React server</h2></div></div></div><p>We have now finished <a class="indexterm" id="id657"/>making our shared components, so it's time to set up server rendering. In the preceding file structure, you've probably noticed that we've added a file called <code class="literal">server-production.es6</code>. We'll keep the ordinary ES5 version, but to simplify our code, we'll type it up in modern JavaScript and use Babel to convert it to ES5.</p><p>Using Babel is something we have to live with until the node implements full support for ES6/ECMAScript 2015. We could optionally use <code class="literal">babel-node</code> to run our express server, but it's not advisable to do this in production because it adds significant overhead to each request.</p><p>Let's see how it should look. Create <code class="literal">server-production.es6</code> and add the following code:</p><div class="informalexample"><pre class="programlisting">'use strict';

import path from 'path';
import express from 'express';
import compression from 'compression';
import cpFile from 'cp-file';
import errorHandler from 'express-error-handler';
import envs from 'envs';
import React from 'react';
import ReactDOM from 'react-dom';
import { Router, match, RoutingContext } from 'react-router';
import { routes } from './build/routes';</pre></div><p>We're going to use client-side routes in our Express server. We'll set up a catch-all Express route and implement react-router routes within it, let's take a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">import settings from './build/shared/settings';
import ReactDOMStream from 'react-dom-stream/server';</pre></div><p>We'll also implement a streaming DOM utility instead of using React's own <code class="literal">renderToString</code>. The <code class="literal">renderToString</code> method is synchronous and can become a performance bottleneck in server-side rendering of React sites. Streams make this process much faster because you don't need to pre-render the entire string before sending it. With larger pages, <code class="literal">renderToString</code> can introduce a latency of hundreds of milliseconds as well as require more memory because it needs to allocate memory to the entire string.</p><p>
<code class="literal">ReactDOMStream</code> renders asynchronously to a stream and lets the browser render the page before the entire response is finished. Refer to the following code:</p><div class="informalexample"><pre class="programlisting">import serveStatic from 'serve-static';

const port = process.env.PORT || 8080;
const host = process.env.HOST || '0.0.0.0';
const app = express();
const http = require('http');
app.set('environment', envs('NODE_ENV', process.env.NODE_ENV || 'production')); 
app.set('port', port);
app.use(compression());

cpFile('assets/app.css', 'public/assets/app.css').then(function() {
  console.log('Copied app.css');
});
app.use(serveStatic(path.join(__dirname, 'public', 'assets')));

const appRoutes = (app) =&gt; {
  app.get('*', (req, res) =&gt; {
    match({ routes, location: req.url },
    (err, redirectLocation, props) =&gt; {
      if (err) {
        res.status(500).send(err.message);
      }
      else if (redirectLocation) {
        res.redirect(302,
        redirectLocation.pathname + redirectLocation.search);</pre></div><p>When performing server<a class="indexterm" id="id658"/> rendering, we need to send 500 responses for errors and 302 responses for redirects. We can do this by matching and checking the response status. If there are no errors, we proceed with the rendering, let's take a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">      } else if (props) {
        res.write(`&lt;!DOCTYPE html&gt;
          &lt;html&gt;
            &lt;head&gt;
              &lt;meta charSet="utf-8" /&gt;
                &lt;meta httpEquiv="X-UA-Compatible"
                  content="IE=edge" /&gt;
                  &lt;meta name="viewport" content="width=device-width,
                  initial-scale=1, maximum-scale=1, user-scalable=no"/&gt;
                  &lt;link rel="preload" as="stylesheet" type="text/css"
                  href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"/&gt;
                  &lt;link rel="preload" as="stylesheet" type="text/css"
                  href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" /&gt;
                  &lt;link rel="preload" as="stylesheet" href='https://fonts.googleapis.com/css?family=Bitter' type='text/css'/&gt;
                  &lt;link rel="preload" as="stylesheet" href="/app.css" /&gt;
                  &lt;title&gt;${settings.title}&lt;/title&gt;
            &lt;/head&gt;
        &lt;body&gt;&lt;div id="app"&gt;`);
      const stream = ReactDOMStream.renderToString(
        React.createElement(RoutingContext, props));
      stream.pipe(res, {end: false});
      stream.on("end", ()=&gt; {
        res.write(`&lt;/div&gt;&lt;script
          src="/bundle.js"&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;`);
        res.end();
       });''
      }
      else {
        res.sendStatus(404);</pre></div><p>Finally, we need to send a <code class="literal">404</code> status if we do not find any properties or routes, let's take a look at the remaining code:</p><div class="informalexample"><pre class="programlisting">      }
    });
  });
}</pre></div><p>When the server starts<a class="indexterm" id="id659"/> rendering, it will start by writing out our header information. It will load the initial CSS files asynchronously, set up the title and the body, and the first div. Then, we switch to <code class="literal">ReactDOMStream</code>, which will then start rendering our app starting from <code class="literal">RoutingContext</code>. When the stream is finished, we close the response by wrapping up our <code class="literal">div</code> and HTML page. Server-rendered content now lives inside <code class="literal">&lt;div id="app"&gt;&lt;/div&gt;</code>. When <code class="literal">bundle.js</code> is loaded, it will take over and replace the content of this <code class="literal">div</code>, unless the device it renders on doesn't support JavaScript.</p><p>Note that while the CSS files are asynchronous, they still block the rendering until they are loaded. It's possible to get around this by inlining the CSS to avoid extra lookups, let's take a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">const router = express.Router();
appRoutes(router);
app.use(router);

const server = http.createServer(app);
app.use((err, req, res, next) =&gt; {
  console.log(err);
  next(err);
});
app.use( errorHandler({server: server}) );

app.listen(port, host, () =&gt; {
  console.log('Server started for '+settings.title+' at http://'+host+':'+port);
});</pre></div><p>The final part is the same<a class="indexterm" id="id660"/> as before, just modified to use the new JavaScript syntax. One thing you have noticed is that we're importing our source components from a new folder called <code class="literal">build</code> rather than <code class="literal">source</code>. We can get away with converting our source code to ES5, with Babel on runtime when developing; however, this won't fly in production. Instead, we need to convert our entire source manually.</p><p>First, let's change two lines in <code class="literal">webpack.config.dev.js</code> and verify that it builds locally.</p><p>Open the file and replace the line in the entry where it says <code class="literal">./source/index</code> with <code class="literal">./source/client/index</code>, and the line path <code class="literal">path.join(__dirname, 'public', 'assets')</code> to <code class="literal">path.join(__dirname, 'assets')</code>. Then, run the project by executing <code class="literal">npm run dev</code>.</p><p>The following screenshot shows the main page of the app:</p><div class="mediaobject"><img alt="Setting up a server-rendered Express React server" src="graphics/B04943_09_02.jpg"/></div><p>Your app should now <a class="indexterm" id="id661"/>run without problems, and <code class="literal">http://localhost:8080</code> should now present you with the <span class="strong"><strong>Shared App</strong></span> screen. You should be able to edit the code in your <code class="literal">source</code> folder and see it updated live on the screen. You should also be able to click on the links and perform math operations with the calculator.</p></div><div class="section" title="Setting up Webpack for server-rendering"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec88"/>Setting up Webpack for server-rendering</h2></div></div></div><p>Open <code class="literal">Webpack-production.config.js</code> and replace<a class="indexterm" id="id662"/> its content<a class="indexterm" id="id663"/> with the following:</p><div class="informalexample"><pre class="programlisting">'use strict';

var path = require('path');
var webpack = require('webpack');

module.exports = {
  entry: [
    './build/client/index'
  ],
  output: {
    path: path.join(__dirname, 'public', 'assets'),
    filename: 'bundle.js',
    publicPath: '/assets/'
  },
  plugins: [
    new webpack.optimize.OccurenceOrderPlugin(),
    new webpack.DefinePlugin({
      'process.env': {
        'NODE_ENV': JSON.stringify('production')
      }
    }),
    new webpack.optimize.UglifyJsPlugin({
      compressor: {
        warnings: false
      }
    })
  ]
};</pre></div><p>We're not going <a class="indexterm" id="id664"/>to rely on Babel to convert our code on the<a class="indexterm" id="id665"/> fly, so we can remove the <code class="literal">module</code> and <code class="literal">resolve</code> section.</p></div><div class="section" title="Setting up npm scripts for server rendering"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec89"/>Setting up npm scripts for server rendering</h2></div></div></div><p>Open <code class="literal">package.json</code> and<a class="indexterm" id="id666"/> replace the <code class="literal">scripts</code> section with<a class="indexterm" id="id667"/> this:</p><div class="informalexample"><pre class="programlisting">"scripts": {
  "test": "echo \"Error: no test specified\"",
  "convert": "babel server-production.es6 &gt; server-production.js",
  "prestart": "npm run build",
  "start": "npm run convert",
  "poststart": "cross-env NODE_ENV=production node server-production.js",
  "dev": "cross-env NODE_ENV=development node server-development.js",
  "prebuild": "rimraf public &amp;&amp; rimraf build &amp;&amp; NODE_ENV=production babel source/ --out-dir build",
  "build": "cross-env NODE_ENV=production webpack --progress --config Webpack-production.config.js",
  "predeploy": "npm run build",
  "deploy": "npm run convert",
  "postdeploy": "echo Ready to deploy. Commit your changes and run git push heroku master"
},</pre></div><p>Here's what a running <code class="literal">npm start</code> command will do:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Run the build (before it starts).</li><li class="listitem">Delete the <code class="literal">public</code> and <code class="literal">build</code> folder, and convert the ES2015 source to ES5 and put it in the <code class="literal">builder</code> folder (the prebuild process).</li><li class="listitem">Run Webpack and create a <span class="emphasis"><em>bundle</em></span> in <code class="literal">public/assets</code> (the build process).</li><li class="listitem">Run convert, which is in order to convert <code class="literal">server-production.es6</code> to <code class="literal">server-production.js</code> (when it is started).</li><li class="listitem">Run the Express server (after it has started).</li></ol></div><p>Phew! That's a huge<a class="indexterm" id="id668"/> command chain. After the compilation is <a class="indexterm" id="id669"/>over, the server starts and you can go to <code class="literal">http://localhost:8080</code> to test your pre-rendered server. You'll probably not even notice the difference at first glance, but try turning off JavaScript in your browser and perform the refresh action. The page will still load and you'll still be able to navigate. The calculator will not work, however, because it requires client-side JavaScript to work. As noted earlier, the goal is not to support JavaScript-less browsers (as they are rare). The goal is to deliver a pre-rendered page, and that's what this does.</p><p>We change <code class="literal">npm deploy</code> as well. Here's what this does:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Run the build (before it is deployed).</li><li class="listitem">Run convert, in order to convert <code class="literal">server-production.es6</code> to <code class="literal">server-production.js</code> (once it's deployed).</li><li class="listitem">It will let you know it's done. This step could be replaced with a push to the cloud (post its deployment).</li></ol></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note33"/>Note</h3><p>The server-rendered app<a class="indexterm" id="id670"/> is now complete. You can find a demo at <a class="ulink" href="https://reactjsblueprints-srvdeploy.herokuapp.com/">https://reactjsblueprints-srvdeploy.herokuapp.com/</a>.</p></div></div></div></div>
<div class="section" title="Adding Redux to your server-rendered app"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec51"/>Adding Redux to your server-rendered app</h1></div></div></div><p>The final piece of the puzzle is the<a class="indexterm" id="id671"/> handling of the data flow. In a client-rendered app, data flow is generally handled in this way: The user initiates an action, for instance, by visiting the index page of your app. The app then routes to the view and the render process starts. After the rendering, or during the rendering (asynchronously), data is fetched and then displayed to the user.</p><p>In a server-rendered app, the data needs to be prefetched before the rendering process starts. The responsibility of fetching the data shifts from the client to the server. This necessitates a complete rethink of how we structure our apps. It's important to make this decision before you start designing your app because changing your data flow architecture after you've started implementing the app is a costly operation.</p><div class="section" title="Adding packages"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec90"/>Adding packages</h2></div></div></div><p>We need to add a <a class="indexterm" id="id672"/>number of new packages to our project. The <code class="literal">package.json</code> file should now look like this:</p><div class="informalexample"><pre class="programlisting">"babel-polyfill": "^6.3.14",
"body-parser": "^1.14.2",
"isomorphic-fetch": "^2.2.1",
"react-redux": "^4.2.1",
"redux": "^3.2.1",
"redux-logger": "^2.5.0",
"redux-thunk": "^1.0.3",</pre></div><p>We're going to perform isomorphic fetching like we did in <a class="link" href="ch06.html" title="Chapter 6. Advanced React">Chapter 6</a>, <span class="emphasis"><em>Advanced React</em></span>, so we need to add the <code class="literal">isomorphic-fetch</code> library. This library adds <code class="literal">fetch</code> as a global function so that its API is consistent between the client and server.</p><p>We'll also add Redux and a console logger instead of the devtools logger we used in <a class="link" href="ch06.html" title="Chapter 6. Advanced React">Chapter 6</a>, <span class="emphasis"><em>Advanced React</em></span>.</p></div><div class="section" title="Adding files"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec91"/>Adding files</h2></div></div></div><p>We'll add a<a class="indexterm" id="id673"/> number of new files to our project and change a few of the existing ones. The functionality we'll implement is the asynchronous fetching of a set of news items from an offline news API available at <a class="ulink" href="http://reactjsblueprints-newsapi.herokuapp.com/stories">http://reactjsblueprints-newsapi.herokuapp.com/stories</a>. It provides a set of news stories updated at regular intervals.</p><p>We'll start with <code class="literal">client/index.jsx</code>. Open this file and replace the content with this code:</p><div class="informalexample"><pre class="programlisting">'use strict';

import 'babel-polyfill'
import React from 'react';
import ReactDOM from 'react-dom';
import { Router, browserHistory } from 'react-router';
import { Provider } from 'react-redux';
import { routes } from '../routes';
import configureStore from '../shared/store/configureStore';

const initialState = window.__INITIAL_STATE__;
const store = configureStore(initialState);

ReactDOM.render(
  &lt;Provider store={store}&gt;
    &lt;Router routes={routes} history={ browserHistory } /&gt;
  &lt;/Provider&gt;,
  document.getElementById('app')
)</pre></div><p>Here, we add <code class="literal">polyfill</code> and the <code class="literal">Redux</code> setup like we did in <a class="link" href="ch06.html" title="Chapter 6. Advanced React">Chapter 6</a>, <span class="emphasis"><em>Advanced React</em></span>. We also add a check for <code class="literal">window.__INITIAL_STATE__</code>, which is how we'll transfer the server-rendered <a class="indexterm" id="id674"/>content to our app.</p><p>Next, open <code class="literal">routes/index.jsx</code> and replace the content with this code:</p><div class="informalexample"><pre class="programlisting">import React from 'react';

import { Router, Route, IndexRoute } from 'react-router'
import App from '../shared/views/app';
import Error from '../shared/views/error';
import Layout from '../shared/views/layout';
import About from '../shared/views/about';
import Calculator from '../shared/views/calculator';
import News from '../shared/views/news';
import { connect } from 'react-redux';
import { fetchPostsIfNeeded } from '../shared/actions';
import { bindActionCreators } from 'redux';

function mapStateToProps(state) {
  return {
    receivePosts: {
      posts: ('posts' in state) ? state.posts : [],
      isFetching: ('isFetching' in state)
        ? state.isFetching : true,
      lastUpdated: ('lastUpdated' in state)
        ? state.lastUpdated : null
    }
  }
}

function mapFncsToProps(dispatch) {
  return { fetchPostsIfNeeded, dispatch }
}</pre></div><p>These functions are responsible for transmitting state and functions to our <code class="literal">child</code> components. We'll use <a class="indexterm" id="id675"/>them to pass the news stories to our <code class="literal">News</code> component and the <code class="literal">dispatch</code> and <code class="literal">fetchPostsIfNeeded</code> functions. Next, add a new folder to <code class="literal">shared</code> and call it <code class="literal">actions</code>:</p><div class="informalexample"><pre class="programlisting">const routes= &lt;Route path="/"
  name="Shared App" component={ Layout } &gt;
  &lt;Route name="About"
    path="about" component={ About } /&gt;
  &lt;Route name="Calculator"
    path="calculator" component={ Calculator } /&gt;
  &lt;Route name="News" path="news" component={
    connect(mapStateToProps, mapFncsToProps)(News) } /&gt;
  &lt;IndexRoute name="Welcome" component={ App } /&gt;
  &lt;Route path="*" name="Error" component={ Error } /&gt;
&lt;/Route&gt;
export { routes };</pre></div><p>In this folder, add a file called <code class="literal">index.js</code> with this code:</p><div class="informalexample"><pre class="programlisting">'use strict';

import { fetchPostsAsync } from '../api/fetch-posts';

export const RECEIVE_POSTS = 'RECEIVE_POSTS';

export function fetchPostsIfNeeded() {
  return (dispatch, getState) =&gt; {
    if(getState().receivePosts &amp;&amp; getState().receivePosts.length {
      let json=(getState().receivePosts.posts);
      return dispatch(receivePosts(json));
    }
    else return dispatch(fetchPosts());
  }
}</pre></div><p>This function will check whether the stored state exists and has content; if not, it will dispatch a call to <code class="literal">fetchPosts()</code>. This will make sure we will be able to take advantage of the state rendered by the server and fetch the content on the client if no such state exists. Refer to the next function in the following code:</p><div class="informalexample"><pre class="programlisting">export function fetchPosts() {
  return dispatch =&gt; {
    return fetchPostsAsync(json =&gt;  dispatch(receivePosts(json)));
  }
}</pre></div><p>This function returns a <code class="literal">fetch</code> operation from our API file. It dispatches the <code class="literal">receivePosts()</code> function, which is the <code class="literal">Redux</code> function that tells the Redux store to call the <code class="literal">RECEIVE_POSTS</code> reducer function. Let's take a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">export function receivePosts(json) {
  const posts = {
    type: RECEIVE_POSTS,
    posts: json,
    lastUpdated: Date.now()
  };

  return posts;
}</pre></div><p>The next file we'll add <a class="indexterm" id="id676"/>is <code class="literal">fetch-posts.js</code>. Create a folder called <code class="literal">api</code> in <code class="literal">shared</code>, then add the file, and then this code:</p><div class="informalexample"><pre class="programlisting">'use strict';
import fetch from 'isomorphic-fetch'

export function fetchPostsAsync(callback) {
  return fetch(`https://reactjsblueprints-newsapi.herokuapp.com/stories`)
    .then(response =&gt; response.json())
    .then(data =&gt; callback(data))
}</pre></div><p>This function simply returns a set of stories using the fetch API.</p><p>Next, add a folder called <code class="literal">reducers</code> to <code class="literal">shared</code>, then add <code class="literal">index.js</code>, and then this code:</p><div class="informalexample"><pre class="programlisting">'use strict';
import {
  RECEIVE_POSTS
} from '../actions'

function receivePosts(state = { }, action) {
  switch (action.type) {
    case RECEIVE_POSTS:
      return Object.assign({}, state, {
        isFetching: false,
        posts: action.posts,
        lastUpdated: action.lastUpdated
      })
    default:
      return state
  }
}

export default receivePosts;</pre></div><p>Our reducer picks up the new state and returns a new object with the set of posts that we fetched.</p><p>Next, create a folder called <code class="literal">store</code> in <code class="literal">shared</code>, add a file and call it <code class="literal">configure-store.js</code>, and then add this content:</p><div class="informalexample"><pre class="programlisting">import { createStore, applyMiddleware } from 'redux'
import thunkMiddleware from 'redux-thunk'
import createLogger from 'redux-logger'
import rootReducer from '../reducers'

export default function configureStore(initialState) {
  const store = createStore(
    rootReducer,
    initialState,
    applyMiddleware(thunkMiddleware, createLogger())
  )

  return store
}</pre></div><p>We create a function<a class="indexterm" id="id677"/> that takes <code class="literal">initialState</code> and returns a store with our reducer and adds middleware for asynchronous operation and logging. The logger displays log data in the console window of the browser.</p><p>The final two files we add should be placed in the <code class="literal">views</code> folder. The first one is <code class="literal">news.jsx</code>. For this, add the following code:</p><div class="informalexample"><pre class="programlisting">'use strict';

import React, { Component, PropTypes } from 'react'
import { connect } from 'react-redux'
import Posts from './posts';

class App extends Component {
  constructor(props) {
    super(props)
    this.state={};
    this.state._activePost=-1;
  }</pre></div><p>We'll initialize the state by setting <code class="literal">_activePost</code> to <code class="literal">-1</code>. This will prevent the component from showing the <a class="indexterm" id="id678"/>body of any post before the user has had time to click on any post. Refer to the following:</p><div class="informalexample"><pre class="programlisting">  componentDidMount() {
    const { fetchPostsIfNeeded, dispatch } = this.props
    dispatch(fetchPostsIfNeeded())
  }

  handleClickCallback(i) {
    this.setState({_activePost:i});
  }</pre></div><p>This is our callback handler in <code class="literal">posts.jsx</code>. When the user clicks on a news headline, a new state will be set with the ID of the news item, let's take a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">  render() {
    const { posts, isFetching, lastUpdated } =
    this.props.receivePosts
    const { _activePost } = this.state;
    return (
      &lt;div&gt;
        &lt;p&gt;
          {lastUpdated &amp;&amp;
            &lt;span&gt;
              Last updated at {new Date(lastUpdated)
              .toLocaleTimeString()}.
            &lt;/span&gt;
          }
        &lt;/p&gt;
        {posts &amp;&amp; isFetching &amp;&amp; posts.length === 0 &amp;&amp;
          &lt;h2&gt;Loading...&lt;/h2&gt;
        }
        {posts &amp;&amp; !isFetching &amp;&amp; posts.length === 0 &amp;&amp;
          &lt;h2&gt;Empty.&lt;/h2&gt;
        }
        {posts &amp;&amp; posts.length &gt; 0 &amp;&amp;
          &lt;div style={{ opacity: isFetching ? 0.5 : 1 }}&gt;
            &lt;Posts posts={posts} activePost={_activePost} 
              onClickHandler={this.handleClickCallback.bind(this)} /&gt;
          &lt;/div&gt;
        }</pre></div><p>The <code class="literal">Posts</code> component will be given a set of posts, an active post, and an <code class="literal">onClick</code> handler. The <code class="literal">onClick</code> handler needs to have the <code class="literal">App</code> context bound or else it will not be able to use internal methods, such as <code class="literal">setState</code>. If we don't bind it, <code class="literal">setState</code> will apply to the context of the <code class="literal">Posts</code> component instead, let's take a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">      &lt;/div&gt;
    )
  }
}

App.propTypes = {
  receivePosts: React.PropTypes.shape({
    posts: PropTypes.array.isRequired,
    isFetching: PropTypes.bool.isRequired,
    lastUpdated: PropTypes.number
  }),
  dispatch: PropTypes.func.isRequired,
  fetchPostsIfNeeded: PropTypes.func.isRequired
}</pre></div><p>We'll use <code class="literal">propTypes</code> <a class="indexterm" id="id679"/>so that the React devtools can let us know if any of the incoming props are missing or have the wrong type:</p><div class="informalexample"><pre class="programlisting">function mapStateToProps(state) {
  return {
    receivePosts: {
      posts: ('posts' in state) ?  state.posts : [],
      isFetching: ('isFetching' in state) ?
        state.isFetching : true,
      lastUpdated: ('lastUpdated' in state) ?
        state.lastUpdated : null
    }
  }
}</pre></div><p>We export the app state so that it's available for components importing the current one:</p><div class="informalexample"><pre class="programlisting">export default connect(mapStateToProps)(App)</pre></div><p>The second file we add to <code class="literal">views</code> is <code class="literal">posts.jsx</code>:</p><div class="informalexample"><pre class="programlisting">'use strict';
import React, { PropTypes, Component } from 'react'

export default class Posts extends Component {
  render() {
    function createmarkup(html) { return {__html: html}; };
    return (
      &lt;ul&gt;
        {this.props.posts.map((post, i) =&gt;
        &lt;li key={i}&gt;
          &lt;a onClick={this.props.onClickHandler.bind(this,i)}&gt; 
          {post.title}&lt;/a&gt;
            {this.props.activePost===i ?
            &lt;div style={{marginBottom: 15}}
              dangerouslySetInnerHTML= {createmarkup(post.body)} /&gt;:
            &lt;div/&gt;
          }</pre></div><p>The RSS bodies come <a class="indexterm" id="id680"/>with their own HTML. We must explicitly allow this HTML to be rendered or else ReactJS will escape the content. When the user clicks on a headline, the callback executes <code class="literal">handleClickCallback</code> in <code class="literal">posts.jsx</code>. It will set a new state in <code class="literal">news.jsx</code>, and this state will be passed to <code class="literal">posts.jsx</code> as a prop, signaling that the body of this headline should be displayed, let's take a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">        &lt;/li&gt;
        )}
      &lt;/ul&gt;
    )
  }
}

Posts.propTypes = {
  posts: PropTypes.array.isRequired,
  activePost: PropTypes.number.isRequired
}</pre></div><p>We'll also need to add a link to the news items in our <code class="literal">app.jsx</code> file. Open the file and add this line:</p><div class="informalexample"><pre class="programlisting">&lt;li&gt;&lt;Link to="/news"&gt;News&lt;/Link&gt;&lt;/li&gt;</pre></div><p>With these changes, you're ready to run your app. Start it with <code class="literal">npm run dev</code>. You should be able to go to the front page on <code class="literal">http://localhost:8080</code> and click on the news link. It should display <span class="strong"><strong>Loading</strong></span> until the content is fetched from the server. Here's a screenshot illustrating this:</p><div class="mediaobject"><img alt="Adding files" src="graphics/B04943_09_03.jpg"/></div><p>The screenshot shows <a class="indexterm" id="id681"/>that the news data is loaded and displayed even though JavaScript is blocked in the browser.</p></div><div class="section" title="Adding server rendering"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec92"/>Adding server rendering</h2></div></div></div><p>We're very close now, but <a class="indexterm" id="id682"/>we still have a little bit of work to do before we're done. We need to add data fetching to our Express server. Let's open up <code class="literal">server-production.es6</code> and add the code necessary to prefetch data.</p><p>Add these imports somewhere at the top of the file:</p><div class="informalexample"><pre class="programlisting">import { Provider } from 'react-redux'
import configureStore from './build/shared/store/configure-store'
import { fetchPostsAsync } from './build/shared/api/fetch-posts'</pre></div><p>Then, replace <code class="literal">const approutes</code> with this code:</p><div class="informalexample"><pre class="programlisting">const appRoutes = (app) =&gt; {
  app.get('*', (req, res) =&gt; {
    match({ routes, location: req.url },
    (err, redirectLocation, props) =&gt; {
      if (err) {
        res.status(500).send(err.message);
      }
      else if (redirectLocation) {
        res.redirect(302, redirectLocation.pathname +
          redirectLocation.search);
      }
      else if (props) {

      fetchPostsAsync(posts =&gt; {
        const isFetching = false;
        const lastUpdated = Date.now()
        const initialState = {
          posts,
          isFetching,
          lastUpdated
        }

        const store = configureStore(initialState)</pre></div><p>Here, we start the <code class="literal">fetchPostsAsync</code> function. When we receive a result, we create an initial state with the<a class="indexterm" id="id683"/> news items and then create a new Redux store instance with this state, let's take a look at the following code snippet:</p><div class="informalexample"><pre class="programlisting">        res.write(`&lt;!DOCTYPE html&gt;
          &lt;html&gt;
            &lt;head&gt;
              &lt;meta charSet="utf-8" /&gt;
              &lt;meta httpEquiv="X-UA-Compatible" content="IE=edge" /&gt;
              &lt;meta name="viewport" content="width=device-width,
                initial-scale=1, maximum-scale=1, user-scalable=no"/&gt;
              &lt;link async rel="stylesheet" type="text/css"
                href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"/&gt;
              &lt;link async rel="stylesheet" type="text/css" 
                href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" /&gt;
              &lt;link async href='https://fonts.googleapis.com/css?family=Bitter'
              rel='stylesheet' type='text/css'/&gt;
              &lt;link async rel="stylesheet" href="/app.css" /&gt;
                &lt;title&gt;${settings.title}&lt;/title&gt;
            &lt;/head&gt;
            &lt;script&gt;
              window.__INITIAL_STATE__ = 
              ${JSON.stringify(initialState)}
            &lt;/script&gt;</pre></div><p>We add the initial state<a class="indexterm" id="id684"/> to the global window so that we can pick it up in <code class="literal">client/index.jsx</code>, let's take a look at the remaining code:</p><div class="informalexample"><pre class="programlisting">            &lt;body&gt;&lt;div id="app"&gt;`);
            const stream = ReactDOMStream.renderToString(
            &lt;Provider store={store}&gt;
            &lt;RoutingContext {...props} /&gt;
            &lt;/Provider&gt;);
            stream.pipe(res, {end: false});
            stream.on("end", ()=&gt; {
            res.write(`&lt;/div&gt;&lt;script src="/bundle.js"&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;`);
              res.end();
            });''
          })
        } else {
        res.sendStatus(404);
      }
    });
  });
}</pre></div><p>That's all you need to prefetch the data. You should now be able to execute <code class="literal">npm start</code> and then open <code class="literal">http://localhost:8080</code>. Try turning off JavaScript in your browser, and you should still be able to navigate and see the items in the news list.</p><p>You can also create a new Heroku instance, run <code class="literal">npm deploy</code>, and then push it.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note34"/>Note</h3><p>You can view a demo online at <a class="ulink" href="https://reactjsblueprints-shared.herokuapp.com">https://reactjsblueprints-shared.herokuapp.com</a>.</p></div></div></div><div class="section" title="Performing faster cloud deployment"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec93"/>Performing faster cloud deployment</h2></div></div></div><p>When you push to <a class="indexterm" id="id685"/>Heroku now, what will happen is that Heroku will execute <code class="literal">npm start</code>, kicking off the entire build process. This is problematic because if the build process is too time consuming or demands too much of resources, it will fail.</p><p>You can prevent this by committing the <code class="literal">build</code> folder to your repository and then simply execute <code class="literal">node server-production.js</code> on push. You can do this by adding a special start up file called <code class="literal">Procfile</code> to the <a class="indexterm" id="id686"/>repository. Create this file in the root of your project and add this line:</p><div class="informalexample"><pre class="programlisting">web: NODE_ENV=production node server-production.js</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note35"/>Note</h3><p>Note that this file is specific to Heroku. Other cloud providers may have a different system in place to specify the start up procedure.</p></div></div></div></div>
<div class="section" title="The final structure"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec52"/>The final structure</h1></div></div></div><p>This is how our final app structure looks like (excluding the <code class="literal">build</code> folder, which is essentially the same as the <code class="literal">source</code> folder):</p><div class="informalexample"><pre class="programlisting">├── .babelrc
├── Procfile
├── assets
│   ├── app.css
│   ├── favicon.ico
│   └── index.html
├── config.js
├── package.json
├── server-development.js
├── server-production.es6
├── server-production.js
├── source
│   ├── client
│   │   └── index.jsx
│   ├── routes
│   │   └── index.jsx
│   └── shared
│       ├── actions
│       │   └── index.js
│       ├── api
│       │   └── fetch-posts.js
│       ├── reducers
│       │   └── index.js
│       ├── settings.js
│       ├── store
│       │   └── configure-store.js
│       └── views
│           ├── about.jsx
│           ├── app.jsx
│           ├── calculator.jsx
│           ├── error.jsx
│           ├── layout.jsx
│           ├── news.jsx
│           └── posts.jsx
├── Webpack-development.config.js
└── Webpack-production.config.js</pre></div><p>The server structure remains more or less the same, and the <code class="literal">source</code> folder is the only one that is growing. This is how it should be.</p><p>It's worth looking at the structure as you develop your apps. It provides a bird's eye view that can help you spot inconsistencies in naming and other structural issues. For instance, does the component <code class="literal">layout.jsx</code> really belong in views? How about <code class="literal">posts.jsx</code>? It's a view component, but it can be argued that it's a helper to <code class="literal">news.jsx</code> and may possibly belong somewhere else.</p></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec53"/>Summary</h1></div></div></div><p>In this chapter, we modified our Webpack scaffold to enable cloud deployment. In the second part of the chapter, we added server rendering, and in the third part, we added Redux and the prefetching of data asynchronously.</p><p>With these three projects, you should be able to produce any kind of app, be they small or large. However, as you may have noticed, writing an app that supports server rendering requires a fair amount of thought and organization. As the application increases in size, it becomes even more difficult to reason out the organization and data-fetching strategies. You'll be able to make really efficient apps with this strategy, but I'd advise you to spend time thinking through how you structure your application.</p><p>The demos for this chapter are available at <a class="ulink" href="https://reactjsblueprints-srvdeploy.herokuapp.com/">https://reactjsblueprints-srvdeploy.herokuapp.com/</a> and <a class="ulink" href="https://reactjsblueprints-shared.herokuapp.com">https://reactjsblueprints-shared.herokuapp.com</a>. The first link showcases the app as it is when server rendering is added. The second shows the final app where we fetch data on the server side and populate a Redux store before rendering the app to the user.</p><p>In the next chapter, we'll create a game with ReactJS. We'll use the HTML5 canvas technology and add Flowtype for static type checking.</p></div></body></html>