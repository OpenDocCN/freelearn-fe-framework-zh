<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Working with Geolocation and Maps"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Working with Geolocation and Maps</h1></div></div></div><p>So far you've seen that React Native simplifies the creation of native UI components, such as lists, text fields, and buttons, and it gives you simple abstractions, such as AsyncStorage, to work with underlying native APIs. Soon, you'll see that you also have access to advanced components, such as maps using the <code class="literal">MapView</code> component, and that you can access more advanced native features, such as geolocation using React Native's Geolocation API. We'll demonstrate these capabilities by adding the ability to capture and save current GPS coordinates with each new note. Note that the next two chapters will focus on iOS development, as the feature set for Android is not complete.</p><p>In this chapter we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Learning how to get the current geolocation</li><li class="listitem" style="list-style-type: disc">Listening for changes to the user's position</li><li class="listitem" style="list-style-type: disc">Ensuring that our app requires appropriate permissions</li><li class="listitem" style="list-style-type: disc">Saving location data with each note</li><li class="listitem" style="list-style-type: disc">Displaying the original locations of all the notes on a <code class="literal">MapView</code></li></ul></div><p>Let's get started!</p><div class="section" title="Introducing the Geolocation API"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec26"/>Introducing the Geolocation API</h1></div></div></div><p>React Native <a id="id166" class="indexterm"/>provides an easy-to-use abstraction over the native Geolocation APIs. It follows the <span class="strong"><strong>MDN</strong></span> (<span class="strong"><strong>Mozilla Developer Network</strong></span>) specification, which recommends the following geolocation interface:</p><div class="informalexample"><pre class="programlisting">navigator.geolocation.getCurrentPosition(success, error, options)</pre></div><p>This method <code class="literal">asynchronously</code> asks for the device's current location and will call the <code class="literal">success</code> callback with a <code class="literal">Position</code> object if it is successful and the <code class="literal">error</code> callback if it fails (usually, due to misconfigured permissions in your app or the user explicitly rejecting the request to allow your app to know their location). The <code class="literal">options</code> argument allows you to request higher position accuracy, define how long you're willing to wait for a response, and specify the maximum age of cached data that you're willing to accept:</p><div class="informalexample"><pre class="programlisting">navigator.geolocation.watchPosition(success, error, options)</pre></div><p>This function <a id="id167" class="indexterm"/>enables you to register a function that will be called each time the position changes. This function returns an integer that represents the <code class="literal">id</code> of the callback you registered. This allows you to stop listening for updates by calling the following:</p><div class="informalexample"><pre class="programlisting">navigator.geolocation.clearWatch(id);</pre></div><div class="section" title="The location permission in iOS"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec24"/>The location permission in iOS</h2></div></div></div><p>Before<a id="id168" class="indexterm"/> we begin integrating geolocation into our notes, we need to configure a permission to request the user's location. From Xcode, open <code class="literal">info.plist</code> and make sure that the <code class="literal">NSLocationWhenInUseUsageDescription</code> key is located in the file (it should be enabled by default):</p><div class="mediaobject"><img src="graphics/B05162_06_00.jpg" alt="The location permission in iOS"/></div><p>Once the application starts up, you should see a permission modal automatically pop up in the center of the screen:</p><div class="mediaobject"><img src="graphics/B05162_06_01.jpg" alt="The location permission in iOS"/></div></div></div></div>
<div class="section" title="Tagging notes with geolocation"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec27"/>Tagging notes with geolocation</h1></div></div></div><p>Let's take <a id="id169" class="indexterm"/>geolocation for a spin and start capturing the user's location when they save a new note. Since we're going to be using the location data when we save notes, we'll add our code to the <code class="literal">ReactNotes</code> component in <code class="literal">index.ios.js</code> or <code class="literal">index.android.js</code>. Let's begin by adding a function called <code class="literal">trackLocation()</code>:</p><div class="informalexample"><pre class="programlisting">class ReactNotes extends React.Component {
  trackLocation() {
    navigator.geolocation.getCurrentPosition(
      (initialPosition) =&gt; this.setState({initialPosition}),
      (error) =&gt; alert(error.message)
    );
    this.watchID = navigator.geolocation.watchPosition((lastPosition) =&gt; {
      this.setState({lastPosition});
    });
  }

 …
}</pre></div><p>Here we <a id="id170" class="indexterm"/>call <code class="literal">getCurrentPosition</code> and provide a callback that will update the current state with the position information returned from the device. We also provide an error handler if something goes wrong.</p><p>Next, we use <code class="literal">watchPosition()</code> to register an event handler that will be called when the user's position changes. We also save the <code class="literal">watchId</code> that is returned from this call, so that we can stop listening when the component has been unmounted. It is generally good practice to clear up any listeners you initially set up in your constructor or <code class="literal">componentDidMount</code> method from the <code class="literal">componentWillUnmount</code> function:</p><div class="informalexample"><pre class="programlisting">class ReactNotes extends React.Component {
  componentWillUnmount() {
    navigator.geolocation.clearWatch(this.watchID);
  }
  trackLocation() {
    …
  }
 …
}</pre></div><p>Then, we'll call our <code class="literal">trackLocation()</code> function from the constructor and add some notes with the position data to our initial state:</p><div class="informalexample"><pre class="programlisting">class ReactNotes extends React.Component {
  constructor (props) {
    super(props);
    StatusBarIOS.setStyle('light-content');

    this.state = {
      notes: {
        1: {
          title: "Note 1",
          body: "body",
          id: 1,
          location: {
            coords: {
              latitude: 33.987,
              longitude: -118.47
            }
          }
        },
        2: {
          title: "Note 2",
          body: "body",
          id: 2,
          location: {
            coords: {
              latitude: 33.986,
              longitude: -118.46
            }
          }
        }
      }
    };

    this.loadNotes();
    this.trackLocation();
  }</pre></div><p>Saving the <a id="id171" class="indexterm"/>position data with a note requires a minor adjustment to our <code class="literal">updateNote()</code> function:</p><div class="informalexample"><pre class="programlisting">  updateNote(note) {
    var newNotes = Object.assign({}, this.state.notes);

    if (!note.isSaved) {
      note.location = this.state.lastPosition;
    }

    note.isSaved = true;
    newNotes[note.id] = note;
    this.setState({notes:newNotes});
    this.saveNotes(newNotes);
  }</pre></div><p>That's all there is to it! Reload the app, create a new note, and the GPS coordinates will be stored when the note is saved for the first time. But how can we visualize the position data associated with each of our notes? Let's make a <code class="literal">MapView</code> to display pins for each note!</p><p>The complete <a id="id172" class="indexterm"/>documentation of geolocation can be found in the React Native documentation at <a class="ulink" href="https://facebook.github.io/react-native/docs/geolocation.html">https://facebook.github.io/react-native/docs/geolocation.html</a>.</p></div>
<div class="section" title="NoteLocationScreen"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec28"/>NoteLocationScreen</h1></div></div></div><p>Now, since we <a id="id173" class="indexterm"/>are capturing the location of the user on note creation, we want to display this information in a useful manner. Location data perfectly matches up with showing the notes on a map UI. This way the user can visually see all of the notes that they have created. We are going to create a new component called <code class="literal">NoteLocationScreen</code> to house our note locations, but before writing the code for this screen, let's begin by adding the navigation.</p><p>On the home screen, we want to have a <span class="strong"><strong>Map</strong></span> button in the <code class="literal">navbar</code> to transition to the <code class="literal">NoteLocationScreen</code>. Update the <code class="literal">LeftButton</code> and <code class="literal">Title</code> in <code class="literal">NavigationBarRouteMapper</code> to the following:</p><div class="informalexample"><pre class="programlisting">var NavigationBarRouteMapper = {
  LeftButton: function(route, navigator, index, navState) {
    switch (route.name) {
      case 'home':
        return (
          &lt;SimpleButton
            onPress={() =&gt; navigator.push({name: 'noteLocations'})}
            customText='Map'
            style={styles.navBarLeftButton}
            textStyle={styles.navBarButtonText}
           /&gt;
        );
      case 'createNote':
      case 'noteLocations':
        return (
          &lt;SimpleButton
            onPress={() =&gt; navigator.pop()}
            customText='Back'
            style={styles.navBarLeftButton}
            textStyle={styles.navBarButtonText}
           /&gt;
        );
      default:
        return null;
    }
  },
  ...

  Title: function(route, navigator, index, navState) {
    switch (route.name) {
      case 'home':
        return (
          &lt;Text style={styles.navBarTitleText}&gt;React Notes&lt;/Text&gt;
        );
      case 'createNote':
        return (
          &lt;Text style={styles.navBarTitleText}&gt;{route.note ? route.note.title : 'Create Note'}&lt;/Text&gt;
        );
      case 'noteLocations':
        return (
          &lt;Text style={styles.navBarTitleText}&gt;Note Locations&lt;/Text&gt;
        );
    }
  }
}</pre></div><p>Here, we are defining <a id="id174" class="indexterm"/>a new route called <code class="literal">noteLocations</code>. Notice that we also want the <code class="literal">back</code> button to be displayed on the <code class="literal">noteLocation</code> route, so we include the case along with the <code class="literal">createNote</code> route.</p><p>If you haven't already, add a new <code class="literal">NoteLocationScreen.js</code> file to <code class="literal">App/Components/</code> and import it into <code class="literal">ReactNotes</code>. The last thing we need to do is include it in our <code class="literal">renderScene</code> function. We are going to pass it in the list of notes and the same <code class="literal">onSelectNote</code> function to our <code class="literal">NoteLocationScreen</code>:</p><div class="informalexample"><pre class="programlisting">import NoteLocationScreen from './App/Components/NoteLocationScreen';

...

class ReactNotes extends React.Component {
  ...

  renderScene(route, navigator) {
    switch (route.name) {
      case 'home':
        return (
          &lt;HomeScreen navigator={navigator} notes={_(this.state.notes).toArray()} onSelectNote={(note) =&gt; navigator.push({name:"createNote", note: note})} /&gt;
        );
      case 'createNote':
        return (
          &lt;NoteScreen note={route.note} onChangeNote={(note) =&gt; this.updateNote(note)} /&gt;
        );
      case 'noteLocations':
        return (
          &lt;NoteLocationScreen notes={this.state.notes} onSelectNote={(note) =&gt; navigator.push({name:"createNote", note: note})} /&gt;
        );
    }
  }

  ...

}</pre></div><div class="section" title="MapView"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec25"/>MapView</h2></div></div></div><p>MapView<a id="id175" class="indexterm"/> is another component provided by React Native to display the map corresponding to each platform: Apple Maps on iOS and Google Maps on Android. You can start by adding the <code class="literal">MapView</code> to the <code class="literal">NoteLocationScreen</code>:</p><div class="informalexample"><pre class="programlisting">import React, {
  MapView,
  StyleSheet
} from 'react-native';

export default class NoteLocationScreen extends React.Component {
  render () {
    return (
      &lt;MapView
        showsUserLocation={true}
        style={styles.map}
      /&gt;
    );
  }
}

var styles = StyleSheet.create({
  map: {
    flex: 1,
    marginTop: 64
  }
});</pre></div><div class="mediaobject"><img src="graphics/B05162_06_02.jpg" alt="MapView"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note13"/>Note</h3><p>If the map does not show your location on iOS, you may need to enable locations in the simulator. Set a custom location by navigating to <span class="strong"><strong>Debug</strong></span> | <span class="strong"><strong>Location</strong></span> | <span class="strong"><strong>Custom Location</strong></span>.</p></div></div><p>The <code class="literal">showsUserLocation</code> function<a id="id176" class="indexterm"/> will zoom and display the location of the user on the map; by default, this value is <code class="literal">false</code>. Next, we want to gather all the notes locations to display them on our map using annotations. The annotation format accepts an object with <code class="literal">longitude</code>, <code class="literal">latitude</code>, some <code class="literal">title</code> information, and <code class="literal">on</code> <code class="literal">press</code> attributes. We will loop through the list of notes passed via props and extract the location data. The list of annotations is then passed to the MapView's <code class="literal">annotations</code> prop:</p><div class="informalexample"><pre class="programlisting">export default class NoteLocationScreen extends React.Component {
  render () {
    var locations = _.values(this.props.notes).map((note) =&gt; {
      return {
        latitude: note.location.coords.latitude,
        longitude: note.location.coords.longitude,
        title: note.title
      };
    });

    return (
      &lt;MapView
        annotations={locations}
        showsUserLocation={true}
        style={styles.map}
      /&gt;
    );
  }
}</pre></div><div class="mediaobject"><img src="graphics/B05162_06_03.jpg" alt="MapView"/></div><p>We can also add <a id="id177" class="indexterm"/>the ability to view the note by adding a <code class="literal">callout on press</code> function to the annotations. The <code class="literal">callout on press</code> method will invoke the <code class="literal">onNoteSelect</code> function we passed in and transition to the <code class="literal">NoteScreen</code>. Here we are adding a <code class="literal">left callout</code>:</p><div class="informalexample"><pre class="programlisting">export default class NoteLocationScreen extends React.Component {
  render () {
    var locations = _.values(this.props.notes).map((note) =&gt; {
      return {
        latitude: note.location.coords.latitude,
        longitude: note.location.coords.longitude,
        hasLeftCallout: true,
        onLeftCalloutPress: this.props.onSelectNote.bind(this, note),
        title: note.title
      };
    });

  ...

}</pre></div><div class="mediaobject"><img src="graphics/B05162_06_04.jpg" alt="MapView"/></div><p>Check the React Native documentation for more details <a id="id178" class="indexterm"/>on <code class="literal">MapView</code> at <a class="ulink" href="https://facebook.github.io/react-native/docs/mapview.html">https://facebook.github.io/react-native/docs/mapview.html</a>.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec29"/>Summary</h1></div></div></div><p>In this chapter, we explored more of React Native's built-in components and modules to capture the device-specific location data. The Geolocation API provides us the mechanism which hooks into the existing component life cycle to track user location. By incorporating this into our existing saved data, we can use the longitude and latitude values to display a map of where all of our notes were taken.</p></div></body></html>