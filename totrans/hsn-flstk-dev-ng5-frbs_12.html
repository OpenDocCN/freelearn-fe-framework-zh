<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Firebase Security and Hosting</h1>
                
            
            <article>
                
<p class="calibre2">Fi<span>rebase provides flexible security rules with a JavaScript-like syntax, as this helps to structure our data and index the frequently used data. Security rules are integrated with F</span>irebase <span>authentication, which helps to define read and write access based on the user. In this chapter, we will add security rules for users and chat nodes to our Firebase database. Firebase security rules provide a nice simulator to check new rules before releasing them into production. We will also index our user's and their friends data for faster queries. Finally, we will deploy our application to the Firebase server. We will set up a different deployment environment so that we can test our application in the staging server and then deploy the application to the production server.</span><br class="title-page-name"/></p>
<p class="calibre2"><span>In this chapter, we will cover the following topics:</span></p>
<ul class="calibre7">
<li class="calibre8">Introducing Firebase security </li>
<li class="calibre8">Adding security rules for users</li>
<li class="calibre8">Adding security rules for chat messages</li>
<li class="calibre8">Indexing users and their friends</li>
<li class="calibre8">Setting up multiple deployment environments</li>
<li class="calibre8">Hosting the friends app in Firebase</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Introducing Firebase security</h1>
                
            
            <article>
                
<p class="calibre2">Firebase security provides tools to manage the security of our application, as we can add rules and validate inputs for our data in the Firebase database. Firebase provides the following security for our application:</p>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Authentication</strong>: The first step to secure our application is to identify the user. Firebase authentication supports multiple authentication mechanisms, such as Google, Facebook, email, and password authentication.</li>
<li class="calibre8"><strong class="calibre1">Authorization</strong>: Once the user is authenticated, we will need to control the access to data in our database. Firebase security rules has built-in variables and functions, such as an <kbd class="calibre11">auth</kbd> object, as it helps to control read and write operations for users.</li>
</ul>
<p class="calibre2">Go to the Firebase portal and navigate to <span>Database|</span><span>RULES</span> tab. The default Firebase security rule is as follows; the <kbd class="calibre11">auth!= null</kbd> <span>condition </span>means that only authenticated users have access to data in the Firebase database.</p>
<p class="calibre2"> </p>
<div class="cdpaligncenter"><img src="../images/00057.jpeg" class="calibre71"/></div>
<p class="calibre2">Firebase security rules provides the following four types of functions:</p>
<ul class="calibre7">
<li class="calibre8"><kbd class="calibre11">.read</kbd>: We can define this function for the data and control the user's read operation.</li>
</ul>
<p class="mce-root">The following example shows that only a logged-in user can read their own user data:</p>
<pre class="calibre18">{<br class="title-page-name"/>    "rules":{<br class="title-page-name"/>        "users":{<br class="title-page-name"/>            "$uid":{<br class="title-page-name"/>                ".read": "auth != null &amp;&amp; $uid === auth.uid"<br class="title-page-name"/>            }<br class="title-page-name"/>        }<br class="title-page-name"/>    }<br class="title-page-name"/>}</pre>
<ul class="calibre7">
<li class="calibre8"><kbd class="calibre11">.write</kbd>: We define this for the data and control the user's write operation.</li>
</ul>
<p class="mce-root"><span>The following example shows that only a logged-in user can write on their own user data node:</span></p>
<pre class="calibre18">{<br class="title-page-name"/>    "rules":{<br class="title-page-name"/>        "users":{<br class="title-page-name"/>            "$uid":{<br class="title-page-name"/>                ".write": "auth != null &amp;&amp; $uid === auth.uid"<br class="title-page-name"/>            }<br class="title-page-name"/>        }<br class="title-page-name"/>    }<br class="title-page-name"/>}</pre>
<ul class="calibre7">
<li class="calibre8"><kbd class="calibre11">.validate</kbd>: This function maintains the integrity of the data, and this variable provides data validation.</li>
</ul>
<p class="mce-root"><span>The following example validates the <kbd class="calibre11">name</kbd> field to be a string:</span></p>
<pre class="calibre18">{<br class="title-page-name"/>  "rules":{<br class="title-page-name"/>     "users":{<br class="title-page-name"/>        "$uid":{<br class="title-page-name"/>           "name": {<br class="title-page-name"/>              ".validate":"newData.isString()"                  <br class="title-page-name"/>            }<br class="title-page-name"/>          }<br class="title-page-name"/>        }<br class="title-page-name"/>     }<br class="title-page-name"/>}</pre>
<ul class="calibre7">
<li class="calibre8"><kbd class="calibre11">.indexOn</kbd>: This provides a child index for the querying and ordering of data.</li>
</ul>
<p class="mce-root"><span>In the following </span>example, we index the <kbd class="calibre11">name</kbd> field of user data.</p>
<pre class="calibre18">{<br class="title-page-name"/>  "rules":{<br class="title-page-name"/>     "users":{<br class="title-page-name"/>        ".indexOn": ["name"],<br class="title-page-name"/>        "$uid":{<br class="title-page-name"/>           "name": {<br class="title-page-name"/>              ".validate":"newData.isString()"                  <br class="title-page-name"/>            }<br class="title-page-name"/>          }<br class="title-page-name"/>        }<br class="title-page-name"/>     }<br class="title-page-name"/>}</pre>
<p class="calibre2">Firebase security rules also provide the following predefined variables, which are used to define the security rules:</p>
<ul class="calibre7">
<li class="calibre8"><kbd class="calibre11">root</kbd>: This variable gives a <kbd class="calibre11">RuleDataSnapshot</kbd> instance to access data from the root of the Firebase database.</li>
</ul>
<p class="mce-root">The following root variables are used to traverse the Firebase database path from the root user node:</p>
<pre class="calibre18">{<br class="title-page-name"/>  "rules":{<br class="title-page-name"/>     "users":{<br class="title-page-name"/>        "$uid":{<br class="title-page-name"/>           "image": {               <br class="title-page-name"/>             ".read":"root.child('users').<br class="title-page-name"/>             child(auth.uid).child('image').val() === ''"                  <br class="title-page-name"/>            }<br class="title-page-name"/>          }<br class="title-page-name"/>        }<br class="title-page-name"/>     }<br class="title-page-name"/>}</pre>
<ul class="calibre7">
<li class="calibre8"><kbd class="calibre11">newData</kbd>: This variable provides a <kbd class="calibre11">RuleDataSnapshot</kbd> instance that represents the new data, which exists after the insert operation.</li>
</ul>
<p class="mce-root">The following example validates the new data to be a string:</p>
<pre class="calibre18">"name": {<br class="title-page-name"/>    ".validate":"newData.isString()"                  <br class="title-page-name"/>}</pre>
<ul class="calibre7">
<li class="calibre8"><kbd class="calibre11">data</kbd>: This variable gives a <kbd class="calibre11">RuleDataSnapshot</kbd> instance that represents the data that exists before the insert operation.</li>
</ul>
<p class="mce-root"><span>The following </span>example shows that the current data in the <kbd class="calibre11">name</kbd> field is not null:</p>
<pre class="calibre18">"user": {<br class="title-page-name"/>   "$uid":{<br class="title-page-name"/>      ".read":"data.child('name').val() != null"<br class="title-page-name"/>   }<br class="title-page-name"/>}</pre>
<ul class="calibre7">
<li class="calibre8"><kbd class="calibre11">$variables</kbd>: This variable represents the dynamic IDs and keys.</li>
</ul>
<p class="mce-root">In the following example, the unique ID is assigned to the <kbd class="calibre11">$uid</kbd> variable:</p>
<pre class="calibre18">"user": {<br class="title-page-name"/>   "$uid":{<br class="title-page-name"/>   }<br class="title-page-name"/>}</pre>
<ul class="calibre7">
<li class="calibre8"><kbd class="calibre11">auth</kbd>: This represents the <kbd class="calibre11">auth</kbd> object, which provides the UID of the user.</li>
</ul>
<p class="mce-root">In the following example, we access the <kbd class="calibre11">auth</kbd> object to get a UID of a user:</p>
<pre class="calibre18">"$uid":{<br class="title-page-name"/>    ".write": "auth != null &amp;&amp; $uid === auth.uid"<br class="title-page-name"/> }</pre>
<ul class="calibre7">
<li class="calibre8"><kbd class="calibre11">now</kbd>: This variable provides the current time in milliseconds and helps to validate the time stamp.</li>
</ul>
<p class="mce-root">In the following example, we conclude that the time stamp is greater than the current time:</p>
<pre class="calibre18">"$uid":{<br class="title-page-name"/>    ".write": "newData.child('timestamp').val() &gt;   now"<br class="title-page-name"/> }</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Adding security rules for users</h1>
                
            
            <article>
                
<p class="calibre2">In our application, users' details play a critical part, so we need to provide security rules for our users' details. We have already seen the default settings for security. By default, only an authenticated user can access any part of our Firebase database. We will modify the security rules for the user node and retain the default security rules for the other nodes for now.</p>
<p class="calibre2">As you can see from the following screenshot, for <kbd class="calibre11">users</kbd> node, <kbd class="calibre11">read</kbd> and <kbd class="calibre11">write</kbd> operations are allowed for an authentic user with the same unique user ID; we will also need to validate the type of data in our user node to maintain the data integrity:</p>
<div class="cdpaligncenter"><img src="../images/00058.jpeg" class="calibre49"/></div>
<p class="calibre2">To validate the<span> changes in</span> our security rules, Firebase provides a simulator to test our changes before deploying it into production. You will see a <span>SIMULATOR</span> option <span>on the top-right corner of the <span>RULES</span> tab</span>. This tool provides the mock operation without actually performing any CRUD operation within the database. We will test the following scenarios on the simulator:</p>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Successful read operation for an authentic user</strong>: Open the simulator and enable the <span>Authenticated</span> switch button; it provides a mock uid in the <span>Auth token payload</span> text box. In the <span>Location</span> text box, we enter the path as <kbd class="calibre11">/users/6e115890-7802-4f56-87ed-4e6ac359c2e0</kbd> and click on the <span>RUN</span> button. <span>This operation will be successful when the <span>Simulated read allowed</span> message appears, as shown in the following screenshot</span>:</li>
</ul>
<div class="cdpaligncenter"><img src="../images/00059.jpeg" class="calibre49"/></div>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Successful write operation with an authentic user and proper data</strong>: In this scenario, we will provide a location path with the user UID with the string name data as JSON payload in the simulator. <span>When we click on <span>RUN</span>, this operation is considered successful when the <span>Simulated write allowed</span> message appears, as shown in the following screenshot.</span> Also, the succeeding screenshots show two ticks, which indicates that our authorization and data validation have been successful.</li>
</ul>
<div class="cdpaligncenter"><img src="../images/00060.jpeg" class="calibre49"/></div>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Failed write operation with a different UID</strong>: In this scenario, we provide a wrong UID in the user path location and then perform the same write operation. This operation fails, resulting in a <span>Simulated write denied</span><span> message </span>and a cross on the write tag, as follows; you can take a look at more error details by clicking on the <span>DETAILS</span> button:</li>
</ul>
<div class="cdpaligncenter"><img src="../images/00061.jpeg" class="calibre49"/></div>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Failed write operation with data validation:</strong> In this scenario, we provide the correct user UID path in <span>Location</span> but the wrong data type in payload. For example, we will give number data type for a string name data. This operation fails in data validation tag, as follows:</li>
</ul>
<div class="cdpaligncenter"><img src="../images/00062.jpeg" class="calibre72"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Adding security rules for chat messages</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we will enable the security rules for chat messages. The message details node contains two identifiers, as follows:</p>
<ul class="calibre7">
<li class="calibre8"><kbd class="calibre11">$identifierKey</kbd>: The first is the identifier key, which is used for users under conversation, and this key is also stored in the user details node. In the following example, <kbd class="calibre11">"-L-0uxNuc6gC95iQytu9"</kbd> is the identifier key.</li>
<li class="calibre8"><kbd class="calibre11">$messageKey</kbd>: The second is the message key, which is generated when we push a new message in the node. In the following example, <kbd class="calibre11">"-L-125Am3LVQQQiN_xlG"</kbd> is the message key:</li>
</ul>
<pre class="calibre18">"message_details" : {<br class="title-page-name"/>  "-L-0uxNuc6gC95iQytu9" : {<br class="title-page-name"/>   "-L-125Am3LVQQQiN_xlG" : {<br class="title-page-name"/>     "message" : "Hello",<br class="title-page-name"/>     "receiverUid" :"2HIvnEJvN0O03PtByU2ACBhSMDe2",<br class="title-page-name"/>     "senderUid" : "YnmOB5rTAwVErXcmMuJkHDEb4i92",<br class="title-page-name"/>     "timestamp" : 1511862854520<br class="title-page-name"/>   }<br class="title-page-name"/>  }<br class="title-page-name"/> }</pre>
<p class="calibre2">We will define the following security rules for a message details node:</p>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Read permission</strong>: We give read permission only to the authentic users</li>
<li class="calibre8"><strong class="calibre1">Write permission</strong>: We give write permission to authentic users and also check whether any new data exists before the data push happens</li>
<li class="calibre8"><strong class="calibre1">Validation</strong>: We validate all the fields in the message so that data integrity is maintained for any new data insertion, as shown here:</li>
</ul>
<div class="cdpaligncenter"><img src="../images/00063.jpeg" class="calibre49"/></div>
<p class="mce-root">Finally, we will validate the new rules in the simulator to check whether they work:</p>
<div class="cdpaligncenter"><img src="../images/00064.jpeg" class="calibre49"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Indexing users and friends</h1>
                
            
            <article>
                
<p class="calibre2">Firebase provides the querying and ordering of data upon collection of the nodes using any common child key. This query becomes slow when the data grows. To increase the performance, the Firebase recommends that you index within a particular child field. Firebase indexes the key to the server to increase the performance of the query.</p>
<p class="calibre2">As part of this section, we will implement an index on our user data to search or find friends, which is quite common in any social application. To achieve this, we will perform the following tasks:</p>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Creating an index within the name field of the user data</strong>: We provide an index within the name field of our user data. We will use the <kbd class="calibre11">.indexOn</kbd> tag for the name field, as follows:</li>
</ul>
<div class="cdpaligncenter"><img src="../images/00065.jpeg" class="calibre49"/></div>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Creating a service for querying the data based on the text</strong>: In this task, we will query the user data based on the search text. We will provide <kbd class="calibre11">orderByChild</kbd> as the name field of the user.</li>
</ul>
<p class="mce-root"><span>Here's the <kbd class="calibre11">friends-search.service.ts</kbd></span><span>:</span></p>
<pre class="calibre18"><span>import </span>{Injectable} <span>from </span><span>'@angular/core'</span>;<br class="title-page-name"/><span>import </span>{AngularFireDatabase} <span>from </span><span>'angularfire2/database'</span>;<br class="title-page-name"/><span>import </span>{Observable} <span>from </span><span>'rxjs/Observable'</span>;<br class="title-page-name"/><span>import </span>{User} <span>from </span><span>'./user'</span>;<br class="title-page-name"/><span>import </span>{<span>FRIENDS_CHILD</span>, <span>USER_DETAILS_CHILD</span>} <span>from </span><span>'./database-constants'</span>;<br class="title-page-name"/><br class="title-page-name"/><span>/**<br class="title-page-name"/></span><span> * Friends search service<br class="title-page-name"/></span><span> *<br class="title-page-name"/></span><span> */<br class="title-page-name"/></span>@<span>Injectable</span>()<br class="title-page-name"/><span>export class </span>FriendsSearchService {<br class="title-page-name"/><br class="title-page-name"/>  <span>constructor</span>(<span>private </span>db: AngularFireDatabase) {<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  <span>getSearchFriends</span>(start, end): Observable&lt;User[]&gt; {<br class="title-page-name"/>    <span>return this</span>.db.<span>list</span>&lt;User&gt;(<span>'/users'</span>,<br class="title-page-name"/>      ref =&gt; ref.<span>orderByChild</span>(<span>'name'</span>).<span>limitToFirst</span>(<span>10</span>).<br class="title-page-name"/><span>      startAt</span>(start).<span>endAt</span>(end)<br class="title-page-name"/>    ).<span>valueChanges</span>();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>}</pre>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Modifying the template</strong>: We modify the app template to show the search result in the drop-down menu below the search text.</li>
</ul>
<p class="mce-root"><span>Here's the modified <kbd class="calibre11">app.component.html</kbd></span> file:</p>
<pre class="calibre18"><span>&lt;</span><span>h1 </span><span>class=</span><span>"title"</span><span>&gt;</span>Friends - A Social App<span>&lt;/</span><span>h1</span><span>&gt;</span><br class="title-page-name"/><span>&lt;</span><span>div </span><span>class=</span><span>"nav-container"</span><span>&gt;</span><br class="title-page-name"/><span>&lt;</span><span>nav </span><span>class=</span><span>"navbar navbar-expand-lg navbar-light bg-color"</span><span>&gt;</span><br class="title-page-name"/>  <span>&lt;</span><span>div </span><span>class=</span><span>"collapse navbar-collapse" </span><span>id=</span><span>"navbarNav"</span><span>&gt;</span><br class="title-page-name"/>    ...<br class="title-page-name"/>    <span>&lt;</span><span>div </span><span>class=</span><span>"form-container"</span><span>&gt;</span><br class="title-page-name"/>    <span>&lt;</span><span>form </span><span>class=</span><span>"form-inline my-2 my-lg-0"</span><span>&gt;</span><br class="title-page-name"/>      <span>&lt;</span><span>div </span><span>class=</span><span>"dropdown"</span><span>&gt;</span><br class="title-page-name"/>        <span>&lt;</span><span>input </span><span>class=</span><span>"form-control mr-sm-2" </span><span>type=</span><span>"text" <br class="title-page-name"/></span><span>         (keyup)=</span><span>"</span><span>onSearch</span><span>(</span><span>$event</span><span>)" </span><span>name=</span><span>"searchText"<br class="title-page-name"/>         </span><span>data-toggle=</span><span>"dropdown" </span><span>placeholder=</span><span>"Search friends..." <br class="title-page-name"/></span><span>         aria-label=</span><span>"Search"</span><span>&gt;</span><br class="title-page-name"/>        <span>&lt;</span><span>div </span><span>class=</span><span>"dropdown-menu" </span><span>aria-<br class="title-page-name"/>         labelledby=</span><span>"dropdownMenuButton"</span><span>&gt;</span><br class="title-page-name"/>          <span>&lt;</span><span>div </span><span>class=</span><span>"list-group" </span><span>*ngFor=</span><span>"let </span><span>user</span><span> of </span><span>users</span><span>"</span><span>&gt;</span><br class="title-page-name"/>            <span>&lt;</span><span>div </span><span>class=</span><span>"list-group-item list-group-item-action <br class="title-page-name"/>             flex-column align-items-start"</span><span>&gt;</span><br class="title-page-name"/>              <span>&lt;</span><span>div </span><span>class=</span><span>"d-flex w-100 justify-content-between"</span><span>&gt;</span><br class="title-page-name"/>                <span>&lt;</span><span>label</span><span>&gt;</span>{{<span>user</span>?.<span>name</span>}}<span>&lt;/</span><span>label</span><span>&gt;</span><br class="title-page-name"/>                <span>&lt;</span><span>button </span><span>type=</span><span>"button" </span><span>class=</span><span>"btn btn-light" <br class="title-page-name"/></span><span>                 (click)=</span><span>"</span><span>onAddFriend</span><span>(</span><span>user</span><span>)"</span><span>&gt;</span>ADD<span>&lt;/</span><span>button</span><span>&gt;</span><br class="title-page-name"/>              <span>&lt;/</span><span>div</span><span>&gt;</span><br class="title-page-name"/>            <span>&lt;/</span><span>div</span><span>&gt;</span><br class="title-page-name"/>          <span>&lt;/</span><span>div</span><span>&gt;</span><br class="title-page-name"/>        <span>&lt;/</span><span>div</span><span>&gt;</span><br class="title-page-name"/>      <span>&lt;/</span><span>div</span><span>&gt;</span><br class="title-page-name"/>      <span>&lt;</span><span>button </span><span>class=</span><span>"btn btn-success my-2 my-sm-0" <br class="title-page-name"/></span><span>       type=</span><span>"submit"</span><span>&gt;</span>Search<span>&lt;/</span><span>button</span><span>&gt;</span><br class="title-page-name"/>    <span>&lt;/</span><span>form</span><span>&gt;</span><br class="title-page-name"/>    <span>&lt;/</span><span>div</span><span>&gt;</span><br class="title-page-name"/>  <span>&lt;/</span><span>div</span><span>&gt;</span><br class="title-page-name"/><span>&lt;/</span><span>nav</span><span>&gt;</span><br class="title-page-name"/><span>&lt;/</span><span>div</span><span>&gt;</span><br class="title-page-name"/><span>&lt;</span><span>router-outlet</span><span>&gt;&lt;/</span><span>router-outlet</span><span>&gt;</span></pre>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Modifying the component</strong>: When an app component is loaded the we query for all the user in <kbd class="calibre11">ngOnInit()</kbd> method and when user click in search text box then user list appears with all the names. We also filter the list with the user type on the text box and then the <kbd class="calibre11">onSearch()</kbd> method is called and we query the Firebase database with the query range. </li>
</ul>
<p class="mce-root"><span>Here's the complete <kbd class="calibre11">app.component.ts</kbd> file </span><span>as of now:</span></p>
<pre class="calibre18"><span>import </span>{Component, OnInit} <span>from </span><span>'@angular/core'</span>;<br class="title-page-name"/><span>import </span>{AuthenticationService} <span>from </span><span>'./services/authentication.service'</span>;<br class="title-page-name"/><span>import </span>{User} <span>from </span><span>'./services/user'</span>;<br class="title-page-name"/><span>import </span>{FriendsSearchService} <span>from </span><span>'./services/friends-search.service'</span>;<br class="title-page-name"/><br class="title-page-name"/>@<span>Component</span>({<br class="title-page-name"/>  <span>selector</span>: <span>'app-friends'</span>,<br class="title-page-name"/>  <span>styleUrls</span>: [<span>'app.component.scss'</span>],<br class="title-page-name"/>  <span>templateUrl</span>: <span>'./app.component.html'</span>,<br class="title-page-name"/>})<br class="title-page-name"/><span>export class </span>AppComponent <span>implements </span>OnInit {<br class="title-page-name"/><br class="title-page-name"/>  <span>startAt</span>: <span>string</span>;<br class="title-page-name"/><br class="title-page-name"/>  <span>endAt</span>: <span>string</span>;<br class="title-page-name"/><br class="title-page-name"/>  <span>users</span>: User[];<br class="title-page-name"/><br class="title-page-name"/>  <span>searchText</span>: <span>string</span>;<br class="title-page-name"/><br class="title-page-name"/>  <span>authenticationService</span>: AuthenticationService;<br class="title-page-name"/><br class="title-page-name"/>  <span>constructor</span>(<span>private </span>authService: AuthenticationService,<br class="title-page-name"/>              <span>private </span>friendsSearchService: FriendsSearchService) {<br class="title-page-name"/>    <span>this</span>.<span>authenticationService </span>= authService;<br class="title-page-name"/><br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  <span>ngOnInit</span>() {<br class="title-page-name"/>    <span>console</span>.<span>log</span>(<span>this</span>.<span>currentLoginUser</span>);<br class="title-page-name"/>    <span>this</span>.<span>searchText </span>= <span>''</span>;<br class="title-page-name"/>    <span>this</span>.<span>onSearchFriends</span>(<span>this</span>.<span>searchText</span>);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  <span>onSearch</span>(event) {<br class="title-page-name"/>    <span>const </span><span>text </span>= event.<span>target</span>.<span>value</span>;<br class="title-page-name"/>    <span>this</span>.<span>onSearchFriends</span>(<span>text</span>);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  <span>onSearchFriends</span>(searchText) {<br class="title-page-name"/>    <span>const </span><span>text </span>= searchText;<br class="title-page-name"/>    <span>this</span>.<span>startAt </span>= <span>text</span>;<br class="title-page-name"/>    <span>this</span>.<span>endAt </span>= <span>text </span>+ <span>'</span><span>\uf8ff</span><span>'</span>;<br class="title-page-name"/>    <span>this</span>.friendsSearchService.<span>getSearchFriends</span>(<span>this</span>.<span>startAt</span>, <br class="title-page-name"/><span>    this</span>.<span>endAt</span>)<br class="title-page-name"/>      .<span>subscribe</span>(users =&gt; <span>this</span>.<span>users </span>= users);<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<div class="packt_infobox"><span class="calibre20"><br class="calibre44"/>
The <kbd class="calibre21">\uf8ff</kbd> characters is a very high code point in the unicode range, which allows you to match all values that start with your search text.</span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Setting up multiple environments</h1>
                
            
            <article>
                
<p class="calibre2">When our application is ready to deploy, we will need to separate the Firebase projects for the development and production environments so that we can test our code changes in a development environment before deploying them into production. We will follow these steps to set up a separate environment:</p>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Creating a new staging project in Firebase</strong>: Because we cannot use the same Firebase features, such as database and storage, we will need to separate the production and staging environments. We will then create a new project with the <kbd class="calibre11">friends-staging</kbd> <span>name; </span>this project has the new Firebase environment variables:</li>
</ul>
<div class="cdpaligncenter"><img src="../images/00066.jpeg" class="calibre73"/></div>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Creating a new environment variable</strong>: The new Firebase project has a new environment variable, and you can get configuration from the Firebase project. So, navigate to <span>Project </span><span>Overview</span> | <span>Project settings</span> | <span><span>Add Firebase</span> to your web app</span>. </li>
</ul>
<p class="mce-root"><span>Copy the content into the new environment file, as shown in the following code;</span> we have two environment files for staging and production:</p>
<ul class="calibre7">
<li class="mce-root2">The <kbd class="calibre11">environment.prod.ts</kbd> file with production is set as <kbd class="calibre11">true</kbd>, and this is used for the production environment:</li>
</ul>
<pre class="calibre18"><span>export const </span><span>environment </span>= {<br class="title-page-name"/>   <span>production</span>: <span>true</span>,<br class="title-page-name"/>   <span>firebase</span>: {<br class="title-page-name"/>      <span>apiKey</span>: <span>'XXXX'</span>,<br class="title-page-name"/>      <span>authDomain</span>: <span>'friends-4d4fa.firebaseapp.com'</span>,<br class="title-page-name"/>      <span>databaseURL</span>: <span>'https://friends-4d4fa.firebaseio.com'</span>,<br class="title-page-name"/>      <span>projectId</span>: <span>'friends-4d4fa'</span>,<br class="title-page-name"/>      <span>storageBucket</span>: <span>'friends-4d4fa.appspot.com'</span>,<br class="title-page-name"/>      <span>messagingSenderId</span>: <span>'321535044959'<br class="title-page-name"/></span><span>   </span>}<br class="title-page-name"/>};</pre>
<ul class="calibre7">
<li class="mce-root2">The <kbd class="calibre11">environment.ts</kbd> file with production is set as <kbd class="calibre11">false</kbd>; this will be used for the staging environment:</li>
</ul>
<pre class="calibre18"><span>export const </span><span>environment </span>= {<br class="title-page-name"/>   <span>production</span>: <span>false</span>,<br class="title-page-name"/>   <span>firebase</span>: {<br class="title-page-name"/>      <span>apiKey</span>: <span>'XXXX'</span>,<br class="title-page-name"/>      <span>authDomain</span>: <span>'friends-4d4fa.firebaseapp.com'</span>,<br class="title-page-name"/>      <span>databaseURL</span>: <span>'https://friends-4d4fa.firebaseio.com'</span>,<br class="title-page-name"/>      <span>projectId</span>: <span>'friends-4d4fa'</span>,<br class="title-page-name"/>      <span>storageBucket</span>: <span>'friends-4d4fa.appspot.com'</span>,<br class="title-page-name"/>      <span>messagingSenderId</span>: <span>'321535044959'<br class="title-page-name"/></span><span>   </span>}<br class="title-page-name"/>};</pre>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Installing Firebase tools</strong>: Once you create a new Firebase project, you will need to install the Firebase tools and log into the Firebase portal with the following command:</li>
</ul>
<pre class="calibre18"><strong class="calibre1"><span>$ npm install </span><span>-</span><span>g firebase</span><span>-</span><span>tools<br class="title-page-name"/>$ firebase login</span></strong></pre>
<p class="calibre2"><span>The preceding command will open your Gmail permission page; c</span>licking on <span>ALLOW</span> will give permission to list all the available projects:</p>
<div class="cdpaligncenter"><img src="../images/00067.jpeg" class="calibre74"/></div>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Using the new Firebase project</strong><span>: Once we give permission, we will need to add the available project based on the current environment in use. Suppose that we need to test a new feature under development, we can select a staging environment and give the alias name for the staging environment for future use. We can switch the environment using the alias name, as follows: </span></li>
</ul>
<pre class="calibre18"><strong class="calibre1">$ firebase use --add</strong><br class="title-page-name"/><strong class="calibre1">$ firebase use staging</strong></pre>
<p class="mce-root">This creates the <kbd class="calibre11">.firebaserc</kbd> file in the base project directory, which looks like this:</p>
<pre class="calibre18">{<br class="title-page-name"/>  "projects": {<br class="title-page-name"/>    "default": "friends-4d4fa",<br class="title-page-name"/>    "staging": "friends-staging"<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Hosting the friends app in Firebase</h1>
                
            
            <article>
                
<p class="calibre2">Firebase supports hosting as a service, and application deployment is easy in Firebase. Most applications adopt a two-stage deployment, that is, first staging and then production. Once we test the application in the staging environment, we can deploy it into the production environment. The steps to deploy an application are as follows:</p>
<ol class="calibre13">
<li value="1" class="calibre8">The first is to build the application, which creates a <kbd class="calibre11">dist</kbd> folder that has <kbd class="calibre11">index.html</kbd> and other required files. You can build for production just by adding a <kbd class="calibre11">--prod</kbd> option:</li>
</ol>
<pre class="calibre18"><strong class="calibre1">$ ng build</strong></pre>
<ol start="2" class="calibre13">
<li value="2" class="calibre8">The next step is to initialize the application project. We will execute the init command and select the Firebase features using the space key in the command prompt; for our friends application, we will use the database, storage, and hosting features of Firebase, and when we select the respective features, it creates a default database and storage rules:</li>
</ol>
<pre class="calibre18"><strong class="calibre1">$ firebase init</strong></pre>
<p class="mce-root"><span>It also creates the </span><kbd class="calibre11">firebase.json</kbd> <span>file, which looks as follows:</span></p>
<pre class="calibre18">{<br class="title-page-name"/>  "hosting": {<br class="title-page-name"/>    "public": "src",<br class="title-page-name"/>    "ignore": [<br class="title-page-name"/>      "firebase.json",<br class="title-page-name"/>      "**/.*",<br class="title-page-name"/>      "**/node_modules/**"<br class="title-page-name"/>    ]<br class="title-page-name"/>  },<br class="title-page-name"/>  "database": {<br class="title-page-name"/>    "rules": "database.rules.json"<br class="title-page-name"/>  },<br class="title-page-name"/>  "storage": {<br class="title-page-name"/>    "rules": "storage.rules"<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<ol start="3" class="calibre13">
<li class="calibre8" value="3">Finally, we deploy our application using the following command; once our application is deployed, we can take a look at the deployed application in the Firebase hosting our project:</li>
</ol>
<pre class="calibre18"><strong class="calibre1">$ firebase deploy</strong></pre>
<p class="mce-root4">The deployed application appears in the Firebase portal. You can see the deployed application in the Firebase portal by navigating to  <span>DEVELOP</span> | <span>Hosting</span>, and on the right panel <span>Domain</span> and <span>Deployment history</span> appear as follows:</p>
<div class="cdpaligncenter"><img src="../images/00068.jpeg" class="calibre75"/></div>
<ol start="4" class="calibre13">
<li class="calibre8" value="4">Finally, you can open your live application using the following command or by pasting the URL as <a href="https://friends-staging.firebaseapp.com" class="calibre10">https://friends-staging.firebaseapp.com</a>:</li>
</ol>
<pre class="calibre18"><strong class="calibre1">$ firebase open</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we covered the Firebase security mechanism. We added security rules for our friends application database to make our application more secure. We indexed the <kbd class="calibre11">name</kbd> field of our user node for our database so that the search query became faster. We then used a search API in our friends application. Finally, we created multiple environments for our application so that we were able to separate staging from production. We then deployed our application on to Firebase.</p>
<p class="calibre2">In the next chapter, we will learn about Firebase cloud messaging, Google analytics, and ads.</p>
<p class="calibre2"/>
<p class="calibre2"/>


            </article>

            
        </section>
    </body></html>