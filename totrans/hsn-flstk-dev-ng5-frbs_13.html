<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Growing Our Application Using Firebase</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we will take a look at how Firebase provides cloud messaging to engage our users. We will add a Firebase cloud messaging feature to our application. We will cover Google analytics, which provides a good dashboard to analyze our application and take action accordingly, as this helps to improve our application further. Finally, we will discuss Google ads, which helps to monetize our application. </p>
<p class="calibre2"><span>In this chapter, we will cover the following topics:</span></p>
<ul class="calibre7">
<li class="calibre8">Introduction to Firebase cloud messaging</li>
<li class="calibre8">Adding FCM to our application</li>
<li class="calibre8">Google data analytics</li>
<li class="calibre8">Learning about Google Ads</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Introduction to Firebase cloud messaging</h1>
                
            
            <article>
                
<p class="calibre2"><strong class="calibre1">Firebase cloud messaging</strong> (<strong class="calibre1">FCM</strong>) is a cross-platform service used to deliver messages reliably across different platforms. It uses the push methodology to send messages, and we can send up to 4 KB of data to the client. It supports many use cases, such as to engage users with promotional messages and send a message when the user is in the background.</p>
<p class="calibre2">It has the following two main modules:</p>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Trusted server</strong>: This server is used to send messages to clients and can be a Firebase console or a server SDK implementation.</li>
<li class="calibre8"><strong class="calibre1">Client application</strong>: This includes client applications in the web, Android, or iOS. This receives messages from the trusted server.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Adding FCM to our application</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we will configure FCM in our application. We will perform the following <span>steps </span>to configure FCM:</p>
<ol class="calibre13">
<li class="calibre8" value="1"><strong class="calibre1">Creating a</strong> <strong class="calibre1">manifest.json</strong> <strong class="calibre1">file</strong>: Our first step will be to create a <kbd class="calibre11">manifest.json</kbd> file within the <kbd class="calibre11">src</kbd> folder. This file contains <kbd class="calibre11">gcm_sender_id</kbd>, which authorizes a client to a trusted FCM server and enables FCM to send messages to our application. For a desktop browser, the client ID—<kbd class="calibre11">103953800507</kbd><span>—</span>remains fixed for a web application, so you don't need to change it.</li>
</ol>
<div class="packt_infobox">The web manifest file is a simple JSON file, in which we can specify the configuration for our application, such as its name, display, and orientation.  </div>
<p class="mce-root"><span>Here's the code for <kbd class="calibre11">manifest.json</kbd></span><span>:</span></p>
<pre class="calibre18">{<br class="title-page-name"/>   <span>"name"</span>: <span>"Friends"</span>,<br class="title-page-name"/>   <span>"short_name"</span>: <span>"Friends"</span>,<br class="title-page-name"/>   <span>"start_url"</span>: <span>"/index.html"</span>,<br class="title-page-name"/>   <span>"display"</span>: <span>"standalone"</span>,<br class="title-page-name"/>   <span>"orientation"</span>: <span>"portrait"</span>,<br class="title-page-name"/>   <span>"gcm_sender_id"</span>: <span>"103953800507"<br class="title-page-name"/></span>}</pre>
<ol start="2" class="calibre13">
<li value="2" class="calibre8"><strong class="calibre1">Configuring</strong> <strong class="calibre1">manifest.json</strong> <strong class="calibre1">in</strong> <strong class="calibre1">index.html</strong>: Once we create the manifest file, we include the file reference in <kbd class="calibre11">index.html</kbd>.</li>
</ol>
<p class="mce-root">Then we include the modified <kbd class="calibre11">index.html</kbd>:</p>
<pre class="calibre18"><span>&lt;!DOCTYPE </span><span>html</span><span>&gt;</span><br class="title-page-name"/><span>&lt;</span><span>html</span><span>&gt;</span><br class="title-page-name"/>   <span>&lt;</span><span>link </span><span>rel=</span><span>"manifest" </span><span>href=</span><span>"/manifest.json"</span><span>&gt;</span><br class="title-page-name"/><span>&lt;/</span><span>head</span><span>&gt;</span><br class="title-page-name"/><span>&lt;</span><span>body</span><span>&gt;</span><br class="title-page-name"/><span>&lt;</span><span>app-friends</span><span>&gt;</span><br class="title-page-name"/>   Loading...<br class="title-page-name"/><span>&lt;/</span><span>app-friends</span><span>&gt;</span><br class="title-page-name"/><span>&lt;/</span><span>body</span><span>&gt;</span><br class="title-page-name"/><span>&lt;/</span><span>html</span><span>&gt;</span></pre>
<ol start="3" class="calibre13">
<li value="3" class="calibre8"><strong class="calibre1">Creating a service worker</strong>: After we create a manifest file, we create a Firebase service worker to process incoming push messages from the trusted server and to register our Firebase app with a messaging sender <kbd class="calibre11">ID</kbd>, which we can get from the Firebase portal by navigating to <span>Project Overview</span> &gt; <span>Project settings</span> &gt; <span>CLOUD MESSAGING</span>. </li>
</ol>
<div class="packt_infobox">A service worker is a type of web worker that runs in the background and helps in push in notifications.</div>
<p class="mce-root"><span>Here's the <kbd class="calibre11">firebase-messaging-sw.js</kbd> file </span><span>as of now:</span></p>
<pre class="calibre18"><span>importScripts</span>(<span>'https://www.gstatic.com/firebasejs/3.9.0/firebase-app.js'</span>);<br class="title-page-name"/><span>importScripts</span>(<span>'https://www.gstatic.com/firebasejs/3.9.0/firebase-messaging.js'</span>);<br class="title-page-name"/><br class="title-page-name"/><span>firebase</span>.<span>initializeApp</span>({<br class="title-page-name"/>   <span>'messagingSenderId'</span>: <span>'807434545532'<br class="title-page-name"/></span>});<br class="title-page-name"/><br class="title-page-name"/><span>const </span><span>messaging </span>= <span>firebase</span>.<span>messaging</span>();</pre>
<ol start="4" class="calibre13">
<li value="4" class="calibre8"><strong class="calibre1">Referring to the manifest and service worker in</strong> <strong class="calibre1">angular-cli.json</strong>: Next, we mention the service worker and manifest file's reference in <kbd class="calibre11">angular-cli.json</kbd>; the following is the modified <kbd class="calibre11">angular-cli.json</kbd><span>:</span></li>
</ol>
<pre class="calibre18"><span>...<br class="title-page-name"/>"apps"</span>: [<br class="title-page-name"/>   {<br class="title-page-name"/>      <span>"assets"</span>: [<br class="title-page-name"/>         <span>"assets"</span>,<br class="title-page-name"/>         <span>"favicon.ico"</span>,<br class="title-page-name"/>         <span>"firebase-messaging-sw.js"</span>,<br class="title-page-name"/>         <span>"manifest.json"<br class="title-page-name"/></span><span>      </span>],<br class="title-page-name"/>      ...<br class="title-page-name"/>   }<br class="title-page-name"/>]</pre>
<ol start="5" class="calibre13">
<li value="5" class="calibre8">
<p class="calibre9"><strong class="calibre1">Creating FCM Service</strong>: This service class is used to receive the client token and insert the token to the Firebase database. It is also used to register for token refresh when a token expires. The method steps for creating this service class are as follows:</p>
</li>
</ol>
<p class="mce-root">The first method step is to get user permission for notifications by an alert dialog, and once the user clicks on the <span>Allow</span> button,  we call <kbd class="calibre11">getToken()</kbd> from the Firebase messaging object to get the token. We send this token to the Firebase database so that we can use this token in the future to send promotional messages to all of our users. We also create an <kbd class="calibre11">onTokenRefresh()</kbd> method to refresh our token once it expires.</p>
<p class="mce-root">The second method step is to register for push notification messages by calling <kbd class="calibre11">onMessage()</kbd> when the application is in the foreground. </p>
<p class="mce-root"><span>Here's the <kbd class="calibre11">fcm-messaging.service.ts</kbd> file <span>as of now:</span></span></p>
<pre class="calibre18"><span>import </span>{Injectable} <span>from </span><span>'@angular/core'</span>;<br class="title-page-name"/><span>import </span>{AngularFireDatabase} <span>from </span><span>'angularfire2/database'</span>;<br class="title-page-name"/><span>import </span>{AngularFireAuth} <span>from </span><span>'angularfire2/auth'</span>;<br class="title-page-name"/><span>import </span><span>'firebase/messaging'</span>;<br class="title-page-name"/><br class="title-page-name"/>@<span>Injectable</span>()<br class="title-page-name"/><span>export class </span>FcmMessagingService {<br class="title-page-name"/><br class="title-page-name"/>   <span>messaging </span>= <span>null</span>;<br class="title-page-name"/><br class="title-page-name"/>   <span>constructor</span>(<span>private </span>angularFireDatabase: AngularFireDatabase, <br class="title-page-name"/><span>   private </span>afAuth: AngularFireAuth) {<br class="title-page-name"/>      <span>this</span>.<span>messaging </span>= angularFireDatabase.<span>app</span>.<span>messaging</span>();<br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>   <span>getPermission</span>() {<br class="title-page-name"/>      <span>this</span>.<span>messaging</span>.requestPermission()<br class="title-page-name"/>         .<span>then</span>(() =&gt; {<br class="title-page-name"/>            <span>console</span>.<span>log</span>(<span>'Permission granted.'</span>);<br class="title-page-name"/>            <span>this</span>.<span>getToken</span>();<br class="title-page-name"/>         })<br class="title-page-name"/>         .<span>catch</span>((err) =&gt; {<br class="title-page-name"/>            <span>console</span>.<span>log</span>(<span>'Permission denied'</span>, err);<br class="title-page-name"/>         });<br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>   <span>getToken</span>() {<br class="title-page-name"/>      <span>this</span>.<span>messaging</span>.getToken()<br class="title-page-name"/>         .<span>then</span>((currentToken) =&gt; {<br class="title-page-name"/>            <span>if </span>(currentToken) {<br class="title-page-name"/>               <span>console</span>.<span>log</span>(currentToken);<br class="title-page-name"/>               <span>this</span>.<span>sendTokenToServer</span>(currentToken);<br class="title-page-name"/>            } <span>else </span>{<br class="title-page-name"/>               <span>console</span>.<span>log</span>(<span>'No token available'</span>);<br class="title-page-name"/>            }<br class="title-page-name"/>         })<br class="title-page-name"/>         .<span>catch</span>((err) =&gt; {<br class="title-page-name"/>            <span>console</span>.<span>log</span>(<span>'An error occurred while retrieving token. <br class="title-page-name"/>            '</span>, err);<br class="title-page-name"/>         });<br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>   <span>onMessage</span>() {<br class="title-page-name"/>      <span>this</span>.<span>messaging</span>.onMessage((payload) =&gt; {<br class="title-page-name"/>         <span>console</span>.<span>log</span>(<span>'Message received. '</span>, payload);<br class="title-page-name"/>      });<br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>   <span>onTokenRefresh</span>() {<br class="title-page-name"/>      <span>this</span>.<span>messaging</span>.onTokenRefresh(<span>function </span>() {<br class="title-page-name"/>         <span>this</span>.<span>messaging</span>.getToken()<br class="title-page-name"/>            .<span>then</span>(<span>function </span>(refreshedToken) {<br class="title-page-name"/>               <span>console</span>.<span>log</span>(<span>'Token refreshed.'</span>);<br class="title-page-name"/>               <span>this</span>.<span>sendTokenToServer</span>(refreshedToken);<br class="title-page-name"/>            })<br class="title-page-name"/>            .<span>catch</span>(<span>function </span>(err) {<br class="title-page-name"/>               <span>console</span>.<span>log</span>(<span>'Unable to retrieve refreshed token '</span>, <br class="title-page-name"/>               err);<br class="title-page-name"/>            });<br class="title-page-name"/>      });<br class="title-page-name"/><br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>   <span>sendTokenToServer</span>(token) {<br class="title-page-name"/>      <span>this</span>.afAuth.<span>authState</span>.<span>subscribe</span>(user =&gt; {<br class="title-page-name"/>         <span>if </span>(user) {<br class="title-page-name"/>            <span>const </span><span>data </span>= {[user.<span>uid</span>]: token};<br class="title-page-name"/>            <span>this</span>.angularFireDatabase.<span>object</span>(<span>'fcm-<br class="title-page-name"/>            tokens/'</span>).<span>update</span>(<span>data</span>);<br class="title-page-name"/>         }<br class="title-page-name"/>      });<br class="title-page-name"/>   }<br class="title-page-name"/>}</pre>
<ol start="6" class="calibre13">
<li value="6" class="calibre8"><strong class="calibre1">Registering Firebase messaging for update in app component</strong>: Once we create service methods, we call user permission, token, and register for a message update in our app component as shown in the following <kbd class="calibre11">app.component.ts</kbd><span>:</span></li>
</ol>
<pre class="calibre18"><span>import </span>{Component, OnInit} <span>from </span><span>'@angular/core'</span>;<br class="title-page-name"/><span>import </span>{AuthenticationService} <span>from </span><span>'./services/authentication.service'</span>;<br class="title-page-name"/><span>import </span>{FcmMessagingService} <span>from </span><span>'./services/fcm-messaging.service'</span>;<br class="title-page-name"/><br class="title-page-name"/>@<span>Component</span>({<br class="title-page-name"/>   <span>selector</span>: <span>'app-friends'</span>,<br class="title-page-name"/>   <span>styleUrls</span>: [<span>'app.component.scss'</span>],<br class="title-page-name"/>   <span>templateUrl</span>: <span>'./app.component.html'</span>,<br class="title-page-name"/>})<br class="title-page-name"/><span>export class </span>AppComponent <span>implements </span>OnInit {<br class="title-page-name"/><br class="title-page-name"/>   ...<br class="title-page-name"/>   authenticationService: AuthenticationService;<br class="title-page-name"/><br class="title-page-name"/>   <span>constructor</span>(<span>private </span>authService: AuthenticationService,<br class="title-page-name"/>            <span>private </span>friendsSearchService: FriendsSearchService,<br class="title-page-name"/>            <span>private </span>fcmService: FcmMessagingService) {<br class="title-page-name"/>      <span>this</span>.<span>authenticationService </span>= authService;<br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>   <span>ngOnInit</span>() {<br class="title-page-name"/>      <span>this</span>.fcmService.<span>getPermission</span>();<br class="title-page-name"/>      <span>this</span>.fcmService.<span>onMessage</span>();<br class="title-page-name"/>      <span>this</span>.fcmService.<span>onTokenRefresh</span>();<br class="title-page-name"/>   }<br class="title-page-name"/>    ...<br class="title-page-name"/>}</pre>
<p class="calibre2">Finally, our application is now ready to send push notification messages. You can send messages either by a curl command or Postman request. </p>
<p class="calibre2">To send a push notification from Postman, we require the following details:</p>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">URL</strong>: This is an FCM endpoint registered with our trusted server. Its unique URL is <a href="https://fcm.googleapis.com/fcm/send" target="_blank" class="calibre10">https://fcm.googleapis.com/fcm/send</a>.</li>
<li class="calibre8"><strong class="calibre1">Content type</strong>: This is a type of content sent to the server and in our case is JSON type as <kbd class="calibre11">application/json</kbd>.</li>
<li class="calibre8"><strong class="calibre1">Authorization</strong>: This key is the server key for our Firebase project. You can find this key in our Firebase portal by navigating to <span>Project Overview|</span><span>Project settings|</span><span>CLOUD MESSAGING|</span><span>Server Key.</span></li>
<li class="calibre8"><strong class="calibre1">Body</strong>: This contains the title, body, action, and the target sender <kbd class="calibre11">ID</kbd>. The sender token ID is saved in our Firebase database.</li>
</ul>
<p class="calibre2">This is an example of a Postman request for a <span>H<span>eaders</span></span> tab:</p>
<div class="cdpaligncenter"><img src="../images/00069.gif" class="calibre76"/></div>
<p class="calibre2">The Postman for the <span>Body</span> tab will be as follows:</p>
<div class="cdpaligncenter"><img src="../images/00070.gif" class="calibre77"/></div>
<p class="calibre2">The notification that appears on the bottom-right corner of your screen should look as follows:</p>
<div class="cdpaligncenter"><img src="../images/00071.jpeg" class="calibre78"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Google data analytics</h1>
                
            
            <article>
                
<p class="calibre2">Google analytics is a free service offered by Google that provides statistics about the visitors and traffic to our website. It provides a more valuable input about the visitors and geographies. It also provides input about the behavior of the visitor when they use our website. The following are the steps for registering Google analytics to your application.</p>
<p class="calibre2"><strong class="calibre1">Creating a Google analytics account</strong>: We can create a Google analytics account with an existing Gmail account or a new Gmail account by performing the following steps:</p>
<ol class="calibre13">
<li value="1" class="calibre8">Open the browser and paste in the analytics URL (<a href="https://analytics.google.com/analytics" class="calibre10">https://analytics.google.com/analytics</a>)</li>
<li value="2" class="calibre8">Click on the <span>SIGNUP</span> button</li>
<li value="3" class="calibre8">Fill out your live application URL and form information</li>
<li value="4" class="calibre8">Click on the <span>Get Tracking ID</span> button</li>
</ol>
<p class="calibre2"><strong class="calibre1">Integrating tracking code into our application</strong>: After a successful signup, we can integrate the generated global site tag into our application. Take a look at the following sample global site code in <kbd class="calibre11">index.html</kbd>:</p>
<pre class="calibre17">&lt;head&gt;<br class="title-page-name"/>...<br class="title-page-name"/>&lt;script async src="https://www.googletagmanager.com/gtag/js?id=UA-108905892-1"&gt;&lt;/script&gt;<br class="title-page-name"/>&lt;script&gt;<br class="title-page-name"/>  window.dataLayer = window.dataLayer || [];<br class="title-page-name"/>  function gtag(){dataLayer.push(arguments);}<br class="title-page-name"/>  gtag('js', new Date());<br class="title-page-name"/><br class="title-page-name"/>  gtag('config', 'UA-108905892-1');<br class="title-page-name"/>&lt;/script&gt;<br class="title-page-name"/>...<br class="title-page-name"/>&lt;/head&gt;</pre>
<p class="calibre2">After a successful signup, our Google analytics dashboard should look like this:</p>
<div class="cdpaligncenter"><img src="../images/00072.jpeg" class="calibre79"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Learning about Google adsense</h1>
                
            
            <article>
                
<p class="calibre2">Google adsense provides a platform to monetize our web application. Firebase ads are not supported for this web application, so we will work with Google ads to monetize our application. In this section, we will take a look at how to add ads to our application. </p>
<p class="calibre2"><strong class="calibre1">Creating an adsense account</strong>: We can create an adsense account with the existing Gmail account or create a new Gmail account by performing the following steps:</p>
<ol class="calibre13">
<li value="1" class="calibre8">Open the browser and paste in the adsense URL (<a href="http://adsense" class="calibre10">https://www.google.com/adsense</a><span> </span>)</li>
<li value="2" class="calibre8">Click on the <span>SIGNUP</span> button</li>
<li value="3" class="calibre8">Fill out your live application URL and address details</li>
<li value="4" class="calibre8">Click on the <span>SUBMIT</span> button</li>
</ol>
<p class="calibre2"><strong class="calibre1">Adding the adsense script to our application</strong>: When you click on the <span>Submit</span> button, Google ads will provide steps to register your site with ads. It gives code to paste into the <kbd class="calibre11">index.html</kbd> of our application. T<span>ake a look at the following</span> sample script to paste into the<span> <kbd class="calibre11">index.html</kbd></span><span>:</span></p>
<pre class="calibre17">&lt;head&gt;<br class="title-page-name"/>...<br class="title-page-name"/>&lt;script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"&gt;&lt;/script&gt;<br class="title-page-name"/>&lt;script&gt;<br class="title-page-name"/>  (adsbygoogle = window.adsbygoogle || []).push({<br class="title-page-name"/>    google_ad_client: "ca-pub-6342144115183345",<br class="title-page-name"/>    enable_page_level_ads: true<br class="title-page-name"/>  });<br class="title-page-name"/>&lt;/script&gt;<br class="title-page-name"/>...<br class="title-page-name"/>&lt;/head&gt;</pre>
<p class="calibre2">After a successful signup, our Google adsense dashboard look as follows:</p>
<div class="cdpaligncenter"><img src="../images/00073.jpeg" class="calibre49"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we covered Firebase cloud messaging. We integrated FCM into our application, which helps to engage our users. We also covered Google analytics and saw how to enable analytics in our application. This gives a good perspective about the application's usage. Finally, we discussed Google adsense, which helps to monetize our application. </p>
<p class="calibre2">In the next chapter, we will discuss the <strong class="calibre1">Progressive Web App</strong> (<strong class="calibre1">PWA</strong>) and add a few features to make our application PWA-compliant. </p>


            </article>

            
        </section>
    </body></html>