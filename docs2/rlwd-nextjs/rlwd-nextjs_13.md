# 第十一章：*第十一章*：不同的部署平台

在前面的章节中，我们看到了 Next.js 是如何工作的，如何为 SEO 优化它，如何处理性能，如何采用 UI 框架，以及如何在客户端和服务器端获取数据，最终能够创建一个出色的 Web 应用程序。但是，我们遇到了一个问题：我们应该如何将其部署到生产环境中？有许多不同的托管提供商、云平台，甚至**平台即服务**（**PaaS**）解决方案；我们应该如何选择？

在本章中，我们将了解如何选择正确的部署平台。

我们将详细探讨以下内容：

+   选择正确的部署平台如何影响性能

+   如何在不同的云解决方案之间做出选择

+   最受欢迎的 Next.js 应用程序托管替代方案有哪些？

到本章结束时，您将能够将任何 Next.js 应用程序部署到任何主机，并了解如何从最受欢迎的托管解决方案中选择正确的提供商。

# 技术要求

要运行本章中的代码示例，您需要在您的本地机器上安装 Node.js 和 npm。

如果您愿意，可以使用在线 IDE，例如[`repl.it`](https://repl.it)或[`codesandbox.io`](https://codesandbox.io)；它们都支持 Next.js，您不需要在您的电脑上安装任何依赖。与其他章节一样，您可以在 GitHub 上找到本章的代码库：https://github.com/PacktPublishing/Real-World-Next.js。

# 不同部署平台的简要介绍

当我们在考虑一个新的 Web 应用程序时，有许多事情需要考虑。例如，我们希望如何渲染其页面，我们希望采用哪种样式方法，数据从哪里来，我们如何管理应用程序状态，以及我们希望将应用程序部署在哪里？

专注于最后一部分，我们可以将一个问题分为两个：我们希望在哪里部署我们的应用程序，以及我们希望如何进行部署？

事实上，大多数时候，选择一个部署平台也意味着选择一种略微不同的部署方法。有一些特定的云平台，如 Vercel、Netlify 和 Heroku，它们的部署过程是标准化的，并且极大地简化，以便让每个人都能使用。对于其他云提供商，如 AWS、Azure 和 DigitalOcean，您对整个部署过程有完全的控制权。不幸的是，在许多情况下，您必须自己实现这个过程或使用第三方软件。

在过去几年中，云基础设施的数量急剧增加，竞争也带来了这个领域的一些重大创新。尽管有许多替代方案，但我们将专注于最受欢迎的方案，因为我们更有可能找到更多关于它们的文档和支持。

在下一节中，我们将讨论将 Next.js 应用程序部署到最突出的平台：*Vercel*。

# 部署到 Vercel 平台

*开发、预览、发布*不仅仅是一个口号。它完美地描述了开发 Next.js（以及许多其他开源库）的公司，以及一个优秀的云基础设施，用于部署和托管 Web 应用程序。

使用 Vercel，你几乎不需要进行任何配置。你可以通过他们的 CLI 工具从命令行部署你的 Web 应用程序，或者在你将代码推送到主 Git 分支后创建自动部署。

在开始使用 Vercel 之前，有一件事需要知道的是，该平台是专门为静态网站和前端框架构建的。不幸的是，这意味着*不支持自定义 Node.js 服务器*。

但在这个时候，你可能想知道是否只支持静态生成或客户端渲染的 Next.js 网站。简短的回答是*不*。实际上，Vercel 通过提供*无服务器函数*来支持服务器端渲染的页面。

“无服务器函数”是什么意思？

当谈到“无服务器函数”时，我们指的是一个单独的函数（用任何编程语言编写），它在托管的基础设施上被调用。实际上，它被称为“无服务器”，因为我们只需要编写函数，而不必真正考虑执行它的服务器。与传统的服务器不同，我们通常按小时付费（例如，即使服务器没有处理任何数据，我们可能每小时支付 1 美元），无服务器函数有一个不同的定价模型：我们根据执行时间、内存使用和其他类似指标，为每次执行支付几分之一的美分。例如，在撰写本文时，AWS Lambda（最受欢迎的无服务器环境）每百万请求收费*0.20 美元*，每毫秒收费*0.0000000021 美元*（当分配 128MB 内存时）。正如你可以想象的那样，这种定价模型与更传统的替代方案相比非常有吸引力，因为你只需为实际使用的部分付费。

Vercel 在部署 Next.js 应用程序时为我们设置无服务器函数做得非常出色，所以我们不必担心它们；我们只需专注于我们正在构建的 Web 应用程序。

将应用程序部署到 Vercel 相当直接。我们可以以两种不同的方式操作：

+   *通过将我们的 GitHub、GitLab 或 Bitbucket 仓库链接到 Vercel*。每次我们创建一个拉取请求时，Vercel 都会部署一个预览应用程序来测试我们刚刚开发的功能，在它们发布到生产之前。一旦我们合并或推送到我们的主分支，Vercel 将自动将应用程序部署到生产环境。

+   *我们可以从命令行手动完成所有操作*。例如，我们可以决定创建一个预览应用程序，在本地预览它，或者直接从我们的终端使用 Vercel CLI 工具将其发布到生产，只需输入`vercel --prod`就足以将应用程序提升到生产状态。

无论哪种方式，开发者的体验都是出色的，所以请随意测试这两种部署策略，找到您最喜欢的一种。

在所有可能的 Next.js 应用程序部署和托管替代方案中，Vercel 可能是其中最容易的一个。此外，它还允许您访问分析模块（您还记得我们在*第十章*，*与 SEO 合作和管理性能？*）中提到的内容，这对于测量前端性能随时间的变化非常有用。这将帮助我们关注前端优化，而其他平台并不提供（这也是一项基本功能！）。

如果您正在寻找与 Vercel 相当的东西，您可以考虑的一个很好的替代方案是 Netlify。整个部署工作流程与 Vercel 的非常相似，开发者的体验同样出色。然而，我鼓励您在决定选择哪个平台之前，考虑一下定价模型的不同。

Vercel 和 Netlify 在部署静态网站时也表现出色。但在那里，与其他平台的竞争将会加剧；我们将在下一节中看到一些替代方案。

# 将静态网站部署到 CDN

当我们谈论**CDN**（即**内容分发网络**）时，我们指的是一个地理分布式的数据中心网络，用于在向世界任何地区的用户提供内容时实现高可用性和高性能。

为了简化，让我们举一个例子。我目前住在意大利米兰附近，我希望我的 Web 应用程序能够在世界任何地方使用。那么，从地理角度来看，我应该在哪里托管它呢？

某些提供商，如 Amazon AWS、DigitalOcean 和 Microsoft Azure（以及许多其他提供商），允许您选择一个特定的数据中心来托管您的应用程序。例如，我可以选择 AWS *eu-south-1*（意大利米兰），*ap-northeast-2*（韩国首尔），或*sa-east-1*（巴西圣保罗）。如果我选择从米兰托管我的 Web 应用程序，意大利用户在尝试访问 Web 应用程序时将注意到非常低的延迟；它在地理位置上非常接近他们。对于法国、瑞士和德国用户来说，情况可能相同，但对于生活在亚洲、非洲或美洲的人来说，情况则相反。您离数据中心越远，延迟就越大，导致性能不佳、客户端到服务器请求延迟较差，等等。如果我们考虑静态资源，如图像、CSS 或 JavaScript 文件，这一点将更加明显。

大文件大小 + 数据中心距离 = 下载性能差。这很简单，不是吗？

CDN 通过在（几乎）每个大陆上提供整个基础设施来解决这个特定问题。一旦您将静态资产部署到 CDN，它将在网络的所有区域中复制，使得它在世界任何地方的用户的附近都可用。

如果你查看 Next.js 的静态生成网站，你会很快注意到在请求时间不需要服务器来渲染页面。相反，网站在构建时完全生成并静态渲染，所以我们最终会得到一组可以部署到 CDN 的静态 HTML、CSS 和 JavaScript 文件。

如果我们处于那种情况，那么我们就很幸运了。我们即将通过从 CDN 提供静态 HTML 页面来实现最佳性能。但我应该选择哪个 CDN 呢？我们将在下一节中找到答案。

# 选择 CDN

当我们在寻找 CDN 来部署我们的 Web 应用时，我们会发现许多不同的选择。该领域的知名玩家包括（但不限于）*Amazon AWS*、*Microsoft Azure CDN*和*Cloudflare*。当然，还有很多其他的选择，但这些是我尝试过并且有良好体验的，所以我自信地向你推荐它们。

CDN 部署增加了几个配置步骤，但花点额外的时间以实现最佳性能可能值得。

以 AWS 为例，流程不会像 Vercel 那样直接。我们需要构建一个管道（使用 GitHub Actions 或 GitLab Pipelines 等），以静态生成 Web 应用，然后将其推送到**AWS S3**（一个用于存储静态资源的服务），最终使用**CloudFront**（AWS CDN）分发，让用户通过 HTTP 请求访问这些静态资源。我们还需要将我们的 CloudFront 分发链接到一个域名，我们可以使用**AWS Route 53**（一个 AWS 专有的 DNS 服务）来实现这一点。

与之相比，Cloudflare 使事情变得简单一些。它有一个更直观的 UI，称为 Cloudflare Pages，可以帮助我们将项目链接到 Git 仓库，并且每次我们向任何分支推送新代码时，都会自动部署一个新的网站版本。当然，每次我们将代码推送到主分支时，它都会在生产环境中发布；如果我们想预览位于功能分支上的某些功能，我们只需将代码推送到那里，然后等待 Cloudflare 发布预览部署，就像 Vercel 做的那样。

Microsoft Azure 提供了另一种令人兴奋的方法。我们可以进入 Azure 门户（Azure 管理仪表板），创建一个新的资源，选择“静态 Web 应用”作为资源类型，并输入所需的数据来配置它。之后，我们可以链接我们的 GitHub 账户，就像我们在 Cloudflare 和 Vercel 上做的那样，实现自动部署。Azure 会为我们创建一个 GitHub 工作流文件，这样构建阶段就会在 GitHub 上运行，一旦成功就会将内容推送到 Azure。

现在，你可能想知道如何从之前列出的 CDN 中选择最好的一个。好吧，它们都很优秀，但有一种方法可以确定哪个最适合我们的需求。

以 AWS 为例，可能看起来是最复杂的。但如果我们已经拥有 AWS 基础设施，那么在那里设置部署会更容易。同样适用于 Microsoft Azure，我们可能已经在该平台上运行了现有的项目，并且我们不希望将单个 Web 应用程序移出该平台。

相反，Cloudflare 可以是所有不需要依赖其他服务（除了无服务器函数（Cloudflare 提供名为 Cloudflare Workers 的无服务器函数服务）和其他类似服务，您可以在 https://developers.cloudflare.com 找到这些服务）的静态网站的完美解决方案。

尽管有方法在不脱离静态网站的情况下执行无服务器函数（通过使用 AWS Lambda、Azure Functions、Cloudflare Workers 等），但有时我们需要创建数十个甚至数百个无服务器函数。组织这样的部署可能具有挑战性，尤其是如果我们是在一个没有 DevOps 人员支持的小团队中工作。

有时，我们只需要服务器端渲染与静态生成的页面一起，并且需要在运行时使用 Node.js 代码的应用程序进行部署。一个有趣的方法是将网站完全以无服务器的方式部署。

有一个名为 **serverless-next.js** 的开源项目（[`github.com/serverless-nextjs/serverless-next.js`](https://github.com/serverless-nextjs/serverless-next.js)）可以帮助我们实现这一结果。它作为一个 "*无服务器组件*"（在这种情况下，*无服务器* 是一个 npm 库的名称，用于将代码部署到任何无服务器平台）来配置 AWS 上的部署，通过适应以下规则：

+   SSR 页面和 API 路由将由 AWS Lambda（无服务器函数）部署和提供服务。

+   静态页面、客户端资源和公共文件将部署到 S3，并由 CloudFront 自动提供服务。

这种方法将导致一种混合部署，我们总是试图实现每种类型请求的最佳性能。SSR 和 API 页面（需要 Node.js 运行时）将由无服务器函数提供服务，其余的由 CDN 提供。

不要担心这听起来很复杂，因为它并不复杂。但如果您觉得这将是应用程序生命周期中过度工程化的部分（并且您仍然需要服务器端渲染和 API 路由），您可能希望考虑其他方法。我们将在下一节讨论如何正确地将 SSR Next.js 应用程序部署到任何平台。

# 在任何服务器上部署 Next.js

到目前为止，我们已经看到了一些将我们的 Next.js 应用程序部署到 CDN 和托管基础设施的替代方案，例如 Vercel 和 Netlify。然而，还有一个我们尚未考虑的替代方案；如果我们想将我们的应用程序部署到我们的私有服务器上怎么办？

尽管这是一个常见的情况，但它也是迄今为止最复杂的情况。虽然平台如 Vercel、Netlify 和 Heroku 为我们管理服务器，但有时我们可能希望将我们的应用程序托管在私有服务器上，在那里我们必须独立控制一切。

让我们快速回顾一下之前提到的托管平台能为我们做什么：

+   自动部署

+   回滚到之前的部署

+   特性分支的自动部署

+   自动服务器配置（Node.js 运行时、反向代理等）

+   内置缩放功能

通过选择自定义服务器，我们必须自己实现所有这些功能。但这值得吗？嗯，这取决于。当在一个大型公司工作，该公司已经在特定的云服务提供商上运行着显著的基础设施（无论是亚马逊 AWS、谷歌云、微软 Azure 等等）时，对于我们来说，在相同的基础设施中确定部署我们的 Next.js 应用程序的最佳解决方案可能是有意义的。

如果我们在进行一个副项目或小型商业网站，或者从头开始创建一个新的网络应用程序，我们可以考虑替代方案，如托管平台或 CDN，但我们已经讨论过这一点。

让我们暂时假设选择已经做出，我们必须将我们的应用程序部署到亚马逊 AWS、谷歌云或微软 Azure 之一。那么我们如何从那里开始部署和托管呢？

首先要考虑的是我们希望如何提供我们的应用程序。从一个空服务器开始意味着我们必须手动设置一堆东西来使其准备好提供 Node.js 应用程序。这包括（但不限于）以下内容：

+   *Node.js 运行时*：Node.js 并非预安装在每一个操作系统上，因此我们需要安装它来提供 API 和服务器端渲染的页面。

+   *进程管理器*：如果你以前已经使用过 Node.js，你可能知道如果主进程崩溃，整个应用程序将保持关闭状态，直到我们手动重新启动它。这是由于 Node.js 的单线程架构，并且未来不太可能改变，因此我们需要为此可能性做好准备。解决该问题的流行方法之一是使用进程管理器，如 PM2 ([`github.com/Unitech/pm2`](https://github.com/Unitech/pm2))，它监控 Node.js 进程并管理它们以保持应用程序运行。它还提供了许多其他附加功能来处理任何 Node.js 程序，所以如果你对此感兴趣，我建议你阅读官方文档在 [`pm2.keymetrics.io`](https://pm2.keymetrics.io)。

+   *反向代理*：尽管我们可以轻松设置任何 Node.js 应用程序来管理传入的 HTTP 请求，但将它们放在 NGINX、Caddy 或 Envoy 等反向代理之后是一种最佳实践。这除了增加了额外的安全层之外，还意味着我们必须在我们的服务器上维护一个反向代理。

+   *设置防火墙规则*：我们需要打开防火墙以接受对 `:443` 和 `:80` 端口的入站 HTTP 请求。

+   *设置高效的部署管道*：我们可以使用 Jenkins、CircleCI，甚至 GitHub Actions。但这又是另一件需要注意的事情。

一旦我们完成了整个环境的设置，我们也应该考虑，当我们需要扩展我们的基础设施以接受越来越多的入站请求时，我们可能需要尽快在另一台服务器上复制相同的设置。在新的服务器上复制它可能相当容易，但如果我们需要在数十台新机器上进行扩展怎么办？如果我们需要升级所有机器上的 Node.js 运行时或反向代理怎么办？事情变得越来越复杂和耗时，所以我们可能想要寻找另一种方法，这就是我们将在下一节中讨论的内容：如何通过 Docker 将我们的 Next.js 应用程序部署到任何服务器。

# 在 Docker 容器中运行 Next.js

Docker，以及一般意义上的虚拟化，已经永远改变了我们构建和部署应用程序的方式。它提供了一套有用的实用工具、命令和配置，使我们的构建在任何服务器上都具有可重复性，通过创建运行我们程序（或网络应用程序）的虚拟机，使我们的应用程序几乎可以在任何操作系统上运行。

如果你刚开始接触 Docker

Docker 是构建和部署任何计算机程序（网络应用程序、数据库或其他任何东西）时需要考虑的重要工具。如果你对这个技术还不太熟悉，我强烈建议你在开始使用它之前阅读官方的 Docker 文档[`www.docker.com`](https://www.docker.com)。如果你对通过实践学习 Docker 感兴趣，我也建议你阅读 Russ McKendrick 的《Mastering Docker – 第四版》([`www.packtpub.com/product/mastering-docker-fourth-edition/9781839216572`](https://www.packtpub.com/product/mastering-docker-fourth-edition/9781839216572))；它提供了完整的入门和了解 Docker 的指南。

在 Docker 中运行 Next.js 相对直接。一个非常基本的 Dockerfile 包含以下命令：

```js
FROM node:16-alpine
RUN mkdir -p /app
WORKDIR /app
COPY . /app/
RUN npm install
RUN npm run build
EXPOSE 3000
CMD npm run start
```

这几乎不费吹灰之力，不是吗？让我们将其分解成小步骤：

1.  首先，声明我们想要在哪个镜像中运行我们的服务器。在这种情况下，我们选择 `node:14-alpine`。

1.  创建一个新的工作目录是一个最佳实践，因此作为第一步，创建它并命名为 `/app`。

1.  选择 `/app` 作为我们的工作目录。

1.  将我们本地目录的所有内容复制到 Docker 的工作目录中。

1.  安装所有必需的依赖项。

1.  在容器的工作目录内构建 Next.js。

1.  将端口 `3000` 暴露给容器外部。

1.  运行启动脚本以启动 Next.js 内置服务器。

我们可以通过创建一个新的、空的 Next.js 应用程序并在新目录中运行以下命令来测试之前的 Dockerfile：

```js
npx create-next-app my-first-dockerized-nextjs-app
```

让我们创建一个包含我们刚刚讨论内容的 Dockerfile。我们还应该创建一个包含`node_modules`和 Next.js 输出目录的`.dockerignore`文件，这样我们就不会将它们复制到容器中：

```js
.next
node_modules
```

我们现在可以继续构建 Docker 容器：

```js
docker build -t my-first-dockerized-nextjs-app .
```

我们将使用一个自定义名称标记它，在这个例子中，是`my-first-dockerized-nextjs-app`。

一旦构建成功，我们可以按照以下方式运行容器：

```js
docker run -p 3000:3000  my-first-dockerized-nextjs-app
```

我们最终能够通过 http://localhost:3000 访问我们的 Web 应用！

从这个简单的配置开始，我们将能够将我们的应用部署到任何托管容器服务（如 AWS ECS 或 Google Cloud Run）、任何 Kubernetes 集群或任何安装了 Docker 的机器。

在生产中使用容器有许多好处，因为我们只需要一个非常简单的配置文件来设置 Linux 机器的虚拟化，以便运行我们的应用。无论何时我们需要复制、扩展或重新生成我们的构建，我们都可以通过共享 Dockerfile 并执行它来简单地做到这一点，使整个过程变得极其简单、可扩展且易于维护。

话虽如此，我们是否总是需要 Docker？让我们在下一节的总结中讨论这个问题。

# 总结

在本章中，我们看到了 Next.js 应用的多种部署平台。在构建和部署 Next.js 应用方面，没有完美的解决方案，因为它取决于每个项目带来的特定用例和挑战。

Vercel、Netlify 和 Heroku（仅举几个例子）都是快速将 Next.js 应用部署到生产的优秀替代方案。另一方面，Cloudflare Pages、AWS S3 和 AWS CloudFront 以及 Microsoft Azure CDN 确实可以为我们的静态网站提供出色的性能，在提供静态生成网站方面，与我们在本章中看到的所有其他优秀解决方案竞争。

Docker 可能是最灵活的解决方案之一。它允许我们在任何地方部署我们的应用，使得在每台机器上复制生产环境变得容易。

再次强调，对于部署 Next.js 应用来说，并没有一个“完美”的解决方案，因为这个领域的竞争非常激烈，许多公司提供了优秀的解决方案来简化我们的开发生活，并使用户的浏览体验始终如一地更好。

当决定在哪里部署 Next.js 应用时，我能给出的最好建议是考虑以下方面：我所在的团队有多大？虽然 Vercel、Netlify、Heroku 和 Cloudflare 等解决方案非常适合小型和大型团队，但还有其他提供者，所需的知识、技能集和容量要高得多。在 AWS EC2 实例或 DigitalOcean 或 Google Cloud 上的自定义机器上设置，给我们提供了对整个应用生命周期的更多控制，但成本（在配置、设置和所需时间方面）是相当可观的。

另一方面，当在大公司工作，那里有一个专门的 DevOps 团队可以负责应用程序的发布流程时，他们可能会更倾向于采用自定义解决方案，这样他们就有越来越多的控制权。

即使我们在单独工作，我们也可以选择将我们的应用程序部署到自定义云基础设施。如果我们这么做，我们应该确保我们没有无意中重新发明轮子，即重新创建 Vercel、Netlify、Cloudflare 等甚至免费计划就能提供的基础设施。

我们到目前为止已经取得了一些显著的进步。我们学习了框架的基础知识以及如何将其与不同的库和数据源集成，现在我们也知道了如何为任何需求选择部署平台。

从下一章开始，我们将构建一些实际的应用程序，这将使我们能够理解在 Next.js 中创建生产就绪的 Web 应用程序时我们将面临的现实世界挑战。
