<html><head></head><body>
  <div id="_idContainer299" class="Basic-Text-Frame">
    <h1 class="chapterNumber">6</h1>
    <h1 id="_idParaDest-191" class="chapterTitle">Implementing Role-Based Navigation</h1>
    <p class="normal">In <em class="chapterRef">Chapter 5</em>, <em class="italic">Designing Authorization and Authentication</em>, we covered how designing an effective authentication and authorization system is challenging but crucial for user satisfaction. Users expect a high standard from web authentication systems, and any errors should be clearly communicated. As applications grow, their authentication backbone should be easily maintainable and extensible to ensure a seamless user experience.</p>
    <p class="normal">In this chapter, we will discuss the challenges of creating a great auth UX and implementing a solid baseline experience. We will continue the router-first approach to designing SPAs by implementing the auth experience of LemonMart. In <em class="chapterRef">Chapter 4</em>, <em class="italic">Creating a Router-First Line-of-Business App</em>, we defined user roles, finished our build-out of all major routing, and completed a rough walking-skeleton navigation experience of LemonMart. This means we are well prepared to implement a role-based conditional navigation experience that captures the nuances of a seamless auth experience. We will supplement this with an auth provider using the Google Firebase auth service, which you can leverage in real-world applications.</p>
    <p class="normal">In this chapter, you will learn about the following topics:</p>
    <ul>
      <li class="bulletList">Dynamic UI components and navigation</li>
      <li class="bulletList">Role-based routing using guards</li>
      <li class="bulletList">A Firebase authentication recipe</li>
      <li class="bulletList">Providing a service using a factory</li>
    </ul>
    <h1 id="_idParaDest-192" class="heading-1">Technical requirements</h1>
    <p class="normal">The most up-to-date versions of the sample code for the book are on GitHub at the following linked repository. The repository contains the final and completed state of the code. You can verify your progress at the end of this chapter by looking for the end-of-chapter snapshot of code under the <code class="inlineCode">projects</code> folder.</p>
    <p class="normal">For <em class="italic">Chapter 6</em>:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Clone the repository <a href="https://github.com/duluca/lemon-mart"><span class="url">https://github.com/duluca/lemon-mart</span></a>.</li>
      <li class="numberedList">Execute <code class="inlineCode">npm install</code> on the root folder to install dependencies.</li>
      <li class="numberedList">You will continue building on <code class="inlineCode">stage8</code> from the last chapter:
        <pre class="programlisting con"><code class="hljs-con">projects/stage7
</code></pre>
      </li>
      <li class="numberedList">The end state of the project is reflected at:
        <pre class="programlisting con"><code class="hljs-con">projects/stage8
</code></pre>
      </li>
      <li class="numberedList">Add the stage name to any <code class="inlineCode">ng</code> command to act only on that stage:
        <pre class="programlisting con"><code class="hljs-con">npx ng build stage8
</code></pre>
      </li>
    </ol>
    <div class="packt_tip">
      <p class="normal">Note that the <code class="inlineCode">dist/stage8</code> folder at the root of the repository will contain the compiled result.</p>
    </div>
    <div class="note">
      <p class="normal">Beware that the source code provided in the book and the version on GitHub are likely to be different. The ecosystem around these projects is ever-evolving. Between changes to how Angular CLI generates new code, bug fixes, new versions of libraries, and side-by-side implementations of multiple techniques, there’s a lot of variation that is impossible to account for. If you find errors or have questions, please create an issue or submit a pull request on GitHub.</p>
    </div>
    <p class="normal">With the in-memory auth provider in place, let’s take advantage of all the supporting code we have written with dynamic UI components and a conditional navigation system for a role-based UX.</p>
    <h1 id="_idParaDest-193" class="heading-1">Dynamic UI components and navigation</h1>
    <p class="normal"><code class="inlineCode">AuthService</code> provides asynchronous<a id="_idIndexMarker540"/> auth status and user information, including a user’s name and role. We can use all this information to create a friendly and personalized user experience. In this next section, we will implement the <code class="inlineCode">LoginComponent</code> so that users can enter their username and password information and attempt a login.</p>
    <h2 id="_idParaDest-194" class="heading-2">Implementing the login component</h2>
    <p class="normal">The <code class="inlineCode">LoginComponent</code> leverages the <code class="inlineCode">AuthService</code> we created and implements validation errors using reactive forms.</p>
    <div class="packt_tip">
      <p class="normal">Remember that in <code class="inlineCode">app.config.ts</code>, we provided <code class="inlineCode">AuthService</code> using the class <code class="inlineCode">InMemoryAuthService</code>. So, during runtime, when <code class="inlineCode">AuthService</code> is injected into the <code class="inlineCode">LoginComponent</code>, the in-memory service will be used.</p>
    </div>
    <p class="normal">The <code class="inlineCode">LoginComponent</code> should be designed to be rendered independently of any other component because, during a routing event, if we discover that the user is not properly authenticated or authorized, we will navigate them to this component. We can capture this origination URL as a <code class="inlineCode">redirectUrl</code> so that once a user logs in successfully, we can navigate them back to it.</p>
    <p class="normal">Let’s begin:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Create a new component named <code class="inlineCode">login</code> in the root of your application with inline styles.</li>
      <li class="numberedList">Let’s start by implementing the routes to the <code class="inlineCode">LoginComponent</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/app-routing.modules.ts</strong></span>
...
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'login'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title">LoginComponent</span> },
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'login/:redirectUrl'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title">LoginComponent</span> },
...
</code></pre>
        <div class="packt_tip">
          <p class="normal">Remember that the <code class="inlineCode">'**'</code> path must be the last one defined.</p>
        </div>
      </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Using a similar <code class="inlineCode">login</code> logic to the one we implemented in <code class="inlineCode">HomeComponent</code>, implement the <code class="inlineCode">LoginComponent</code> with some styles:
    <div class="note">
      <p class="normal">Don’t forget to import the requisite dependent modules into your Angular application for the upcoming steps. This is intentionally left as an exercise for you to locate and import<a id="_idIndexMarker541"/> the missing modules.</p>
    </div>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/login/login.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
…
<span class="hljs-keyword">import</span> { <span class="hljs-title">AuthService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../auth/auth.service'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Role</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../auth/role.enum'</span>
<span class="hljs-meta">@Component</span>({
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'</span><span class="hljs-string">app-login'</span>,
  <span class="hljs-attr">templateUrl</span>: <span class="hljs-string">'login.component.html'</span>,
  <span class="hljs-attr">styles</span>: <span class="hljs-string">`</span>
<span class="hljs-string">      .error { color: red; }</span>
<span class="hljs-string">      div[fxLayout] { margin-top: 32px; }</span>
<span class="hljs-string">    `</span>, 
  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-title">FlexModule</span>,
    <span class="hljs-title">MatCardModule</span>,
    <span class="hljs-title">ReactiveFormsModule</span>,
    <span class="hljs-title">MatIconModule</span>,
    <span class="hljs-title">MatFormFieldModule</span>,
    <span class="hljs-title">MatInputModule</span>,
    <span class="hljs-title">FieldErrorDirective</span>,
    <span class="hljs-title">MatButtonModule</span>,
    <span class="hljs-title">MatExpansionModule</span>,
    <span class="hljs-title">MatGridListModule</span>,
  ],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LoginComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OnInit</span> { 
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> formBuilder = <span class="hljs-title">inject</span>(<span class="hljs-title">FormBuilder</span>)
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> authService = <span class="hljs-title">inject</span>(<span class="hljs-title">AuthService</span>)
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> router = <span class="hljs-title">inject</span>(<span class="hljs-title">Router</span>)
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> route = <span class="hljs-title">inject</span>(<span class="hljs-title">ActivatedRoute</span>)
  <span class="hljs-attr">loginForm</span>: <span class="hljs-title">FormGroup</span>
  loginError = <span class="hljs-string">''</span>  
  <span class="hljs-keyword">get</span> <span class="hljs-title">redirectUrl</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-property">route</span>.<span class="hljs-property">snapshot</span>
               .<span class="hljs-property">queryParamMap</span>.<span class="hljs-title">get</span>(<span class="hljs-string">'</span><span class="hljs-string">redirectUrl'</span>) || <span class="hljs-string">''</span>
  }
  
  <span class="hljs-title">ngOnInit</span>() {
    <span class="hljs-variable">this</span>.<span class="hljs-property">authService</span>.<span class="hljs-title">logout</span>()
    <span class="hljs-variable">this</span>.<span class="hljs-title">buildLoginForm</span>()
  }
  <span class="hljs-title">buildLoginForm</span>() {
    <span class="hljs-variable">this</span>.<span class="hljs-property">loginForm</span> = <span class="hljs-variable">this</span>.<span class="hljs-property">formBuilder</span>.<span class="hljs-title">group</span>({
      <span class="hljs-attr">email</span>: [<span class="hljs-string">''</span>, [<span class="hljs-title">Validators</span>.<span class="hljs-property">required</span>, <span class="hljs-title">Validators</span>.<span class="hljs-property">email</span>]],
      <span class="hljs-attr">password</span>: [<span class="hljs-string">''</span>, [
        <span class="hljs-title">Validators</span>.<span class="hljs-property">required</span>,
        <span class="hljs-title">Validators</span>.<span class="hljs-title">minLength</span>(<span class="hljs-number">8</span>),
        <span class="hljs-title">Validators</span>.<span class="hljs-title">maxLength</span>(<span class="hljs-number">50</span>),
      ]],
    })
  }
  <span class="hljs-keyword">async</span> <span class="hljs-title">login</span>(<span class="hljs-attr">submittedForm</span><span class="hljs-params">: </span><span class="hljs-title">FormGroup</span>) {
    <span class="hljs-variable">this</span>.<span class="hljs-property">authService</span>
      .<span class="hljs-title">login</span>(
        submittedForm.<span class="hljs-property">value</span>.<span class="hljs-property">email</span>,
        submittedForm.<span class="hljs-property">value</span>.<span class="hljs-property">password</span>
      )
      .<span class="hljs-title">pipe</span>(<span class="hljs-title">catchError</span>(<span class="hljs-params">err</span><span class="hljs-function"> =&gt;</span> (<span class="hljs-variable">this</span>.<span class="hljs-property">loginError</span> = err)))
    <span class="hljs-title">combineLatest</span>([
      <span class="hljs-variable">this</span>.<span class="hljs-property">authService</span>.<span class="hljs-property">authStatus$</span>,
      <span class="hljs-variable">this</span>.<span class="hljs-property">authService</span>.<span class="hljs-property">currentUser$</span>,
    ])
      .<span class="hljs-title">pipe</span>(
        <span class="hljs-title">filter</span>(
          <span class="hljs-function">(</span><span class="hljs-params">[authStatus, user]</span><span class="hljs-function">) =&gt;</span>
            authStatus.<span class="hljs-property">isAuthenticated</span> &amp;&amp; user?.<span class="hljs-property">_id</span> !== <span class="hljs-string">''</span>
        ),
        <span class="hljs-title">first</span>(),
        <span class="hljs-title">tap</span>(<span class="hljs-function">(</span><span class="hljs-params">[authStatus, user]</span><span class="hljs-function">) =&gt;</span> {
          <span class="hljs-variable">this</span>.<span class="hljs-property">router</span>.<span class="hljs-title">navigate</span>([<span class="hljs-variable">this</span>.<span class="hljs-property">redirectUrl</span> || <span class="hljs-string">'/manager'</span>])
        })
      )
      .<span class="hljs-title">subscribe</span>()
  } 
}
</code></pre>
    <p class="normal">We are using the <code class="inlineCode">first</code> operator<a id="_idIndexMarker542"/> to manage the subscription. We ensure that we are logged out when <code class="inlineCode">ngOnInit</code> is called. We build the reactive form in a standard manner. Finally, the <code class="inlineCode">login</code> method calls <code class="inlineCode">this.authService.login</code> to initiate the login process.</p>
    <p class="normal">We listen to the <code class="inlineCode">authStatus$</code> and <code class="inlineCode">currentUser$</code> data streams simultaneously using <code class="inlineCode">combineLatest</code>. Every time there’s a change in each stream, our pipe gets executed. We filter out unsuccessful login attempts. As the result of a successful login attempt, we leverage the router to navigate an authenticated user to their profile. In the case of an error sent from the server via the service, we assign that error to <code class="inlineCode">loginError</code>.</p></li>
    </ol>





    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Here’s an implementation<a id="_idIndexMarker543"/> for a login form to capture and validate a user’s <code class="inlineCode">email</code> and <code class="inlineCode">password</code> and, if there are any server errors, display them:
    <div class="packt_tip">
      <p class="normal">Don’t forget to import <code class="inlineCode">ReactiveFormsModule</code> in <code class="inlineCode">app.modules.ts</code>.</p>
    </div>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/login/login.component.html</strong></span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayout</span><span class="hljs-tag">=</span><span class="hljs-string">"row"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayoutAlign</span><span class="hljs-tag">=</span><span class="hljs-string">"</span><span class="hljs-string">center"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-card</span><span class="hljs-tag"> </span><span class="hljs-attr">appearance</span><span class="hljs-tag">=</span><span class="hljs-string">"outlined"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlex</span><span class="hljs-tag">=</span><span class="hljs-string">"400px"</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-card-header</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-card-title</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"mat-headline-5"</span><span class="hljs-tag">&gt;</span>Hello, Limoncu!<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-card-title</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-card-header</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-card-content</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">form</span><span class="hljs-tag"> [</span><span class="hljs-attr">formGroup</span><span class="hljs-tag">]=</span><span class="hljs-string">"loginForm"</span><span class="hljs-tag"> (</span><span class="hljs-attr">ngSubmit</span><span class="hljs-tag">)=</span><span class="hljs-string">"login(loginForm)"</span>
<span class="hljs-string">                 </span><span class="hljs-attr">fxLayout</span><span class="hljs-tag">=</span><span class="hljs-string">"</span><span class="hljs-string">column"</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayout</span><span class="hljs-tag">=</span><span class="hljs-string">"row"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayoutAlign</span><span class="hljs-tag">=</span><span class="hljs-string">"start center"</span>
<span class="hljs-string">              </span><span class="hljs-tag">  </span><span class="hljs-attr">fxLayoutGap</span><span class="hljs-tag">=</span><span class="hljs-string">"10px"</span><span class="hljs-tag">&gt;</span>
          <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-icon</span><span class="hljs-tag">&gt;</span>email<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-icon</span><span class="hljs-tag">&gt;</span>
          <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlex</span><span class="hljs-tag">&gt;</span>
            <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span>
<span class="hljs-tag">              </span><span class="hljs-attr">matInput</span>
<span class="hljs-tag">              </span><span class="hljs-attr">placeholder</span><span class="hljs-tag">=</span><span class="hljs-string">"</span><span class="hljs-string">E-mail"</span>
<span class="hljs-tag">              </span><span class="hljs-attr">aria-label</span><span class="hljs-tag">=</span><span class="hljs-string">"E-mail"</span>
<span class="hljs-tag">              </span><span class="hljs-attr">formControlName</span><span class="hljs-tag">=</span><span class="hljs-string">"email"</span>
<span class="hljs-tag">              #</span><span class="hljs-attr">email</span><span class="hljs-tag"> /&gt;</span>
            <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-error</span><span class="hljs-tag"> [</span><span class="hljs-attr">input</span><span class="hljs-tag">]=</span><span class="hljs-string">"email"</span><span class="hljs-tag"> [</span><span class="hljs-attr">group</span><span class="hljs-tag">]=</span><span class="hljs-string">"loginForm"</span>
<span class="hljs-string">                               </span><span class="hljs-tag"> </span><span class="hljs-attr">appFieldError</span><span class="hljs-tag">=</span><span class="hljs-string">"invalid"</span><span class="hljs-tag">&gt;</span>
            <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>
          <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayout</span><span class="hljs-tag">=</span><span class="hljs-string">"row"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayoutAlign</span><span class="hljs-tag">=</span><span class="hljs-string">"start center"</span>
<span class="hljs-string">              </span><span class="hljs-tag">  </span><span class="hljs-attr">fxLayoutGap</span><span class="hljs-tag">=</span><span class="hljs-string">"10px"</span><span class="hljs-tag">&gt;</span>
          <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-icon</span><span class="hljs-tag"> </span><span class="hljs-attr">matPrefix</span><span class="hljs-tag">&gt;</span>vpn_key<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-icon</span><span class="hljs-tag">&gt;</span>
          <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlex</span><span class="hljs-tag">&gt;</span>
            <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span>
<span class="hljs-tag">              </span><span class="hljs-attr">matInput</span>
<span class="hljs-tag">              </span><span class="hljs-attr">placeholder</span><span class="hljs-tag">=</span><span class="hljs-string">"</span><span class="hljs-string">Password"</span>
<span class="hljs-tag">              </span><span class="hljs-attr">aria-label</span><span class="hljs-tag">=</span><span class="hljs-string">"Password"</span>
<span class="hljs-tag">              </span><span class="hljs-attr">type</span><span class="hljs-tag">=</span><span class="hljs-string">"password"</span>
<span class="hljs-tag">              </span><span class="hljs-attr">formControlName</span><span class="hljs-tag">=</span><span class="hljs-string">"password"</span>
<span class="hljs-tag">              #</span><span class="hljs-attr">password</span><span class="hljs-tag"> /&gt;</span>
            <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-hint</span><span class="hljs-tag">&gt;</span>Minimum 8 characters<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-hint</span><span class="hljs-tag">&gt;</span>
            <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-error</span>
<span class="hljs-tag">              [</span><span class="hljs-attr">input</span><span class="hljs-tag">]=</span><span class="hljs-string">"password"</span>
<span class="hljs-tag">              [</span><span class="hljs-attr">group</span><span class="hljs-tag">]=</span><span class="hljs-string">"loginForm"</span>
<span class="hljs-tag">              [</span><span class="hljs-attr">appFieldError</span><span class="hljs-tag">]=</span>
<span class="hljs-tag">                </span><span class="hljs-string">"['required', 'minlength', 'maxlength']"</span><span class="hljs-tag">&gt;</span>
            <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>
          <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayout</span><span class="hljs-tag">=</span><span class="hljs-string">"row"</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"margin-top"</span><span class="hljs-tag">&gt;</span>
          @if (loginError) {
            <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"mat-caption error"</span><span class="hljs-tag">&gt;</span>
              {{ loginError }}
            <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
          }           
          <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"flex-spacer"</span><span class="hljs-tag">&gt;&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
          <span class="hljs-tag">&lt;</span><span class="hljs-name">button</span>
<span class="hljs-tag">            </span><span class="hljs-attr">mat-raised-button</span>
<span class="hljs-tag">            </span><span class="hljs-attr">type</span><span class="hljs-tag">=</span><span class="hljs-string">"submit"</span>
<span class="hljs-tag">            </span><span class="hljs-attr">color</span><span class="hljs-tag">=</span><span class="hljs-string">"primary"</span>
<span class="hljs-tag">            [</span><span class="hljs-attr">disabled</span><span class="hljs-tag">]=</span><span class="hljs-string">"loginForm.invalid"</span><span class="hljs-tag">&gt;</span>
            Login
          <span class="hljs-tag">&lt;/</span><span class="hljs-name">button</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">form</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-card-content</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-card</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
</code></pre>
    <div class="note">
      <p class="normal">The <strong class="screenText">Login</strong> button is disabled until the email and password meet client site validation rules. Additionally, <code class="inlineCode">&lt;mat-form-field&gt;</code> will only display one <code class="inlineCode">mat-error</code> at a time, unless you create more space for more errors, so be sure to place your error conditions in the correct order.</p>
    </div>
    <p class="normal">Once you’re done implementing the <code class="inlineCode">LoginComponent</code>, you can update the home screen to conditionally display or hide the new component we created.</p></li>
    </ol>








    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Update the <code class="inlineCode">HomeComponent</code> to clean up the code<a id="_idIndexMarker544"/> we added previously so that we can display the <code class="inlineCode">LoginComponent</code> when users land on the home page of the app:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/home/home.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
  ...
  <span class="hljs-attr">template</span>: <span class="hljs-string">`</span>
<span class="hljs-string">    @if (displayLogin) {</span>
<span class="hljs-string">      &lt;app-login&gt;&lt;/app-login&gt;</span>
<span class="hljs-string">    } @else {</span>
<span class="hljs-string">      &lt;span class="mat-display-3"&gt;</span>
<span class="hljs-string">        You get a lemon, you get a lemon, you get a lemon...</span>
<span class="hljs-string">      &lt;/span&gt;</span>
<span class="hljs-string">    }</span>
<span class="hljs-string">  `</span>,
}) 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HomeComponent</span> {
  displayLogin = <span class="hljs-literal">true</span>
  <span class="hljs-title">constructor</span>() {
  }
}
</code></pre>
      </li>
    </ol>
    <p class="normal">Your application should look like the following screenshot:</p>
    <figure class="mediaobject"><img src="../Images/B20960_06_01.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 6.1: LemonMart with login</p>
    <p class="normal">There’s still some work to be done in terms of implementing and showing/hiding the <code class="inlineCode">sidenav</code> menu, profile, and logout<a id="_idIndexMarker545"/> icons, given the user’s authentication status.</p>
    <h2 id="_idParaDest-195" class="heading-2">Conditional navigation</h2>
    <p class="normal">Conditional navigation is necessary<a id="_idIndexMarker546"/> to create a frustration-free UX. By selectively showing the elements the user has access to and hiding the ones they don’t, we allow the user to confidently navigate through the application.</p>
    <p class="normal">Let’s start by hiding the <code class="inlineCode">LoginComponent</code> after a user logs into the application:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">On the <code class="inlineCode">HomeComponent</code>, inject the <code class="inlineCode">AuthService</code> into the constructor as a <code class="inlineCode">public</code> variable:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/home/home.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">simple</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
<span class="hljs-keyword">import</span> { <span class="hljs-title">AuthService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../auth/auth.service'</span>
...
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HomeComponent</span> { 
  <span class="hljs-title">constructor</span>(<span class="hljs-keyword">public</span><span class="hljs-params"> </span><span class="hljs-attr">authService</span><span class="hljs-params">: </span><span class="hljs-title">AuthService</span>) {}
}
</code></pre>
      </li>
      <li class="numberedList">Remove the local variable <code class="inlineCode">displayLogin</code> because we can directly tap into the auth status in the template using the <code class="inlineCode">async</code> pipe.</li>
      <li class="numberedList">Implement a new template using the control flow syntax, along with the <code class="inlineCode">async</code> pipe, as shown here:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/home/home.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
  <span class="hljs-attr">template</span>: <span class="hljs-string">`</span>
<span class="hljs-string">    </span><span class="code-highlight"><strong class="hljs-string-slc">@if ((authService.authStatus$ | async)?.isAuthenticated) {</strong></span>
<span class="hljs-string">      &lt;div&gt;      </span>
<span class="hljs-string">        &lt;div class="mat-display-4"&gt;</span>
<span class="hljs-string">          This is LemonMart! The place where</span>
<span class="hljs-string">        &lt;/div&gt;</span>
<span class="hljs-string">        &lt;div class="mat-display-4"&gt;</span>
<span class="hljs-string">          You get a lemon, you get a lemon, you get a lemon...</span>
<span class="hljs-string">        &lt;/div&gt;</span>
<span class="hljs-string">        &lt;div class="mat-display-4"&gt;</span>
<span class="hljs-string">          Everybody gets a lemon.</span>
<span class="hljs-string">        &lt;/div&gt;</span>
<span class="hljs-string">      &lt;/div&gt;</span>
<span class="hljs-string">    </span><span class="code-highlight"><strong class="hljs-string-slc">} @else {</strong></span>
<span class="hljs-string">      &lt;app-login&gt;&lt;/app-login&gt;</span>
<span class="hljs-string">    </span><span class="code-highlight"><strong class="hljs-string-slc">}</strong></span>
<span class="hljs-string">  `</span>,
   <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,
   <span class="hljs-attr">imports</span>: [<span class="hljs-title">LoginComponent</span>, <span class="hljs-title">AsyncPipe</span>],
</code></pre>
      
    <div class="note">
      <p class="normal">Using the <code class="inlineCode">async</code> pipe avoids errors like <code class="inlineCode">Error: ExpressionChangedAfterItHasBeenCheckedError: Expression has changed after it was checked</code>. Whenever you see this error, stop using local variables and, instead, use the <code class="inlineCode">async</code> pipe. It is the reactive thing to do!</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">On the <code class="inlineCode">AppComponent</code>, we will follow<a id="_idIndexMarker547"/> a similar pattern by injecting <code class="inlineCode">AuthService</code> as a <code class="inlineCode">public</code> variable:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/app.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Component</span>, <span class="hljs-title">OnInit</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">AuthService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth/auth.service'</span>
...
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AppComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OnInit</span> { 
  <span class="hljs-title">constructor</span>(<span class="hljs-params">..., </span><span class="code-highlight"><strong class="hljs-keyword-slc">public</strong><strong class="hljs-params-slc"> </strong><strong class="hljs-attr-slc">authService</strong><strong class="hljs-params-slc">: </strong><strong class="hljs-title-slc">AuthService</strong></span>) {
  }
  <span class="hljs-title">ngOnInit</span>(): <span class="hljs-built_in">void</span> {}
  ...
}
</code></pre>
      </li>
      <li class="numberedList">Update <code class="inlineCode">mat-toolbar</code> in the template<a id="_idIndexMarker548"/> so that we monitor both <code class="inlineCode">authStatus$</code> and <code class="inlineCode">currentUser$</code> using the <code class="inlineCode">async</code> pipe:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-meta-slc">@if</strong><strong class="hljs-slc"> ({</strong></span>
  <span class="code-highlight"><strong class="hljs-attr-slc">status</strong><strong class="hljs-slc">: authService.</strong><strong class="hljs-property-slc">authStatus$</strong><strong class="hljs-slc"> | </strong><strong class="hljs-keyword-slc">async</strong><strong class="hljs-slc">,</strong></span>
  <span class="code-highlight"><strong class="hljs-attr-slc">user</strong><strong class="hljs-slc">: authService.</strong><strong class="hljs-property-slc">currentUser$</strong><strong class="hljs-slc"> | </strong><strong class="hljs-keyword-slc">async</strong></span>
<span class="code-highlight"><strong class="hljs-slc">}; </strong><strong class="hljs-keyword-slc">as</strong><strong class="hljs-slc"> auth;) {      </strong></span>
   <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-toolbar</span><span class="hljs-tag"> </span><span class="hljs-attr">...</span>
</code></pre>
      </li>
      <li class="numberedList">Use <code class="inlineCode">@if</code> to hide all buttons meant for logged-in users:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/app.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-meta">@if</span> (auth?.<span class="hljs-property">status</span>?.<span class="hljs-property">isAuthenticated</span>) {
  <span class="hljs-tag">&lt;</span><span class="hljs-name">button</span><span class="hljs-tag"> </span><span class="hljs-attr">...</span><span class="hljs-tag"> &gt;</span>
</code></pre>
      
    <p class="normal">Now, when a user is logged out, your toolbar should look clean, with no buttons, as shown here:</p>
    <figure class="mediaobject"><img src="../Images/B20960_06_02.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 6.2: The LemonMart toolbar before a user logs in</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">We can also swap out the generic <code class="inlineCode">account_circle</code> icon in the <code class="inlineCode">profile</code> button if the user has a picture:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/app.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> { </strong><strong class="hljs-title-slc">NgOptimizedImage</strong><strong class="hljs-slc"> } </strong><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">@angular/common'</strong></span>
<span class="hljs-attr">styles</span>: <span class="hljs-string">`</span>
<span class="hljs-string">  .image-cropper {</span>
<span class="hljs-string">    border-radius: 50%;</span>
<span class="hljs-string">  }</span>
<span class="hljs-string">`</span>,
<span class="hljs-attr">template</span>: <span class="hljs-string">`</span>
<span class="hljs-string">  ...</span>
<span class="hljs-string">  @if (auth?.status?.isAuthenticated) {</span>
<span class="hljs-string">    &lt;button mat-mini-fab routerLink="/user/profile" </span>
<span class="hljs-string">     matTooltip="Profile" aria-label="User Profile"&gt;</span>
<span class="hljs-string">    @if (auth?.user?.picture) {</span>
<span class="hljs-string">      &lt;img alt="Profile picture" class="image-cropper" </span>
<span class="hljs-string">           </span><span class="code-highlight"><strong class="hljs-string-slc">[ngSrc]="auth?.user?.picture ?? ''" </strong></span>
<span class="hljs-string">           width="40px" height="40px" fill /&gt;</span>
<span class="hljs-string">    }</span>
<span class="hljs-string">    @if (!auth?.user?.picture) {</span>
<span class="hljs-string">      &lt;mat-icon&gt;account_circle&lt;/mat-icon&gt;</span>
<span class="hljs-string">    }</span>
<span class="hljs-string">  &lt;/button&gt;</span>
<span class="hljs-string">}</span>
<span class="hljs-string">...</span>
<span class="hljs-string">`</span>
<span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-title">FlexModule</span>,
    <span class="hljs-title">RouterLink</span>,
    <span class="hljs-title">NavigationMenuComponent</span>,
    <span class="hljs-title">RouterOutlet</span>,
    <span class="hljs-title">AsyncPipe</span>,
    <span class="hljs-title">MatIconModule</span>,
    <span class="hljs-title">MatToolbarModule</span>,
    <span class="hljs-title">MatButtonModule</span>,
    <span class="hljs-title">MatSidenavModule</span>,
    <span class="hljs-title">NgOptimizedImage</span>,
  ],
</code></pre>
      </li>
    </ol>
    <div class="note">
      <p class="normal">Note the use of the <code class="inlineCode">ngSrc</code> attribute <a id="_idIndexMarker549"/>within the <code class="inlineCode">img</code> tag, which activates the <code class="inlineCode">NgOptimizedImage</code> directive. This directive makes it easy to adopt performance best practices for loading images. It has rich features to prioritize<a id="_idIndexMarker550"/> or delay the loading of certain images to assist in fast <strong class="keyWord">First Contentful Paint</strong> (<strong class="keyWord">FCP</strong>) scenarios, allow the use of CDNs, and enforce the use of <code class="inlineCode">width</code> and <code class="inlineCode">height</code> attributes to prevent layout shifts that can occur when an image loads. </p>
      <p class="normal">Read more<a id="_idIndexMarker551"/> about <code class="inlineCode">NgOptimizedImage</code> at <a href="https://angular.dev/guide/image-optimization"><span class="url">https://angular.dev/guide/image-optimization</span></a>.</p>
    </div>
    <p class="normal">We now have a highly functional<a id="_idIndexMarker552"/> toolbar that reacts to the auth status of the application and can also display information that belongs to the logged-in user.</p>
    <h2 id="_idParaDest-196" class="heading-2">Common validations for forms</h2>
    <p class="normal">Before we move on, we need<a id="_idIndexMarker553"/> to refactor the validations for <code class="inlineCode">LoginComponent</code>. As we implement more forms in <em class="chapterRef">Chapter 8</em>, <em class="italic">Recipes – Reusability, Forms, and Caching</em>, you will realize that it gets tedious very quickly to repeatedly type out form validations in either template or reactive forms. Part of the allure of reactive forms is that they are driven by code, so we can easily extract the validations to a shared class and unit test and reuse them, as follows:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Create a <code class="inlineCode">validations.ts</code> file under the <code class="inlineCode">common</code> folder.</li>
      <li class="numberedList">Implement the email and password validations:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/common/validations.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Validators</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/forms'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title">EmailValidation</span> = [
  <span class="hljs-title">Validators</span>.<span class="hljs-property">required</span>, <span class="hljs-title">Validators</span>.<span class="hljs-property">email</span>
]
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title">PasswordValidation</span> = [
  <span class="hljs-title">Validators</span>.<span class="hljs-property">required</span>,
  <span class="hljs-title">Validators</span>.<span class="hljs-title">minLength</span>(<span class="hljs-number">8</span>),
  <span class="hljs-title">Validators</span>.<span class="hljs-title">maxLength</span>(<span class="hljs-number">50</span>),
]
</code></pre>
      
    <div class="note">
      <p class="normal">Depending on your password validation needs, you can use a <code class="inlineCode">RegEx</code> pattern with the <code class="inlineCode">Validations.pattern()</code> function to enforce password complexity rules or leverage the OWASP <code class="inlineCode">npm</code> package, <code class="inlineCode">owasp-password-strength-test</code>, to enable passphrases, as well as set more flexible password requirements. See the link to the OWASP authentication general guidelines in the <em class="italic">Further reading</em> section.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Update the <code class="inlineCode">LoginComponent</code> with the new validations:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/login/login.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> {
  <span class="hljs-title">EmailValidation</span>, <span class="hljs-title">PasswordValidation</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/validations'</span>
...
<span class="hljs-variable">this</span>.<span class="hljs-property">loginForm</span> = <span class="hljs-variable">this</span>.<span class="hljs-property">formBuilder</span>.<span class="hljs-title">group</span>({
  <span class="hljs-attr">email</span>: [<span class="hljs-string">''</span>, <span class="hljs-title">EmailValidation</span>],
  <span class="hljs-attr">password</span>: [<span class="hljs-string">''</span>, <span class="hljs-title">PasswordValidation</span>],
})
</code></pre>
      </li>
    </ol>
    <p class="normal">Next, let’s encapsulate some common UI behavior in an Angular service.</p>
    <h2 id="_idParaDest-197" class="heading-2">UI service using environment provider</h2>
    <p class="normal">As we start dealing with complicated<a id="_idIndexMarker554"/> workflows, such as the auth <a id="_idIndexMarker555"/>workflow, it is important to be able to programmatically display a toast notification for the user. In other cases, we may want to ask for confirmation before executing a destructive action with a more intrusive pop-up notification.</p>
    <p class="normal">No matter what component library you use, it gets tedious to recode the same boilerplate just to display a quick notification. A UI service can neatly encapsulate a default implementation that can be customized.</p>
    <p class="normal">In the UI service, we will implement <code class="inlineCode">showToast</code> and <code class="inlineCode">showDialog</code> functions that can trigger notifications or prompt users for a decision, allowing us to use them within the code implementing the business logic.</p>
    <p class="normal">Let’s get started:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Create a new service named <code class="inlineCode">ui</code> under <code class="inlineCode">common</code>.</li>
      <li class="numberedList">Implement a <code class="inlineCode">showToast</code> function using <code class="inlineCode">MatSnackBar</code>:
    <div class="packt_tip">
      <p class="normal">Check out the<a id="_idIndexMarker556"/> documentation for <code class="inlineCode">MatSnackBar</code> at <a href="https://material.angular.io"><span class="url">https://material.angular.io</span></a>.</p>
    </div>
    <div class="note">
      <p class="normal">Since this service could be used by any service, component, or feature module, we can’t declare this service in a module context. Since our project is a standalone project, we instead need to implement an <strong class="keyWord">environment provider</strong> so that we can provide the service in the app context defined in <code class="inlineCode">app.config.ts</code>.</p>
    </div>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/common/ui.</strong><strong class="hljs-property-slc">service</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-meta">@Injectable</span>({
  <span class="hljs-attr">providedIn</span>: <span class="hljs-string">'root'</span>,
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UiService</span> {
  <span class="hljs-title">constructor</span>(
<span class="hljs-params">    </span><span class="hljs-keyword">private</span><span class="hljs-params"> </span><span class="hljs-attr">snackBar</span><span class="hljs-params">: </span><span class="hljs-title">MatSnackBar</span><span class="hljs-params">,</span>
<span class="hljs-params">    </span><span class="hljs-keyword">private</span><span class="hljs-params"> </span><span class="hljs-attr">dialog</span><span class="hljs-params">: </span><span class="hljs-title">MatDialog</span>
<span class="hljs-params">  </span>) {}
  <span class="hljs-title">showToast</span>(
    <span class="hljs-attr">message</span><span class="hljs-params">: </span><span class="hljs-built_in">string</span><span class="hljs-params">,</span>
<span class="hljs-params">    action = </span><span class="hljs-string">'Close'</span><span class="hljs-params">,</span>
<span class="hljs-params">    config?: </span><span class="hljs-title">MatSnackBarConfig</span>
) {
    <span class="hljs-variable">this</span>.<span class="hljs-property">snackBar</span>.<span class="hljs-title">open</span>(
      message,
      action,
      config || {
        <span class="hljs-attr">duration</span>: <span class="hljs-number">7000</span>,
      }
    )
  }
}
</code></pre>
    <p class="normal">For a <code class="inlineCode">showDialog</code> function using <code class="inlineCode">MatDialog</code>, we must implement a basic <code class="inlineCode">dialog</code> component.</p>
    <div class="packt_tip">
      <p class="normal">Check out the <a id="_idIndexMarker557"/>documentation for <code class="inlineCode">MatDialog</code> at <a href="https://material.angular.io"><span class="url">https://material.angular.io</span></a>.</p>
    </div></li>
    </ol>











    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Add a new component<a id="_idIndexMarker558"/> named <code class="inlineCode">simpleDialog</code> under<a id="_idIndexMarker559"/> the <code class="inlineCode">common</code> folder with inline templates and styling, skip testing, and a flat folder structure:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">app/common/simple-dialog.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Component</span>, <span class="hljs-title">Inject</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable">MAT_DIALOG_DATA</span>, <span class="hljs-title">MatDialogRef</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/material/dialog'</span>
<span class="hljs-meta">@Component</span>({
  <span class="hljs-comment">// prettier-ignore</span>
  <span class="hljs-attr">template</span>: <span class="hljs-string">`</span>
<span class="hljs-string">    &lt;h2 mat-dialog-title&gt;{{ data.title }}&lt;/h2&gt;</span>
<span class="hljs-string">    &lt;mat-dialog-content&gt;</span>
<span class="hljs-string">      &lt;p&gt;{{ data.content }}&lt;/p&gt;</span>
<span class="hljs-string">    &lt;/mat-dialog-content&gt;</span>
<span class="hljs-string">    &lt;mat-dialog-actions&gt;</span>
<span class="hljs-string">      &lt;span class="flex-spacer"&gt;&lt;/span&gt;</span>
<span class="hljs-string">      @if (data.cancelText) {</span>
<span class="hljs-string">        &lt;button mat-button mat-dialog-close&gt;</span>
<span class="hljs-string">          {{ data.cancelText }}</span>
<span class="hljs-string">        &lt;/button&gt;</span>
<span class="hljs-string">      }</span>
<span class="hljs-string">      &lt;button mat-button mat-button-raised color="primary"</span>
<span class="hljs-string">        [mat-dialog-close]="true" cdkFocusInitial&gt;</span>
<span class="hljs-string">        {{ data.okText }}</span>
<span class="hljs-string">      &lt;/button&gt;</span>
<span class="hljs-string">    &lt;/mat-dialog-actions&gt;</span>
<span class="hljs-string">  `</span>,
  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">imports</span>: [<span class="hljs-title">MatDialogModule</span>, <span class="hljs-title">MatButtonModule</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SimpleDialogComponent</span> {
  <span class="hljs-title">constructor</span>(
<span class="hljs-params">    </span><span class="hljs-keyword">public</span><span class="hljs-params"> </span><span class="hljs-attr">dialogRef</span><span class="hljs-params">: </span><span class="hljs-title">MatDialogRef</span><span class="hljs-params">&lt;</span><span class="hljs-title">SimpleDialogComponent</span><span class="hljs-params">, </span><span class="hljs-built_in">boolean</span><span class="hljs-params">&gt;,</span>
<span class="hljs-params">    </span><span class="hljs-meta">@Inject</span><span class="hljs-params">(MAT_DIALOG_DATA)</span>
<span class="hljs-params">    </span><span class="hljs-keyword">public</span><span class="hljs-params"> </span><span class="hljs-attr">data</span><span class="hljs-params">: {</span>
<span class="hljs-params">      title: </span><span class="hljs-built_in">string</span><span class="hljs-params">;</span>
<span class="hljs-params">      content: </span><span class="hljs-built_in">string</span><span class="hljs-params">;</span>
<span class="hljs-params">      okText: </span><span class="hljs-built_in">string</span><span class="hljs-params">;</span>
<span class="hljs-params">      cancelText: </span><span class="hljs-built_in">string</span>
<span class="hljs-params">    }</span>
<span class="hljs-params">  </span>) {}
}
</code></pre>
     
    <div class="note">
      <p class="normal"><code class="inlineCode">SimpleDialogComponent</code> should not have an application selector like <code class="inlineCode">selector: 'app-simple-dialog'</code>, since we only plan to use it with <code class="inlineCode">UiService</code>. If auto-generated, remove this property from your component.</p>
    </div> </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Now, implement a <code class="inlineCode">showDialog</code> function <a id="_idIndexMarker560"/>using <code class="inlineCode">MatDialog</code> to display<a id="_idIndexMarker561"/> the <code class="inlineCode">SimpleDialogComponent</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">app/common/ui.</strong><strong class="hljs-property-slc">service</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
<span class="hljs-title">showDialog</span>(
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>,
  <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>,
  okText = <span class="hljs-string">'OK'</span>,
  cancelText?: <span class="hljs-built_in">string</span>,
  customConfig?: <span class="hljs-title">MatDialogConfig</span>
): <span class="hljs-title">Observable</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {
  <span class="hljs-keyword">const</span> dialogRef = <span class="hljs-variable">this</span>.<span class="hljs-property">dialog</span>.<span class="hljs-title">open</span>(
    <span class="hljs-title">SimpleDialogComponent</span>,
    customConfig || {
      <span class="hljs-attr">width</span>: <span class="hljs-string">'300px'</span>,
      <span class="hljs-attr">data</span>: { title, content, okText, cancelText },
    }
  )
  <span class="hljs-keyword">return</span> dialogRef.<span class="hljs-title">afterClosed</span>()
}
</code></pre>
      
    <p class="normal"><code class="inlineCode">ShowDialog</code> returns an <code class="inlineCode">Observable&lt;boolean&gt;</code>, so you can implement a follow-on action depending on what selection the user makes. Clicking on <strong class="keyWord">OK</strong> will return <code class="inlineCode">true</code>, and <strong class="keyWord">Cancel</strong> will return <code class="inlineCode">false</code>.</p>
    <p class="normal">In <code class="inlineCode">SimpleDialogComponent</code>, using <code class="inlineCode">@Inject</code>, we can use all variables sent by <code class="inlineCode">showDialog</code> to customize the content of the dialog.</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Add a function<a id="_idIndexMarker562"/> named <code class="inlineCode">provideUiService</code> as an environment provider<a id="_idIndexMarker563"/> at the bottom of <code class="inlineCode">UiService</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">app/common/ui.</strong><strong class="hljs-property-slc">service</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { importProvidersFrom, makeEnvironmentProviders } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title">provideUiService</span>() {
  <span class="hljs-keyword">return</span> <span class="hljs-title">makeEnvironmentProviders</span>([
    importProvidersFrom(<span class="hljs-title">MatDialogModule</span>, <span class="hljs-title">MatSnackBarModule</span>),
  ])
}
</code></pre>
      
    <div class="note">
      <p class="normal"><code class="inlineCode">makeEnvironmentProviders</code> allows us to wrap the dependencies of <code class="inlineCode">Service</code> in an encapsulated object. This way, we don’t expose these dependencies to the component using the service. This helps us enforce a decoupled architecture.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">In <code class="inlineCode">app.config.ts</code>, add <code class="inlineCode">provideUiService()</code> to the <code class="inlineCode">providers</code> array:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/app.</strong><strong class="hljs-property-slc">config</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">appConfig</span>: <span class="hljs-title">ApplicationConfig</span> = {
  <span class="hljs-attr">providers</span>: [
    ...
    <span class="hljs-title">provideUiService</span>()
  ]
}
</code></pre>
      </li>
      <li class="numberedList">Update the <code class="inlineCode">login()</code> function on the <code class="inlineCode">LoginComponent</code> to display a toast message after login:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/login/login.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">UiService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/ui.service'</span>
...
  <span class="code-highlight"><strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">readonly</strong><strong class="hljs-slc"> uiService = </strong><strong class="hljs-title-slc">inject</strong><strong class="hljs-slc">(</strong><strong class="hljs-title-slc">UiService</strong><strong class="hljs-slc">) </strong></span>
  ...
  <span class="hljs-keyword">async</span> <span class="hljs-title">login</span>(<span class="hljs-attr">submittedForm</span><span class="hljs-params">: </span><span class="hljs-title">FormGroup</span>) {
    ...
    <span class="hljs-title">tap</span>(<span class="hljs-function">(</span><span class="hljs-params">[authStatus, user]</span><span class="hljs-function">) =&gt;</span> {
      <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">uiService</strong><strong class="hljs-slc">.</strong><strong class="hljs-title-slc">showToast</strong><strong class="hljs-slc">(</strong></span>
        <span class="code-highlight"><strong class="hljs-string-slc">`Welcome </strong><strong class="hljs-subst-slc">${user.fullName}</strong><strong class="hljs-string-slc">! Role: </strong><strong class="hljs-subst-slc">${user.role}</strong><strong class="hljs-string-slc">`</strong></span>
      )
      ...
    })
 ...
</code></pre>
      
    <p class="normal">Now, a toast message<a id="_idIndexMarker564"/> will appear after a user <a id="_idIndexMarker565"/>has logged in, as shown here:</p>
    <figure class="mediaobject"><img src="../Images/B20960_06_03.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 6.3: Material snackbar</p>
    <div class="packt_tip">
      <p class="normal">The <code class="inlineCode">snackBar</code> will either take up the full width of the screen or a portion, depending on the size of the browser.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="8">Experiment with displaying a dialog instead:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/login/login.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-variable">this</span>.<span class="hljs-property">uiService</span>.<span class="hljs-title">showDialog</span>(
  <span class="hljs-string">`Welcome </span><span class="hljs-subst">${user.fullName}</span><span class="hljs-string">!`</span>, <span class="hljs-string">`Role: </span><span class="hljs-subst">${user.role}</span><span class="hljs-string">`</span>
)
</code></pre>
      </li>
    </ol>
    <p class="normal">Now that you’ve verified that both <code class="inlineCode">showToast</code> and <code class="inlineCode">showDialog</code> work, which do you prefer? </p>
    <div class="packt_tip">
      <p class="normal">My rule of thumb between choosing a toast message or a dialog box is that unless the user is about to take an irreversible action, you should choose toast messages over dialogs so that you don’t interrupt the user’s workflow.</p>
    </div>
    <p class="normal">Next, let’s implement<a id="_idIndexMarker566"/> an application-wide side navigation<a id="_idIndexMarker567"/> experience as an alternative to the toolbar-based navigation we already have so that users can switch between modules with ease.</p>
    <h2 id="_idParaDest-198" class="heading-2">Side navigation</h2>
    <p class="normal">To enhance the user experience, it is essential<a id="_idIndexMarker568"/> to enable mobile-first workflows and offer an intuitive navigation mechanism that allows users to access their desired functionality quickly. A side navigation (<code class="inlineCode">SideNav</code>) bar serves mobile and desktop users equally well. On mobile screens, it can be activated by a triple dash (hamburger) menu, and on a large screen, it can be locked open. To further optimize the experience, we should only show the links a user is authorized to view. We can do this by utilizing the <code class="inlineCode">AuthenticationService</code> based on the user’s current role. We will implement the side navigation mock-up as follows:</p>
    <figure class="mediaobject"><img src="../Images/B20960_06_04.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 6.4: Side navigation mock-up</p>
    <p class="normal">Let’s implement the code for the side navigation<a id="_idIndexMarker569"/> as a separate component so that it is easier to maintain:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the application’s root, create a <code class="inlineCode">NavigationMenu</code> component with inline templates and styles.
    <div class="packt_tip">
      <p class="normal">The side navigation isn’t technically required until after a user is logged in. However, to be able to launch the side navigation menu from the toolbar, we need to be able to trigger it from <code class="inlineCode">AppComponent</code>. Since this component will be simple, we will eagerly load it. To do this lazily, Angular does have a Dynamic Component Loader pattern, which has a high implementation overhead that will only make sense if multi-hundred-KB savings are made.</p>
    </div>
    <p class="normal"><code class="inlineCode">SideNav</code> will be triggered from the toolbar, and it comes with a <code class="inlineCode">&lt;mat-sidenav-container&gt;</code> parent container that hosts the <code class="inlineCode">SideNav</code> itself and the application’s content. So we must render all application content by placing the <code class="inlineCode">&lt;router-outlet&gt;</code> inside <code class="inlineCode">&lt;mat-sidenav-content&gt;</code>.</p></li>
    </ol>




    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">In <code class="inlineCode">AppComponent</code>, define some styles that will ensure that the web application will expand to fill the entire page and remain properly scrollable for desktop and mobile scenarios:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/app.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-attr">styles</span>: <span class="hljs-string">`</span>
<span class="hljs-string">    .app-container {</span>
<span class="hljs-string">      display: flex;</span>
<span class="hljs-string">      flex-direction: column;</span>
<span class="hljs-string">      position: absolute;</span>
<span class="hljs-string">      top: 0;</span>
<span class="hljs-string">      bottom: 0;</span>
<span class="hljs-string">      left: 0;</span>
<span class="hljs-string">      right: 0;</span>
<span class="hljs-string">    }</span>
<span class="hljs-string">    .app-is-mobile .app-toolbar {</span>
<span class="hljs-string">      position: fixed;</span>
<span class="hljs-string">      z-index: 2;</span>
<span class="hljs-string">    }</span>
<span class="hljs-string">    .app-sidenav-container {</span>
<span class="hljs-string">      flex: 1;</span>
<span class="hljs-string">    }</span>
<span class="hljs-string">    .app-is-mobile .app-sidenav-container {</span>
<span class="hljs-string">      flex: 1 0 auto;</span>
<span class="hljs-string">    }</span>
<span class="hljs-string">    mat-sidenav {</span>
<span class="hljs-string">      width: 200px;</span>
<span class="hljs-string">    }</span>
<span class="hljs-string">    .image-cropper {</span>
<span class="hljs-string">      border-radius: 50%;</span>
<span class="hljs-string">    }</span>
<span class="hljs-string">  `</span>,
</code></pre>
      </li>
      <li class="numberedList">Inject the <code class="inlineCode">MediaObserver</code> service<a id="_idIndexMarker570"/> from Angular Flex Layout in <code class="inlineCode">AppComponent</code>. Also, implement <code class="inlineCode">OnInit</code>, inject <code class="inlineCode">DestroyRef</code>, and add a Boolean property named <code class="inlineCode">opened</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/app.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">MediaObserver</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ngbracket/ngx-layout '</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AppComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OnInit</span> {
  <span class="code-highlight"><strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> destroyRef = </strong><strong class="hljs-title-slc">inject</strong><strong class="hljs-slc">(</strong><strong class="hljs-title-slc">DestroyRef</strong><strong class="hljs-slc">)</strong></span>
  <span class="code-highlight"><strong class="hljs-attr-slc">opened</strong><strong class="hljs-slc">: </strong><strong class="hljs-built_in-slc">boolean</strong></span>
  <span class="hljs-title">constructor</span>(
<span class="hljs-params">    ...</span>
    <span class="code-highlight"><strong class="hljs-keyword-slc">public</strong><strong class="hljs-params-slc"> </strong><strong class="hljs-attr-slc">media</strong><strong class="hljs-params-slc">: </strong><strong class="hljs-title-slc">MediaObserver</strong></span>
<span class="hljs-params">  </span>) {
  ...
  }
  <span class="hljs-title">ngOnInit</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title">Error</span>(<span class="hljs-string">'Method not implemented.'</span>)
  }
}
</code></pre>
      
    <p class="normal">To automatically determine<a id="_idIndexMarker571"/> the open/closed status of the side navigation, we need to monitor the media observer and the auth status. When the user logs in, we would like to show the side navigation and hide it when the user logs out. We can do this by assigning <code class="inlineCode">opened</code> to the value of <code class="inlineCode">authStatus$.isAuthenticated</code>. However, if we only consider <code class="inlineCode">isAuthenticated</code>, and the user is on a mobile device, we will create a less-than-ideal UX. Watching for the media observer’s <code class="inlineCode">mediaValue</code>, we can check whether the screen size is set to extra small or <code class="inlineCode">xs</code>; if so, we can keep the side navigation closed.</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Update <code class="inlineCode">ngOnInit</code> to implement the dynamic side navigation open/closed logic:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/app.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
  <span class="hljs-title">ngOnInit</span>() {
    <span class="hljs-title">combineLatest</span>([
      <span class="hljs-variable">this</span>.<span class="hljs-property">media</span>.<span class="hljs-title">asObservable</span>(),
      <span class="hljs-variable">this</span>.<span class="hljs-property">authService</span>.<span class="hljs-property">authStatus$</span>,
    ])
      .<span class="hljs-title">pipe</span>(
        <span class="hljs-title">tap</span>(<span class="hljs-function">(</span><span class="hljs-params">[mediaValue, authStatus]</span><span class="hljs-function">) =&gt;</span> {
          <span class="hljs-keyword">if</span> (!authStatus?.<span class="hljs-property">isAuthenticated</span>) {
            <span class="hljs-variable">this</span>.<span class="hljs-property">opened</span> = <span class="hljs-literal">false</span>
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (mediaValue[<span class="hljs-number">0</span>].<span class="hljs-property">mqAlias</span> === <span class="hljs-string">'xs'</span>) {
              <span class="hljs-variable">this</span>.<span class="hljs-property">opened</span> = <span class="hljs-literal">false</span>
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-variable">this</span>.<span class="hljs-property">opened</span> = <span class="hljs-literal">true</span>
            }
          }
        }),
        <span class="hljs-title">takeUntilDestroyed</span>(<span class="hljs-variable">this</span>.destroyRef)
      )
      .<span class="hljs-title">subscribe</span>()
  }
</code></pre>
      
    <p class="normal">By monitoring the media and <code class="inlineCode">authStatus$</code> streams, we can consider unauthenticated scenarios where the side navigation should not be opened even if there’s enough screen space. We also use <code class="inlineCode">takeUntilDestroyed</code> so that our resources can be cleaned up.</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Update the template with<a id="_idIndexMarker572"/> a responsive <code class="inlineCode">SideNav</code> that will slide over the content in mobile or push the content aside in desktop scenarios:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/app.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
<span class="hljs-comment">// prettier-ignore</span>
<span class="hljs-attr">template</span>: <span class="hljs-string">`</span>
  <span class="code-highlight"><strong class="hljs-string-slc">&lt;div class="app-container"&gt;</strong></span>
<span class="hljs-string">      @if (</span>
<span class="hljs-string">        {</span>
<span class="hljs-string">          status: authService.authStatus$ | async,</span>
<span class="hljs-string">          user: authService.currentUser$ | async</span>
<span class="hljs-string">        };</span>
<span class="hljs-string">        as auth;</span>
<span class="hljs-string">      ) {</span>
<span class="hljs-string">        &lt;mat-toolbar color="primary" fxLayoutGap="8px" </span>
<span class="hljs-string">         </span><span class="code-highlight"><strong class="hljs-string-slc">class="app-toolbar" </strong></span>
<span class="hljs-string">         </span><span class="code-highlight"><strong class="hljs-string-slc">[class.app-is-mobile]="media.isActive('xs')"</strong></span>
<span class="hljs-string">          &gt;</span>
<span class="hljs-string">          @if (auth?.status?.isAuthenticated) {</span>
<span class="hljs-string">            &lt;button mat-icon-button </span>
<span class="hljs-string">              </span><span class="code-highlight"><strong class="hljs-string-slc">(click)="sidenav.toggle()"&gt;</strong></span>
<span class="hljs-string">              &lt;mat-icon&gt;menu&lt;/mat-icon&gt;</span>
<span class="hljs-string">            &lt;/button&gt;</span>
<span class="hljs-string">          }</span>
<span class="hljs-string">    ...</span>
<span class="hljs-string">  &lt;/mat-toolbar&gt;</span>
<span class="hljs-string">  &lt;mat-sidenav-container class="app-sidenav-container"&gt;</span>
<span class="hljs-string">    &lt;mat-sidenav #sidenav</span>
<span class="hljs-string">      [mode]="media.isActive('xs') ? 'over' : 'side'"</span>
<span class="hljs-string">      [fixedInViewport]="media.isActive('xs')"</span>
<span class="hljs-string">      fixedTopGap="56" [(opened)]="opened"</span>
<span class="hljs-string">    &gt;</span>
<span class="hljs-string">      &lt;app-navigation-menu&gt;&lt;/app-navigation-menu&gt;</span>
<span class="hljs-string">    &lt;/mat-sidenav&gt;</span>
<span class="hljs-string">    &lt;mat-sidenav-content&gt;</span>
<span class="hljs-string">      &lt;router-outlet&gt;&lt;/router-outlet&gt;</span>
<span class="hljs-string">    &lt;/mat-sidenav-content&gt;</span>
<span class="hljs-string">  &lt;/mat-sidenav-container&gt;</span>
<span class="hljs-string">  &lt;/div&gt;</span>
<span class="hljs-string">`</span>,
</code></pre>
        <div class="note">
          <p class="normal">The preceding template leverages the media observer in <code class="inlineCode">@ngbracket/ngx-layout</code>, a community clone of the deprecated Angular Flex Layout library. We injected <code class="inlineCode">ngx-layout</code> earlier for a responsive implementation.</p>
        </div>
      
    <div class="packt_tip">
      <p class="normal">You can use the <code class="inlineCode">// prettier-ignore</code> directive above your template to prevent Prettier from breaking up your template into too many lines, which can hurt readability in certain conditions like this one.</p>
    </div>
    <p class="normal">We will implement navigational links<a id="_idIndexMarker573"/> in <code class="inlineCode">NavigationMenuComponent</code>. The number of links in our application will likely grow over time and be subject to various role-based business rules. Therefore, if we were to implement these links in <code class="inlineCode">app.component.ts</code>, we would risk that file getting too large. In addition, we don’t want <code class="inlineCode">app.component.ts</code> to change very often since changes made there can impact the entire application. It is a good practice to implement the links in a separate component.</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">Implement navigational links in <code class="inlineCode">NavigationMenuComponent</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/navigation-menu/navigation-menu.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
  <span class="hljs-attr">styles</span>: <span class="hljs-string">`</span>
<span class="hljs-string">      .active-link {</span>
<span class="hljs-string">        font-weight: bold;</span>
<span class="hljs-string">        border-left: 3px solid green;</span>
<span class="hljs-string">      }</span>
<span class="hljs-string">      .mat-mdc-subheader {        font-weight: bold;      }</span>
<span class="hljs-string">  `</span>,
  <span class="hljs-attr">template</span>: <span class="hljs-string">`</span>
<span class="hljs-string">    &lt;mat-nav-list&gt;</span>
<span class="hljs-string">      &lt;h3 matSubheader&gt;Manager&lt;/h3&gt;</span>
<span class="hljs-string">      &lt;a mat-list-item</span>
<span class="hljs-string">        routerLinkActive="active-link"</span>
<span class="hljs-string">        routerLink="/manager/users"&gt;</span>
<span class="hljs-string">          Users</span>
<span class="hljs-string">      &lt;/a&gt;</span>
<span class="hljs-string">      &lt;a mat-list-item</span>
<span class="hljs-string">        routerLinkActive="active-link"</span>
<span class="hljs-string">        routerLink="/manager/receipts"&gt;</span>
<span class="hljs-string">          Receipts</span>
<span class="hljs-string">      &lt;/a&gt;</span>
<span class="hljs-string">      &lt;h3 matSubheader&gt;Inventory&lt;/h3&gt;</span>
<span class="hljs-string">      &lt;a mat-list-item</span>
<span class="hljs-string">        routerLinkActive="active-link"</span>
<span class="hljs-string">        routerLink="/inventory/stockEntry"&gt;</span>
<span class="hljs-string">          Stock Entry</span>
<span class="hljs-string">      &lt;/a&gt;</span>
<span class="hljs-string">      &lt;a mat-list-item</span>
<span class="hljs-string">        routerLinkActive="active-link"</span>
<span class="hljs-string">        routerLink="/inventory/products"&gt;</span>
<span class="hljs-string">          Products</span>
<span class="hljs-string">      &lt;/a&gt;</span>
<span class="hljs-string">      &lt;a mat-list-item</span>
<span class="hljs-string">        routerLinkActive="active-link"</span>
<span class="hljs-string">        routerLink="/inventory/categories"&gt;</span>
<span class="hljs-string">          Categories</span>
<span class="hljs-string">      &lt;/a&gt;</span>
<span class="hljs-string">      &lt;h3 matSubheader&gt;Clerk&lt;/h3&gt;</span>
<span class="hljs-string">      &lt;a mat-list-item</span>
<span class="hljs-string">        routerLinkActive="active-link"</span>
<span class="hljs-string">        routerLink="/pos"&gt;</span>
<span class="hljs-string">          POS</span>
<span class="hljs-string">      &lt;/a&gt;</span>
<span class="hljs-string">    &lt;/mat-nav-list&gt;</span>
<span class="hljs-string">  `</span>,
  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">imports</span>: [<span class="hljs-title">MatListModule</span>, <span class="hljs-title">RouterLinkActive</span>, <span class="hljs-title">RouterLink</span>],
...
</code></pre>
      
    <p class="normal"><code class="inlineCode">&lt;mat-nav-list&gt;</code> is functionally <a id="_idIndexMarker574"/>equivalent to <code class="inlineCode">&lt;mat-list&gt;</code>, so you can use the documentation of <code class="inlineCode">MatList</code> for layout purposes. Observe the <code class="inlineCode">subheaders</code> for <strong class="screenText">Manager</strong>, <strong class="screenText">Inventory</strong>, and <strong class="screenText">Clerk</strong> here:</p>
    <figure class="mediaobject"><img src="../Images/B20960_06_05.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 6.5: The Manager dashboard showing Receipt Lookup on a desktop</p>
    <p class="normal"><code class="inlineCode">routerLinkActive="active-link"</code> highlights<a id="_idIndexMarker575"/> the selected <strong class="screenText">Receipts</strong> route, as shown in the preceding screenshot.</p>
    <div class="note">
      <p class="normal">Angular Router keeps track of the state of navigation in the app. Based on which link is active, it automatically assigns the appropriate CSS so it can be highlighted as the active one.</p>
      <p class="normal">You can read more<a id="_idIndexMarker576"/> about the router at <a href="https://angular.dev/guide/routing/router-reference"><span class="url">https://angular.dev/guide/routing/router-reference</span></a>.</p>
    </div>
    <p class="normal">Additionally, you can see the difference in appearance and behavior on mobile devices as follows:</p>
    <figure class="mediaobject"><img src="../Images/B20960_06_06.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 6.6: The Manager dashboard showing Receipt Lookup on a mobile</p>
</li>
    </ol>




    <p class="normal">Next, let’s implement role-based routing.</p>
    <h1 id="_idParaDest-199" class="heading-1">Role-based routing using guards</h1>
    <p class="normal">This is the most elemental <a id="_idIndexMarker577"/>and important<a id="_idIndexMarker578"/> part of your application. With lazy loading, we have ensured that only the bare minimum number of assets will be loaded to enable a user to log in.</p>
    <p class="normal">Once a user logs in, they should be routed to the appropriate landing screen as per their user role, so they’re not guessing how they need to use the application. For example, a cashier only needs access to the <strong class="keyWord">point of sale (POS)</strong> screen so that they can check out customers. In this case, cashiers can automatically be routed to that screen.</p>
    <p class="normal">The following is a mock-up of the POS screen:</p>
    <figure class="mediaobject"><img src="../Images/B20960_06_07.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 6.7: A POS screen mock-up</p>
    <p class="normal">Let’s ensure users get<a id="_idIndexMarker579"/> routed to the appropriate<a id="_idIndexMarker580"/> page after logging in by updating the <code class="inlineCode">LoginComponent</code>.</p>
    <p class="normal">Update the <code class="inlineCode">login</code> logic to each route per role in the function named <code class="inlineCode">homeRoutePerRole</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">app/src/login/login.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">async</span> <span class="hljs-title">login</span>(<span class="hljs-attr">submittedForm</span><span class="hljs-params">: </span><span class="hljs-title">FormGroup</span>) {
  ...
    <span class="hljs-variable">this</span>.<span class="hljs-property">router</span>.<span class="hljs-title">navigate</span>([
      <span class="hljs-variable">this</span>.<span class="hljs-property">redirectUrl</span> ||
      <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-title-slc">homeRoutePerRole</strong><strong class="hljs-slc">(user.</strong><strong class="hljs-property-slc">role</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">as</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Role</strong><strong class="hljs-slc">)</strong></span>
    <span class="code-highlight"><strong class="hljs-slc">])</strong></span>
  <span class="code-highlight"><strong class="hljs-slc">...</strong></span>
<span class="code-highlight"><strong class="hljs-slc">}</strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">homeRoutePerRole</strong><strong class="hljs-slc">(</strong><strong class="hljs-attr-slc">role</strong><strong class="hljs-params-slc">: </strong><strong class="hljs-title-slc">Role</strong><strong class="hljs-slc">) {</strong></span>
  <span class="code-highlight"><strong class="hljs-keyword-slc">switch</strong><strong class="hljs-slc"> (role) {</strong></span>
    <span class="code-highlight"><strong class="hljs-keyword-slc">case</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Role</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">Cashier</strong><strong class="hljs-slc">:</strong></span>
      <span class="code-highlight"><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'/pos'</strong></span>
    <span class="code-highlight"><strong class="hljs-keyword-slc">case</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Role</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">Clerk</strong><strong class="hljs-slc">:</strong></span>
      <span class="code-highlight"><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'/inventory'</strong></span>
    <span class="code-highlight"><strong class="hljs-keyword-slc">case</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Role</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">Manager</strong><strong class="hljs-slc">:</strong></span>
      <span class="code-highlight"><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'/manager'</strong></span>
    <span class="code-highlight"><strong class="hljs-attr-slc">default</strong><strong class="hljs-slc">:</strong></span>
      <span class="code-highlight"><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'/user/profile'</strong></span>
  <span class="code-highlight"><strong class="hljs-slc">}</strong></span>
<span class="code-highlight"><strong class="hljs-slc">}</strong></span>
</code></pre>
    <p class="normal">Similarly, clerks and managers are routed to their landing screens to access the features they need to accomplish their tasks, as shown earlier. Since we have implemented a default manager role, the corresponding landing experience will be launched automatically.</p>
    <p class="normal">In the next section, you will learn<a id="_idIndexMarker581"/> about route guards, which help check<a id="_idIndexMarker582"/> for user authentication and can even load requisite data before a form is rendered. This is crucial in preventing unintentional access to routes that users should not have access to and deterring intentional attempts to breach these restrictions.</p>
    <h2 id="_idParaDest-200" class="heading-2">Route guards</h2>
    <p class="normal">Route guards enable the further decoupling<a id="_idIndexMarker583"/> and reuse of logic and greater control over the component life cycle.</p>
    <p class="normal">Here are the four major guards you will most likely use:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">canActivate</code> and <code class="inlineCode">canActivateChild</code>: Used for checking auth access to a route</li>
      <li class="bulletList"><code class="inlineCode">canDeactivate</code>: Used to ask permission before navigating away from a route</li>
      <li class="bulletList"><code class="inlineCode">Resolve</code>: Allows the pre-fetching of data from route parameters</li>
      <li class="bulletList"><code class="inlineCode">CanLoad</code>: Allows custom logic to execute before loading feature module assets</li>
    </ul>
    <p class="normal">Refer to the following sections to discover how to leverage <code class="inlineCode">canActivate</code> and <code class="inlineCode">canLoad</code>. The <code class="inlineCode">Resolve</code> guard will be covered in <em class="chapterRef">Chapter 8</em>, <em class="italic">Recipes – Reusability, Forms, and Caching</em>.</p>
    <h2 id="_idParaDest-201" class="heading-2">Auth guards</h2>
    <p class="normal">Auth guards enable a good UX by allowing<a id="_idIndexMarker584"/> or disallowing accidental navigation to a feature module or a component before the module has loaded, or before any improper data requests have been made to the server. For example, when a manager logs in, they’re automatically routed to the <code class="inlineCode">/manager/home</code> path. The browser will cache this URL, and it would be completely plausible for a clerk to accidentally navigate to the same URL. Angular doesn’t know whether a particular route is accessible to a user. Without an <code class="inlineCode">authGuard</code>, it will happily render the manager’s home page and trigger server requests that will fail.</p>
    <div class="note">
      <p class="normal">Regardless of the robustness of your frontend implementation, every REST or GraphQL API you implement<a id="_idIndexMarker585"/> should also be properly secured with <strong class="keyWord">Role-based Access Control</strong> (<strong class="keyWord">RBAC</strong>) on the server side.</p>
    </div>
    <p class="normal">Let’s update the router so that <code class="inlineCode">ProfileComponent</code> can’t be activated without an authenticated user, and the <code class="inlineCode">ManagerModule</code> won’t load unless a manager logs in using an <code class="inlineCode">authGuard</code>:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Implement a functional <code class="inlineCode">AuthGuard</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/auth/auth.</strong><strong class="hljs-property-slc">guard</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title">authGuard</span> = (<span class="hljs-params">route?: </span><span class="hljs-title">ActivatedRouteSnapshot</span>) =&gt; {
  <span class="hljs-keyword">const</span> authService = <span class="hljs-title">inject</span>(<span class="hljs-title">AuthService</span>)
  <span class="hljs-keyword">const</span> router = <span class="hljs-title">inject</span>(<span class="hljs-title">Router</span>)
  <span class="hljs-keyword">const</span> uiService = <span class="hljs-title">inject</span>(<span class="hljs-title">UiService</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-title">checkLogin</span>(authService, router, uiService, route)
}
</code></pre>
     
    <div class="note">
      <p class="normal">Note that all dependencies are being injected inline, using the inject function, which allows dependency injection outside of just the constructor of an <code class="inlineCode">@Injectable</code> class, in this case, a function.</p>
    </div>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">function</span> <span class="hljs-title">checkLogin</span>(
<span class="hljs-params">  </span><span class="hljs-attr">authService</span><span class="hljs-params">: </span><span class="hljs-title">AuthService</span><span class="hljs-params">,</span>
<span class="hljs-params">  </span><span class="hljs-attr">router</span><span class="hljs-params">: </span><span class="hljs-title">Router</span><span class="hljs-params">,</span>
<span class="hljs-params">  </span><span class="hljs-attr">uiService</span><span class="hljs-params">: </span><span class="hljs-title">UiService</span><span class="hljs-params">,</span>
<span class="hljs-params">  route?: </span><span class="hljs-title">ActivatedRouteSnapshot</span>
): <span class="hljs-title">Observable</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {
  <span class="hljs-keyword">return</span> authService.<span class="hljs-property">authStatus$</span>.<span class="hljs-title">pipe</span>(
    <span class="hljs-title">map</span>(<span class="hljs-function">(</span><span class="hljs-params">authStatus</span><span class="hljs-function">) =&gt;</span> {
      <span class="hljs-keyword">const</span> roleMatch = <span class="hljs-title">checkRoleMatch</span>(authStatus.<span class="hljs-property">userRole</span>, route)
      <span class="hljs-keyword">const</span> allowLogin = authStatus.<span class="hljs-property">isAuthenticated</span> &amp;&amp; roleMatch
      <span class="hljs-keyword">if</span> (!allowLogin) {
        <span class="hljs-title">showAlert</span>(uiService, authStatus.<span class="hljs-property">isAuthenticated</span>, roleMatch)
        router.<span class="hljs-title">navigate</span>([<span class="hljs-string">'login'</span>], {
          <span class="hljs-attr">queryParams</span>: {
            <span class="hljs-attr">redirectUrl</span>: router?.<span class="hljs-title">getCurrentNavigation</span>()?
                         .<span class="hljs-property">initialUrl</span>.<span class="hljs-title">toString</span>(),
          },
        })
      }
      <span class="hljs-keyword">return</span> allowLogin
    }),
    <span class="hljs-title">take</span>(<span class="hljs-number">1</span>) <span class="hljs-comment">// the observable must complete for the guard to work</span>
  )
}
<span class="hljs-keyword">function</span> <span class="hljs-title">checkRoleMatch</span>(<span class="hljs-attr">role</span><span class="hljs-params">: </span><span class="hljs-title">Role</span><span class="hljs-params">, route?: </span><span class="hljs-title">ActivatedRouteSnapshot</span>) {
  <span class="hljs-keyword">if</span> (!route?.<span class="hljs-property">data</span>?.[<span class="hljs-string">'expectedRole'</span>]) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  }
  <span class="hljs-keyword">return</span> role === route.<span class="hljs-property">data</span>[<span class="hljs-string">'expectedRole'</span>]
}
<span class="hljs-keyword">function</span> <span class="hljs-title">showAlert</span>(
  <span class="hljs-attr">uiService</span><span class="hljs-params">: </span><span class="hljs-title">UiService</span><span class="hljs-params">,</span>
<span class="hljs-params">  </span><span class="hljs-attr">isAuth</span><span class="hljs-params">: </span><span class="hljs-built_in">boolean</span><span class="hljs-params">,</span>
<span class="hljs-params">  </span><span class="hljs-attr">roleMatch</span><span class="hljs-params">: </span><span class="hljs-built_in">boolean</span>
) {
  <span class="hljs-keyword">if</span> (!isAuth) {
    uiService.<span class="hljs-title">showToast</span>(<span class="hljs-string">'You must login to continue'</span>)
  }
  <span class="hljs-keyword">if</span> (!roleMatch) {
    uiService.<span class="hljs-title">showToast</span>(
      <span class="hljs-string">'You do not have the permissions to view this resource'</span>
<span class="hljs-string">    </span>)
  }
}
</code></pre> </li>
    </ol>



    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">Use the <code class="inlineCode">c</code><code class="inlineCode">anLoad</code> guard to prevent the loading of a lazily loaded module, such as the <code class="inlineCode">manager's</code> module:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/app.</strong><strong class="hljs-property-slc">routes</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> { authGuard } </strong><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'./auth/auth.guard'</strong></span>
...
{
  <span class="hljs-attr">path</span>: <span class="hljs-string">'manager'</span>,
  <span class="hljs-attr">loadChildren</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./manager/manager.module'</span>)
    .<span class="hljs-title">then</span>(<span class="hljs-function">(</span><span class="hljs-params">m</span><span class="hljs-function">) =&gt;</span> m.<span class="hljs-property">ManagerModule</span>), 
  <span class="code-highlight"><strong class="hljs-attr-slc">canLoad</strong><strong class="hljs-slc">: [authGuard],</strong></span>
  <span class="code-highlight"><strong class="hljs-attr-slc">data</strong><strong class="hljs-slc">: { </strong><strong class="hljs-attr-slc">expectedRole</strong><strong class="hljs-slc">: </strong><strong class="hljs-title-slc">Role</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">Manager</strong><strong class="hljs-slc"> },</strong></span>
},
...
</code></pre>
      
    <p class="normal">In this instance, when the <code class="inlineCode">ManagerModule</code> is loaded, <code class="inlineCode">authGuard</code> will be called during the <code class="inlineCode">canLoad</code> event, and the <code class="inlineCode">checkLogin</code> function will verify the authentication status of the user. If the guard returns <code class="inlineCode">false</code>, the module will not be loaded.</p>
    <p class="normal">We can go further and provide additional metadata<a id="_idIndexMarker586"/> in the route definition, like <code class="inlineCode">expectedRole</code>, which will be passed into the <code class="inlineCode">checkLogin</code> function by the <code class="inlineCode">canActivate</code> event. If a user is authenticated, but their role doesn’t match <code class="inlineCode">Role.Manager</code>, <code class="inlineCode">authGuard</code> will again return <code class="inlineCode">false,</code> and the module will not be loaded.</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Use the <code class="inlineCode">canActivate</code> guard to prevent the activation of individual components, such as the user’s <code class="inlineCode">profile</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/user-routing.</strong><strong class="hljs-property-slc">module</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
{ 
  <span class="hljs-attr">path</span>: <span class="hljs-string">'profile'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title">ProfileComponent</span>, 
  <span class="code-highlight"><strong class="hljs-attr-slc">canActivate</strong><strong class="hljs-slc">: [authGuard] </strong></span>
},
...
</code></pre>
      
    <p class="normal">In the case of <code class="inlineCode">user-routing.module.ts</code>, <code class="inlineCode">authGuard</code> is called during the <code class="inlineCode">canActivate</code> event, and the <code class="inlineCode">checkLogin</code> function controls where this route can be navigated. Since the user is viewing their own profile, there’s no need to check the user’s role here.</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Use <code class="inlineCode">canActivate</code> or <code class="inlineCode">canActivateChild</code> with an <code class="inlineCode">expectedRole</code> property to prevent the activation of components by other users, such as <code class="inlineCode">ManagerHomeComponent</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/mananger/manager-routing.</strong><strong class="hljs-property-slc">module</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'home'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-title">ManagerHomeComponent</span>,
    <span class="code-highlight"><strong class="hljs-attr-slc">canActivate</strong><strong class="hljs-slc">: [authGuard],</strong></span>
    <span class="code-highlight"><strong class="hljs-attr-slc">data</strong><strong class="hljs-slc">: { </strong><strong class="hljs-attr-slc">expectedRole</strong><strong class="hljs-slc">: </strong><strong class="hljs-title-slc">Role</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">Manager</strong><strong class="hljs-slc"> },</strong></span>
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'users'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-title">UserManagementComponent</span>,
    <span class="code-highlight"><strong class="hljs-attr-slc">canActivate</strong><strong class="hljs-slc">: [authGuard],</strong></span>
    <span class="code-highlight"><strong class="hljs-attr-slc">data</strong><strong class="hljs-slc">: { </strong><strong class="hljs-attr-slc">expectedRole</strong><strong class="hljs-slc">: </strong><strong class="hljs-title-slc">Role</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">Manager</strong><strong class="hljs-slc"> },</strong></span>
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'receipts'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-title">ReceiptLookupComponent</span>,
    <span class="code-highlight"><strong class="hljs-attr-slc">canActivate</strong><strong class="hljs-slc">: [authGuard],</strong></span>
    <span class="code-highlight"><strong class="hljs-attr-slc">data</strong><strong class="hljs-slc">: { </strong><strong class="hljs-attr-slc">expectedRole</strong><strong class="hljs-slc">: </strong><strong class="hljs-title-slc">Role</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">Manager</strong><strong class="hljs-slc"> },</strong></span>
  },
...
</code></pre>
      </li>
    </ol>
    <p class="normal">Inside <code class="inlineCode">ManagerModule</code>, we can verify whether the user can access a particular route. We can once again define some metadata, like <code class="inlineCode">expectedRole</code>, so if a role doesn’t match <code class="inlineCode">Role.Manager</code>, <code class="inlineCode">authGuard</code> will return <code class="inlineCode">false,</code> and the navigation<a id="_idIndexMarker587"/> will be prevented.</p>
    <p class="normal">Next, we will review some techniques to implement unit tests to isolate dependencies.</p>
    <h2 id="_idParaDest-202" class="heading-2">Auth service fake and common testing providers</h2>
    <p class="normal">We need to provide mocked<a id="_idIndexMarker588"/> versions of services<a id="_idIndexMarker589"/> like <code class="inlineCode">AuthService</code> or <code class="inlineCode">UiService</code> using the <code class="inlineCode">commonTestingProviders</code> function in <code class="inlineCode">common.testing.ts</code>, using a pattern similar to <code class="inlineCode">commonTestingModules</code>, which was mentioned in <em class="chapterRef">Chapter 4</em>, <em class="italic">Creating a Router-First Line-of-Business App</em>. This way, we won’t have to mock the same objects repeatedly.</p>
    <p class="normal">Let’s create the spy objects using the <code class="inlineCode">autoSpyObj</code> function from <code class="inlineCode">angular-unit-test-helper</code> and go over some less obvious changes we need to implement to get our tests passing:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Update <code class="inlineCode">commonTestingProviders</code> in <code class="inlineCode">common.testing.ts</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/common/common.</strong><strong class="hljs-property-slc">testing</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { autoSpyObj } <span class="hljs-keyword">from</span> <span class="hljs-string">'angular-unit-test-helper'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">commonTestingProviders</span>: <span class="hljs-built_in">any</span>[] = [
  { <span class="hljs-attr">provide</span>: <span class="hljs-title">AuthService</span>, <span class="hljs-attr">useValue</span>: <span class="hljs-title">autoSpyObj</span>(<span class="hljs-title">AuthService</span>) },
  { <span class="hljs-attr">provide</span>: <span class="hljs-title">UiService</span>, <span class="hljs-attr">useValue</span>: <span class="hljs-title">autoSpyObj</span>(<span class="hljs-title">UiService</span>) }, 
]
</code></pre>
      </li>
      <li class="numberedList">Observe the test double <a id="_idIndexMarker590"/> provided for<a id="_idIndexMarker591"/> the <code class="inlineCode">MediaObserver</code> in <code class="inlineCode">app.component.spec.ts</code> and update it to use <code class="inlineCode">commonTestingModules</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/app.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">spec</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
  <span class="hljs-title">TestBed</span>.<span class="hljs-title">configureTestingModule</span>({
    <span class="code-highlight"><strong class="hljs-attr-slc">imports</strong><strong class="hljs-slc">: [...commonTestingModules],</strong></span>
    <span class="hljs-attr">providers</span>: [
      <span class="code-highlight"><strong class="hljs-slc">{ </strong><strong class="hljs-attr-slc">provide</strong><strong class="hljs-slc">: </strong><strong class="hljs-title-slc">MediaObserver</strong><strong class="hljs-slc">, </strong><strong class="hljs-attr-slc">useClass</strong><strong class="hljs-slc">: </strong><strong class="hljs-title-slc">MediaObserverFake</strong><strong class="hljs-slc"> },</strong></span>
...
</code></pre>
      
    <p class="normal">Note how we use the spread syntax, <code class="inlineCode">...</code>, to expand the <code class="inlineCode">commonTestingModules</code> within another array. This way, when you need to add more items to the array, it is convenient to do so by just adding a <code class="inlineCode">common</code> and another element next to it.</p>
    <div class="note">
      <p class="normal">Don’t confuse the spread syntax, <code class="inlineCode">…</code>, with this book’s use of ellipses, also <code class="inlineCode">…</code>, to represent the existence of surrounding code in the snippets shared.</p>
    </div></li>
    </ol>

    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Update the <code class="inlineCode">spec</code> file for <code class="inlineCode">LoginComponent</code> to leverage <code class="inlineCode">commonTestingModules</code> and <code class="inlineCode">commonTestingProviders</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/login/login.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">spec</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
  <span class="hljs-title">TestBed</span>.<span class="hljs-title">configureTestingModule</span>({
    <span class="code-highlight"><strong class="hljs-attr-slc">imports</strong><strong class="hljs-slc">: [... commonTestingModules],</strong></span>
    <span class="code-highlight"><strong class="hljs-attr-slc">providers</strong><strong class="hljs-slc">: [... commonTestingProviders],</strong></span>
    <span class="hljs-attr">declarations</span>: [<span class="hljs-title">LoginComponent</span>],
  }).<span class="hljs-title">compileComponents</span>()
</code></pre>
      </li>
      <li class="numberedList">Go ahead and apply this technique to all <code class="inlineCode">spec</code> files that have a dependency on <code class="inlineCode">AuthService</code> and <code class="inlineCode">UiService</code>.</li>
      <li class="numberedList">The notable exception is services, as in <code class="inlineCode">auth.service.spec.ts</code>, where you do <em class="italic">not</em> want to use a test double. Since <code class="inlineCode">AuthService</code> is the class under test, make sure it is configured as follows:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/auth/auth.</strong><strong class="hljs-property-slc">service</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">spec</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
<span class="hljs-title">TestBed</span>.<span class="hljs-title">configureTestingModule</span>({
  <span class="code-highlight"><strong class="hljs-attr-slc">imports</strong><strong class="hljs-slc">: [</strong><strong class="hljs-title-slc">HttpClientTestingModule</strong><strong class="hljs-slc">],</strong></span>
  <span class="code-highlight"><strong class="hljs-attr-slc">providers</strong><strong class="hljs-slc">: [</strong><strong class="hljs-title-slc">AuthService</strong><strong class="hljs-slc">, </strong></span>
  <span class="code-highlight"><strong class="hljs-slc">{ </strong><strong class="hljs-attr-slc">provide</strong><strong class="hljs-slc">: </strong><strong class="hljs-title-slc">UiService</strong><strong class="hljs-slc">, </strong><strong class="hljs-attr-slc">useValue</strong><strong class="hljs-slc">: </strong><strong class="hljs-title-slc">autoSpyObj</strong><strong class="hljs-slc">(</strong><strong class="hljs-title-slc">UiService</strong><strong class="hljs-slc">) }],</strong></span>
})
</code></pre>
      </li>
      <li class="numberedList">Update <code class="inlineCode">ui.service.spec.ts</code> with<a id="_idIndexMarker592"/> similar <a id="_idIndexMarker593"/>considerations.</li>
    </ol>
    <p class="normal">Remember, don’t move on until all your tests pass!</p>
    <h1 id="_idParaDest-203" class="heading-1">A Firebase authentication recipe</h1>
    <p class="normal">We can leverage our current<a id="_idIndexMarker594"/> authentication setup and integrate it with a real authentication service. For this section, you need a free Google and Firebase<a id="_idIndexMarker595"/> account. Firebase is Google’s comprehensive mobile development platform: <a href="https://firebase.google.com"><span class="url">https://firebase.google.com</span></a>. You can create a free account to host your application and leverage the Firebase authentication system.</p>
    <p class="normal">The Firebase console, found at <a href="https://console.firebase.google.com"><span class="url">https://console.firebase.google.com</span></a>, allows you to manage users and<a id="_idIndexMarker596"/> send a password reset email without implementing a backend for your application. Later, you can leverage Firebase functions to implement APIs in a serverless manner.</p>
    <p class="normal">Start by adding your project to Firebase using the Firebase console:</p>
    <figure class="mediaobject"><img src="../Images/B20960_06_08.png" alt="A screenshot of a blue screen  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 6.8: The Firebase console</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Click on <strong class="screenText">Add project</strong>.</li>
      <li class="numberedList">Provide your project name.</li>
      <li class="numberedList">Enable Google Analytics for your project.</li>
    </ol>
    <p class="normal">It helps to create a Google Analytics<a id="_idIndexMarker597"/> account before attempting this, but it should still work. Once your project is created, you should see your project dashboard:</p>
    <figure class="mediaobject"><img src="../Images/B20960_06_09.png" alt="A screenshot of a computer  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 6.9: The Firebase project overview</p>
    <p class="normal">On the left-hand side, marked with <strong class="screenText">1</strong>, you can see a menu of tools and services that you can add to your project. At the top, marked<a id="_idIndexMarker598"/> with <strong class="screenText">2</strong>, you can quickly jump between your projects. Before doing so, you need to add an application to your project.</p>
    <h2 id="_idParaDest-204" class="heading-2">Create a Firebase application</h2>
    <p class="normal">Your project can include multiple <a id="_idIndexMarker599"/>distributions of your application, like web, iOS, and Android versions. In this chapter, we’re only interested in adding a web application.</p>
    <p class="normal">Let’s get started:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">On your project dashboard, click on the web application button to add an application, which is marked with <strong class="screenText">3</strong> in <em class="italic">Figure 6.9</em>.</li>
      <li class="numberedList">Provide an application nickname.</li>
      <li class="numberedList">Select the option to set up <strong class="screenText">Firebase Hosting</strong>.</li>
      <li class="numberedList">Continue by hitting the <strong class="screenText">Register app</strong> button.</li>
      <li class="numberedList">Skip over the <strong class="screenText">Add Firebase SDK</strong> section.</li>
      <li class="numberedList">Install the Firebase CLI as instructed:
        <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npm install -g firebase-tools
</code></pre>
      </li>
      <li class="numberedList">Sign in:
        <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> firebase login
</code></pre>
      </li>
    </ol>
    <div class="note">
      <p class="normal">Make sure your current directory is your project’s root folder.</p>
    </div>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="8">Initialize your project:
        <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> firebase init
</code></pre>
      </li>
      <li class="numberedList">Select the <strong class="screenText">Hosting</strong> option. Don’t worry; you can add more features later.</li>
      <li class="numberedList">Select the project you created as the default, that is, <strong class="screenText">lemon-mart-007</strong>.</li>
      <li class="numberedList">Say yes to “Detected an existing Angular codebase in the current directory, should we use this?”
    <p class="normal">This will create two new files: <code class="inlineCode">firebase.json</code> and <code class="inlineCode">.firebaserc</code>.</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="12">Build your project for production:
        <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npx ng build --prod
</code></pre>
      
    <p class="normal">or</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npm run build:prod
</code></pre></li>
    </ol>


    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="13">Now, you can deploy your Angular application by executing the following command:
        <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> firebase deploy
</code></pre>
      </li>
    </ol>
    <p class="normal">Your website should be available on a URL similar to <a href="https://lemon-mart-007.firebaseapp.com"><span class="url">https://lemon-mart-007.firebaseapp.com</span></a>, as shown in the terminal.</p>
    <div class="packt_tip">
      <p class="normal">Add the <code class="inlineCode">.firebase</code> folder to <code class="inlineCode">.gitignore</code> so that you don’t check in your cache files. The other two files, <code class="inlineCode">firebase.json</code> and <code class="inlineCode">.firebaserc</code>, are safe to commit.</p>
    </div>
    <p class="normal">Optionally, connect a custom<a id="_idIndexMarker600"/> domain name that you own to the account using the Firebase console.</p>
    <h2 id="_idParaDest-205" class="heading-2">Configuring Firebase authentication</h2>
    <p class="normal">Now, let’s configure<a id="_idIndexMarker601"/> authentication.</p>
    <p class="normal">In the Firebase console:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Expand the <strong class="screenText">Build</strong> menu and select <strong class="screenText">Authentication</strong> from the side navigation:
    <figure class="mediaobject"><img src="../Images/B20960_06_10.png" alt="A screenshot of a login page  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 6.10: The Firebase Authentication page</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">Add a sign-in method; select <strong class="screenText">Email/Password</strong> as the provider.</li>
      <li class="numberedList">Enable it.</li>
      <li class="numberedList">Do not enable the email link.</li>
      <li class="numberedList">Save your configuration.</li>
    </ol>
    <p class="normal">You can now see the user <a id="_idIndexMarker602"/>management console:</p>
    <figure class="mediaobject"><img src="../Images/B20960_06_11.png" alt="A screenshot of a computer  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 6.11: The Firebase user management console</p>
    <p class="normal">It is straightforward and intuitive<a id="_idIndexMarker603"/> to operate, so I will leave the configuration of it as an exercise for you.</p>
    <h2 id="_idParaDest-206" class="heading-2">Adding a Firebase auth provider to Angular</h2>
    <p class="normal">Let’s start by adding Angular<a id="_idIndexMarker604"/> Fire, the official Firebase library<a id="_idIndexMarker605"/> for Angular, to our application:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npx ng add @angular/fire
</code></pre>
    <div class="note">
      <p class="normal">Follow Angular Fire’s quick start guide to finish setting up the library with your Angular project, which you can find linked from the <code class="inlineCode">README</code> file on GitHub at <a href="https://github.com/angular/angularfire"><span class="url">https://github.com/angular/angularfire</span></a>.</p>
    </div>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Ensure Firebase modules are provided in <code class="inlineCode">app.config.ts</code> as per the documentation.</li>
      <li class="numberedList">Copy your Firebase <code class="inlineCode">config</code> object to all of your <code class="inlineCode">environment.ts</code> files.
    <div class="note">
      <p class="normal">Note that any information provided in <code class="inlineCode">environment.ts</code> is public information. So when you place your Firebase API key in this file, it will be publicly available. There’s a small chance that another developer could abuse your API key and run up your bill. To protect yourself<a id="_idIndexMarker606"/> from any such attack, check out this blog post by Paachu: <em class="italic">How to secure your Firebase project even when your API key is publicly available</em> at <a href="https://medium.com/@impaachu/how-to-secure-your-firebase-project-even-when-your-api-key-is-publicly-available-a462a2a58843"><span class="url">https://medium.com/@impaachu/how-to-secure-your-firebase-project-even-when-your-api-key-is-publicly-available-a462a2a58843</span></a>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Create a new <code class="inlineCode">FirebaseAuthService</code>:
        <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npx ng g s auth/firebaseAuth --lintFix
</code></pre>
      </li>
      <li class="numberedList">Rename the service file <code class="inlineCode">auth.firebase.service.ts</code>.</li>
      <li class="numberedList">Be sure to remove <code class="inlineCode">{ providedIn: 'root' }</code>.</li>
      <li class="numberedList">Implement Firebase auth by extending the abstract auth service:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/auth/auth.</strong><strong class="hljs-property-slc">firebase</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">service</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { inject, <span class="hljs-title">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>
<span class="hljs-keyword">import</span> {
  <span class="hljs-title">Auth</span> <span class="hljs-keyword">as</span> <span class="hljs-title">FireAuth</span>,
  signInWithEmailAndPassword,
  signOut,
  <span class="hljs-title">User</span> <span class="hljs-keyword">as</span> <span class="hljs-title">FireUser</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/fire/auth'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Observable</span>, <span class="hljs-keyword">of</span>, <span class="hljs-title">Subject</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">IUser</span>, <span class="hljs-title">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../user/user/user'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Role</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth.enum'</span>
<span class="hljs-keyword">import</span> {
  <span class="hljs-title">AuthService</span>,
  <span class="hljs-title">defaultAuthStatus</span>,
  <span class="hljs-title">IAuthStatus</span>,
  <span class="hljs-title">IServerAuthResponse</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth.service'</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title">IJwtToken</span> {
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">iat</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">exp</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">sub</span>: <span class="hljs-built_in">string</span>
}
<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FirebaseAuthService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">afAuth</span>: <span class="hljs-title">FireAuth</span> = <span class="hljs-title">inject</span>(<span class="hljs-title">FireAuth</span>)
  <span class="hljs-title">constructor</span>() {
    <span class="hljs-variable">super</span>()
  }
  <span class="hljs-keyword">protected</span> <span class="hljs-title">authProvider</span>(
    <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-built_in">string</span>
  ): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">IServerAuthResponse</span>&gt; {
    <span class="hljs-keyword">const</span> serverResponse$ = <span class="hljs-keyword">new</span> <span class="hljs-title">Subject</span>&lt;<span class="hljs-title">IServerAuthResponse</span>&gt;()
    <span class="hljs-title">signInWithEmailAndPassword</span>(<span class="hljs-variable">this</span>.<span class="hljs-property">afAuth</span>, email, password).<span class="hljs-title">then</span>(
      <span class="hljs-function">(</span><span class="hljs-params">res</span><span class="hljs-function">) =&gt;</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">firebaseUser</span>: <span class="hljs-title">FireUser</span> | <span class="hljs-literal">null</span> = res.<span class="hljs-property">user</span>
        firebaseUser?.<span class="hljs-title">getIdToken</span>().<span class="hljs-title">then</span>(
          <span class="hljs-function">(</span><span class="hljs-params">token</span><span class="hljs-function">) =&gt;</span> serverResponse$.<span class="hljs-title">next</span>({
            <span class="hljs-attr">accessToken</span>: token
          } <span class="hljs-keyword">as</span> <span class="hljs-title">IServerAuthResponse</span>),
          <span class="hljs-function">(</span><span class="hljs-params">err</span><span class="hljs-function">) =&gt;</span> serverResponse$.<span class="hljs-title">error</span>(err)
        )
      },
      <span class="hljs-function">(</span><span class="hljs-params">err</span><span class="hljs-function">) =&gt;</span> serverResponse$.<span class="hljs-title">error</span>(err)
    )
    <span class="hljs-keyword">return</span> serverResponse$
  }
  <span class="hljs-keyword">protected</span> <span class="hljs-title">transformJwtToken</span>(<span class="hljs-attr">token</span>: <span class="hljs-title">IJwtToken</span>): <span class="hljs-title">IAuthStatus</span> {
    <span class="hljs-keyword">if</span> (!token) {
      <span class="hljs-keyword">return</span> defaultAuthStatus
    }
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">isAuthenticated</span>: token.<span class="hljs-property">email</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>,
      <span class="hljs-attr">userId</span>: token.<span class="hljs-property">sub</span>,
      <span class="hljs-attr">userRole</span>: <span class="hljs-title">Role</span>.<span class="hljs-property">None</span>,
    }
  }
  <span class="hljs-keyword">protected</span> <span class="hljs-title">getCurrentUser</span>(): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">User</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-title">of</span>(<span class="hljs-variable">this</span>.<span class="hljs-title">transformFirebaseUser</span>(<span class="hljs-variable">this</span>.<span class="hljs-property">afAuth</span>.<span class="hljs-property">currentUser</span>))
  }
  <span class="hljs-keyword">private</span> <span class="hljs-title">transformFirebaseUser</span>(<span class="hljs-attr">firebaseUser</span>: <span class="hljs-title">FireUser</span> | <span class="hljs-literal">null</span>): <span class="hljs-title">User</span> {
    <span class="hljs-keyword">if</span> (!firebaseUser) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">User</span>()
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title">User</span>.<span class="hljs-title">Build</span>({
      <span class="hljs-attr">name</span>: {
        <span class="hljs-attr">first</span>: firebaseUser?.<span class="hljs-property">displayName</span>?.<span class="hljs-title">split</span>(<span class="hljs-string">' '</span>)[<span class="hljs-number">0</span>] ||
                 <span class="hljs-string">'Firebase'</span>,
        <span class="hljs-attr">last</span>: firebaseUser?.<span class="hljs-property">displayName</span>?.<span class="hljs-title">split</span>(<span class="hljs-string">'</span><span class="hljs-string"> '</span>)[<span class="hljs-number">1</span>] || <span class="hljs-string">'User'</span>,
      },
      <span class="hljs-attr">picture</span>: firebaseUser.<span class="hljs-property">photoURL</span>,
      <span class="hljs-attr">email</span>: firebaseUser.<span class="hljs-property">email</span>,
      <span class="hljs-attr">_id</span>: firebaseUser.<span class="hljs-property">uid</span>,
      <span class="hljs-attr">role</span>: <span class="hljs-title">Role</span>.<span class="hljs-property">None</span>,
    } <span class="hljs-keyword">as</span> <span class="hljs-title">IUser</span>)
  }
  <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> <span class="hljs-title">logout</span>() {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">this</span>.<span class="hljs-property">afAuth</span>) {
      <span class="hljs-keyword">await</span> <span class="hljs-title">signOut</span>(<span class="hljs-variable">this</span>.<span class="hljs-property">afAuth</span>)
    }
    <span class="hljs-variable">this</span>.<span class="hljs-title">clearToken</span>()
    <span class="hljs-variable">this</span>.<span class="hljs-property">authStatus$</span>.<span class="hljs-title">next</span>(defaultAuthStatus)
  }
}
</code></pre>
      
    <p class="normal">As you can see, we only had to implement<a id="_idIndexMarker607"/> the delta between<a id="_idIndexMarker608"/> our already established authentication code and Firebase’s authentication methods. We didn’t have to duplicate any code, and we had to transform a Firebase <code class="inlineCode">user</code> object into our application’s internal user object.</p>
    <div class="packt_tip">
      <p class="normal">Note that in <code class="inlineCode">transformFirebaseUser</code>, we set <code class="inlineCode">role: Role.None</code> because Firebase authentication doesn’t implement the concept of a user role by default. To make the Firebase integration fully functional, you’d have to implement Firebase functions and a Firestore database so that you can store rich user profiles and perform CRUD operations on it. In this case, after authentication, you’d make another call to retrieve the role information. In <em class="chapterRef">Chapter 7</em>, <em class="italic">Working with REST and GraphQL APIs</em>, we cover how to implement this within your custom API.</p>
    </div></li>
    </ol>



    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">To use Firebase authentication instead of in-memory authentication, update the <code class="inlineCode">AuthService</code> provider in <code class="inlineCode">app.config.ts</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/app.</strong><strong class="hljs-property-slc">config</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
  {
    <span class="hljs-attr">provide</span>: <span class="hljs-title">AuthService</span>,
    <span class="hljs-attr">useClass</span>: <span class="code-highlight"><strong class="hljs-title-slc">FirebaseAuthService</strong></span>,
  },
</code></pre>
     
    <p class="normal">Once you’ve completed the steps, add a new user from the Firebase authentication console, and you should be able to log in using real authentication.</p>
    <div class="packt_tip">
      <p class="normal">Always make sure<a id="_idIndexMarker609"/> that you’re using HTTPS when transmitting any kind of <strong class="keyWord">Personally Identifiable Information</strong> (<strong class="keyWord">PII</strong>) or sensitive information (like passwords) over the internet. Otherwise, your information will be logged on to third-party servers or captured by bad actors.</p>
    </div> </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="8">Once again, be sure<a id="_idIndexMarker610"/> to update your unit tests<a id="_idIndexMarker611"/> before moving on:
        <pre class="programlisting code"><code class="hljs-code">src/app/auth/auth.firebase.service.spec.ts
<span class="hljs-keyword">import</span> {
  <span class="hljs-title">HttpClientTestingModule</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http/testing'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">inject</span>, <span class="hljs-title">TestBed</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Auth</span> <span class="hljs-keyword">as</span> <span class="hljs-title">FireAuth</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/fire/auth'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">UiService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/ui.service'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">FirebaseAuthService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth.firebase.service'</span>
<span class="hljs-keyword">const</span> angularFireStub = {
  <span class="hljs-attr">user</span>: jasmine.<span class="hljs-title">createSpyObj</span>(<span class="hljs-string">'user'</span>, [<span class="hljs-string">'subscribe'</span>]),
  <span class="hljs-attr">auth</span>: jasmine.<span class="hljs-title">createSpyObj</span>(<span class="hljs-string">'auth'</span>,
            [<span class="hljs-string">'signInWithEmailAndPassword'</span>, <span class="hljs-string">'signOut'</span>]),
}
<span class="hljs-title">describe</span>(<span class="hljs-string">'AuthService'</span>, () =&gt; {
  <span class="hljs-title">beforeEach</span>(() =&gt; {
    <span class="hljs-title">TestBed</span>.<span class="hljs-title">configureTestingModule</span>({
      <span class="hljs-attr">imports</span>: [<span class="hljs-title">HttpClientTestingModule</span>],
      <span class="hljs-attr">providers</span>: [
        <span class="hljs-title">FirebaseAuthService</span>,
        <span class="hljs-title">UiService</span>,
        { <span class="hljs-attr">provide</span>: <span class="hljs-title">FireAuth</span>, <span class="hljs-attr">useValue</span>: angularFireStub },
      ],
    })
  })
  <span class="hljs-title">it</span>(<span class="hljs-string">'should</span> <span class="hljs-string">be</span> <span class="hljs-string">created'</span>, <span class="hljs-title">inject</span>(
    [<span class="hljs-title">FirebaseAuthService</span>],
    (<span class="hljs-attr">service</span><span class="hljs-params">:</span> <span class="hljs-title">FirebaseAuthService</span>) =&gt; {
      <span class="hljs-title">expect</span>(service).<span class="hljs-title">toBeTruthy</span>()
    }
  ))
})
</code></pre>
      </li>
    </ol>
    <div class="note">
      <p class="normal">Stop! Remove the <code class="inlineCode">fake-jwt-sign</code> package from your project before deploying a real authentication method.</p>
    </div>
    <p class="normal">Congratulations! Your<a id="_idIndexMarker612"/> application<a id="_idIndexMarker613"/> is integrated with Firebase! Next, let’s cover service factories, which can help you to switch the providers of your abstract classes dynamically.</p>
    <h1 id="_idParaDest-207" class="heading-1">Providing a service using a factory</h1>
    <p class="normal">You can dynamically choose<a id="_idIndexMarker614"/> providers during load time, so instead of changing code<a id="_idIndexMarker615"/> to switch between authentication methods, you can parametrize environment variables so that different kinds of builds can have different authentication methods. This is especially useful when writing automated UI tests against your application, where real authentication can be difficult, if not impossible, to deal with.</p>
    <p class="normal">First, we will create an <code class="inlineCode">enum</code> in <code class="inlineCode">environment.ts</code> to help define our options, and then we will use that <code class="inlineCode">enum</code> to choose an auth provider during our application’s bootstrap process.</p>
    <p class="normal">Let’s get started:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Create a new <code class="inlineCode">enum</code> called <code class="inlineCode">AuthMode</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/auth/auth.</strong><strong class="hljs-property-slc">enum</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title">AuthMode</span> {
  <span class="hljs-title">InMemory</span> = <span class="hljs-string">'In Memory'</span>,
  <span class="hljs-title">CustomServer</span> = <span class="hljs-string">'Custom Server'</span>,
  <span class="hljs-title">CustomGraphQL</span> = <span class="hljs-string">'Custom GraphQL'</span>,
  <span class="hljs-title">Firebase</span> = <span class="hljs-string">'Firebase'</span>,
}
</code></pre>
      </li>
      <li class="numberedList">Add an <code class="inlineCode">authMode</code> property in <code class="inlineCode">environment.ts</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/environments/environment.</strong><strong class="hljs-property-slc">ts</strong></span>
...
  <span class="hljs-attr">authMode</span>: <span class="hljs-title">AuthMode</span>.<span class="code-highlight"><strong class="hljs-property-slc">InMemory</strong></span>,
...
<span class="code-highlight"><strong class="hljs-slc">src/environments/environment.</strong><strong class="hljs-property-slc">prod</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
  <span class="hljs-attr">authMode</span>: <span class="hljs-title">AuthMode</span>.<span class="code-highlight"><strong class="hljs-property-slc">Firebase</strong></span>,
...
</code></pre>
      </li>
      <li class="numberedList">Create an <code class="inlineCode">authFactory</code> function<a id="_idIndexMarker616"/> in a new file<a id="_idIndexMarker617"/> under <code class="inlineCode">auth/auth.factory.ts</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/auth/auth.</strong><strong class="hljs-property-slc">factory</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">environment</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../environments/environment'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">AuthMode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth.enum'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">FirebaseAuthService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth.firebase.service'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">InMemoryAuthService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth.in-memory.service'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title">authFactory</span>() {
  <span class="hljs-keyword">switch</span> (environment.<span class="hljs-property">authMode</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title">AuthMode</span>.<span class="hljs-property">InMemory</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">InMemoryAuthService</span>()
    <span class="hljs-keyword">case</span> <span class="hljs-title">AuthMode</span>.<span class="hljs-property">Firebase</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">FirebaseAuthService</span>()
    <span class="hljs-keyword">case</span> <span class="hljs-title">AuthMode</span>.<span class="hljs-property">CustomServer</span>:
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title">Error</span>(<span class="hljs-string">'Not yet implemented'</span>)
    <span class="hljs-keyword">case</span> <span class="hljs-title">AuthMode</span>.<span class="hljs-property">CustomGraphQL</span>:
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title">Error</span>(<span class="hljs-string">'Not yet implemented'</span>)
  }
}
</code></pre>
      
    <div class="note">
      <p class="normal">Note that the factory must import any dependent service, as shown above.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Update the <code class="inlineCode">AuthService</code> provider in <code class="inlineCode">app.config.ts</code> to use the factory instead:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/app.</strong><strong class="hljs-property-slc">config</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
  <span class="hljs-attr">providers</span>: [
    {
      <span class="hljs-attr">provide</span>: <span class="hljs-title">AuthService</span>,
      <span class="code-highlight"><strong class="hljs-attr-slc">useFactory</strong><strong class="hljs-slc">: authFactory</strong></span>
    },
</code></pre>
      </li>
    </ol>
    <p class="normal">Note that you can remove imports of <code class="inlineCode">InMemoryAuthService</code> and <code class="inlineCode">FirebaseAuthService</code> from <code class="inlineCode">app.config.ts</code>.</p>
    <p class="normal">With this configuration in place, whenever<a id="_idIndexMarker618"/> you build your application in development<a id="_idIndexMarker619"/> configuration, you will use the in-memory auth service, and production (prod) builds will use the Firebase auth service. </p>
    <h1 id="_idParaDest-208" class="heading-1">Summary</h1>
    <p class="normal">You should now be familiar with how to create high-quality auth experiences. In this chapter, we designed a great conditional navigation experience that you can use in your own applications, by copying the base elements to your project and implementing your own auth provider. We created a reusable UI service so that you can conveniently show alerts in the flow-control logic of your application.</p>
    <p class="normal">We covered route guards to prevent users from stumbling onto screens they are not authorized to use, and we reaffirmed the point that the real security of your application should be implemented on the server side. You saw how you can use a factory to dynamically provide different auth providers for different environments.</p>
    <p class="normal">Finally, we implemented a real auth provider with Firebase. In <em class="chapterRef">Chapter 7</em>, <em class="italic">Working with REST and GraphQL APIs</em>, we will review LemonMart Server, a full-stack implementation using the minimal MEAN stack with REST and GraphQL APIs. We will complete our authentication journey by learning how to implement a custom auth provider and implement RBAC for both the REST and GraphQL endpoints.</p>
    <h1 id="_idParaDest-209" class="heading-1">Further reading</h1>
    <ul>
      <li class="bulletList"><em class="italic">Angular @if block</em>: <a href="https://angular.dev/api/core/@if"><span class="url">https://angular.dev/api/core/@if</span></a></li>
      <li class="bulletList">Angular. <em class="italic">CanActivate</em>. Angular. Retrieved from <a href="https://angular.io/api/router/CanActivate"><span class="url">https://angular.io/api/router/CanActivate</span></a></li>
      <li class="bulletList">Angular. <em class="italic">CanLoad</em>. Angular. Retrieved from <a href="https://angular.io/api/router/CanLoad"><span class="url">https://angular.io/api/router/CanLoad</span></a></li>
      <li class="bulletList">Vasconcelos, V. (2019, October 10). <em class="italic">Angular Router Guards: A Complete Guide</em>. Angular University. Retrieved from <a href="https://blog.angular-university.io/angular-router-guards/"><span class="url">https://blog.angular-university.io/angular-router-guards/</span></a></li>
      <li class="bulletList">AngularFire. <em class="italic">Getting started with AngularFire authentication</em>. GitHub. Retrieved from <a href="https://blog.angular-university.io/angular-router-guards/"><span class="url">https://github.com/angular/angularfire/blob/master/docs/auth/getting-started.md</span></a></li>
      <li class="bulletList">Davis, J. (2021, April 12). <em class="italic">Role-Based Authorization in Angular with Firebase</em>. InDepth. Retrieved from <a href="https://indepth.dev/posts/1305/role-based-firebase-authentication-with-angular-8 "><span class="url">https://indepth.dev/posts/1305/role-based-firebase-authentication-with-angular-8</span></a></li>
    </ul>
    <h1 id="_idParaDest-210" class="heading-1">Questions</h1>
    <p class="normal">Answer the following questions as best as possible to ensure you’ve understood the key concepts from this chapter without googling anything. Do you know if you got all the answers right? Visit <a href="https://angularforenterprise.com/self-assessment"><span class="url">https://angularforenterprise.com/self-assessment</span></a> for more:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">What is the difference between RxJS’s <code class="inlineCode">combineLatest</code> and <code class="inlineCode">merge</code> operators?</li>
      <li class="numberedList">Explain the difference between <code class="inlineCode">canActivate</code> and <code class="inlineCode">canLoad</code> in the context of Angular route guards.</li>
      <li class="numberedList">How does dynamic UI rendering improve the user experience in role-based navigation systems?</li>
      <li class="numberedList">What are the benefits and potential drawbacks of using a service like Firebase Authentication for user management in a web application?</li>
      <li class="numberedList">Describe a scenario where a service factory can be particularly useful in an Angular application.</li>
    </ol>
    
  </div>
</body></html>