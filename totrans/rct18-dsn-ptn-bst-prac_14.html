<html><head></head><body>
<div id="sbo-rt-content"><div class="Basic-Text-Frame" id="_idContainer159">
<h1 class="chapterNumber">14</h1>
<h1 class="chapterTitle" id="_idParaDest-244">MonoRepo Architecture</h1>
<p class="normal">When we think about building apps, we usually talk about an app, a <code class="inlineCode">git</code> repository, and a build output. However, this configuration of an application and a repository does not always reflect the real-world experience of developers. Often organizations will use a single repository with all the applications, components, and libraries that could be used in common development. These are called a monorepository or single repository, and they are starting to become very popular.</p>
<p class="normal">So, what makes a monorepository interesting for organizations? Why put all the code in one place? Why not have a single <code class="inlineCode">git</code> repository where you have many small and separate repositories? If we keep all our code in one project.</p>
<p class="normal">By keeping all the code in one repository, you keep all dependencies up to date across the organization. This is probably the biggest benefit of a single repository. This way we will stop having to waste time updating all the dependencies of several different projects. </p>
<p class="normal">In this chapter, we’ll be walking through how to create a monorepository with multiple packages using TypeScript, webpack, and NPM Workspaces.</p>
<p class="normal">We will look at the following topics:</p>
<ul>
<li class="bulletList">Advantages of a monorepository and the problems it solves</li>
<li class="bulletList">How to create a monorepository</li>
<li class="bulletList">Implementing TypeScript in the monorepository</li>
<li class="bulletList">Creating a <code class="inlineCode">devtools</code> package to compile other packages with Webpack</li>
<li class="bulletList">Creating a <code class="inlineCode">utils</code> package</li>
<li class="bulletList">How to create a multi-site system</li>
</ul>
<h1 class="heading-1" id="_idParaDest-245">Technical requirements</h1>
<p class="normal">To complete this chapter, you will need the following:</p>
<ul>
<li class="bulletList">Node.js 19+</li>
<li class="bulletList">Visual Studio Code</li>
</ul>
<p class="normal">You can find the code for this chapter in the book’s GitHub repository: <a href="https://github.com/PacktPublishing/React-18-Design-Patterns-and-Best-Practices-Fourth-Edition/tree/main/Chapter14"><span class="url">https://github.com/PacktPublishing/React-18-Design-Patterns-and-Best-Practices-Fourth-Edition/tree/main/Chapter14</span></a>.</p>
<h1 class="heading-1" id="_idParaDest-246">Advantages of a monorepository and the problems it solves</h1>
<p class="normal">Some <a id="_idIndexMarker705"/>of <a id="_idIndexMarker706"/>the advantages of a <strong class="keyWord">MonoRepo</strong> (<strong class="keyWord">monorepository</strong>) are:</p>
<ul>
<li class="bulletList"><strong class="keyWord">Sharing is made easy</strong>: With all the code in one place, it becomes easier to utilize the same code or tools across multiple projects, saving valuable time and effort. </li>
<li class="bulletList"><strong class="keyWord">No mix-ups</strong>: In a MonoRepo, every project utilizes the same version of shared components, eliminating concerns about compatibility issues between different versions.</li>
<li class="bulletList"><strong class="keyWord">Change everything at once</strong>: In a MonoRepo, making changes across all projects simultaneously becomes a straightforward task, as opposed to the complexity of managing individual projects in separate repositories.</li>
<li class="bulletList"><strong class="keyWord">Grouped changes</strong>: Modifying multiple projects simultaneously within a MonoRepo ensures that all related components stay synchronized, allowing for efficient and cohesive updates.</li>
<li class="bulletList"><strong class="keyWord">Everyone can see everything</strong>: With all the code centralized in one repository, all developers have access to it, fostering a better understanding of the entire system and facilitating effective collaboration.</li>
</ul>
<p class="normal">Now let’s explore some of the real-life problems that a MonoRepo solves: </p>
<ul>
<li class="bulletList"><strong class="keyWord">Faster updates</strong>: With a MonoRepo, you can update all projects at once. Without it, you’d have to update each project separately, which can take a lot of time.</li>
<li class="bulletList"><strong class="keyWord">No more confusion</strong>: Without a MonoRepo, different projects might use different versions of the same thing, which can cause problems. With a MonoRepo, everything uses the same version, so there’s no confusion.</li>
<li class="bulletList"><strong class="keyWord">Better teamwork</strong>: With all the code in one place, developers can easily see and understand what others have done. This can help them work together better.</li>
<li class="bulletList"><strong class="keyWord">Easier start for newbies</strong>: For new team members, it’s easier to get started when all the code is in one place. They can quickly understand the whole system, rather than having to search through different places.</li>
</ul>
<p class="normal">It is important <a id="_idIndexMarker707"/>to <a id="_idIndexMarker708"/>remember that MonoRepos may not always be the optimal choice. They can introduce their own challenges, such as potential performance issues and increased complexity when they become excessively large. Whether adopting a MonoRepo is a suitable approach depends on the specific needs of the team and the scale of their projects.</p>
<p class="normal">In the following image you can see how the structure of a <strong class="screenText">MonoRepo</strong> is different from that of a <strong class="screenText">Multi Repo</strong>:</p>
<figure class="mediaobject"><img alt="A screenshot of a computer screen  Description automatically generated with low confidence" height="695" src="../Images/B18414_14_01.png" width="556"/></figure>
<p class="packt_figref">Figure 14.1: MultiRepo vs MonoRepo</p>
<p class="normal">Now that we’ve shed light on the concept of a monorepository and explored why it is becoming<a id="_idIndexMarker709"/> increasingly <a id="_idIndexMarker710"/>popular for organizations, we will delve into the practical implementation of a monorepository using NPM Workspaces.</p>
<h1 class="heading-1" id="_idParaDest-247">Creating a MonoRepo with NPM Workspaces</h1>
<p class="normal"><strong class="keyWord">NPM Workspaces</strong> was <a id="_idIndexMarker711"/>introduced in NPM 7 and<a id="_idIndexMarker712"/> is a generic term that refers to the set of features in the npm CLI that provides support for managing multiple packages from your local filesystem, from within a singular top-level root package.</p>
<p class="normal">The first thing you need to do in order to create a monorepository is to create a root <code class="inlineCode">package.json</code> file, which should contain the following code:</p>
<pre class="programlisting code"><code class="hljs-code">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"web-creator"</span>,
  <span class="hljs-string">"private"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"workspaces"</span>: [
    <span class="hljs-string">"packages/*"</span>
  ]
}
</code></pre>
<p class="normal">We will name our MonoRepo <code class="inlineCode">web-creator</code>. We need to specify that <code class="inlineCode">web-creator</code> will be private (only the root), and we need to specify the workspaces where our packages will live, which is on <code class="inlineCode">"packages/*"</code>; the <code class="inlineCode">*</code> means that we will include any directory that exists under the <code class="inlineCode">packages</code> folder. After this, you need to create the packages directly.</p>
<p class="normal">Let’s create<a id="_idIndexMarker713"/> two <a id="_idIndexMarker714"/>directories inside our new <code class="inlineCode">packages</code> folder: <code class="inlineCode">"packages/api"</code> and <code class="inlineCode">"packages/frontend"</code>. Now go to your <code class="inlineCode">api</code> project and run <code class="inlineCode">npm init -y</code>:</p>
<pre class="programlisting con"><code class="hljs-con">cd packages/api
npm init -y
</code></pre>
<p class="normal">Once you run that command it will create a <code class="inlineCode">package.json</code> like this:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ISC"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">As you can see, the name of that package by default will be <code class="inlineCode">"api"</code>, but in order to connect that package to our main monorepository, we need to call it with a special format; in this case, you need to rename it <code class="inlineCode">"@&lt;name_of_root_package&gt;/api"</code>, which in our example will be <code class="inlineCode">"@web-creator/api"</code>. Your <code class="inlineCode">package.json</code> should be like this:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@web-creator/api"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ISC"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">Now you need to create a file (<code class="inlineCode">packages/api/index.js</code>) inside your <code class="inlineCode">api</code> directory (later we will change this to TypeScript) with the following code:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-variable">module</span>.<span class="hljs-property">export</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-variable">console</span>.<span class="hljs-title">log</span>(<span class="hljs-string">"I'm the API package"</span>)
</code></pre>
<p class="normal">After this, you need to go to your <code class="inlineCode">frontend</code> package (<code class="inlineCode">packages/frontend</code>) and run the same <code class="inlineCode">npm init -y</code> command:</p>
<pre class="programlisting con"><code class="hljs-con">cd packages/frontend
npm init -y
</code></pre>
<p class="normal">Also, you will <a id="_idIndexMarker715"/>need<a id="_idIndexMarker716"/> to rename that package <code class="inlineCode">@web-creator/frontend</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"</span><span class="hljs-string">@web-creator/frontend"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carlos Santana"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ISC"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">The monorepository now is ready to share packages. Let’s suppose you now want to consume your <code class="inlineCode">api</code> package in your <code class="inlineCode">frontend</code> package. To do this, you need to specify the <code class="inlineCode">api</code> package as a dependency and put the same version we have in that <code class="inlineCode">api</code> package; in this case, the version will be 1.0.0. You need to be very careful and not change this version unless you really need to, and if you change it then you will need to update it on the <code class="inlineCode">dependencies</code> node as well. </p>
<p class="normal">This will be your <code class="inlineCode">package.json</code> from <code class="inlineCode">packages/frontend</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@web-creator/frontend"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carlos Santana"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ISC"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@web-creator/api"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span> <span class="hljs-comment">// this version needs to match with the API package.json</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">After you’ve specified the <code class="inlineCode">api</code> package as a dependency, you need to run <code class="inlineCode">npm install</code> inside the frontend project. One very interesting thing you will notice is that even if you run the <code class="inlineCode">npm install</code> command inside the <code class="inlineCode">frontend</code> package (<code class="inlineCode">packages/frontend</code>), your <code class="inlineCode">node_modules</code> folder will be created at the root level, and it will<a id="_idIndexMarker717"/> look<a id="_idIndexMarker718"/> like this:</p>
<p class="packt_figref"><img alt="" height="540" src="../Images/B18414_14_02.png" width="319"/></p>
<p class="packt_figref">Figure 14.2: Monorepo structure</p>
<p class="normal">If everything worked as expected, you can consume your <code class="inlineCode">api</code> package in your <code class="inlineCode">frontend</code> package. For this, you need to create an <code class="inlineCode">index.js</code> file inside <code class="inlineCode">packages/frontend/index.js</code> with the following code:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">const</span> api = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@web-creator/api'</span>)
<span class="hljs-title">api</span>()
</code></pre>
<p class="normal">Now you can execute your index file with <code class="inlineCode">node</code> and see the console message that comes from the <code class="inlineCode">api</code> package:</p>
<p class="packt_figref"><img alt="" height="55" src="../Images/B18414_14_03.png" width="523"/></p>
<p class="packt_figref">Figure 14.3: Running frontend</p>
<p class="normal">One of the biggest advantages of a monorepository is that if you update your API <code class="inlineCode">index.js</code>, the change will be reflected right away without you having to compile anything or publish any package to the NPM registry. This is very helpful and saves a lot of time for developers when coding large projects. Let’s change our message now to <code class="inlineCode">I'm the API package UPDATED</code> in the <code class="inlineCode">packages/api/index.js</code> and run the <code class="inlineCode">index.js</code> again with <code class="inlineCode">node</code>:</p>
<p class="packt_figref"><img alt="" height="45" src="../Images/B18414_14_04.png" width="436"/></p>
<p class="packt_figref">Figure 14.4: Updating the API</p>
<p class="normal">Congratulations, you<a id="_idIndexMarker719"/> have created your first <a id="_idIndexMarker720"/>MonoRepo successfully! In the next section, we will transform our MonoRepo to use TypeScript.</p>
<h1 class="heading-1" id="_idParaDest-248">Implementing TypeScript in our MonoRepo</h1>
<div class="note">
<p class="normal">In the following sections, I will outline the steps to create a multi-site project. Due to the substantial amount of code involved, I’m unable to include it all in this book. However, I invite you to review the complete code in the repository available at <a href="https://github.com/PacktPublishing/React-18-Design-Patterns-and-Best-Practices-Fourth-Edition/tree/main/Chapter14/web-creator"><span class="url">https://github.com/PacktPublishing/React-18-Design-Patterns-and-Best-Practices-Fourth-Edition/tree/main/Chapter14/web-creator</span></a>.</p>
</div>
<p class="normal">The first<a id="_idIndexMarker721"/> thing<a id="_idIndexMarker722"/> you need to do in order to add TypeScript to your project is to install the <code class="inlineCode">typescript</code> package at the root level:</p>
<pre class="programlisting con"><code class="hljs-con">npm install -D typescript
</code></pre>
<p class="normal">After this, you need to create the <code class="inlineCode">tsconfig.json</code> file at the root level as well with the following code:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"extends"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./tsconfig.common.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./packages"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@web-creator/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"*/src"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">As you can see, we extend the <code class="inlineCode">tsconfig.json</code> file to <code class="inlineCode">tsconfig.common.json</code>, and this is because we don’t want to to repeat each package that we want to transform to TypeScript. The only <code class="inlineCode">compilerOptions</code> we want to specify is the <code class="inlineCode">baseUrl</code> on our <code class="inlineCode">packages</code> directory, and in the paths we will specify the name of our MonoRepo to be able to do imports in the code. This is the <code class="inlineCode">tsconfig.common.json</code> file that you need to create:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"allowSyntheticDefaultImports"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"alwaysStrict"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"declaration"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"declarationMap"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"downlevelIteration"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"esModuleInterop"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"experimentalDecorators"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"jsx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"react-jsx"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lib"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"DOM"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"</span><span class="hljs-string">DOM.Iterable"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">],</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"commonjs"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"noEmit"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"noFallthroughCasesInSwitch"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"noImplicitAny"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"noImplicitReturns"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"outDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"resolveJsonModule"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"skipLibCheck"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sourceMap"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"strictFunctionTypes"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"strictNullChecks"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"suppressImplicitAnyIndexErrors"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span>
<span class="hljs-punctuation">  },</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"exclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"node_modules"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"coverage"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">".vscode"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"**/__tests__/*"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">The architecture <a id="_idIndexMarker723"/>of <a id="_idIndexMarker724"/>our project will look like this:</p>
<p class="packt_figref"><img alt="Chart, bubble chart  Description automatically generated" height="1030" src="../Images/B18414_14_05.png" width="712"/></p>
<p class="packt_figref">Figure 14.5: Web creator architecture</p>
<p class="normal">Now that we have explored the project’s architecture, let’s dive into the first package that will <a id="_idIndexMarker725"/>manage <a id="_idIndexMarker726"/>our Webpack configurations. This package will be referred to as <code class="inlineCode">devtools</code>.</p>
<h1 class="heading-1" id="_idParaDest-249">Creating a devtools package to compile packages with Webpack</h1>
<p class="normal">The first <a id="_idIndexMarker727"/>package <a id="_idIndexMarker728"/>we need to create to be able to compile other packages is called <code class="inlineCode">devtools</code> and should be created in <code class="inlineCode">packages/devtools</code>. Let’s see how it should look in its <code class="inlineCode">package.json</code> file:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@web-creator/devtools"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist/index.js"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist/index.d.ts"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
<span class="hljs-punctuation">    </span><span class="hljs-string">"dist"</span>
<span class="hljs-punctuation">  ],</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm-run-all clean compile"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"clean"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rm -rf ./dist"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"compile"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run --prefix ../../ lint"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"lint:fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"</span><span class="hljs-string">npm run --prefix ../../ lint:fix"</span>
<span class="hljs-punctuation">  },</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carlos Santana"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@types/cli-color"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.2"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@types/ip"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.1.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@types/webpack-bundle-analyzer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.6.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@types/webpack-node-externals"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.5.3"</span>
<span class="hljs-punctuation">  },</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@svgr/webpack"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^6.5.1"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@types/file-loader"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"</span><span class="hljs-string">^5.0.1"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"cli-color"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.3"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"css-loader"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^6.7.3"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"dotenv"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^16.0.3"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"file-loader"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^6.2.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"html-webpack-plugin"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.5.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"path-browserify"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.0.1"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"run-script-webpack-plugin"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^0.1.1"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"style-loader"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.3.1"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"ts-loader"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^9.4.2"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"typescript-plugin-styled-components"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"</span><span class="hljs-string">^2.0.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"webpack"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.75.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"webpack-bundle-analyzer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.7.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"webpack-dev-server"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.11.1"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"webpack-node-externals"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.0.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"webpackbar"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.0.2"</span>
<span class="hljs-punctuation">  }</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">After you create the <code class="inlineCode">package.json</code>, you need to create the <code class="inlineCode">tsconfig.json</code> file for <code class="inlineCode">devtools</code>. Each package will have its own <code class="inlineCode">tsconfig.json</code> file. Basically we will extend our <code class="inlineCode">tsconfig.common.json</code> from root and just specify the <code class="inlineCode">outDir</code> and include the<a id="_idIndexMarker729"/> files<a id="_idIndexMarker730"/> inside the <code class="inlineCode">src</code> folder:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"extends"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"../../tsconfig.common.json"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"outDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist"</span>
<span class="hljs-punctuation">  },</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/**/*"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 class="heading-2" id="_idParaDest-250">Creating a colorful log</h2>
<p class="normal">We need to create<a id="_idIndexMarker731"/> a log<a id="_idIndexMarker732"/> function that will help us highlight the Webpack configuration that we will implement, and for this we will use the <code class="inlineCode">cli-color</code> package, which adds colors to the logs. You need to create the file under <code class="inlineCode">packages/devtools/src/cli/log.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> cliColor <span class="hljs-keyword">from</span> <span class="hljs-string">'cli-color'</span>
type <span class="hljs-title">Args</span> = {
text?: string
tag?: string
json?: any
type?: <span class="hljs-string">'info'</span> | <span class="hljs-string">'error'</span> | <span class="hljs-string">'warning'</span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title">log</span> = (<span class="hljs-params">args: Args | any</span>) =&gt; {
<span class="hljs-keyword">const</span> <span class="hljs-attr">blockColor</span>: any = {
<span class="hljs-attr">info</span>: cliColor.<span class="hljs-property">bgCyan</span>.<span class="hljs-property">whiteBright</span>.<span class="hljs-property">bold</span>,
<span class="hljs-attr">error</span>: cliColor.<span class="hljs-property">bgRed</span>.<span class="hljs-property">whiteBright</span>.<span class="hljs-property">bold</span>,
<span class="hljs-attr">warning</span>: cliColor.<span class="hljs-property">bgYellow</span>.<span class="hljs-property">blackBright</span>.<span class="hljs-property">bold</span>
}
<span class="hljs-keyword">const</span> <span class="hljs-attr">textColor</span>: any = {
<span class="hljs-attr">info</span>: cliColor.<span class="hljs-property">blue</span>,
<span class="hljs-attr">error</span>: cliColor.<span class="hljs-property">red</span>,
<span class="hljs-attr">warning</span>: cliColor.<span class="hljs-property">yellow</span>
}
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> args === <span class="hljs-string">'string'</span>) {
<span class="hljs-variable">console</span>.<span class="hljs-title">info</span>(textColor.<span class="hljs-title">info</span>(args))
}
<span class="hljs-keyword">const</span> { tag, json, type } = args
<span class="hljs-keyword">if</span> (tag &amp;&amp; json) {
<span class="hljs-variable">console</span>.<span class="hljs-title">info</span>(blockColor[type](<span class="hljs-string">`&lt;&lt;&lt; BEGIN </span><span class="hljs-subst">${tag.toUpperCase()}</span><span class="hljs-string">`</span>))
<span class="hljs-variable">console</span>.<span class="hljs-title">info</span>(textColor[type](<span class="hljs-title">JSON</span>.<span class="hljs-title">stringify</span>(json, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)))
<span class="hljs-variable">console</span>.<span class="hljs-title">info</span>(blockColor[type](<span class="hljs-string">`END </span><span class="hljs-subst">${tag.toUpperCase()}</span><span class="hljs-string"> &gt;&gt;&gt;`</span>))
 }
 }
</code></pre>
<h2 class="heading-2" id="_idParaDest-251">Webpack common configuration</h2>
<p class="normal">Now that we have <a id="_idIndexMarker733"/>our log<a id="_idIndexMarker734"/> function ready, we will continue creating the Webpack configuration. We will break our Webpack configuration into three files: <code class="inlineCode">webpack.common.ts</code>, <code class="inlineCode">webpack.development.ts</code>, and <code class="inlineCode">webpack.production.ts</code>. The common configuration will be merged with the development and production separately. However, before creating our common configuration, we need to create our Webpack types, and you need to add this file to <code class="inlineCode">packages/devtools/src/webpack/webpack.types.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">export</span> type <span class="hljs-title">WebpackMode</span> = <span class="hljs-string">'production'</span> | <span class="hljs-string">'development'</span>
<span class="hljs-keyword">export</span> type <span class="hljs-title">ConfigType</span> = <span class="hljs-string">'web'</span> | <span class="hljs-string">'</span><span class="hljs-string">package'</span>
<span class="hljs-keyword">export</span> type <span class="hljs-title">Package</span> = <span class="hljs-string">'api'</span> | <span class="hljs-string">'design-system'</span> | <span class="hljs-string">'frontend'</span> | <span class="hljs-string">'utils'</span>
<span class="hljs-keyword">export</span> type <span class="hljs-title">ConfigArgs</span> = {
<span class="hljs-attr">mode</span>: <span class="hljs-title">WebpackMode</span>
<span class="hljs-attr">type</span>: <span class="hljs-title">ConfigType</span>
sandbox?: <span class="hljs-string">'true'</span> | <span class="hljs-string">'false'</span>
<span class="hljs-attr">packageName</span>: <span class="hljs-title">Package</span>
}
<span class="hljs-keyword">export</span> type <span class="hljs-title">ModeArgs</span> = {
<span class="hljs-attr">configType</span>: <span class="hljs-title">ConfigType</span>
<span class="hljs-attr">packageName</span>: <span class="hljs-title">Package</span>
mode?: <span class="hljs-title">WebpackMode</span>
sandbox?: boolean
devServer?: boolean
isAnalyze?: boolean
port?: number
analyzerPort?: number
color?: string
htmlOptions?: {
<span class="hljs-attr">title</span>: string
<span class="hljs-attr">template</span>: string
}
}
</code></pre>
<p class="normal">Now let’s create our <code class="inlineCode">webpack.common.ts</code> file, starting with the packages we need to import:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> <span class="hljs-title">HtmlWebPackPlugin</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'html-webpack-plugin'</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
<span class="hljs-keyword">import</span> createStyledComponentsTransformer <span class="hljs-keyword">from</span> <span class="hljs-string">'typescript-plugin-styled-components'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Configuration</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">BundleAnalyzerPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack-bundle-analyzer'</span>
<span class="hljs-keyword">import</span> nodeExternals <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack-node-externals'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">ModeArgs</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./webpack.types'</span>
</code></pre>
<p class="normal">Next we need to <a id="_idIndexMarker735"/>create<a id="_idIndexMarker736"/> the <code class="inlineCode">getWebpackCommonConfig</code> function, which will receive arguments from the terminal to compile each package via the NPM script:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">const</span> getWebpackCommonConfig = (<span class="hljs-attr">args</span>: <span class="hljs-title">ModeArgs</span>): <span class="hljs-params">Configuration</span><span class="hljs-function"> =&gt;</span> {
<span class="hljs-keyword">const</span> {
configType, <span class="hljs-comment">// it can be "web" or "package"</span>
isAnalyze,
port = <span class="hljs-number">3000</span>,
mode,
analyzerPort = <span class="hljs-number">9001</span>,
packageName,
htmlOptions,
sandbox,
devServer
} = args
<span class="hljs-comment">// Here goes the next block of codes</span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> getWebpackCommonConfig
</code></pre>
<p class="normal">The blocks of code that you will see next from this chapter’s GitHub repository need to be added where the comment is located in the previous code: <code class="inlineCode">// Here goes the next block of codes</code>.</p>
<p class="normal">First let’s check if we are running a sandbox (this will be for our design-system package). If yes, we will use port <code class="inlineCode">8080</code>, and if not, we will use the <code class="inlineCode">port + 1</code> (<code class="inlineCode">3001</code><strong class="keyWord"> </strong>by default):</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">const</span> devServerPort = sandbox &amp;&amp; devServer ? <span class="hljs-number">8080</span> : port + <span class="hljs-number">1</span>
</code></pre>
<p class="normal">The first configuration option we need to create is <code class="inlineCode">entry</code>, which will define the index file that we will use to compile our project, based on the <code class="inlineCode">packageName</code> we specify in our script. We can create <code class="inlineCode">entry</code> by running the following code:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Client Entry</span>
<span class="hljs-keyword">const</span> entry = configType !== <span class="hljs-string">'web'</span>
? path.<span class="hljs-title">resolve</span>(__dirname, <span class="hljs-string">`../../../</span><span class="hljs-subst">${packageName}</span><span class="hljs-string">/src/index.ts`</span>)
: path.<span class="hljs-title">resolve</span>(__dirname, <span class="hljs-string">`../../../</span><span class="hljs-subst">${packageName}</span><span class="hljs-string">/src/index.tsx`</span>)
</code></pre>
<p class="normal">When our <code class="inlineCode">configType</code> is <code class="inlineCode">"package"</code> (or different than <code class="inlineCode">'web'</code>), we will specify the <code class="inlineCode">index.ts</code> as <code class="inlineCode">entry</code>, and for the web packages, we will use <code class="inlineCode">index.tsx</code>.</p>
<p class="normal">The second <a id="_idIndexMarker737"/>configuration <a id="_idIndexMarker738"/>option we need to create is going to be the <code class="inlineCode">resolve</code> node, which will include the extensions we want to support and the alias for each package (<code class="inlineCode">~</code>). In Webpack 5, we must turn off some fallback packages that are not enabled by default anymore:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Resolve</span>
<span class="hljs-keyword">const</span> resolve = {
<span class="hljs-attr">extensions</span>: [<span class="hljs-string">'*'</span>, <span class="hljs-string">'.ts'</span>, <span class="hljs-string">'.tsx'</span>, <span class="hljs-string">'.js'</span>, <span class="hljs-string">'.jsx'</span>],
<span class="hljs-attr">alias</span>: {
<span class="hljs-string">'~'</span>: path.<span class="hljs-title">resolve</span>(__dirname, <span class="hljs-string">`../../../</span><span class="hljs-subst">${packageName}</span><span class="hljs-string">/src`</span>)
},
<span class="hljs-attr">fallback</span>: {
<span class="hljs-attr">buffer</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">crypto</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">stream</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">querystring</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">os</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">zlib</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">http</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">https</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">url</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">path</span>: <span class="hljs-built_in">require</span>.<span class="hljs-title">resolve</span>(<span class="hljs-string">'path-browserify'</span>)
}
}
</code></pre>
<p class="normal">The third configuration option is the <code class="inlineCode">output</code>, which will specify where we will place the compiled project (the <code class="inlineCode">dist</code> directory), which will be the dynamic filename (<code class="inlineCode">[name].js</code>). If we want to compile a package, we will add the necessary options to be able to export that package (<code class="inlineCode">libraryTarget</code>, <code class="inlineCode">library</code>, <code class="inlineCode">umdNamedDefine</code>, and <code class="inlineCode">globalObject</code>):</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Output</span>
<span class="hljs-keyword">const</span> output = {
 <span class="hljs-attr">path</span>: path.<span class="hljs-title">resolve</span>(__dirname, <span class="hljs-string">`../../../</span><span class="hljs-subst">${packageName}</span><span class="hljs-string">/dist`</span>),
 <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].js'</span>,
 ...(sandbox &amp;&amp; {
 <span class="hljs-attr">publicPath</span>: <span class="hljs-string">'/'</span>,
 <span class="hljs-attr">chunkFilename</span>: <span class="hljs-string">'[name].js'</span>
 }),
 ...(configType === <span class="hljs-string">'</span><span class="hljs-string">package'</span> &amp;&amp; !sandbox &amp;&amp; {
 <span class="hljs-attr">filename</span>: <span class="hljs-string">'index.js'</span>,
 <span class="hljs-attr">libraryTarget</span>: <span class="hljs-string">'umd'</span>,
 <span class="hljs-attr">library</span>: <span class="hljs-string">'lib'</span>,
 <span class="hljs-attr">umdNamedDefine</span>: <span class="hljs-literal">true</span>,
 <span class="hljs-attr">globalObject</span>: <span class="hljs-string">'</span><span class="hljs-string">this'</span>
 })
}
</code></pre>
<p class="normal">The fourth<a id="_idIndexMarker739"/> configuration<a id="_idIndexMarker740"/> option is the <code class="inlineCode">plugins</code>, which will be applied based on some conditions, depending on if we want to analyze our bundle sizes (<code class="inlineCode">BundleAnalyzerPlugin</code>) and add a template with <code class="inlineCode">HtmlWebPackPlugin</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Plugins</span>
<span class="hljs-keyword">const</span> plugins = []
<span class="hljs-keyword">if</span> (isAnalyze) {
plugins.<span class="hljs-title">push</span>(
<span class="hljs-keyword">new</span> <span class="hljs-title">BundleAnalyzerPlugin</span>({
analyzerPort
})
)
}
<span class="hljs-keyword">if</span> (mode === <span class="hljs-string">'development'</span> &amp;&amp; htmlOptions?.<span class="hljs-property">title</span> &amp;&amp; htmlOptions.<span class="hljs-property">template</span>) {
plugins.<span class="hljs-title">push</span>(
<span class="hljs-keyword">new</span> <span class="hljs-title">HtmlWebPackPlugin</span>({
<span class="hljs-attr">title</span>: htmlOptions.<span class="hljs-property">title</span>,
<span class="hljs-attr">template</span>: path.<span class="hljs-title">resolve</span>(__dirname, <span class="hljs-string">`../../../</span><span class="hljs-subst">${packageName}</span><span class="hljs-string">/</span><span class="hljs-subst">${htmlOptions.template}</span><span class="hljs-string">`</span>),
<span class="hljs-attr">filename</span>: <span class="hljs-string">'./index.xhtml'</span>
})
)
}
</code></pre>
<p class="normal">The fifth configuration option is the <code class="inlineCode">rules</code>, which we will define depending on the extension file we want to process. We will also use Webpack loaders like <code class="inlineCode">ts-loader</code> to load TypeScript <a id="_idIndexMarker741"/>files <a id="_idIndexMarker742"/>or <code class="inlineCode">svg-url-loader</code> and <code class="inlineCode">@svgr/webpack</code> to load SVG files:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Rules</span>
<span class="hljs-keyword">const</span> rules = []
rules.<span class="hljs-title">push</span>({
<span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(tsx|ts)$/</span>,
<span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules/</span>,
<span class="hljs-attr">loader</span>: <span class="hljs-string">'ts-loader'</span>,
<span class="hljs-attr">options</span>: {
<span class="hljs-attr">getCustomTransformers</span>: <span class="hljs-function">() =&gt;</span> ({
 <span class="hljs-attr">before</span>: [
<span class="hljs-title">createStyledComponentsTransformer</span>({
 <span class="hljs-attr">displayName</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">ssr</span>: <span class="hljs-literal">true</span>,
 <span class="hljs-attr">minify</span>: <span class="hljs-literal">true</span>
 })
 ]
 })
}
})
<span class="hljs-keyword">if</span> (packageName === <span class="hljs-string">'design-system'</span>) {
<span class="hljs-keyword">const</span> <span class="hljs-attr">svgUrlLoaderInclude</span>: <span class="hljs-title">Record</span>&lt;string, string[]&gt; = {
<span class="hljs-string">'design-system'</span>: [
path.<span class="hljs-title">resolve</span>(__dirname, <span class="hljs-string">'</span><span class="hljs-string">../../../design-system/src/components/Spinner/loaders'</span>),
path.<span class="hljs-title">resolve</span>(__dirname, <span class="hljs-string">'../../../design-system/src/components/Dialog/icons'</span>),
path.<span class="hljs-title">resolve</span>(__dirname, <span class="hljs-string">'../../../design-system/src/icons'</span>)
]
}
<span class="hljs-keyword">const</span> <span class="hljs-attr">svgrWebpackInclude</span>: <span class="hljs-title">Record</span>&lt;string, string[]&gt; = {
<span class="hljs-string">'design-system'</span>: [
path.<span class="hljs-title">resolve</span>(__dirname, <span class="hljs-string">'</span><span class="hljs-string">../../../design-system/src/components/Icon/icons'</span>)
]
}
rules.<span class="hljs-title">push</span>({
<span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.svg$/</span>,
<span class="hljs-attr">oneOf</span>: [
{
<span class="hljs-attr">use</span>: <span class="hljs-string">'svg-url-loader'</span>,
<span class="hljs-attr">include</span>: configType === <span class="hljs-string">'package'</span> ? svgUrlLoaderInclude[packageName] ?? [] : []
},
{
<span class="hljs-attr">use</span>: <span class="hljs-string">'</span><span class="hljs-string">@svgr/webpack'</span>,
<span class="hljs-attr">include</span>: configType === <span class="hljs-string">'package'</span> ? svgrWebpackInclude[packageName] ?? [] : []
}
]
})
}
<span class="hljs-keyword">if</span> (configType === <span class="hljs-string">'package'</span> &amp;&amp; sandbox) {
rules.<span class="hljs-title">push</span>({
<span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(jpe?g|png|gif|svg)$/i</span>,
<span class="hljs-attr">use</span>: [{ <span class="hljs-attr">loader</span>: <span class="hljs-string">'</span><span class="hljs-string">file-loader'</span>, <span class="hljs-attr">options</span>: {} }]
})
}
</code></pre>
<p class="normal">Finally, we put all<a id="_idIndexMarker743"/> the <a id="_idIndexMarker744"/>options together in the <code class="inlineCode">webpackConfig</code> object:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">const</span> webpackConfig = {
entry,
...(configType === <span class="hljs-string">'package'</span> &amp;&amp; sandbox &amp;&amp; {
<span class="hljs-attr">entry</span>: path.<span class="hljs-title">resolve</span>(__dirname, <span class="hljs-string">`../../../</span><span class="hljs-subst">${packageName}</span><span class="hljs-string">/sandbox/index.tsx`</span>)
}),
...(devServer &amp;&amp; {
<span class="hljs-attr">devServer</span>: {
<span class="hljs-attr">historyApiFallback</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">static</span>: output.<span class="hljs-property">path</span>,
<span class="hljs-attr">port</span>: devServerPort
}
}),
...(!sandbox &amp;&amp; {
<span class="hljs-attr">externals</span>: [<span class="hljs-title">nodeExternals</span>()]
}),
output,
resolve,
plugins,
<span class="hljs-attr">module</span>: {
rules
},
...(configType !== <span class="hljs-string">'web'</span> &amp;&amp; !sandbox &amp;&amp; {
<span class="hljs-attr">target</span>: <span class="hljs-string">'node'</span>
})
}
<span class="hljs-keyword">return</span> webpackConfig <span class="hljs-keyword">as</span> <span class="hljs-title">Configuration</span>
</code></pre>
<h2 class="heading-2" id="_idParaDest-252">Webpack development configuration</h2>
<p class="normal">After creating our <a id="_idIndexMarker745"/>Webpack<a id="_idIndexMarker746"/> common configuration file, we now need to create our <code class="inlineCode">webpack.development.ts</code> file, which is way smaller than the common one and will extend that configuration (on <code class="inlineCode">webpack.config.ts</code>), specifying the development mode for Webpack, adding the source map, and passing the <code class="inlineCode">HMR</code> plugin:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> {
<span class="hljs-title">Configuration</span> <span class="hljs-keyword">as</span> <span class="hljs-title">WebpackConfiguration</span>,
<span class="hljs-title">HotModuleReplacementPlugin</span>,
<span class="hljs-title">NoEmitOnErrorsPlugin</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Configuration</span> <span class="hljs-keyword">as</span> <span class="hljs-title">WebpackDevServerConfiguration</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack-dev-server'</span>
interface <span class="hljs-title">Configuration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebpackConfiguration</span> {
devServer?: <span class="hljs-title">WebpackDevServerConfiguration</span>
}
<span class="hljs-keyword">const</span> getWebpackDevelopmentConfig = (): <span class="hljs-params">Configuration</span><span class="hljs-function"> =&gt;</span> {
<span class="hljs-keyword">const</span> <span class="hljs-attr">webpackConfig</span>: <span class="hljs-title">Configuration</span> = {
<span class="hljs-attr">mode</span>: <span class="hljs-string">'development'</span>,
<span class="hljs-attr">devtool</span>: <span class="hljs-string">'source-map'</span>,
<span class="hljs-attr">plugins</span>: [<span class="hljs-keyword">new</span> <span class="hljs-title">HotModuleReplacementPlugin</span>(), <span class="hljs-keyword">new</span> <span class="hljs-title">NoEmitOnErrorsPlugin</span>()]
}
<span class="hljs-keyword">return</span> webpackConfig
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> getWebpackDevelopmentConfig
</code></pre>
<h2 class="heading-2" id="_idParaDest-253">Webpack production configuration</h2>
<p class="normal">The last file we<a id="_idIndexMarker747"/> need <a id="_idIndexMarker748"/>to create is the <code class="inlineCode">webpack.production.ts</code>, which will will use external libraries when we try to compile a package that uses shared<a id="_idIndexMarker749"/> libraries<a id="_idIndexMarker750"/> like <strong class="keyWord">React</strong>, <strong class="keyWord">Apollo Server</strong>, or <strong class="keyWord">JSON Web Tokens</strong>, put <a id="_idIndexMarker751"/>the <code class="inlineCode">mode</code> as production, and disable the source map:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">Configuration</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">ModeArgs</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./webpack.types'</span>
<span class="hljs-keyword">const</span> getWebpackProductionConfig = (<span class="hljs-attr">args</span>: <span class="hljs-title">ModeArgs</span>): <span class="hljs-params">Configuration</span><span class="hljs-function"> =&gt;</span> {
<span class="hljs-keyword">const</span> { configType } = args
<span class="hljs-comment">// Externals</span>
<span class="hljs-keyword">const</span> externals = configType === <span class="hljs-string">'package'</span>
? {
<span class="hljs-attr">react</span>: {
<span class="hljs-attr">commonjs</span>: <span class="hljs-string">'react'</span>,
<span class="hljs-attr">commonjs2</span>: <span class="hljs-string">'react'</span>,
<span class="hljs-attr">amd</span>: <span class="hljs-string">'React'</span>,
<span class="hljs-attr">root</span>: <span class="hljs-string">'React'</span>
},
<span class="hljs-string">'react-dom'</span>: {
<span class="hljs-attr">commonjs</span>: <span class="hljs-string">'react-dom'</span>,
<span class="hljs-attr">commonjs2</span>: <span class="hljs-string">'react-dom'</span>,
<span class="hljs-attr">amd</span>: <span class="hljs-string">'ReactDOM'</span>,
<span class="hljs-attr">root</span>: <span class="hljs-string">'ReactDOM'</span>
},
<span class="hljs-string">'apollo-server-express'</span>: <span class="hljs-string">'apollo-server-express'</span>,
<span class="hljs-attr">jsonwebtoken</span>: <span class="hljs-string">'jsonwebtoken'</span>
}
: {}
<span class="hljs-keyword">const</span> webpackConfig = {
<span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>,
<span class="hljs-attr">devtool</span>: <span class="hljs-literal">false</span>,
externals
}
<span class="hljs-keyword">return</span> webpackConfig <span class="hljs-keyword">as</span> <span class="hljs-title">Configuration</span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> getWebpackProductionConfig
</code></pre>
<p class="normal">That’s all for our <code class="inlineCode">devtools</code> package. Now we only need to create the <code class="inlineCode">index.ts</code> file in <code class="inlineCode">packages/devtools/src/index.ts</code> to export all the Webpack configuration and be able to compile our <code class="inlineCode">devtools</code> package:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// CLI</span>
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./cli/log'</span>
<span class="hljs-comment">// Webpack</span>
<span class="hljs-keyword">export</span> { <span class="hljs-keyword">default</span> <span class="hljs-keyword">as</span> getWebpackCommonConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'./webpack/webpack.common'</span>
<span class="hljs-keyword">export</span> { <span class="hljs-keyword">default</span> <span class="hljs-keyword">as</span> getWebpackDevelopmentConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'./webpack/webpack.development'</span>
<span class="hljs-keyword">export</span> { <span class="hljs-keyword">default</span> <span class="hljs-keyword">as</span> getWebpackProductionConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'./webpack/webpack.production'</span>
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./webpack/webpack.types'</span>
</code></pre>
<p class="normal">Since this will be the base package that will compile other packages, first we need to build it, and for this, we will just use the <code class="inlineCode">tsc</code> command to transform TypeScript into <a id="_idIndexMarker752"/>JavaScript<a id="_idIndexMarker753"/> files. For this, you just need to run the <code class="inlineCode">build</code> command inside <code class="inlineCode">packages/devtools</code>:</p>
<pre class="programlisting con"><code class="hljs-con">npm run build
</code></pre>
<p class="normal">If everything is correct, you should see something like this:</p>
<p class="packt_figref"><img alt="Text  Description automatically generated" height="271" src="../Images/B18414_14_06.png" width="356"/></p>
<p class="packt_figref">Figure 14.6: npm run build</p>
<p class="normal">Finally, we need to create the <code class="inlineCode">webpack.config.ts</code> file at the root level where we will consume our brand-new <code class="inlineCode">devtools</code> package and merge the configurations (development + common or production + common) using <code class="inlineCode">webpack-merge</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> {
<span class="hljs-title">ConfigArgs</span>,
getWebpackCommonConfig,
getWebpackDevelopmentConfig,
getWebpackProductionConfig,
log
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@web-creator/devtools'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Configuration</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>
<span class="hljs-keyword">import</span> { merge } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack-merge'</span>
<span class="hljs-comment">// Mode Config</span>
<span class="hljs-keyword">const</span> getModeConfig = {
<span class="hljs-attr">development</span>: getWebpackDevelopmentConfig,
<span class="hljs-attr">production</span>: getWebpackProductionConfig
}
<span class="hljs-comment">// Mode Configuration (development/production)</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">modeConfig</span>: <span class="hljs-function">(</span><span class="hljs-params">args: ConfigArgs</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">Configuration</span> = <span class="hljs-function">(</span><span class="hljs-params">{mode, type, packageName}</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-keyword">const</span> getWebpackConfiguration = getModeConfig[mode]
<span class="hljs-keyword">return</span> <span class="hljs-title">getWebpackConfiguration</span>({ 
<span class="hljs-attr">configType</span>: type, 
packageName, 
<span class="hljs-attr">sandbox</span>: <span class="hljs-literal">true</span>, 
<span class="hljs-attr">devServer</span>: <span class="hljs-literal">true</span> 
})
}
<span class="hljs-comment">// Merging all configurations</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">webpackConfig</span>: <span class="hljs-function">(</span><span class="hljs-params">args: ConfigArgs</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">Configuration</span>&gt; = <span class="hljs-keyword">async</span> ({ 
mode, type, sandbox, packageName 
} = {
<span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>,
<span class="hljs-attr">type</span>: <span class="hljs-string">'web'</span>,
<span class="hljs-attr">sandbox</span>: <span class="hljs-string">'false'</span>,
<span class="hljs-attr">packageName</span>: <span class="hljs-string">'design-system'</span>
}) =&gt; {
<span class="hljs-keyword">const</span> isSandbox = type === <span class="hljs-string">'package'</span> &amp;&amp; sandbox === <span class="hljs-string">'true'</span>
<span class="hljs-keyword">const</span> commonConfiguration = <span class="hljs-title">getWebpackCommonConfig</span>({
<span class="hljs-attr">configType</span>: type,
packageName,
mode,
...(isSandbox &amp;&amp; {
<span class="hljs-attr">htmlOptions</span>: { <span class="hljs-attr">title</span>: <span class="hljs-string">'Sandbox'</span>, <span class="hljs-attr">template</span>: <span class="hljs-string">'sandbox/index.xhtml'</span> },
<span class="hljs-attr">sandbox</span>: isSandbox,
<span class="hljs-attr">devServer</span>: isSandbox
})
})
<span class="hljs-comment">// Mode Configuration</span>
<span class="hljs-keyword">const</span> modeConfiguration = mode &amp;&amp; type ? <span class="hljs-title">modeConfig</span>({ mode, type, packageName }) : {}
<span class="hljs-comment">// Merging all configurations</span>
<span class="hljs-keyword">const</span> webpackConfiguration = <span class="hljs-title">merge</span>(commonConfiguration, modeConfiguration)
<span class="hljs-comment">// Logging Webpack Configuration</span>
<span class="hljs-title">log</span>({ <span class="hljs-attr">tag</span>: <span class="hljs-string">'Webpack Configuration'</span>, <span class="hljs-attr">json</span>: webpackConfiguration, <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span> })
<span class="hljs-keyword">return</span> webpackConfiguration
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> webpackConfig
</code></pre>
<h1 class="heading-1" id="_idParaDest-254">Creating the utils package</h1>
<p class="normal">After we’ve created <a id="_idIndexMarker754"/>the <code class="inlineCode">devtools</code> package, it is time to add a basic <code class="inlineCode">utils</code> package to test the Webpack compilation with <code class="inlineCode">devtools</code>. For this, you will need to create a directory at <code class="inlineCode">packages/utils</code>. For the example in the book, we will just add one <code class="inlineCode">util</code> file to test our <code class="inlineCode">devtools</code>, but in the actual repository you will find way more <code class="inlineCode">util</code> files that have been added to the project.</p>
<p class="normal">As always let’s start creating our <code class="inlineCode">package.json</code> in the <code class="inlineCode">utils</code> package:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@web-creator/utils"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist/index.js"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist/index.d.ts"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
<span class="hljs-punctuation">    </span><span class="hljs-string">"dist"</span>
<span class="hljs-punctuation">  ],</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cross-env NODE_ENV=production npm-run-all clean compile webpack:production"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"build:dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cross-env NODE_ENV=development npm-run-all clean compile webpack:development"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"clean"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rm -rf ./dist"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"compile"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run --prefix ../../ lint"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"lint:fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run --prefix ../../ lint:fix"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"prepublishOnly"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"</span><span class="hljs-string">npm run lint &amp;&amp; npm run build"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"webpack:development"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack --config=../../webpack.config.ts --env mode=development --env type=package --env packageName=utils"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"webpack:production"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack --config=../../webpack.config.ts --env mode=production --env type=package --env packageName=utils"</span>
<span class="hljs-punctuation">  },</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carlos Santana"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"currency-formatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.5.9"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"slug"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.2.2"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"uuid"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^9.0.0"</span>
<span class="hljs-punctuation">  },</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@types/currency-formatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"</span><span class="hljs-string">^1.5.1"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@types/slug"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.0.3"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@types/uuid"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^9.0.0"</span>
<span class="hljs-punctuation">  }</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">There are some important elements in this <code class="inlineCode">package.json</code> that I want to mention:</p>
<ul>
<li class="bulletList">The first one is the name of the package, which is <code class="inlineCode">@web-creator/utils</code>. As I mentioned before, this is the correct format to name packages inside our MonoRepo. </li>
<li class="bulletList">The second node is <code class="inlineCode">version</code>, which always will be <code class="inlineCode">1.0.0</code> (unless you want to publish this package to the NPM registry; for now you don’t need to worry about that). </li>
<li class="bulletList"><code class="inlineCode">main</code> is to specify where our <code class="inlineCode">utils</code> code will exist, which will always be in <code class="inlineCode">dist/index.js</code>. </li>
<li class="bulletList">The <code class="inlineCode">types</code> node is to be able to load our TypeScript types; if you don’t specify this, it won’t be possible to see the types you add to your <code class="inlineCode">utils</code> package when you consume this package. </li>
<li class="bulletList">Finally the <code class="inlineCode">files</code> node is an array that will contain the <code class="inlineCode">dist</code> directory that will contain the compiled package.</li>
</ul>
<p class="normal">Additionally, the <a id="_idIndexMarker755"/>scripts have some interesting things that you should know. Our <code class="inlineCode">build</code> command will run multiple scripts using <code class="inlineCode">npm-run-all</code>, which is a library that helps us run multiple scripts one after the other. In this case, we always execute the script <code class="inlineCode">clean</code> first to remove our <code class="inlineCode">dist</code> folder and start fresh. Then we <code class="inlineCode">compile</code> the code with TypeScript (<code class="inlineCode">tsc</code>), then we execute <code class="inlineCode">webpack:production</code>. This will execute <code class="inlineCode">webpack</code>, specifying the configuration file that exists at the root (two levels behind). We also use the <code class="inlineCode">--env</code> flag to pass values as variables. </p>
<p class="normal">These variables are defined in our <code class="inlineCode">webpack.config.ts</code> file. In this case, we’re passing <code class="inlineCode">mode=production</code>, <code class="inlineCode">type=package</code>, and <code class="inlineCode">packageName=utils</code>.</p>
<p class="normal">If you notice, some scripts contain <code class="inlineCode">npm run --prefix ../../</code>, and I’m pretty sure you are wondering what exactly the <code class="inlineCode">--prefix</code> flag is in this command. It is essentially a way to tell NPM that we want to run a script from a different <code class="inlineCode">package.json</code>. In this specific example, we are going back two levels to run the script <code class="inlineCode">lint</code> that exists in our root <code class="inlineCode">package.json</code>.</p>
<p class="normal">Now let’s create our first <code class="inlineCode">util</code> file, which is going to be called <code class="inlineCode">is.ts</code>, and you must save it <a id="_idIndexMarker756"/>in <code class="inlineCode">packages/utils/src/utils/is.ts</code> with the following code:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">const</span> is = {
<span class="hljs-title">Array</span>(<span class="hljs-attr">v</span>: unknown) {
<span class="hljs-keyword">return</span> v <span class="hljs-keyword">instanceof</span> <span class="hljs-title">Array</span>
},
<span class="hljs-title">Defined</span>(<span class="hljs-attr">v</span>: unknown) {
<span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> v !== <span class="hljs-string">'undefined'</span> &amp;&amp; v !== <span class="hljs-literal">null</span>
},
<span class="hljs-title">Email</span>(<span class="hljs-attr">email</span>: string) {
<span class="hljs-keyword">const</span> regex = <span class="hljs-regexp">/^[^\s@]+@[^\s@]+\.[^\s@]+$/</span>
<span class="hljs-keyword">return</span> regex.<span class="hljs-title">test</span>(email)
},
<span class="hljs-title">False</span>(<span class="hljs-attr">v</span>: unknown) {
<span class="hljs-keyword">return</span> (<span class="hljs-variable">this</span>.<span class="hljs-title">Defined</span>(v) &amp;&amp; v === <span class="hljs-literal">false</span>) || v === <span class="hljs-string">'false'</span>
},
<span class="hljs-title">Number</span>(<span class="hljs-attr">v</span>: unknown) {
<span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'number'</span>
},
<span class="hljs-title">Function</span>(<span class="hljs-attr">v</span>: unknown) {
<span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'function'</span>
},
<span class="hljs-title">Object</span>(<span class="hljs-attr">v</span>: unknown) {
<span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-title">Defined</span>(v) &amp;&amp; <span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'object'</span> &amp;&amp; !<span class="hljs-variable">this</span>.<span class="hljs-title">Array</span>(v)
},
<span class="hljs-title">String</span>(<span class="hljs-attr">v</span>: unknown) {
<span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-title">Defined</span>(v) &amp;&amp; <span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'string'</span>
},
<span class="hljs-title">Undefined</span>(<span class="hljs-attr">v</span>: unknown) {
<span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'undefined'</span> || v === <span class="hljs-literal">null</span>
},
<span class="hljs-title">JSON</span>(<span class="hljs-attr">str</span>: string) {
<span class="hljs-keyword">if</span> (!str || str === <span class="hljs-literal">null</span>) {
<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
<span class="hljs-keyword">try</span> {
<span class="hljs-title">JSON</span>.<span class="hljs-title">parse</span>(str)
} <span class="hljs-keyword">catch</span> (e) {
<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
},
<span class="hljs-title">Password</span>(<span class="hljs-attr">password</span>: string, min = <span class="hljs-number">8</span>) {
<span class="hljs-keyword">return</span> <span class="hljs-title">Boolean</span>(password &amp;&amp; password.<span class="hljs-property">length</span> &gt;= min)
},
<span class="hljs-title">PasswordMatch</span>(<span class="hljs-attr">p1</span>: string, <span class="hljs-attr">p2</span>: string) {
<span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-title">Password</span>(p1) &amp;&amp; <span class="hljs-variable">this</span>.<span class="hljs-title">Password</span>(p2) &amp;&amp; p1 === p2
},
<span class="hljs-title">Browser</span>() {
<span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> <span class="hljs-variable">window</span> !== <span class="hljs-string">'undefined'</span>
},
<span class="hljs-title">Device</span>() {
<span class="hljs-keyword">if</span> (!<span class="hljs-variable">this</span>.<span class="hljs-title">Browser</span>()) {
<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
<span class="hljs-keyword">const</span> ua = navigator.<span class="hljs-property">userAgent</span>
<span class="hljs-keyword">if</span> (<span class="hljs-regexp">/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i</span>.<span class="hljs-title">test</span>(ua)) {
<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}
<span class="hljs-keyword">if</span> (<span class="hljs-regexp">/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/</span>.<span class="hljs-title">test</span>(ua)) {
<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}
<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
},
<span class="hljs-title">EmptyObject</span>(<span class="hljs-attr">v</span>: any) {
<span class="hljs-keyword">return</span> v ? <span class="hljs-title">Object</span>.<span class="hljs-title">keys</span>(v).<span class="hljs-property">length</span> === <span class="hljs-number">0</span> : <span class="hljs-literal">true</span>
}
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> is
</code></pre>
<p class="normal">After you create this <code class="inlineCode">util</code>, you need to create the <code class="inlineCode">index.ts</code> file in <code class="inlineCode">packages/utils/src/index.ts</code>, where you will export all your <code class="inlineCode">utils</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">export</span> { <span class="hljs-keyword">default</span> <span class="hljs-keyword">as</span> is } <span class="hljs-keyword">from</span> <span class="hljs-string">'</span><span class="hljs-string">./utils/is'</span>
</code></pre>
<p class="normal">Finally, you must<a id="_idIndexMarker757"/> add a script to your root <code class="inlineCode">package.json</code> to be able to compile your brand-new <code class="inlineCode">utils</code> package. Here is how your root <code class="inlineCode">package.json</code> file should look:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"web-creator"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"private"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"workspaces"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
<span class="hljs-punctuation">    </span><span class="hljs-string">"packages/*"</span>
<span class="hljs-punctuation">  ],</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"</span><span class="hljs-string">eslint --ext .tsx,.ts ./packages/**/src"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"lint:fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint --ext .tsx,.ts ./packages/**/src"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm-run-all build:*"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"build:devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cd ./packages/devtools &amp;&amp; npm run build"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"build:utils"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cd ./packages/utils &amp;&amp; npm run build"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"build:authentication"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cd ./packages/authentication &amp;&amp; npm run build"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"build:design-system"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cd ./packages/design-system &amp;&amp; npm run build"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"build:api"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cd ./packages/api &amp;&amp; npm run build"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  },</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@typescript-eslint/eslint-plugin"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.49.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@typescript-eslint/parser"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.49.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"cross-env"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^7.0.3"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"eslint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.33.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"eslint-config-airbnb"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^19.0.4"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"eslint-config-airbnb-typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^17.0.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"eslint-config-prettier"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.6.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"eslint-import-resolver-typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.5.3"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"eslint-plugin-import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.27.5"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"eslint-plugin-jsx-a11y"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^6.7.1"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"eslint-plugin-prettier"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.2.1"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"eslint-plugin-react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^7.32.2"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"eslint-plugin-react-hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.6.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"npm-run-all"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.1.5"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"prettier"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.8.3"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"ts-node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^10.9.1"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.9.5"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"webpack-cli"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.0.1"</span>
<span class="hljs-punctuation">  },</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"webpack"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.75.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"webpack-merge"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.8.0"</span>
<span class="hljs-punctuation">  }</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">As you can see, we <a id="_idIndexMarker758"/>need to add a <code class="inlineCode">build:package_name</code><strong class="keyWord"> </strong>(in this case,<strong class="keyWord"> </strong><code class="inlineCode">build:utils</code>) script for each package that we want to build, and then our build script will execute all of them using <code class="inlineCode">npm-run-all build:*</code>.</p>
<p class="normal">Now you can build your <code class="inlineCode">utils</code> package by running the <code class="inlineCode">npm run build</code> script inside the <code class="inlineCode">utils</code> directory; you should see something like this:</p>
<p class="packt_figref"><img alt="Text  Description automatically generated" height="266" src="../Images/B18414_14_07.png" width="825"/></p>
<p class="packt_figref">Figure 14.7: Building utils</p>
<p class="normal">Following this, you<a id="_idIndexMarker759"/> should see the Webpack configuration log that we use to compile this package:</p>
<p class="packt_figref"><img alt="Text, timeline  Description automatically generated" height="973" src="../Images/B18414_14_08.png" width="825"/></p>
<p class="packt_figref">Figure 14.8: Webpack configuration</p>
<p class="normal">Then at the<a id="_idIndexMarker760"/> end, you will see the compiled files by Webpack:</p>
<p class="packt_figref"><img alt="Text  Description automatically generated" height="564" src="../Images/B18414_14_09.png" width="825"/></p>
<p class="packt_figref">Figure 14.9: Compiled files by Webpack</p>
<p class="normal">Now that we have <a id="_idIndexMarker761"/>created our first package, which is compiled with <code class="inlineCode">devtools</code>, and understand the structure of a package, it’s time to start working on our API.</p>
<h1 class="heading-1" id="_idParaDest-255">Creating the API package</h1>
<p class="normal">In this package, we<a id="_idIndexMarker762"/> will implement a multi-service system that will help us have more than one service to connect to multiple databases. Let’s see how our <code class="inlineCode">package.json</code> file should look for the <code class="inlineCode">api</code> package:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@web-creator/api"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"index.js"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cross-env NODE_ENV=production npm-run-all clean compile webpack:production"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"build:dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cross-env NODE_ENV=development npm-run-all clean compile webpack:development"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"clean"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rm -rf ./dist"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"compile"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ts-node-dev src/index.ts"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run --prefix ../../ lint"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"lint:fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"</span><span class="hljs-string">npm run --prefix ../../ lint:fix"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"webpack:development"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack --config=../../webpack.config.ts --env mode=production --env type=api --env packageName=api"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"webpack:production"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack --config=../../webpack.config.ts --env mode=development --env type=api --env packageName=api"</span>
<span class="hljs-punctuation">  },</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carlos Santana"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">  </span><span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@graphql-tools/merge"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"8.3.18"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@graphql-tools/schema"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"9.0.16"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@web-creator/authentication"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@web-creator/utils"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.0.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@apollo/server"</span><span class="hljs-punctuation">:</span><span class="hljs-attr"> </span><span class="hljs-string">"^4.7.3"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"cookie-parser"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.4.6"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"cors"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.8.5"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"dotenv"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^16.0.3"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"express"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.18.2"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"graphql"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"16.6.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"graphql-middleware"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"6.1.33"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"graphql-tag"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.12.6"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"isomorphic-fetch"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.0.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"jsonwebtoken"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^9.0.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"pg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"</span><span class="hljs-string">^8.9.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"pg-hstore"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.3.4"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"pg-native"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.0.1"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"sequelize"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^6.28.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"sequelize-typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.1.5"</span>
<span class="hljs-punctuation">  },</span>
<span class="hljs-attr">  "devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@types/body-parser"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.19.2"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@types/express-jwt"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^6.0.4"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@types/jsonwebtoken"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^9.0.1"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@types/cors"</span>: <span class="hljs-string">"^2.8.13"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@types/node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.11.18"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@types/pg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"</span><span class="hljs-string">^8.6.6"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"ts-node-dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0.0"</span>
<span class="hljs-punctuation">  }</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">In this case, we will <a id="_idIndexMarker763"/>use Sequelize (an ORM) and PostgreSQL for the database, but feel free to use MySQL or any other type of database supported by Sequelize.</p>
<p class="normal">In the following sections, we’ll guide you through each of these steps in detail. We’ll demonstrate how to integrate all the components and successfully operate your CRM service. If it appears complex, there’s no need to worry. We’ll proceed at a steady pace<a id="_idIndexMarker764"/> and provide explanations along the way.</p>
<h2 class="heading-2" id="_idParaDest-256">Creating a user-shared model</h2>
<p class="normal">The first thing we <a id="_idIndexMarker765"/>need to create is our<a id="_idIndexMarker766"/> shared model, which for now will be only the <code class="inlineCode">User</code> model, to be able to create a shared authentication system for all our sites.</p>
<p class="normal">You must create the <code class="inlineCode">User</code> model file in <code class="inlineCode">packages/models/User.ts</code>, which will create a table with the following fields: <code class="inlineCode">id</code> (<code class="inlineCode">UUID</code>), <code class="inlineCode">username</code> (<code class="inlineCode">STRING)</code>, <code class="inlineCode">password</code> (<code class="inlineCode">STRING</code>), <code class="inlineCode">Email</code> (<code class="inlineCode">STRING</code>), <code class="inlineCode">Role</code> (<code class="inlineCode">STRING</code>), and <code class="inlineCode">active</code> (<code class="inlineCode">BOOLEAN</code>):</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { security } <span class="hljs-keyword">from</span> <span class="hljs-string">'@web-creator/utils'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">DataType</span>, <span class="hljs-title">Sequelize</span>, <span class="hljs-title">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../types'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> (<span class="hljs-attr">sequelize</span>: <span class="hljs-title">Sequelize</span>, <span class="hljs-attr">dataType</span>: <span class="hljs-title">DataType</span>): <span class="hljs-params">User</span><span class="hljs-function"> =&gt;</span> {
<span class="hljs-keyword">const</span> user = sequelize.<span class="hljs-title">define</span>(<span class="hljs-string">'User'</span>, {
<span class="hljs-attr">id</span>: {
<span class="hljs-attr">primaryKey</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">type</span>: dataType.<span class="hljs-property">UUID</span>,
<span class="hljs-attr">defaultValue</span>: dataType.<span class="hljs-title">UUIDV4</span>()
},
<span class="hljs-attr">username</span>: {
<span class="hljs-attr">type</span>: dataType.<span class="hljs-property">STRING</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">validate</span>: {
<span class="hljs-attr">isAlphanumeric</span>: {
<span class="hljs-attr">args</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">msg</span>: <span class="hljs-string">'The user just accepts alphanumeric characters'</span>
},
<span class="hljs-attr">len</span>: {
<span class="hljs-attr">args</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">20</span>],
<span class="hljs-attr">msg</span>: <span class="hljs-string">'The username must be from 4 to 20 characters'</span>
}
}
},
<span class="hljs-attr">password</span>: {
<span class="hljs-attr">type</span>: dataType.<span class="hljs-property">STRING</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>
},
<span class="hljs-attr">email</span>: {
<span class="hljs-attr">type</span>: dataType.<span class="hljs-property">STRING</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">validate</span>: {
<span class="hljs-attr">isEmail</span>: {
<span class="hljs-attr">args</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">msg</span>: <span class="hljs-string">'Invalid email'</span>
}
}
},
<span class="hljs-attr">role</span>: {
<span class="hljs-attr">type</span>: dataType.<span class="hljs-property">STRING</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>
},
<span class="hljs-attr">active</span>: {
<span class="hljs-attr">type</span>: dataType.<span class="hljs-property">BOOLEAN</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">defaultValue</span>: <span class="hljs-literal">false</span>
 }
},
{
<span class="hljs-attr">hooks</span>: {
<span class="hljs-attr">beforeCreate</span>: (<span class="hljs-attr">u</span>: <span class="hljs-title">User</span>): <span class="hljs-params">void</span><span class="hljs-function"> =&gt;</span> {
u.<span class="hljs-property">password</span> = security.<span class="hljs-title">encrypt</span>(u.<span class="hljs-property">password</span>)
}
}
}
)
<span class="hljs-keyword">return</span> user
}
</code></pre>
<h2 class="heading-2" id="_idParaDest-257">Creating a user-shared GraphQL type and resolver</h2>
<p class="normal">Besides the <code class="inlineCode">User</code>-shared<a id="_idIndexMarker767"/> model, we <a id="_idIndexMarker768"/>need to create a shared GraphQL <strong class="keyWord">type</strong> and <strong class="keyWord">resolver</strong>, in order to handle the authentication using GraphQL on all our sites.</p>
<p class="normal">First we need to create another shared GraphQL type called <code class="inlineCode">error</code>, which will help us handle errors on any of the queries or mutations we will create later. This file exists in <code class="inlineCode">packages/api/src/graphql/types/Error.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> gql <span class="hljs-keyword">from</span> <span class="hljs-string">'graphql-tag'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> gql<span class="hljs-string">`</span>
<span class="hljs-string">type ErrorResponse {</span>
<span class="hljs-string">code: Int</span>
<span class="hljs-string">message: String!</span>
<span class="hljs-string">}</span>
<span class="hljs-string"> </span>
<span class="hljs-string">type Error {</span>
<span class="hljs-string">error: ErrorResponse</span>
<span class="hljs-string">}</span>
<span class="hljs-string">`</span>
</code></pre>
<p class="normal">Another shared type that we need to create is the scalar one, which will define scalar types like <code class="inlineCode">UUID</code>, <code class="inlineCode">Datetime</code>, and <code class="inlineCode">JSON</code>. This file exists in <code class="inlineCode">packages/api/src/graphql/types/Scalar.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> gql <span class="hljs-keyword">from</span> <span class="hljs-string">'graphql-tag'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> gql<span class="hljs-string">`</span>
<span class="hljs-string">scalar UUID</span>
<span class="hljs-string">scalar Datetime</span>
<span class="hljs-string">scalar JSON</span>
<span class="hljs-string">`</span>
</code></pre>
<p class="normal">Finally, we need to create our <code class="inlineCode">User</code> type, which will include some queries to get a specific user via an access token (<code class="inlineCode">at</code>), get all users, and get some mutations to create a new <a id="_idIndexMarker769"/>user and <a id="_idIndexMarker770"/>also to log in. This file should be placed in <code class="inlineCode">packages/api/src/graphql/types/User.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> gql <span class="hljs-keyword">from</span> <span class="hljs-string">'graphql-tag'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> gql<span class="hljs-string">`</span>
<span class="hljs-string">"User type"</span>
<span class="hljs-string">type User {</span>
<span class="hljs-string">id: UUID!</span>
<span class="hljs-string">username: String!</span>
<span class="hljs-string">email: String!</span>
<span class="hljs-string">role: String!</span>
<span class="hljs-string">active: Boolean!</span>
<span class="hljs-string">createdAt: Datetime!</span>
<span class="hljs-string">updatedAt: Datetime!</span>
<span class="hljs-string">}</span>
<span class="hljs-string">"Token type"</span>
<span class="hljs-string">type Token {</span>
<span class="hljs-string">token: String!</span>
<span class="hljs-string">}</span>
<span class="hljs-string">"User Query"</span>
<span class="hljs-string">type Query {</span>
<span class="hljs-string">getUser(at: String!): User!</span>
<span class="hljs-string">getUsers: [User!]</span>
<span class="hljs-string">}</span>
<span class="hljs-string">"User Mutation"</span>
<span class="hljs-string">type Mutation {</span>
<span class="hljs-string">createUser(input: ICreateUser): User!</span>
<span class="hljs-string">login(input: ILogin): Token!</span>
<span class="hljs-string">}</span>
<span class="hljs-string">"CreateUser Input"</span>
<span class="hljs-string">input ICreateUser {</span>
<span class="hljs-string">username: String!</span>
<span class="hljs-string">password: String!</span>
<span class="hljs-string">email: String!</span>
<span class="hljs-string">active: Boolean!</span>
<span class="hljs-string">role: String!</span>
<span class="hljs-string">}</span>
<span class="hljs-string">"Login Input"</span>
<span class="hljs-string">input ILogin {</span>
<span class="hljs-string">emailOrUsername: String!</span>
<span class="hljs-string">password: String!</span>
<span class="hljs-string">}</span>
<span class="hljs-string">`</span>
</code></pre>
<p class="normal">After you create the preceding types, you need to create the user resolver. For this we will use the <code class="inlineCode">authentication</code> package (please check the code at <a href="https://github.com/PacktPublishing/React-18-Design-Patterns-and-Best-Practices-Fourth-Edition/tree/main/Chapter14/web-creator/packages/authentication"><span class="url">https://github.com/PacktPublishing/React-18-Design-Patterns-and-Best-Practices-Fourth-Edition/tree/main/Chapter14/web-creator/packages/authentication</span></a>). Do you remember the authentication system we created in <em class="italic">Chapter 13</em>? It is the same code, but now it will have its own package. This <a id="_idIndexMarker771"/>resolver<a id="_idIndexMarker772"/> should be created in <code class="inlineCode">packages/api/src/graphql/resolvers/user.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { authenticate, getUserBy, getUserData } <span class="hljs-keyword">from</span> <span class="hljs-string">'</span><span class="hljs-string">@web-builder/authentication'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">ICreateUser</span>, <span class="hljs-title">ILogin</span>, <span class="hljs-title">Model</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../types'</span>
<span class="hljs-keyword">const</span> <span class="hljs-title">getUsers</span> = (<span class="hljs-params">_: </span><span class="hljs-built_in">any</span><span class="hljs-params">, _args: </span><span class="hljs-built_in">any</span><span class="hljs-params">, { models }: { models: Model }</span>) =&gt; models.<span class="hljs-property">User</span>.<span class="hljs-title">findAll</span>()
<span class="hljs-keyword">const</span> <span class="hljs-title">getUser</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">_: </span><span class="hljs-built_in">any</span><span class="hljs-params">, { at }: { at: </span><span class="hljs-built_in">string</span><span class="hljs-params"> }, { models }: {models: Model}</span>) =&gt; {
<span class="hljs-keyword">const</span> connectedUser = <span class="hljs-keyword">await</span> <span class="hljs-title">getUserData</span>(at)
<span class="hljs-keyword">if</span> (connectedUser) {
<span class="hljs-comment">// Validating if the user is still valid</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title">getUserBy</span>(
{
<span class="hljs-attr">id</span>: connectedUser.<span class="hljs-property">id</span>,
<span class="hljs-attr">email</span>: connectedUser.<span class="hljs-property">email</span>,
<span class="hljs-attr">active</span>: connectedUser.<span class="hljs-property">active</span>
},
[connectedUser.<span class="hljs-property">role</span>],
models
)
<span class="hljs-keyword">if</span> (user) {
<span class="hljs-keyword">return</span> {
...connectedUser
}
}
}
<span class="hljs-keyword">return</span> {
<span class="hljs-attr">id</span>: <span class="hljs-string">''</span>,
<span class="hljs-attr">username</span>: <span class="hljs-string">''</span>,
<span class="hljs-attr">email</span>: <span class="hljs-string">''</span>,
<span class="hljs-attr">role</span>: <span class="hljs-string">''</span>,
<span class="hljs-attr">active</span>: <span class="hljs-literal">false</span>
}
}
<span class="hljs-keyword">const</span> <span class="hljs-title">createUser</span> = (<span class="hljs-params">_:</span><span class="hljs-built_in">any</span><span class="hljs-params">, {input}: {input: ICreateUser}, {models}: {models: Model}</span>) =&gt;
models.<span class="hljs-property">User</span>.<span class="hljs-title">create</span>({ ...input })
<span class="hljs-keyword">const</span> <span class="hljs-title">login</span> = (<span class="hljs-params">_: </span><span class="hljs-built_in">any</span><span class="hljs-params">, { input }: { input: ILogin }, { models }: { models: Model }</span>) =&gt;
<span class="hljs-title">authenticate</span>(input.<span class="hljs-property">emailOrUsername</span>, input.<span class="hljs-property">password</span>, models)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
<span class="hljs-title">Query</span>: {
getUser,
getUsers
},
<span class="hljs-title">Mutation</span>: {
createUser,
login
}
}
</code></pre>
<h2 class="heading-2" id="_idParaDest-258">Creating custom services</h2>
<p class="normal">Now it is time to <a id="_idIndexMarker773"/>create our custom services; for <a id="_idIndexMarker774"/>this we will create one default service (just to have an empty service) and one for a <strong class="keyWord">CRM</strong> project (it will be called <code class="inlineCode">crm</code>).</p>
<p class="normal">The first thing we need to do is to create our service configuration, and for this we will create some types that will help us to be very strict in the options that our configuration will receive. This file needs to be created in <code class="inlineCode">packages/api/src/types/config.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">ValueOf</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@web-creator/utils'</span>
<span class="hljs-comment">// Here you need to add all the services you want to create</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title">Service</span> = {
<span class="hljs-attr">CRM</span>: <span class="hljs-string">'crm'</span>
} <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title">Service</span> = <span class="hljs-title">ValueOf</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title">Service</span>&gt;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title">Mode</span> = <span class="hljs-string">'</span><span class="hljs-string">production'</span> | <span class="hljs-string">'development'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title">DeploymentType</span> {
<span class="hljs-variable">PRODUCTION</span> = <span class="hljs-string">'production'</span>,
<span class="hljs-variable">STAGING</span> = <span class="hljs-string">'staging'</span>,
<span class="hljs-variable">DEVELOPMENT</span> = <span class="hljs-string">'</span><span class="hljs-string">development'</span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ServiceConfiguration</span> {
<span class="hljs-attr">domainName</span>: <span class="hljs-built_in">string</span>
<span class="hljs-attr">port</span>: <span class="hljs-built_in">number</span>
database?: {
engine?: <span class="hljs-built_in">string</span>
port?: <span class="hljs-built_in">number</span>
host?: <span class="hljs-built_in">string</span>
database?: <span class="hljs-built_in">string</span>
username?: <span class="hljs-built_in">string</span>
password?: <span class="hljs-built_in">string</span>
}
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ServiceBuilderConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceConfiguration</span> {
<span class="hljs-attr">service</span>: <span class="hljs-title">Service</span>
}
</code></pre>
<p class="normal">Our default<a id="_idIndexMarker775"/> configuration should be <a id="_idIndexMarker776"/>like this (<code class="inlineCode">packages/api/src/services/default/config.ts</code>):</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">ServiceConfiguration</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../types/config'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title">ServiceConfiguration</span> = {
<span class="hljs-attr">domainName</span>: <span class="hljs-string">'localhost'</span>,
<span class="hljs-attr">port</span>: <span class="hljs-number">4000</span>,
<span class="hljs-attr">database</span>: {
<span class="hljs-attr">engine</span>: <span class="hljs-string">'postgresql'</span>,
<span class="hljs-attr">port</span>: <span class="hljs-number">5432</span>,
<span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>,
<span class="hljs-attr">database</span>: <span class="hljs-string">''</span>,
<span class="hljs-attr">username</span>: <span class="hljs-string">''</span>,
<span class="hljs-attr">password</span>: <span class="hljs-string">''</span>
}
}
</code></pre>
<p class="normal">After that let’s create our CRM configuration (custom service). This should be placed in <code class="inlineCode">packages/api/src/services/crm/config.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">ServiceConfiguration</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../types/config'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title">ServiceConfiguration</span> = {
<span class="hljs-attr">domainName</span>: <span class="hljs-string">'ranchosanpancho.com'</span>,
<span class="hljs-attr">port</span>: <span class="hljs-number">4000</span>,
<span class="hljs-attr">database</span>: {
<span class="hljs-attr">database</span>: <span class="hljs-string">'crm'</span>
}
}
</code></pre>
<p class="normal">I’m pretty sure you’re wondering where the other options of the database node (<code class="inlineCode">engine</code>, <code class="inlineCode">port</code>, <code class="inlineCode">host</code>, <code class="inlineCode">username</code>, and <code class="inlineCode">password</code>) are. Those will be overwritten in the main config file that we will create later, but those values will be grabbed from our <code class="inlineCode">.env</code> file (you must<a id="_idIndexMarker777"/> rename the <code class="inlineCode">.env.example</code> file). Hence, let’s <a id="_idIndexMarker778"/>create that file in <code class="inlineCode">packages/api/.env</code>:</p>
<pre class="programlisting con"><code class="hljs-con">DB_ENGINE=postgresql
DB_PORT=5432
DB_HOST=localhost
DB_USERNAME=&lt;YourDBUserName&gt;
DB_PASSWORD=&lt;YourDBPassword&gt;
</code></pre>
<h2 class="heading-2" id="_idParaDest-259">Building our service configuration</h2>
<p class="normal">Now that we<a id="_idIndexMarker779"/> have our custom service (<strong class="keyWord">CRM</strong>) ready, let’s<a id="_idIndexMarker780"/> build our configuration. For this you need to create the config file in <code class="inlineCode">packages/api/src/config.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// This package will load the environment variables from our .env file</span>
<span class="hljs-keyword">import</span> dotenv <span class="hljs-keyword">from</span> <span class="hljs-string">'dotenv'</span>
<span class="hljs-comment">// Here you can add your custom services configuration</span>
<span class="hljs-keyword">import</span> { config <span class="hljs-keyword">as</span> crmConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'./services/crm/config'</span>
<span class="hljs-keyword">import</span> { config <span class="hljs-keyword">as</span> blankServiceConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'./services/default/config'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Service</span>, <span class="hljs-title">ServiceBuilderConfiguration</span>, <span class="hljs-title">ServiceConfiguration</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./types/config'</span>
<span class="hljs-comment">// Loading Env vars</span>
dotenv.<span class="hljs-title">config</span>()
<span class="hljs-keyword">const</span> getServiceConfig = (<span class="hljs-attr">service</span>: <span class="hljs-title">Service</span>): <span class="hljs-params">ServiceConfiguration</span><span class="hljs-function"> =&gt;</span> {
<span class="hljs-keyword">switch</span> (service) {
<span class="hljs-comment">// Add your custom services here</span>
<span class="hljs-keyword">case</span> <span class="hljs-title">Service</span>.<span class="hljs-property">CRM</span>:
<span class="hljs-keyword">return</span> crmConfig
<span class="hljs-attr">default</span>:
<span class="hljs-keyword">return</span> blankServiceConfig
}
}
<span class="hljs-keyword">const</span> buildConfig = (): <span class="hljs-params">ServiceBuilderConfiguration</span><span class="hljs-function"> =&gt;</span> {
<span class="hljs-keyword">const</span> service = process.<span class="hljs-property">env</span>.<span class="hljs-property">SERVICE</span> <span class="hljs-keyword">as</span> <span class="hljs-title">Service</span>
<span class="hljs-keyword">if</span> (!service) {
<span class="hljs-keyword">throw</span> <span class="hljs-string">'You must specify a service (E.g., SERVICE=crm npm run dev)'</span>
}
<span class="hljs-keyword">const</span> serviceConfig = <span class="hljs-title">getServiceConfig</span>(service)
<span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title">ServiceBuilderConfiguration</span> = {
...serviceConfig,
<span class="hljs-attr">database</span>: {
...serviceConfig.<span class="hljs-property">database</span>,
<span class="hljs-attr">engine</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_ENGINE</span>,
<span class="hljs-attr">host</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_HOST</span>,
<span class="hljs-attr">port</span>: <span class="hljs-title">Number</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_PORT</span>),
<span class="hljs-attr">username</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_USERNAME</span>,
<span class="hljs-attr">password</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_PASSWORD</span>
},
service
}
<span class="hljs-keyword">return</span> config
}
<span class="hljs-comment">// Building the config</span>
<span class="hljs-keyword">const</span> <span class="hljs-title">Config</span> = <span class="hljs-title">buildConfig</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">Config</span>
</code></pre>
<h2 class="heading-2" id="_idParaDest-260">Creating our custom models</h2>
<p class="normal">Once we’ve created<a id="_idIndexMarker781"/> the configuration correctly, we <a id="_idIndexMarker782"/>need to create our custom models for our CRM service, which are created specifically for that service, and they will not be shared with other services. In this case, we will add just one and call it <code class="inlineCode">Guest</code>. This model needs to be saved in <code class="inlineCode">packages/api/src/services/crm/models/Guest.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">DataType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../types'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> (<span class="hljs-attr">sequelize</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">dataType</span>: <span class="hljs-title">DataType</span>) =&gt; {
<span class="hljs-keyword">const</span> <span class="hljs-title">Guest</span> = sequelize.<span class="hljs-title">define</span>(<span class="hljs-string">'Guest'</span>, {
<span class="hljs-attr">id</span>: {
<span class="hljs-attr">primaryKey</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">type</span>: dataType.<span class="hljs-property">UUID</span>,
<span class="hljs-attr">defaultValue</span>: dataType.<span class="hljs-title">UUIDV4</span>()
},
<span class="hljs-attr">fullName</span>: {
<span class="hljs-attr">type</span>: dataType.<span class="hljs-property">STRING</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>
},
<span class="hljs-attr">email</span>: {
<span class="hljs-attr">type</span>: dataType.<span class="hljs-property">STRING</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>
},
<span class="hljs-attr">photo</span>: {
<span class="hljs-attr">type</span>: dataType.<span class="hljs-property">STRING</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">true</span>
},
<span class="hljs-attr">phone</span>: {
<span class="hljs-attr">type</span>: dataType.<span class="hljs-property">STRING</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">true</span>
},
<span class="hljs-attr">socialMedia</span>: {
<span class="hljs-attr">type</span>: dataType.<span class="hljs-property">STRING</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">true</span>
},
<span class="hljs-attr">location</span>: {
<span class="hljs-attr">type</span>: dataType.<span class="hljs-property">STRING</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">true</span>
},
<span class="hljs-attr">gender</span>: {
<span class="hljs-attr">type</span>: dataType.<span class="hljs-property">STRING</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">true</span>
},
<span class="hljs-attr">birthday</span>: {
<span class="hljs-attr">type</span>: dataType.<span class="hljs-property">STRING</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">true</span>
}
})
<span class="hljs-keyword">return</span> <span class="hljs-title">Guest</span>
}
</code></pre>
<p class="normal">After we create the <code class="inlineCode">Guest</code> model, we need to connect to our database and join our global models (<code class="inlineCode">User</code>) and our local models (<code class="inlineCode">Guest</code>) in order to create our service <a id="_idIndexMarker783"/>tables. This<a id="_idIndexMarker784"/> file needs to be created in <code class="inlineCode">packages/api/src/services/crm/models/index.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { keys, ts } <span class="hljs-keyword">from</span> <span class="hljs-string">'@web-creator/utils'</span>
<span class="hljs-keyword">import</span> pg <span class="hljs-keyword">from</span> <span class="hljs-string">'pg'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Sequelize</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'sequelize'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">Config</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../config'</span>
<span class="hljs-comment">// Db Connection</span>
<span class="hljs-keyword">const</span> { engine, port, host, database, username, password } = <span class="hljs-title">Config</span>.<span class="hljs-property">database</span> ?? {}
<span class="hljs-keyword">const</span> uri = <span class="hljs-string">`</span><span class="hljs-subst">${engine}</span><span class="hljs-string">://</span><span class="hljs-subst">${username}</span><span class="hljs-string">:</span><span class="hljs-subst">${password}</span><span class="hljs-string">@</span><span class="hljs-subst">${host}</span><span class="hljs-string">:</span><span class="hljs-subst">${port}</span><span class="hljs-string">/</span><span class="hljs-subst">${database}</span><span class="hljs-string">`</span>
<span class="hljs-keyword">const</span> sequelize = <span class="hljs-keyword">new</span> <span class="hljs-title">Sequelize</span>(uri, {
<span class="hljs-attr">dialectModule</span>: pg
})
<span class="hljs-comment">// Models</span>
<span class="hljs-keyword">const</span> <span class="hljs-title">addModel</span> = (<span class="hljs-params">path: </span><span class="hljs-built_in">string</span>) =&gt; <span class="hljs-built_in">require</span>(path).<span class="hljs-title">default</span>(sequelize, <span class="hljs-title">Sequelize</span>)
<span class="hljs-keyword">const</span> <span class="hljs-attr">models</span>: <span class="hljs-built_in">any</span> = {
<span class="hljs-title">User</span>: <span class="hljs-title">addModel</span>(<span class="hljs-string">'../../../models/User'</span>), <span class="hljs-comment">// Global model</span>
<span class="hljs-title">Guest</span>: <span class="hljs-title">addModel</span>(<span class="hljs-string">'./Guest'</span>), <span class="hljs-comment">// Local model</span>
sequelize <span class="hljs-comment">// We must pass the sequelize object here</span>
}
<span class="hljs-comment">// Relationships</span>
<span class="hljs-title">keys</span>(models).<span class="hljs-title">forEach</span>(<span class="hljs-function">(</span><span class="hljs-params">modelName: </span><span class="hljs-built_in">string</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-keyword">if</span> (ts.<span class="hljs-title">hasKey</span>(models, modelName)) {
<span class="hljs-keyword">if</span> (models[modelName].<span class="hljs-property">associate</span>) {
models[modelName].<span class="hljs-title">associate</span>(models)
}
}
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> models
</code></pre>
<h2 class="heading-2" id="_idParaDest-261">Creating model seeds</h2>
<p class="normal">Seeds are the initial<a id="_idIndexMarker785"/> data for our models (tables). Most<a id="_idIndexMarker786"/> of the time we want to clear all the model values but keep some of them as default values, but in this case we will add some default data for our <code class="inlineCode">User</code> model and our <code class="inlineCode">Guest</code> model:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> models <span class="hljs-keyword">from</span> <span class="hljs-string">'../models'</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title">createFirstUser</span>(): <span class="hljs-title">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt; {
<span class="hljs-keyword">const</span> existingUsers = <span class="hljs-keyword">await</span> models.<span class="hljs-property">User</span>.<span class="hljs-title">findAll</span>()
<span class="hljs-keyword">if</span> (existingUsers.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
<span class="hljs-keyword">const</span> <span class="hljs-attr">newUser</span>: <span class="hljs-built_in">any</span> = <span class="hljs-keyword">await</span> models.<span class="hljs-property">User</span>.<span class="hljs-title">create</span>({
<span class="hljs-attr">username</span>: <span class="hljs-string">'admin'</span>,
<span class="hljs-attr">password</span>: <span class="hljs-string">'12345678'</span>,
<span class="hljs-attr">email</span>: <span class="hljs-string">'admin@ranchosanpancho.com'</span>,
<span class="hljs-attr">role</span>: <span class="hljs-string">'god'</span>,
<span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>
})
<span class="hljs-keyword">return</span> newUser
}
<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
}
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title">createGuests</span>(): <span class="hljs-title">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt; {
<span class="hljs-keyword">const</span> existingGuests = <span class="hljs-keyword">await</span> models.<span class="hljs-property">Guest</span>.<span class="hljs-title">findAll</span>()
<span class="hljs-keyword">if</span> (existingGuests.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
<span class="hljs-keyword">const</span> <span class="hljs-attr">newGuests</span>: <span class="hljs-built_in">any</span> = <span class="hljs-keyword">await</span> models.<span class="hljs-property">Guest</span>.<span class="hljs-title">bulkCreate</span>([
{
<span class="hljs-attr">fullName</span>: <span class="hljs-string">'Carlos Santana'</span>,
<span class="hljs-attr">email</span>: <span class="hljs-string">'carlos@ranchosanpancho.com'</span>,
<span class="hljs-attr">photo</span>: <span class="hljs-string">'carlos.jpg'</span>,
<span class="hljs-attr">phone</span>: <span class="hljs-string">'+1 555 555 5555'</span>,
<span class="hljs-attr">socialMedia</span>: <span class="hljs-string">'https://www.facebook.com/carlos.santana'</span>,
<span class="hljs-attr">location</span>: <span class="hljs-string">'Colima, Mexico'</span>,
<span class="hljs-attr">gender</span>: <span class="hljs-string">'Male'</span>,
<span class="hljs-attr">birthday</span>: <span class="hljs-string">'11/21/1987'</span>
},
{
<span class="hljs-attr">fullName</span>: <span class="hljs-string">'Cristina Santana'</span>,
<span class="hljs-attr">email</span>: <span class="hljs-string">'cristina@ranchosanpancho.com'</span>,
<span class="hljs-attr">photo</span>: <span class="hljs-string">'cristina.jpg'</span>,
<span class="hljs-attr">phone</span>: <span class="hljs-string">'+1 444 444 4444'</span>,
<span class="hljs-attr">socialMedia</span>: <span class="hljs-string">'https://www.facebook.com/cristina.santana'</span>,
<span class="hljs-attr">location</span>: <span class="hljs-string">'Colima, Mexico'</span>,
<span class="hljs-attr">gender</span>: <span class="hljs-string">'Female'</span>,
<span class="hljs-attr">birthday</span>: <span class="hljs-string">'1/20/1989'</span>
}
])
<span class="hljs-keyword">return</span> newGuests
}
<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
}
<span class="hljs-keyword">function</span> <span class="hljs-title">setInitialSeeds</span>(): <span class="hljs-built_in">void</span> {
<span class="hljs-title">createFirstUser</span>()
<span class="hljs-title">createGuests</span>()
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> setInitialSeeds
</code></pre>
<h2 class="heading-2" id="_idParaDest-262">Creating our custom GraphQL types and resolvers</h2>
<p class="normal">For our CRM, we <a id="_idIndexMarker787"/>will <a id="_idIndexMarker788"/>create a <code class="inlineCode">Guest</code> type and resolver just to illustrate how we can use GraphQL in different services that we create; the first file you need to create is the <code class="inlineCode">Guest</code> type, which must be saved in <code class="inlineCode">packages/api/src/services/crm/graphql/types/Guest.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> gql <span class="hljs-keyword">from</span> <span class="hljs-string">'graphql-tag'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> gql<span class="hljs-string">`</span>
<span class="hljs-string">type Guest {</span>
<span class="hljs-string">id: UUID!</span>
<span class="hljs-string">fullName: String!</span>
<span class="hljs-string">email: String!</span>
<span class="hljs-string">photo: String!</span>
<span class="hljs-string">socialMedia: String!</span>
<span class="hljs-string">location: String!</span>
<span class="hljs-string">phone: String!</span>
<span class="hljs-string">gender: String!</span>
<span class="hljs-string">birthday: String</span>
<span class="hljs-string">createdAt: Datetime!</span>
<span class="hljs-string">updatedAt: Datetime!</span>
<span class="hljs-string">}</span>
<span class="hljs-string">type GuestResponse {</span>
<span class="hljs-string">guests: [Guest!]!</span>
<span class="hljs-string">}</span>
<span class="hljs-string">union GuestResult = GuestResponse | Error</span>
<span class="hljs-string">type Query {</span>
<span class="hljs-string">getGuests: GuestResult</span>
<span class="hljs-string">}</span>
<span class="hljs-string">`</span>
</code></pre>
<p class="normal">As you can see, we define our <code class="inlineCode">Guest</code> type with some personal fields such as <code class="inlineCode">fullName</code>, <code class="inlineCode">email</code>, <code class="inlineCode">photo</code>, etc. Then we create a <code class="inlineCode">GuestResponse</code> type that represents an array of guests <code class="inlineCode">([Guest!]!</code>). The square brackets indicate that it’s an array, and the exclamation mark (<code class="inlineCode">!</code>) denotes that it cannot contain <code class="inlineCode">null</code> values. After that, we create a <code class="inlineCode">union</code> type, which enables the <code class="inlineCode">schema</code> field to return one of multiple object types. In this case, it can return <code class="inlineCode">GuestResponse</code> when we have guests or the <code class="inlineCode">Error</code> type if we don’t have guests or encounter any other issues. If something else occurs, we define the response of these types in our resolver.</p>
<p class="normal">After you create this type file (or more), it is time to merge all your <strong class="keyWord">Type Definitions</strong> (<strong class="keyWord">TypeDefs</strong>). For <a id="_idIndexMarker789"/>this, we will create an <code class="inlineCode">index.ts</code> file inside our <code class="inlineCode">types</code> directory <a id="_idIndexMarker790"/>and <a id="_idIndexMarker791"/>import our global types (<code class="inlineCode">Error</code>, <code class="inlineCode">Scalar</code>, and <code class="inlineCode">User</code>). We will also include our local type (<code class="inlineCode">Guest</code>) and merge it with a function provided by <code class="inlineCode">@graphql-tools/merge</code>. This file is placed in <code class="inlineCode">packages/api/src/services/crm/types/index.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { mergeTypeDefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@graphql-tools/merge'</span>
<span class="hljs-comment">// Global Types</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">Error</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../../graphql/types/Error'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">Scalar</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../../graphql/types/Scalar'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">User</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../../graphql/types/User'</span>
<span class="hljs-comment">// Local Types</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">Guest</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Guest'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">mergeTypeDefs</span>([<span class="hljs-title">Error</span>, <span class="hljs-title">Scalar</span>, <span class="hljs-title">User</span>, <span class="hljs-title">Guest</span>])
</code></pre>
<p class="normal">Now once you have merged your types, you need to create the <code class="inlineCode">Guest</code> resolver. This file should be placed in <code class="inlineCode">packages/api/src/services/crm/graphql/resolvers/guest.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
<span class="hljs-title">Query</span>: {
<span class="hljs-attr">getGuests</span>: <span class="hljs-keyword">async</span> (<span class="hljs-attr">_</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">_args</span>: <span class="hljs-built_in">any</span>, { models }: { <span class="hljs-attr">models</span>: <span class="hljs-built_in">any</span> }): <span class="hljs-title">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt; =&gt; {
<span class="hljs-keyword">const</span> guests = <span class="hljs-keyword">await</span> models.<span class="hljs-property">Guest</span>.<span class="hljs-title">findAll</span>({ 
<span class="hljs-attr">order</span>: [[<span class="hljs-string">'fullName'</span>, <span class="hljs-string">'ASC'</span>]]
})
<span class="hljs-comment">// If there are guests, return them with a GuestResponse type</span>
<span class="hljs-keyword">if</span> (guests.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
<span class="hljs-keyword">return</span> {
<span class="hljs-attr">__typename</span>: <span class="hljs-string">'GuestResponse'</span>,
guests
}
}
<span class="hljs-comment">// If there are no guests, return an Error type with a 404 code and message </span>
<span class="hljs-keyword">return</span> {
<span class="hljs-attr">__typename</span>: <span class="hljs-string">'Error'</span>,
<span class="hljs-attr">error</span>: {
<span class="hljs-attr">code</span>: <span class="hljs-number">404</span>,
<span class="hljs-attr">message</span>: <span class="hljs-string">'No guests found'</span>
}
}
}
}
}
</code></pre>
<p class="normal">As you can<a id="_idIndexMarker792"/> see, when <a id="_idIndexMarker793"/>we find guests (or data), we return them and add the <code class="inlineCode">__typename</code> property (which is a GraphQL property) with a value of <code class="inlineCode">GuestResponse</code>. This property is necessary to resolve the query with the correct type, since we are using a union. Here is where we define what we will return, whether it’s the <code class="inlineCode">GuestResponse</code> type or the <code class="inlineCode">Error</code> type. On the other hand, if we don’t find any guests, we return an error object with a code and message, and the <code class="inlineCode">__typename</code> is set to <code class="inlineCode">'Error'</code>. </p>
<p class="normal">Now, we need to do the same with the resolvers. We need to merge our resolvers, both the global ones and the local ones. To do this, create an <code class="inlineCode">index.ts</code> file in the same <code class="inlineCode">resolvers</code> directory and add the following code:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { mergeResolvers } <span class="hljs-keyword">from</span> <span class="hljs-string">'@graphql-tools/merge'</span>
<span class="hljs-keyword">import</span> user <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../../graphql/resolvers/user'</span>
<span class="hljs-keyword">import</span> guest <span class="hljs-keyword">from</span> <span class="hljs-string">'./guest'</span>
<span class="hljs-keyword">const</span> resolvers = <span class="hljs-title">mergeResolvers</span>([user, guest])
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> resolvers
</code></pre>
<p class="normal">We have done a similar thing with our resolvers as we did with the <code class="inlineCode">TypeDef</code>. Now, we need to<a id="_idIndexMarker794"/> import the global<a id="_idIndexMarker795"/> user resolver and merge it with our guest resolver.</p>
<h2 class="heading-2" id="_idParaDest-263">Synchronizing our models and starting Apollo Server</h2>
<p class="normal">Now that we <a id="_idIndexMarker796"/>have<a id="_idIndexMarker797"/> created <a id="_idIndexMarker798"/>our <a id="_idIndexMarker799"/>custom <code class="inlineCode">configs</code>, <code class="inlineCode">models</code>, <code class="inlineCode">seeds</code>, <code class="inlineCode">types</code>, and <code class="inlineCode">resolvers</code>, it’s time to put everything together, synchronize our models, and start our Apollo Server. This file should be placed in <code class="inlineCode">packages/api/src/index.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { makeExecutableSchema } <span class="hljs-keyword">from</span> <span class="hljs-string">'@graphql-tools/schema'</span>
<span class="hljs-keyword">import</span> { ts } <span class="hljs-keyword">from</span> <span class="hljs-string">'@web-creator/utils'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">ApolloServer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@apollo/server'</span>
<span class="hljs-keyword">import</span> { expressMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">'@apollo/server/express4'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">ApolloServerPluginDrainHttpServer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@apollo/server/plugin/drainHttpServer'</span>
<span class="hljs-keyword">import</span> bodyParser <span class="hljs-keyword">from</span> <span class="hljs-string">'body-parser'</span>
<span class="hljs-keyword">import</span> http <span class="hljs-keyword">from</span> <span class="hljs-string">'http'</span>
<span class="hljs-keyword">import</span> cookieParser <span class="hljs-keyword">from</span> <span class="hljs-string">'cookie-parser'</span>
<span class="hljs-keyword">import</span> cors <span class="hljs-keyword">from</span> <span class="hljs-string">'cors'</span>
<span class="hljs-keyword">import</span> express, { <span class="hljs-title">NextFunction</span>, <span class="hljs-title">Request</span>, <span class="hljs-title">Response</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>
<span class="hljs-keyword">import</span> { applyMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">'graphql-middleware'</span>
<span class="hljs-keyword">import</span> { json } <span class="hljs-keyword">from</span> <span class="hljs-string">'body-parser'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Service</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./types/config'</span>
</code></pre>
<p class="normal">After importing all the packages we need, first we need to check if we received the <code class="inlineCode">SERVICE</code> variable from the terminal; otherwise, we will choose our default service. We will also check if our service is valid (exists in our <code class="inlineCode">Service</code> type):</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Service</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">service</span>: <span class="hljs-built_in">any</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">SERVICE</span> ?? <span class="hljs-string">'default'</span>
<span class="hljs-comment">// Validating service</span>
<span class="hljs-keyword">if</span> (!ts.<span class="hljs-title">includes</span>(<span class="hljs-title">Service</span>, service)) {
<span class="hljs-keyword">throw</span> <span class="hljs-string">'Invalid service'</span>
}
</code></pre>
<p class="normal">Once we are sure that our service is valid, then we will dynamically import the <code class="inlineCode">resolvers</code>, <code class="inlineCode">types</code>, <code class="inlineCode">models</code>, and <code class="inlineCode">seeds</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// We are importing the service files dynamically</span>
<span class="hljs-keyword">const</span> resolvers = <span class="hljs-built_in">require</span>(<span class="hljs-string">`./services/</span><span class="hljs-subst">${service}</span><span class="hljs-string">/graphql/resolvers`</span>).<span class="hljs-property">default</span>
<span class="hljs-keyword">const</span> typeDefs = <span class="hljs-built_in">require</span>(<span class="hljs-string">`./services/</span><span class="hljs-subst">${service}</span><span class="hljs-string">/graphql/types`</span>).<span class="hljs-property">default</span>
<span class="hljs-keyword">const</span> models = <span class="hljs-built_in">require</span>(<span class="hljs-string">`./services/</span><span class="hljs-subst">${service}</span><span class="hljs-string">/models`</span>).<span class="hljs-property">default</span>
<span class="hljs-keyword">const</span> seeds = <span class="hljs-built_in">require</span>(<span class="hljs-string">`./services/</span><span class="hljs-subst">${service}</span><span class="hljs-string">/seeds`</span>).<span class="hljs-property">default</span>
</code></pre>
<p class="normal">Then we create our Express app and configure <code class="inlineCode">cors</code>, <code class="inlineCode">cookieParser</code>, and <code class="inlineCode">bodyParser</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">const</span> app = <span class="hljs-title">express</span>()
<span class="hljs-keyword">const </span>httpServer<span class="hljs-keyword"> </span>=<span class="hljs-keyword"> </span><span class="hljs-title">http.createServer</span>(app)
<span class="hljs-keyword">const</span> corsOptions = {
<span class="hljs-attr">origin</span>: <span class="hljs-string">'*'</span>,
<span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>
}
app.<span class="hljs-title">use</span>(<span class="hljs-title">cors</span>(corsOptions))
app.<span class="hljs-title">use</span>(<span class="hljs-title">cookieParser</span>())
app.<span class="hljs-title">use</span>(bodyParser.<span class="hljs-title">json</span>())
<span class="hljs-comment">// CORS</span>
app.<span class="hljs-title">use</span>(<span class="hljs-function">(</span><span class="hljs-params">req: Request, res: Response, next: NextFunction</span><span class="hljs-function">) =&gt;</span> {
res.<span class="hljs-title">header</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, <span class="hljs-string">'*'</span>)
res.<span class="hljs-title">header</span>(<span class="hljs-string">'</span><span class="hljs-string">Access-Control-Allow-Headers'</span>, <span class="hljs-string">'Origin, X-Requested-With, Content-Type, Accept'</span>)
<span class="hljs-title">next</span>()
})
</code></pre>
<p class="normal">We<a id="_idIndexMarker800"/> need<a id="_idIndexMarker801"/> to <a id="_idIndexMarker802"/>create <a id="_idIndexMarker803"/>our GraphQL schema with <code class="inlineCode">makeExecutableSchema</code> and use the <code class="inlineCode">applyMiddleware</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Schema</span>
<span class="hljs-keyword">const</span> schema = <span class="hljs-title">applyMiddleware</span>(
<span class="hljs-title">makeExecutableSchema</span>({
typeDefs,
resolvers
})
)
</code></pre>
<p class="normal">Finally, we create our <code class="inlineCode">ApolloServer</code> instance passing the schema and the plugins. </p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Apollo Server</span>
<span class="hljs-keyword">const</span> apolloServer = <span class="hljs-keyword">new</span> <span class="hljs-title">ApolloServer</span>({
schema,
<span class="hljs-attr">plugins</span>:[<span class="hljs-title">ApolloServerPluginDrainHttpServer</span>({ httpServer })]
})
</code></pre>
<p class="normal">Now we need to sync our models. The <code class="inlineCode">alter</code> option enables us to listen to changes in our<a id="_idIndexMarker804"/> models<a id="_idIndexMarker805"/> and <a id="_idIndexMarker806"/>modify <a id="_idIndexMarker807"/>them:</p>
<div class="note">
<p class="normal">If you change something, BE VERY CAREFUL with the <code class="inlineCode">force</code> option. If it is <code class="inlineCode">true</code>, it will truncate all your tables (meaning all your data will be deleted). Hence, only use it when totally necessary.</p>
</div>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Database Sync</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title">main</span> = <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> alter = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">const</span> force = <span class="hljs-literal">false</span>
    
    <span class="hljs-keyword">await</span> apolloServer.<span class="hljs-title">start</span>()
    <span class="hljs-keyword">await</span> models.<span class="hljs-property">sequelize</span>.<span class="hljs-title">sync</span>({ alter, force })
    <span class="hljs-comment">// Setting up initial seeds</span>
    <span class="hljs-variable">console</span>.<span class="hljs-title">log</span>(<span class="hljs-string">'Initializing Seeds...'</span>)
    <span class="hljs-title">seeds</span>()
    app.<span class="hljs-title">use</span>(
      <span class="hljs-string">'/graphql'</span>,
      cors&lt;cors.<span class="hljs-property">CorsRequest</span>&gt;(),
      <span class="hljs-title">json</span>(),
      <span class="hljs-title">expressMiddleware</span>(apolloServer, {
        <span class="hljs-attr">context</span>: <span class="hljs-keyword">async</span> () =&gt; ({ models })
      })
    )
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt;(<span class="hljs-function">(</span><span class="hljs-params">resolve</span><span class="hljs-function">) =&gt;</span> httpServer.<span class="hljs-title">listen</span>({ <span class="hljs-attr">port</span>: <span class="hljs-number">4000</span> }, resolve))
    <span class="hljs-variable">console</span>.<span class="hljs-title">log</span>(<span class="hljs-string">' Server ready at http://localhost:4000/graphql'</span>)
  }
  <span class="hljs-title">main</span>()
</code></pre>
<h2 class="heading-2" id="_idParaDest-264">Testing our CRM service</h2>
<p class="normal">If you did <a id="_idIndexMarker808"/>everything <a id="_idIndexMarker809"/>correctly, you can run the command <code class="inlineCode">SERVICE=crm npm run dev</code> inside your <code class="inlineCode">api</code> package. and you should see something like this:</p>
<p class="packt_figref"><img alt="Text  Description automatically generated" height="525" src="../Images/B18414_14_10.png" width="825"/></p>
<p class="packt_figref">Figure 14.10: SERVICE=crm npm run dev</p>
<p class="normal">If you check your database, you will see the two tables created from your models (<code class="inlineCode">Guests</code> and <code class="inlineCode">Users</code>), and you<a id="_idIndexMarker810"/> should be able to see the seeds you added as well:</p>
<p class="packt_figref"><img alt="Graphical user interface, application, email  Description automatically generated" height="253" src="../Images/B18414_14_11.a.png" width="224"/></p>
<p class="packt_figref"><img alt="Graphical user interface, application, email  Description automatically generated" height="69" src="../Images/B18414_14_11.b.png" width="825"/></p>
<p class="packt_figref">Figure 14.11: Database query</p>
<p class="normal">As you can see, the <code class="inlineCode">createdAt</code> and <code class="inlineCode">updatedAt</code> fields are automatically created by Sequelize. After this, you can try to hit <a href="http://localhost:4000/graphql"><span class="url">http://localhost:4000/graphql</span></a> to see if your Apollo Server <a id="_idIndexMarker811"/>works fine.</p>
<p class="packt_figref"><img alt="Graphical user interface, application, website  Description automatically generated" height="509" src="../Images/B18414_14_12.png" width="626"/></p>
<p class="packt_figref">Figure 14.12: GraphQL Explorer</p>
<p class="normal">We can start testing <a id="_idIndexMarker812"/>our service queries like <code class="inlineCode">getGuests</code>; let’s see what it returns:</p>
<p class="packt_figref"><img alt="Graphical user interface, text  Description automatically generated" height="585" src="../Images/B18414_14_13.png" width="825"/></p>
<p class="packt_figref">Figure 14.13: getGuests query</p>
<p class="normal">Also, you <a id="_idIndexMarker813"/>can test<a id="_idIndexMarker814"/> the <code class="inlineCode">getUsers</code> query:</p>
<p class="packt_figref"><img alt="Graphical user interface, application, Teams  Description automatically generated" height="277" src="../Images/B18414_14_14.png" width="825"/></p>
<p class="packt_figref">Figure 14.14: getUsers query</p>
<p class="normal">Finally, you can also test the <code class="inlineCode">login</code> mutation to make sure your global authentication system works fine:</p>
<p class="packt_figref"><img alt="Graphical user interface, application, Teams  Description automatically generated" height="501" src="../Images/B18414_14_15.png" width="825"/></p>
<p class="packt_figref">Figure 14.15: The login mutation</p>
<h1 class="heading-1" id="_idParaDest-265">Creating the frontend package</h1>
<p class="normal">In this package, we will<a id="_idIndexMarker815"/> implement a multi-site system that will help us have more than one site with the same code base.</p>
<p class="normal">Let’s see how our <code class="inlineCode">package.json</code> file should look for this package:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
<span class="hljs-attr">  "name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@web-creator/frontend"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">  "version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span> 
<span class="hljs-attr">  "scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cross-env NODE_ENV=development npm run next:dev"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"next build"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"next"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ts-node src/server.ts"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"next:dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ts-node src/server.ts"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run --prefix ../../ lint"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"lint:fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run --prefix ../../ lint:fix"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"typecheck"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc --noEmit"</span>
<span class="hljs-punctuation">  },</span>
<span class="hljs-attr">  "author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carlos Santana"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">  "license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ISC"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">  "peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=17.0.2"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=17.0.2"</span>
<span class="hljs-punctuation">  },</span>
<span class="hljs-attr">  "devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@babel/core"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^7.20.12"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@babel/node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^7.20.7"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@types/cookie-parser"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.4.3"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@types/isomorphic-fetch"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^0.0.36"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@types/styled-components"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.1.26"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"babel-plugin-jsx-remove-data-test-id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.0.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"babel-plugin-styled-components"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.7"</span>
<span class="hljs-punctuation">  },</span>
<span class="hljs-attr">  "dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@apollo/client"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.7.7"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@web-creator/authentication"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@web-creator/devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"@web-creator/utils"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.0.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"babel-preset-next"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.4.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"cookie-parser"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.4.6"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"dotenv"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^16.0.3"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"express"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.18.2"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"isomorphic-fetch"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.0.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"next"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^13.1.6"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"react-cookie"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.1.1"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"styled-components"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.3.6"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">    </span><span class="hljs-attr">"webpack"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.75.0"</span>
<span class="hljs-punctuation">  }</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">Our <code class="inlineCode">frontend</code> package <a id="_idIndexMarker816"/>works a little bit differently from our other packages because <a id="_idIndexMarker817"/>we use <strong class="keyWord">Next.js</strong>, which takes care of its own Webpack configuration. We do not compile it using our <code class="inlineCode">devtools</code> like the other packages, and the TypeScript configuration differs slightly. </p>
<p class="normal">This is the <code class="inlineCode">tsconfig.json</code> file for our <code class="inlineCode">frontend</code> package:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
<span class="hljs-attr">  "extends"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"../../tsconfig.common.json"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">  "compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-attr">    "outDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"</span><span class="hljs-string">./dist"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">    "baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"."</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">    "isolatedModules"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">    "noEmit"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">    "allowJs"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">    "forceConsistentCasingInFileNames"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">    "incremental"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">    "jsx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"preserve"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">    "paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-attr">      "~/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/*"</span><span class="hljs-punctuation">]</span>
<span class="hljs-attr">    </span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">  },</span>
<span class="hljs-attr">  "include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/**/*"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">As you can see, we define the <code class="inlineCode">~</code> path. This is handled by <code class="inlineCode">devtools</code> in other packages but in our case, we need to modify the next Webpack configuration directly. For this, you need to create the file <code class="inlineCode">next.config.js</code> (yes, <code class="inlineCode">.js</code>, not <code class="inlineCode">.ts</code>), and the code should look like:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-variable">module</span>.<span class="hljs-property">exports</span> = {
<span class="hljs-attr">reactStrictMode</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">webpack</span>: <span class="hljs-function">(</span><span class="hljs-params">config, { isServer }</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-comment">// Fixes npm packages that depend on 'fs' module</span>
<span class="hljs-keyword">if</span> (!isServer) {
config.<span class="hljs-property">resolve</span>.<span class="hljs-property">fallback</span>.<span class="hljs-property">fs</span> = <span class="hljs-literal">false</span>
}
<span class="hljs-comment">// Aliases</span>
config.<span class="hljs-property">resolve</span>.<span class="hljs-property">alias</span>[<span class="hljs-string">'~'</span>] = path.<span class="hljs-title">resolve</span>(__dirname, <span class="hljs-string">'./src'</span>)
<span class="hljs-keyword">return</span> config
}
}
</code></pre>
<p class="normal">Another configuration<a id="_idIndexMarker818"/> we need to set up is to add <code class="inlineCode">styled-components</code> plugins to our <code class="inlineCode">.babelrc</code> file. We will also use the <code class="inlineCode">next/babel</code> preset. This file exists in <code class="inlineCode">packages/frontend/.babelrc</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
<span class="hljs-attr">  "presets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"next/babel"</span><span class="hljs-punctuation">],</span>
<span class="hljs-attr">  "plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[[</span><span class="hljs-string">"styled-components"</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"ssr"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"</span><span class="hljs-attr">preprocess"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span> <span class="hljs-punctuation">}]],</span>
<span class="hljs-attr">  "env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-attr">    "production"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-attr">      "plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"babel-plugin-jsx-remove-data-test-id"</span><span class="hljs-punctuation">]</span>
<span class="hljs-attr">    </span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">  }</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">Now that we have completed this portion of the chapter, we will proceed to create a universal <code class="inlineCode">User</code> model. This model will serve as a template that can be utilized across all our websites for anyone who signs up.</p>
<p class="normal">Next, our focus will shift toward developing a <code class="inlineCode">Sites</code> system, which can be visualized as a master control room responsible for managing our websites. Just like changing TV channels, we will also build a <strong class="keyWord">Page Switcher</strong> that enables users to seamlessly switch between different pages on our websites.</p>
<p class="normal">Subsequently, we will construct a common <code class="inlineCode">Login</code> system that ensures a consistent login experience across all our websites. To enhance customization and functionality, we will set up a <code class="inlineCode">Sites</code> configuration, which acts as a rulebook or settings panel for each individual site, dictating its behavior and features.</p>
<p class="normal">To consolidate all these components, we will bundle them together in a single file named <code class="inlineCode">server.ts</code>, which will function as the command center for our system.</p>
<p class="normal">Once the setup is complete, we will proceed to test our work by running the program and examining the outcomes using various examples. If any issues arise, our system will provide error messages to indicate and assist in troubleshooting.</p>
<p class="normal">In the upcoming sections, you will witness all these steps in action, enabling you to comprehend<a id="_idIndexMarker819"/> how they integrate within our larger system. Rest assured, although it may sound intricate at the moment, we will break it down and guide you through each step, ensuring a clear understanding of the process.</p>
<h2 class="heading-2" id="_idParaDest-266">Creating our Sites system</h2>
<p class="normal">The Sites system is<a id="_idIndexMarker820"/> pretty much the same as the<a id="_idIndexMarker821"/> services system we created in our API packages, but in this case instead of managing databases, we manage websites. So, like we did before, the first thing we need to do is create the configuration of each site. In this scenario, we will also have a <strong class="keyWord">default</strong> site, which is called <code class="inlineCode">'blank-page'</code>, just to avoid the system breaking when no site has been provided. </p>
<p class="normal">Let’s create the config file for this site in <code class="inlineCode">packages/frontend/src/sites/blank-page/config.ts</code>, and this is the content of that file:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">SiteConfiguration</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../types/config'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title">SiteConfiguration</span> = {
<span class="hljs-attr">siteTitle</span>: <span class="hljs-string">'Blank Page'</span>,
<span class="hljs-attr">domainName</span>: <span class="hljs-string">'localhost'</span>,
<span class="hljs-attr">api</span>: {
<span class="hljs-attr">uri</span>: <span class="hljs-string">'http://localhost:4000/graphql'</span>
},
<span class="hljs-attr">pages</span>: [<span class="hljs-string">'index'</span>]
}
</code></pre>
<p class="normal">For this example, I’ll use two personal sites, <code class="inlineCode">san-pancho</code> and <code class="inlineCode">codejobs</code>, but feel free to add any site you want to the project.</p>
<p class="normal">As part of the site, we need to create the <code class="inlineCode">graphql</code> files, to consume our API queries and mutations, and the specific pages for this site. The only query we will add for now is the <code class="inlineCode">getGuests</code> query that we previously created in the API package. This file should be in <code class="inlineCode">packages/frontend/src/sites/san-pancho/graphql/guest/getGuests.query.ts</code>. If, at some point, you want to create a mutation, you <a id="_idIndexMarker822"/>may<a id="_idIndexMarker823"/> want to use the <code class="inlineCode">myMutation.mutation.ts</code> format for the filename:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { gql } <span class="hljs-keyword">from</span> <span class="hljs-string">'</span><span class="hljs-string">@apollo/client'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getGuestsQuery = <span class="hljs-string">'</span>
<span class="hljs-string">getGuests {</span>
<span class="hljs-string">... on GuestResponse {</span>
<span class="hljs-string">guests {</span>
<span class="hljs-string">id</span>
<span class="hljs-string">fullName</span>
<span class="hljs-string">email</span>
<span class="hljs-string">photo</span>
<span class="hljs-string">socialMedia</span>
<span class="hljs-string">location</span>
<span class="hljs-string">gender</span>
<span class="hljs-string">birthday</span>
<span class="hljs-string">note</span>
<span class="hljs-string">}</span>
<span class="hljs-string">}</span>
<span class="hljs-string">... on Error {</span>
<span class="hljs-string">error {</span>
<span class="hljs-string">code</span>
<span class="hljs-string">message</span>
<span class="hljs-string">}</span>
<span class="hljs-string">}</span>
<span class="hljs-string">}</span>
<span class="hljs-string">'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> gql<span class="hljs-string">'</span>
<span class="hljs-string">query getGuests {</span>
<span class="hljs-subst">${getGuestsQuery}</span>
<span class="hljs-string">}</span>
<span class="hljs-string">'</span>
</code></pre>
<h2 class="heading-2" id="_idParaDest-267">Creating our Page Switcher</h2>
<p class="normal">If you have used <a id="_idIndexMarker824"/>Next.js in the past, you’ll <a id="_idIndexMarker825"/>know how the <strong class="keyWord">Next</strong> page system works. Essentially, you have your <code class="inlineCode">pages</code> directory, and the files or directories you add to that will represent the route of a page. For our example, we will need to create some Next pages that will “switch” or render a custom page from each site. I know it sounds a little bit complicated, but let’s break this down into parts.</p>
<p class="normal">The first thing to do is to create our <code class="inlineCode">index.ts</code> page in <code class="inlineCode">packages/frontend/src/pages/index.ts</code> (this is a Next page):</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> <span class="hljs-title">React</span>, { <span class="hljs-variable">FC</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">Config</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'~/config'</span>
<span class="hljs-keyword">const</span> <span class="hljs-title">SwitcherPage</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'~/sites/</span><span class="hljs-subst">${Config.site}</span><span class="hljs-string">/switcher'</span>).<span class="hljs-property">default</span>
<span class="hljs-keyword">const</span> getRouterParams = <span class="hljs-built_in">require</span>(<span class="hljs-string">'</span><span class="hljs-string">~/sites/</span><span class="hljs-subst">${Config.site}</span><span class="hljs-string">/server/routerParams'</span>).<span class="hljs-property">default</span>
type <span class="hljs-title">Props</span> = {
<span class="hljs-attr">siteTitle</span>: string
}
<span class="hljs-keyword">const</span> <span class="hljs-title">Page</span>: <span class="hljs-variable">FC</span>&lt;<span class="hljs-title">Props</span>&gt; = <span class="hljs-function">(</span><span class="hljs-params">{ siteTitle }</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-keyword">const</span> routerParams = <span class="hljs-title">getRouterParams</span>({})
<span class="hljs-keyword">return</span> <span class="hljs-tag">&lt;</span><span class="hljs-name">SwitcherPage</span><span class="hljs-tag"> </span><span class="hljs-attr">routerParams</span><span class="hljs-tag">=</span><span class="hljs-string">{routerParams}</span><span class="hljs-tag"> </span><span class="hljs-attr">siteTitle</span><span class="hljs-tag">=</span><span class="hljs-string">{siteTitle}</span><span class="hljs-tag"> /&gt;</span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">Page</span>
</code></pre>
<p class="normal">Another Next.js page that we must create is one that has a special name and needs to be created in <code class="inlineCode">packages/frontend/src/pages/[page]/[…params].tsx</code>. The <code class="inlineCode">[page]</code> will be a dynamic path. The <code class="inlineCode">[...params].tsx</code> file will receive any additional parameters passed in the URL. If we have more than two nested routes, these additional routes will be added as an array to the <code class="inlineCode">params</code> variable:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/router'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">React</span>, { <span class="hljs-variable">FC</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">Config</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'~/config'</span>
<span class="hljs-keyword">const</span> <span class="hljs-title">SwitcherPage</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'~/sites/</span><span class="hljs-subst">${Config.site}</span><span class="hljs-string">/switcher'</span>).<span class="hljs-property">default</span>
<span class="hljs-keyword">const</span> getRouterParams = <span class="hljs-built_in">require</span>(<span class="hljs-string">'~/sites/</span><span class="hljs-subst">${Config.site}</span><span class="hljs-string">/server/routerParams'</span>).<span class="hljs-property">default</span>
type <span class="hljs-title">Props</span> = {
<span class="hljs-attr">siteTitle</span>: string
<span class="hljs-attr">serverData</span>: any
}
<span class="hljs-keyword">const</span> <span class="hljs-title">Page</span>: <span class="hljs-variable">FC</span>&lt;<span class="hljs-title">Props</span>&gt; = <span class="hljs-function">(</span><span class="hljs-params">{ siteTitle, serverData }</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-keyword">const</span> router = <span class="hljs-title">useRouter</span>()
<span class="hljs-keyword">const</span> routerParams = <span class="hljs-title">getRouterParams</span>(router.<span class="hljs-property">query</span>)
<span class="hljs-keyword">return</span> (
<span class="hljs-tag">&lt;</span><span class="hljs-name">SwitcherPage</span><span class="hljs-tag"> </span>
<span class="hljs-attr">routerParams</span><span class="hljs-tag">=</span><span class="hljs-string">{routerParams}</span><span class="hljs-tag"> </span>
<span class="hljs-attr">siteTitle</span><span class="hljs-tag">=</span><span class="hljs-string">{siteTitle}</span><span class="hljs-tag"> </span>
<span class="hljs-attr">props</span><span class="hljs-tag">=</span><span class="hljs-string">{{</span><span class="hljs-tag"> </span><span class="hljs-attr">serverData</span><span class="hljs-tag"> }} </span>
<span class="hljs-tag">/&gt;</span>
)
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">Page</span>
</code></pre>
<p class="normal">On each Next.js page, we will import a <code class="inlineCode">SwitcherPage</code> component that exists on each site. We also import the <code class="inlineCode">routerParams</code>, which will control the routing for each site as well, and <a id="_idIndexMarker826"/>we will receive the <code class="inlineCode">siteTitle</code> via <a id="_idIndexMarker827"/>props. In other words, we just render the <code class="inlineCode">SwitcherPage</code> component and pass the props.</p>
<p class="normal">Let’s see how the <code class="inlineCode">Switcher</code> component from our <code class="inlineCode">san-pancho</code> site looks (<code class="inlineCode">packages/frontend/src/sites/san-pancho/switcher.tsx</code>):</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> dynamic <span class="hljs-keyword">from</span> <span class="hljs-string">'next/dynamic'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">Switcher</span>, { <span class="hljs-title">Props</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'~/components/Switcher'</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">dynamicPages</span>: <span class="hljs-title">Record</span>&lt;string, <span class="hljs-title">Record</span>&lt;string, any&gt;&gt; = {
<span class="hljs-attr">index</span>: {
<span class="hljs-attr">index</span>: <span class="hljs-title">dynamic</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./pages/index'</span>))
},
<span class="hljs-attr">login</span>: {
<span class="hljs-attr">index</span>: <span class="hljs-title">dynamic</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./pages/login'</span>))
},
<span class="hljs-attr">dashboard</span>: {
<span class="hljs-attr">index</span>: <span class="hljs-title">dynamic</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./pages/dashboard/index'</span>))
}
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> ({ routerParams, siteTitle, props }: <span class="hljs-title">Props</span>) =&gt; (
<span class="hljs-tag">&lt;</span><span class="hljs-name">Switcher</span>
<span class="hljs-attr">routerParams</span><span class="hljs-tag">=</span><span class="hljs-string">{routerParams}</span>
<span class="hljs-attr">siteTitle</span><span class="hljs-tag">=</span><span class="hljs-string">{siteTitle}</span>
<span class="hljs-attr">props</span><span class="hljs-tag">=</span><span class="hljs-string">{props}</span>
<span class="hljs-attr">dynamicPages</span><span class="hljs-tag">=</span><span class="hljs-string">{dynamicPages}</span>
<span class="hljs-tag">/&gt;</span>
)
</code></pre>
<p class="normal">The <code class="inlineCode">next/dynamic</code> is a composite extension of <code class="inlineCode">React.lazy</code> and <code class="inlineCode">Suspense</code>. These components can delay hydration until the <code class="inlineCode">Suspense</code> boundary is resolved. In our case, we are dynamically loading pages from this site, specifically the <code class="inlineCode">index.index</code>, <code class="inlineCode">login.index</code>, and <code class="inlineCode">dashboard.index</code>. You’re probably wondering why we have a nested index page for each of them. This is because we can have nested pages; for example, <code class="inlineCode">index.index</code> will refer to <a href="http://localhost:3000/"><span class="url">http://localhost:3000/</span></a>, <code class="inlineCode">login.index</code> to <a href="http://localhost:3000/login"><span class="url">http://localhost:3000/login</span></a>, and <code class="inlineCode">dashboard.index</code> to <a href="http://localhost:3000/dashboard"><span class="url">http://localhost:3000/dashboard</span></a>. However, suppose you want to add a page inside the dashboard like <code class="inlineCode">guests</code>. You will then add <code class="inlineCode">dashboard.guests</code>, which will point to <a href="http://localhost:3000/dashboard/guests"><span class="url">http://localhost:3000/dashboard/guests</span></a>. </p>
<p class="normal">Each <code class="inlineCode">switcher.ts</code> file <a id="_idIndexMarker828"/>from the <code class="inlineCode">sites</code> directories uses <a id="_idIndexMarker829"/>the <code class="inlineCode">Switcher</code> component. Hence, let’s create it. This file is located in <code class="inlineCode">packages/frontend/src/components/Switcher.tsx</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> <span class="hljs-title">React</span>, { <span class="hljs-variable">FC</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">ErrorPage</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'~/components/ErrorPage'</span>
type <span class="hljs-title">Route</span> = {
<span class="hljs-attr">page</span>: string
section?: string
subSection?: string
urlParams?: string[]
queryParams?: <span class="hljs-title">Record</span>&lt;string, string&gt;
}
<span class="hljs-keyword">export</span> type <span class="hljs-title">Props</span> = {
<span class="hljs-attr">routerParams</span>: <span class="hljs-title">Route</span>
<span class="hljs-attr">siteTitle</span>: string
props?: <span class="hljs-title">Record</span>&lt;string, any&gt;
<span class="hljs-attr">dynamicPages</span>: any
}
<span class="hljs-keyword">const</span> <span class="hljs-title">Switcher</span>: <span class="hljs-variable">FC</span>&lt;<span class="hljs-title">Props</span>&gt; = <span class="hljs-function">(</span><span class="hljs-params">{ routerParams, props = {}, dynamicPages: sitePages }</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-keyword">const</span> { 
page, 
section = <span class="hljs-string">'index'</span>, 
subSection = <span class="hljs-string">''</span>, 
urlParams, 
queryParams = {} 
} = routerParams
<span class="hljs-keyword">const</span> extraProps = {
queryParams,
<span class="hljs-attr">router</span>: {
section,
subsection
},
...urlParams
}
<span class="hljs-keyword">const</span> pageName = page
<span class="hljs-keyword">let</span> <span class="hljs-title">PageToRender</span> <span class="hljs-comment">// This will be a dynamic React Component </span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">sectionPages</span>: any = {}
<span class="hljs-comment">// We validate if our main page exists (index, login or dashboard)</span>
<span class="hljs-keyword">if</span> (sitePages[pageName]) {
<span class="hljs-comment">// If exists we get our sectionsPages (index.index, login.index and dashboard.index)</span>
sectionPages = sitePages[pageName]
<span class="hljs-comment">// By default we will try to render the index of each page</span>
<span class="hljs-title">PageToRender</span> = sectionPages.<span class="hljs-property">index</span>
<span class="hljs-comment">// If we have subsection, we render it (dashboard.guests)</span>
<span class="hljs-keyword">if</span> (sectionPages[section][subSection]) {
<span class="hljs-title">PageToRender</span> = sectionPages[section][subSection]
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (section !== <span class="hljs-string">'index'</span>) {
<span class="hljs-comment">// This is to render nested routes that only have index</span>
<span class="hljs-title">PageToRender</span> = sectionPages[section].<span class="hljs-property">index</span>
}
} <span class="hljs-keyword">else</span> {
<span class="hljs-comment">// If we can't find any of the pages, then we render an ErrorPage</span>
<span class="hljs-title">PageToRender</span> = <span class="hljs-title">ErrorPage</span>
}
<span class="hljs-keyword">return</span> <span class="hljs-tag">&lt;</span><span class="hljs-name">PageToRender</span><span class="hljs-tag"> {</span><span class="hljs-attr">...props</span><span class="hljs-tag">} {</span><span class="hljs-attr">...extraProps</span><span class="hljs-tag">} /&gt;</span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">Switcher</span>
</code></pre>
<p class="normal">Let’s now create<a id="_idIndexMarker830"/> the index page for our San Pancho <a id="_idIndexMarker831"/>site. This page serves a simple purpose: to display the site’s title, providing confirmation that we are currently on the San Pancho site. This file should exist in <code class="inlineCode">packages/frontend/src/sites/san-pancho/pages/index.tsx</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> <span class="hljs-title">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'</span><span class="hljs-string">react'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> () =&gt; <span class="hljs-tag">&lt;</span><span class="hljs-name">h1</span><span class="hljs-tag">&gt;</span>San Pancho Index Page<span class="hljs-tag">&lt;/</span><span class="hljs-name">h1</span><span class="hljs-tag">&gt;</span>
</code></pre>
<p class="normal">After this, we can create our index page for our dashboard (<code class="inlineCode">packages/frontend/src/sites/san-pancho/pages/dashboard/index.tsx</code>):</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> <span class="hljs-title">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> () =&gt; (
<span class="hljs-tag">&lt;&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">h1</span><span class="hljs-tag">&gt;</span>Dashboard for San Pancho<span class="hljs-tag">&lt;/</span><span class="hljs-name">h1</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">a</span><span class="hljs-tag"> </span><span class="hljs-attr">href</span><span class="hljs-tag">=</span><span class="hljs-string">"/logout"</span><span class="hljs-tag">&gt;</span>Logout<span class="hljs-tag">&lt;/</span><span class="hljs-name">a</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/&gt;</span>
)
</code></pre>
<p class="normal">Finally, we need to create our login page for <code class="inlineCode">san-pancho</code>, which will share the <code class="inlineCode">Login</code> component <a id="_idIndexMarker832"/>for all <a id="_idIndexMarker833"/>the sites (<code class="inlineCode">packages/frontend/src/sites/san-pancho/pages/login.tsx</code>):</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> <span class="hljs-title">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">Login</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'~/components/Login'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> () =&gt; <span class="hljs-tag">&lt;</span><span class="hljs-name">Login</span><span class="hljs-tag"> /&gt;</span>
</code></pre>
<h2 class="heading-2" id="_idParaDest-268">Creating our Login system</h2>
<p class="normal">All our sites will <a id="_idIndexMarker834"/>use the <a id="_idIndexMarker835"/>same login page because we share the authentication system. Let’s create our <code class="inlineCode">Login</code> component and see how we can perform the login:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">Button</span>, <span class="hljs-title">Input</span>, <span class="hljs-title">RenderIf</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@web-creator/design-system'</span>
<span class="hljs-keyword">import</span> { getRedirectToUrl, redirectTo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@web-creator/utils'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">React</span>, { <span class="hljs-variable">FC</span>, useContext, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">FormContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'~/contexts/form'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">UserContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'~/contexts/user'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable">CSS</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Login.styled'</span>
type <span class="hljs-title">Props</span> = {
  background?: string
}
<span class="hljs-keyword">const</span> <span class="hljs-title">Login</span>: <span class="hljs-variable">FC</span>&lt;<span class="hljs-title">Props</span>&gt; = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> redirectToUrl = <span class="hljs-title">getRedirectToUrl</span>()
  <span class="hljs-comment">// States</span>
  <span class="hljs-keyword">const</span> [values, setValues] = <span class="hljs-title">useState</span>({
    <span class="hljs-attr">emailOrUsername</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">''</span>
  })
  <span class="hljs-keyword">const</span> [notification, setNotification] = <span class="hljs-title">useState</span>({
    <span class="hljs-attr">id</span>: <span class="hljs-title">Math</span>.<span class="hljs-title">random</span>(),
    <span class="hljs-attr">message</span>: <span class="hljs-string">''</span>
  })
  <span class="hljs-keyword">const</span> [invalidLogin, setInvalidLogin] = <span class="hljs-title">useState</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-comment">// Contexts</span>
  <span class="hljs-keyword">const</span> { change } = <span class="hljs-title">useContext</span>(<span class="hljs-title">FormContext</span>)
  <span class="hljs-keyword">const</span> { login } = <span class="hljs-title">useContext</span>(<span class="hljs-title">UserContext</span>)
  <span class="hljs-comment">// Methods</span>
  <span class="hljs-keyword">const</span> onChange = (<span class="hljs-attr">e</span>: any): <span class="hljs-params">any</span><span class="hljs-function"> =&gt;</span> <span class="hljs-title">change</span>(e, setValues)
  <span class="hljs-keyword">const</span> handleSubmit = <span class="hljs-keyword">async</span> (<span class="hljs-attr">user</span>: any): <span class="hljs-title">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; =&gt; {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title">login</span>(user)
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">error</span>) {
      <span class="hljs-title">setInvalidLogin</span>(<span class="hljs-literal">true</span>)
      <span class="hljs-title">setNotification</span>({
        <span class="hljs-attr">id</span>: <span class="hljs-title">Math</span>.<span class="hljs-title">random</span>(),
        <span class="hljs-attr">message</span>: response.<span class="hljs-property">message</span>
      })
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title">redirectTo</span>(redirectToUrl || <span class="hljs-string">'/'</span>, <span class="hljs-literal">true</span>)
    }
  }
  <span class="hljs-keyword">return</span> (
    <span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">RenderIf</span><span class="hljs-tag"> </span><span class="hljs-attr">isTrue</span><span class="hljs-tag">=</span><span class="hljs-string">{invalidLogin</span><span class="hljs-tag"> &amp;&amp; </span><span class="hljs-attr">notification.message</span><span class="hljs-tag"> !== </span><span class="hljs-string">''</span><span class="hljs-tag">}&gt;</span>
        {notification.message}
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">RenderIf</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">CSS.Login</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">CSS.LoginBox</span><span class="hljs-tag">&gt;</span>
          <span class="hljs-tag">&lt;</span><span class="hljs-name">header</span><span class="hljs-tag">&gt;</span>
            <span class="hljs-tag">&lt;</span><span class="hljs-name">img</span><span class="hljs-tag"> </span><span class="hljs-attr">className</span><span class="hljs-tag">=</span><span class="hljs-string">"logo"</span><span class="hljs-tag"> </span><span class="hljs-attr">src</span><span class="hljs-tag">=</span><span class="hljs-string">"/images/isotype.png"</span><span class="hljs-tag"> </span><span class="hljs-attr">alt</span><span class="hljs-tag">=</span><span class="hljs-string">"Logo"</span><span class="hljs-tag"> /&gt;</span> <span class="hljs-tag">&lt;</span><span class="hljs-name">br</span><span class="hljs-tag"> /&gt;</span>
            <span class="hljs-tag">&lt;</span><span class="hljs-name">h2</span><span class="hljs-tag">&gt;</span>Sign In<span class="hljs-tag">&lt;/</span><span class="hljs-name">h2</span><span class="hljs-tag">&gt;</span>
          <span class="hljs-tag">&lt;/</span><span class="hljs-name">header</span><span class="hljs-tag">&gt;</span>
          <span class="hljs-tag">&lt;</span><span class="hljs-name">section</span><span class="hljs-tag">&gt;</span>
            <span class="hljs-tag">&lt;</span><span class="hljs-name">Input</span>
<span class="hljs-tag">              </span><span class="hljs-attr">autoComplete</span><span class="hljs-tag">=</span><span class="hljs-string">"off"</span>
<span class="hljs-tag">              </span><span class="hljs-attr">name</span><span class="hljs-tag">=</span><span class="hljs-string">"emailOrUsername"</span>
<span class="hljs-tag">              </span><span class="hljs-attr">placeholder</span><span class="hljs-tag">=</span><span class="hljs-string">"Email Or Username"</span>
<span class="hljs-tag">              </span><span class="hljs-attr">onChange</span><span class="hljs-tag">=</span><span class="hljs-string">{onChange}</span>
<span class="hljs-tag">              </span><span class="hljs-attr">value</span><span class="hljs-tag">=</span><span class="hljs-string">{values.emailOrUsername}</span>
<span class="hljs-tag">            /&gt;</span>
            <span class="hljs-tag">&lt;</span><span class="hljs-name">Input</span><span class="hljs-tag"> </span>
<span class="hljs-tag">              </span><span class="hljs-attr">name</span><span class="hljs-tag">=</span><span class="hljs-string">"password"</span>
<span class="hljs-tag">              </span><span class="hljs-attr">type</span><span class="hljs-tag">=</span><span class="hljs-string">"password"</span>
<span class="hljs-tag">              </span><span class="hljs-attr">placeholder</span><span class="hljs-tag">=</span><span class="hljs-string">"Password"</span>
<span class="hljs-tag">              </span><span class="hljs-attr">onChange</span><span class="hljs-tag">=</span><span class="hljs-string">{onChange}</span>
<span class="hljs-tag">              </span><span class="hljs-attr">value</span><span class="hljs-tag">=</span><span class="hljs-string">{values.password}</span>
<span class="hljs-tag">            /&gt;</span>
            <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">className</span><span class="hljs-tag">=</span><span class="hljs-string">"actions"</span><span class="hljs-tag">&gt;</span>
              <span class="hljs-tag">&lt;</span><span class="hljs-name">Button</span><span class="hljs-tag"> </span><span class="hljs-attr">onClick</span><span class="hljs-tag">=</span><span class="hljs-string">{():</span><span class="hljs-tag"> </span><span class="hljs-attr">Promise</span><span class="hljs-tag">&lt;</span><span class="hljs-attr">void</span><span class="hljs-tag">&gt;</span> =&gt; handleSubmit(values)}&gt;
                Login
              <span class="hljs-tag">&lt;/</span><span class="hljs-name">Button</span><span class="hljs-tag">&gt;</span>
              <span class="hljs-tag">&lt;</span><span class="hljs-name">Button</span><span class="hljs-tag"> </span><span class="hljs-attr">color</span><span class="hljs-tag">=</span><span class="hljs-string">"success"</span><span class="hljs-tag">&gt;</span>
                Register
              <span class="hljs-tag">&lt;/</span><span class="hljs-name">Button</span><span class="hljs-tag">&gt;</span>
            <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
          <span class="hljs-tag">&lt;/</span><span class="hljs-name">section</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;/</span><span class="hljs-name">CSS.LoginBox</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">CSS.Login</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span>
  )
}
export default Login
</code></pre>
<p class="normal">As you can see, the <code class="inlineCode">login</code> function that is executed in the <code class="inlineCode">handleSubmit</code> comes from our <code class="inlineCode">UserContext</code>. This will execute the <code class="inlineCode">login</code> mutation when the user needs to perform a login, and the <code class="inlineCode">getUser</code> query to validate if a logged user is valid. Let’s create<a id="_idIndexMarker836"/> that <code class="inlineCode">User Context</code> (Context API), which<a id="_idIndexMarker837"/> should be located in <code class="inlineCode">packages/frontend/src/contexts/user.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { useMutation, useQuery } <span class="hljs-keyword">from</span> <span class="hljs-string">'@apollo/client'</span>
<span class="hljs-keyword">import</span> { getGraphQlError, parseDebugData, redirectTo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@web-builder/utils'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">React</span>, { createContext, <span class="hljs-variable">FC</span>, <span class="hljs-title">ReactElement</span>, useEffect,useMemo,useState} <span class="hljs-keyword">from</span> <span class="hljs-string">'</span><span class="hljs-string">react'</span>
<span class="hljs-keyword">import</span> { useCookies } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-cookie'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">Config</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'~/config'</span>
<span class="hljs-keyword">import</span> <span class="hljs-variable">GET_USER_QUERY</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'~/graphql/user/getUser.query'</span>
<span class="hljs-keyword">import</span> <span class="hljs-variable">LOGIN_MUTATION</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'~/graphql/user/login.mutation'</span>
<span class="hljs-comment">// Interfaces</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title">IUserContext</span> {
<span class="hljs-title">login</span>(<span class="hljs-attr">input</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">any</span>
<span class="hljs-attr">user</span>: <span class="hljs-built_in">any</span>
}
<span class="hljs-keyword">type</span> <span class="hljs-title">Props</span> = {
<span class="hljs-attr">children</span>: <span class="hljs-title">ReactElement</span>
}
<span class="hljs-comment">// Creating context</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title">UserContext</span> = createContext&lt;<span class="hljs-title">IUserContext</span>&gt;({
<span class="hljs-attr">login</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">null</span>,
<span class="hljs-attr">user</span>: <span class="hljs-literal">null</span>
})
<span class="hljs-keyword">const</span> <span class="hljs-title">UserProvider</span>: <span class="hljs-variable">FC</span>&lt;<span class="hljs-title">Props</span>&gt; = <span class="hljs-function">(</span><span class="hljs-params">{ children }</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-comment">// States</span>
<span class="hljs-keyword">const</span> [cookies, setCookie] = <span class="hljs-title">useCookies</span>()
<span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title">useState</span>(<span class="hljs-literal">null</span>)
<span class="hljs-comment">// Mutations</span>
<span class="hljs-keyword">const</span> [loginMutation] = <span class="hljs-title">useMutation</span>(<span class="hljs-variable">LOGIN_MUTATION</span>)
<span class="hljs-comment">// Queries</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: dataUser } = <span class="hljs-title">useQuery</span>(<span class="hljs-variable">GET_USER_QUERY</span>, {
<span class="hljs-attr">variables</span>: {
<span class="hljs-attr">at</span>: cookies[<span class="hljs-string">'at-</span><span class="hljs-subst">${Config.site}</span><span class="hljs-string">'</span>] || <span class="hljs-string">''</span>
}
})
<span class="hljs-comment">// Effects</span>
<span class="hljs-title">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
<span class="hljs-keyword">if</span> (dataUser) {
<span class="hljs-title">setUser</span>(dataUser.<span class="hljs-property">getUser</span>)
}
}, [dataUser])
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title">login</span>(<span class="hljs-params">input:{emailOrUsername: </span><span class="hljs-built_in">string</span><span class="hljs-params">;password: </span><span class="hljs-built_in">string</span><span class="hljs-params"> }</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt; {
<span class="hljs-keyword">try</span> {
<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: dataLogin } = <span class="hljs-keyword">await</span> <span class="hljs-title">loginMutation</span>({
<span class="hljs-attr">variables</span>: {
<span class="hljs-attr">emailOrUsername</span>: input.<span class="hljs-property">emailOrUsername</span>,
<span class="hljs-attr">password</span>: input.<span class="hljs-property">password</span>
}
})
<span class="hljs-keyword">if</span> (dataLogin) {
<span class="hljs-title">setCookie</span>(<span class="hljs-string">'at-</span><span class="hljs-subst">${Config.site}</span><span class="hljs-string">'</span>, dataLogin.<span class="hljs-property">login</span>.<span class="hljs-property">token</span>, { 
<span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, 
<span class="hljs-attr">maxAge</span>: <span class="hljs-number">45</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> 
})
<span class="hljs-keyword">return</span> dataLogin.<span class="hljs-property">login</span>.<span class="hljs-property">token</span>
}
} <span class="hljs-keyword">catch</span> (err) {
<span class="hljs-keyword">return</span> <span class="hljs-title">getGraphQlError</span>(err)
}
<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
}
<span class="hljs-keyword">const</span> context = <span class="hljs-title">useMemo</span>(<span class="hljs-function">() =&gt;</span> ({
login,
user
}), [user])
<span class="hljs-keyword">return</span> <span class="hljs-tag">&lt;</span><span class="hljs-name">UserContext.Provider</span><span class="hljs-tag"> </span><span class="hljs-attr">value</span><span class="hljs-tag">=</span><span class="hljs-string">{context}</span><span class="hljs-tag">&gt;</span>{children}<span class="hljs-tag">&lt;/</span><span class="hljs-name">UserContext.Provider</span><span class="hljs-tag">&gt;</span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">UserProvider</span>
</code></pre>
<p class="normal">Now let’s create<a id="_idIndexMarker838"/> our <code class="inlineCode">login</code> mutation, which will<a id="_idIndexMarker839"/> receive two parameters (<code class="inlineCode">$emailOrUsername</code> and <code class="inlineCode">$password</code>). This file should be located in <code class="inlineCode">packages/frontend/src/graphql/user/login.mutation.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { gql } <span class="hljs-keyword">from</span> <span class="hljs-string">'@apollo/client'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> gql<span class="hljs-string">`</span>
<span class="hljs-string">mutation login($emailOrUsername: String!, $password: String!) {</span>
<span class="hljs-string">login(input: { emailOrUsername: $emailOrUsername, password: $password }) {</span>
<span class="hljs-string">token</span>
<span class="hljs-string">}</span>
<span class="hljs-string">}</span>
<span class="hljs-string">`</span>
</code></pre>
<p class="normal">After that, we need to create the <code class="inlineCode">getUser</code> query, which will take the <code class="inlineCode">accessToken</code> (<code class="inlineCode">at</code>) as a parameter and validate if the connected user is valid. This file exists in <code class="inlineCode">packages/frontend/src/graphql/user/getUser.query.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { gql } <span class="hljs-keyword">from</span> <span class="hljs-string">'@apollo/client'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> gql<span class="hljs-string">`</span>
<span class="hljs-string">query getUser($at: String!) {</span>
<span class="hljs-string">getUser(at: $at) {</span>
<span class="hljs-string">id</span>
<span class="hljs-string">email</span>
<span class="hljs-string">username</span>
<span class="hljs-string">role</span>
<span class="hljs-string">active</span>
<span class="hljs-string">}</span>
<span class="hljs-string">}</span>
<span class="hljs-string">`</span>
</code></pre>
<p class="normal">There are two more things to do. The first thing is to add our <code class="inlineCode">UserProvider</code> as a wrapper of our <a id="_idIndexMarker840"/>application; we need to do this on a special page called <code class="inlineCode">"_app.tsx"</code> inside the <code class="inlineCode">pages</code> directory:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">ApolloProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@apollo/client'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">React</span>, { <span class="hljs-variable">FC</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">Config</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'~/config'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">GlobalStyle</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'~/components/GlobalStyles/GlobalStyles'</span>
<span class="hljs-keyword">import</span> { useApollo } <span class="hljs-keyword">from</span> <span class="hljs-string">'~/contexts/apolloClient'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">FormProvider</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'~/contexts/form'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">UserProvider</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'~/contexts/user'</span>
<span class="hljs-keyword">const</span> <span class="hljs-title">App</span>: <span class="hljs-variable">FC</span>&lt;<span class="hljs-built_in">any</span>&gt; = <span class="hljs-function">(</span><span class="hljs-params">{ Component, pageProps }</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-keyword">const</span> apolloClient = <span class="hljs-title">useApollo</span>((pageProps &amp;&amp; pageProps.<span class="hljs-property">initialApolloState</span>) || {})
<span class="hljs-keyword">return</span> (
<span class="hljs-tag">&lt;&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">GlobalStyle</span><span class="hljs-tag"> /&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">ApolloProvider</span><span class="hljs-tag"> </span><span class="hljs-attr">client</span><span class="hljs-tag">=</span><span class="hljs-string">{apolloClient}</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">UserProvider</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">FormProvider</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">Component</span><span class="hljs-tag"> {</span><span class="hljs-attr">...pageProps</span><span class="hljs-tag">} /&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">FormProvider</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">UserProvider</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">ApolloProvider</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/&gt;</span>
)
}
<span class="hljs-comment">// @ts-ignore</span>
<span class="hljs-title">App</span>.<span class="hljs-property">getInitialProps</span> = <span class="hljs-keyword">async</span> () =&gt; ({
...<span class="hljs-title">Config</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">App</span>
</code></pre>
<p class="normal">Finally, we need to create another special file called <code class="inlineCode">"_document.tsx"</code> inside the <code class="inlineCode">pages</code> directory. In this file, we will render the <code class="inlineCode">ServerStyleSheet</code> from <code class="inlineCode">styled-components</code> to be <a id="_idIndexMarker841"/>able to use <code class="inlineCode">styled-components</code> in <a id="_idIndexMarker842"/>the server (Next.js):</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { cx } <span class="hljs-keyword">from</span> <span class="hljs-string">'</span><span class="hljs-string">@web-creator/utils'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">Document</span>, { <span class="hljs-title">Head</span>, <span class="hljs-title">Html</span>, <span class="hljs-title">Main</span>, <span class="hljs-title">NextScript</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/document'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">ServerStyleSheet</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'styled-components'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">Config</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'</span><span class="hljs-string">~/config'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyDocument</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Document</span> {
<span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title">getInitialProps</span>(<span class="hljs-params">ctx: </span><span class="hljs-built_in">any</span>) {
<span class="hljs-keyword">const</span> sheet = <span class="hljs-keyword">new</span> <span class="hljs-title">ServerStyleSheet</span>()
<span class="hljs-keyword">const</span> originalRenderPage = ctx.<span class="hljs-property">renderPage</span>
<span class="hljs-keyword">try</span> {
ctx.<span class="hljs-property">renderPage</span> = <span class="hljs-function">() =&gt;</span>
<span class="hljs-title">originalRenderPage</span>({
<span class="hljs-attr">enhanceApp</span>: <span class="hljs-function">(</span><span class="hljs-params">App: </span><span class="hljs-built_in">any</span><span class="hljs-function">) =&gt;</span> <span class="hljs-function">(</span><span class="hljs-params">props: </span><span class="hljs-built_in">any</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-keyword">const</span> themeClassname = <span class="hljs-string">'theme--light'</span>
<span class="hljs-keyword">return</span> sheet.<span class="hljs-title">collectStyles</span>(
<span class="hljs-tag">&lt;</span><span class="hljs-name">body</span><span class="hljs-tag"> </span><span class="hljs-attr">className</span><span class="hljs-tag">=</span><span class="hljs-string">{cx.join(themeClassname)}</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">App</span><span class="hljs-tag"> {</span><span class="hljs-attr">...props</span><span class="hljs-tag">} </span><span class="hljs-attr">title</span><span class="hljs-tag">=</span><span class="hljs-string">{Config.siteTitle}</span><span class="hljs-tag"> /&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">body</span><span class="hljs-tag">&gt;</span>
)
}
})
<span class="hljs-keyword">const</span> initialProps = <span class="hljs-keyword">await</span> <span class="hljs-title">Document</span>.<span class="hljs-title">getInitialProps</span>(ctx)
<span class="hljs-keyword">return</span> {
...initialProps,
<span class="hljs-attr">styles</span>: (
<span class="hljs-tag">&lt;&gt;</span>
{initialProps.styles}
{sheet.getStyleElement()}
<span class="hljs-tag">&lt;/&gt;</span>
)
}
} <span class="hljs-keyword">finally</span> {
sheet.<span class="hljs-title">seal</span>()
}
}
<span class="hljs-title">render</span>() {
<span class="hljs-keyword">return</span> (
<span class="hljs-tag">&lt;</span><span class="hljs-name">Html</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">Head</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">link</span><span class="hljs-tag"> </span><span class="hljs-attr">rel</span><span class="hljs-tag">=</span><span class="hljs-string">"</span><span class="hljs-string">icon"</span><span class="hljs-tag"> </span><span class="hljs-attr">type</span><span class="hljs-tag">=</span><span class="hljs-string">"image/x-icon"</span><span class="hljs-tag"> </span><span class="hljs-attr">href</span><span class="hljs-tag">=</span><span class="hljs-string">"/images/favicon.png"</span><span class="hljs-tag"> /&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">Head</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">Main</span><span class="hljs-tag"> /&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">NextScript</span><span class="hljs-tag"> /&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">Html</span><span class="hljs-tag">&gt;</span>
)
}
}
</code></pre>
<h2 class="heading-2" id="_idParaDest-269">Creating our sites configuration</h2>
<p class="normal">As we did in our<a id="_idIndexMarker843"/> API project, we <a id="_idIndexMarker844"/>need to create a configuration for our sites. Let’s start by creating our <code class="inlineCode">SiteConfiguration</code> type, the file for which will be located in <code class="inlineCode">packages/frontend/src/types/config.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">ValueOf</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@web-creator/utils'</span>
<span class="hljs-comment">// Here you add your sites</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title">Site</span> = {
<span class="hljs-title">SanPancho</span>: <span class="hljs-string">'san-pancho'</span>,
<span class="hljs-title">Codejobs</span>: <span class="hljs-string">'codejobs'</span>,
<span class="hljs-title">BlankPage</span>: <span class="hljs-string">'blank-page'</span>
} <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title">Site</span> = <span class="hljs-title">ValueOf</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title">Site</span>&gt;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title">Mode</span> = <span class="hljs-string">'production'</span> | <span class="hljs-string">'development'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title">DeploymentType</span> {
<span class="hljs-variable">PRODUCTION</span> = <span class="hljs-string">'production'</span>,
<span class="hljs-variable">STAGING</span> = <span class="hljs-string">'staging'</span>,
<span class="hljs-variable">DEVELOPMENT</span> = <span class="hljs-string">'development'</span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">SiteConfiguration</span> {
<span class="hljs-attr">siteTitle</span>: <span class="hljs-built_in">string</span>
<span class="hljs-attr">domainName</span>: <span class="hljs-built_in">string</span>
hostname?: <span class="hljs-built_in">string</span>
mode?: <span class="hljs-built_in">string</span>
api?: {
<span class="hljs-attr">uri</span>: <span class="hljs-built_in">string</span>
}
<span class="hljs-attr">pages</span>: <span class="hljs-built_in">string</span>[]
custom?: <span class="hljs-built_in">any</span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">SiteBuilderConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SiteConfiguration</span> {
<span class="hljs-attr">site</span>: <span class="hljs-title">Site</span>
<span class="hljs-attr">homeUrl</span>: <span class="hljs-built_in">string</span>
}
</code></pre>
<p class="normal">The configuration we will do is for the <code class="inlineCode">san-pancho</code> site, and you should add this file to <code class="inlineCode">packages/frontend/src/sites/san-pancho/config.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">SiteConfiguration</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../types/config'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title">SiteConfiguration</span> = {
<span class="hljs-attr">siteTitle</span>: <span class="hljs-string">'Cabañas San Pancho'</span>,
<span class="hljs-attr">domainName</span>: <span class="hljs-string">'ranchosanpancho.com'</span>,
<span class="hljs-attr">pages</span>: [<span class="hljs-string">'index'</span>, <span class="hljs-string">'login'</span>]
}
</code></pre>
<p class="normal">After this, we<a id="_idIndexMarker845"/> must create our main <code class="inlineCode">config.ts</code> file, which <a id="_idIndexMarker846"/>should be in <code class="inlineCode">packages/frontend/src/config.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { is } <span class="hljs-keyword">from</span> <span class="hljs-string">'@web-creator/utils'</span>
<span class="hljs-comment">// Importing sites configurations</span>
<span class="hljs-keyword">import</span> { config <span class="hljs-keyword">as</span> blankPageConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'./sites/blank-page/config'</span>
<span class="hljs-keyword">import</span> { config <span class="hljs-keyword">as</span> sanPanchoConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'./sites/san-pancho/config'</span>
<span class="hljs-keyword">import</span> { config <span class="hljs-keyword">as</span> codejobsConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'./sites/codejobs/config'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Site</span>, <span class="hljs-title">SiteBuilderConfiguration</span>, <span class="hljs-title">SiteConfiguration</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./types/config'</span>
<span class="hljs-keyword">const</span> isProduction = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span>
<span class="hljs-keyword">const</span> isLocal = process.<span class="hljs-property">env</span>.<span class="hljs-property">LOCAL</span> === <span class="hljs-string">'true'</span>
<span class="hljs-keyword">const</span> isLocalProduction = isProduction &amp;&amp; isLocal
<span class="hljs-comment">// Getting site configuration</span>
<span class="hljs-keyword">const</span> getSiteConfig = (<span class="hljs-attr">site</span>: <span class="hljs-title">Site</span>): <span class="hljs-params">SiteConfiguration</span><span class="hljs-function"> =&gt;</span> {
<span class="hljs-keyword">switch</span> (site) {
<span class="hljs-keyword">case</span> <span class="hljs-title">Site</span>.<span class="hljs-property">SanPancho</span>:
<span class="hljs-keyword">return</span> sanPanchoConfig
<span class="hljs-keyword">case</span> <span class="hljs-title">Site</span>.<span class="hljs-property">Codejobs</span>:
<span class="hljs-keyword">return</span> codejobsConfig
<span class="hljs-attr">default</span>:
<span class="hljs-keyword">return</span> blankPageConfig
}
}
<span class="hljs-comment">// Building configuration</span>
<span class="hljs-keyword">const</span> buildConfig = (): <span class="hljs-params">SiteBuilderConfiguration</span><span class="hljs-function"> =&gt;</span> {
<span class="hljs-comment">// Server site</span>
<span class="hljs-keyword">let</span> site = process.<span class="hljs-property">env</span>.<span class="hljs-property">SITE</span> <span class="hljs-keyword">as</span> <span class="hljs-title">Site</span>
<span class="hljs-comment">// On client side we grab the site from Next props</span>
<span class="hljs-keyword">if</span> (is.<span class="hljs-title">Browser</span>()) {
<span class="hljs-keyword">const</span> { props } = <span class="hljs-variable">window</span>.<span class="hljs-property">__NEXT_DATA__</span>
<span class="hljs-keyword">if</span> (props &amp;&amp; props.<span class="hljs-property">site</span>) {
site = props.<span class="hljs-property">site</span>
}
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!site) {
<span class="hljs-keyword">throw</span> <span class="hljs-string">'You must specify a site (E.g. SITE=san-pancho npm run dev)'</span>
}
<span class="hljs-keyword">const</span> siteConfig = <span class="hljs-title">getSiteConfig</span>(site)
<span class="hljs-comment">// Building configuration based on the environment and site configuration</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title">SiteBuilderConfiguration</span> = {
...siteConfig,
<span class="hljs-attr">api</span>: {
<span class="hljs-attr">uri</span>: isProduction &amp;&amp; !isLocalProduction
? <span class="hljs-string">`https://</span><span class="hljs-subst">${siteConfig.domainName}</span><span class="hljs-string">/graphql`</span>
: <span class="hljs-string">`http://localhost:4000/graphql`</span>
},
site,
<span class="hljs-attr">homeUrl</span>: <span class="hljs-string">`https://</span><span class="hljs-subst">${siteConfig.domainName}</span><span class="hljs-string">`</span>,
<span class="hljs-attr">hostname</span>: isProduction &amp;&amp; !isLocalProduction ? siteConfig.<span class="hljs-property">domainName</span> : <span class="hljs-string">'localhost'</span>,
<span class="hljs-attr">mode</span>: isProduction ? <span class="hljs-string">'production'</span> : <span class="hljs-string">'development'</span>
}
<span class="hljs-keyword">return</span> config
}
<span class="hljs-keyword">const</span> <span class="hljs-title">Config</span> = <span class="hljs-title">buildConfig</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">Config</span>
</code></pre>
<h2 class="heading-2" id="_idParaDest-270">Putting everything together</h2>
<p class="normal">The last piece of the puzzle is our <code class="inlineCode">server.ts</code> file, which will handle Next.js, our static directories, and routes. Let’s break down the file into parts and see each one in detail. This file should be in <code class="inlineCode">packages/frontend/src/server.ts</code>.</p>
<p class="normal">The first thing we need to do is to import some dependencies and the site configuration:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> cookieParser <span class="hljs-keyword">from</span> <span class="hljs-string">'cookie-parser'</span>
<span class="hljs-keyword">import</span> express, { <span class="hljs-title">Application</span>, <span class="hljs-title">NextFunction</span>, <span class="hljs-title">Request</span>, <span class="hljs-title">Response</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>
<span class="hljs-keyword">import</span> nextJS <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
<span class="hljs-keyword">import</span> { ts } <span class="hljs-keyword">from</span> <span class="hljs-string">'@web-creator/utils'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">Config</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./config'</span>
<span class="hljs-keyword">import</span> { isConnected } <span class="hljs-keyword">from</span> <span class="hljs-string">'./lib/middlewares/user'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Site</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./types/config'</span>
</code></pre>
<p class="normal">Then we need to check that the <code class="inlineCode">SITE</code> being passed in the terminal is actually valid:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Site</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">site</span>: <span class="hljs-built_in">string</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">SITE</span> ?? <span class="hljs-string">'blank-page'</span>
<span class="hljs-comment">// Validating service</span>
<span class="hljs-keyword">if</span> (!ts.<span class="hljs-title">includes</span>(<span class="hljs-title">Site</span>, site)) {
<span class="hljs-keyword">throw</span> <span class="hljs-string">'Invalid site'</span>
}
</code></pre>
<p class="normal">If the site is valid, then we prepare our <code class="inlineCode">Next</code> and <code class="inlineCode">Express</code> applications:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Setting up Next App</span>
<span class="hljs-keyword">const</span> { hostname } = <span class="hljs-title">Config</span>
<span class="hljs-keyword">const</span> port = <span class="hljs-number">3000</span>
<span class="hljs-keyword">const</span> dev = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">'production'</span>
<span class="hljs-keyword">const</span> nextApp = <span class="hljs-title">nextJS</span>({ dev, hostname, port })
<span class="hljs-keyword">const</span> handle = nextApp.<span class="hljs-title">getRequestHandler</span>()
<span class="hljs-comment">// Running Next App</span>
nextApp.<span class="hljs-title">prepare</span>().<span class="hljs-title">then</span>(<span class="hljs-function">() =&gt;</span> {
<span class="hljs-comment">// Express application</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">app</span>: <span class="hljs-title">Application</span> = <span class="hljs-title">express</span>()
</code></pre>
<p class="normal">We also need to configure our <code class="inlineCode">cookieParser</code> to be able to use cookies and set up our site’s static directories, so we can have a shared <code class="inlineCode">public</code> folder and then specific <code class="inlineCode">static</code> directories inside each site:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Cookies</span>
app.<span class="hljs-title">use</span>(<span class="hljs-title">cookieParser</span>())
<span class="hljs-comment">// Sites static directories</span>
app.<span class="hljs-title">use</span>(express.<span class="hljs-title">static</span>(path.<span class="hljs-title">join</span>(__dirname, <span class="hljs-string">'</span><span class="hljs-string">../public'</span>)))
app.<span class="hljs-title">use</span>(express.<span class="hljs-title">static</span>(path.<span class="hljs-title">join</span>(__dirname, <span class="hljs-string">'./sites/</span><span class="hljs-subst">${Config.site}</span><span class="hljs-string">/static'</span>)))
</code></pre>
<p class="normal">Next, we’ll handle our custom routes next and add additional protection to specific routes, such as <code class="inlineCode">/dashboard</code>. We want to ensure that only connected users can access this route. For this, we will use the <code class="inlineCode">isConnected</code> middleware to validate whether a user is connected. If the user is not connected, we will redirect them to the login page:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Custom Routes</span>
app.<span class="hljs-title">get</span>(<span class="hljs-string">'/logout'</span>, <span class="hljs-function">(</span><span class="hljs-params">req: Request, res: Response</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-keyword">const</span> <span class="hljs-attr">redirect</span>: <span class="hljs-built_in">any</span> = req.<span class="hljs-property">query</span>.<span class="hljs-property">redirectTo</span> || <span class="hljs-string">'/'</span>
<span class="hljs-comment">// The "at (accessToken)" cookie will be per site, like: "at-san-pancho" or "at-codejobs".</span>
res.<span class="hljs-title">clearCookie</span>(<span class="hljs-string">'at-</span><span class="hljs-subst">${Config.site}</span><span class="hljs-string">'</span>)
res.<span class="hljs-title">redirect</span>(redirect)
})
app.<span class="hljs-title">get</span>(
<span class="hljs-string">'/dashboard'</span>,
<span class="hljs-title">isConnected</span>(<span class="hljs-literal">true</span>, [<span class="hljs-string">'god'</span>, <span class="hljs-string">'admin'</span>, <span class="hljs-string">'editor'</span>], <span class="hljs-string">'/login?redirectTo=/dashboard'</span>),
<span class="hljs-function">(</span><span class="hljs-params">req: Request, res: Response, next: NextFunction</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">next</span>()
)
</code></pre>
<p class="normal">Finally, all other traffic is going to be handled by Next.js; then we listen to port <code class="inlineCode">3000</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Traffic handling</span>
app.<span class="hljs-title">all</span>(<span class="hljs-string">'*'</span>, <span class="hljs-function">(</span><span class="hljs-params">req: Request, res: Response</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">handle</span>(req, res))
<span class="hljs-comment">// Listening...</span>
app.<span class="hljs-title">listen</span>(<span class="hljs-number">3000</span>)
</code></pre>
<h2 class="heading-2" id="_idParaDest-271">Demo time!</h2>
<p class="normal">After all of those <a id="_idIndexMarker847"/>configurations, we are ready to run our project and see if it works. We will need to run it in a similar way to how we did on the API, but instead of the <code class="inlineCode">SERVICE</code> variable, we will use the <code class="inlineCode">SITE</code> variable. We also need to specify which site we want to run (<code class="inlineCode">san-pancho</code> or <code class="inlineCode">codejobs</code>). If you try to run some other site that does not exist, you will get an error. Let’s try that to test the validation of the sites:</p>
<p class="packt_figref"><img alt="Text  Description automatically generated" height="291" src="../Images/B18414_14_16.png" width="825"/></p>
<p class="packt_figref">Figure 14.16: getGuests query</p>
<p class="normal">The validation works fine. Now, let’s run our <code class="inlineCode">san-pancho</code> site with the <code class="inlineCode">SITE=san-pancho npm run dev</code> command:</p>
<p class="packt_figref"><img alt="Graphical user interface, text, application, chat or text message  Description automatically generated" height="171" src="../Images/B18414_14_17.png" width="490"/></p>
<p class="packt_figref">Figure 14.17: San Pancho Index Page</p>
<p class="normal">If everything works<a id="_idIndexMarker848"/> fine, you should see the preceding. Next, let’s run our <code class="inlineCode">codejobs</code> site with <code class="inlineCode">SITE=codejobs npm run dev</code>:</p>
<p class="packt_figref"><img alt="Graphical user interface, text, application, chat or text message  Description automatically generated" height="156" src="../Images/B18414_14_18.png" width="434"/></p>
<p class="packt_figref">Figure 14.18: Codejobs Index Page</p>
<p class="normal">Nice, so both our sites work as expected!</p>
<p class="normal">Now it’s time to test our login page for each site. Let’s start with San Pancho:</p>
<p class="packt_figref"><img alt="Graphical user interface, text, application, chat or text message  Description automatically generated" height="608" src="../Images/B18414_14_19.png" width="332"/></p>
<p class="packt_figref">Figure 14.19: San Pancho Sign In page</p>
<p class="normal">Then let’s test<a id="_idIndexMarker849"/> the Codejobs login page:</p>
<p class="packt_figref"><img alt="Graphical user interface, application  Description automatically generated" height="552" src="../Images/B18414_14_20.png" width="311"/></p>
<p class="packt_figref">Figure 14.20: Codejobs Sign In page</p>
<p class="normal">Everything seems<a id="_idIndexMarker850"/> good so far. Now let’s test the login with our default credentials, which are <strong class="keyWord">username</strong>: <code class="inlineCode">admin</code> and <strong class="keyWord">password</strong>:<strong class="keyWord"> </strong><code class="inlineCode">12345678</code>:</p>
<p class="packt_figref"><img alt="Graphical user interface, text, application, email  Description automatically generated" height="239" src="../Images/B18414_14_21.png" width="599"/></p>
<p class="packt_figref">Figure 14.21: Dashboard for San Pancho</p>
<p class="normal">Nice! So now we are connected to San Pancho’s dashboard. </p>
<p class="normal">One thing I want to highlight here is the cookie name we used for the user session, which is <code class="inlineCode">at-san-pancho</code>. However, even if you already performed a login in San Pancho, if you try to access the Codejobs dashboard, you will be required to log in again because each site session is independent of the other:</p>
<p class="packt_figref"><img alt="" height="79" src="../Images/B18414_14_22.png" width="825"/></p>
<p class="packt_figref">Figure 14.22: Site cookies</p>
<p class="normal">Finally, let’s test <a id="_idIndexMarker851"/>hitting a URL that does not exist on our sites:</p>
<p class="packt_figref"><img alt="Graphical user interface, website  Description automatically generated" height="648" src="../Images/B18414_14_23.png" width="825"/></p>
<p class="packt_figref">Figure 14.23: 404 error page</p>
<p class="normal">You should see a <code class="inlineCode">404</code> page that will be shared across both sites.</p>
<h1 class="heading-1" id="_idParaDest-272">Summary</h1>
<p class="normal">Congratulations on making it this far! Without a doubt, this chapter has been complex, yet incredibly interesting. Now, you have the bare bones ready to begin working on your personal websites.</p>
<p class="normal">Throughout the course of this chapter, you acquired a comprehensive set of skills. You learned how to create <code class="inlineCode">User</code> models and GraphQL types, understand error handling, and set up custom services like a CRM. You successfully navigated through the process of building a Sites system, enhanced user experience with a Page Switcher, and established a shared login system. Furthermore, you gained knowledge in managing configurations, working with “seeds” or default data for models, and consolidating components into a command file such as <code class="inlineCode">server.ts</code>. As a result, you are now proficient in synchronizing models, starting up the Apollo Server, running tests, and effectively troubleshooting any issues that may arise. In essence, you have established a robust foundation in managing multi-site web systems, enhancing user experience, understanding GraphQL, and troubleshooting.</p>
<p class="normal">In the next chapter, you will have the opportunity to expand your skills further as you learn how to improve the performance of your React applications.</p>
</div>
</div></body></html>