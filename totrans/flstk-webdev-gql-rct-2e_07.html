<html><head></head><body>
		<div id="_idContainer048">
			<h1 id="_idParaDest-100"><em class="italic"><a id="_idTextAnchor123"/>Chapter 5</em>: Reusable React Components and React Hooks</h1>
			<p>We have done a lot to reach this point in the book, including saving, requesting, inserting, and updating data through the use of Apollo Client, in connection with our GraphQL <strong class="bold">application programming interface</strong> (<strong class="bold">API</strong>). Much of the code that we have written will also have to be reviewed many times. This is especially important because we are building an application so quickly. Everything is working for now, but we have not done a great job here; there are some best practices and tactics that need to be observed in order to write good React applications.</p>
			<p>This chapter will cover everything you need to know to write efficient and reusable React components. It will cover the following topics:</p>
			<ul>
				<li>Introducing React patterns</li>
				<li>Structuring our React application</li>
				<li>Extending Graphbook</li>
				<li>Documenting React applications</li>
			</ul>
			<h1 id="_idParaDest-101"><a id="_idTextAnchor124"/>Technical requirements</h1>
			<p>The source code for this chapter is available in the following GitHub repository: </p>
			<p><a href="https://github.com/PacktPublishing/Full-Stack-Web-Development-with-GraphQL-and-React-Second-Edition/tree/main/Chapter05">https://github.com/PacktPublishing/Full-Stack-Web-Development-with-GraphQL-and-React-Second-Edition/tree/main/Chapter05</a></p>
			<h1 id="_idParaDest-102"><a id="_idTextAnchor125"/>Introducing React patterns</h1>
			<p>With any programming language, framework, or library that you use, there are always common tactics<a id="_idIndexMarker376"/> that you should follow. They present an understandable, efficient way to write applications.</p>
			<p>In <a href="B17337_04_Final_ASB_ePub.xhtml#_idTextAnchor085"><em class="italic">Chapter 4</em></a>, <em class="italic">Hooking Apollo into React</em>, we tackled some patterns, such as rendering arrays, the spread operator, and destructuring objects. Nevertheless, there are some further patterns that you should know about.</p>
			<p>We will go over the most commonly used patterns<a id="_idIndexMarker377"/> that React offers, as follows:</p>
			<ul>
				<li>Controlled components</li>
				<li>Functional components</li>
				<li>Conditional rendering</li>
				<li>Rendering children</li>
			</ul>
			<p>Many (but not all) of the examples here only represent illustrations of what each method looks like. Some of them will not be taken over to our real application code, so if you are not interested in learning the essential aspects of patterns or if you already know most of them, you can skip the examples.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Beyond the short explanation that I will provide, there is more extensive documentation on this topic. The official React documentation is always a good starting point, but you can find all React patterns, including those<a id="_idIndexMarker378"/> that we have already used, at <a href="https://reactpatterns.com/">https://reactpatterns.com/</a>.</p>
			<h2 id="_idParaDest-103"><a id="_idTextAnchor126"/>Controlled components</h2>
			<p>When we wrote<a id="_idIndexMarker379"/> our post form to submit new posts or the message inputs<a id="_idIndexMarker380"/> inside chat in the previous chapters, we used controlled input by incident. To provide a better understanding, I am going to quickly explain the difference between controlled and uncontrolled components, and when to use each of them.</p>
			<p>Let's start with uncontrolled input.</p>
			<p>By definition, a component is uncontrolled whenever the value is not set by a property through React, but only<a id="_idIndexMarker381"/> saved and taken from the real browser <strong class="bold">Document Object Model</strong> (<strong class="bold">DOM</strong>). The value of an input is then retrieved from a reference to the DOM Node and is not managed and taken from React's component state.</p>
			<p>The following code snippet shows the post form where the user will be able to submit new posts. I have excluded the rendering<a id="_idIndexMarker382"/> logic for the complete feed, as it is not a part<a id="_idIndexMarker383"/> of the pattern that I want to show you:</p>
			<p class="source-code">import React, { useState, useRef } from 'react';</p>
			<p class="source-code">import { gql, useQuery, useMutation } from '@apollo/client';</p>
			<p class="source-code">const ADD_POST = gql'</p>
			<p class="source-code">  mutation addPost($post : PostInput!) {</p>
			<p class="source-code">    addPost(post : $post) {</p>
			<p class="source-code">      id</p>
			<p class="source-code">      text</p>
			<p class="source-code">      user {</p>
			<p class="source-code">        username</p>
			<p class="source-code">        avatar</p>
			<p class="source-code">      }</p>
			<p class="source-code">    }</p>
			<p class="source-code">  }</p>
			<p class="source-code">';</p>
			<p class="source-code">const Feed = () =&gt; {</p>
			<p class="source-code">  const textArea = useRef(null)</p>
			<p class="source-code">  const [addPost] = useMutation(ADD_POST);</p>
			<p class="source-code">  const handleSubmit = (event) =&gt; {</p>
			<p class="source-code">    event.preventDefault();</p>
			<p class="source-code">    addPost({ variables: { post: { text: </p>
			<p class="source-code">      textArea.current.value } } });</p>
			<p class="source-code">  };</p>
			<p class="source-code">  return (</p>
			<p class="source-code">    &lt;div className="container"&gt;</p>
			<p class="source-code">      &lt;div className="postForm"&gt;</p>
			<p class="source-code">        &lt;form onSubmit={handleSubmit}&gt;</p>
			<p class="source-code">          &lt;textarea ref={textArea} placeholder="Write your</p>
			<p class="source-code">            custom post!"/&gt;</p>
			<p class="source-code">          &lt;input type="submit" value="Submit" /&gt;</p>
			<p class="source-code">        &lt;/form&gt;</p>
			<p class="source-code">      &lt;/div&gt;</p>
			<p class="source-code">    &lt;/div&gt;</p>
			<p class="source-code">  )</p>
			<p class="source-code">}</p>
			<p class="source-code">export default Feed</p>
			<p>In this example, you can see that we no longer have the <strong class="source-inline">useState</strong> Hook, since the <strong class="source-inline">textarea</strong> value is stored within the real DOM Node, and not the application state.</p>
			<p>We run the <strong class="source-inline">useRef</strong> Hook provided<a id="_idIndexMarker384"/> by React. It prepares the variable<a id="_idIndexMarker385"/> to accept the DOM Node as a property. If you are using class-based React components, you can use the <strong class="source-inline">createRef</strong> function.</p>
			<p>In the <strong class="source-inline">return</strong> statement for rendering the component, the <strong class="source-inline">ref</strong> property fills in the reference that we just created with the DOM element.</p>
			<p>Accessing the value of the DOM Node works by using the normal JavaScript DOM API. You can see this behavior when sending the <strong class="source-inline">submit</strong> event of our form. The value is extracted from the <strong class="source-inline">textArea.current.value</strong> field.</p>
			<p>Everything that an uncontrolled component needs is already shown here; there is no more to it. You can compare this approach to our current implementation of the post form. In our implementation, we set up the state, listen for change events, and save and read the value directly from the component state, not from the DOM element.</p>
			<p>When using uncontrolled components and working directly with DOM elements, the problem is that you leave the normal React workflow. You are no longer able to handle conditions and, therefore, trigger other events inside of React.</p>
			<p>Nevertheless, the DOM reference<a id="_idIndexMarker386"/> can make it easier to use third-party plugins<a id="_idIndexMarker387"/> that were not written for the React ecosystem. There are thousands of great jQuery plugins, for example. I always recommend using the default approach of a controlled component. For 99% of cases, this works without leaving the React workflow.</p>
			<p class="callout-heading">Tip</p>
			<p class="callout">If you need a deeper understanding of which<a id="_idIndexMarker388"/> approach is a better solution for your specific case, take a look at <a href="https://goshakkk.name/controlled-vs-uncontrolled-inputs-react/">https://goshakkk.name/controlled-vs-uncontrolled-inputs-react/</a>.</p>
			<h2 id="_idParaDest-104"><a id="_idTextAnchor127"/>Functional components</h2>
			<p>One fundamental and efficient solution for writing well-structured and reusable React components is the use of functional<a id="_idIndexMarker389"/> components. We have already used them throughout the book at every location.</p>
			<p>Before the existence of functional components, there were stateless functions. As you might expect, stateless<a id="_idIndexMarker390"/> functions are functions, not React components. They are not able to store any states; only properties can be used to pass and render data. Property updates are directly rerendered inside the stateless functions.</p>
			<p>Since newer versions of React, those stateless functions no longer exist as there are React Hooks that allow us to use state in those functions, which makes them fully functional components. This is why they are now called functional components.</p>
			<p>We have written a lot of code where more functional components can help us provide more structured and understandable code.</p>
			<p>Beginning with the file structure, we will create a new folder for our new components, as follows:</p>
			<p class="source-code">mkdir src/client/components</p>
			<p>Many parts of our application<a id="_idIndexMarker391"/> need to be reworked. Create a new file<a id="_idIndexMarker392"/> for our first functional component, as follows:</p>
			<p class="source-code">touch src/client/components/loading.js</p>
			<p>Currently, we display a dull and boring <strong class="bold">Loading...</strong> message when our GraphQL requests are running. Let's change this by inserting the following code into the <strong class="source-inline">loading.js</strong> file:</p>
			<p class="source-code">import React from 'react';</p>
			<p class="source-code">export default ({color, size}) =&gt; {</p>
			<p class="source-code">  var style = {</p>
			<p class="source-code">    backgroundColor: '#6ca6fd',</p>
			<p class="source-code">    width: 40,</p>
			<p class="source-code">    height: 40,</p>
			<p class="source-code">  };</p>
			<p class="source-code">  if(typeof color !== typeof undefined) {</p>
			<p class="source-code">    style.color = color;</p>
			<p class="source-code">  }</p>
			<p class="source-code">  if(typeof size !== typeof undefined) {</p>
			<p class="source-code">    style.width = size;</p>
			<p class="source-code">    style.height = size;</p>
			<p class="source-code">  }</p>
			<p class="source-code">  return &lt;div className="bouncer" style={style}&gt;&lt;/div&gt;</p>
			<p class="source-code">}</p>
			<p>In the preceding code<a id="_idIndexMarker393"/> snippet, we are using a simple function in <strong class="bold">ECMAScript 6</strong> (<strong class="bold">ES6</strong>) arrow notation. This will actually be a pure stateless<a id="_idIndexMarker394"/> function as we do not use any React<a id="_idIndexMarker395"/> Hook, as it is just not required for this simple component. In the code, you can see that we are extracting the <strong class="source-inline">color</strong> and <strong class="source-inline">size</strong> fields from the properties that our function receives.</p>
			<p>We are building a default <strong class="source-inline">style</strong> object that represents the basic styling for a loading spinner. You can pass the <strong class="source-inline">color</strong> and <strong class="source-inline">size</strong> values separately, to adjust those settings.</p>
			<p>Lastly, we are returning<a id="_idIndexMarker396"/> a simple <strong class="source-inline">div</strong> tag with the <strong class="bold">Cascading Style Sheets</strong> (<strong class="bold">CSS</strong>) style and the <strong class="source-inline">bouncer</strong> class.</p>
			<p>What's missing here is the CSS styling. The code should look like this; we'll just add it to our <strong class="source-inline">style.css</strong> file:</p>
			<p class="source-code">.bouncer {</p>
			<p class="source-code">  margin: 20px auto;</p>
			<p class="source-code">  border-radius: 100%; </p>
			<p class="source-code">  -webkit-animation: bounce 1.0s infinite ease-in-out;</p>
			<p class="source-code">  animation: bounce 1.0s infinite ease-in-out;</p>
			<p class="source-code">}</p>
			<p class="source-code">@-webkit-keyframes bounce {</p>
			<p class="source-code">  0% {</p>
			<p class="source-code">    -webkit-transform: scale(0)</p>
			<p class="source-code">  }</p>
			<p class="source-code">  100% {</p>
			<p class="source-code">    -webkit-transform: scale(1.0);</p>
			<p class="source-code">    opacity: 0;</p>
			<p class="source-code">  }</p>
			<p class="source-code">}</p>
			<p class="source-code">@keyframes bounce {</p>
			<p class="source-code">  0% { </p>
			<p class="source-code">    -webkit-transform: scale(0);</p>
			<p class="source-code">    transform: scale(0);</p>
			<p class="source-code">  }</p>
			<p class="source-code">  100% {</p>
			<p class="source-code">    -webkit-transform: scale(1.0);</p>
			<p class="source-code">    transform: scale(1.0);</p>
			<p class="source-code">    opacity: 0;</p>
			<p class="source-code">  }</p>
			<p class="source-code">}</p>
			<p>As in the previous examples, we use CSS animations to display our loading spinner correctly and to let it animate as pulsating.</p>
			<p>We have now finished the functional<a id="_idIndexMarker397"/> component. You should place<a id="_idIndexMarker398"/> it into the existing code, wherever a loading state exists.</p>
			<p>First, import the new loading spinner to the top of your files, as follows:</p>
			<p class="source-code">import Loading from './components/loading';</p>
			<p>You can then render the functional component, as follows:</p>
			<p class="source-code">if (loading) return &lt;Loading /&gt;;</p>
			<p>Start the server with <strong class="source-inline">npm run server</strong> and the frontend with <strong class="source-inline">npm run client</strong>. You should now see a pulsating blue bubble where you inserted it. I have tested this inside of my posts feed, and it looks pretty good.</p>
			<p>The advantage of functional components<a id="_idIndexMarker399"/> is that they are minimal and efficient functions, rendering<a id="_idIndexMarker400"/> smaller parts of our application. The approach perfectly integrates with React, and we can improve upon the code that we have written.</p>
			<h2 id="_idParaDest-105"><a id="_idTextAnchor128"/>Conditional rendering</h2>
			<p>One important ability of React is rendering components or data conditionally. We will use this intensively<a id="_idIndexMarker401"/> in the next main features that we are going<a id="_idIndexMarker402"/> to implement.</p>
			<p>Generally, you can accomplish conditional rendering by using the curly brace syntax. An example of an <strong class="source-inline">if</strong> statement is provided here:</p>
			<p class="source-code">const [shouldRender, setShouldRender] = useState(false);</p>
			<p class="source-code">return (</p>
			<p class="source-code">  &lt;div className="conditional"&gt;</p>
			<p class="source-code">    {(shouldRender === true) &amp;&amp; (</p>
			<p class="source-code">      &lt;p&gt;Successful conditional rendering!&lt;/p&gt;</p>
			<p class="source-code">    )}</p>
			<p class="source-code">  &lt;/div&gt;</p>
			<p class="source-code">)</p>
			<p>This code is the simplest example of conditional rendering. We have the <strong class="source-inline">shouldRender</strong> variable from the component state, and we use this as our condition. When the condition is <strong class="source-inline">true</strong>, the second part—which is our <strong class="source-inline">Successful conditional rendering!</strong> text—will also render. That is because we are using the <strong class="source-inline">&amp;&amp;</strong> characters. The text does not render if the condition is <strong class="source-inline">false</strong>.</p>
			<p>You can replace the preceding condition with anything that you have in mind. It can be a complex condition, such<a id="_idIndexMarker403"/> as a function returning a Boolean value, or just as in the preceding code, it can be a state variable.</p>
			<p>You will see further examples in later steps and chapters of this book.</p>
			<h2 id="_idParaDest-106"><a id="_idTextAnchor129"/>Rendering child components</h2>
			<p>In all of the code that we have<a id="_idIndexMarker404"/> written so far, we have directly written<a id="_idIndexMarker405"/> the markup as though it is rendered to real <strong class="bold">HyperText Markup Language</strong> (<strong class="bold">HTML</strong>).</p>
			<p>A great feature that React offers<a id="_idIndexMarker406"/> is the ability to pass children to other components. The parent component decides what is done with its children.</p>
			<p>Something that we are still missing is a good error message for our users. So, we will use this pattern to solve the issue.</p>
			<p>Create an <strong class="source-inline">error.js</strong> file next to the <strong class="source-inline">loading.js</strong> file in the <strong class="source-inline">components</strong> folder, as follows:</p>
			<p class="source-code">import React from 'react';</p>
			<p class="source-code">export default ({ children }) =&gt; {</p>
			<p class="source-code">  return (</p>
			<p class="source-code">    &lt;div className="error message"&gt;</p>
			<p class="source-code">      {children}</p>
			<p class="source-code">    &lt;/div&gt;</p>
			<p class="source-code">  );</p>
			<p class="source-code">}</p>
			<p>When passing children to another component, a new property, called <strong class="source-inline">children</strong>, is added to the properties of the component. You specify <strong class="source-inline">children</strong> by writing normal React markup.</p>
			<p>If you wanted to, you could perform actions, such as looping through each child. In our example, we render the children as usual, by using curly braces and putting the <strong class="source-inline">children</strong> variable inside.</p>
			<p>To start using the new <strong class="source-inline">Error</strong> component, you can simply import it. The markup for the new component is shown here:</p>
			<p class="source-code">if (error) return &lt;Error&gt;&lt;p&gt;{error.message}&lt;/p&gt;&lt;/Error&gt;;</p>
			<p>Add some CSS, and everything should be finished, as shown in the following code snippet:</p>
			<p class="source-code">.message {</p>
			<p class="source-code">  margin: 20px auto;</p>
			<p class="source-code">  padding: 5px;</p>
			<p class="source-code">  max-width: 400px;</p>
			<p class="source-code">}</p>
			<p class="source-code">.error.message {</p>
			<p class="source-code">  border-radius: 5px;</p>
			<p class="source-code">  background-color: #FFF7F5;</p>
			<p class="source-code">  border: 1px solid #FF9566;</p>
			<p class="source-code">  width: 100%;</p>
			<p class="source-code">}</p>
			<p>A working result might look like this:</p>
			<div>
				<div id="_idContainer040" class="IMG---Figure">
					<img src="image/Figure_5.01_B17337.jpg" alt="Figure 5.1 – Error message&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.1 – Error message</p>
			<p>You can apply the stateless function<a id="_idIndexMarker407"/> pattern and the children<a id="_idIndexMarker408"/> pattern to many other use cases. Which one you use will depend on your specific scenario. In this case, you could also use a stateless function, rather than a React component.</p>
			<p>Next, we are going to have a look at how we can improve our code structure, together with the fundamentals that React is following.</p>
			<h1 id="_idParaDest-107"><a id="_idTextAnchor130"/>Structuring our React application</h1>
			<p>We have already improved some things by using React patterns. You should do some homework and introduce those patterns wherever possible.</p>
			<p>When writing<a id="_idIndexMarker409"/> applications, one key objective is to keep them modular and readable but also as understandable as possible. It is always hard to tell when splitting code up is useful and when it overcomplicates things. This is something that you will learn more and more about by writing as many applications and as much code as possible.</p>
			<p>Let's begin to structure our application further.</p>
			<h2 id="_idParaDest-108"><a id="_idTextAnchor131"/>The React file structure</h2>
			<p>We have already saved our <strong class="source-inline">Loading</strong> and <strong class="source-inline">Error</strong> components in the <strong class="source-inline">components</strong> folder. Still, there are many parts of our components that we did not save in separate files<a id="_idIndexMarker410"/> to improve the readability of this book.</p>
			<p>I will explain the most important solution for unreadable React code in one example. You can implement this on your own later for all other parts of our application, as you should not read duplicate code.</p>
			<p>Currently, we render the posts in our feed by mapping through all posts from the GraphQL response. There, we directly render the corresponding markup for all post items. Therefore, it is one big render function that does everything at once.</p>
			<p>To make this a bit more intuitive, we should create a new <strong class="source-inline">Post</strong> component. Separating the components hugely improves the readability of our posts feed. Then, we can replace the return value from the loop with a new component, instead of real markup.</p>
			<p>Instead of creating a <strong class="source-inline">post.js</strong> file in our <strong class="source-inline">components</strong> folder, we should first create another <strong class="source-inline">post</strong> folder, as follows:</p>
			<p class="source-code">mkdir src/client/components/post</p>
			<p>The <strong class="source-inline">Post</strong> component consists of multiple tiny, nested components. A post is also a standalone GraphQL entity, making it logical to have a separate folder. We will store all related components in this folder.</p>
			<p>Let's create those components. We will start with the post header, where the top part of a post item<a id="_idIndexMarker411"/> is defined. Create a new <strong class="source-inline">header.js</strong> file in the <strong class="source-inline">components/post</strong> folder, as follows:</p>
			<p class="source-code">import React from 'react';</p>
			<p class="source-code">export default ({post}) =&gt; {</p>
			<p class="source-code">  return (</p>
			<p class="source-code">    &lt;div className="header"&gt;</p>
			<p class="source-code">      &lt;img src={post.user.avatar} /&gt;</p>
			<p class="source-code">      &lt;div&gt;</p>
			<p class="source-code">        &lt;h2&gt;{post.user.username}&lt;/h2&gt;</p>
			<p class="source-code">      &lt;/div&gt;</p>
			<p class="source-code">    &lt;/div&gt;</p>
			<p class="source-code">  );</p>
			<p class="source-code">}</p>
			<p>The <strong class="source-inline">header</strong> component is just a functional component. As you can see, we are using a React pattern from the earlier pages of this chapter.</p>
			<p>Up next is the post content, which represents the body of a post item. Add the following code inside of a new file, called <strong class="source-inline">content.js</strong>:</p>
			<p class="source-code">import React from 'react';</p>
			<p class="source-code">export default ({post}) =&gt; </p>
			<p class="source-code">  &lt;p className="content"&gt;</p>
			<p class="source-code">    {post.text}</p>
			<p class="source-code">  &lt;/p&gt;</p>
			<p>The code is pretty much the same as that of the post header. At later points, you will be free to introduce real React components<a id="_idIndexMarker412"/> or extended markup to those two files. It is entirely open to your implementation.</p>
			<p>The main file is a new <strong class="source-inline">index.js</strong> file in the new <strong class="source-inline">post</strong> folder. It should look like this:</p>
			<p class="source-code">import React from 'react';</p>
			<p class="source-code">import PostHeader from './header';</p>
			<p class="source-code">import PostContent from './content';</p>
			<p class="source-code">const Post = ({ post }) =&gt; {</p>
			<p class="source-code">  return (</p>
			<p class="source-code">    &lt;div className={"post " + (post.id &lt; 0 ? "optimistic": </p>
			<p class="source-code">      "")}&gt;</p>
			<p class="source-code">      &lt;PostHeader post={post}/&gt;</p>
			<p class="source-code">      &lt;PostContent post={post}/&gt;</p>
			<p class="source-code">    &lt;/div&gt;</p>
			<p class="source-code">  )</p>
			<p class="source-code">}</p>
			<p class="source-code">export default Post</p>
			<p>The preceding code represents a very basic component, but instead of directly using markup to render a complete post item (as we did before), we are using two further components for this, with <strong class="source-inline">PostHeader</strong> and <strong class="source-inline">PostContent</strong>. Both of the components receive <strong class="source-inline">post</strong> as a property.</p>
			<p>You can now use the new <strong class="source-inline">Post</strong> component in the feed list with ease. First, import the component, as follows:</p>
			<p class="source-code">import Post from './components/post';</p>
			<p>The good thing when having an <strong class="source-inline">index.js</strong> file is that you can reduce the path by directly pointing to the folder and the <strong class="source-inline">index.js</strong> file will be picked up automatically. Then, just replace the old code inside the loop, as follows:</p>
			<p class="source-code">&lt;Post key={post.id} post={post} /&gt;</p>
			<p>The improvement is that all three of the components give you a clear overview at first glance. Inside of the loop, we return<a id="_idIndexMarker413"/> a post item. A post item consists of a header and body content.</p>
			<p>Still, there is room for enhancement, because the posts feed list is cluttered.</p>
			<h2 id="_idParaDest-109"><a id="_idTextAnchor132"/>Efficient Apollo React components</h2>
			<p>We have successfully replaced<a id="_idIndexMarker414"/> the post items in our feed with a React component, instead of raw markup.</p>
			<p>A major part, which I dislike very much, is the way we define and pass the actual GraphQL query or mutation to the <strong class="source-inline">useQuery</strong> or <strong class="source-inline">useMutation</strong> Hook within the components. It would be good to define those GraphQL requests once and use them everywhere they are needed so that we can use them across different components.</p>
			<p>Furthermore, not only should the pure GraphQL requests be reusable but the <strong class="source-inline">update</strong> function or the <strong class="source-inline">optimisticResponse</strong> object should also be reusable across different components.</p>
			<p>As an example, we will fix those issues for <strong class="source-inline">Feed.js</strong> in the next section.</p>
			<h3>Using fragments with Apollo</h3>
			<p>A GraphQL fragment<a id="_idIndexMarker415"/> is a functionality that allows you to share common queries or pieces<a id="_idIndexMarker416"/> of them between different bigger GraphQL queries. For example, if you have different GraphQL queries that request a <strong class="source-inline">user</strong> object and the data structure for this user is always the same, you can define a user fragment to reuse the same attributes across multiple different GraphQL requests.</p>
			<p>We will implement this for our <strong class="source-inline">GET_POSTS</strong> query. Follow the next instructions:</p>
			<ol>
				<li>Create a new <strong class="source-inline">queries</strong> folder and a <strong class="source-inline">fragments</strong> folder inside of the <strong class="source-inline">apollo</strong> folder, as follows:<p class="source-code"><strong class="bold">mkdir src/client/apollo/queries</strong></p><p class="source-code"><strong class="bold">mkdir src/client/apollo/fragments</strong></p></li>
				<li>Create a file called <strong class="source-inline">userAttributes.js</strong> inside the <strong class="source-inline">fragments</strong> folder and fill in the following lines of code:<p class="source-code">import { gql } from '@apollo/client';</p><p class="source-code">export const USER_ATTRIBUTES = gql'</p><p class="source-code">  fragment userAttributes on User {</p><p class="source-code">    username</p><p class="source-code">    avatar</p><p class="source-code">  }</p><p class="source-code">';</p><p>For all <strong class="source-inline">user</strong> objects that we have requested so far, we have always returned the username and the avatar<a id="_idIndexMarker417"/> image, as we always display the name in the user<a id="_idIndexMarker418"/> profile image. In the preceding code snippet, we implemented the matching GraphQL fragment, which we can now use in any other query where we want to request exactly this data.</p></li>
				<li>Create a file called <strong class="source-inline">getPosts.js</strong> inside the <strong class="source-inline">queries</strong> folder. Add the following content to it:<p class="source-code">import { gql } from '@apollo/client';</p><p class="source-code">import { USER_ATTRIBUTES } from '../fragments/userAttributes';</p><p class="source-code">export const GET_POSTS = gql'</p><p class="source-code">  query postsFeed($page: Int, $limit: Int) {</p><p class="source-code">    postsFeed(page: $page, limit: $limit) {</p><p class="source-code">      posts {</p><p class="source-code">        id</p><p class="source-code">        text</p><p class="source-code">        user {</p><p class="source-code">          ...userAttributes</p><p class="source-code">        }</p><p class="source-code">      }</p><p class="source-code">    }</p><p class="source-code">  }</p><p class="source-code">  ${USER_ATTRIBUTES}</p><p class="source-code">';</p><p>In the preceding code snippet, we are making use of our newly created GraphQL fragment. Firstly, we of course import it at the top of the file. Inside the GraphQL query, we use the <strong class="source-inline">…userAttributes</strong> syntax, which is similar to the normal JavaScript destructuring assignment and spreads the fragment with the same name up to inject those properties at the specified location in the GraphQL query. The last step<a id="_idIndexMarker419"/> is to add a fragment below the actual<a id="_idIndexMarker420"/> query to be able to make use of it. </p></li>
				<li>The last step is to simply replace the old <strong class="source-inline">GET_POSTS</strong> variable that we have manually parsed inside the <strong class="source-inline">Feed.js</strong> file with this <strong class="source-inline">import</strong> statement:<p class="source-code">import { GET_POSTS } from './apollo/queries/getPosts';</p></li>
			</ol>
			<p>At this point, we are successfully using the fragment within our main <strong class="source-inline">GET_POSTS</strong> query, which we also can reuse just by importing it into any other component. You can repeat this for all the other requests and, by doing so, reach a cleaner code structure and more reusability.</p>
			<h3>Reusing Apollo Hooks</h3>
			<p>We did a good job extracting<a id="_idIndexMarker421"/> the GraphQL query from our component into separate reusable files.</p>
			<p>Still, we have some amount of logic in our component where we define how the <strong class="source-inline">update</strong> function and <strong class="source-inline">optimisticResponse</strong> object for the GraphQL mutations are handled. We can also extract these to further improve reusability and clear the code.</p>
			<p>One problem with the use of the Apollo or React Hooks is that they need to be executed within the functional component. Still, we can save the biggest amount of the Hook configuration outside of the component to make them reusable.</p>
			<p>Follow the next instructions to accomplish this for the <strong class="source-inline">addPost</strong> mutation:</p>
			<ol>
				<li value="1">Create a new <strong class="source-inline">mutations</strong> folder inside the <strong class="source-inline">apollo</strong> folder, as follows:<p class="source-code"><strong class="bold">mkdir src/client/apollo/mutations</strong></p></li>
				<li>Create a file called <strong class="source-inline">addPost.js</strong> and insert the following code into it:<p class="source-code">import { gql } from '@apollo/client';</p><p class="source-code">import { USER_ATTRIBUTES } from '../fragments/userAttributes';</p><p class="source-code">export const ADD_POST = gql'</p><p class="source-code">  mutation addPost($post : PostInput!) {</p><p class="source-code">    addPost(post : $post) {</p><p class="source-code">      id</p><p class="source-code">      text</p><p class="source-code">      user {</p><p class="source-code">        ...userAttributes</p><p class="source-code">      }</p><p class="source-code">    }</p><p class="source-code">  }</p><p class="source-code">  ${USER_ATTRIBUTES}</p><p class="source-code">';</p><p>The great thing is that we can reuse the fragment we have created before here, so we do not need to define it again. </p></li>
				<li>We can use this <strong class="source-inline">ADD_POST</strong> variable in the <strong class="source-inline">Feed.js</strong> file for our mutation. Replace the actual parsed GraphQL query with the following <strong class="source-inline">import</strong> statement:<p class="source-code">import { ADD_POST } from './apollo/mutations/addPost';</p></li>
				<li>We still have the <strong class="source-inline">update</strong> function and the <strong class="source-inline">optimisticResponse</strong> object within our <strong class="source-inline">useMutation</strong> Hook. It's easiest<a id="_idIndexMarker422"/> to also move them to the <strong class="source-inline">addPost.js</strong> file, as follows:<p class="source-code">export const getAddPostConfig = (postContent) =&gt; ({</p><p class="source-code">  optimisticResponse: {</p><p class="source-code">    __typename: "mutation",</p><p class="source-code">    addPost: {</p><p class="source-code">      __typename: "Post",</p><p class="source-code">      text: postContent,</p><p class="source-code">      id: -1,</p><p class="source-code">      user: {</p><p class="source-code">        __typename: "User",</p><p class="source-code">        username: "Loading...",</p><p class="source-code">        avatar: "/public/loading.gif"</p><p class="source-code">      }</p><p class="source-code">    }</p><p class="source-code">  },</p><p class="source-code">  update(cache, { data: { addPost } }) {</p><p class="source-code">    cache.modify({</p><p class="source-code">      fields: {</p><p class="source-code">        postsFeed(existingPostsFeed) {</p><p class="source-code">          const { posts: existingPosts } =</p><p class="source-code">            existingPostsFeed;</p><p class="source-code">          const newPostRef = cache.writeFragment({</p><p class="source-code">            data: addPost,</p><p class="source-code">            fragment: gql'</p><p class="source-code">              fragment NewPost on Post {</p><p class="source-code">                id</p><p class="source-code">                type</p><p class="source-code">              }</p><p class="source-code">            '</p><p class="source-code">          });</p><p class="source-code">          return {</p><p class="source-code">            ...existingPostsFeed,</p><p class="source-code">            posts: [newPostRef, ...existingPosts]</p><p class="source-code">          };</p><p class="source-code">        }</p><p class="source-code">      }</p><p class="source-code">    });</p><p class="source-code">  }</p><p class="source-code">});</p><p>We are returning a function on import so that we can pass all required parameters. The only expected parameter is the <strong class="source-inline">postContent</strong> state variable, which is required for the <strong class="source-inline">optimisticResponse</strong> object.</p></li>
				<li>Update the <strong class="source-inline">import</strong> statement<a id="_idIndexMarker423"/> inside the <strong class="source-inline">Feed.js</strong> file again to also import the <strong class="source-inline">getAddPostConfig</strong> function, as follows: <p class="source-code">import { ADD_POST, getAddPostConfig } from './apollo/mutations/addPost';</p></li>
				<li>The final <strong class="source-inline">useState</strong> Hook should then look like this:<p class="source-code">const [addPost] = useMutation(ADD_POST, getAddPostConfig(postContent));</p><p>We execute <strong class="source-inline">getAddPostConfig</strong> as the second parameter of the <strong class="source-inline">useMutation</strong> Hook. It will be filled with the returned object but will still have the <strong class="source-inline">postContent</strong> value inside the <strong class="source-inline">optimisticResponse</strong> object, as every time the value changes, the <strong class="source-inline">getAddPostConfig</strong> function will also be run.</p></li>
				<li>We can go even further. Add the following line of code to the <strong class="source-inline">addPost.js</strong> file:<p class="source-code">export const useAddPostMutation = (postContent) =&gt; useMutation(ADD_POST, getAddPostConfig(postContent));</p><p>We will replace the plain <strong class="source-inline">useMutation</strong> Hook in our component and instead build a small wrapper around it. It will accept the <strong class="source-inline">postContent</strong> value to pass it further to the <strong class="source-inline">getAddPostConfig</strong> function. The advantage will be that we can just import the <strong class="source-inline">useAddPostMutation</strong> function and, after executing it, all default configurations are applied and we are able to use that inside any component without having to import the query, the configuration, and the <strong class="source-inline">useMutation</strong> Hook separately.</p></li>
				<li>Change the import of the <strong class="source-inline">addPost.js</strong> file inside the <strong class="source-inline">Feed.js</strong> file, as follows:<p class="source-code">import { useAddPostMutation } from './apollo/mutations/addPost';</p></li>
				<li>Replace the <strong class="source-inline">useMutation</strong> Hook with the following line of code and remove the <strong class="source-inline">useMutation</strong> import while doing so:<p class="source-code">const [addPost] = useAddPostMutation(postContent);</p><p>We only need to import one function to get the full-fledged <strong class="source-inline">addPost</strong> mutation running in any component we want it to be in. This concept will work with any query or mutations we have used so far.</p></li>
			</ol>
			<p>We cleaned up the functional component from most of the GraphQL request logic and have it in separate files now. We can use the query or the mutation at any location where we need them.</p>
			<p>I recommend that you repeat the same for all other locations so that you have a nicely filled set of GraphQL requests<a id="_idIndexMarker424"/> that we are able to reuse anywhere we want. This would be a good homework exercise to learn that concept.</p>
			<p>Next, we will have a look at how we can extend Graphbook.</p>
			<h1 id="_idParaDest-110"><a id="_idTextAnchor133"/>Extending Graphbook</h1>
			<p>Our social network is still a bit rough. Aside from the fact that we are still missing authentication, all of the features<a id="_idIndexMarker425"/> are pretty basic; writing and reading the posts and messages is nothing exceptional.</p>
			<p>If you compare it to Facebook, there are many things that we need to do. Of course, we cannot rebuild Facebook in its totality, but the usual features should be there. From my point of view, we should cover<a id="_idIndexMarker426"/> the following features:</p>
			<ul>
				<li>Adding a drop-down menu to the posts to allow deletion of posts.</li>
				<li>Creating a global <strong class="source-inline">user</strong> object with the React Context API.</li>
				<li>Using Apollo cache as an alternative to the React Context API.</li>
				<li>Implementing a top bar as the first component rendered above all of the views. We can search for users in our database from a search bar, and we can show the logged-in user<a id="_idIndexMarker427"/> from the global <strong class="source-inline">user</strong> object.</li>
			</ul>
			<p>We will begin by looking at the first feature.</p>
			<h2 id="_idParaDest-111"><a id="_idTextAnchor134"/>The React context menu</h2>
			<p>You should be able<a id="_idIndexMarker428"/> to write the React context menu pretty much on your own. All the required React patterns have been explained, and implementing the mutations<a id="_idIndexMarker429"/> should be clear by now.</p>
			<p>Before we begin, we will lay out the plan that we want to follow. We'll aim to do this:</p>
			<ul>
				<li>Render a simple icon with Font Awesome</li>
				<li>Build React helper components</li>
				<li>Handle the <strong class="source-inline">onClick</strong> event and set the correct component state</li>
				<li>Use the conditional rendering pattern to show the drop-down menu, if the component state is set correctly</li>
				<li>Add buttons to the menu and bind mutations to them</li>
			</ul>
			<p>Continue reading to find out how to get the job done.</p>
			<p>The following is a preview screenshot, showing how the final implemented feature should look:</p>
			<div>
				<div id="_idContainer041" class="IMG---Figure">
					<img src="image/Figure_5.02_B17337.jpg" alt="Figure 5.2 – Drop-down with context&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.2 – Drop-down with context</p>
			<p>We will now start with the first task of setting up Font Awesome for our project.</p>
			<h3>Font Awesome in React</h3>
			<p>As you may have noticed, we have not installed Font Awesome yet. Let's fix this with <strong class="source-inline">npm</strong>, as follows:</p>
			<p class="source-code">npm i --save @fortawesome/fontawesome-svg-core @fortawesome/free-solid-svg-icons @fortawesome/free-brands-svg-icons @fortawesome/react-fontawesome</p>
			<p>Graphbook relies<a id="_idIndexMarker430"/> on the preceding four packages to import<a id="_idIndexMarker431"/> the Font Awesome icons into our frontend code.</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">Font Awesome<a id="_idIndexMarker432"/> provides multiple configurations for use with React. The best, most production-ready approach is to import only the icons that we are explicitly going to use. For your next project or prototype, it might make sense to get started with the simplest<a id="_idIndexMarker433"/> approach. You can find all of the information on the official page, at <a href="https://fontawesome.com/v5.15/how-to-use/on-the-web/using-with/react">https://fontawesome.com/v5.15/how-to-use/on-the-web/using-with/react</a>.</p>
			<p>Creating a separate file for Font Awesome will help us to have a clean import. Save the following code<a id="_idIndexMarker434"/> under the <strong class="source-inline">fontawesome.js</strong> file, inside of the <strong class="source-inline">components</strong> folder:</p>
			<p class="source-code">import { library } from '@fortawesome/fontawesome-svg-core';</p>
			<p class="source-code">import { faAngleDown } from '@fortawesome/free-solid-svg-icons';</p>
			<p class="source-code">library.add(faAngleDown);</p>
			<p>First, we import the <strong class="source-inline">library</strong> object from the Font Awesome core package. For our specific use case, we only need one arrow image, called <strong class="source-inline">angle-down</strong>. Using the <strong class="source-inline">library.add</strong> function, we register this icon for later use.</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">There are many versions of Font Awesome. In this book, we are using Font Awesome 5, with free icons only. More premium icons can be bought on the official Font Awesome web page. You can find an overview of all of<a id="_idIndexMarker435"/> the icons, and a detailed description of each, in the icon gallery at <a href="https://fontawesome.com/icons?d=gallery">https://fontawesome.com/icons?d=gallery</a>.</p>
			<p>The only place where we need this file is within our root <strong class="source-inline">App.js</strong> file. It ensures that all of our custom React<a id="_idIndexMarker436"/> components can display the imported icons. Add the following <strong class="source-inline">import</strong> statement to the top of the file:</p>
			<p class="source-code">import './components/fontawesome';</p>
			<p>No variable is required to save the exported methods since there won't be any. We want to execute this file in our application only once.</p>
			<p>When you reach a point where your application needs a complete set of icons, you can get all the icons<a id="_idIndexMarker437"/> grouped directly from the <strong class="source-inline">@fortawesome/free-brands-svg-icons</strong> package, which we also installed.</p>
			<p>Next, we are going to create a <strong class="source-inline">Dropdown</strong> helper component.</p>
			<h3>React helper components</h3>
			<p>Production-ready applications need to be as polished as possible. Implementing reusable React components is one of the most important things to do.</p>
			<p>You should notice that drop-down menus<a id="_idIndexMarker438"/> are a common topic when building client-side applications. They are global parts<a id="_idIndexMarker439"/> of the frontend and appear everywhere throughout our components.</p>
			<p>It would be best to separate the actual menu markup that we want to display from the code, which handles the event-binding and shows the menu.</p>
			<p>I always call this kind of code in React <strong class="bold">helper components</strong>. They are not implementing any business logic but give us the opportunity to reuse drop-down menus or other features wherever we want.</p>
			<p>Logically, the first step is to create a new folder to store all of the helper components, as follows:</p>
			<p class="source-code">mkdir src/client/components/helpers</p>
			<p>Create a new file, called <strong class="source-inline">dropdown.js</strong>, as the helper<a id="_idIndexMarker440"/> component, as follows:</p>
			<p class="source-code">import React, { useState, useRef, useEffect } from 'react';</p>
			<p class="source-code">export default ({ trigger, children }) =&gt; {</p>
			<p class="source-code">  const [show, setShow] = useState(false);</p>
			<p class="source-code">  const wrapperRef = useRef(null);</p>
			<p class="source-code">  useOutsideClick(wrapperRef);</p>
			<p class="source-code">  function useOutsideClick(ref) {</p>
			<p class="source-code">    useEffect(() =&gt; {</p>
			<p class="source-code">      function handleClickOutside(event) {</p>
			<p class="source-code">        if (ref.current &amp;&amp;</p>
			<p class="source-code">            !ref.current.contains(event.target)) {</p>
			<p class="source-code">          setShow(false);</p>
			<p class="source-code">        }</p>
			<p class="source-code">      }</p>
			<p class="source-code">      document.addEventListener("mousedown", </p>
			<p class="source-code">        handleClickOutside);</p>
			<p class="source-code">      return () =&gt; {</p>
			<p class="source-code">        document.removeEventListener("mousedown",</p>
			<p class="source-code">          handleClickOutside);</p>
			<p class="source-code">      };</p>
			<p class="source-code">    }, [ref]);</p>
			<p class="source-code">  }</p>
			<p class="source-code">  return(</p>
			<p class="source-code">    &lt;div className="dropdown"&gt;</p>
			<p class="source-code">      &lt;div&gt;</p>
			<p class="source-code">        &lt;div className="trigger" onClick={() =&gt; </p>
			<p class="source-code">          setShow(!show)}&gt;</p>
			<p class="source-code">          {trigger}</p>
			<p class="source-code">        &lt;/div&gt;</p>
			<p class="source-code">        &lt;div ref={wrapperRef}&gt;</p>
			<p class="source-code">          { show &amp;&amp;</p>
			<p class="source-code">            &lt;div className="content"&gt;</p>
			<p class="source-code">              {children}</p>
			<p class="source-code">            &lt;/div&gt;</p>
			<p class="source-code">          }</p>
			<p class="source-code">        &lt;/div&gt;</p>
			<p class="source-code">      &lt;/div&gt;</p>
			<p class="source-code">    &lt;/div&gt;</p>
			<p class="source-code">  )</p>
			<p class="source-code">}</p>
			<p>We do not require much code to write a drop-down component. It is also pretty efficient since this works with nearly every scenario that you can think of.</p>
			<p>We use basic event handling in the preceding<a id="_idIndexMarker441"/> code snippet. When the trigger <strong class="source-inline">div</strong> tag is clicked, we update the <strong class="source-inline">show state</strong> variable. Inside of the <strong class="source-inline">div</strong> trigger, we also render a property called <strong class="source-inline">trigger</strong>. A <strong class="source-inline">trigger</strong> property can be anything from regular text or an HTML tag to a React<a id="_idIndexMarker442"/> component. It can be passed through the parent components in order<a id="_idIndexMarker443"/> to customize the look of the drop-down component.</p>
			<p>In addition to the <strong class="source-inline">trigger</strong> property, we are using two well-known React patterns, as follows:</p>
			<ul>
				<li>Conditional rendering when the <strong class="source-inline">show</strong> variable is <strong class="source-inline">true</strong></li>
				<li>Rendering children given by the parent component</li>
			</ul>
			<p>This solution allows us to fill in the menu items that we want to render directly as children of the <strong class="source-inline">Dropdown</strong> component, which, as mentioned previously, is displayed after clicking on the trigger. In this case, the <strong class="source-inline">show</strong> state variable is <strong class="source-inline">true</strong>.</p>
			<p>However, one thing is still not completely correct here. If you test the drop-down component by providing simple text or an icon as a trigger and other text as the content, you should see that the <strong class="source-inline">Dropdown</strong> component only closes when clicking on the trigger again; it does not close when clicking anywhere else in our browser, outside of the drop-down menu.</p>
			<p>This is one scenario where the React approach encounters problems. There is no DOM Node event such as <strong class="source-inline">useOutsideClick</strong>, so we cannot directly listen to the outside click events of any DOM Node, such as our drop-down menu. The conventional approach is to bind an event listener to the complete document. Clicking anywhere in our browser closes the drop-down menu.</p>
			<p>The <strong class="source-inline">useOutSideClick</strong> Hook just checks if the clicked element matches the reference that we set up through the <strong class="source-inline">useRef</strong> Hook.</p>
			<p>When clicking<a id="_idIndexMarker444"/> on the trigger button, we add the click event listener to the whole document with the <strong class="source-inline">addEventListener</strong> function of JavaScript. </p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">There are many cases where it might make sense to leave the React approach and use the DOM directly, through the standard JavaScript interface. </p>
			<p class="callout">Read this article on <em class="italic">Medium</em> to get a better understanding: <a href="https://medium.com/@garrettmac/reactjs-how-to-safely-manipulate-the-dom-when-reactjs-cant-the-right-way-8a20928e8a6">https://medium.com/@garrettmac/reactjs-how-to-safely-manipulate-the-dom-when-reactjs-cant-the-right-way-8a20928e8a6</a>.</p>
			<p>The <strong class="source-inline">useEffect</strong> Hook is executed only on first rendering of the component. You can execute any kind of logic there. If the return value is a function too, this function will be executed on unmount of the component. By doing that, we do not forget to remove all the manually created event listeners whenever the component is unmounted and removed from the DOM. Forgetting this can lead to many errors.</p>
			<p>As mentioned previously, this is the part where React fails at least a little bit, although it is not the fault of React. The DOM and JavaScript do not have the right abilities.</p>
			<p>We can finally use<a id="_idIndexMarker445"/> our helper component and display the<a id="_idIndexMarker446"/> context menus for posts, but first, we need to prepare all of the menu items and components that we want to render.</p>
			<h3>The Apollo deletePost mutation</h3>
			<p>A mutation is always located<a id="_idIndexMarker447"/> at two points in our code. One part is written inside of our GraphQL API in the backend, and the other one is written in our frontend code.</p>
			<p>We should start with the<a id="_idIndexMarker448"/> implementation on the backend side, as follows:</p>
			<ol>
				<li value="1">Edit the GraphQL schema. The <strong class="source-inline">deletePost</strong> mutation needs to go inside of the <strong class="source-inline">RootMutation</strong> object. The new <strong class="source-inline">Response</strong> type serves as a return value, as deleted posts cannot be returned because they do not exist. Note in the following code snippet that we only need the <strong class="source-inline">postId</strong> parameter and do not send the complete post:<p class="source-code">type Response {</p><p class="source-code">  success: Boolean</p><p class="source-code">}</p><p class="source-code">deletePost (</p><p class="source-code">  postId: Int!</p><p class="source-code">): Response</p></li>
				<li>Add the missing GraphQL resolver function. The <strong class="source-inline">destroy</strong> function of Sequelize only returns a number that represents the number of deleted rows. We return an object with the <strong class="source-inline">success</strong> field. This field<a id="_idIndexMarker449"/> indicates whether our frontend should throw an error. The code<a id="_idIndexMarker450"/> is illustrated in the following snippet:<p class="source-code">deletePost(root, { postId }, context) {</p><p class="source-code">  return Post.destroy({</p><p class="source-code">    where: {</p><p class="source-code">      id: postId</p><p class="source-code">    }</p><p class="source-code">  }).then(function(rows){</p><p class="source-code">    if(rows === 1){</p><p class="source-code">      logger.log({</p><p class="source-code">        level: 'info',</p><p class="source-code">        message: 'Post ' + postId + 'was deleted',</p><p class="source-code">      });</p><p class="source-code">      return {</p><p class="source-code">        success: true</p><p class="source-code">      };</p><p class="source-code">    }</p><p class="source-code">    return {</p><p class="source-code">      success: false</p><p class="source-code">    };</p><p class="source-code">  }, function(err){</p><p class="source-code">    logger.log({</p><p class="source-code">      level: 'error',</p><p class="source-code">      message: err.message,</p><p class="source-code">    });</p><p class="source-code">  });</p><p class="source-code">},</p></li>
			</ol>
			<p>The only special thing here is that we need to specify which posts we want to delete. This is done by having the <strong class="source-inline">where</strong> property inside of the function call. Because we currently do not have authentication implemented yet, we cannot verify the user deleting the post, but for our example, this is no problem.</p>
			<p>In short, our GraphQL API<a id="_idIndexMarker451"/> is now able to accept the <strong class="source-inline">deletePost</strong> mutation. We do not verify which user sends this mutation, so for our example, posts can be deleted by anyone.</p>
			<p>We can now focus on the frontend again.</p>
			<p>Recall how we implemented<a id="_idIndexMarker452"/> the previous mutations; we always created reusable functions and configurations for them. We should do the same for the <strong class="source-inline">delete</strong> mutation.</p>
			<p>Let's start by implementing the <strong class="source-inline">deletePost</strong> mutation for the client, as follows:</p>
			<ol>
				<li value="1">Create a new file, called <strong class="source-inline">deletePost.js</strong>, inside of the <strong class="source-inline">mutations</strong> folder. </li>
				<li>Import all the dependencies, as follows:<p class="source-code">import { gql } from '@apollo/client';</p><p class="source-code">import { useMutation } from '@apollo/client';</p></li>
				<li>Add the new <strong class="source-inline">deletePost</strong> mutation, as follows:<p class="source-code">export const DELETE_POST = gql'</p><p class="source-code">  mutation deletePost($postId : Int!) {</p><p class="source-code">    deletePost(postId : $postId) {</p><p class="source-code">      success</p><p class="source-code">    }</p><p class="source-code">  }</p><p class="source-code">';</p></li>
				<li>Add a new function to handle<a id="_idIndexMarker453"/> the configuration of the<a id="_idIndexMarker454"/> mutation, as follows:<p class="source-code">export const getDeletePostConfig = (postId) =&gt; ({</p><p class="source-code">  update(cache, { data: { deletePost: { success } } })</p><p class="source-code">    {</p><p class="source-code">    if(success) {</p><p class="source-code">      cache.modify({</p><p class="source-code">        fields: {</p><p class="source-code">          postsFeed(postsFeed, { readField }) {</p><p class="source-code">            return {</p><p class="source-code">              ...postsFeed,</p><p class="source-code">              posts: postsFeed.posts.filter(postRef =&gt;</p><p class="source-code">                postId !== readField('id', postRef))</p><p class="source-code">            }</p><p class="source-code">          }</p><p class="source-code">        }</p><p class="source-code">      });</p><p class="source-code">    }</p><p class="source-code">  }</p><p class="source-code">});</p><p>To remove an item, we need<a id="_idIndexMarker455"/> to clean the array from the post with the given <strong class="source-inline">postId</strong> value. The easiest way to<a id="_idIndexMarker456"/> do that is to return the complete object of <strong class="source-inline">postsFeed</strong>, and while doing so, we let the normal JavaScript <strong class="source-inline">filter</strong> function return only those posts not having the <strong class="source-inline">postId</strong> value inside. To read the <strong class="bold">identifier</strong> (<strong class="bold">ID</strong>) of the current<a id="_idIndexMarker457"/> post, we use the <strong class="source-inline">readField</strong> function given by Apollo.</p></li>
				<li>Lastly, insert the wrapper function for the <strong class="source-inline">useMutation</strong> Hook, as follows:<p class="source-code">export const useDeletePostMutation = (postId) =&gt; useMutation(DELETE_POST, getDeletePostConfig(postId));</p></li>
			</ol>
			<p>I have removed the <strong class="source-inline">optimisticResponse</strong> update for the <strong class="bold">user interface</strong> (<strong class="bold">UI</strong>) since it is not intuitive<a id="_idIndexMarker458"/> if the request fails because then the UI would first show an optimistic update, but under failure, put the post back again as the API call failed. This would make your post disappear and reappear again.</p>
			<p>We need to add our drop-down menu<a id="_idIndexMarker459"/> to the post header with a new item so that we can call the <strong class="source-inline">deletePost</strong> mutation. Follow these instructions to add it:</p>
			<ol>
				<li value="1">Open the <strong class="source-inline">header.js</strong> file and import the drop-down component, <strong class="source-inline">fontawesome</strong>, and the mutation, as follows:<p class="source-code">import Dropdown from '../helpers/dropdown';</p><p class="source-code">import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';</p><p class="source-code">import { useDeletePostMutation } from '../../apollo/mutations/deletePost';</p></li>
				<li>Run the <strong class="source-inline">useDeletePostMutation</strong> Hook before the <strong class="source-inline">return</strong> statement, as follows:<p class="source-code">const [deletePost] = useDeletePostMutation(post.id);</p></li>
				<li>Add the new button to our header beneath the <strong class="source-inline">div</strong> tag with the username, like this:<p class="source-code">&lt;Dropdown trigger={&lt;FontAwesomeIcon icon="angle-down" /&gt;}&gt;</p><p class="source-code">  &lt;button onClick={() =&gt; deletePost({ variables: {</p><p class="source-code">    postId: post.id }})}&gt;Delete&lt;/button&gt;</p><p class="source-code">&lt;/Dropdown&gt;</p></li>
			</ol>
			<p>The overall solution is very simple. We have a wrapping drop-down component. All children will be only rendered if the <strong class="source-inline">show</strong> state variable is changed. This includes our <strong class="bold">Delete</strong> button. The <strong class="bold">Delete</strong> button just receives the <strong class="source-inline">deletePost</strong> mutation and triggers on click. The mutation itself is separated from the actual code to render the view.</p>
			<p>You can get the correct CSS from the GitHub repository.</p>
			<p>We have now covered the retrieval and deletion of posts. The update of posts is more or less the same—instead of adding or removing, you need to update the post not only via its ID in the database but also in the Apollo cache. The approach is the same, though.</p>
			<p>I expect that you are now prepared for advanced scenarios, where communication between multiple components on different layers is required. Consequently, when starting<a id="_idIndexMarker460"/> the server and client, you should be presented with the preview image<a id="_idIndexMarker461"/> that I gave you when starting this section.</p>
			<p>To get some more practice, we will repeat this for another use case in the next section.</p>
			<h2 id="_idParaDest-112"><a id="_idTextAnchor135"/>The React application bar</h2>
			<p>In contrast with Facebook, we do not have an outstanding<a id="_idIndexMarker462"/> application bar. The plan is to implement something similar. It is fixed to always stay at the top<a id="_idIndexMarker463"/> of the browser window, above all parts of the Graphbook. You will be able to search for other users, see notifications, and see the logged-in user inside the application bar, after going through this section.</p>
			<p>The first thing that we will implement is a simple search for users because it is complex.</p>
			<p>The following screenshot shows a preview of what we are going to build:</p>
			<div>
				<div id="_idContainer042" class="IMG---Figure">
					<img src="image/Figure_5.03_B17337.jpg" alt="Figure 5.3 – Search results&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.3 – Search results</p>
			<p>It looks basic, but what we are doing here is binding the <strong class="source-inline">onChange</strong> event of an input and refetching the query every time the value changes. Logically, this rerenders the search list in accordance with the responses from our GraphQL API.</p>
			<p>Starting with the API, we need to introduce a new entity.</p>
			<p>Just as with our <strong class="source-inline">postsFeed</strong> query, we will set up pagination from the beginning, because later, we might<a id="_idIndexMarker464"/> want to offer more advanced functionalities, such as loading more items while scrolling through the search list.</p>
			<p>Edit the GraphQL schema and fill in the new <strong class="source-inline">RootQuery</strong> property and type, as follows:</p>
			<p class="source-code">type UsersSearch {</p>
			<p class="source-code">  users: [User]</p>
			<p class="source-code">}</p>
			<p class="source-code">usersSearch(page: Int, limit: Int, text: String!): UsersSearch</p>
			<p>The <strong class="source-inline">UsersSearch</strong> type expects one special parameter, which is the search text. Without the text parameter, the request would not make much sense. You should remember the <strong class="source-inline">page</strong> and <strong class="source-inline">limit</strong> parameters from the <strong class="source-inline">postsFeed</strong> pagination.</p>
			<p>Furthermore, the <strong class="source-inline">resolver</strong> function looks pretty much the same as the <strong class="source-inline">postsFeed</strong> resolver function. You can add the following code straight into the <strong class="source-inline">resolvers.js</strong> file in the <strong class="source-inline">RootQuery</strong> property, as follows:</p>
			<p class="source-code">usersSearch(root, { page, limit, text }, context) {</p>
			<p class="source-code">  if(text.length &lt; 3) {</p>
			<p class="source-code">    return {</p>
			<p class="source-code">      users: []</p>
			<p class="source-code">    };</p>
			<p class="source-code">  }</p>
			<p class="source-code">  var skip = 0;</p>
			<p class="source-code">  if(page &amp;&amp; limit) {</p>
			<p class="source-code">    skip = page * limit;</p>
			<p class="source-code">  }</p>
			<p class="source-code">  var query = {</p>
			<p class="source-code">    order: [['createdAt', 'DESC']],</p>
			<p class="source-code">    offset: skip,</p>
			<p class="source-code">  };</p>
			<p class="source-code">  if(limit) {</p>
			<p class="source-code">    query.limit = limit;</p>
			<p class="source-code">  }</p>
			<p class="source-code">  query.where = {</p>
			<p class="source-code">    username: {</p>
			<p class="source-code">      [Op.like]: '%' + text + '%'</p>
			<p class="source-code">    }</p>
			<p class="source-code">  };</p>
			<p class="source-code">  return {</p>
			<p class="source-code">    users: User.findAll(query)</p>
			<p class="source-code">  };</p>
			<p class="source-code">},</p>
			<p>You should note that the first condition asks whether the provided text is larger than three characters. We do this to avoid sending<a id="_idIndexMarker465"/> too many unnecessary queries to our database. Searching for every user where the username consists of just one or two characters would result in providing us with nearly every user. Of course, this could <a id="_idIndexMarker466"/>have been done on the frontend, too, but various clients could use our API, so we need to make sure that the backend makes this small improvement as well.</p>
			<p>We send the <strong class="source-inline">query</strong> object to our database through Sequelize. The code works pretty much like the <strong class="source-inline">postsFeed</strong> resolver function from before, except that we are using a Sequelize operator. We want to find every user where the username includes the entered text, without specifying whether it is at the start, middle, or end of the name. Consequently, we will use the <strong class="source-inline">Op.like</strong> operator, which Sequelize<a id="_idIndexMarker467"/> parses into a pure <strong class="bold">Structured Query Language</strong> (<strong class="bold">SQL</strong>) <strong class="source-inline">LIKE</strong> query, giving us the results we want. The <strong class="source-inline">%</strong> operator is used in MySQL to represent an unspecified number of characters. To enable this operator, we must import the <strong class="source-inline">sequelize</strong> package and extract the <strong class="source-inline">Op</strong> object from it, as follows:</p>
			<p class="source-code">import Sequelize from 'sequelize';</p>
			<p class="source-code">const Op = Sequelize.Op;</p>
			<p>Going further, we can implement the client-side code, as follows:</p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">searchQuery.js</strong> within the <strong class="source-inline">queries</strong> folder and insert the following code into it:<p class="source-code">import { gql } from '@apollo/client';</p><p class="source-code">import { USER_ATTRIBUTES } from '../fragments/userAttributes';</p><p class="source-code">import { useQuery } from '@apollo/client';</p><p class="source-code">export const GET_USERS = gql'</p><p class="source-code">  query usersSearch($page: Int, $limit: Int, $text:</p><p class="source-code">    String!) {</p><p class="source-code">    usersSearch(page: $page, limit: $limit, text:</p><p class="source-code">      $text) {</p><p class="source-code">      users {</p><p class="source-code">        id</p><p class="source-code">        ...userAttributes</p><p class="source-code">      }</p><p class="source-code">    }</p><p class="source-code">  }</p><p class="source-code">  ${USER_ATTRIBUTES}</p><p class="source-code">';</p><p class="source-code">export const getUserSearchConfig = (text) =&gt; ({ variables: { page: 0, limit: 5, text }, skip: text.length &lt; 3})</p><p class="source-code">export const useUserSearchQuery = (text) =&gt; useQuery(GET_USERS, getUserSearchConfig(text))</p><p>The only required parameter is the <strong class="source-inline">text</strong> parameter that we want to pass to our search. If the <strong class="source-inline">text</strong> parameter is shorter than three characters, we are passing a <strong class="source-inline">skip</strong> property<a id="_idIndexMarker468"/> either with <strong class="source-inline">true</strong> or <strong class="source-inline">false</strong> to not execute the GraphQL request.</p></li>
				<li>Continuing with our plan, we will create an application bar in a separate file. Create a new folder, called <strong class="source-inline">bar</strong>, below the <strong class="source-inline">components</strong> folder and the <strong class="source-inline">index.js</strong> file. Fill it in with the following code:<p class="source-code">import React from 'react';</p><p class="source-code">import SearchBar from './search';</p><p class="source-code">const Bar = () =&gt; {</p><p class="source-code">  return (</p><p class="source-code">    &lt;div className="topbar"&gt;</p><p class="source-code">      &lt;div className="inner"&gt;</p><p class="source-code">        &lt;SearchBar/&gt;</p><p class="source-code">      &lt;/div&gt;</p><p class="source-code">    &lt;/div&gt;</p><p class="source-code">  );</p><p class="source-code">}</p><p class="source-code">export default Bar</p><p>This file works as a wrapper for all of the components we want to render in the application bar; it does not implement<a id="_idIndexMarker469"/> any custom logic. We have already imported the <strong class="source-inline">SearchBar</strong> component that we must create.</p></li>
				<li>The <strong class="source-inline">SearchBar</strong> component lives inside of a separate file. Just create a <strong class="source-inline">search.js</strong> file in the <strong class="source-inline">bar</strong> folder, as follows:<p class="source-code">import React, { useState } from 'react';</p><p class="source-code">import { useUserSearchQuery } from '../../apollo/queries/searchQuery';</p><p class="source-code">import SearchList from './searchList';</p><p class="source-code">const SearchBar = () =&gt; {</p><p class="source-code">  const [text, setText] = useState('');</p><p class="source-code">  const { loading, error, data } =</p><p class="source-code">    useUserSearchQuery(text);</p><p class="source-code">  const changeText = (event) =&gt; {</p><p class="source-code">    setText(event.target.value);</p><p class="source-code">  }</p><p class="source-code">  return (</p><p class="source-code">    &lt;div className="search"&gt;</p><p class="source-code">      &lt;input type="text" onChange={changeText} </p><p class="source-code">        value={text}</p><p class="source-code">      /&gt;</p><p class="source-code">      {!loading &amp;&amp; !error &amp;&amp; data &amp;&amp; (</p><p class="source-code">        &lt;SearchList data={data}/&gt;</p><p class="source-code">      )}</p><p class="source-code">    &lt;/div&gt;</p><p class="source-code">  );</p><p class="source-code">}</p><p class="source-code">export default SearchBar</p><p>We are storing the current input value inside of a state variable, called <strong class="source-inline">text</strong>. Every time the text is changed, the <strong class="source-inline">useUserSearchQuery</strong> Hook is executed again with the new <strong class="source-inline">text</strong> parameter. Inside of the query Hook, the value is merged into the variables<a id="_idIndexMarker470"/> and sent with a GraphQL request. The result is then handed over to the <strong class="source-inline">SearchList</strong> component inside the <strong class="source-inline">data</strong> property if the request is not loading and did not have any error.</p></li>
				<li>Next, we will implement the <strong class="source-inline">SearchList</strong> component. This behaves like the posts feed, but only renders something if a response is given with at least one user. The list is displayed as a drop-down menu and is hidden whenever the browser window is clicked on. Create a file called <strong class="source-inline">searchList.js</strong> inside of the <strong class="source-inline">bar</strong> folder, with the following code:<p class="source-code">import React, { useState, useEffect } from 'react';</p><p class="source-code">const SearchList = ({ data: { usersSearch: { users }}}) =&gt; {</p><p class="source-code">  const [show, setShowList] = useState(false);</p><p class="source-code">  const handleShow = (show) =&gt; {</p><p class="source-code">    if(show) {</p><p class="source-code">      document.addEventListener('click',</p><p class="source-code">        handleShow.bind(null, !show), true);</p><p class="source-code">    } else {</p><p class="source-code">      document.removeEventListener('click',</p><p class="source-code">        handleShow.bind(null, !show), true);</p><p class="source-code">    }</p><p class="source-code">    setShowList(show);</p><p class="source-code">  }</p><p class="source-code">  const showList = (users) =&gt; {</p><p class="source-code">    if(users.length) {</p><p class="source-code">      handleShow(true);</p><p class="source-code">    } else {</p><p class="source-code">      handleShow(false);</p><p class="source-code">    }</p><p class="source-code">  }</p><p class="source-code">  useEffect(() =&gt; {</p><p class="source-code">    showList(users);</p><p class="source-code">  }, [users]);</p><p class="source-code">  useEffect(() =&gt; {</p><p class="source-code">    return () =&gt; {</p><p class="source-code">      document.removeEventListener('click',</p><p class="source-code">        handleShow.bind(null, !show), true);</p><p class="source-code">    }</p><p class="source-code">  });</p><p class="source-code">  return (</p><p class="source-code">    show &amp;&amp;</p><p class="source-code">      &lt;div className="result"&gt;</p><p class="source-code">        {users.map((user, i) =&gt;</p><p class="source-code">          &lt;div key={user.id} className="user"&gt;</p><p class="source-code">            &lt;img src={user.avatar} /&gt;</p><p class="source-code">            &lt;span&gt;{user.username}&lt;/span&gt;</p><p class="source-code">          &lt;/div&gt;</p><p class="source-code">        )}</p><p class="source-code">      &lt;/div&gt;</p><p class="source-code">  )</p><p class="source-code">}</p><p class="source-code">export default SearchList</p></li>
			</ol>
			<p>We are using the <strong class="source-inline">useEffect</strong> Hook here with the dependency on <strong class="source-inline">users</strong>, which is executed whenever the parent component sets new properties on the current one. In this case, we check whether the properties include at least one user, and then set the state accordingly, in order to make the drop-down menu visible. The drop-down menu is hidden when clicked<a id="_idIndexMarker471"/> on or when an empty result is given. The approach is very similar to the drop-down for the post.</p>
			<p>There are just two things to do now, as follows:</p>
			<ol>
				<li value="1">You should copy the CSS from the official GitHub repository of this chapter in order to get the correct styling, or you can do it on your own.</li>
				<li>You need to import the bar wrapper component inside of the <strong class="source-inline">App</strong> class and render it between React Helmet and the news feed.</li>
			</ol>
			<p>The first feature of our application bar is now complete.</p>
			<p>Let's continue and take a look at React's Context API, the Apollo Consumer feature, and how to store data globally in our React frontend.</p>
			<h2 id="_idParaDest-113"><a id="_idTextAnchor136"/>The React Context API versus Apollo Consumer</h2>
			<p>There are two ways to<a id="_idIndexMarker472"/> handle global variables in the stack that<a id="_idIndexMarker473"/> we are using at the moment. These are through<a id="_idIndexMarker474"/> the new React Context API and the<a id="_idIndexMarker475"/> Apollo Consumer functionality.</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">There are further ways to handle global state management. One of the most famous libraries is Redux, but there are many<a id="_idIndexMarker476"/> more. As an explanation of Redux would outreach the topic of this book, we are only focusing on the tools provided by React and Apollo.</p>
			<p class="callout">If you want to check <a id="_idIndexMarker477"/>other ways, have a look at Redux's website: <a href="https://redux.js.org/">https://redux.js.org/</a>.</p>
			<p>From version 16.3 of React, there is a Context API that allows you to define global providers offering data through deeply nested components. These components do not require your application to hand over the data through many components, from the top to the bottom of the React tree. Instead, it uses so-called consumers and providers. These are useful when you set up the <strong class="source-inline">user</strong> object at a global point of your application, and you can access it from anywhere. In earlier versions of React, you needed to pass the property down from component to component to get it to the correct component at the bottom of the React component tree. This passing of properties through multiple layers<a id="_idIndexMarker478"/> of components is also called "prop drilling."</p>
			<p>An alternative approach to the React Context API is the Apollo Consumer<a id="_idIndexMarker479"/> feature, which is a specific implementation for Apollo. The React Context API is a general way<a id="_idIndexMarker480"/> of doing things, for Apollo or anything else that you can imagine.</p>
			<p>The great thing about the Apollo Consumer component is that it enables you to access the Apollo cache and use it as data storage. Using the Apollo Consumer component saves you from handling all the data, and you are also not required to implement the provider itself; you can consume the data wherever you want.</p>
			<p>Both approaches will result in the following output:</p>
			<div>
				<div id="_idContainer043" class="IMG---Figure">
					<img src="image/Figure_5.04_B17337.jpg" alt="Figure 5.4 – User profile in the top bar&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.4 – User profile in the top bar</p>
			<p>The best option is to show you the two alternatives right away so that you can identify your preferred method.</p>
			<h3>The React Context API</h3>
			<p>We will start with the React method for storing <a id="_idIndexMarker481"/>and accessing global data in your frontend.</p>
			<p>Here is a short explanation of this method:</p>
			<ul>
				<li><strong class="bold">Context</strong>: This is a React approach<a id="_idIndexMarker482"/> for sharing data between components, without having to pass it through the complete tree.</li>
				<li><strong class="bold">Provider</strong>: This is a global component, mostly used at just one point in your code. It enables<a id="_idIndexMarker483"/> you to access the specific context data.</li>
				<li><strong class="bold">Consumer</strong>: This is a component<a id="_idIndexMarker484"/> that can be used at many different points in your application, reading the data behind the context that you are referring to.</li>
			</ul>
			<p>To get started, create a folder called <strong class="source-inline">context</strong> below the <strong class="source-inline">components</strong> folder. In that folder, create a <strong class="source-inline">user.js</strong> file, where we can set up the Context API.</p>
			<p>We will go over every step, one by one, as follows:</p>
			<ol>
				<li value="1">As always, we need<a id="_idIndexMarker485"/> to import all of the dependencies. Furthermore, we will set up a new empty context. The <strong class="source-inline">createContext</strong> function will return one provider and consumer to use throughout the application, as follows:<p class="source-code">import React, { createContext } from 'react';</p><p class="source-code">const { Provider, Consumer } = createContext();</p></li>
				<li>Now, we want to use the provider. The best option here is to create a special <strong class="source-inline">UserProvider</strong> component. Later, when we have authentication, we can adjust it to do the GraphQL query, and then share the resultant data in our frontend. For now, we will stick with fake data. Insert the following code:<p class="source-code">export const UserProvider = ({ children }) =&gt; {</p><p class="source-code">  const user = {</p><p class="source-code">    username: "Test User",</p><p class="source-code">    avatar: "/uploads/avatar1.png"</p><p class="source-code">  };</p><p class="source-code">  return (</p><p class="source-code">    &lt;Provider value={user}&gt;</p><p class="source-code">      {children}</p><p class="source-code">    &lt;/Provider&gt;</p><p class="source-code">  );</p><p class="source-code">}</p></li>
				<li>In the preceding code snippet, we render the <strong class="source-inline">Provider</strong> component from Apollo and wrap all the children in it. There is a <strong class="source-inline">Consumer</strong> component that reads from the <strong class="source-inline">Provider</strong>. We will set up a special <strong class="source-inline">UserConsumer</strong> component that takes care of passing the data to the underlying components by cloning them with React's <strong class="source-inline">cloneElement</strong> function, as follows:<p class="source-code">export const UserConsumer = ({ children }) =&gt; {</p><p class="source-code">  return (</p><p class="source-code">    &lt;Consumer&gt;</p><p class="source-code">      {user =&gt; React.Children.map(children,</p><p class="source-code">        function(child){</p><p class="source-code">        return React.cloneElement(child, { user });</p><p class="source-code">      })}</p><p class="source-code">    &lt;/Consumer&gt;</p><p class="source-code">  )</p><p class="source-code">}</p></li>
			</ol>
			<p>We will export both<a id="_idIndexMarker486"/> classes directly under their names.</p>
			<p>We need to introduce the provider at an early point in our code base. The best approach is to import the <strong class="source-inline">UserProvider</strong> component into the <strong class="source-inline">App.js</strong> file, as follows:</p>
			<p class="source-code">import { UserProvider } from './components/context/user';</p>
			<p>Use the provider as follows, and wrap it around all essential components:</p>
			<p class="source-code">&lt;UserProvider&gt;</p>
			<p class="source-code">  &lt;Bar /&gt;</p>
			<p class="source-code">  &lt;Feed /&gt;</p>
			<p class="source-code">  &lt;Chats /&gt;</p>
			<p class="source-code">&lt;/UserProvider&gt;</p>
			<p>Everywhere in the <strong class="source-inline">Bar</strong>, <strong class="source-inline">Feed</strong>, and <strong class="source-inline">Chats</strong> components, we can now read from the provider.</p>
			<p>As stated previously, we want to show the logged-in user, with their name, inside the application.</p>
			<p>The component<a id="_idIndexMarker487"/> using the data is the <strong class="source-inline">UserBar</strong> component. We need to create a <strong class="source-inline">user.js</strong> file inside of the <strong class="source-inline">bar</strong> folder. Insert the following code:</p>
			<p class="source-code">import React from 'react';</p>
			<p class="source-code">const UserBar = ({ user }) =&gt; {</p>
			<p class="source-code">  if(!user) return null;</p>
			<p class="source-code">  return (</p>
			<p class="source-code">    &lt;div className="user"&gt;</p>
			<p class="source-code">      &lt;img src={user.avatar} /&gt;</p>
			<p class="source-code">      &lt;span&gt;{user.username}&lt;/span&gt;</p>
			<p class="source-code">    &lt;/div&gt;</p>
			<p class="source-code">  );</p>
			<p class="source-code">}</p>
			<p class="source-code">export default UserBar</p>
			<p>For the moment, we render a simple user container inside of the application bar, from the data of the <strong class="source-inline">user</strong> object.</p>
			<p>To get the user data into the <strong class="source-inline">UserBar</strong> component, we need to use the <strong class="source-inline">UserConsumer</strong> component, of course.</p>
			<p>Open the <strong class="source-inline">index.js</strong> file for the top bar and add the following code to the <strong class="source-inline">return</strong> statement, beneath the <strong class="source-inline">SearchBar</strong> component:</p>
			<p class="source-code">&lt;UserConsumer&gt;</p>
			<p class="source-code">  &lt;UserBar /&gt;</p>
			<p class="source-code">&lt;/UserConsumer&gt;</p>
			<p>Obviously, you need to import both of the components at the top of the file, as follows:</p>
			<p class="source-code">import UserBar from './user';</p>
			<p class="source-code">import { UserConsumer } from '../context/user';</p>
			<p>You have now successfully configured and used the React Context API to save and read data globally.</p>
			<p>The solution that we have<a id="_idIndexMarker488"/> is a general approach that will work for all scenarios that you can think of, including Apollo. If you view the browser now, you will be able to see the logged-in user or at least the fake data we added in the top bar.</p>
			<p>Nevertheless, we should cover the solution offered by Apollo itself.</p>
			<h3>Apollo Consumer</h3>
			<p>Nearly all of the code<a id="_idIndexMarker489"/> that we have written can stay as it was in the previous section. We just need to remove the <strong class="source-inline">UserProvider</strong> component from the <strong class="source-inline">App</strong> class because it is not needed anymore for the Apollo Consumer component.</p>
			<p>Open up the <strong class="source-inline">user.js</strong> file in the <strong class="source-inline">context</strong> folder and replace the contents with the following code:</p>
			<p class="source-code">import React from 'react';</p>
			<p class="source-code">import { ApolloConsumer } from '@apollo/client';</p>
			<p class="source-code">export const UserConsumer = ({ children }) =&gt; {</p>
			<p class="source-code">  return (</p>
			<p class="source-code">    &lt;ApolloConsumer&gt;</p>
			<p class="source-code">      {client =&gt; {</p>
			<p class="source-code">        // Use client.readQuery to get the current logged </p>
			<p class="source-code">        // in user.</p>
			<p class="source-code">        const user = {</p>
			<p class="source-code">          username: "Test User",</p>
			<p class="source-code">          avatar: "/uploads/avatar1.png"</p>
			<p class="source-code">        };</p>
			<p class="source-code">        return React.Children.map(children,</p>
			<p class="source-code">          function(child){</p>
			<p class="source-code">          return React.cloneElement(child, { user });</p>
			<p class="source-code">        });</p>
			<p class="source-code">      }}</p>
			<p class="source-code">    &lt;/ApolloConsumer&gt;</p>
			<p class="source-code">  )</p>
			<p class="source-code">}</p>
			<p>As you can see, we import the <strong class="source-inline">ApolloConsumer</strong> component from the <strong class="source-inline">@apollo-client</strong> package. This package enables us to get access to the Apollo Client that we set up in <a href="B17337_04_Final_ASB_ePub.xhtml#_idTextAnchor085"><em class="italic">Chapter 4</em></a>, <em class="italic">Hooking Apollo into React</em>.</p>
			<p>The problem we have here<a id="_idIndexMarker490"/> is that we do not have a <strong class="source-inline">CurrentUser</strong> query that would respond with the logged-in user from the GraphQL, so we are not able to run the <strong class="source-inline">readQuery</strong> function. You would typically run the query against the internal cache of Apollo and be able to get the <strong class="source-inline">user</strong> object easily. Once we have implemented authentication, we will fix this problem.</p>
			<p>For now, we will return the same fake object as we did with the React Context API. The Apollo Client replaces the <strong class="source-inline">Provider</strong> component that we used with the React Context API.</p>
			<p>I hope that you can understand the difference between these two solutions. In the next chapter, you will see the <strong class="source-inline">ApolloConsumer</strong> component in full action, when the user query is established<a id="_idIndexMarker491"/> and can be read through the client of its cache.</p>
			<h1 id="_idParaDest-114"><a id="_idTextAnchor137"/>Documenting React applications</h1>
			<p>We have put a lot of work and code into our React application. To be honest, we can improve upon our code<a id="_idIndexMarker492"/> base by documenting it. We did not comment on our code, we did not add React component property-type definitions, and we have no automated documentation tool. Of course, we did not write any comments because you learned all of the techniques and libraries from the book, so no comments were needed. However, be sure to always comment your code outside of this book.</p>
			<p>In the JavaScript ecosystem, many different approaches and tools exist to document your<a id="_idIndexMarker493"/> application. For this book, we will use a tool called <strong class="bold">React Styleguidist</strong>. It was made especially for React. You cannot document other frameworks or code with it.</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">Generally speaking, this is an area that you can put months of work into without coming to a real end. If you are searching for a general approach for any framework or backend and frontend, I can recommend JSDoc, but there are many more.</p>
			<p class="callout">Beyond<a id="_idIndexMarker494"/> that, there are many different React documentation tools. If you want to check other tools, have a look here: <a href="https://blog.bitsrc.io/6-tools-for-documenting-your-react-components-like-a-pro-5027cdfb40c6">https://blog.bitsrc.io/6-tools-for-documenting-your-react-components-like-a-pro-5027cdfb40c6</a>.</p>
			<p>Let's get started with the configuration for React Styleguidist.</p>
			<h2 id="_idParaDest-115"><a id="_idTextAnchor138"/>Setting up React Styleguidist</h2>
			<p>React Styleguidist and<a id="_idIndexMarker495"/> our application rely on <strong class="source-inline">webpack</strong>. Just follow these instructions to get a working copy of it:</p>
			<ol>
				<li value="1">Install React Styleguidist using <strong class="source-inline">npm</strong>, as follows:<p class="source-code"><strong class="bold">npm install --save-dev react-styleguidist</strong></p></li>
				<li>Usually, the folder structure is expected to be <strong class="source-inline">src/components</strong>, but we have a <strong class="source-inline">client</strong> folder between the <strong class="source-inline">src</strong> and <strong class="source-inline">components</strong> folders, so we must configure React Styleguidist to let it understand our folder structure. Create a <strong class="source-inline">styleguide.config.js</strong> file in the root<a id="_idIndexMarker496"/> folder of the project to configure it, as follows:</li>
			</ol>
			<p class="source-code">const path = require('path')</p>
			<p class="source-code">module.exports = {</p>
			<p class="source-code">  components: 'src/client/components/**/*.js',</p>
			<p class="source-code">  require: [</p>
			<p class="source-code">    path.join(__dirname, 'assets/css/style.css')</p>
			<p class="source-code">  ],</p>
			<p class="source-code">  webpackConfig: require('./webpack.client.config')</p>
			<p class="source-code">}</p>
			<p>We export an object containing all the information needed for React Styleguidist. In addition to specifying the <strong class="source-inline">components</strong> path, we also require our main CSS style file. You will see why this can be useful later in this chapter. We must define the <strong class="source-inline">webpackConfig</strong> option because our <strong class="source-inline">config</strong> file has a custom name that is not found automatically.</p>
			<p>Styleguidist provides two ways to view the documentation. One is to build the documentation statically, in production mode, with this command:</p>
			<p class="source-code">npx styleguidist build</p>
			<p>This command creates a <strong class="source-inline">styleguide</strong> folder, and inside the folder there are HTML files for our documentation. It is an excellent method when releasing new versions of your application so that you can save and back up those files with each version.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">If you see an error while running <strong class="source-inline">npx styleguidist</strong>, you have to apply a short-term workaround.</p>
			<p class="callout">Install yarn by running <strong class="source-inline">npm install -g yarn</strong> and then add the following lines to the root level of your <strong class="source-inline">package.json</strong> object:</p>
			<p class="callout"><strong class="bold">  "resolutions": {</strong></p>
			<p class="callout"><strong class="bold">    "react-dev-utils": "12.0.0-next.47"</strong></p>
			<p class="callout"><strong class="bold">  }</strong></p>
			<p class="callout">You can then run <strong class="source-inline">yarn install</strong>. This will update an internal dependency of <strong class="source-inline">styleguidist</strong> to a newer version that does not have the problem.</p>
			<p class="callout">You can then run <strong class="source-inline">npx styleguidist build</strong> again. Just remember that in case you run <strong class="source-inline">npm install</strong>, it will overwrite this dependency with the old one and you will have to run <strong class="source-inline">yarn install</strong> again to get it working.</p>
			<p>The second method, for development cases, lets Styleguidist run and create documentation on the fly using <strong class="source-inline">webpack</strong>. Here's the command you need for this:</p>
			<p class="source-code">npx styleguidist server</p>
			<p>You can view the results under <strong class="source-inline">http://localhost:6060</strong>. The documentation should look like this:</p>
			<div>
				<div id="_idContainer044" class="IMG---Figure">
					<img src="image/Figure_5.05_B17337.jpg" alt="Figure 5.5 – React Styleguidist documentation&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.5 – React Styleguidist documentation</p>
			<p>In the left-hand panel, all of the components<a id="_idIndexMarker497"/> are listed in the order of our folder structure. You will always have an excellent overview of the existing components this way.</p>
			<p>In the main panel, each component is explained in detail. You may have noticed that the components are missing further information. We will change that next.</p>
			<h2 id="_idParaDest-116"><a id="_idTextAnchor139"/>React PropTypes</h2>
			<p>An essential feature of React<a id="_idIndexMarker498"/> is passing the properties to the child components. These can be anything from basic strings to numbers, but also complete components. We have already seen all of the scenarios in our application.</p>
			<p>Developers that are new to your code base need to read through all of the components and identify which properties they can accept.</p>
			<p>React offers a way to describe properties from within each component. Documenting the properties of your components makes it easier for other developers to understand your React components.</p>
			<p>We will take a look at how to do this with an example in our <strong class="source-inline">Post</strong> component.</p>
			<p>There are two React features that we haven't covered yet, as follows:</p>
			<ul>
				<li>If your components have optional parameters, it can make sense to have default properties in the first place. To do this, you can specify <strong class="source-inline">defaultProps</strong> as a static property, in the same way as with the state initializers.</li>
				<li>The important part is the <strong class="source-inline">propTypes</strong> field, which you can fill in for all of your components with the custom properties that they accept.</li>
			</ul>
			<p>A new package is required to define the property types, as follows:</p>
			<p class="source-code">npm install --save prop-types</p>
			<p>This package includes<a id="_idIndexMarker499"/> everything that we need to set up our property definitions.</p>
			<p>Now, open your <strong class="source-inline">Post</strong> component's <strong class="source-inline">index.js</strong> file. We need to import the new package at the top of this file, as follows: </p>
			<p class="source-code">import PropTypes from 'prop-types';</p>
			<p>Next, we will add the new field to our component, before the <strong class="source-inline">export</strong> statement, like this:</p>
			<p class="source-code">Post.propTypes = {</p>
			<p class="source-code">  /** Object containing the complete post. */</p>
			<p class="source-code">  post: PropTypes.object.isRequired,</p>
			<p class="source-code">}</p>
			<p>The preceding code should help everyone to understand your component a bit better. Every developer should know that a <strong class="source-inline">post</strong> object is required for this component to work.</p>
			<p>The <strong class="source-inline">PropTypes</strong> package offers various types that we can use. You can access each type with <strong class="source-inline">PropTypes.X</strong>. If it is a required property, you can append <strong class="source-inline">isRequired</strong> in the same way as in the preceding code.</p>
			<p>Not only does React now throw an error inside of our console when the property does not exist, but React Styleguidist is also able to show which properties are needed, as you can see in the following screenshot:</p>
			<div>
				<div id="_idContainer045" class="IMG---Figure">
					<img src="image/Figure_5.06_B17337.jpg" alt="Figure 5.6 – Basic property documentation&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.6 – Basic property documentation</p>
			<p>However, what is a <strong class="source-inline">post</strong> object? What kind of fields does it include?</p>
			<p>The best way to document a <strong class="source-inline">post</strong> object is to define which properties a post should include, at least for this specific component. Replace<a id="_idIndexMarker500"/> the property definition, as follows:</p>
			<p class="source-code">Post.propTypes = {</p>
			<p class="source-code">  /** Object containing the complete post. */</p>
			<p class="source-code">  post: PropTypes.shape({</p>
			<p class="source-code">    id: PropTypes.number.isRequired,</p>
			<p class="source-code">    text: PropTypes.string.isRequired,</p>
			<p class="source-code">    user: PropTypes.shape({</p>
			<p class="source-code">      avatar: PropTypes.string.isRequired,</p>
			<p class="source-code">      username: PropTypes.string.isRequired,</p>
			<p class="source-code">    }).isRequired</p>
			<p class="source-code">  }).isRequired,</p>
			<p class="source-code">}</p>
			<p>Here, we use the <strong class="source-inline">shape</strong> function. This allows you to hand over a list of fields that the object contains. Each of those is given a type from the <strong class="source-inline">PropTypes</strong> package.</p>
			<p>The output from React Styleguidist now looks like this:</p>
			<div>
				<div id="_idContainer046" class="IMG---Figure">
					<img src="image/Figure_5.07_B17337.jpg" alt="Figure 5.7 – Detailed property documentation&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.7 – Detailed property documentation</p>
			<p>All the fields that we specified are listed separately. At the time of writing this book, React Styleguidist does not offer a recursive view of all properties. As you can see, the <strong class="source-inline">user</strong> object inside of the <strong class="source-inline">post</strong> object is not listed with its properties, but it is only listed as a second shape. If you need this feature, you can, of course, implement it yourself and send a <strong class="source-inline">pull</strong> request<a id="_idIndexMarker501"/> on the official GitHub repository, or switch to another tool.</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">React offers way more property types and functions that you can use to document all of the components and their properties. To learn a bit more about<a id="_idIndexMarker502"/> this, visit the official documentation at <a href="https://reactjs.org/docs/typechecking-with-proptypes.html">https://reactjs.org/docs/typechecking-with-proptypes.html</a>.</p>
			<p>One last great feature of React Styleguidist is that you can enter examples for every component. You can also use markdown to add some more descriptions.</p>
			<p>For our <strong class="source-inline">Post</strong> component, we need to create an <strong class="source-inline">index.md</strong> file, next to the <strong class="source-inline">index.js</strong> file in the <strong class="source-inline">post</strong> folder. React Styleguidist proposes creating either a <strong class="source-inline">Readme.md</strong> or a <strong class="source-inline">Post.md</strong> file, but those did not work for me. The <strong class="source-inline">index.md</strong> file should look like this:</p>
			<p class="source-code">Post example:</p>
			<p class="source-code">'''js</p>
			<p class="source-code">  const post = {</p>
			<p class="source-code">    id: 3,</p>
			<p class="source-code">    text: "This is a test post!",</p>
			<p class="source-code">    user: {</p>
			<p class="source-code">      avatar: "/uploads/avatar1.png",</p>
			<p class="source-code">      username: "Test User"</p>
			<p class="source-code">    }</p>
			<p class="source-code">  };</p>
			<p class="source-code">  &lt;Post key={post.id} post={post} /&gt;</p>
			<p class="source-code">'''</p>
			<p>Sadly, you will not be able<a id="_idIndexMarker503"/> to see the output of that markup directly. The reason is that the <strong class="source-inline">Post</strong> component relies on Apollo. If you just render the plain <strong class="source-inline">Post</strong> component in the way React Styleguidist does, the Apollo Client will not be there.</p>
			<p>To fix this issue, we can overwrite the default way React Styleguidist renders any component. Follow these instructions to get it working:</p>
			<ol>
				<li value="1">Create a new folder where we can save all special React Styleguidist components, as follows:<p class="source-code"><strong class="bold">mkdir src/client/styleguide/</strong></p></li>
				<li>Create a file called <strong class="source-inline">Wrapper.js</strong> with the following content:<p class="source-code">import React from 'react';</p><p class="source-code">import client from '../apollo';</p><p class="source-code">import { ApolloProvider } from '@apollo/client/react';</p><p class="source-code">const Wrapper = ({ children }) =&gt; {</p><p class="source-code">  return (</p><p class="source-code">    &lt;ApolloProvider client={client}&gt;</p><p class="source-code">      {children}</p><p class="source-code">    &lt;/ApolloProvider&gt;</p><p class="source-code">  );</p><p class="source-code">}</p><p class="source-code">export default Wrapper</p><p>This will be the standard <strong class="source-inline">Wrapper</strong> component for all components that React Styleguidist runs. This way, we ensure<a id="_idIndexMarker504"/> that we always have the Apollo Client in the context.</p></li>
				<li>The last thing we need to do is to add the following property to the <strong class="source-inline">styleguide.config.js</strong> file:<p class="source-code">styleguideComponents: {</p><p class="source-code">     Wrapper: path.join(__dirname,</p><p class="source-code">       'src/client/styleguide/Wrapper')</p><p class="source-code">},</p><p>React Styleguidist will now use this <strong class="source-inline">Wrapper</strong> component.</p></li>
			</ol>
			<p>If you restart React Styleguidist, it will render the documentation and generate the following output:</p>
			<div>
				<div id="_idContainer047" class="IMG---Figure">
					<img src="image/Figure_5.08_B17337.jpg" alt="Figure 5.8 – React Styleguidist example&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.8 – React Styleguidist example</p>
			<p>Now, you can see why it was useful to use the CSS style. Not only can React Styleguidist document the code, but it can also execute it within the documentation. As in the preceding code, providing the correct properties inside of the <strong class="source-inline">post</strong> object enables us to see how the component should look, including the correct styling.</p>
			<p>This example shows<a id="_idIndexMarker505"/> how reusable our <strong class="source-inline">Post</strong> component is since it is usable without having to run the Apollo query. </p>
			<p>The basics should be clear by now. Continue to read up on this topic because there are more things to learn.</p>
			<h1 id="_idParaDest-117"><a id="_idTextAnchor140"/>Summary</h1>
			<p>Through this chapter, you have gained a lot of experience in writing a React application. You have applied multiple React patterns to different use cases, such as children passing through a pattern and conditional rendering. Furthermore, you now know how to document your code correctly.</p>
			<p>You also learned how to use the React Context API, in comparison with the Apollo Consumer feature, to retrieve the currently logged-in user in our application.</p>
			<p>In the next chapter, you will learn how to implement authentication in your backend and use it in the frontend.</p>
		</div>
	</body></html>