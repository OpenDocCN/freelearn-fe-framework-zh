<html><head></head><body>
<div id="_idContainer130" class="calibre2">
<h1 class="chapter-number" id="_idParaDest-259"><a id="_idTextAnchor262" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1.1">14</span></h1>
<h1 id="_idParaDest-260" class="calibre5"><a id="_idTextAnchor263" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.2.1">Creating a Frontend to Consume and Send Events</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.3.1">After successfully creating a Socket.IO backend in the previous chapter, and doing our first experiments with the Socket.IO client, let’s now focus on implementing a frontend to connect to the backend and consume and </span><span><span class="kobospan" id="kobo.4.1">send events.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.5.1">We are first going to clean up our project by removing files from the previously created blog app. </span><span class="kobospan" id="kobo.5.2">Then, we are going to implement a React Context to initialize and store our Socket.IO instance, making use of the existing </span><strong class="source-inline"><span class="kobospan" id="kobo.6.1">AuthProvider</span></strong><span class="kobospan" id="kobo.7.1"> to provide the token for authenticating with the backend. </span><span class="kobospan" id="kobo.7.2">After that, we are going to implement an interface for our chat app and a way to send chat messages, as well as displaying received chat messages. </span><span class="kobospan" id="kobo.7.3">Finally, we are going to implement chat commands with acknowledgments to show which rooms we are </span><span><span class="kobospan" id="kobo.8.1">currently in.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.9.1">In this chapter, we are going to cover the following </span><span><span class="kobospan" id="kobo.10.1">main topics:</span></span></p>
<ul class="calibre10">
<li class="calibre11"><span class="kobospan" id="kobo.11.1">Integrating the Socket.IO client </span><span><span class="kobospan" id="kobo.12.1">with React</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.13.1">Implementing </span><span><span class="kobospan" id="kobo.14.1">chat functionality</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.15.1">Implementing chat commands </span><span><span class="kobospan" id="kobo.16.1">with acknowledgments</span></span></li>
</ul>
<h1 id="_idParaDest-261" class="calibre5"><a id="_idTextAnchor264" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.17.1">Technical requirements</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.18.1">Before we start, please install all the requirements from </span><a href="B19385_01.xhtml#_idTextAnchor016" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.19.1">Chapter 1</span></em></span></a><span class="kobospan" id="kobo.20.1">, </span><em class="italic"><span class="kobospan" id="kobo.21.1">Preparing for Full-Stack Development</span></em><span class="kobospan" id="kobo.22.1">, and </span><a href="B19385_02.xhtml#_idTextAnchor028" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.23.1">Chapter 2</span></em></span></a><span class="kobospan" id="kobo.24.1">, </span><em class="italic"><span class="kobospan" id="kobo.25.1">Getting to Know Node.js </span></em><span><em class="italic"><span class="kobospan" id="kobo.26.1">and MongoDB</span></em></span><span><span class="kobospan" id="kobo.27.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.28.1">The versions listed in those chapters are the ones used in the book. </span><span class="kobospan" id="kobo.28.2">While installing a newer version should not be an issue, please note that certain steps might work differently on a newer version. </span><span class="kobospan" id="kobo.28.3">If you have an issue with the code and steps provided in this book, please try using the versions listed in </span><em class="italic"><span class="kobospan" id="kobo.29.1">Chapters 1 </span></em><span><span class="kobospan" id="kobo.30.1">and</span></span><span><em class="italic"><span class="kobospan" id="kobo.31.1"> 2.</span></em></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.32.1">You can find the code for this chapter on </span><span><span class="kobospan" id="kobo.33.1">GitHub: </span></span><a href="https://github.com/PacktPublishing/Modern-Full-Stack-React-Projects/tree/main/ch14" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.34.1">https://github.com/PacktPublishing/Modern-Full-Stack-React-Projects/tree/main/ch14</span></span></a><span><span class="kobospan" id="kobo.35.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.36.1">If you cloned the full repository for the book, Husky may not find the </span><strong class="source-inline"><span class="kobospan" id="kobo.37.1">.git</span></strong><span class="kobospan" id="kobo.38.1"> directory when running </span><strong class="source-inline"><span class="kobospan" id="kobo.39.1">npm install</span></strong><span class="kobospan" id="kobo.40.1">. </span><span class="kobospan" id="kobo.40.2">In that case, just run </span><strong class="source-inline"><span class="kobospan" id="kobo.41.1">git init</span></strong><span class="kobospan" id="kobo.42.1"> in the root of the corresponding </span><span><span class="kobospan" id="kobo.43.1">chapter folder.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.44.1">The CiA video for this chapter can be found </span><span><span class="kobospan" id="kobo.45.1">at: </span></span><a href="https://youtu.be/d_TZK6S_XDU" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.46.1">https://youtu.be/d_TZK6S_XDU</span></span></a><span><span class="kobospan" id="kobo.47.1">.</span></span></p>
<h1 id="_idParaDest-262" class="calibre5"><a id="_idTextAnchor265" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.48.1">Integrating the Socket.IO client with React</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.49.1">Let’s start by cleaning </span><a id="_idIndexMarker801" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.50.1">up the project and deleting all old files </span><a id="_idIndexMarker802" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.51.1">copied over from the blog app. </span><span class="kobospan" id="kobo.51.2">Then, we are going to set up a Socket.IO context to make it easier to initialize and use Socket.IO in React components. </span><span class="kobospan" id="kobo.51.3">Finally, we are going to create our first component that utilizes this context to show the status of our </span><span><span class="kobospan" id="kobo.52.1">Socket.IO connection.</span></span></p>
<h2 id="_idParaDest-263" class="calibre7"><a id="_idTextAnchor266" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.53.1">Cleaning up the project</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.54.1">Let’s first delete the folders </span><a id="_idIndexMarker803" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.55.1">and files from the blog application we </span><span><span class="kobospan" id="kobo.56.1">created earlier:</span></span></p>
<ol class="calibre15">
<li class="calibre11"><span class="kobospan" id="kobo.57.1">Copy the existing </span><strong class="source-inline1"><span class="kobospan" id="kobo.58.1">ch13</span></strong><span class="kobospan" id="kobo.59.1"> folder to a new </span><strong class="source-inline1"><span class="kobospan" id="kobo.60.1">ch14</span></strong><span class="kobospan" id="kobo.61.1"> folder, </span><span><span class="kobospan" id="kobo.62.1">as follows:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.63.1">$ cp -R ch13 ch14</span></strong></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.64.1">Open the </span><strong class="source-inline1"><span class="kobospan" id="kobo.65.1">ch14</span></strong><span class="kobospan" id="kobo.66.1"> folder in </span><span><span class="kobospan" id="kobo.67.1">VS Code.</span></span></li>
<li class="calibre11"><em class="italic"><span class="kobospan" id="kobo.68.1">Delete</span></em><span class="kobospan" id="kobo.69.1"> the following folders and files, as they were only required for the blog </span><span><span class="kobospan" id="kobo.70.1">application backend:</span></span><ul class="calibre16"><li class="calibre11"><span><strong class="source-inline1"><span class="kobospan" id="kobo.71.1">backend/src/__tests__/</span></strong></span></li><li class="calibre11"><span><strong class="source-inline1"><span class="kobospan" id="kobo.72.1">backend/src/example.js</span></strong></span></li><li class="calibre11"><span><strong class="source-inline1"><span class="kobospan" id="kobo.73.1">backend/src/db/models/post.js</span></strong></span></li><li class="calibre11"><span><strong class="source-inline1"><span class="kobospan" id="kobo.74.1">backend/src/routes/posts.js</span></strong></span></li><li class="calibre11"><span><strong class="source-inline1"><span class="kobospan" id="kobo.75.1">backend/src/services/posts.js</span></strong></span></li></ul></li>
<li class="calibre11"><span class="kobospan" id="kobo.76.1">In </span><strong class="source-inline1"><span class="kobospan" id="kobo.77.1">backend/src/app.js</span></strong><span class="kobospan" id="kobo.78.1">, </span><em class="italic"><span class="kobospan" id="kobo.79.1">remove</span></em><span class="kobospan" id="kobo.80.1"> the </span><span><span class="kobospan" id="kobo.81.1">following import:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.82.1">
import postRoutes from './routes/posts.js'</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.83.1">Also, </span><span><em class="italic"><span class="kobospan" id="kobo.84.1">remove</span></em></span><span> </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.85.1">postRoutes</span></strong></span><span><span class="kobospan" id="kobo.86.1">:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.87.1">
postRoutes(app)</span></pre></li> <li class="calibre11"><em class="italic"><span class="kobospan" id="kobo.88.1">Delete</span></em><span class="kobospan" id="kobo.89.1"> the </span><a id="_idIndexMarker804" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.90.1">following folders and files, as they were only required for the blog </span><span><span class="kobospan" id="kobo.91.1">application frontend:</span></span><ul class="calibre16"><li class="calibre11"><span><strong class="source-inline1"><span class="kobospan" id="kobo.92.1">src/api/posts.js</span></strong></span></li><li class="calibre11"><span><strong class="source-inline1"><span class="kobospan" id="kobo.93.1">src/components/CreatePost.jsx</span></strong></span></li><li class="calibre11"><span><strong class="source-inline1"><span class="kobospan" id="kobo.94.1">src/components/Post.jsx</span></strong></span></li><li class="calibre11"><span><strong class="source-inline1"><span class="kobospan" id="kobo.95.1">src/components/PostFilter.jsx</span></strong></span></li><li class="calibre11"><span><strong class="source-inline1"><span class="kobospan" id="kobo.96.1">src/components/PostList.jsx</span></strong></span></li><li class="calibre11"><span><strong class="source-inline1"><span class="kobospan" id="kobo.97.1">src/components/PostSorting.jsx</span></strong></span></li><li class="calibre11"><span><strong class="source-inline1"><span class="kobospan" id="kobo.98.1">src/pages/Blog.jsx</span></strong></span></li></ul></li>
</ol>
<p class="calibre3"><span class="kobospan" id="kobo.99.1">Now that we have cleaned up our project, let’s get started with implementing a Socket.IO context for our new </span><span><span class="kobospan" id="kobo.100.1">chat app.</span></span></p>
<h2 id="_idParaDest-264" class="calibre7"><a id="_idTextAnchor267" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.101.1">Creating a Socket.IO context</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.102.1">Up until now, we</span><a id="_idIndexMarker805" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.103.1"> have been initializing the Socket.IO client instance in the </span><strong class="source-inline"><span class="kobospan" id="kobo.104.1">src/App.jsx</span></strong><span class="kobospan" id="kobo.105.1"> component. </span><span class="kobospan" id="kobo.105.2">However, doing this has </span><span><span class="kobospan" id="kobo.106.1">some downsides:</span></span></p>
<ul class="calibre10">
<li class="calibre11"><span class="kobospan" id="kobo.107.1">To access the socket in other components, we would need to pass it down </span><span><span class="kobospan" id="kobo.108.1">via props.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.109.1">We can only have one socket connection for the </span><span><span class="kobospan" id="kobo.110.1">whole app.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.111.1">It is not possible to get the token dynamically from </span><strong class="source-inline1"><span class="kobospan" id="kobo.112.1">AuthContext</span></strong><span class="kobospan" id="kobo.113.1">, requiring us to store the token in local </span><span><span class="kobospan" id="kobo.114.1">storage instead.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.115.1">Our app requires a full refresh to be able to load the new token and connect </span><span><span class="kobospan" id="kobo.116.1">with it.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.117.1">We still try to connect and get an error when not </span><span><span class="kobospan" id="kobo.118.1">logged in.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.119.1">To solve these </span><a id="_idIndexMarker806" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.120.1">issues, we can instead create a Socket.IO context. </span><span class="kobospan" id="kobo.120.2">We can then use the provider component to do </span><span><span class="kobospan" id="kobo.121.1">the following:</span></span></p>
<ul class="calibre10">
<li class="calibre11"><span class="kobospan" id="kobo.122.1">Connect to Socket.IO only when the token is available </span><span><span class="kobospan" id="kobo.123.1">in </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.124.1">AuthContext</span></strong></span><span><span class="kobospan" id="kobo.125.1">.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.126.1">Store the status of the Socket.IO connection and use it within components to, for example, only show the chat interface when </span><span><span class="kobospan" id="kobo.127.1">logged in.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.128.1">Store the error object and display errors in the </span><span><span class="kobospan" id="kobo.129.1">user interface.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.130.1">The following diagram shows how the status of our connection will </span><span><span class="kobospan" id="kobo.131.1">be tracked:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer124">
<span class="kobospan" id="kobo.132.1"><img alt="Figure 14.1 – The different states of the connection" src="image/B19385_14_1.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.133.1">Figure 14.1 – The different states of the connection</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.134.1">As can be seen, the socket connection is initially waiting for the user to log in. </span><span class="kobospan" id="kobo.134.2">Once the token is available, we attempt to establish a socket connection. </span><span class="kobospan" id="kobo.134.3">If successful, the status changes to </span><strong class="source-inline"><span class="kobospan" id="kobo.135.1">connected</span></strong><span class="kobospan" id="kobo.136.1">, otherwise to </span><strong class="source-inline"><span class="kobospan" id="kobo.137.1">error</span></strong><span class="kobospan" id="kobo.138.1">. </span><span class="kobospan" id="kobo.138.2">If the socket disconnects (for example, when the internet connection is lost), the state is set </span><span><span class="kobospan" id="kobo.139.1">to </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.140.1">disconnected</span></strong></span><span><span class="kobospan" id="kobo.141.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.142.1">Now, let’s get started with creating a </span><span><span class="kobospan" id="kobo.143.1">Socket.IO context:</span></span></p>
<ol class="calibre15">
<li class="calibre11"><span class="kobospan" id="kobo.144.1">Create a new </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.145.1">src/contexts/SocketIOContext.jsx</span></strong></span><span><span class="kobospan" id="kobo.146.1"> file.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.147.1">Inside this file, import the following functions from </span><strong class="source-inline1"><span class="kobospan" id="kobo.148.1">react</span></strong><span class="kobospan" id="kobo.149.1">, </span><strong class="source-inline1"><span class="kobospan" id="kobo.150.1">socket.io-client</span></strong><span class="kobospan" id="kobo.151.1">, </span><span><span class="kobospan" id="kobo.152.1">and </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.153.1">prop-types</span></strong></span><span><span class="kobospan" id="kobo.154.1">:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.155.1">
import { createContext, useState, useContext, useEffect } from 'react'
import { io } from 'socket.io-client'
import PropTypes from 'prop-types'</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.156.1">Additionally, import the </span><strong class="source-inline1"><span class="kobospan" id="kobo.157.1">useAuth</span></strong><span class="kobospan" id="kobo.158.1"> hook from </span><strong class="source-inline1"><span class="kobospan" id="kobo.159.1">AuthContext</span></strong><span class="kobospan" id="kobo.160.1"> to get the </span><span><span class="kobospan" id="kobo.161.1">current token:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.162.1">
import { useAuth } from './AuthContext.jsx'</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.163.1">Now, define a</span><a id="_idIndexMarker807" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.164.1"> React Context with some initial values for </span><strong class="source-inline1"><span class="kobospan" id="kobo.165.1">socket</span></strong><span class="kobospan" id="kobo.166.1">, </span><strong class="source-inline1"><span class="kobospan" id="kobo.167.1">status</span></strong> <span><span class="kobospan" id="kobo.168.1">and </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.169.1">error</span></strong></span><span><span class="kobospan" id="kobo.170.1">:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.171.1">
export const SocketIOContext = createContext({
  socket: null,
  status: 'waiting',
  error: null,
})</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.172.1">Next, define a provider component, in which we first create state hooks for the different values of </span><span><span class="kobospan" id="kobo.173.1">the context:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.174.1">
export const SocketIOContextProvider = ({ children }) =&gt; {
  const [socket, setSocket] = useState(null)
  const [status, setStatus] = useState('waiting')
  const [error, setError] = useState(null)</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.175.1">Then, use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.176.1">useAuth</span></strong><span class="kobospan" id="kobo.177.1"> hook to get the JWT (</span><span><span class="kobospan" id="kobo.178.1">if available):</span></span><pre class="source-code"><span class="kobospan1" id="kobo.179.1">
  const [token] = useAuth()</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.180.1">Create an effect hook that checks whether the token is available, and if so, attempts to connect to</span><a id="_idIndexMarker808" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.181.1"> the </span><span><span class="kobospan" id="kobo.182.1">Socket.IO backend:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.183.1">
  useEffect(() =&gt; {
    if (token) {
      const socket = io(import.meta.env.VITE_SOCKET_HOST, {
        query: window.location.search.substring(1),
        auth: { token },
      })</span></pre><p class="calibre3"><span class="kobospan" id="kobo.184.1">Just like before, we pass the host, the </span><strong class="source-inline"><span class="kobospan" id="kobo.185.1">query</span></strong><span class="kobospan" id="kobo.186.1"> string, and the </span><strong class="source-inline"><span class="kobospan" id="kobo.187.1">auth</span></strong><span class="kobospan" id="kobo.188.1"> object. </span><span class="kobospan" id="kobo.188.2">However, now we get the token from the </span><strong class="source-inline"><span class="kobospan" id="kobo.189.1">useAuth</span></strong><span class="kobospan" id="kobo.190.1"> hook instead of </span><span><span class="kobospan" id="kobo.191.1">local storage.</span></span></p></li> <li class="calibre11"><span class="kobospan" id="kobo.192.1">Create handlers </span><a id="_idIndexMarker809" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.193.1">for the </span><strong class="source-inline1"><span class="kobospan" id="kobo.194.1">connect</span></strong><span class="kobospan" id="kobo.195.1">, </span><strong class="source-inline1"><span class="kobospan" id="kobo.196.1">connect_error</span></strong><span class="kobospan" id="kobo.197.1">, and </span><strong class="source-inline1"><span class="kobospan" id="kobo.198.1">disconnect</span></strong><span class="kobospan" id="kobo.199.1"> events and set the </span><strong class="source-inline1"><span class="kobospan" id="kobo.200.1">status</span></strong><span class="kobospan" id="kobo.201.1"> string and the </span><strong class="source-inline1"><span class="kobospan" id="kobo.202.1">error</span></strong> <span><span class="kobospan" id="kobo.203.1">object, respectively:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.204.1">
      socket.on('connect', () =&gt; {
        setStatus('connected')
        setError(null)
      })
      socket.on('connect_error', (err) =&gt; {
        setStatus('error')
        setError(err)
      })
      socket.on('disconnect', () =&gt; setStatus('disconnected'))</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.205.1">Set the </span><strong class="source-inline1"><span class="kobospan" id="kobo.206.1">socket</span></strong><span class="kobospan" id="kobo.207.1"> object and list all necessary dependencies for the </span><span><span class="kobospan" id="kobo.208.1">effect hook:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.209.1">
      setSocket(socket)
    }
  }, [token, setSocket, setStatus, setError])</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.210.1"> Now we can return the provider, passing all values from the state hooks </span><span><span class="kobospan" id="kobo.211.1">to it:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.212.1">
  return (
    &lt;SocketIOContext.Provider value={{ socket, status, error }}&gt;
      {children}
    &lt;/SocketIOContext.Provider&gt;
  )
}</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.213.1">Finally, we set </span><strong class="source-inline1"><span class="kobospan" id="kobo.214.1">PropTypes</span></strong><span class="kobospan" id="kobo.215.1"> for the</span><a id="_idIndexMarker810" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.216.1"> context provider component and define a </span><strong class="source-inline1"><span class="kobospan" id="kobo.217.1">useSocket</span></strong><span class="kobospan" id="kobo.218.1"> hook that will simply return the </span><span><span class="kobospan" id="kobo.219.1">whole context:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.220.1">
SocketIOContextProvider.propTypes = {
  children: PropTypes.element.isRequired,
}
export function useSocket() {
  return useContext(SocketIOContext)
}</span></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.221.1">Now that we have a context to initialize our Socket.IO client, let’s hook it up and display the status of the </span><span><span class="kobospan" id="kobo.222.1">socket connection.</span></span></p>
<h2 id="_idParaDest-265" class="calibre7"><a id="_idTextAnchor268" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.223.1">Hooking up the context and displaying the status</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.224.1">We can now remove the</span><a id="_idIndexMarker811" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.225.1"> code to connect to Socket.IO from the </span><strong class="source-inline"><span class="kobospan" id="kobo.226.1">App</span></strong><span class="kobospan" id="kobo.227.1"> component and use the provider instead, </span><span><span class="kobospan" id="kobo.228.1">as follows:</span></span></p>
<ol class="calibre15">
<li class="calibre11"><span class="kobospan" id="kobo.229.1">Edit </span><strong class="source-inline1"><span class="kobospan" id="kobo.230.1">src/App.jsx</span></strong><span class="kobospan" id="kobo.231.1"> and </span><em class="italic"><span class="kobospan" id="kobo.232.1">remove</span></em><span class="kobospan" id="kobo.233.1"> the </span><span><span class="kobospan" id="kobo.234.1">following import:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.235.1">
import { io } from 'socket.io-client'</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.236.1">Add an import </span><span><span class="kobospan" id="kobo.237.1">to </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.238.1">SocketIOContextProvider</span></strong></span><span><span class="kobospan" id="kobo.239.1">:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.240.1">
import { SocketIOContextProvider } from './contexts/SocketIOContext.jsx'</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.241.1">Then, </span><em class="italic"><span class="kobospan" id="kobo.242.1">remove</span></em><a id="_idIndexMarker812" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.243.1"> the following code related to the </span><span><span class="kobospan" id="kobo.244.1">Socket.IO connection:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.245.1">
const socket = io(import.meta.env.VITE_SOCKET_HOST, {
  query: window.location.search.substring(1),
  auth: {
    token: window.localStorage.getItem('token'),
  },
})
socket.on('connect', async () =&gt; {
  console.log('connected to socket.io as', socket.id)
  socket.emit('chat.message', 'hello from client')
  const userInfo = await socket.emitWithAck('user.info', socket.id)
  console.log('user info', userInfo)
})
socket.on('connect_error', (err) =&gt; {
  console.error('socket.io connect error:', err)
})
socket.on('chat.message', (message) =&gt; {
  console.log(message)
})</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.246.1">Inside the </span><strong class="source-inline1"><span class="kobospan" id="kobo.247.1">App</span></strong><span class="kobospan" id="kobo.248.1"> component, render </span><a id="_idIndexMarker813" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.249.1">the </span><span><span class="kobospan" id="kobo.250.1">context provider:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.251.1">
export function App() {
  return (
    &lt;QueryClientProvider client={queryClient}&gt;
      &lt;AuthContextProvider&gt;
</span><strong class="bold1"><span class="kobospan1" id="kobo.252.1">        &lt;SocketIOContextProvider&gt;</span></strong><span class="kobospan1" id="kobo.253.1">
          &lt;RouterProvider router={router} /&gt;
</span><strong class="bold1"><span class="kobospan1" id="kobo.254.1">        &lt;/SocketIOContextProvider&gt;</span></strong><span class="kobospan1" id="kobo.255.1">
      &lt;/AuthContextProvider&gt;
    &lt;/QueryClientProvider&gt;
  )
}</span></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.256.1">After hooking up the Socket.IO context, let’s move on to creating a </span><strong class="source-inline"><span class="kobospan" id="kobo.257.1">Status</span></strong><span class="kobospan" id="kobo.258.1"> component to display </span><span><span class="kobospan" id="kobo.259.1">the status.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.260.1">Creating a Status component</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.261.1">Now, let’s </span><a id="_idIndexMarker814" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.262.1">create a </span><strong class="source-inline"><span class="kobospan" id="kobo.263.1">Status</span></strong><span class="kobospan" id="kobo.264.1"> component to display the current status of </span><span><span class="kobospan" id="kobo.265.1">the socket:</span></span></p>
<ol class="calibre15">
<li class="calibre11"><span class="kobospan" id="kobo.266.1">Create a new </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.267.1">src/components/Status.jsx</span></strong></span><span><span class="kobospan" id="kobo.268.1"> file.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.269.1">Inside it, import the </span><strong class="source-inline1"><span class="kobospan" id="kobo.270.1">useSocket</span></strong><span class="kobospan" id="kobo.271.1"> hook from </span><span><span class="kobospan" id="kobo.272.1">our </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.273.1">SocketIOContext</span></strong></span><span><span class="kobospan" id="kobo.274.1">:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.275.1">
import { useSocket } from '../contexts/SocketIOContext.jsx'</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.276.1">Define a </span><strong class="source-inline1"><span class="kobospan" id="kobo.277.1">Status</span></strong><span class="kobospan" id="kobo.278.1"> component, in which we get the </span><strong class="source-inline1"><span class="kobospan" id="kobo.279.1">status</span></strong><span class="kobospan" id="kobo.280.1"> string and </span><strong class="source-inline1"><span class="kobospan" id="kobo.281.1">error</span></strong><span class="kobospan" id="kobo.282.1"> object from </span><span><span class="kobospan" id="kobo.283.1">the hook:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.284.1">
export function Status() {
  const { status, error } = useSocket()</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.285.1">Render the </span><span><span class="kobospan" id="kobo.286.1">socket status:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.287.1">
  return (
    &lt;div&gt;
      Socket status: &lt;b&gt;{status}&lt;/b&gt;</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.288.1">If we have</span><a id="_idIndexMarker815" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.289.1"> an </span><strong class="source-inline1"><span class="kobospan" id="kobo.290.1">error</span></strong><span class="kobospan" id="kobo.291.1"> object, we can additionally display the error </span><span><span class="kobospan" id="kobo.292.1">message now:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.293.1">
      {error &amp;&amp; &lt;i&gt; - {error.message}&lt;/i&gt;}
    &lt;/div&gt;
  )
}</span></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.294.1">Now that we have a </span><strong class="source-inline"><span class="kobospan" id="kobo.295.1">Status</span></strong><span class="kobospan" id="kobo.296.1"> component, let’s create a </span><strong class="source-inline"><span class="kobospan" id="kobo.297.1">Chat</span></strong><span class="kobospan" id="kobo.298.1"> page component, where we render the </span><strong class="source-inline"><span class="kobospan" id="kobo.299.1">Header</span></strong><span class="kobospan" id="kobo.300.1"> and </span><span><strong class="source-inline"><span class="kobospan" id="kobo.301.1">Status</span></strong></span><span><span class="kobospan" id="kobo.302.1"> components.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.303.1">Creating a Chat page component</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.304.1">We previously </span><a id="_idIndexMarker816" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.305.1">had a </span><strong class="source-inline"><span class="kobospan" id="kobo.306.1">Blog</span></strong><span class="kobospan" id="kobo.307.1"> page for our blog app, which we deleted earlier in this chapter. </span><span class="kobospan" id="kobo.307.2">Let’s now create a new </span><strong class="source-inline"><span class="kobospan" id="kobo.308.1">Chat</span></strong><span class="kobospan" id="kobo.309.1"> page component for our </span><span><span class="kobospan" id="kobo.310.1">chat app:</span></span></p>
<ol class="calibre15">
<li class="calibre11"><span class="kobospan" id="kobo.311.1">Create a new </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.312.1">src/pages/Chat.jsx</span></strong></span><span><span class="kobospan" id="kobo.313.1"> file.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.314.1">Inside it, import the </span><strong class="source-inline1"><span class="kobospan" id="kobo.315.1">Header</span></strong><span class="kobospan" id="kobo.316.1"> component (which we are going to reuse from the </span><strong class="source-inline1"><span class="kobospan" id="kobo.317.1">Blog</span></strong><span class="kobospan" id="kobo.318.1"> app) and the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.319.1">Status</span></strong></span><span><span class="kobospan" id="kobo.320.1"> component:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.321.1">
import { Header } from '../components/Header.jsx'
import { Status } from '../components/Status.jsx'</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.322.1">Render a </span><strong class="source-inline1"><span class="kobospan" id="kobo.323.1">Chat</span></strong><span class="kobospan" id="kobo.324.1"> component in which we display the </span><strong class="source-inline1"><span class="kobospan" id="kobo.325.1">Header</span></strong><span class="kobospan" id="kobo.326.1"> and </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.327.1">Status</span></strong></span><span><span class="kobospan" id="kobo.328.1"> components:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.329.1">
export function Chat() {
  return (
    &lt;div style={{ padding: 8 }}&gt;
      &lt;Header /&gt;
      &lt;br /&gt;
      &lt;hr /&gt;
      &lt;br /&gt;
      &lt;Status /&gt;
    &lt;/div&gt;
  )
}</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.330.1">Edit </span><strong class="source-inline1"><span class="kobospan" id="kobo.331.1">src/App.jsx</span></strong><span class="kobospan" id="kobo.332.1"> and locate the </span><span><span class="kobospan" id="kobo.333.1">following import:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.334.1">
import { Blog } from './pages/Blog.jsx'</span></pre><p class="calibre3"><em class="italic"><span class="kobospan" id="kobo.335.1">Replace</span></em><span class="kobospan" id="kobo.336.1"> it with an import to the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.337.1">Chat</span></strong></span><span><span class="kobospan" id="kobo.338.1"> component:</span></span></p><pre class="source-code"><span class="kobospan1" id="kobo.339.1">import { Chat } from './pages/Chat.jsx'</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.340.1">Finally, </span><em class="italic"><span class="kobospan" id="kobo.341.1">replace</span></em><span class="kobospan" id="kobo.342.1"> the </span><strong class="source-inline1"><span class="kobospan" id="kobo.343.1">&lt;Blog /&gt;</span></strong><span class="kobospan" id="kobo.344.1"> component </span><a id="_idIndexMarker817" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.345.1">in the main path in our router with the </span><strong class="source-inline1"><span class="kobospan" id="kobo.346.1">&lt;Chat /&gt;</span></strong> <span><span class="kobospan" id="kobo.347.1">component:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.348.1">
const router = createBrowserRouter([
  {
    path: '/',
    element: </span><strong class="bold1"><span class="kobospan1" id="kobo.349.1">&lt;Chat /&gt;</span></strong><span class="kobospan1" id="kobo.350.1">,
  },</span></pre></li> </ol>
<h3 class="calibre9"><span class="kobospan" id="kobo.351.1">Starting and testing our chat app frontend</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.352.1">We can now start and</span><a id="_idIndexMarker818" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.353.1"> test out our chat </span><span><span class="kobospan" id="kobo.354.1">app frontend:</span></span></p>
<ol class="calibre15">
<li class="calibre11"><span class="kobospan" id="kobo.355.1">Run the</span><a id="_idIndexMarker819" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.356.1"> frontend, </span><span><span class="kobospan" id="kobo.357.1">as follows:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.358.1">$ npm run dev</span></strong></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.359.1">Run the backend, as follows (make sure Docker and the database container </span><span><span class="kobospan" id="kobo.360.1">are running!):</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.361.1">$ cd backend/</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.362.1">$ npm run dev</span></strong></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.363.1">Now go to </span><strong class="source-inline1"><span class="kobospan" id="kobo.364.1">http://localhost:5173/</span></strong><span class="kobospan" id="kobo.365.1"> and you should see the </span><span><span class="kobospan" id="kobo.366.1">following interface:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer125">
<span class="kobospan" id="kobo.367.1"><img alt="Figure 14.2 – Socket connection waiting for user to be logged in" src="image/B19385_14_2.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.368.1">Figure 14.2 – Socket connection waiting for user to be logged in</span></p>
<ol class="calibre15">
<li value="4" class="calibre11"><span class="kobospan" id="kobo.369.1">Log in (create a new user if you do not have one yet), and the socket should </span><span><span class="kobospan" id="kobo.370.1">connect</span></span><span><a id="_idIndexMarker820" class="calibre6 pcalibre1 pcalibre"/></span><span><span class="kobospan" id="kobo.371.1"> successfully:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer126">
<span class="kobospan" id="kobo.372.1"><img alt="Figure 14.3 – Socket connected after user is logged in" src="image/B19385_14_3.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.373.1">Figure 14.3 – Socket connected after user is logged in</span></p>
<h2 id="_idParaDest-266" class="calibre7"><a id="_idTextAnchor269" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.374.1">Disconnecting socket on logout</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.375.1">You may have noticed that </span><a id="_idIndexMarker821" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.376.1">when pressing </span><strong class="bold"><span class="kobospan" id="kobo.377.1">Logout</span></strong><span class="kobospan" id="kobo.378.1">, the socket stays connected. </span><span class="kobospan" id="kobo.378.2">Let’s fix that now, by disconnecting the socket when </span><span><span class="kobospan" id="kobo.379.1">logging out:</span></span></p>
<ol class="calibre15">
<li class="calibre11"><span class="kobospan" id="kobo.380.1">Edit </span><strong class="source-inline1"><span class="kobospan" id="kobo.381.1">src/components/Header.jsx</span></strong><span class="kobospan" id="kobo.382.1"> and import the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.383.1">useSocket</span></strong></span><span><span class="kobospan" id="kobo.384.1"> hook:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.385.1">
import { useSocket } from '../contexts/SocketIOContext.jsx'</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.386.1">Get the socket from the </span><strong class="source-inline1"><span class="kobospan" id="kobo.387.1">useSocket</span></strong><span class="kobospan" id="kobo.388.1"> hook, </span><span><span class="kobospan" id="kobo.389.1">as follows:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.390.1">
export function Header() {
  const [token, setToken] = useAuth()
</span><strong class="bold1"><span class="kobospan1" id="kobo.391.1">  const { socket } = useSocket()</span></strong></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.392.1">Define a new </span><strong class="source-inline1"><span class="kobospan" id="kobo.393.1">handleLogout</span></strong><span class="kobospan" id="kobo.394.1"> function, which disconnects the socket and resets </span><span><span class="kobospan" id="kobo.395.1">the token:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.396.1">
  const handleLogout = () =&gt; {
    socket.disconnect()
    setToken(null)
  }</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.397.1">Lastly, set the </span><strong class="source-inline1"><span class="kobospan" id="kobo.398.1">onClick</span></strong><span class="kobospan" id="kobo.399.1"> handler to the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.400.1">handleLogout</span></strong></span><span><span class="kobospan" id="kobo.401.1"> function:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.402.1">
        &lt;button onClick={</span><strong class="bold1"><span class="kobospan1" id="kobo.403.1">handleLogout</span></strong><span class="kobospan1" id="kobo.404.1">}&gt;Logout&lt;/button&gt;</span></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.405.1">Now, when you log out, the socket will be disconnected, as can be seen in the </span><span><span class="kobospan" id="kobo.406.1">following screenshot:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer127">
<span class="kobospan" id="kobo.407.1"><img alt="Figure 14.4 – Socket disconnected after logging out" src="image/B19385_14_4.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.408.1">Figure 14.4 – Socket disconnected after logging out</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.409.1">Now that the Socket.IO client is successfully integrated with our React frontend, we can continue by implementing chat functionality in </span><span><span class="kobospan" id="kobo.410.1">the frontend.</span></span></p>
<h1 id="_idParaDest-267" class="calibre5"><a id="_idTextAnchor270" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.411.1">Implementing chat functionality</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.412.1">We are now going </span><a id="_idIndexMarker822" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.413.1">to implement functionality to send and receive messages in our chat app. </span><span class="kobospan" id="kobo.413.2">First, we are going to implement all the components that we need. </span><span class="kobospan" id="kobo.413.3">Then, we are going to create a </span><strong class="source-inline"><span class="kobospan" id="kobo.414.1">useChat</span></strong><span class="kobospan" id="kobo.415.1"> hook to implement the logic to interface with the socket connection and provide functions to send/receive messages. </span><span class="kobospan" id="kobo.415.2">Lastly, we are going to put it all together by creating a </span><span><span class="kobospan" id="kobo.416.1">chat room.</span></span></p>
<h2 id="_idParaDest-268" class="calibre7"><a id="_idTextAnchor271" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.417.1">Implementing the chat components</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.418.1">We are going to</span><a id="_idIndexMarker823" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.419.1"> implement the following </span><span><span class="kobospan" id="kobo.420.1">chat components:</span></span></p>
<ul class="calibre10">
<li class="calibre11"><strong class="source-inline1"><span class="kobospan" id="kobo.421.1">ChatMessage</span></strong><span class="kobospan" id="kobo.422.1">: To display </span><span><span class="kobospan" id="kobo.423.1">chat messages</span></span></li>
<li class="calibre11"><strong class="source-inline1"><span class="kobospan" id="kobo.424.1">EnterMessage</span></strong><span class="kobospan" id="kobo.425.1">: A field to enter new messages and a button to </span><span><span class="kobospan" id="kobo.426.1">send them</span></span></li>
</ul>
<h3 class="calibre9"><span class="kobospan" id="kobo.427.1">Implementing the ChatMessage component</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.428.1">Let’s start by</span><a id="_idIndexMarker824" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.429.1"> implementing the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.430.1">ChatMessage</span></strong></span><span><span class="kobospan" id="kobo.431.1"> component:</span></span></p>
<ol class="calibre15">
<li class="calibre11"><span class="kobospan" id="kobo.432.1">Create a new </span><strong class="source-inline1"><span class="kobospan" id="kobo.433.1">src/components/ChatMessage.jsx</span></strong><span class="kobospan" id="kobo.434.1"> file, which will render a </span><span><span class="kobospan" id="kobo.435.1">chat message.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.436.1">Import </span><strong class="source-inline1"><span class="kobospan" id="kobo.437.1">PropTypes</span></strong><span class="kobospan" id="kobo.438.1"> and define a new function with </span><strong class="source-inline1"><span class="kobospan" id="kobo.439.1">username</span></strong><span class="kobospan" id="kobo.440.1"> and </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.441.1">message</span></strong></span><span><span class="kobospan" id="kobo.442.1"> props:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.443.1">
import PropTypes from 'prop-types'
export function ChatMessage({ username, message }) {</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.444.1">Render the username in bold and the message next </span><span><span class="kobospan" id="kobo.445.1">to it:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.446.1">
  return (
    &lt;div&gt;
      &lt;b&gt;{username}&lt;/b&gt;: {message}
    &lt;/div&gt;
  )
}</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.447.1">Define</span><a id="_idIndexMarker825" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.448.1"> the prop types, </span><span><span class="kobospan" id="kobo.449.1">as follows:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.450.1">
ChatMessage.propTypes = {
  username: PropTypes.string.isRequired,
  message: PropTypes.string.isRequired,
}</span></pre></li> </ol>
<h3 class="calibre9"><span class="kobospan" id="kobo.451.1">Implementing the EnterMessage component</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.452.1">Now, let’s </span><a id="_idIndexMarker826" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.453.1">create the </span><strong class="source-inline"><span class="kobospan" id="kobo.454.1">EnterMessage</span></strong><span class="kobospan" id="kobo.455.1"> component, which will allow users to send a new </span><span><span class="kobospan" id="kobo.456.1">chat message:</span></span></p>
<ol class="calibre15">
<li class="calibre11"><span class="kobospan" id="kobo.457.1">Create a new </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.458.1">src/components/EnterMessage.jsx</span></strong></span><span><span class="kobospan" id="kobo.459.1"> file.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.460.1">Import the </span><strong class="source-inline1"><span class="kobospan" id="kobo.461.1">useState</span></strong><span class="kobospan" id="kobo.462.1"> hook </span><span><span class="kobospan" id="kobo.463.1">and </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.464.1">PropTypes</span></strong></span><span><span class="kobospan" id="kobo.465.1">:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.466.1">
import { useState } from 'react'
import PropTypes from 'prop-types'</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.467.1">Define a new </span><strong class="source-inline1"><span class="kobospan" id="kobo.468.1">EnterMessage</span></strong><span class="kobospan" id="kobo.469.1"> component, which receives an </span><strong class="source-inline1"><span class="kobospan" id="kobo.470.1">onSend</span></strong><span class="kobospan" id="kobo.471.1"> function </span><span><span class="kobospan" id="kobo.472.1">as props:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.473.1">
export function EnterMessage({ onSend }) {</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.474.1">We store the current state of the </span><span><span class="kobospan" id="kobo.475.1">message entered:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.476.1">
  const [message, setMessage] = useState('')</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.477.1">Then, we define a function to handle sending the request and clearing the </span><span><span class="kobospan" id="kobo.478.1">field afterward:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.479.1">
  function handleSend(e) {
    e.preventDefault()
    onSend(message)
    setMessage('')
  }</span></pre></li> </ol>
<p class="callout-heading"><span class="kobospan" id="kobo.480.1">Reminder</span></p>
<p class="callout"><span class="kobospan" id="kobo.481.1">Because we are submitting a form using a </span><strong class="source-inline1"><span class="kobospan" id="kobo.482.1">submit</span></strong><span class="kobospan" id="kobo.483.1"> button, we need to call </span><strong class="source-inline1"><span class="kobospan" id="kobo.484.1">e.preventDefault()</span></strong><span class="kobospan" id="kobo.485.1"> to prevent the form from refreshing </span><span><span class="kobospan" id="kobo.486.1">the page.</span></span></p>
<ol class="calibre15">
<li value="6" class="calibre11"><span class="kobospan" id="kobo.487.1">Render </span><a id="_idIndexMarker827" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.488.1">a form with an input field to enter the message and a button to </span><span><span class="kobospan" id="kobo.489.1">send it:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.490.1">
  return (
    &lt;form onSubmit={handleSend}&gt;
      &lt;input
        type='text'
        value={message}
        onChange={(e) =&gt; setMessage(e.target.value)}
      /&gt;
      &lt;input type='submit' value='Send' /&gt;
    &lt;/form&gt;
  )
}</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.491.1">Define the</span><a id="_idIndexMarker828" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.492.1"> prop types, </span><span><span class="kobospan" id="kobo.493.1">as follows:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.494.1">
EnterMessage.propTypes = {
  onSend: PropTypes.func.isRequired,
}</span></pre></li> </ol>
<h2 id="_idParaDest-269" class="calibre7"><a id="_idTextAnchor272" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.495.1">Implementing a useChat hook</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.496.1">To bundle all the </span><a id="_idIndexMarker829" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.497.1">logic together, we are going to implement a </span><strong class="source-inline"><span class="kobospan" id="kobo.498.1">useChat</span></strong><span class="kobospan" id="kobo.499.1"> hook, which is going to deal with sending and receiving messages, as well as storing all current messages in a state hook. </span><span class="kobospan" id="kobo.499.2">Follow these steps to </span><span><span class="kobospan" id="kobo.500.1">implement it:</span></span></p>
<ol class="calibre15">
<li class="calibre11"><span class="kobospan" id="kobo.501.1">Create a new </span><strong class="source-inline1"><span class="kobospan" id="kobo.502.1">src/hooks/</span></strong><span class="kobospan" id="kobo.503.1"> folder. </span><span class="kobospan" id="kobo.503.2">Inside it, create a new </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.504.1">src/hooks/useChat.js</span></strong></span><span><span class="kobospan" id="kobo.505.1"> file.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.506.1">Import the </span><strong class="source-inline1"><span class="kobospan" id="kobo.507.1">useState</span></strong><span class="kobospan" id="kobo.508.1"> and </span><strong class="source-inline1"><span class="kobospan" id="kobo.509.1">useEffect</span></strong><span class="kobospan" id="kobo.510.1"> hooks </span><span><span class="kobospan" id="kobo.511.1">from React:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.512.1">
import { useState, useEffect } from 'react'</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.513.1">Import the </span><strong class="source-inline1"><span class="kobospan" id="kobo.514.1">useSocket</span></strong><span class="kobospan" id="kobo.515.1"> hook from </span><span><span class="kobospan" id="kobo.516.1">our context:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.517.1">
import { useSocket } from '../contexts/SocketIOContext.jsx'</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.518.1">Define a new </span><strong class="source-inline1"><span class="kobospan" id="kobo.519.1">useChat</span></strong><span class="kobospan" id="kobo.520.1"> function, where we get the socket from the </span><strong class="source-inline1"><span class="kobospan" id="kobo.521.1">useSocket</span></strong><span class="kobospan" id="kobo.522.1"> hook, and define a state hook to store an array </span><span><span class="kobospan" id="kobo.523.1">of messages:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.524.1">
export function useChat() {
  const { socket } = useSocket()
  const [messages, setMessages] = useState([])</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.525.1">Next, define a </span><strong class="source-inline1"><span class="kobospan" id="kobo.526.1">receiveMessage</span></strong><span class="kobospan" id="kobo.527.1"> function, which appends a new message to </span><span><span class="kobospan" id="kobo.528.1">the array:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.529.1">
  function receiveMessage(message) {
    setMessages((messages) =&gt; [...messages, message])
  }</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.530.1">Now, create an effect hook, in which we create a listener </span><span><span class="kobospan" id="kobo.531.1">using </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.532.1">socket.on</span></strong></span><span><span class="kobospan" id="kobo.533.1">:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.534.1">
  useEffect(() =&gt; {
    socket.on('chat.message', receiveMessage)</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.535.1">We need to make sure to remove the listener again using </span><strong class="source-inline1"><span class="kobospan" id="kobo.536.1">socket.off</span></strong><span class="kobospan" id="kobo.537.1"> when the effect hook unmounts, otherwise we might end up with multiple listeners when the component re-renders </span><span><span class="kobospan" id="kobo.538.1">or unmounts:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.539.1">
    return () =&gt; socket.off('chat.message', receiveMessage)
  }, [])</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.540.1">Now, receiving </span><a id="_idIndexMarker830" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.541.1">messages should work fine. </span><span class="kobospan" id="kobo.541.2">Let’s move on to sending messages. </span><span class="kobospan" id="kobo.541.3">To do this, we create a </span><strong class="source-inline1"><span class="kobospan" id="kobo.542.1">sendMessage</span></strong><span class="kobospan" id="kobo.543.1"> function, which uses </span><strong class="source-inline1"><span class="kobospan" id="kobo.544.1">socket.emit</span></strong><span class="kobospan" id="kobo.545.1"> to send </span><span><span class="kobospan" id="kobo.546.1">the message:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.547.1">
  function sendMessage(message) {
    socket.emit('chat.message', message)
  }</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.548.1">Lastly, return </span><a id="_idIndexMarker831" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.549.1">the </span><strong class="source-inline1"><span class="kobospan" id="kobo.550.1">messages</span></strong><span class="kobospan" id="kobo.551.1"> array and the </span><strong class="source-inline1"><span class="kobospan" id="kobo.552.1">sendMessage</span></strong><span class="kobospan" id="kobo.553.1"> function so that we can use them in </span><span><span class="kobospan" id="kobo.554.1">our components:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.555.1">
  return { messages, sendMessage }
}</span></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.556.1">Now that we have successfully implemented the </span><strong class="source-inline"><span class="kobospan" id="kobo.557.1">useChat</span></strong><span class="kobospan" id="kobo.558.1"> hook, let’s </span><span><span class="kobospan" id="kobo.559.1">use it!</span></span></p>
<h2 id="_idParaDest-270" class="calibre7"><a id="_idTextAnchor273" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.560.1">Implementing the ChatRoom component</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.561.1">Finally, we can put it all </span><a id="_idIndexMarker832" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.562.1">together and implement a </span><strong class="source-inline"><span class="kobospan" id="kobo.563.1">ChatRoom</span></strong><span class="kobospan" id="kobo.564.1"> component. </span><span class="kobospan" id="kobo.564.2">Follow these steps to </span><span><span class="kobospan" id="kobo.565.1">get started:</span></span></p>
<ol class="calibre15">
<li class="calibre11"><span class="kobospan" id="kobo.566.1">Create a new </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.567.1">src/components/ChatRoom.jsx</span></strong></span><span><span class="kobospan" id="kobo.568.1"> file.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.569.1">Import the </span><strong class="source-inline1"><span class="kobospan" id="kobo.570.1">useChat</span></strong><span class="kobospan" id="kobo.571.1"> hook and the </span><strong class="source-inline1"><span class="kobospan" id="kobo.572.1">EnterMessage</span></strong><span class="kobospan" id="kobo.573.1"> and </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.574.1">ChatMessage</span></strong></span><span><span class="kobospan" id="kobo.575.1"> components:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.576.1">
import { useChat } from '../hooks/useChat.js'
import { EnterMessage } from './EnterMessage.jsx'
import { ChatMessage } from './ChatMessage.jsx'</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.577.1">Define a new component, which gets the </span><strong class="source-inline1"><span class="kobospan" id="kobo.578.1">messages</span></strong><span class="kobospan" id="kobo.579.1"> array and the </span><strong class="source-inline1"><span class="kobospan" id="kobo.580.1">sendMessage</span></strong><span class="kobospan" id="kobo.581.1"> function from the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.582.1">useChat</span></strong></span><span><span class="kobospan" id="kobo.583.1"> hook:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.584.1">
export function ChatRoom() {
  const { messages, sendMessage } = useChat()</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.585.1">Then, render</span><a id="_idIndexMarker833" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.586.1"> the list of messages as </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.587.1">ChatMessage</span></strong></span><span><span class="kobospan" id="kobo.588.1"> components:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.589.1">
  return (
    &lt;div&gt;
      {messages.map((message, index) =&gt; (
        &lt;ChatMessage key={index} {...message} /&gt;
      ))}</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.590.1">Next, render </span><a id="_idIndexMarker834" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.591.1">the </span><strong class="source-inline1"><span class="kobospan" id="kobo.592.1">EnterMessage</span></strong><span class="kobospan" id="kobo.593.1"> component and pass the </span><strong class="source-inline1"><span class="kobospan" id="kobo.594.1">sendMessage</span></strong><span class="kobospan" id="kobo.595.1"> function as the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.596.1">onSend</span></strong></span><span><span class="kobospan" id="kobo.597.1"> prop:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.598.1">
      &lt;EnterMessage onSend={sendMessage} /&gt;
    &lt;/div&gt;
  )
}</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.599.1">Edit </span><strong class="source-inline1"><span class="kobospan" id="kobo.600.1">src/pages/Chat.jsx</span></strong><span class="kobospan" id="kobo.601.1"> and import the </span><strong class="source-inline1"><span class="kobospan" id="kobo.602.1">ChatRoom</span></strong><span class="kobospan" id="kobo.603.1"> component and the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.604.1">useSocket</span></strong></span><span><span class="kobospan" id="kobo.605.1"> hook:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.606.1">
import { ChatRoom } from '../components/ChatRoom.jsx'
import { useSocket } from '../contexts/SocketIOContext.jsx'</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.607.1">Get the status from the </span><strong class="source-inline1"><span class="kobospan" id="kobo.608.1">useSocket</span></strong><span class="kobospan" id="kobo.609.1"> hook in the </span><strong class="source-inline1"><span class="kobospan" id="kobo.610.1">Chat</span></strong> <span><span class="kobospan" id="kobo.611.1">page component:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.612.1">
export function Chat() {
</span><strong class="bold1"><span class="kobospan1" id="kobo.613.1">  const { status } = useSocket()</span></strong></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.614.1">If the status</span><a id="_idIndexMarker835" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.615.1"> is </span><strong class="source-inline1"><span class="kobospan" id="kobo.616.1">connected</span></strong><span class="kobospan" id="kobo.617.1">, we show the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.618.1">ChatRoom</span></strong></span><span><span class="kobospan" id="kobo.619.1"> component:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.620.1">
  return (
    &lt;div style={{ padding: 8 }}&gt;
      &lt;Header /&gt;
      &lt;br /&gt;
      &lt;hr /&gt;
      &lt;br /&gt;
      &lt;Status /&gt;
</span><strong class="bold1"><span class="kobospan1" id="kobo.621.1">      &lt;br /&gt;</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.622.1">      &lt;hr /&gt;</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.623.1">      &lt;br /&gt;</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.624.1">      {status === 'connected' &amp;&amp; &lt;ChatRoom /&gt;}</span></strong></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.625.1">Now, go to </span><strong class="source-inline1"><span class="kobospan" id="kobo.626.1">http://localhost:5173/</span></strong><span class="kobospan" id="kobo.627.1"> in your browser and log in with a username and password. </span><span class="kobospan" id="kobo.627.2">The socket connects and the chat room is rendered. </span><span class="kobospan" id="kobo.627.3">Enter a chat message and send it by pressing </span><em class="italic"><span class="kobospan" id="kobo.628.1">Return/Enter</span></em><span class="kobospan" id="kobo.629.1"> or by clicking the </span><strong class="bold"><span class="kobospan" id="kobo.630.1">Send</span></strong><span class="kobospan" id="kobo.631.1"> button. </span><span class="kobospan" id="kobo.631.2">You will see that the message is received </span><span><span class="kobospan" id="kobo.632.1">and displayed!</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.633.1">Open a second</span><a id="_idIndexMarker836" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.634.1"> browser window and log in with a second user. </span><span class="kobospan" id="kobo.634.2">Send another message there. </span><span class="kobospan" id="kobo.634.3">You will see that the message is received by both users, as can be seen in the </span><span><span class="kobospan" id="kobo.635.1">following screenshot:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer128">
<span class="kobospan" id="kobo.636.1"><img alt="Figure 14.5 – Sending and receiving messages from different users" src="image/B19385_14_5.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.637.1">Figure 14.5 – Sending and receiving messages from different users</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.638.1">Now that we have a basic chat app working, let’s explore how we could implement chat commands </span><span><span class="kobospan" id="kobo.639.1">using acknowledgments.</span></span></p>
<h1 id="_idParaDest-271" class="calibre5"><a id="_idTextAnchor274" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.640.1">Implementing chat commands with acknowledgments</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.641.1">In addition to </span><a id="_idIndexMarker837" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.642.1">sending and receiving messages, chat apps often offer a way to send commands to the client and/or server. </span><span class="kobospan" id="kobo.642.2">For example, we could send a </span><strong class="source-inline"><span class="kobospan" id="kobo.643.1">/clear</span></strong><span class="kobospan" id="kobo.644.1"> command to clear our local messages list. </span><span class="kobospan" id="kobo.644.2">Or we could send a </span><strong class="source-inline"><span class="kobospan" id="kobo.645.1">/rooms</span></strong><span class="kobospan" id="kobo.646.1"> command to get a list of rooms that we are in. </span><span class="kobospan" id="kobo.646.2">Follow these steps to implement </span><span><span class="kobospan" id="kobo.647.1">chat commands:</span></span></p>
<ol class="calibre15">
<li class="calibre11"><span class="kobospan" id="kobo.648.1">Edit </span><strong class="source-inline1"><span class="kobospan" id="kobo.649.1">src/hooks/useChat.js</span></strong><span class="kobospan" id="kobo.650.1"> and adjust the </span><strong class="source-inline1"><span class="kobospan" id="kobo.651.1">sendMessage</span></strong><span class="kobospan" id="kobo.652.1"> function inside it. </span><span class="kobospan" id="kobo.652.2">First, let’s make it an </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.653.1">async</span></strong></span><span><span class="kobospan" id="kobo.654.1"> function:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.655.1">
  </span><strong class="bold1"><span class="kobospan1" id="kobo.656.1">async </span></strong><span class="kobospan1" id="kobo.657.1">function sendMessage(message) {</span></pre></li> <li class="calibre11"><em class="italic"><span class="kobospan" id="kobo.658.1">Replace</span></em><span class="kobospan" id="kobo.659.1"> the contents of the function with the following. </span><span class="kobospan" id="kobo.659.2">We first check whether the message starts with a slash (</span><strong class="source-inline1"><span class="kobospan" id="kobo.660.1">/</span></strong><span class="kobospan" id="kobo.661.1">). </span><span class="kobospan" id="kobo.661.2">If so, then we get the command by removing the slash and use a </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.662.1">switch</span></strong></span><span><span class="kobospan" id="kobo.663.1"> statement:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.664.1">
    if (message.startsWith('/')) {
      const command = message.substring(1)
      switch (command) {</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.665.1">For the </span><strong class="source-inline1"><span class="kobospan" id="kobo.666.1">clear</span></strong><span class="kobospan" id="kobo.667.1"> command, we simply set the array of messages to an </span><span><span class="kobospan" id="kobo.668.1">empty array:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.669.1">
        case 'clear':
          setMessages([])
          break</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.670.1">For the </span><strong class="source-inline1"><span class="kobospan" id="kobo.671.1">rooms</span></strong><span class="kobospan" id="kobo.672.1"> command, we get the user info by using </span><strong class="source-inline1"><span class="kobospan" id="kobo.673.1">socket.emitWithAck</span></strong><span class="kobospan" id="kobo.674.1"> and our </span><span><span class="kobospan" id="kobo.675.1">own </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.676.1">socket.id</span></strong></span><span><span class="kobospan" id="kobo.677.1">:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.678.1">
        case 'rooms': {
          const userInfo = await socket.emitWithAck('user.info', socket.id)</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.679.1">Then, we get the list of rooms, filtering out our own room (with the name of our </span><strong class="source-inline1"><span class="kobospan" id="kobo.680.1">socket.id</span></strong><span class="kobospan" id="kobo.681.1">) that we automatically join </span><span><span class="kobospan" id="kobo.682.1">in Socket.IO:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.683.1">
          const rooms = userInfo.rooms.filter((room) =&gt; room !== socket.id)</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.684.1">We reuse</span><a id="_idIndexMarker838" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.685.1"> the </span><strong class="source-inline1"><span class="kobospan" id="kobo.686.1">receiveMessage</span></strong><span class="kobospan" id="kobo.687.1"> function to send a message from the server, telling us the rooms that we </span><span><span class="kobospan" id="kobo.688.1">are in:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.689.1">
          receiveMessage({
            message: `You are in: ${rooms.join(', ')}`,
          })
          break
        }</span></pre><p class="calibre3"><span class="kobospan" id="kobo.690.1">Note that we are not sending a username here, just a message. </span><span class="kobospan" id="kobo.690.2">We will have to adapt the </span><strong class="source-inline"><span class="kobospan" id="kobo.691.1">ChatMessage</span></strong><span class="kobospan" id="kobo.692.1"> component to accommodate </span><span><span class="kobospan" id="kobo.693.1">that later.</span></span></p></li> <li class="calibre11"><span class="kobospan" id="kobo.694.1">If we receive any other command, we show an </span><span><span class="kobospan" id="kobo.695.1">error message:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.696.1">
        default:
          receiveMessage({
            message: `Unknown command: ${command}`,
          })
          break
      }</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.697.1">Otherwise (if the message did not start with a slash), we simply emit the chat message, </span><span><span class="kobospan" id="kobo.698.1">as before:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.699.1">
    } else {
      socket.emit('chat.message', message)
    }
  }</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.700.1">Finally, edit </span><strong class="source-inline1"><span class="kobospan" id="kobo.701.1">src/components/ChatMessage.jsx</span></strong><span class="kobospan" id="kobo.702.1"> and adapt the component</span><a id="_idIndexMarker839" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.703.1"> to render a system message if no username </span><span><span class="kobospan" id="kobo.704.1">was given:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.705.1">
export function ChatMessage({ username, message }) {
  return (
    &lt;div&gt;
</span><strong class="bold1"><span class="kobospan1" id="kobo.706.1">      {username ? </span><span class="kobospan1" id="kobo.706.2">(</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.707.1">        &lt;span&gt;</span></strong><span class="kobospan1" id="kobo.708.1">
          &lt;b&gt;{username}&lt;/b&gt;: {message}
</span><strong class="bold1"><span class="kobospan1" id="kobo.709.1">        &lt;/span&gt;</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.710.1">      ) : (</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.711.1">        &lt;i&gt;{message}&lt;/i&gt;</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.712.1">      )}</span></strong><span class="kobospan1" id="kobo.713.1">
    &lt;/div&gt;
  )
}</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.714.1">Do not forget to adjust </span><strong class="source-inline1"><span class="kobospan" id="kobo.715.1">PropTypes</span></strong><span class="kobospan" id="kobo.716.1"> to make the username optional (by </span><em class="italic"><span class="kobospan" id="kobo.717.1">removing</span></em> <strong class="source-inline1"><span class="kobospan" id="kobo.718.1">.isRequired</span></strong><span class="kobospan" id="kobo.719.1"> from the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.720.1">username</span></strong></span><span><span class="kobospan" id="kobo.721.1"> prop):</span></span><pre class="source-code"><span class="kobospan1" id="kobo.722.1">
ChatMessage.propTypes = {
  username: PropTypes.string,</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.723.1">Go to </span><strong class="source-inline1"><span class="kobospan" id="kobo.724.1">http://localhost:5173/</span></strong><span class="kobospan" id="kobo.725.1"> in your browser and try sending a couple messages. </span><span class="kobospan" id="kobo.725.2">Then, type </span><strong class="source-inline1"><span class="kobospan" id="kobo.726.1">/clear</span></strong><span class="kobospan" id="kobo.727.1"> and you will see all messages were cleared. </span><span class="kobospan" id="kobo.727.2">Next, type </span><strong class="source-inline1"><span class="kobospan" id="kobo.728.1">/rooms</span></strong><span class="kobospan" id="kobo.729.1"> to get the list of rooms that you are in, as you can see in the </span><span><span class="kobospan" id="kobo.730.1">following </span></span><span><a id="_idIndexMarker840" class="calibre6 pcalibre1 pcalibre"/></span><span><span class="kobospan" id="kobo.731.1">screenshot:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer129">
<span class="kobospan" id="kobo.732.1"><img alt="Figure 14.6 – Sending the /rooms command" src="image/B19385_14_6.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.733.1">Figure 14.6 – Sending the /rooms command</span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.734.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.735.1">Joining different rooms currently does not work due to the query parameter getting cleared after logging in. </span><span class="kobospan" id="kobo.735.2">In the next chapter, we are going to refactor the chat app and implement a </span><strong class="source-inline1"><span class="kobospan" id="kobo.736.1">/join</span></strong><span class="kobospan" id="kobo.737.1"> command to join a </span><span><span class="kobospan" id="kobo.738.1">different room.</span></span></p>
<h1 id="_idParaDest-272" class="calibre5"><a id="_idTextAnchor275" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.739.1">Summary</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.740.1">In this chapter, we implemented a frontend for our chat app backend. </span><span class="kobospan" id="kobo.740.2">We started by integrating the Socket.IO client with React by making a context and a custom hook for it. </span><span class="kobospan" id="kobo.740.3">Then, we used </span><strong class="source-inline"><span class="kobospan" id="kobo.741.1">AuthProvider</span></strong><span class="kobospan" id="kobo.742.1"> to get the token to authenticate a user when connecting to the socket. </span><span class="kobospan" id="kobo.742.2">After that, we displayed the status of our socket. </span><span class="kobospan" id="kobo.742.3">Then, we implemented a chat app interface to send and receive messages. </span><span class="kobospan" id="kobo.742.4">Finally, we implemented chat commands by using acknowledgments to get the rooms that we </span><span><span class="kobospan" id="kobo.743.1">are in.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.744.1">In the next chapter, </span><a href="B19385_15.xhtml#_idTextAnchor276" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.745.1">Chapter 15</span></em></span></a><span class="kobospan" id="kobo.746.1">, </span><em class="italic"><span class="kobospan" id="kobo.747.1">Adding Persistence to Socket.IO Using MongoDB</span></em><span class="kobospan" id="kobo.748.1">, we are going to learn how to store and replay previously sent messages using MongoDB </span><span><span class="kobospan" id="kobo.749.1">with Socket.IO.</span></span></p>
</div>
</body></html>