<html><head></head><body>
		<div id="_idContainer045">
			<h1 id="_idParaDest-115"><em class="italic"><a id="_idTextAnchor116"/>Chapter 8</em>: Web Analytics and Performance Monitoring</h1>
			<p>In this chapter, we will investigate ways in which we can monitor the behavior of our application and the users who visit it. We will learn how page analytics can be a valuable tool in helping create better user experiences. We will learn how to use two different tools to gather these page insights, depending on what we require. We will learn what is required of us legally when using these tools. We will also implement plugins that allow us to debug errors that our users encounter when using our site. </p>
			<p>By the end of this chapter, you should feel confident that you can gather different types of analytics and use them to inform yourself (or the site owner) about how code changes have affected the user experience.</p>
			<p>In this chapter, we will cover the following topics:</p>
			<ul>
				<li>Introducing website analytics</li>
				<li>Implementing page analytics</li>
				<li>Monitoring the performance of your site</li>
			</ul>
			<h1 id="_idParaDest-116"><a id="_idTextAnchor117"/>Technical requirements</h1>
			<p>To complete this chapter, you will need to have completed <a href="B15983_07_ePub_RK.xhtml#_idTextAnchor105"><em class="italic">Chapter 7</em></a>, <em class="italic">Testing and Auditing Your Site</em>. </p>
			<p>The code for this chapter can be found at <a href="https://github.com/PacktPublishing/Elevating-React-Web-Development-with-Gatsby-4/tree/main/Chapter08">https://github.com/PacktPublishing/Elevating-React-Web-Development-with-Gatsby-4/tree/main/Chapter08</a>.</p>
			<h1 id="_idParaDest-117"><a id="_idTextAnchor118"/>Introducing website analytics </h1>
			<p>Website analytics <a id="_idIndexMarker430"/>is the act of collecting, aggregating, analyzing, and reporting a website's data. Let's break website analytics down into two categories:</p>
			<ul>
				<li><strong class="bold">Page analytics</strong>: Analytics <a id="_idIndexMarker431"/>we gather about how users <a id="_idIndexMarker432"/>interact with our website. This could be page views, click rates, or bounce rates, for example.</li>
				<li><strong class="bold">Performance Monitoring</strong>: Analytics we gather on how our code performs for our users. This is <a id="_idIndexMarker433"/>primarily used for logging errors<a id="_idTextAnchor119"/> in <a id="_idIndexMarker434"/>our JavaScript that our users encounter.</li>
			</ul>
			<p>Regardless of the category, they all work in a similar way. First, an inserted <strong class="source-inline">script</strong> tag loads a small amount of JavaScript into the page. This code is run in the web browser of anyone visiting the site. In most cases, the code drops a small text file with small pieces of data known as cookies onto the users' browsers. This data is used to identify the user session. This is sent back to the analytics tool, along with request information, to identify the user and the event that is being tracked.</p>
			<p>You've collected all this data – now what? By looking at aggregated users' data, we can gain insights into how our users are behaving. This information is the most powerful ally you can have when you're trying to improve your user experience. You can use these reports to identify trends in the kind of content your users like or pages where users most often leave your application, for example.</p>
			<p>Now, let's take a moment to talk about privacy concerns when gathering user data.</p>
			<h2 id="_idParaDest-118"><a id="_idTextAnchor120"/>Privacy </h2>
			<p>Regardless of what data you intend on collecting, it is always important to consider the privacy of your <a id="_idIndexMarker435"/>users. A published and publicly accessible privacy policy is a legal requirement if you intend to store, transfer, or handle a user's personal information. It is also the case that the popular analytics providers, including <em class="italic">Google Analytics</em>, specify in their terms of service that if you are using their service, you must publish a privacy policy. If you do not, you are in breach of your contract with them and are using the tool illegally.</p>
			<p>In addition to a privacy policy, it is also a good idea to have a cookies policy, if your website has visitors from Europe. As of 2018, the European Union state that you are required to get "clear, informed consent" from your users to use cookies. This normally takes the form <a id="_idIndexMarker436"/>of a banner that you display to users on their first visit to your site.</p>
			<p>Now that we understand what website analytics is, let's turn our attention to how we can implement the first type of them – page analytics. </p>
			<h1 id="_idParaDest-119"><a id="_idTextAnchor121"/>Implementing page analytics</h1>
			<p>There is a <a id="_idIndexMarker437"/>multitude of tools you can use to perform page analytics. In this book, we are going to look at the following two:</p>
			<ul>
				<li>Google Analytics </li>
				<li>Fathom Analytics </li>
			</ul>
			<p><strong class="bold">Google Analytics</strong> is the world's <a id="_idIndexMarker438"/>leader in page analytics. More than half of all websites on the web use this tool. One of the reasons for its popularity is its age as it has been around since 2005. When it was launched, there wasn't much competition in the analytics space. Another reason for its popularity is that it's free. It's important to remember that if you are using a free tool or site, it is often the case that your data is the product. If you are concerned about your privacy and that of your site visitors, then perhaps Fathom Analytics is a better choice.</p>
			<p>Unlike Google, <strong class="bold">Fathom Analytics</strong> does not <a id="_idIndexMarker439"/>track personal data. For example, when a page view is logged, it only tells you it was visited, but not by who specifically. Fathom's script is cookie-free, which means that you do not need a cookie policy or cookie consent banner. As Fathom is determined to collect as little personal information as possible, your privacy policy can also be considerably shorter.</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">Only implement one of the page analytics tools mentioned in this section. Having multiple scripts that accomplish the same thing is only going to make your page heavier. </p>
			<p>We will discuss how to implement both page analytics tools in the following sections. Let's start with Google Analytics.</p>
			<h2 id="_idParaDest-120"><a id="_idTextAnchor122"/>Adding Google Analytics</h2>
			<p>To start <a id="_idIndexMarker440"/>tracking data within our Gatsby <a id="_idIndexMarker441"/>site, we will need to obtain a measurement ID from Google Analytics. Let's do this by following these steps:</p>
			<ol>
				<li>Navigate to <a href="https://analytics.google.com/analytics/web/?authuser=0#/provision/create">https://analytics.google.com/analytics/web/?authuser=0#/provision/create</a> from your browser.</li>
				<li>Give your account an <strong class="bold">Account name</strong> and enter your <strong class="bold">Account Data Sharing Settings</strong> preferences: <div id="_idContainer038" class="IMG---Figure"><img src="image/Figure_8.01_B15983.jpg" alt="Figure 8.1 – Google Analytics account setup&#13;&#10;"/></div><p class="figure-caption">Figure 8.1 – Google Analytics account setup</p><p>The name is specific to a project, so call it something relevant. Pay attention to the data sharing options – only ever share with Google what you're comfortable sharing. </p></li>
				<li>Set up a property by entering a <strong class="bold">Property name</strong>, <strong class="bold">Reporting time zone</strong> (region), and <strong class="bold">Currency</strong>:<div id="_idContainer039" class="IMG---Figure"><img src="image/Figure_8.02_B15983.jpg" alt="Figure 8.2 – Google Analytics property setup&#13;&#10;"/></div><p class="figure-caption">Figure 8.2 – Google Analytics property setup</p><p>This <a id="_idIndexMarker442"/>property is specific to your <a id="_idIndexMarker443"/>website or app. In our case, this will be used to reference analytics from our Gatsby site, so a name such as <strong class="bold">personal-website</strong> or <strong class="bold">my-website</strong> would be appropriate.</p></li>
				<li>Fill out the business information that Google requires and submit the form. You will then be presented with the following screen:<div id="_idContainer040" class="IMG---Figure"><img src="image/Figure_8.03_B15983.jpg" alt="Figure 8.3 – Google Analytics dashboard&#13;&#10;"/></div><p class="figure-caption">Figure 8.3 – Google Analytics dashboard</p><p>This is <a id="_idIndexMarker444"/>your first look at the Google <a id="_idIndexMarker445"/>Analytics dashboard. Before we can start leveraging its power, we will need to set up our first data stream.</p></li>
				<li>Select <strong class="bold">Web</strong> under the <strong class="bold">Choose a platform</strong> heading. This will open the following screen:<div id="_idContainer041" class="IMG---Figure"><img src="image/Figure_8.04_B15983.jpg" alt="Figure 8.4 – Google Analytics web stream setup&#13;&#10;"/></div><p class="figure-caption">Figure 8.4 – Google Analytics web stream setup</p><p>Enter your website address under <strong class="bold">URL</strong> and <strong class="bold">name</strong> your web stream. Finally, submit the form by clicking <strong class="bold">Create stream</strong>. This will bring up the details of our newly created stream.</p></li>
				<li>Make a note of the stream's measurement ID. </li>
			</ol>
			<p>Now that <a id="_idIndexMarker446"/>we have obtained the measurement ID, let's <a id="_idIndexMarker447"/>turn our attention to our Gatsby site repository and use it to start gathering site statistics:</p>
			<ol>
				<li value="1">Install the necessary dependencies:<p class="source-code">npm install gatsby-plugin-google-gtag</p></li>
				<li>Include the <strong class="source-inline">gatsby-plugin-google-gtag</strong> plugin in your <strong class="source-inline">gatsby-config.js</strong> file:<p class="source-code">{</p><p class="source-code">      resolve: `gatsby-plugin-google-gtag`,</p><p class="source-code">      options: {</p><p class="source-code">        trackingIds: [</p><p class="source-code">          "GA-TRACKING_ID", // Your Measurement ID </p><p class="source-code">        ],</p><p class="source-code">        gtagConfig: {</p><p class="source-code">          anonymize_ip: true</p><p class="source-code">        },</p><p class="source-code">      },</p><p class="source-code">    },</p><p>By including this plugin in your configuration, Gatsby will append the required Google Analytics script to the body of your application. The plugin comes with plenty <a id="_idIndexMarker448"/>of options, all of which can be found here: <a href="https://www.npmjs.com/package/gatsby-plugin-google-gtag">https://www.npmjs.com/package/gatsby-plugin-google-gtag</a>. </p><p>It's important <a id="_idIndexMarker449"/>to draw attention to the <strong class="source-inline">anonymize_ip</strong> gtag configuration option. Anonymizing the IP is a legal <a id="_idIndexMarker450"/>requirement in some countries, such as Germany. Without any additional configuration, the plugin will automatically send a page view event whenever your site's route changes. </p></li>
			</ol>
			<p>This is a great start, but you will most likely also want to track other events on your site. Let's look at how we can track custom events and outbound links.</p>
			<h3>Custom events</h3>
			<p>There are <a id="_idIndexMarker451"/>plenty more ways to track user engagement than just page views. Websites today are becoming more and more interactive, so being able to track interaction can be very useful. We can achieve this within Google Analytics by using custom events. Let's look at an example of using a button click.</p>
			<p>Let's assume we have a simple button component: </p>
			<p class="source-code">import React from "react"</p>
			<p class="source-code">const Button = () =&gt; {</p>
			<p class="source-code">    return (</p>
			<p class="source-code">        &lt;button&gt;Click Me&lt;/button&gt;</p>
			<p class="source-code">    )</p>
			<p class="source-code">}</p>
			<p class="source-code">export default Button</p>
			<p>To track <a id="_idIndexMarker452"/>a click of this button, we can utilize the <strong class="source-inline">gtag</strong> function, which is exposed in the window via the plugin:</p>
			<p class="source-code">import React from "react"</p>
			<p class="source-code">const Button = () =&gt; {</p>
			<p class="source-code">    const track = (e) =&gt; {</p>
			<p class="source-code">        typeof window !== "undefined" &amp;&amp;</p>
			<p class="source-code">         <strong class="bold">window.gtag("event", "click", { /* Meta Data */ })</strong></p>
			<p class="source-code">    }</p>
			<p class="source-code">    return (</p>
			<p class="source-code">        &lt;button onClick={track}&gt;Click Me&lt;/button&gt;</p>
			<p class="source-code">    )</p>
			<p class="source-code">}</p>
			<p class="source-code">export default Button</p>
			<p>In the previous code block, you can see that within <strong class="source-inline">onClick</strong>, we call a <strong class="source-inline">track</strong> function. This function calls the <strong class="source-inline">window.gtag</strong> function conditionally, if <strong class="source-inline">window</strong> is defined. We need to perform this check as the function does not work when it's rendered on the server side.</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">This plugin is for production use only. This means that any events that take place while you are working on the project in development will not be tracked. To test that the plugin is working correctly, you will need to build and serve the site.</p>
			<p>Now that <a id="_idIndexMarker453"/>we understand how custom events work, let's look at how we can track people leaving our site via outbound links.</p>
			<h3>Outbound links</h3>
			<p>It can be useful to understand where and when users navigate away from your site. Perhaps <a id="_idIndexMarker454"/>you reference another developer's site within a blog post and users leave to visit that site? To track this kind of outbound traffic, the <strong class="source-inline">gatsby-plugin-google-gtag</strong> plugin contains a ready-made component – <strong class="source-inline">OutboundLink</strong>. Let's see how we can use it:</p>
			<p class="source-code">import React from "react"</p>
			<p class="source-code">import { OutboundLink } from "gatsby-plugin-google-gtag"</p>
			<p class="source-code">const MyLink = () =&gt; {</p>
			<p class="source-code">    return (</p>
			<p class="source-code">        <strong class="bold">&lt;OutboundLink href="https://sld.codes"&gt;Visit</strong></p>
			<p class="source-code"><strong class="bold">         sld.codes.&lt;/OutboundLink&gt;</strong></p>
			<p class="source-code">    )</p>
			<p class="source-code">}</p>
			<p class="source-code">export default MyLink</p>
			<p>As you should be able to see in this example, we can use the <strong class="source-inline">OutboundLink</strong> component as a direct drop-in replacement for an <strong class="source-inline">a</strong> tag. As its name suggests, you should only use this component for outbound links. If the link is internal, you should be using Gatsby's <strong class="source-inline">Link</strong> component.</p>
			<p>Google Analytics is a great way to track your site's page analytics, but there is also a multitude of other tools you can use for this purpose. Let's look at an alternative – Fathom Analytics.</p>
			<h2 id="_idParaDest-121"><a id="_idTextAnchor123"/>Using Fathom Analytics</h2>
			<p>Fathom Analytics is marketed as a privacy-focused alternative to Google. Google Analytics <a id="_idIndexMarker455"/>collects an abundance of data when <a id="_idIndexMarker456"/>users browse your site, but Fathom suggests that the information that is acquired is too much. Fathom collects only what they need to create their one-page stats dashboard. Unlike Google, Fathom is not free and starts at $14 per month. To start tracking data within our Gatsby site, we will need to obtain a site ID from Fathom Analytics. Let's do this now by following these steps:</p>
			<ol>
				<li value="1">Navigate to <a href="https://usefathom.com">https://usefathom.com</a> from your browser and create an account. You will need to sign up with a credit card, but you will receive a 7-day free trial.</li>
				<li>Upon account creation, you should be prompted to create a new site:<div id="_idContainer042" class="IMG---Figure"><img src="image/Figure_8.05_B15983.jpg" alt="Figure 8.5 – Fathom dashboard&#13;&#10;"/></div><p class="figure-caption">Figure 8.5 – Fathom dashboard</p><p>Give your site an appropriate name. A name such as <strong class="bold">personal-website</strong> would be appropriate. Click <strong class="bold">Create site</strong>.</p></li>
				<li>Upon <a id="_idIndexMarker457"/>submission, you will be presented <a id="_idIndexMarker458"/>with your <strong class="bold">Site ID</strong> and embeddable code for a multitude of frameworks, including Gatsby:</li>
			</ol>
			<div>
				<div id="_idContainer043" class="IMG---Figure">
					<img src="image/Figure_8.06_B15983.jpg" alt="Figure 8.6 – Fathom embed code&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.6 – Fathom embed code</p>
			<p>I suggest that you <em class="italic">do not</em> follow the instructions they provide you with for Gatsby. Why? Because their instructions suggest modifying the component that Gatsby uses to server render <strong class="source-inline">head</strong> and other parts of the HTML outside of Gatsby. There is no guarantee that Gatsby will keep this file consistent between versions, so meddling with it might make upgrading it difficult later down the line. Instead, simply make a note of your <strong class="bold">Site ID</strong>. Then, minimize your browser.</p>
			<p>Now that we have retrieved our <strong class="bold">Site ID</strong>, let's turn our attention to our Gatsby site repository <a id="_idIndexMarker459"/>and start populating that Fathom <a id="_idIndexMarker460"/>dashboard with statistics:</p>
			<ol>
				<li value="1">Install the necessary dependencies:<p class="source-code">npm install gatsby-plugin-fathom</p></li>
				<li>Include the <strong class="source-inline">gatsby-plugin-fathom</strong> plugin in your <strong class="source-inline">gatsby-config.js</strong> file:<p class="source-code">{</p><p class="source-code">      resolve: 'gatsby-plugin-fathom',</p><p class="source-code">      options: {</p><p class="source-code">        siteId: 'FATHOM_SITE_ID'</p><p class="source-code">      }</p><p class="source-code"> }</p></li>
				<li>Replace <strong class="source-inline">FATHOM_SITE_ID</strong> with the <strong class="bold">Site ID</strong> property that you retrieved via Fathom's website.</li>
				<li>Build and serve your Gatsby site. <strong class="source-inline">gatsby-plugin-fathom</strong> is production-only, so we need to create and serve a production build to validate that it is working. </li>
				<li>Once your site has loaded, navigate to it. Once it has been rendered, return to Fathom and click <strong class="bold">Verify site code</strong>. It should inform you that fathom is all hooked up!</li>
			</ol>
			<p>Now, let's investigate how we can track more than page views.</p>
			<h3>Custom events (goals)</h3>
			<p>Like Google <a id="_idIndexMarker461"/>Analytics, Fathom also allow you to track custom events. Fathom refers to these events as "goals." To learn how we can track a goal, let's look at an example of using a button click.</p>
			<p>First, we need to create an event via Fathom:</p>
			<ol>
				<li value="1">Navigate to your Fathom analytics dashboard. Under the <strong class="bold">Events</strong> section, click <strong class="bold">Add event</strong>.</li>
				<li>Give your event a name and click <strong class="bold">Create event</strong>. Note your event code.</li>
			</ol>
			<p>Now that <a id="_idIndexMarker462"/>we have an event code, let's use it! Let's assume we have a simple button component: </p>
			<p class="source-code">import React from "react"</p>
			<p class="source-code">const Button = () =&gt; {</p>
			<p class="source-code">    return (</p>
			<p class="source-code">        &lt;button&gt;Click Me&lt;/button&gt;</p>
			<p class="source-code">    )</p>
			<p class="source-code">}</p>
			<p class="source-code">export default Button</p>
			<p>To track a click of this button, we can utilize the <strong class="source-inline">useGoal</strong> function, which is exposed via the plugin:</p>
			<p class="source-code">import React from "react"</p>
			<p class="source-code">import { useGoal } from "gatsby-plugin-fathom"</p>
			<p class="source-code">const Button = () =&gt; {</p>
			<p class="source-code">    const handleGoal = useGoal("YOUR_EVENT_CODE")</p>
			<p class="source-code">    return (</p>
			<p class="source-code">        &lt;button onClick={() =&gt; handleGoal(100)}&gt;Click</p>
			<p class="source-code">          Me&lt;/button&gt;</p>
			<p class="source-code">    )</p>
			<p class="source-code">}</p>
			<p class="source-code">export default Button</p>
			<p>The <strong class="source-inline">useGoal</strong> hook exposes a function with a single argument, which is the value of your goal. Perhaps this is the purchase button, and you would like to log your revenue on your <a id="_idIndexMarker463"/>dashboard. If your goal has no value, set this parameter to <strong class="source-inline">0</strong>. </p>
			<p>Now that we understand how to track page analytics, let's look at how we can monitor our application for errors in production through application monitoring.</p>
			<h1 id="_idParaDest-122"><a id="_idTextAnchor124"/>Monitoring the performance of your site</h1>
			<p>One of the hardest things to debug is user errors in production that you cannot seem to replicate on <a id="_idIndexMarker464"/>your machine. Without logs, this can be an impossible task. Luckily, some tools are dedicated to monitoring errors within your application and alert you when things do go wrong. One of the most popular tools out there for this purpose is Sentry.io.</p>
			<h2 id="_idParaDest-123"><a id="_idTextAnchor125"/>Using Sentry.io analytics</h2>
			<p>Sentry.io is a <a id="_idIndexMarker465"/>full-stack error tracking system that supports a variety of desktop, browser, and <a id="_idIndexMarker466"/>server applications – including GatsbyJS! Sentry works by integrating with our site's logging infrastructure <a id="_idIndexMarker467"/>directly. Let's learn <a id="_idIndexMarker468"/>how we can implement Sentry so that we can monitor it for production errors:</p>
			<ol>
				<li value="1">Navigate to <a href="https://sentry.io/signup/">https://sentry.io/signup/</a> from your browser and create an account.</li>
				<li>Once you've logged in, create a new project by navigating to <strong class="bold">Projects</strong> and clicking <strong class="bold">Create Project</strong>.</li>
				<li>Fill in the new project user interface, like so:</li>
			</ol>
			<div>
				<div id="_idContainer044" class="IMG---Figure">
					<img src="image/Figure_8.07_B15983.jpg" alt="Figure 8.7 – Sentry initialization&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.7 – Sentry initialization</p>
			<p>Choose Gatsby <a id="_idIndexMarker469"/>as your platform. As your site is presumably going to be small at launch, I would suggest setting your default alert settings to <strong class="bold">Alert me on every new issue</strong>. Finally, give your project a name. Then, click <strong class="bold">Create Project</strong>.</p>
			<p>Sentry, then, gives <a id="_idIndexMarker470"/>you a great step-by-step guide on how to set up Sentry within your Gatsby project. Let's reiterate these steps here:</p>
			<ol>
				<li value="1">Install the necessary dependencies:<p class="source-code">npm install --save @sentry/gatsby</p></li>
				<li>Include <a id="_idIndexMarker471"/>the <strong class="source-inline">@sentry/gatsby</strong> plugin in your <strong class="source-inline">gatsby-config.js</strong> file:<p class="source-code">{</p><p class="source-code">      resolve: "@sentry/gatsby",</p><p class="source-code">      options: {</p><p class="source-code">        dsn: "YOUR_DSN_NUMBER",</p><p class="source-code">        sampleRate: 0.7</p><p class="source-code">      },</p><p class="source-code">},</p><p><strong class="source-inline">sampleRate</strong> is the rate of error events that are sent. Sentry suggests <strong class="source-inline">0.7</strong> as the default value, which means that 70% of error events will be sent. </p><p>A complete <a id="_idIndexMarker472"/>list of plugin options can be found here: <a href="https://docs.sentry.io/platforms/javascript/guides/gatsby/configuration/options/">https://docs.sentry.io/platforms/javascript/guides/gatsby/configuration/options/</a>.</p></li>
			</ol>
			<p>These few lines of code are all that is needed to have Sentry start tracking errors and the performance of your site in production. You can rest easy knowing that if your site visitors encounter errors, you will know about them instantly.</p>
			<h1 id="_idParaDest-124"><a id="_idTextAnchor126"/>Summary</h1>
			<p>In this chapter, we learned about website analytics and how useful they can be to make our application perform at its best. We learned about the different types of data we can collect and the regulations we should follow when collecting a user's data. We implemented page analytics in two different ways – one by providing you with an abundance of data and the other by taking a more privacy-focused stance. Finally, we also implemented application monitoring using Sentry.io. You should now feel confident collecting website analytics.</p>
			<p>In the next chapter, we will finally bring together everything we have learned in the last eight chapters and deploy our website.</p>
		</div>
	</body></html>