<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Connecting Chat Components with Firebase Database</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we will integrate our chat components with the new messaging service. We will discuss a new method to pass our data to our chat module using route parameters. Once a friend's UID is passed from the user friend list component, then we will pass this friend's UID to a different chat component, as this data is required in the message list and message form components. We will also design a database for our chat application, as a proper design avoids data duplication. Once the database is ready, we will query the data from the message service and integrate the message service with the chat components.</p>
<p class="calibre2">In this chapter, we will cover the following topics:</p>
<ul class="calibre7">
<li class="calibre8">Passing data using route parameters</li>
<li class="calibre8">Passing friend data to different chat components</li>
<li class="calibre8">Designing a Firebase database for chat</li>
<li class="calibre8">Creating the messaging service</li>
<li class="calibre8">Integrating service to chat components</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Passing data using route parameters</h1>
                
            
            <article>
                
<p class="calibre2">When a user clicks on the <span>Chat</span> button, we pass the friend UID to the chat component using route parameters.</p>
<p class="calibre2">In the <a href="part0079.html#2BASE0-bb7c6bfbc452460584038b7864f000f7" class="calibre10">Chapter 5</a>, <em class="calibre16">Creating a User Profile Page</em>, we passed the user data using <kbd class="calibre11">BehaviorSubject</kbd> in the RxJS library. In this section, we will use the route parameter of the router link to pass the friend's UID. We perform the following three steps to pass the data using route parameters:</p>
<ol class="calibre13">
<li value="1" class="calibre8">Adding a route parameter ID</li>
<li value="2" class="calibre8">Linking a route to the parameter</li>
<li value="3" class="calibre8">Reading the parameter</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Adding a route parameter ID</h1>
                
            
            <article>
                
<p class="calibre2">In the first step mentioned in the preceding list, we need to add the friend's UID parameter to the route link. We add an ID parameter to the path element as shown here:</p>
<pre class="calibre17"><span>export const </span><span>ROUTES</span>: Routes = [<br class="title-page-name"/>    { <span>path</span>: <span>'app-friends-chat/:id'</span>, <span>component</span>: ChatComponent }<br class="title-page-name"/>];</pre>
<p class="calibre2">When a user clicks on the <span>Chat</span> button, this ID is added to URL as <kbd class="calibre11">http://localhost:4200/friends-chat/8wcVXYmEDQdqbaJ12BPmpsCmBMB2</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Linking a route to the parameter</h1>
                
            
            <article>
                
<p class="calibre2"><span>In the second step mentioned in the preceding list,</span> we need to link the friend's UID to the router link. The following are the two methods to achieve it:</p>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Router link directive</strong>: We can directly link the parameter ID using the <kbd class="calibre11">routerLink</kbd> <span>directive, as follows:</span></li>
</ul>
<pre class="calibre18"><span>&lt;</span><span>div </span><span>*ngFor=</span><span>"let </span><span>friend</span><span> of </span><span>friends</span><span>" </span><span>class=</span><span>"card" </span><span>[routerLink]=</span><span>"['/app-friends-chat' , </span><span>friend</span><span>.</span><span>getUid</span><span>()]"</span><span>&gt;&lt;/div&gt;</span></pre>
<ul class="calibre7">
<li class="calibre8"><span><strong class="calibre1">Programmatically using router</strong>: When a user clicks on the <span>Chat</span> button, we pass the UID to the method parameter and use a router to pass the data.</span></li>
</ul>
<p class="calibre2">We add a <span>Chat</span> button to the friends list of our user. We modify the template of our <span>user's friends, </span>as follows:</p>
<pre class="calibre17"><span>&lt;</span><span>div </span><span>*ngFor=</span><span>"let </span><span>friend</span><span> of </span><span>friends</span><span>" </span><span>class=</span><span>"card"</span><span>&gt;</span><br class="title-page-name"/>    ...<br class="title-page-name"/>        <span>&lt;</span><span>button </span><span>(click)=</span><span>"</span><span>onChat</span><span>(</span><span>friend</span><span>.</span><span>uid</span><span>)" </span><span>class=</span><span>"btn btn-outline-<br class="title-page-name"/>         success my-2 my-sm-0" </span><span>type=</span><span>"submit"</span><span>&gt;</span>Chat<span>&lt;/</span><span>button</span><span>&gt;</span><br class="title-page-name"/>    <span>&lt;/</span><span>div</span><span>&gt;</span><br class="title-page-name"/>    ...<br class="title-page-name"/><span>&lt;/</span><span>div</span><span>&gt;</span></pre>
<p class="calibre2">When a user clicks on the <span>Chat</span> button, the <kbd class="calibre11">onChat()</kbd> method is called with a UID as its parameter. Finally, we call the <kbd class="calibre11">router</kbd> method to pass the <kbd class="calibre11">id</kbd> as the route parameter:</p>
<pre class="calibre17"><span>onChat</span>(id: <span>string</span>): <span>void </span>{<br class="title-page-name"/>    <span>this</span>.router.<span>navigate</span>([<span>'/app-friends-chat' </span>, id]);<br class="title-page-name"/>}</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Reading the parameter</h1>
                
            
            <article>
                
<p class="calibre2">We use <kbd class="calibre11">ActivatedRoute</kbd> to read the parameter ID. This component provides a collection of parameters to read the ID. We subscribe to route parameters and store the subscription object in member variables and <span>unsubscribe</span> it in the Angular life cycle <kbd class="calibre11">ngOnDestroy()</kbd> method. </p>
<div class="packt_infobox"><kbd class="calibre21">OnDestroy</kbd> is an Angular life cycle hook interface. It has the <kbd class="calibre21">ngOnDestroy()</kbd> method and is called for cleanup logic when the components are destroyed. </div>
<p class="calibre2"><span>The following is the complete <kbd class="calibre11">chat.component.ts</kbd> file </span><span>as of now:</span></p>
<pre class="calibre17"><span>import </span>{Component} <span>from </span><span>'@angular/core'</span>;<br class="title-page-name"/><span>import </span>{ActivatedRoute} <span>from </span><span>'@angular/router'</span>;<br class="title-page-name"/><br class="title-page-name"/>@<span>Component</span>({<br class="title-page-name"/>    <span>selector</span>: <span>'friends-chat'</span>,<br class="title-page-name"/>    <span>styleUrls</span>: [<span>'chat.component.scss'</span>],<br class="title-page-name"/>    <span>templateUrl</span>: <span>'chat.component.html'</span>,<br class="title-page-name"/>})<br class="title-page-name"/><span>export class </span>ChatComponent {<br class="title-page-name"/><br class="title-page-name"/>    <span>uid</span>: <span>string</span>;<br class="title-page-name"/><br class="title-page-name"/>    <span>private </span><span>sub</span>: <span>any</span>;<br class="title-page-name"/><br class="title-page-name"/>    <span>constructor</span>(<span>private </span>route: ActivatedRoute) {<br class="title-page-name"/><br class="title-page-name"/>    }<br class="title-page-name"/><br class="title-page-name"/>    <span>ngOnInit</span>() {<br class="title-page-name"/>        <span>this</span>.<span>sub </span>= <span>this</span>.route.<span>params</span>.<span>subscribe</span>(params =&gt; {<br class="title-page-name"/>            <span>this</span>.<span>uid </span>= params[<span>'id'</span>];<br class="title-page-name"/>        });<br class="title-page-name"/>    }<br class="title-page-name"/><br class="title-page-name"/>    <span>ngOnDestroy</span>() {<br class="title-page-name"/>        <span>this</span>.<span>sub</span>.<span>unsubscribe</span>();<br class="title-page-name"/>    }<br class="title-page-name"/>}</pre>
<p class="calibre2"/>
<p class="calibre2">We will cover how to pass UID data to other chat components in the next section. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Passing friend data to different chat components</h1>
                
            
            <article>
                
<p class="calibre2">Once we have the friend's UID in our chat module, we can pass the friend's UID to our message list and the message form component using Angular data binding. We perform the following two steps to pass the data to two chat components:</p>
<ol class="calibre13">
<li value="1" class="calibre8"><strong class="calibre1">Declaring the input variables</strong>: We declare the input variables using the Angular <kbd class="calibre11">@Input</kbd> annotation i<span>n the two chat components</span>. The following snippet shows the changes for the message list and message form components.</li>
</ol>
<p class="mce-root">The following snippet shows changes for <kbd class="calibre11">chat-message-list.component.ts</kbd>:</p>
<pre class="calibre18"><span>export class </span>ChatMessageListComponent <span>implements </span>OnInit , AfterViewChecked{<br class="title-page-name"/>    @<span>Input</span>() <span>friendUid</span>: <span>string</span>;<br class="title-page-name"/><br class="title-page-name"/>}</pre>
<p class="mce-root"><span>The following snippet shows c</span>hanges for <kbd class="calibre11">chat-message-form.component.ts</kbd> file:</p>
<pre class="calibre18"><span>export class </span>ChatMessageFormComponent <span>implements </span>OnInit {<br class="title-page-name"/>  @<span>Input</span>() <span>friendUid</span>: <span>string</span>;</pre>
<ol start="2" class="calibre13">
<li value="2" class="calibre8"><strong class="calibre1">Binding the data to input</strong>: We can bind the input variable <kbd class="calibre11">friendUid</kbd> with <kbd class="calibre11">uid</kbd>, which was passed from the user module:</li>
</ol>
<pre class="calibre18"><span>&lt;</span><span>div </span><span>class=</span><span>"col-md-8 col-md-offset-2"</span><span>&gt;</span><br class="title-page-name"/>    <span>&lt;app-</span><span>chat-message-list </span><span>[friendUid]=</span><span>"</span><span>uid</span><span>"</span><span>&gt;<br class="title-page-name"/>    &lt;/app-</span><span>chat-message-list</span><span>&gt;</span><br class="title-page-name"/>    <span>&lt;app-</span><span>chat-message-form </span><span>[friendUid]=</span><span>"</span><span>uid</span><span>"</span><span>&gt;<br class="title-page-name"/>    &lt;/app-</span><span>chat-message-form</span><span>&gt;</span><br class="title-page-name"/><span>&lt;/</span><span>div</span><span>&gt;</span></pre>
<p class="calibre2">We will use this friend's UID to read or update the Firebase database. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Designing a Firebase database for chat</h1>
                
            
            <article>
                
<p class="calibre2">Designing the Firebase database is the most crucial part in writing the chat feature.</p>
<p class="calibre2">Chat involves communication between two persons. It has a sender and receiver, and both can see the same text messages. We have to associate two users with the same messages, and this involves mainly two steps:</p>
<ol class="calibre13">
<li value="1" class="calibre8"><strong class="calibre1">Creating a new chat ID</strong>: The first step is to associate the unique message ID for both persons. We create a unique message ID and associate the two users using their UID. As shown in the following screenshot, we associate the <span><span>"-KvMW57CNfA40GJNDF-F"</span> key with both UIDs.</span></li>
</ol>
<div class="cdpaligncenter"><img src="../images/00031.gif" class="calibre55"/></div>
<p class="mce-root">When the user clicks on the <span>Chat</span> button in their friend's page, we will check for the key and freshly create the ID, as follows:</p>
<pre class="calibre18"><span>const </span><span>key </span>= <span>this</span>.fireDb.<span>createPushId</span>();</pre>
<p class="mce-root"><kbd class="calibre11">AngularFireDatabase</kbd> has a <kbd class="calibre11">createPushId()</kbd> method to create the unique ID.</p>
<p class="mce-root">Here is the sample code from <kbd class="calibre11">messaging.service.ts</kbd>:</p>
<pre class="calibre18"><span>freshlyCreateChatIDEntry</span>(uid: <span>string</span>, friendUid: <span>string</span>): <span>string </span>{<br class="title-page-name"/>  <span>const </span><span>key </span>= <span>this</span>.fireDb.<span>createPushId</span>();<br class="title-page-name"/>  <span>this</span>.fireDb.<span>object</span>(<span>`</span>${<span>USER_DETAILS_CHILD</span>}<span>/</span>${<span>CHAT_MESSAGES_CHILD</span>}<span>/</span>${uid}<span>/</span>${friendUid}<span>`</span>).<span>set</span>({<span>key</span>: <span>key</span>});<br class="title-page-name"/>  <span>this</span>.fireDb.<span>object</span>(<span>`</span>${<span>USER_DETAILS_CHILD</span>}<span>/</span>${<span>CHAT_MESSAGES_CHILD</span>}<span>/</span>${friendUid}<span>/</span>${uid}<span>`</span>).<span>set</span>({<span>key</span>: <span>key</span>});<br class="title-page-name"/>  <span>return </span><span>key</span>;<br class="title-page-name"/>}</pre>
<ol start="2" class="calibre13">
<li value="2" class="calibre8"><strong class="calibre1">Associating messages with the key</strong>: Once we create the key for the users, we create the new node in our Firebase database, associate this key as a node, and push the messages in this node so that both the users have access. In the database schema, we will create receiver and sender nodes with UIDs so that we know who has sent the message and align the messages in the chat window based on this condition</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00032.gif" class="calibre56"/></div>
<p class="mce-root">We store the key in the member variable of the service so that we use this key to push a new message to our Firebase database.</p>
<p class="mce-root">The following is the sample code from <kbd class="calibre11">messaging.service.ts</kbd>:</p>
<pre class="calibre18"><span>createNewMessage</span>(newMessage: Message) {<br class="title-page-name"/>  <span>const </span><span>messageKey </span>= <span>this</span>.fireDb.<span>createPushId</span>();<br class="title-page-name"/>  <span>this</span>.fireDb.<span>object</span>(<span>`</span>${<span>MESSAGE_DETAILS_CHILD</span>}<span>/</span>${<span>this</span>.<span>key</span>}<span>/<br class="title-page-name"/></span>  ${<span>messageKey</span>}<span>`</span>).<span>set</span>(newMessage).<span>catch</span>(error =&gt; {<br class="title-page-name"/>    <span>console</span>.<span>log</span>(error);<br class="title-page-name"/>  });<br class="title-page-name"/>}</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Creating a messaging service</h1>
                
            
            <article>
                
<p class="calibre2">The first step in creating the messaging service is to define a data model. We create a message model with properties; the message model consists of the following four properties:</p>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Message</strong>: This contains the message in a string type. </li>
<li class="calibre8"><strong class="calibre1">Sender UID</strong>: The sender UID is used to know the identity of the sender of the particular message and write logic to display the text message on the left panel of the chat window.</li>
<li class="calibre8"><strong class="calibre1">Receiver UID</strong>: The receiver UID is used to know the <span>identity of </span>the receiver of the particular message and write logic to display the text message on the right panel of the chat window.</li>
<li class="calibre8"><strong class="calibre1">Timestamp</strong>: This property is used to display the date and time of the message sent.</li>
</ul>
<p class="calibre2"><span>Here's the <kbd class="calibre11">message.ts</kbd> </span><span>as of now:</span></p>
<pre class="calibre17"><span>export class </span>Message {<br class="title-page-name"/><br class="title-page-name"/>   <span>message</span>: <span>string</span>;<br class="title-page-name"/><br class="title-page-name"/>   <span>senderUid</span>: <span>string</span>;<br class="title-page-name"/><br class="title-page-name"/>   <span>receiverUid</span>: <span>string</span>;<br class="title-page-name"/><br class="title-page-name"/>   <span>timestamp</span>: <span>number</span>;<br class="title-page-name"/><br class="title-page-name"/>   <span>constructor</span>(message: <span>string</span>,<br class="title-page-name"/>            senderUid: <span>string</span>,<br class="title-page-name"/>            receiverUid: <span>string</span>,<br class="title-page-name"/>            timestamp: <span>number</span>) {<br class="title-page-name"/>      <span>this</span>.<span>message </span>= message;<br class="title-page-name"/>      <span>this</span>.<span>senderUid </span>= senderUid;<br class="title-page-name"/>      <span>this</span>.<span>receiverUid </span>= receiverUid;<br class="title-page-name"/>      <span>this</span>.<span>timestamp </span>= timestamp;<br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>}</pre>
<p class="calibre2">As a part of the chat feature, we declare a constant to know the node of the Firebase database, as shown in the next code.</p>
<p class="calibre2"><span>Here's the <kbd class="calibre11">database-constants.ts</kbd> file </span><span>as of now:</span></p>
<pre class="calibre17"><span>export const </span><span>USER_DETAILS_CHILD </span>= <span>'user-details'</span>;<br class="title-page-name"/><span>export const </span><span>CHAT_MESSAGES_CHILD </span>= <span>"chat_messages"</span>;<br class="title-page-name"/><span>export const </span><span>MESSAGE_DETAILS_CHILD </span>= <span>"message_details"</span>;</pre>
<p class="calibre2">The core part of our messaging feature is the service. This service is responsible for creating the chat ID, pushing the new message, and getting messages. As part of this application, we have introduced the following four APIs:</p>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1"><kbd class="calibre11">isMessagePresent()</kbd></strong>: When a user clicks on the <span>Chat</span> button, we check whether a message key is present and store the key in the member variable in this service. We use this key to push any new messages in the Firebase database.</li>
<li class="calibre8"> <kbd class="calibre11">freshlyCreateChatIdEntry()</kbd>: We call this API when the user starts a fresh communication with a friend. Then, we create the key and store it in the Firebase database. </li>
<li class="calibre8"><kbd class="calibre11">getMessages()</kbd>: This API is used to subscribe to all the messages in the conversation, and we also get updates when a new message is received. </li>
<li class="calibre8"><kbd class="calibre11">createNewMessage()</kbd>: When the user clicks on the <span>SEND</span> button, we call this API to store the new message in the Firebase database. The new message consists of message text, sender UID, receiver UID, and timestamp. </li>
</ul>
<p class="calibre2"><span>Here's the <kbd class="calibre11">messaging.service.ts</kbd> file </span><span>as of now:</span></p>
<pre class="calibre17"><span>import </span>{Injectable} <span>from </span><span>'@angular/core'</span>;<br class="title-page-name"/><span>import </span>{AngularFireDatabase} <span>from </span><span>'angularfire2/database'</span>;<br class="title-page-name"/><span>import </span>{<span>CHAT_MESSAGES_CHILD</span>, <span>MESSAGE_DETAILS_CHILD</span>, <span>USER_DETAILS_CHILD</span>} <span>from </span><span>'./database-constants'</span>;<br class="title-page-name"/><span>import </span>{FirebaseApp} <span>from </span><span>'angularfire2'</span>;<br class="title-page-name"/><span>import </span><span>'firebase/storage'</span>;<br class="title-page-name"/><span>import </span>{Observable} <span>from </span><span>'rxjs/Observable'</span>;<br class="title-page-name"/><span>import </span>{Message} <span>from </span><span>'./message'</span>;<br class="title-page-name"/><br class="title-page-name"/><span>/**<br class="title-page-name"/></span><span> * Messaging service<br class="title-page-name"/></span><span> *<br class="title-page-name"/></span><span> */<br class="title-page-name"/></span>@<span>Injectable</span>()<br class="title-page-name"/><span>export class </span>MessagingService {<br class="title-page-name"/><br class="title-page-name"/>  <span>key</span>: <span>string</span>;<br class="title-page-name"/><br class="title-page-name"/>  <span>/**<br class="title-page-name"/></span><span>   * Constructor<br class="title-page-name"/></span><span>   *<br class="title-page-name"/></span><span>   * </span><span>@param </span><span>{AngularFireDatabase} fireDb provides the functionality <br class="title-page-name"/>     related to authentication<br class="title-page-name"/></span><span>   */<br class="title-page-name"/></span><span>  </span><span>constructor</span>(<span>private </span>fireDb: AngularFireDatabase) {<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  <span>isMessagePresent</span>(uid: <span>string</span>, friendUid: <span>string</span>): Observable&lt;<span>any</span>&gt; {<br class="title-page-name"/>    <span>return  <br class="title-page-name"/>    this</span>.fireDb.<span>object</span>(<span>`</span>${<span>USER_DETAILS_CHILD</span>}<span>/</span>${<span>CHAT_MESSAGES_CHILD</span>}<span>/<br class="title-page-name"/></span>    ${uid}<span>/</span>${friendUid}<span>`</span>).<span>valueChanges</span>();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  <span>createNewMessage</span>(newMessage: Message) {<br class="title-page-name"/>    <span>const </span><span>messageKey </span>= <span>this</span>.fireDb.<span>createPushId</span>();<br class="title-page-name"/>    <span>this</span>.fireDb.<span>object</span>(<span>`</span>${<span>MESSAGE_DETAILS_CHILD</span>}<span>/</span>${<span>this</span>.<span>key</span>}<span>/<br class="title-page-name"/></span>    ${<span>messageKey</span>}<span>`</span>).<span>set</span>(newMessage).<span>catch</span>(error =&gt; {<br class="title-page-name"/>      <span>console</span>.<span>log</span>(error);<br class="title-page-name"/>    });<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  <span>freshlyCreateChatIDEntry</span>(uid: <span>string</span>, friendUid: <span>string</span>): <span>string </span>{<br class="title-page-name"/>    <span>const </span><span>key </span>= <span>this</span>.fireDb.<span>createPushId</span>();<br class="title-page-name"/>    <span>this</span>.fireDb.<span>object</span>(<span>`</span>${<span>USER_DETAILS_CHILD</span>}<span>/<br class="title-page-name"/></span>    ${<span>CHAT_MESSAGES_CHILD</span>}<span>/</span>${uid}<span>/</span>${friendUid}<span>`</span>).<span>set</span>({<span>key</span>: <span>key</span>});<br class="title-page-name"/>    <span>this</span>.fireDb.<span>object</span>(<span>`</span>${<span>USER_DETAILS_CHILD</span>}<span>/<br class="title-page-name"/></span>    ${<span>CHAT_MESSAGES_CHILD</span>}<span>/</span>${friendUid}<span>/</span>${uid}<span>`</span>).<span>set</span>({<span>key</span>: <span>key</span>});<br class="title-page-name"/>    <span>return </span><span>key</span>;<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  <span>getMessages</span>(key: <span>string</span>): Observable&lt;Message[]&gt; {<br class="title-page-name"/>    <span>return this</span>.fireDb.<span>list</span>&lt;Message&gt; <br class="title-page-name"/>    (<span>`</span>${<span>MESSAGE_DETAILS_CHILD</span>}<span>/</span>${key}<span>`</span>).<span>valueChanges</span>();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  <span>setKey</span>(key: <span>string</span>) {<br class="title-page-name"/>    <span>this</span>.<span>key </span>= key;<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">In the next section, we will integrate this service to our chat components.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Integrating our service to chat components</h1>
                
            
            <article>
                
<p class="calibre2">Finally, we will integrate the messaging service to the components. We will cover the following three use cases:</p>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Checking the message key for a new chat</strong>: When the user initiates a conversation with their friend, we call the <kbd class="calibre11">isMessagePresent()</kbd> API of the messaging service. For a fresh conversation, this chat key will not be present, and we need to create the new key and use the same key for subsequent communication:</li>
</ul>
<pre class="calibre18"><span>ngOnInit</span>() {<br class="title-page-name"/>    <span>this</span>.<span>user </span>= <span>this</span>.userService.<span>getSavedUser</span>().<span>getValue</span>();<br class="title-page-name"/>    <span>this</span>.messageService.<span>isMessagePresent</span>(<span>this</span>.<span>user</span>.<span>getUid</span>(),  <br class="title-page-name"/><span>    this</span>.<span>friendUid</span>).<span>subscribe</span>(snapshot =&gt; {<br class="title-page-name"/>        <span>let </span><span>snapshotValue </span>= snapshot.<span>val</span>();<br class="title-page-name"/>        <span>let </span><span>friend</span>: Friend;<br class="title-page-name"/>        <span>if </span>(<span>snapshotValue </span>== <span>null</span>) {<br class="title-page-name"/>            <span>console</span>.<span>log</span>(<span>"Message is empty"</span>);<br class="title-page-name"/>            <span>this</span>.<span>key </span>= <br class="title-page-name"/><span>            this</span>.messageService.<span>freshlyCreateChatIDEntry<br class="title-page-name"/></span>            (<span>this</span>.<span>user</span>.<span>getUid</span>(), <span>this</span>.<span>friendUid</span>);<br class="title-page-name"/>        } <span>else </span>{<br class="title-page-name"/>            <span>this</span>.<span>key </span>= <span>snapshotValue</span>.<span>key</span>;<br class="title-page-name"/>        }<br class="title-page-name"/>        <span>this</span>.messageService.<span>setKey</span>(<span>this</span>.<span>key</span>);<br class="title-page-name"/>        <span>this</span>.<span>subscribeMessages</span>();<br class="title-page-name"/>    });<br class="title-page-name"/>}</pre>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Subscribing to the message list</strong>: We will call the <kbd class="calibre11">getMessages()</kbd> method to get a message list observable. We will then subscribe to this observable to get a message list and then assign it to <kbd class="calibre11">messages</kbd> member variables:</li>
</ul>
<pre class="calibre18"><span>subscribeMessages</span>() {<br class="title-page-name"/>    <span>this</span>.messageService.<span>getMessages</span>(<span>this</span>.<span>key</span>)<br class="title-page-name"/>        .<span>subscribe</span>(<br class="title-page-name"/>            messages =&gt; {<br class="title-page-name"/>                <span>this</span>.<span>messages </span>= messages;<br class="title-page-name"/>            });<br class="title-page-name"/><br class="title-page-name"/>}</pre>
<p class="mce-root"><span>Here's the <kbd class="calibre11">chat-message-list.component.ts</kbd> file </span><span>as of now:</span></p>
<pre class="calibre18"><span>import </span>{AfterViewChecked, ChangeDetectorRef, Component, ElementRef, Input, OnInit, ViewChild} <span>from </span><span>'@angular/core'</span>;<br class="title-page-name"/><span>import </span>{MessagingService} <span>from </span><span>'../../services/messaging.service'</span>;<br class="title-page-name"/><span>import </span>{Message} <span>from </span><span>'../../services/message'</span>;<br class="title-page-name"/><span>import </span>{UserService} <span>from </span><span>'../../services/user.service'</span>;<br class="title-page-name"/><span>import </span>{User} <span>from </span><span>'../../services/user'</span>;<br class="title-page-name"/><br class="title-page-name"/>@<span>Component</span>({<br class="title-page-name"/>   <span>selector</span>: <span>'app-chat-message-list'</span>,<br class="title-page-name"/>   <span>styleUrls</span>: [<span>'chat-message-list.component.scss'</span>],<br class="title-page-name"/>   <span>templateUrl</span>: <span>'chat-message-list.component.html'<br class="title-page-name"/></span>})<br class="title-page-name"/><span>export class </span>ChatMessageListComponent <span>implements </span>OnInit, AfterViewChecked {<br class="title-page-name"/>   @<span>Input</span>() <span>friendUid</span>: <span>string</span>;<br class="title-page-name"/>   <span>private </span><span>user</span>: User;<br class="title-page-name"/>   <span>messages</span>: Message[];<br class="title-page-name"/>   <span>key</span>: <span>string</span>;<br class="title-page-name"/>   @<span>ViewChild</span>(<span>'scrollContainer'</span>) <span>private </span><span>scrollContainer</span>: <br class="title-page-name"/>   ElementRef;<br class="title-page-name"/><br class="title-page-name"/>   <span>constructor</span>(<span>private </span>messageService: MessagingService,<br class="title-page-name"/>            <span>private </span>userService: UserService,<br class="title-page-name"/>            <span>private </span>cdRef: ChangeDetectorRef) {<br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>   <span>ngOnInit</span>() {<br class="title-page-name"/>      <span>this</span>.<span>user </span>= <span>this</span>.userService.<span>getSavedUser</span>().<span>getValue</span>();<br class="title-page-name"/>      <span>this</span>.messageService.<span>isMessagePresent</span>(<span>this</span>.<span>user</span>.<span>uid </span>, <br class="title-page-name"/><span>      this</span>.<span>friendUid</span>).<span>subscribe</span>(snapshot =&gt; {<br class="title-page-name"/>         <span>if </span>(snapshot == <span>null</span>) {<br class="title-page-name"/>            <span>console</span>.<span>log</span>(<span>'Message is empty'</span>);<br class="title-page-name"/>            <span>this</span>.<span>key </span>= <br class="title-page-name"/><span>            this</span>.messageService.<span>freshlyCreateChatIDEntry<br class="title-page-name"/></span>            (<span>this</span>.<span>user</span>.<span>uid</span>, <span>this</span>.<span>friendUid</span>);<br class="title-page-name"/>         } <span>else </span>{<br class="title-page-name"/>            <span>this</span>.<span>key </span>= snapshot.<span>key</span>;<br class="title-page-name"/>         }<br class="title-page-name"/>         <span>this</span>.messageService.<span>setKey</span>(<span>this</span>.<span>key</span>);<br class="title-page-name"/>         <span>this</span>.<span>subscribeMessages</span>();<br class="title-page-name"/>      });<br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>   <span>ngAfterViewChecked</span>() {<br class="title-page-name"/>      <span>this</span>.<span>scrollToBottom</span>();<br class="title-page-name"/>      <span>this</span>.cdRef.<span>detectChanges</span>();<br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>   <span>scrollToBottom</span>(): <span>void </span>{<br class="title-page-name"/>      <span>try </span>{<br class="title-page-name"/>         <span>this</span>.<span>scrollContainer</span>.<span>nativeElement</span>.<span>scrollTop </span>= <br class="title-page-name"/><span>         this</span>.<span>scrollContainer</span>.<span>nativeElement</span>.<span>scrollHeight</span>;<br class="title-page-name"/>      } <span>catch </span>(err) {<br class="title-page-name"/>         <span>console</span>.<span>log</span>(<span>'Error'</span>);<br class="title-page-name"/>      }<br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>   <span>subscribeMessages</span>() {<br class="title-page-name"/>      <span>this</span>.messageService.<span>getMessages</span>(<span>this</span>.<span>key</span>)<br class="title-page-name"/>         .<span>subscribe</span>(<br class="title-page-name"/>            messages =&gt; {<br class="title-page-name"/>               <span>this</span>.<span>messages </span>= messages;<br class="title-page-name"/>            });<br class="title-page-name"/><br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>}</pre>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Sending messages to Firebase database</strong>: When a user types the message and clicks on the <span>SEND</span> button, we create the new message object and call the <kbd class="calibre11">createNewMessage()</kbd> method in the messaging service and this takes care of sending message to Firebase database. </li>
</ul>
<pre class="calibre18"><span>sendMessage</span>() {<br class="title-page-name"/>   <span>const </span><span>message</span>: Message = <span>new </span>Message(<span>this</span>.<span>newMessage</span>, <br class="title-page-name"/><span>   this</span>.<span>uid</span>, <span>this</span>.<span>friendUid</span>, <span>Date</span>.<span>now</span>());<br class="title-page-name"/>   <span>this</span>.messageService.<span>createNewMessage</span>(<span>message</span>);<br class="title-page-name"/>}</pre>
<p class="calibre2"><span>Here's the <kbd class="calibre11">chat-message-form.component.ts</kbd> file </span><span>as of now:</span></p>
<pre class="calibre17"><span>import </span>{Component, Input, OnInit} <span>from </span><span>'@angular/core'</span>;<br class="title-page-name"/><span>import </span>{MessagingService} <span>from </span><span>'../../services/messaging.service'</span>;<br class="title-page-name"/><span>import </span>{Message} <span>from </span><span>'../../services/message'</span>;<br class="title-page-name"/><span>import </span>{UserService} <span>from </span><span>'../../services/user.service'</span>;<br class="title-page-name"/><br class="title-page-name"/>@<span>Component</span>({<br class="title-page-name"/>   <span>selector</span>: <span>'app-chat-message-form'</span>,<br class="title-page-name"/>   <span>styleUrls</span>: [<span>'chat-message-form.component.scss'</span>],<br class="title-page-name"/>   <span>templateUrl</span>: <span>'chat-message-form.component.html'<br class="title-page-name"/></span>})<br class="title-page-name"/><span>export class </span>ChatMessageFormComponent <span>implements </span>OnInit {<br class="title-page-name"/>   @<span>Input</span>() <span>friendUid</span>: <span>string</span>;<br class="title-page-name"/><br class="title-page-name"/>   <span>uid</span>: <span>string</span>;<br class="title-page-name"/><br class="title-page-name"/>   <span>newMessage</span>: <span>string</span>;<br class="title-page-name"/><br class="title-page-name"/>   <span>constructor</span>(<span>private </span>messageService: MessagingService,<br class="title-page-name"/>            <span>private </span>userService: UserService) {<br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>   <span>ngOnInit</span>() {<br class="title-page-name"/>      <span>this</span>.<span>uid </span>= <span>this</span>.userService.<span>getSavedUser</span>().<span>getValue</span>().<span>uid</span>;<br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>   <span>sendMessage</span>() {<br class="title-page-name"/>      <span>const </span><span>message</span>: Message = <span>new </span>Message(<span>this</span>.<span>newMessage</span>, <br class="title-page-name"/><span>      this</span>.<span>uid</span>, <span>this</span>.<span>friendUid</span>, <span>Date</span>.<span>now</span>());<br class="title-page-name"/>      <span>this</span>.messageService.<span>createNewMessage</span>(<span>message</span>);<br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>}</pre>
<p class="calibre2">Finally, we have created a fully functional chat feature for our friends application.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">We have now come to the end of the chat feature in our friends application. In this chapter, we covered the route parameter and used this to pass the friend's UID to our chat module. We passed this UID to different chat components using the <kbd class="calibre11">@Input</kbd> binding. We then discussed how to design Firebase database for our chat feature. We used Firebase database API in the service and created four APIs to perform different operations in our chat feature. Finally, we integrated this service with the chat components. </p>
<p class="calibre2">In the next chapter, we will discuss unit testing in Angular. We will also discuss the Jasmine framework and use this framework to unit-test our application.</p>


            </article>

            
        </section>
    </body></html>