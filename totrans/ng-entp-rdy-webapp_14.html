<html><head></head><body>
  <div id="_idContainer770">
    <h1 class="chapterNumber">14</h1>
    <h1 class="chapterTitle" id="_idParaDest-466">Google Analytics and Advanced Cloud Ops</h1>
    <p class="normal">You have designed, developed, and deployed a world-class web application; however, that is only the beginning of the story of your app. The web is an ever-evolving, living, breathing environment that demands attention in order to continue to succeed as a business. In <em class="italics">Chapter 13</em>, <em class="italics">Highly Available Cloud Infrastructure on AWS</em>, we went over the basic concepts and costs of ownership of a cloud infrastructure.</p>
    <p class="normal">In this chapter, we will dig deeper in to truly understanding how users actually use our application with Google Analytics. We will then use that information to create realistic load tests to simulate actual user behavior to understand the true capacity of a single instance of our server. Knowing the capacity of a single server, we can fine-tune how our infrastructure scales out to reduce waste and discuss the implications of various scaling strategies.</p>
    <p class="normal">Finally, we will go over advanced analytics concepts, such as custom events, to gain a more granular understanding and tracking of user behavior.</p>
    <p class="normal">In this chapter, you will learn about the following topics:</p>
    <ul>
      <li class="list">Collecting analytics</li>
      <li class="list">Budgeting and scaling</li>
      <li class="list">Advanced load testing to predict capacity</li>
      <li class="list">Reliable cloud scaling</li>
      <li class="list">Measuring actual use with custom analytics events</li>
    </ul>
    <p class="normal">Throughout the chapter, you will be setting up Google Analytics, Google Tag Manager, and OctoPerf accounts.</p>
    <p class="normal">The most up-to-date versions of the sample code for this book can be found on GitHub at the following repository link. The repository contains the final and completed state of the code. You can verify your progress at the end of this chapter by looking for the end-of-chapter snapshot of code under the <code class="Code-In-Text--PACKT-">projects</code> folder.</p>
    <p class="normal">In the case of <em class="italics">Chapter 14</em>:</p>
    <ol>
      <li class="list">Clone the repo: <a href="https://github.com/duluca/lemon-mart"><span class="url">https://github.com/duluca/lemon-mart</span></a>.<p class="Bullet-Without-Bullet-Within-Bullet--PACKT-">Execute <code class="Code-In-Text--PACKT-">npm install</code> on the root folder to install dependencies.</p>
      </li>
      <li class="list">The code sample for this chapter can be found under the following subfolder:
        <pre class="programlisting"><code class="hljs">projects/ch14
</code></pre>
      </li>
      <li class="list">To run the Angular app for this chapter, execute the following command:
        <pre class="programlisting"><code class="hljs nginx"><span class="hljs-attribute">npx</span> ng serve ch14
</code></pre>
      </li>
      <li class="list">To run Angular unit tests for this chapter, execute the following command:
        <pre class="programlisting"><code class="hljs bash">npx ng <span class="hljs-built_in">test</span> ch14 --watch=<span class="hljs-literal">false</span>
</code></pre>
      </li>
      <li class="list">To run Angular e2e tests for this chapter, execute the following command:
        <pre class="programlisting"><code class="hljs nginx"><span class="hljs-attribute">npx</span> ng e2e ch14
</code></pre>
      </li>
      <li class="list">To build a production-ready Angular app for this chapter, execute the following command:
        <pre class="programlisting"><code class="hljs ada">npx ng build ch14 <span class="hljs-comment">--prod</span>
</code></pre>
        <div class="packt_tip">
          <p>Note that the <code class="Code-In-Text--PACKT-">dist/ch14</code> folder at the root of the repository will contain the compiled result.</p>
        </div>
        <div class="note">
          <p class="Information-Box--PACKT-">Beware that the source code in the book or on GitHub may not always match the code generated by the Angular CLI. There may also be slight differences in implementation between the code in the book and what's on GitHub because the ecosystem is ever-evolving. It is natural for the sample code to change over time. Also, on GitHub, expect to find corrections, fixes to support newer versions of libraries, or side-by-side implementations of multiple techniques for the reader to observe. The reader is only expected to implement the ideal solution recommended in the book. If you find errors or have questions, please create an issue or submit a pull request on GitHub for the benefit of all readers.</p>
        </div>
        <div class="packt_tip">
          <p>You can read more about updating Angular in <em class="italics">Appendix C</em>, <em class="italics">Keeping Angular and Tools Evergreen</em>. You can find this appendix online from <a href="https://static.packt-cdn.com/downloads/9781838648800_Appendix_C_Keeping_Angular_and_Tools_Evergreen."><span class="url">https://static.packt-cdn.com/downloads/9781838648800_Appendix_C_Keeping_Angular_and_Tools_Evergreen.pdf</span></a> or at <a href="https://expertlysimple.io/stay-evergreen"><span class="url">https://expertlysimple.io/stay-evergreen</span></a>.</p>
        </div>
      </li>
    </ol>
    <p class="normal">Let's begin by covering the basics of web analytics.</p>
    <h1 class="title" id="_idParaDest-467">Collecting analytics</h1>
    <p class="normal">Now that our site is <a id="_idIndexMarker1483"/>up and running, we need to start collecting metrics to understand how it is being used. Metrics are <a id="_idIndexMarker1484"/>key to operating a web application.</p>
    <p class="normal">Google Analytics has many facets. The main<a id="_idIndexMarker1485"/> three are as follows:</p>
    <ol>
      <li class="list" value="1">Acquisition, which measures how visitors arrive at your website</li>
      <li class="list">Behavior, which measures how visitors interact with your website</li>
      <li class="list" value="3">Conversions, which measure how visitors completed various goals on your website</li>
    </ol>
    <p class="normal">Here's a look at the <strong class="screen-text">BEHAVIOR</strong> | <strong class="screen-text">Overview</strong> page from my website <a href="https://thejavascriptpromise.com/"><span class="url">https://thejavascriptpromise.com/</span></a>:</p>
    <figure class="mediaobject"><img alt="" src="../Images/B14094_14_01.png"/></figure>
    <p class="packt_figref">Figure 14.1: Google Analytics behavior overview</p>
    <p class="normal"><a href="https://thejavascriptpromise.com/"><span class="url">https://thejavascriptpromise.com/</span></a> is a simple single-page HTML site, hence the metrics are quite simple. Let's go over the various metrics on the screen:</p>
    <ol>
      <li class="list" value="1"><strong class="screen-text">Pageviews</strong> shows the number of visitors.</li>
      <li class="list"><strong class="screen-text">Unique Pageviews</strong> shows the number of unique visitors.</li>
      <li class="list"><strong class="screen-text">Avg. Time on Page</strong> shows the amount of time each user spent on the site.</li>
      <li class="list"><strong class="screen-text">Bounce Rate</strong> shows that users left the site without navigating to a subpage or interacting with the site in any<a id="_idIndexMarker1486"/> manner, such as clicking on a link or button with a custom event.</li>
      <li class="list" value="5"><strong class="screen-text">% Exit</strong> indicates how often users leave the site after viewing a particular page or set of pages.</li>
    </ol>
    <p class="normal">At a high level, in 2017, the site had about 1,090 unique visitors and, on average, each visitor spent about 2.5 minutes, or 157 seconds, on the site. Given that this is just a single-page site, bounce rate and % exit metrics do not apply in any meaningful manner. Later, we use the number of unique visitors to calculate the cost per user.</p>
    <p class="normal">As a point of comparison, the LemonMart app from the book served 162,396 lemons between April 2018 and April 2020:</p>
    <figure class="mediaobject"><img alt="" src="../Images/B14094_14_02.png"/></figure>
    <p class="packt_figref">Figure 14.2: LemonMart behavior overview</p>
    <p class="normal">In addition to page views, Google Analytics can also capture specific events, such as clicking on a button that triggers a server request. These events can then be viewed on the <strong class="screen-text">Events</strong> | <strong class="screen-text">Overview</strong> page, as shown:</p>
    <figure class="mediaobject"><img alt="" src="../Images/B14094_14_03.png"/></figure>
    <p class="packt_figref">Figure 14.3: Google Analytics Events Overview</p>
    <p class="normal">It is possible to capture metrics <a id="_idIndexMarker1487"/>on the server side as well, but this will give requests-over-time statistics. You will require additional code and state management to track the behavior of a particular user so that you can calculate users-over-time statistics. By implementing such tracking on the client side with Google Analytics, you gain a far more detailed understanding as to where the user came from, what they did, whether they succeeded or not, and when they left your app without adding unnecessary code complexity and infrastructure load to your backend.</p>
    <h2 class="title" id="_idParaDest-468">Adding Google Tag Manager to your Angular app</h2>
    <p class="normal">Let's start capturing analytics in <a id="_idIndexMarker1488"/>your Angular app. Google is in the process of phasing out the legacy <code class="Code-In-Text--PACKT-">ga.js</code> and <code class="Code-In-Text--PACKT-">analytics.js</code> products that are shipped with Google Analytics, replacing these with its new, more flexible global site tag, <code class="Code-In-Text--PACKT-">gtag.js</code>, that ships with Google Tag Manager. This is by no means an end to Google Analytics; instead, it represents a shift toward an easier-to-configure and manage analytics tool. The global site tag can be configured and managed remotely via Google Tag Manager. Tags are snippets of JavaScript tracking code that is delivered to the client, and they can enable tracking of new metrics and integration with multiple analytics tools without having to change code that has already been deployed. You can still continue to use Google Analytics to analyze and view your analytics data. Another major advantage of Google Tag Manager is that it is version controlled, meaning that you can experiment with<a id="_idIndexMarker1489"/> different kinds of tags that are triggered under various kinds of conditions without fear of doing any irreversible damage to your analytics configuration.</p>
    <h3 class="title" id="_idParaDest-469">Setting up Google Tag Manager</h3>
    <p class="normal">Let's begin by setting<a id="_idIndexMarker1490"/> up a Google Tag Manager account for your application:</p>
    <ol>
      <li class="list" value="1">Sign in to Google Tag Manager at <a href="https://tagmanager.google.com/"><span class="url">https://tagmanager.google.com/</span></a>.</li>
      <li class="list">Add a new account with a <strong class="screen-text">Web</strong> container, as follows:<figure class="mediaobject"><img alt="" src="../Images/B14094_14_04.png"/></figure>
        <p class="packt_figref">Figure 14.4: Google Tag Manager</p>
      </li>
      <li class="list">Paste the generated scripts at or near the top <code class="Code-In-Text--PACKT-">&lt;head&gt;</code> and <code class="Code-In-Text--PACKT-">&lt;body&gt;</code> sections of your <code class="Code-In-Text--PACKT-">index.html</code> file, as instructed on the website:
        <pre class="programlisting"><code class="hljs xml"><strong>src/index.html</strong>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-comment">&lt;!-- Google Tag Manager --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">w,d,s,l,i</span>)</span>{w[l]=w[l]||[];w[l].push({<span class="hljs-string">'gtm.start'</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(),<span class="hljs-attr">event</span>:<span class="hljs-string">'gtm.js'</span>});<span class="hljs-keyword">var</span> f=d.getElementsByTagName(s)[<span class="hljs-number">0</span>], j=d.createElement(s),dl=l!=<span class="hljs-string">'dataLayer'</span>?<span class="hljs-string">'&amp;l='</span>+l:<span class="hljs-string">''</span>;j.async=<span class="hljs-literal">true</span>;j.src=<span class="hljs-string">'https://www.googletagmanager.com/gtm.js?id='</span>+i+dl;f.parentNode.insertBefore(j,f);
})(<span class="hljs-built_in">window</span>,<span class="hljs-built_in">document</span>,<span class="hljs-string">'script'</span>,<span class="hljs-string">'dataLayer'</span>,<span class="hljs-string">'GTM-56D4F6K'</span>);</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-comment">&lt;!-- End Google Tag Manager --&gt;</span>
...
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-comment">&lt;!-- Google Tag Manager (noscript) --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">noscript</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://www.googletagmanager.com/ns.html?id=GTM-56D4F6K"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"display:none;visibility:hidden"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">noscript</span>&gt;</span>
<span class="hljs-comment">&lt;!-- End Google Tag Manager (noscript) --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">app-root</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-root</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
</code></pre>
        <p class="Bullet-Without-Bullet-Within-Bullet--PACKT-">Note that the <code class="Code-In-Text--PACKT-">&lt;noscript&gt;</code> tag will only execute if the user has disabled JavaScript execution in their browser. This way, we can collect metrics from such users, rather than being blind to<a id="_idIndexMarker1491"/> their presence.</p>
      </li>
      <li class="list">Submit and publish your tag manager container.</li>
      <li class="list">You should see the initial setup of your tag manager completed, as shown in the following screenshot:<figure class="mediaobject"><img alt="" src="../Images/B14094_14_05.png"/></figure>
        <p class="packt_figref">Figure 14.5: Published tag</p>
      </li>
      <li class="list" value="6">Verify that your Angular app <a id="_idIndexMarker1492"/>runs without any errors.</li>
    </ol>
    <div class="packt_tip">
      <p>Note that if you don't publish your tag manager container, you will see a <code class="Code-In-Text--PACKT-">404</code> error when loading <code class="Code-In-Text--PACKT-">gtm.js</code> in the dev console or the <strong class="screen-text">Network</strong> tab.</p>
    </div>
    <h3 class="title" id="_idParaDest-470">Setting up Google Analytics</h3>
    <p class="normal">Now, let's generate<a id="_idIndexMarker1493"/> a tracking ID through Google Analytics. This is a universally unique identifier for your app to correlate your analytics data:</p>
    <ol>
      <li class="list" value="1">Log in to <a id="_idIndexMarker1494"/>Google Analytics at <a href="https://analytics.google.com"><span class="url">https://analytics.google.com</span></a>.</li>
      <li class="list">Open the <strong class="screen-text">Admin console</strong>, using the gear icon in the bottom-left corner of the screen, as shown in the following screenshot:<figure class="mediaobject"><img alt="" src="../Images/B14094_14_06.png"/></figure>
        <p class="packt_figref">Figure 14.6: Google Analytics admin console</p>
      </li>
      <li class="list">Create a new analytics account.</li>
      <li class="list">Using the steps from the preceding screenshot as a guide, perform the following steps:<ol>
          <li class="Numbered-Bullet-Within-Bullet--PACKT-">Add a new <strong class="screen-text">Property</strong>, <code class="Code-In-Text--PACKT-">LemonMart</code>.</li>
          <li class="Numbered-Bullet-Within-Bullet--PACKT-">Configure the property to your preferences.</li>
          <li class="Numbered-Bullet-Within-Bullet--PACKT-">Click on <strong class="screen-text">Tracking Code</strong>.</li>
          <li class="Numbered-Bullet-Within-Bullet--PACKT-">Copy the <strong class="screen-text">Tracking ID</strong> that starts with <code class="Code-In-Text--PACKT-">UA-xxxxxxxxxx-1</code>.</li>
          <li class="Numbered-Bullet-Within-Bullet-End--PACKT-">Ignore the <code class="Code-In-Text--PACKT-">gtag.js</code> code provided.</li>
        </ol>
      </li>
    </ol>
    <p class="normal">With your tracking ID on hand, we <a id="_idIndexMarker1495"/>can configure Google Tag Manager so that it can collect analytics.</p>
    <h4 class="title">Configuring Google Analytics Tag in Tag Manager</h4>
    <p class="normal">Now, let's connect our <a id="_idIndexMarker1496"/>Google Analytics ID to <a id="_idIndexMarker1497"/>Google Tag Manager:</p>
    <ol>
      <li class="list" value="1">At <a href="https://tagmanager.google.com"><span class="url">https://tagmanager.google.com</span></a>, open the <strong class="screen-text">Workspace</strong> tab.</li>
      <li class="list">Click on <strong class="screen-text">Add a new tag</strong>.</li>
      <li class="list">Name it <code class="Code-In-Text--PACKT-">Google Analytics</code>.</li>
      <li class="list">Click on <strong class="screen-text">Tag Configuration</strong> and select <strong class="screen-text">Universal Analytics</strong>.</li>
      <li class="list">Under <strong class="screen-text">Google Analytics Settings</strong>, add a new variable.</li>
      <li class="list">Paste the tracking ID you<a id="_idIndexMarker1498"/> copied in the previous section.</li>
      <li class="list">Click on <strong class="screen-text">Triggers</strong> and add the <strong class="screen-text">All Pages</strong> trigger.</li>
      <li class="list">Click on <strong class="screen-text">Save</strong>, as shown in the<a id="_idIndexMarker1499"/> following screenshot:<figure class="mediaobject"><img alt="" src="../Images/B14094_14_07.png"/></figure>
        <p class="packt_figref">Figure 14.7: Creating a Google Analytics tag</p>
      </li>
      <li class="list">Submit and publish your changes, and observe the version summary with one tag, as shown:<figure class="mediaobject"><img alt="" src="../Images/B14094_14_08.png"/></figure>
        <p class="packt_figref">Figure 14.8: Version Summary showing one tag</p>
      </li>
      <li class="list">Now refresh your Angular app, where you'll be on the <code class="Code-In-Text--PACKT-">/home</code> route.</li>
      <li class="list">In a private window, open<a id="_idIndexMarker1500"/> a new instance of your Angular app and navigate to the <code class="Code-In-Text--PACKT-">/manager/home</code> route.</li>
      <li class="list">At <a href="https://analytics.google.com/"><span class="url">https://analytics.google.com/</span></a>, open the <strong class="screen-text">REAL-TIME</strong> | <strong class="screen-text">Overview</strong> pane, as shown in the<a id="_idIndexMarker1501"/> following screenshot:<figure class="mediaobject"><img alt="" src="../Images/B14094_14_09.png"/></figure>
        <p class="packt_figref">Figure 14.9: Google Analytics REAL-TIME Overview</p>
      </li>
      <li class="list">Note that the two active users are being tracked.</li>
      <li class="list" value="14">Under <strong class="screen-text">Top Active Pages</strong>, you should see the pages that the users are on.</li>
    </ol>
    <p class="normal">By leveraging Google Tag Manager and <a id="_idIndexMarker1502"/>Google Analytics together, we have been able to accomplish page tracking without changing any code inside our Angular app.</p>
    <div class="packt_tip">
      <p><strong class="bold">Search engine optimization</strong> (<strong class="bold">SEO</strong>) is an important <a id="_idIndexMarker1503"/>part of analytics. To gain a better understanding of how crawlers perceive your Angular site, use the<a id="_idIndexMarker1504"/> Google Search Console dashboard, found at <a href="https://www.google.com/webmasters/tools"><span class="url">https://www.google.com/webmasters/tools</span></a>, to identify optimizations. In addition, consider using Angular Universal to render certain dynamic content on the <a id="_idIndexMarker1505"/>server-side so that crawlers can index your dynamic data sources and drive more traffic to your site.</p>
    </div>
    <h1 class="title" id="_idParaDest-471">Budgeting and scaling</h1>
    <p class="normal">In the <em class="italics">AWS Billing</em> section of <em class="italics">Chapter 13</em>, <em class="italics">Highly Available Cloud Infrastructure on AWS</em>, we covered the <a id="_idIndexMarker1506"/>monthly costs of operating a web server, ranging from $5/month to $45/month, from a single-server instance scenario to a highly available infrastructure. For most needs, budgeting discussions will begin and end with this monthly number. You can execute load tests, as suggested in the <em class="italics">Advanced load testing</em> section, to predict your per-server user capacity and get a general idea of how many servers you may require. In a dynamically scaling <a id="_idIndexMarker1507"/>cloud environment with dozens of servers running 24/7, this is an overly simplistic way to calculate a budget.</p>
    <p class="normal">If you operate a web property of any significant scale, things invariably get complicated. You will be operating multiple servers on different tech stacks, serving different purposes. It can be difficult to gauge or justify how much of a budget to spare for seemingly excess capacity or unnecessarily high-performance servers. Somehow, you need to be able to communicate the efficiency of your infrastructure given the number of users you serve and ensure that your infrastructure is fine-tuned so that you don't lose users due to an unresponsive application or overpay because you're using more capacity than you require.</p>
    <p class="normal">For this reason, we will take a user-centered approach and translate our IT infrastructure costs to a per-user cost metric that the business and the marketing side of your organization can make sense of.</p>
    <p class="normal">In the next section, we will investigate what it means to calculate the per-user cost of your infrastructure and how these calculations change when cloud scaling comes in to play using one of my websites as an example.</p>
    <h2 class="title" id="_idParaDest-472">Calculating the per-user cost</h2>
    <p class="normal">We will be leveraging<a id="_idIndexMarker1508"/> behavior metrics from Google Analytics with the goal of calculating the per-user cost over a given period of time:</p>
    <p class="normal">Per-user cost is calculated as follows:</p>
    <figure class="mediaobject"><img alt="" src="../Images/B14094_14_001.png" style="height: 3em !important;"/></figure>
    <p class="normal">Using the <a href="https://thejavascriptpromise.com/"><span class="url">https://thejavascriptpromise.com/</span></a> data from earlier, let's plug in the data to the formula to calculate <em class="italics">perUserCost/month</em>.</p>
    <p class="normal">This website is deployed on an Ubuntu server on DigitalOcean, so the monthly infrastructure cost, including weekly backups, is $6 a month. From Google Analytics, we know there were 1,090 unique visitors in 2017:</p>
    <figure class="mediaobject"><img alt="" src="../Images/B14094_14_002.png" style="height: 3em !important;"/></figure>
    <p class="normal">In 2017, I have paid 7 cents per user. Money well spent? At $6/month, I don't mind it. In 2017, <a href="https://thejavascriptpromise.com/"><span class="url">https://thejavascriptpromise.com/</span></a> was deployed on a traditional server setup as a static site that doesn't scale out or in. These conditions make it very straightforward to use the unique visitor metric and find the per-user cost. The very same simplicity that allows for<a id="_idIndexMarker1509"/> an easy calculation also leads to a suboptimal infrastructure. If I were to serve 1,000,000 users on the same infrastructure, my costs would add up to $70,000 a year. If I were to earn $100 for every 1,000 users through Google ads, my site would make $100,000 per year. After taxes, development expenses, and our unreasonable hosting expenses, the operation would likely lose money.</p>
    <p class="normal">If you were to take advantage of cloud scaling, where instances can scale out or in dynamically based on current user demand, the preceding formula becomes useless pretty quickly because you must take provisioning time and target server utilization into account.</p>
    <p class="normal">Provisioning time is the amount of time it takes your cloud provider to start a new server from scratch. Target <a id="_idIndexMarker1510"/>server utilization is the maximum usage metric of a given server, where a scale-out alert must be sent out so that a new server is ready before your current servers max out their capacity. In order to calculate these variables, we must execute a series of load tests against our servers.</p>
    <p class="normal">Page views are an overly simplistic way to determine user behavior in SPAs such as Angular, where page views do not necessarily correlate to a request, or vice versa. If we execute load tests simply based on page views, we won't get a realistic simulation of how your platform may perform under load.</p>
    <p class="normal">User behavior, or how users actually use your app, can drastically impact your performance forecasts and wildly fluctuate budget numbers. You can use Google Analytics custom events to capture complicated sets of actions that result in various types of requests served by your platform. Later in this chapter, we will explore how you can measure actual use in the <em class="italics">Measuring actual use</em> section.</p>
    <p class="normal">Initially, you won't have any of the <a id="_idIndexMarker1511"/>aforementioned metrics, and any metrics you may have will be invalidated any time you make a meaningful change to your software or hardware stack. Therefore, it is imperative to execute load tests on a regular basis to simulate realistic user loads.</p>
    <h1 class="title" id="_idParaDest-473">Advanced load testing</h1>
    <p class="normal">In order to be able to predict capacity, we need to run load tests. In <em class="italics">Chapter 13</em>, <em class="italics">Highly Available Cloud Infrastructure on AWS</em>, I discussed a simple load testing technique of just sending a bunch of web requests to a<a id="_idIndexMarker1512"/> server. In a relative comparison scenario, this works fine for testing raw power. However, actual users generate dozens of requests at varying intervals while they navigate your website, resulting in a wide variety of API calls to your backend server.</p>
    <p class="normal">We must be able to model virtual users and unleash a whole bunch of them on our servers to find the breaking point of our server. OctoPerf is an easy-to-use service to execute such load tests, and it's located at <a href="https://octoperf.com"><span class="url">https://octoperf.com</span></a>. OctoPerf<a id="_idIndexMarker1513"/> offers a free tier that allows for 50 concurrent users/test over unlimited test runs with two load generators.</p>
    <p class="normal">OctoPerf is the ideal tool to get <a id="_idIndexMarker1514"/>us quickly started with advanced testing capability. Let's create an account and see what it can do for us:</p>
    <ol>
      <li class="list" value="1">Create an OctoPerf account.</li>
      <li class="list">Log in and add a new project for LemonMart, as shown:<figure class="mediaobject"><img alt="" src="../Images/B14094_14_10.png"/></figure>
        <p class="packt_figref">Figure 14.10: Adding a project in OctoPerf</p>
        <p class="Bullet-Without-Bullet-Within-Bullet--PACKT-">OctoPerf allows you to create<a id="_idIndexMarker1515"/> multiple virtual users with different usage characteristics. Since it is a URL-based setup, any click-based user action can also be simulated by directly calling the application server URL with test parameters.</p>
      </li>
      <li class="list">Create two virtual users, one as a <code class="Code-In-Text--PACKT-">Manager</code> who navigates to manager-based pages, and a second as a <code class="Code-In-Text--PACKT-">POS</code> user who sticks to POS functions.</li>
      <li class="list">Click on <strong class="screen-text">Create scenario</strong>:<figure class="mediaobject"><img alt="" src="../Images/B14094_14_11.png"/></figure>
        <p class="packt_figref">Figure 14.11: POS User scenario</p>
      </li>
      <li class="list">Name the <a id="_idIndexMarker1516"/>scenario <code class="Code-In-Text--PACKT-">Evening Rush</code>.</li>
      <li class="list">You can add a mixture of <strong class="screen-text">Manager</strong> and <strong class="screen-text">POS User</strong> types, as shown:<figure class="mediaobject"><img alt="" src="../Images/B14094_14_12.png"/></figure>
        <p class="packt_figref">Figure 14.12: Evening Rush scenario</p>
      </li>
      <li class="list">Click on the <strong class="screen-text">Launch 50 VUs</strong> button to start the load test.<p class="Bullet-Without-Bullet-Within-Bullet--PACKT-">You can observe the number of <strong class="screen-text">users</strong> and <strong class="screen-text">hits/sec</strong> being achieved in real-time, as shown in the following screenshot:</p>
        <figure class="mediaobject"><img alt="" src="../Images/B14094_14_13.png"/></figure>
        <p class="packt_figref">Figure 14.13: Evening Rush load test underway</p>
      </li>
      <li class="list">ECS service metrics <a id="_idIndexMarker1517"/>also give us a high-level idea of real-time utilization, as shown in the following screenshot:<figure class="mediaobject"><img alt="" src="../Images/B14094_14_14.png"/></figure>
        <p class="packt_figref">Figure 14.14: ECS real-time metrics</p>
      </li>
      <li class="list" value="9">Analyze the load test results.</li>
    </ol>
    <p class="normal">You can get more accurate results from ECS by clicking on the <strong class="screen-text">CPUUtilization</strong> link from <strong class="screen-text">ECS Service Metrics</strong> or by navigating to the <strong class="screen-text">CloudWatch</strong> | <strong class="screen-text">Metrics</strong> section, as follows:</p>
    <figure class="mediaobject"><img alt="" src="../Images/B14094_14_15.png"/></figure>
    <p class="packt_figref">Figure 14.15: AWS CloudWatch Metrics</p>
    <p class="normal">As you can see in the preceding graph, CPU utilization <a id="_idIndexMarker1518"/>was fairly consistent, at around 1.3%, given a sustained user load of 50 over a period of 10 minutes. During this period, there were no request errors, as shown in the statistics summary from OctoPerf:</p>
    <figure class="mediaobject"><img alt="" src="../Images/B14094_14_16.png"/></figure>
    <p class="packt_figref">Figure 14.16: OctoPerf Statistics summary</p>
    <p class="normal">Ideally, we would measure maximum users/second until the moment errors were being generated. However, given only 50 virtual users and the information we already have, we can predict how many users could be handled at 100% utilization:</p>
    <figure class="mediaobject"><img alt="" src="../Images/B14094_14_003.png" style="height: 3em !important;"/></figure>
    <p class="normal">Our load test results reveal that our<a id="_idIndexMarker1519"/> infrastructure can handle 3,846 users/second. Given this information, we can calculate cost per user in a scalable environment in the next section. However, performance and reliability go hand in hand. How you choose to architect your infrastructure will also provide important information in terms of budgeting, because the level of reliability you need will dictate the minimum number of instances you must keep around at all times.</p>
    <h1 class="title" id="_idParaDest-474">Reliable cloud scaling</h1>
    <p class="normal">Reliability can be expressed in terms of<a id="_idIndexMarker1520"/> your organization’s <strong class="bold">recovery point objective</strong> (<strong class="bold">RPO</strong>) and <strong class="bold">recovery time objective</strong> (<strong class="bold">RTO</strong>). RPO<a id="_idIndexMarker1521"/> represents how much data you’re willing to lose, while RTO represents how fast you can rebuild your infrastructure <a id="_idIndexMarker1522"/>in the event of a failure.</p>
    <p class="normal">Let’s suppose that you run an e-commerce site. Around noon every weekday, you reach peak sales. Every time a user adds an item to their shopping cart, you store the items on a server-side cache so that users can resume their shopping spree later at home. In addition, you process hundreds of transactions per minute. Business is good, your infrastructure is scaling out beautifully, and everything is going smoothly. Meanwhile, a hungry rat or an overly charged lightning cloud decides to strike your data center. Initially, a seemingly harmless power unit goes down, but it’s fine, because nearby power units can pick up the slack. However, this is the lunch rush; other websites on the data center are also facing a high traffic volume. As a result, several power units overheat and fail. There aren’t enough power units to pick up the slack, so in quick succession, power units overheat one by one and start failing, triggering a cascade of failures that end up taking down the entire data center. Meanwhile, some of your users just clicked on <strong class="screen-text">Add to cart</strong>, others on the <strong class="screen-text">Pay</strong> button, and some others are just about to arrive on your site. If your RPO is 1 hour, meaning you persisted your shopping cart cache every hour, then you can say <a id="_idIndexMarker1523"/>goodbye to valuable data and potential sales by those night-time shoppers. If your RTO is 1 hour, it will take you up to 1 hour to get your site back up and running again, and you can rest assured that most of those customers who just clicked on the buy button or arrived to an unresponsive site won’t be making a purchase on your site that day.</p>
    <p class="normal">A well-thought-out RPO and RTO is a critical business need, but they must also be paired with the right infrastructure that makes it possible to implement your objectives in a cost-effective manner. AWS is made up of more than two dozen regions around the world, each region containing at<a id="_idIndexMarker1524"/> least their <strong class="bold">availability zones</strong> (<strong class="bold">AZs</strong>). Each AZ is a physically separated infrastructure that is not affected by a failure in another AZ.</p>
    <p class="normal">A highly available configuration on AWS means that your application is up and running on at least two AZs, so if a server instance fails, or even if the entire data center fails, you have another instance already live in a physically separate data center that is able to pick up incoming requests seamlessly.</p>
    <p class="normal">A fault-tolerant architecture means that your application is deployed across multiple regions. Even if an entire region goes down due to a natural disaster, a <strong class="bold">distributed denial-of-service</strong> (<strong class="bold">DDoS</strong>) attack, or a bad software update, your infrastructure remains standing and is able to<a id="_idIndexMarker1525"/> respond to user requests. Your data is protected by layer upon layer of security and via staggered backups of backups.</p>
    <p class="normal">AWS offers great services, including <strong class="bold">Shield</strong> to protect against DDoS attacks targeted against your website, a <strong class="bold">Pilot Light</strong> service to keep a<a id="_idIndexMarker1526"/> minimal infrastructure waiting dormant in another region that can scale to full capacity if needed, while keeping operational<a id="_idIndexMarker1527"/> costs down, and a <strong class="bold">Glacier</strong> service to store large amounts for data for long periods of time in an affordable manner.</p>
    <p class="normal">A highly available configuration will require a minimum of two instances in a multi-AZ setup at all times. For a fault-tolerant setup, you require two highly available configurations in at least two regions. Most AWS cloud services, such as DynamoDB for data storage or Redis for <a id="_idIndexMarker1528"/>caching, are highly available by default, including serverless technologies such as Lambda. Lambda charges on a per-use basis and can scale to match any need you can throw at it in a cost-effective manner. If you can move heavy compute tasks to Lambda, you can reduce your server utilization and your scaling needs dramatically in the process. When planning your infrastructure, you should consider all these variables to set up the right scalable environment for your needs.</p>
    <h2 class="title" id="_idParaDest-475">Cost per user in a scalable environment</h2>
    <p class="normal">In a scalable environment, you <a id="_idIndexMarker1529"/>cannot plan on 100% utilization. It takes time to provision a new server. A server that is at 100% utilization can’t process additional incoming requests in a timely manner, which results in dropped or erroneous <a id="_idIndexMarker1530"/>requests from the users’ perspective. So, the server in question must send a trigger well before it reaches 100% utilization so that no requests are dropped. Earlier in the chapter, I suggested a 60-80% target utilization before scaling. The exact number will largely depend on your specific choice of software and hardware stack. </p>
    <p class="normal">Given your custom utilization target, we can calculate the number of users your infrastructure is expected to serve on average per instance. Using this information, you can calculate a more accurate cost per user, which should allow the correct sizing of your IT budget, given your specific needs. It is equally as bad to underspend as it is to overspend. You may be forgoing more growth, security, data, reliability, and resilience than may be considered acceptable.</p>
    <p class="normal">In the next section, we will walk through the calculation of an optimal target server utilization metric so that you can calculate a more accurate per-user cost. Then, we will explore scaling that can occur during preplanned time frames and software deployments.</p>
    <h3 class="title" id="_idParaDest-476">Calculating target server utilization</h3>
    <p class="normal">First, calculate your custom <a id="_idIndexMarker1531"/>server utilization target, which is the point where your server is experiencing increased volumes of traffic and triggers a new server to provision with enough time <a id="_idIndexMarker1532"/>so that the original server does not reach 100% utilization and drops requests. Consider this formula:</p>
    <figure class="mediaobject"><img alt="" src="../Images/B14094_14_004.png" style="height: 4em !important;"/></figure>
    <p class="normal">Let’s demonstrate how the formula works with the help of a concrete example:</p>
    <ol>
      <li class="list" value="1">Load test your instances to establish user capacity per instance:<p class="Center-Within-Bullet--PACKT-"><em class="italics">Load test results</em>: 3,846 users/second.</p>
        <div class="note">
          <p>Requests/sec and users/sec are not the same, since a user makes multiple requests to complete an action and may execute multiple requests/sec. Advanced load testing tools such as OctoPerf are necessary to execute realistic and varied workloads and measure user capacity over request capacity.</p>
        </div>
      </li>
      <li class="list">Measure instance provisioning speed, from creation/cold boot to the request fulfilled first:<p class="Center-Within-Bullet--PACKT-"><em class="italics">Measured instance provisioning speed</em>: 60 seconds.</p>
        <p class="Bullet-Without-Bullet-Within-Bullet--PACKT-">In order to measure this speed, you can put the stopwatch away. Depending on your exact setup, AWS provides event and application logs in the ECS Service Events tab, CloudWatch, and CloudTrail to correlate enough information to figure out when a new instance was requested and how long it took for the instance to be ready to fulfill requests. </p>
        <p class="Bullet-Without-Bullet-Within-Bullet--PACKT-">For example, in the <strong class="screen-text">ECS Service Events</strong> tab, take the target registration event as the beginning time. Once the task has been initiated, click on the task ID to see the creation time. Using the task ID, check the task’s logs in CloudWatch to see the time at which the task served its first web request as the end time and then calculate the duration.</p>
      </li>
      <li class="list">Measure the 95th percentile user growth rate, excluding known capacity increases:<p class="Center-Within-Bullet--PACKT-"><em class="italics">95th percentile user growth rate</em>: 10 users/second.</p>
        <div class="packt_tip">
          <p class="Tip-Within-Bullet--PACKT-">The 95th percentile is a common metric to calculate overall network usage. It means that 95% of the time, usage will be below the stated amount, making it a good number to use for<a id="_idIndexMarker1533"/> planning, as explained by Barb Dijker in her article entitled <em class="italics">What the heck is this 95th Percentile number?</em>, available at <a href="http://www2.arnes.si/~gljsentvid10/pct.html"><span class="url">http://www2.arnes.si/~gljsentvid10/pct.html</span></a>.</p>
        </div>
        <div class="note">
          <p>If you don’t have prior metrics, initially defining user growth rate will be an educated guess at best. However, once you start collecting data, you can update your assumptions. In addition, it is impossible to operate an infrastructure that can respond to any imaginable outlier without dropping a request in a cost-effective manner. Given your metrics, a business decision should be consciously made as to what percentile of outliers should be ignored as an acceptable business risk.</p>
        </div>
      </li>
      <li class="list">Let’s plug in the numbers to the formula:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="../Images/B14094_14_005.png" style="height: 3em !important;"/></figure>
    <p class="normal">The custom target utilization rate, rounded down, would be 84%. Setting your scale-out trigger at 84% will avoid instances from being over provisioned, while preventing user requests from being dropped.</p>
    <p class="normal">With this custom target utilization in mind, let’s update the per-user cost formula with scaling in mind:</p>
    <figure class="mediaobject"><img alt="" src="../Images/B14094_14_006.png" style="height: 4em !important;"/></figure>
    <p class="normal">So, if our infrastructure cost <a id="_idIndexMarker1534"/>was $100 per month serving 150 users, at 100% utilization, you calculate the per-user cost to be $0.67/user/month. If you were to take scaling into account, the cost would be as follows:</p>
    <figure class="mediaobject"><img alt="" src="../Images/B14094_14_007.png" style="height: 3em !important;"/></figure>
    <p class="normal">Scaling without dropping requests would cost 16% more of the original $0.67 at $0.79 per user per month. However, it is important to keep in mind that your infrastructure won’t always be so efficient. At lower utilization targets, or when these are misconfigured with scaling triggers, costs can easily double, triple, or quadruple the original cost. The ultimate goal here is to find the sweet spot, meaning that you will be paying the right amount per user.</p>
    <p class="normal">There’s no prescriptive per-user<a id="_idIndexMarker1535"/> cost you should be targeting for. However, if you are running a service where you charge users $5 per month after all other operational costs and profit margins are accounted for, and you’re still left with a surplus budget <em class="italics">and</em> your users complaining about poor performance, then you’re underspending. However, if you’re <a id="_idIndexMarker1536"/>eating into your profit margins or, even worse, only breaking even, then you may be overspending or you may need to reconsider your business model.</p>
    <p class="normal">There are several other factors that can impact your per-user cost, including blue/green deployments, which we’ll cover in a moment. You can also increase the efficiency of your scaling by leveraging prescheduled provisioning.</p>
    <h4 class="title">Prescheduled provisioning</h4>
    <p class="normal">Dynamic scaling out and then<a id="_idIndexMarker1537"/> back in is what defines cloud computing. However, the algorithms currently available still require some planning if you know that certain days, weeks, or months of a year will require uncharacteristically higher resource capacity. Given a sudden deluge of new traffic, your infrastructure will attempt to dynamically scale out, but if the rate of increase in traffic is logarithmic, even an optimized server utilization target won’t help. Servers will frequently reach and operate at 100% utilization, resulting in dropped or erroneous requests. To prevent this from happening, you should proactively provision additional capacity during such predictable periods of high demand.</p>
    <h4 class="title">Blue/green deployments</h4>
    <p class="normal">In <em class="italics">Chapter 13</em>, <em class="italics">Highly Available Cloud Infrastructure on AWS</em>, you configured no-downtime blue/green deployments. Blue/green deployments are<a id="_idIndexMarker1538"/> reliable code deployments that ensure continuous uptime of your site, while minimizing the risk of bad deployments.</p>
    <p class="normal">Let’s presume that you have a highly available deployment, meaning you have two instances active at any given time. During a blue/green deployment, two additional instances would be provisioned. Once these additional instances are ready to fulfill requests, their health is determined using your predefined health metric.</p>
    <p class="normal">If your new instances are found to be healthy, this means they’re in working order. There will be a period of time, say 5 minutes, during which connections in the original instance are drained and rerouted to the new instances. At this time, the original instances are deprovisioned.</p>
    <p class="normal">If the new instances are found to be unhealthy, then these new instances will be deprovisioned, resulting in a failed deployment. However, a service will remain available without interruption because the original instance will remain intact and keep serving users during the entire process.</p>
    <h3 class="title" id="_idParaDest-477">Revising estimates with metrics</h3>
    <p class="normal">Load testing and predicting<a id="_idIndexMarker1539"/> user growth rates give you an idea of how your system may behave in production. Collecting more granular metrics and data is critical in revising your estimates and nailing down a more accurate IT budget.</p>
    <h1 class="title" id="_idParaDest-478">Measuring actual use</h1>
    <p class="normal">As we discussed earlier, keeping track of page views alone isn’t reflective of the number of requests that a user sends to the server. With Google Tag Manager and Google Analytics, you can keep track<a id="_idIndexMarker1540"/> of more than just page views with ease.</p>
    <p class="normal">As of the time of publication, here<a id="_idIndexMarker1541"/> are some of the default events you can configure across various categories. This list will grow over time:</p>
    <ul>
      <li class="list">Page View: Used to track whether a user is sticking around as page resources load and the page is fully rendered:<ul>
          <li class="Bullet-Within-Bullet--PACKT-">Page View; fired at the first opportunity</li>
          <li class="Bullet-Within-Bullet--PACKT-">DOM Ready; when the DOM structure is loaded</li>
          <li class="Bullet-Within-Bullet--PACKT-">Window Loaded; when all elements are finished loading</li>
        </ul>
      </li>
      <li class="list">Click: Used to track a user’s click interactions with the page:<ul>
          <li class="Bullet-Within-Bullet--PACKT-">All Elements</li>
          <li class="Bullet-Within-Bullet--PACKT-">Just Links</li>
        </ul>
      </li>
      <li class="list">User Engagement: Tracks user behavior:<ul>
          <li class="Bullet-Within-Bullet--PACKT-">Element Visibility; whether elements have been shown</li>
          <li class="Bullet-Within-Bullet--PACKT-">Form Submission; whether a form was submitted </li>
          <li class="Bullet-Within-Bullet--PACKT-">Scroll Depth; how far they scrolled down the page</li>
          <li class="Bullet-Within-Bullet--PACKT-">YouTube Video; if they <a id="_idIndexMarker1542"/>played an embedded YouTube Video</li>
        </ul>
      </li>
      <li class="list">Other event tracking:<ul>
          <li class="Bullet-Within-Bullet--PACKT-">Custom Event; defined by a programmer to track a single or multistep event, such as a user going through the steps of a checkout process</li>
          <li class="Bullet-Within-Bullet--PACKT-">History Change; whether the user navigates back in the browser’s history</li>
          <li class="Bullet-Within-Bullet--PACKT-">JavaScript Error; whether JavaScript errors have been generated</li>
          <li class="Bullet-Within-Bullet-End--PACKT-">Timer; to trigger or delay time-based analytics events</li>
        </ul>
      </li>
    </ul>
    <p class="normal">Most of these events don’t require any extra coding to implement, so we will implement a custom event to demonstrate how you can capture any single event or series of events you want with custom coding. Capturing workflows with a series of events can reveal where you should be focusing your development efforts.</p>
    <div class="packt_tip">
      <p>For more information on Google Tag Manager events, triggers, or tips and tricks, I recommend that you check<a id="_idIndexMarker1543"/> out the blog by Simo Ahava at <a href="https://www.simoahava.com/"><span class="url">https://www.simoahava.com/</span></a>.</p>
    </div>
    <h2 class="title" id="_idParaDest-479">Creating a custom event</h2>
    <p class="normal">For this example, we will <a id="_idIndexMarker1544"/>capture the event for when a customer is successfully checked out and a sale is completed. We will implement two events, one for checkout initiation, and the other for when the transaction has been completed successfully:</p>
    <ol>
      <li class="list" value="1">Log on to <a id="_idIndexMarker1545"/>your Google Tag Manager workspace at <a href="https://tagmanager.google.com"><span class="url">https://tagmanager.google.com</span></a>.</li>
      <li class="list">Under the <strong class="screen-text">Triggers</strong> menu, click on <strong class="screen-text">NEW</strong>, as indicated here:<figure class="mediaobject"><img alt="" src="../Images/B14094_14_17.png"/></figure>
        <p class="packt_figref">Figure 14.17: Tag Manager workspace</p>
      </li>
      <li class="list">Name your trigger.</li>
      <li class="list">Click on the empty trigger card to <a id="_idIndexMarker1546"/>select the event type.</li>
      <li class="list">Select <strong class="screen-text">Custom Event</strong>.</li>
      <li class="list">Create a custom event named <code class="Code-In-Text--PACKT-">checkoutCompleted</code>, as illustrated:<figure class="mediaobject"><img alt="" src="../Images/B14094_14_18.png"/></figure>
        <p class="packt_figref">Figure 14.18: Custom Checkout event</p>
        <p class="Bullet-Without-Bullet-Within-Bullet--PACKT-">By selecting the <strong class="screen-text">Some Custom Events</strong> option, you can limit or control the collection of a particular event, that is, only when on a particular page or a domain, such as on <code class="Code-In-Text--PACKT-">lemonmart.com</code>. In the<a id="_idIndexMarker1547"/> following screenshot, you can see a custom rule that would filter out any checkout event that didn’t happen on <code class="Code-In-Text--PACKT-">lemonmart.com</code> to weed out development or test data:</p>
        <figure class="mediaobject"><img alt="" src="../Images/B14094_14_19.png"/></figure>
        <p class="packt_figref">Figure 14.19: Some Custom Events</p>
      </li>
      <li class="list"><strong class="screen-text">Save</strong> your new event.</li>
      <li class="list">Repeat the process for an event named <code class="Code-In-Text--PACKT-">Checkout Initiated</code>.</li>
      <li class="list">Add two new Google Analytics event tags, as highlighted here:<figure class="mediaobject"><img alt="" src="../Images/B14094_14_20.png"/></figure>
        <p class="packt_figref">Figure 14.20: New custom event tags</p>
      </li>
      <li class="list">Configure the event and attach the relevant trigger you created to it, as shown in the following screenshot:<figure class="mediaobject"><img alt="" src="../Images/B14094_14_21.png"/></figure>
        <p class="packt_figref">Figure 14.21: Trigger setup</p>
      </li>
      <li class="list" value="11">Submit and publish your workspace.</li>
    </ol>
    <p class="normal">We are now ready to receive <a id="_idIndexMarker1548"/>custom events in our analytics environment.</p>
    <h2 class="title" id="_idParaDest-480">Adding custom events in Angular</h2>
    <p class="normal">Now, let’s edit the<a id="_idIndexMarker1549"/> Angular code to<a id="_idIndexMarker1550"/> trigger the events:</p>
    <ol>
      <li class="list" value="1">Consider the POS template with a checkout button:
        <pre class="programlisting"><code class="hljs xml"><strong>src/app/pos/pos/pos.component.html</strong>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
    <span class="hljs-attr">src</span>=<span class="hljs-string">”https://user-images.githubusercontent.com/822159/36186684-9f05fef8-110e-11e8-991f-fae6ca60fe5d.png”</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">mat-icon-button</span> (<span class="hljs-attr">click</span>)=<span class="hljs-string">”checkout(currentTransaction)”</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">mat-icon</span>&gt;</span>shopping_cart<span class="hljs-tag">&lt;/<span class="hljs-name">mat-icon</span>&gt;</span> Checkout Customer
  <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
</code></pre>
        <p class="Bullet-Without-Bullet-Within-Bullet--PACKT-">The circular checkout button is indicated in the bottom-left corner of the following diagram:</p>
        <figure class="mediaobject"><img alt="" src="../Images/B14094_14_22.png"/></figure>
        <p class="packt_figref">Figure 14.22: POS page with checkout button</p>
        <div class="packt_tip">
          <p class="Tip-Within-Bullet--PACKT-">Optionally, you <a id="_idIndexMarker1551"/>can add an <code class="Code-In-Text--PACKT-">onclick</code> event handler directly in the template, such as <code class="Code-In-Text--PACKT-">onclick=”dataLayer.push({‘event’: ‘checkoutInitiated’})”</code> on the checkout button. This pushes the <code class="Code-In-Text--PACKT-">checkoutInitiated</code> event to the <code class="Code-In-Text--PACKT-">dataLayer</code> object, made available by <code class="Code-In-Text--PACKT-">gtm.js</code>.</p>
        </div>
      </li>
      <li class="list">Define<a id="_idIndexMarker1552"/> an <code class="Code-In-Text--PACKT-">ITransaction</code> interface:
        <pre class="programlisting"><code class="hljs routeros"><strong>src/app/pos/transaction/transaction.ts</strong>
<span class="hljs-built_in">..</span>.
<span class="hljs-builtin-name">export</span><span class="hljs-built_in"> interface </span>ITransaction {
  paymentType: TransactionType
  paymentAmount: number
  transactionId?: string
}
<span class="hljs-built_in">..</span>.
</code></pre>
      </li>
      <li class="list">Define a <code class="Code-In-Text--PACKT-">TransactionType</code> enum:
        <pre class="programlisting"><code class="hljs crystal"><strong>src/app/pos/transaction/transaction<span class="hljs-class">.<span class="hljs-keyword">enum</span>.<span class="hljs-title">ts</span></span></strong>
...
export <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">TransactionType</span> {</span>
  Cash,
  Credit,
  LemonCoin,
}
...
</code></pre>
      </li>
      <li class="list">Implement a <code class="Code-In-Text--PACKT-">TransactionService</code> that <a id="_idIndexMarker1553"/>has a <code class="Code-In-Text--PACKT-">processTransaction</code> function:
        <pre class="programlisting"><code class="hljs typescript"><strong>src/app/pos/transaction/transaction.service.ts</strong>
...
<span class="hljs-meta">@Injectable</span>({
  providedIn: ‘root’,
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> TransactionService {
  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"/>) {}
  processTransaction(transaction: ITransaction)
      : Observable&lt;<span class="hljs-built_in">string</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span>
      BehaviorSubject&lt;<span class="hljs-built_in">string</span>&gt;(‘<span class="hljs-number">5</span>a6352c6810c19729de860ea’)
      .asObservable()
  }
}
...
</code></pre>
        <div class="packt_tip">
          <p class="Tip-Within-Bullet--PACKT-"><code class="Code-In-Text--PACKT-">‘5a6352c6810c19729de860ea’</code> is a random string that represents a transaction ID.</p>
        </div>
        <p class="list">In <code class="Code-In-Text--PACKT-">PosComponent</code>, declare<a id="_idIndexMarker1554"/> an interface for <code class="Code-In-Text--PACKT-">dataLayer</code> events that you intend to push:</p>
        <pre class="programlisting"><code class="hljs routeros"><strong>src/app/pos/pos/pos.component.ts</strong>
<span class="hljs-built_in">..</span>.<span class="hljs-built_in">
interface </span>IEvent {
event: ‘checkoutCompleted’ | ‘checkoutInitiated’
}
declare let dataLayer: IEvent[]
<span class="hljs-built_in">..</span>.
</code></pre>
        <p class="list">Import dependencies and initialize <code class="Code-In-Text--PACKT-">currentTransaction</code>:</p>
        <pre class="programlisting"><code class="hljs groovy"><strong>src<span class="hljs-regexp">/app/</span>pos<span class="hljs-regexp">/pos/</span>pos.component.ts</strong>
...
export <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PosComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OnInit</span>, <span class="hljs-title">OnDestroy</span> {</span>
  <span class="hljs-keyword">private</span> subs = <span class="hljs-keyword">new</span> SubSink()
<span class="hljs-symbol">  currentTransaction:</span> ITransaction
  constructor(
    <span class="hljs-keyword">private</span> <span class="hljs-string">transactionService:</span> TransactionService,
    <span class="hljs-keyword">private</span> <span class="hljs-string">uiService:</span> UiService
  ) {}
   ngOnInit() {
    <span class="hljs-keyword">this</span>.currentTransaction = {
<span class="hljs-symbol">      paymentAmount:</span> <span class="hljs-number">25.78</span>,
<span class="hljs-symbol">      paymentType:</span> TransactionType.Credit,
    } <span class="hljs-keyword">as</span> ITransaction
  }
  ngOnDestroy() {
    <span class="hljs-keyword">this</span>.subs.unsubscribe()
  }
...
</code></pre>
        <p class="list">Create the <code class="Code-In-Text--PACKT-">checkout</code> function to call <code class="Code-In-Text--PACKT-">checkoutInitiated</code> before a service call is made.</p>
        <p class="list">Simulate<a id="_idIndexMarker1555"/> a fake transaction using <code class="Code-In-Text--PACKT-">setTimeout</code> and call the <code class="Code-In-Text--PACKT-">checkoutCompleted</code> event<a id="_idIndexMarker1556"/> when the timeout ends:</p>
        <pre class="programlisting"><code class="hljs coffeescript"><strong>src/app/pos/pos/pos.component.ts</strong>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PosComponent</span> <span class="hljs-title">implements</span> <span class="hljs-title">OnInit</span> {</span>
...
  checkout(transaction: ITransaction) {
    <span class="hljs-keyword">this</span>.uiService.showToast(‘Checkout initiated’)
    dataLayer.push({
      event: ‘checkoutInitiated’,
    })
    <span class="hljs-keyword">this</span>.subs.sink = <span class="hljs-keyword">this</span>.transactionService
      .processTransaction(transaction)
      .pipe(
        filter(<span class="hljs-function"><span class="hljs-params">(tx)</span> =&gt;</span> tx != <span class="hljs-literal">null</span> || tx !== <span class="hljs-literal">undefined</span>),
        tap(<span class="hljs-function"><span class="hljs-params">(transactionId)</span> =&gt;</span> {
          <span class="hljs-keyword">this</span>.uiService.showToast(‘Checkout completed’)
          dataLayer.push({
            event: ‘checkoutCompleted’,
          })
        })
      )
      .subscribe()
}
</code></pre>
      </li>
    </ol>
    <div class="packt_tip">
      <p class="Tip-Within-Bullet--PACKT-">To prevent any data loss during your analytics collection, consider covering failure cases as well, such as adding multiple <code class="Code-In-Text--PACKT-">checkoutFailed</code> events that cover various failure cases.</p>
    </div>
    <p class="normal">Now, we are ready to <a id="_idIndexMarker1557"/>see the analytics in action:</p>
    <p class="list">Run your app.</p>
    <p class="list">On the POS page, click <a id="_idIndexMarker1558"/>on the <strong class="screen-text">Checkout</strong> button.</p>
    <p class="list">In Google Analytics, observe the <strong class="screen-text">REAL-TIME</strong> | <strong class="screen-text">Events</strong> tab to see events as they occur.</p>
    <p class="list">After 5-10 minutes, the events will also show up under the <strong class="screen-text">BEHAVIOR</strong> | <strong class="screen-text">Events</strong> tab, as shown:</p>
    <figure class="mediaobject"><img alt="" src="../Images/B14094_14_23.png"/></figure>
    <p class="packt_figref">Figure 14.23: Google Analytics Top Events</p>
    <p class="normal">Using custom events, you can<a id="_idIndexMarker1559"/> keep track of various nuanced user behaviors happening on your site. By collecting <code class="Code-In-Text--PACKT-">checkoutInitiated</code> and <code class="Code-In-Text--PACKT-">checkoutCompleted</code> events, you can calculate a conversion rate of how many initiated checkouts are taken<a id="_idIndexMarker1560"/> to completion. In the case of a point-of-sale system, that rate should be very high; otherwise, it means you may have systematic issues in place.</p>
    <h2 class="title" id="_idParaDest-481">Advanced analytics events</h2>
    <p class="normal">It is possible to collect additional metadata along with each event, such as the payment amount or type, when checkout is initiated, or <code class="Code-In-Text--PACKT-">transactionId</code> when checkout is completed.</p>
    <p class="normal">To work with these<a id="_idIndexMarker1561"/> more advanced features, I would recommend that you check out <code class="Code-In-Text--PACKT-">angulartics2</code>, which can be found at <a href="https://www.npmjs.com/package/angulartics2"><span class="url">https://www.npmjs.com/package/angulartics2</span></a>. <code class="Code-In-Text--PACKT-">angulartics2</code> is a vendor-agnostic analytics library for Angular that can enable unique and granular event tracking needs using popular vendors, such as Google Tag Manager, Google Analytics, Adobe, Facebook, Baidu and more, as highlighted on the tool’s home page, shown here:</p>
    <figure class="mediaobject"><img alt="" src="../Images/B14094_14_24.png"/></figure>
    <p class="packt_figref">Figure 14.24: Angulartics2</p>
    <p class="normal"><code class="Code-In-Text--PACKT-">angulartics2</code> integrates with the Angular router and the UI router, with the ability to implement custom rules and exceptions <a id="_idIndexMarker1562"/>on a route-per-route basis. The library makes it easy to implement custom events and enables metadata tracking with data binding. </p>
    <p class="normal">Check out the following example:</p>
    <pre class="programlisting"><code class="hljs dust"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">angulartics2On</span>=<span class="hljs-string">"click"</span> <span class="hljs-attr">angularticsEvent</span>=<span class="hljs-string">"DownloadClick"</span>
  <span class="hljs-attr">angularticsCategory</span>=<span class="hljs-string">"</span></span></span><span class="hljs-template-variable">{{ song.name }</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">}"</span>
  [<span class="hljs-attr">angularticsProperties</span>]=<span class="hljs-string">"</span></span></span><span class="hljs-template-variable">{label: 'Fall Campaign'}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</span></code></pre>
    <p class="normal">We can keep track of a <code class="Code-In-Text--PACKT-">click</code> event named <code class="Code-In-Text--PACKT-">DownloadClick</code>, which would have a <code class="Code-In-Text--PACKT-">category</code> and a <code class="Code-In-Text--PACKT-">label</code> attached to it for rich event tracking within Google Analytics.</p>
    <p class="normal">With advanced analytics under your belt, you can use actual usage data to inform how you improve or host your app. This topic concludes a journey that started by creating pencil-drawn mockups at the beginning of this book, covering a wide variety of tools, techniques, and technologies that a full-stack web developer must be familiar with in today’s web in order to succeed. We dove deep into Angular, Angular Material, Docker, and automation in general to make you the most productive developer you can be, delivering the highest <a id="_idIndexMarker1563"/>quality web app, while juggling a lot of complexity along the way. Good luck out there!</p>
    <h1 class="title" id="_idParaDest-482">Summary</h1>
    <p class="normal">In this chapter, you have rounded out your knowledge of developing web apps. You learned how to work with Google Tag Manager and Google Analytics to capture page views of your Angular application. Using high-level metrics, we went over how you can calculate the cost of your infrastructure per user. We then investigated the nuances of the effect that high availability and scaling can have on your budget. We covered the load testing of complex user workflows to estimate how many users any given server can host concurrently. Using this information, we calculated a target server utilization to fine-tune your scaling settings.</p>
    <p class="normal">All of our pre-release calculations were mostly estimates and educated guesses. We went over the kinds of metrics and custom events you can use to measure the actual use of your application. When your application goes live and you start gathering these metrics, you can update your calculations to gain a better understanding of the viability and the affordability of your infrastructure.</p>
    <p class="normal">Congratulations! You have completed your journey. I hope you enjoyed it! Feel free to use this book as a reference, including the appendices.</p>
    <p class="normal">Follow me on Twitter <code class="Code-In-Text--PACKT-">@duluca</code> and stay tuned to <a href="https://expertlysimple.io"><span class="url">https://expertlysimple.io</span></a> for updates.</p>
    <h1 class="title" id="_idParaDest-483">Further reading</h1>
    <ul>
      <li class="list">Google Analytics and Google Tag Manager Blog, by Simo Ahava: <a href="https://www.simoahava.com"><span class="url">https://www.simoahava.com</span></a>.</li>
    </ul>
    <h1 class="title" id="_idParaDest-484">Questions</h1>
    <p class="normal">Answer the following questions as best as you can to ensure that you've understood the key concepts from this chapter without Googling. Do you need help answering the questions? See <em class="italics">Appendix D</em>, <em class="italics">Self-Assessment Answers</em> online at <a href="https://static.packt-cdn.com/downloads/9781838648800_Appendix_D_Self-Assessment_Answers.pdf"><span class="url">https://static.packt-cdn.com/downloads/9781838648800_Appendix_D_Self-Assessment_Answers.pdf</span></a> or visit <a href="https://expertlysimple.io/angular-self-assessment"><span class="url">https://expertlysimple.io/angular-self-assessment</span></a>.</p>
    <ol>
      <li class="list" value="1">What are the benefits of load testing?</li>
      <li>What are some of the considerations as regards reliable cloud scaling?</li>
      <li>What is the value of measuring user behavior? </li>
    </ol>
  </div>
</body></html>