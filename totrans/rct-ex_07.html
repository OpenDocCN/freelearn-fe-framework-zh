<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;React Addons"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. React Addons</h1></div></div></div><p>In the previous chapter, we learned to use React on the server side. We understood pre-rendering of the React components and changes in the component life cycle when using React on server. We also saw how to use server-side API of React using Express.js.</p><p>In this chapter, we will look at React addons—utility packages that are not a part of React core, however, they make development process fun and enjoyable. We will learn to use immutability helpers, cloning of components, and test utilities in this chapter. We will not be covering other addons such as <code class="literal">Animation</code>, <code class="literal">Perf</code>, and <code class="literal">PureRenderMixin</code>. These addons will be covered in the following chapters.</p><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Getting started with React addons</li><li class="listitem" style="list-style-type: disc">Immutability helpers</li><li class="listitem" style="list-style-type: disc">Cloning React components</li><li class="listitem" style="list-style-type: disc">Test helpers</li></ul></div><div class="section" title="Getting started with Addons"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec60"/>Getting started with Addons</h1></div></div></div><p>After <a id="id173" class="indexterm"/>completing the previous project about using React on server side, Mike's team got some free time before starting the next project. Mike decided to utilize this time by learning about <a id="id174" class="indexterm"/>React addons.</p><p>"Shawn, we got some free time. Let's use it to get started with React addons."</p><p>"What are React addons? Are they related to React core library?" Shawn asked.</p><p>"React addons are utility modules that are not a part of the React core library. However, they are blessed by the React team. In future, some of them might be included in the React core. These libraries provide helpers for writing immutable code, utilities for testing React apps, and ways to measure and improve the performance of React apps." explained Mike.</p><p>"Each addon has its <a id="id175" class="indexterm"/>own npm package, making it to simple to use. For example, to use the <a id="id176" class="indexterm"/>Update addon, we need to install and require its npm package."</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  $ npm install  react-addons-update --save</strong></span>

<span class="strong"><strong>  // src/App.js</strong></span>
<span class="strong"><strong>  import Update from 'react-addons-update';</strong></span>
</pre></div><div class="section" title="Immutability helpers"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec08"/>Immutability helpers</h2></div></div></div><p>"Shawn, as <a id="id177" class="indexterm"/>we are learning about addons, let's add the sorting feature to <a id="id178" class="indexterm"/>our app so that the users can sort the books by their titles. I have already added the required markup for it."</p><div class="mediaobject"><img src="graphics/4730_07_01.jpg" alt="Immutability helpers"/></div><p>"Can you try writing the code for sorting when a user clicks on the <span class="strong"><strong>Title</strong></span> heading?" Mark asked.</p><p>"Here it is. I introduced the sorting state to indicate the direction of sorting—ascending or descending."</p><div class="informalexample"><pre class="programlisting">  // Updated getInitialState function of App component
  // src/App.js

  getInitialState(){
    return { books: [],
             totalBooks: 0,
             searchCompleted: false,
             searching: false,
             sorting: 'asc' };
  }</pre></div><p>"When the user clicks on <span class="strong"><strong>Title</strong></span>, it will sort the books stored in the existing state in ascending or descending order using the sort-by npm package and update the state with the sorted books."</p><div class="informalexample"><pre class="programlisting">import sortBy from 'sort-by';

_sortByTitle() {
    let sortByAttribute = this.state.sorting === 'asc' ? "title" : "-title";
    let unsortedBooks = this.state.books;
    let sortedBooks = unsortedBooks.sort(sortBy(sortByAttribute));
    this.setState({ books: sortedBooks, 
                    sorting: this._toggleSorting() });
  },

  _toggleSorting() {
    return this.state.sorting === 'asc' ? 'desc' : 'asc';
  }</pre></div><p>"Shawn, this is functional; however, it's not following the React way. React assumes that the state object is immutable. Here we are using reference to the books from the existing state when we are <a id="id179" class="indexterm"/>assigning value to <code class="literal">unsortedBooks</code>."</p><div class="informalexample"><pre class="programlisting">let unsortedBooks = this.state.books;</pre></div><p>"Later, we are mutating <a id="id180" class="indexterm"/>
<code class="literal">unsortedBooks</code> into <code class="literal">sortedBooks</code>; however, as a side-effect, we are also mutating the current value of <code class="literal">this.state</code>."</p><div class="informalexample"><pre class="programlisting">_sortByTitle() {
    let sortByAttribute = this.state.sorting === 'asc' ? "title" : "-title";
    let unsortedBooks = this.state.books;
    console.log("Before sorting :");
    console.log(this.state.books[0].title);
    let sortedBooks = unsortedBooks.sort(sortBy(sortByAttribute));
    console.log("After sorting :");
    console.log(this.state.books[0].title);
    // this.setState({ books: sortedBooks, 
                       sorting: this._toggleSorting() });

  },</pre></div><div class="mediaobject"><img src="graphics/4730_07_02.jpg" alt="Immutability helpers"/></div><p>"As you can see, even if we commented call to this.<code class="literal">setState</code>, our current state is still mutated." Mark explained.</p><p>"This can be easily fixed using <code class="literal">Object.assign</code> from ES6. We can simply create a new array and copy the current value of <code class="literal">this.state.books</code> in it. We can then sort the new array and call <a id="id181" class="indexterm"/>
<code class="literal">setState</code> with the new sorted array." informed Shawn.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note09"/>Note</h3><p>The <code class="literal">Object.assign</code> method copies the values of all the enumerable properties from <a id="id182" class="indexterm"/>multiple source objects in a target. More details can be found at the following: <a class="ulink" href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Object/assign">https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Object/assign</a>.</p></div></div><div class="informalexample"><pre class="programlisting">_sortByTitle() {
    let sortByAttribute = this.state.sorting === 'asc' ? "title" : "-title";
    let unsortedBooks = Object.assign([], this.state.books);
    console.log("Before sorting :");
    console.log(this.state.books[0].title);
    let sortedBooks = unsortedBooks.sort(sortBy(sortByAttribute));
    console.log("After sorting :");
    console.log(this.state.books[0].title);
    this.setState({ books: sortedBooks, 
                    sorting: this._toggleSorting() });
  }</pre></div><div class="mediaobject"><img src="graphics/4730_07_03.jpg" alt="Immutability helpers"/></div><p>"Yes. This works. But the <code class="literal">Object.assign</code> method will make a shallow copy of <code class="literal">this.state.books</code>. It will create a new <code class="literal">unsortedBooks</code> object, however, it will still use the same references from <code class="literal">this.state.books</code> in <code class="literal">unsortedBooks</code>. Let's say, for some reason, we want the titles of all books in uppercase <a id="id183" class="indexterm"/>letters, then we may accidently mutate <a id="id184" class="indexterm"/>
<code class="literal">this.state</code> too," Mike explained.</p><div class="informalexample"><pre class="programlisting">_sortByTitle() {
    let sortByAttribute = this.state.sorting === 'asc' ? "title" : "-title";
    let unsortedBooks = Object.assign([], this.state.books);
    unsortedBooks.map((book) =&gt; book.title = book.title.toUpperCase());
    console.log("unsortedBooks");
    console.log(unsortedBooks[0].title);
    console.log("this.state.books");
    console.log(this.state.books[0].title); 
  }</pre></div><div class="mediaobject"><img src="graphics/4730_07_04.jpg" alt="Immutability helpers"/></div><p>"As you can see, even after using <code class="literal">Object.assign</code>, <code class="literal">this.state.books</code> was still mutated. Actually, this has nothing to do with React as such. It is due to the way JavaScript passes references of arrays and objects around. However, due to this, if we have arrays and objects in our deeply nested state, it becomes hard to prevent mutations." Mike further explained.</p><p>"Do we always have to perform a deep copy of the state object to be on the safer side?" Shawn asked.</p><p>"Well, deep copies can be expensive and sometimes hard to achieve with deeply nested state. Fortunately, React provides the Update addon with immutability helpers, which we can use to solve this issue." added Mike.</p><p>"While using immutability helpers, we need to answer the following three questions:"</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">What needs to be changed?</li><li class="listitem" style="list-style-type: disc">Where it needs to be changed?</li><li class="listitem" style="list-style-type: disc">How it needs to be changed?</li></ul></div><p>"In this case, we need to change the <code class="literal">this.state</code> to display the sorted books."</p><p>"The second question is that where should the mutation happen inside <code class="literal">this.state</code>? The mutation should happen in <code class="literal">this.state.books</code>."</p><p>"The third question is that how should the mutation happen? Are we going to delete something or add any new element or restructure existing elements? In this case, we want to sort the elements as per some criterion."</p><p>"The Update addon accepts two parameters. The first parameter is the object that we want to mutate. The second parameter tells us where and how should the mutation take place in the first <a id="id185" class="indexterm"/>parameter. In this case, we want to mutate <code class="literal">this.state</code>. In <code class="literal">this.state</code>, we want to update the books with the sorted books. Therefore, our code will look similar to the following:"</p><div class="informalexample"><pre class="programlisting">Update(this.state, { books: { sortedBooks }})</pre></div></div><div class="section" title="Available commands"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec09"/>Available commands</h2></div></div></div><p>The Update addon <a id="id186" class="indexterm"/>provides different commands to perform the mutations in arrays and objects. The syntax of these commands is inspired by MongoDB's query language.</p><p>"Most of these commands operate on array objects allowing us to push in an array or unshift an element from the array. It also supports replacing the target entirely using the set command. Other than this, it also provides the merge command to merge new keys with an existing object." Mike explained.</p><p>"Shawn, my favorite command provided by this addon is apply. It takes a function and applies that function to the current value of the target that we want to modify. It gives more flexibility to make changes in the complex data structures. It's also a hint for your next task. Try to use it to sort the books by title without mutating." Mike challenged.</p><p>"Sure. Here you go," said Shawn.</p><div class="informalexample"><pre class="programlisting">    // src/App.js

import Update from 'react-addons-update';
  
_sortByTitle() {
  let sortByAttribute = this.state.sorting === 'asc' ? "title" : "-title";
  console.log("Before sorting");
  console.log(this.state.books[0].title);
  let newState = Update(this.state,
                        { books: { $apply: (books) =&gt; { return books.sort(sortBy(sortByAttribute)) } },
                          sorting: { $apply: (sorting) =&gt; { return sorting === 'asc' ? 'desc' : 'asc' } } });
  console.log("After sorting");
  console.log(this.state.books[0].title);
  this.setState(newState);
  }</pre></div><div class="mediaobject"><img src="graphics/4730_07_05.jpg" alt="Available commands"/></div><p>"Perfect, Shawn. Using <a id="id187" class="indexterm"/>the Update addon makes it very easy to manage complex state without actually mutating it."</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip05"/>Tip</h3><p>Check <a class="ulink" href="https://facebook.github.io/immutable-js/docs/">https://facebook.github.io/immutable-js/docs/</a> for a complete solution for <a id="id188" class="indexterm"/>using immutable data structures in JavaScript.</p></div></div></div></div></div>
<div class="section" title="Cloning components"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec61"/>Cloning components</h1></div></div></div><p>"Shawn, props are also immutable in React. In most of the cases, the child component just uses props passed by the parent component. However, sometimes we want to extend the incoming props with some new data before rendering the child component. It's a typical use case to update styles and CSS classes. React provides an addon to clone a component and <a id="id189" class="indexterm"/>extending its props. It's called the <span class="strong"><strong>cloneWithProps</strong></span> <a id="id190" class="indexterm"/>addon." said Mike.</p><p>"Mike, that addon is <a id="id191" class="indexterm"/>deprecated. I had looked at it in the past and React has deprecated it. It also has lot of issues related to refs of the child component not getting passed to the newly-cloned child components," Shawn informed.</p><p>"True. However, React also has a top-level <code class="literal">React.cloneElement</code> API method, which allows us to clone and extend a component. It has a very simple API and it can be used instead of the cloneWithProps addon." Mike explained.</p><div class="informalexample"><pre class="programlisting">React.cloneElement(element, props, …children);</pre></div><p>"This method can be used to clone the given element and merge the new props with existing props. It replaces existing children with new children. Therefore, we have to keep this in mind while dealing with the child components."</p><p>"The <code class="literal">cloneElement</code> function also passes ref of the old child component to the newly-cloned component. Therefore, if we have any callbacks based on refs, they will continue to work even after cloning."</p><p>"Shawn, here is your next challenge. We show listing of books in our app. In fact, in all of our apps, we show the listing of other things such as products, items, and so on. We want to show the rows with alternate colors in all of these listings instead of just white background. As the code for this feature will be the same across all the apps, I am thinking about creating a separate component that will accept rows as input and render them with alternate colors. Such components can be used in all of our apps. I think that you can make use of <code class="literal">React.cloneElement</code> for this." Mike explained the next task.</p><p>"Sounds like a good idea to <a id="id192" class="indexterm"/>extract this as a separate component. We need it in almost all the apps. Our QA was complaining about the lack of colors in our search app yesterday." Shawn remembered.</p><p>"Let's add some alternate colors then." Mike chuckled.</p><p>"First, let's see how we are displaying books currently."</p><div class="informalexample"><pre class="programlisting">// src/App.js

render() {
    let tabStyles = {paddingTop: '5%'};
    return (
      &lt;div className='container'&gt;
        &lt;div className="row" style={tabStyles}&gt;
          &lt;div className="col-lg-8 col-lg-offset-2"&gt;
            &lt;h4&gt;Open Library | Search any book you want!&lt;/h4&gt;
            &lt;div className="input-group"&gt;
              &lt;input type="text" className="form-control" placeholder="Search books..." ref='searchInput'/&gt;
              &lt;span className="input-group-btn"&gt;
                &lt;button className="btn btn-default" type="button" onClick={this._performSearch}&gt;Go!&lt;/button&gt;
              &lt;/span&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        {this._displaySearchResults()}
      &lt;/div&gt;
    );
  },

_displaySearchResults() {
    if(this.state.searching) {
      return &lt;Spinner /&gt;;
    } else if(this.state.searchCompleted) {
      return (
        &lt;BookList
            searchCount={this.state.totalBooks}
            _sortByTitle={this._sortByTitle}&gt;
          {this._renderBooks()}
        &lt;/BookList&gt;
      );
    }
  } 

_renderBooks() {
    return this.state.books.map((book, idx) =&gt; {
      return (
        &lt;BookRow key={idx}
                 title={book.title}
                 author_name={book.author_name}
                 edition_count={book.edition_count} /&gt;
      );
    })
  },

})
  }</pre></div><p>"The <code class="literal">BookList</code> <a id="id193" class="indexterm"/>component just renders the rows passed to it as it is using <code class="literal">this.props.children</code>."</p><div class="informalexample"><pre class="programlisting">// BookList component

var BookList = React.createClass({
  render() {
    return (
      &lt;div className="row"&gt;
        &lt;div className="col-lg-8 col-lg-offset-2"&gt;
          &lt;span className='text-center'&gt;
            Total Results: {this.props.searchCount}
          &lt;/span&gt;
          &lt;table className="table table-stripped"&gt;
            &lt;thead&gt;
              &lt;tr&gt;
                &lt;th&gt;&lt;a href="#" onClick={this.props._sortByTitle}&gt;Title&lt;/a&gt;&lt;/th&gt;
                &lt;th&gt;Author&lt;/th&gt;
                &lt;th&gt;No. of Editions&lt;/th&gt;
              &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;
              <span class="strong"><strong>{this.props.children}</strong></span>
            &lt;/tbody&gt;
          &lt;/table&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    );
  }
});</pre></div><p>"Mike, I am naming the component <code class="literal">RowAlternator</code>. The <code class="literal">RowAlternator</code> component will get the dynamic array of children rows and it will render them with alternate colors. We can pass multiple <a id="id194" class="indexterm"/>colors to <code class="literal">RowAlternator</code> too. In this way, the client code using this component can control the colors that they want to use as alternate colors."</p><p>"Sounds good, Shawn. I think this much API is enough for now."</p><div class="informalexample"><pre class="programlisting">// RowAlternator component

import React from 'react';

var RowAlternator = React.createClass({
  propTypes: {
    firstColor: React.PropTypes.string,
    secondColor: React.PropTypes.string
  },

  render() {
    return (
      &lt;tbody&gt;
        { this.props.children.map((row, idx) =&gt; {
            if (idx %2 == 0) {
              return React.cloneElement(row, { style: { background: this.props.firstColor }});
            } else {
              return React.cloneElement(row, { style: { background: this.props.secondColor }});
            }
          })
        }
      &lt;/tbody&gt;
    )
  }
});

module.exports = RowAlternator;</pre></div><p>"As we don't know how many children elements we will get in <code class="literal">RowAlternator</code>, we will just iterate over all of them and set style with alternate colors. We are also using <code class="literal">React.cloneElement</code> <a id="id195" class="indexterm"/>here to clone the passed child and extend its style prop with appropriate background color."</p><p>"Let's change our <code class="literal">BookList</code> component now in order to use <code class="literal">RowAlternator</code>."</p><div class="informalexample"><pre class="programlisting">// BookList component

import RowAlternator from '../src/RowAlternator';

var BookList = React.createClass({
  render() {
    return (
      &lt;div className="row"&gt;
        &lt;div className="col-lg-8 col-lg-offset-2"&gt;
          &lt;span className='text-center'&gt;
            Total Results: {this.props.searchCount}
          &lt;/span&gt;
          &lt;table className="table table-stripped"&gt;
            &lt;thead&gt;
              &lt;tr&gt;
                &lt;th&gt;&lt;a href="#" onClick={this.props._sortByTitle}&gt;Title&lt;/a&gt;&lt;/th&gt;
                &lt;th&gt;Author&lt;/th&gt;
                &lt;th&gt;No. of Editions&lt;/th&gt;
              &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;RowAlternator firstColor="white" secondColor="lightgrey"&gt;
              {this.props.children}
            &lt;/RowAlternator&gt;
          &lt;/table&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    );
  }
});</pre></div><p>"We are all set. The listing now shows alternate colors as we wanted, as shown in the following image:"</p><div class="mediaobject"><img src="graphics/4730_07_06.jpg" alt="Cloning components"/></div><p>"Perfect, Shawn. As you already noticed, using <code class="literal">React.cloneElement</code> makes sense when we are building a <a id="id196" class="indexterm"/>component with dynamic children, where we don't have control on the render method of these children, but want to extend their props based on some criteria." Mike was happy.</p><div class="section" title="Helpers for testing React apps"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec10"/>Helpers for testing React apps</h2></div></div></div><p>"Shawn, we have <a id="id197" class="indexterm"/>not added any tests for our app yet, however, the time has come to start slowly adding test coverage. With the Jest library and Test Utilities addon, it becomes very easy to set up and start testing the React apps." Mark explained the next task.</p><p>"I have heard about Jest. Isn't it a testing library by Facebook?" Shawn asked.</p><div class="section" title="Setting up Jest"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec01"/>Setting up Jest</h3></div></div></div><p>"Yes. It's built on <a id="id198" class="indexterm"/>top of Jasmine. It's very easy to set up. First, we <a id="id199" class="indexterm"/>have to install the <code class="literal">jest-cli</code> and <code class="literal">babel-jest</code> packages."</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>npm install jest-cli --save-dev</strong></span>
<span class="strong"><strong>npm install babel-jest –-save-dev</strong></span>
</pre></div><p>"After that, we need to configure <code class="literal">package.json</code>, as follows:"</p><div class="informalexample"><pre class="programlisting">{
 ...
 "scripts": {
   "test": "jest"
 },

 "jest": {
   "scriptPreprocessor": "&lt;rootDir&gt;/node_modules/babel-jest",
    "unmockedModulePathPatterns": [
         "&lt;rootDir&gt;/node_modules/react",
         "&lt;rootDir&gt;/node_modules/react-dom",
         "&lt;rootDir&gt;/node_modules/react-addons-test-utils",
         "&lt;rootDir&gt;/node_modules/fbjs"
     ],
   "testFileExtensions": ["es6", "js", "jsx"],
   "moduleFileExtensions": ["js", "json", "es6"]
 }
 ...
}</pre></div><p>"By default, Jest mocks all modules, however, here we are telling Jest not to mock React and the related <a id="id200" class="indexterm"/>libraries. We are also specifying the extensions for our test file that will be identified by Jest as test files."</p><p>"Create a <code class="literal">__test__</code> folder, where we will be adding our tests. Jest will run the tests from files in this folder. Let's <a id="id201" class="indexterm"/>add an empty file too. We have to make sure that the file should end with <code class="literal">-test.js</code> so that Jest will pick up it to run the tests." Mike explained.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mkdir __test__</strong></span>
<span class="strong"><strong>touch __test__/app-test.js</strong></span>
</pre></div><p>"Now let's verify that we can run the tests from the command line."</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ npm test</strong></span>

<span class="strong"><strong>&gt; react-addons-examples@0.0.1 test /Users/prathamesh/Projects/sources/reactjs-by-example/chapter7</strong></span>
<span class="strong"><strong>&gt; jest</strong></span>

<span class="strong"><strong>Using Jest CLI v0.7.1</strong></span>
<span class="strong"><strong>PASS __tests__/app-test.js (0.007s)</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note10"/>Note</h3><p>You should see an output that is similar to the preceding output. It may change based on the Jest <a id="id202" class="indexterm"/>version. Consult <a class="ulink" href="https://facebook.github.io/jest/docs/getting-started.html">https://facebook.github.io/jest/docs/getting-started.html</a> to set up Jest, in case of any issues.</p></div></div><p>"Shawn, we are all set with Jest. It's time to start writing the tests now. We will test whether the top-level <code class="literal">App</code> component gets mounted correctly. However, first, we need to understand a bit more about using Jest," said Mike.</p><p>"By default, Jest <a id="id203" class="indexterm"/>mocks all the modules that are required in a test file. Jest does this to isolate the module that is under test from all the other modules. In this <a id="id204" class="indexterm"/>case, we want to test the <code class="literal">App</code> component. If we just require it, then Jest will provide a mocked version of <code class="literal">App</code>."</p><div class="informalexample"><pre class="programlisting">// app-test.js
   
   const App = require('App'); // Mocked by Jest</pre></div><p>"As we we want to test the <code class="literal">App</code> component itself, we need to specify Jest not to mock it. Jest provides the <code class="literal">jest.dontmock()</code> function for this purpose."</p><div class="informalexample"><pre class="programlisting">// app-test.js

jest.dontmock('./../src/App'); // Tells Jest not to mock App.
const App = require('App');</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note11"/>Note</h3><p>Check <a class="ulink" href="https://facebook.github.io/jest/docs/automatic-mocking.html">https://facebook.github.io/jest/docs/automatic-mocking.html</a> for <a id="id205" class="indexterm"/>more details about automatic mocking feature of Jest.</p></div></div><p>"Next up, we will add imports for the React and TestUtils addon."</p><div class="informalexample"><pre class="programlisting">// app-test.js

jest.dontMock('../src/App');
const App = require('../src/App');

import React from 'react';
import ReactDOM from 'react-dom';
import TestUtils from 'react-addons-test-utils';</pre></div><p>"The TestUtils addon provides utility functions to render the components, finding sub-components in rendered components and mimicking events on the rendered component. It helps in testing both the structure and behavior of the React components." Mike added.</p></div></div><div class="section" title="Testing structure of React components"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec11"/>Testing structure of React components</h2></div></div></div><p>"We will <a id="id206" class="indexterm"/>start with the <code class="literal">renderIntoDocument</code> function. This function renders the given component into a detached DOM node in the document. It returns <code class="literal">ReactComponent</code>, which can be used for further testing."</p><div class="informalexample"><pre class="programlisting">// app-test.js

describe('App', () =&gt; {
  it('mounts successfully', () =&gt; {
    let app = TestUtils.renderIntoDocument(&lt;App /&gt;);
    expect(app.state.books).toEqual([]);
    expect(app.state.searching).toEqual(false);
  })
});</pre></div><p>"We rendered the <code class="literal">App</code> component in DOM and asserted that initially books and searching state are being set correctly." Mike explained.</p><p>"Mike, this is awesome. We are not testing real DOM, but testing the React components instead."</p><p>"Yes. The TestUtils addon comes with finder methods that can be used to find the child components in a given component tree. They are useful to find the child components such as input box and submit button and simulate click events or change events."</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">findAllInRenderedTree(tree, predicate function)</code>: This is useful for finding all the components in a given tree that returns the truth value for the predicate function.</li><li class="listitem" style="list-style-type: disc"><code class="literal">scryRenderedDOMComponentsWithClass(tree, className)</code>: This is useful for finding all the DOM components with a given class name.</li><li class="listitem" style="list-style-type: disc"><code class="literal">findRenderedDOMComponentWithClass(tree, className)</code>: Instead of finding all the DOM components with a given class, this method expects that only one such component is present. It throws an exception if there are multiple components with a given class name.</li><li class="listitem" style="list-style-type: disc"><code class="literal">scryRenderedDOMComponentsWithTag(tree, tagName)</code>: It's similar to finding the DOM components with the class name, however, instead of class name, it finds the components based on a given tag name.</li><li class="listitem" style="list-style-type: disc"><code class="literal">findRenderedDOMComponentWithTag(tree, tagName)</code>: Instead of finding all the components with a given tag, it expects that only one such component is present. It also throws exception when more than one such components exists.</li><li class="listitem" style="list-style-type: disc"><code class="literal">scryRenderedComponentsWithType(tree, componentType)</code>: This method finds all the components with a given type. It's useful to find all the composite components created by the user.</li><li class="listitem" style="list-style-type: disc"><code class="literal">findRenderedComponentWithType (tree, componentType)</code>: This is similar <a id="id207" class="indexterm"/>to all the <a id="id208" class="indexterm"/>previous finder methods. It raises exception if more than one component with a given type is present.</li></ul></div></div><div class="section" title="Testing behavior of React components"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec12"/>Testing behavior of React components</h2></div></div></div><p>"Let's <a id="id209" class="indexterm"/>use these functions to <a id="id210" class="indexterm"/>assert that the search for books starts when a user enters a search term and clicks the <span class="strong"><strong>Submit</strong></span> button. We will simulate the event of entering search term by the user." said Mike.</p><div class="informalexample"><pre class="programlisting">// app-test.js

it('starts searching when user enters search term and clicks submit', () =&gt; {
    let app = TestUtils.renderIntoDocument(&lt;App /&gt;);

    let inputNode = TestUtils.findRenderedDOMComponentWithTag(app, 'input');
    inputNode.value = "Dan Brown";
    TestUtils.Simulate.change(inputNode);
    let submitButton = TestUtils.findRenderedDOMComponentWithTag(app, 'button');
    TestUtils.Simulate.click(submitButton);
    expect(app.state.searching).toEqual(true);
    expect(app.state.searchCompleted).toEqual(false);
  })</pre></div><p>"We render the <code class="literal">App</code> component, find the input node, set the value of the input node to the search term, and simulate the change event using <code class="literal">TestUtils.Simulate()</code>. This function simulates the given event dispatch on a DOM node. The <code class="literal">Simulate</code> function has a method for every event that React understands. Therefore, we can simulate all events such as change, click, and so on. We can test the user behavior using this method," Mike explained.</p><p>"Got it. Therefore, after changing the search term, we click the submit button and verify that the state gets updated as per our expectations," informed Shawn.</p><p>"Yes, Shawn. Now, can you check whether the Spinner is shown once the user clicks the <span class="strong"><strong>Submit</strong></span> button? You can use one of the finder method that we discussed earlier." Mike explained the next task.</p><p>"Yes. Once the component state changes after clicking the <span class="strong"><strong>Submit</strong></span> button, we can search the rendered component tree to see whether the Spinner component is present or not."</p><div class="informalexample"><pre class="programlisting">// app-test.js

// __tests__/app-test.js

import Spinner from './../src/Spinner';

it('starts searching when user enters search term and clicks submit', () =&gt; {
    let app = TestUtils.renderIntoDocument(&lt;App /&gt;);
    let inputNode = TestUtils.findRenderedDOMComponentWithTag(app, 'input');
    inputNode.value = "Dan Brown";
    TestUtils.Simulate.change(inputNode);
    let submitButton = TestUtils.findRenderedDOMComponentWithTag(app, 'button');
    TestUtils.Simulate.click(submitButton);
    expect(app.state.searching).toEqual(true);
    expect(app.state.searchCompleted).toEqual(false);
<span class="strong"><strong>    let spinner = TestUtils.findRenderedComponentWithType(app, Spinner);</strong></span>
<span class="strong"><strong>    expect(spinner).toBeTruthy();</strong></span>
  }),</pre></div><p>"We are using <code class="literal">TestUtils.findRenderedComponentWithType</code> here to check whether Spinner is present in the tree rendered by the <code class="literal">App</code> component or not. However, before adding this assertion, we need to import the Spinner component at the top of the test file as <code class="literal">findRenderedComponentWithType</code> expects a second argument to be a React component."</p><p>"Excellent, Shawn. As <a id="id211" class="indexterm"/>you can see, the testing behavior of the React component becomes very easy with the <code class="literal">TestUtils.Simulate</code> and <code class="literal">finder</code> methods." Mike explained.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note12"/>Note</h3><p>Note that we have not added a test to asynchronously load the books from Open Library API as it is out of the scope of this chapter.</p></div></div></div><div class="section" title="Shallow rendering"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec13"/>Shallow rendering</h2></div></div></div><p>"Shawn, TestUtils also provides one more way to test the components in an isolated fashion using the Shallow <a id="id212" class="indexterm"/>rendering. Shallow rendering allows us render the top-level component and assert the facts about the return value of it's render method. It does not render children components or instantiate them. Therefore, our tests are not affected by the behavior of the children components. Shallow rendering also does not require a DOM, unlike the previous methods, where we rendered the component in a detached DOM," Mike explained.</p><div class="informalexample"><pre class="programlisting">let renderer = TestUtils.createRenderer();</pre></div><p>"This creates a shallow renderer object, in which we will render the component that we want to test. Shallow renderer has a render method similar to <code class="literal">ReactDOM.render</code>, which can be used to render the component."</p><div class="informalexample"><pre class="programlisting">let renderer = TestUtils.createRenderer();
let result = renderer.render(&lt;App /&gt;);</pre></div><p>"After render method is <a id="id213" class="indexterm"/>called, we should call <code class="literal">renderer.getRenderedOutput</code>, which returns the shallowly rendered output of rendering the component. We can start asserting facts about the component on the output of <code class="literal">getRenderedOutput</code>."</p><p>"Let's see the output we get from <code class="literal">getRenderedOutput</code>."</p><div class="informalexample"><pre class="programlisting">let renderer = TestUtils.createRenderer();
let result = renderer.render(&lt;App /&gt;);
result = renderer.getRenderOutput();
console.log(result);

// Output of console.log(result)

Object {
  '$$typeof': Symbol(react.element),
  type: 'div',
  key: null,
  ref: null,
  props: 
   Object {
     className: 'container',
     children: Array [ [Object], undefined ] },
  _owner: null,
  _store: Object {} }</pre></div><p>"As you can see, based on the rendered output, we can assert the facts about props of the current component. However, if we want to test anything about children component, we need to explicitly reach out to them through <code class="literal">this.props.children[0].props.children[1].props.children</code>."</p><p>"This makes it hard to test the behavior of the children components using shallow rendering. However, it's useful for testing small components in an isolated way as it does not get affected by children component due to shallow rendering," said Mike.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec62"/>Summary</h1></div></div></div><p>In this chapter, we started with understanding the React addons and how to use them. We used immutability helpers and test utility functions provided by the addons. We also looked into how to clone the components.</p><p>In the next chapter, we will make our React app more performant. You will be learning about addons that will improve the performance of the React apps. Specifically, you will learn how to measure the performance of our apps and how React can make faster updates without changing most of the UI.</p><p>Let's make our React apps faster!</p></div></body></html>