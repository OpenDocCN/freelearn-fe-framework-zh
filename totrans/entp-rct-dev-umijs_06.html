<html><head></head><body>
		<div id="_idContainer041">
			<h1 id="_idParaDest-52"><a id="_idTextAnchor056"/>Chapter 4: Error Handling, Authentication, and Route Protection</h1>
			<p>We need to implement error handling and security measures in our interfaces to ensure that the quality and user experience of the application is good.</p>
			<p>In this chapter, we'll modify the login page created in <a href="B18503_01_Final_JM_ePub.xhtml#_idTextAnchor014"><em class="italic">Chapter 1</em></a>,<em class="italic"> Environment Setup and Introduction to UmiJS</em> and configure the default HTML template for our application. You'll learn how to store and globally access data by configuring your application's initial state. Next, you'll learn how to block unauthorized access using the Umi <strong class="source-inline">plugin-access</strong>. Finally, you'll learn how to handle HTTP error responses and display feedback messages by configuring Umi requests.</p>
			<p>In this chapter, we'll cover the following main topics:</p>
			<ul>
				<li>Modifying the login page and defining the HTML template</li>
				<li>Storing and globally accessing user information</li>
				<li>Protecting application routes based on user roles</li>
				<li>Handling HTTP error responses</li>
			</ul>
			<p>By the end of this chapter, you'll have learned how to configure and use <strong class="source-inline">plugin-initial-state</strong> to store and access information globally in your application. You'll also have learned how to configure and use <strong class="source-inline">plugin-access</strong> to protect routes. Finally, you'll have learned how to handle HTTP error responses by configuring the umi-request library.</p>
			<h1 id="_idParaDest-53"><a id="_idTextAnchor057"/>Technical requirements</h1>
			<p>To complete this chapter's exercises, you only need a computer with any OS (I recommend Ubuntu 20.04 or higher) and the software installed in <a href="B18503_01_Final_JM_ePub.xhtml#_idTextAnchor014"><em class="italic">Chapter 1</em></a>, <em class="italic">Environment Setup and Introduction to UmiJS</em> (VS Code, Node.js, and Yarn).</p>
			<p>You can find the complete project of this chapter in the <strong class="source-inline">Chapter04</strong> folder in the GitHub repository available at <a href="https://github.com/PacktPublishing/Enterprise-React-Development-with-UmiJs">https://github.com/PacktPublishing/Enterprise-React-Development-with-UmiJs</a>.</p>
			<h1 id="_idParaDest-54"><a id="_idTextAnchor058"/>Modifying the login page and defining the HTML template</h1>
			<p>In this section, we'll <a id="_idIndexMarker243"/>create a Umi mock file and requests to simulate user authentication, a login page for users to log in, and we'll configure the default HTML template for our application.</p>
			<p>Let's start with the mock file. We'll create endpoints for login, logout, and getting user information. Follow these steps to create the file:</p>
			<ol>
				<li>Create a new file named <strong class="source-inline">user.ts</strong> in the <strong class="source-inline">mock</strong> folder. Next, create the <strong class="source-inline">login</strong> function as follows:<p class="source-code">import { User } from '@/types/user.d';</p><p class="source-code">import { Request, Response } from 'express';</p><p class="source-code">const user: { currentUser: User } = {</p><p class="source-code">  currentUser: {</p><p class="source-code">    isLoggedIn: false,</p><p class="source-code">  },</p><p class="source-code">};</p><p class="source-code"><strong class="bold">const login = (req: Request, res: Response)</strong> =&gt; {</p><p class="source-code">  const { email, password } = req.body;</p><p class="source-code">};</p></li>
				<li>Add the following <strong class="source-inline">if</strong> statement to the <strong class="source-inline">login</strong> function:<p class="source-code">  <strong class="bold">if (email == 'john@doe.com' &amp;&amp; password == 'user')</strong> {</p><p class="source-code">    user.currentUser = {</p><p class="source-code">      id: 0,</p><p class="source-code">      name: 'John Doe',</p><p class="source-code">      company: 'Umi Group',</p><p class="source-code">      role: {</p><p class="source-code">        id: 1,</p><p class="source-code">        <strong class="bold">title: 'Inside Sales',</strong></p><p class="source-code">      },</p><p class="source-code">      isLoggedIn: true,</p><p class="source-code">    };</p><p class="source-code">    res.json(user.currentUser);</p><p class="source-code">  }</p></li>
			</ol>
			<p>Here, we <a id="_idIndexMarker244"/>defined a condition that allows the mock user John Doe, the inside sales representative, to access the application. The user role will determine what actions the user can execute and which pages they can access.</p>
			<ol>
				<li value="3">Next, add the following <strong class="source-inline">else if</strong> and <strong class="source-inline">else</strong> statements to the <strong class="source-inline">login</strong> function:<p class="source-code"><strong class="bold">else if (email == 'marry@doe.com' &amp;&amp; </strong></p><p class="source-code"><strong class="bold">         password == 'admin')</strong> {</p><p class="source-code">    user.currentUser = {</p><p class="source-code">      id: 1,</p><p class="source-code">      name: 'Marry Doe',</p><p class="source-code">      company: 'Umi Group',</p><p class="source-code">      role: {</p><p class="source-code">        id: 0,</p><p class="source-code">        <strong class="bold">title: 'Sales Manager',</strong></p><p class="source-code">      },</p><p class="source-code">      isLoggedIn: true,</p><p class="source-code">    };</p><p class="source-code">    res.json(user.currentUser);</p><p class="source-code">  } else {</p><p class="source-code">    <strong class="bold">res.status(401).send();</strong></p><p class="source-code">  }</p></li>
			</ol>
			<p>Here, we defined a condition that allows the mock user Mary Doe, the sales manager, to access the application. We also determined that if the user is not John Doe or Marry Doe, the mock API will return an HTTP 401 error, the status code for not authenticated.</p>
			<ol>
				<li value="4">Finally, add the <a id="_idIndexMarker245"/>other functions and the endpoint route definitions to the <strong class="source-inline">user.ts</strong> file as follows:<p class="source-code"><strong class="bold">const logout = (_: any, res: Response) =&gt; {</strong></p><p class="source-code">  user.currentUser = { isLoggedIn: false };</p><p class="source-code">  res.send({ success: true });</p><p class="source-code">};</p><p class="source-code"><strong class="bold">const getUser = (_: any, res: Response) =&gt; {</strong></p><p class="source-code">  if (!user.currentUser.isLoggedIn) {</p><p class="source-code">    res.status(204).send();</p><p class="source-code">  } else {</p><p class="source-code">    res.json(user.currentUser);</p><p class="source-code">  }</p><p class="source-code">};</p><p class="source-code">export default {</p><p class="source-code">  'POST /api/login': login,</p><p class="source-code">  'POST /api/logout': logout,</p><p class="source-code">  '/api/currentUser': getUser,</p><p class="source-code">};</p></li>
			</ol>
			<p>We created the <a id="_idIndexMarker246"/>functions to simulate logout and get the logged-in user's information.</p>
			<p>Now, we <a id="_idIndexMarker247"/>need to create requests in the <strong class="source-inline">services</strong> folder to get user info, login, and log out of the application. Follow<a id="_idIndexMarker248"/> these steps to create the requests:</p>
			<ol>
				<li value="1">Create a new file named <strong class="source-inline">user.ts</strong> in the <strong class="source-inline">services</strong> folder under the <strong class="source-inline">src</strong> folder.</li>
				<li>Add the following requests to the <strong class="source-inline">user.ts</strong> file:<p class="source-code">import { User } from '@/types/user.d';</p><p class="source-code">import { request } from 'umi';</p><p class="source-code">export function getCurrentUser() {</p><p class="source-code">  return request&lt;User&gt;(`<strong class="bold">/api/currentUser</strong>`, {</p><p class="source-code">    method: 'GET',</p><p class="source-code">  });</p><p class="source-code">}</p><p class="source-code">export function userLogin(email: string, </p><p class="source-code">  password: string) {</p><p class="source-code">  return request&lt;User&gt;(`<strong class="bold">/api/login</strong>`, {</p><p class="source-code">    method: 'POST',</p><p class="source-code">    headers: { 'Content-Type': 'application/json' },</p><p class="source-code">    data: { email, password },</p><p class="source-code">  });</p><p class="source-code">}</p><p class="source-code">export function userLogout() {</p><p class="source-code">  return request&lt;void&gt;(`<strong class="bold">/api/logout</strong>`, {</p><p class="source-code">    method: 'POST',</p><p class="source-code">  });</p><p class="source-code">}</p></li>
			</ol>
			<p>We created<a id="_idIndexMarker249"/> the requests to access the endpoints<a id="_idIndexMarker250"/> defined in the <strong class="source-inline">user.ts</strong> mock file.</p>
			<p>We created a Umi mock file for simulating the user service and the requests to the backend. Now, we'll create a login page for users to input their email and password and authenticate in the application.</p>
			<h2 id="_idParaDest-55"><a id="_idTextAnchor059"/>Modifying the login page</h2>
			<p>We need a login page<a id="_idIndexMarker251"/> for users to log in using their email and password. We have already created a login page using Umi UI in <a href="B18503_01_Final_JM_ePub.xhtml#_idTextAnchor014"><em class="italic">Chapter 1</em></a>, <em class="italic">Environment Setup and Introduction to UmiJS</em>, so we only need to adapt the page components. Follow these steps to adjust the login page to match our theme:</p>
			<ol>
				<li value="1">Refactor the <strong class="source-inline">index.tsx</strong> file in the <strong class="source-inline">pages/Login</strong> folder as follows:<p class="source-code">import { SelectLang, useModel, history } from 'umi';</p><p class="source-code">import styles from './index.less';</p><p class="source-code">import LoginForm from './LoginForm';</p><p class="source-code">export default function Page() {</p><p class="source-code">  return (</p><p class="source-code">    &lt;div&gt;</p><p class="source-code">      &lt;span className={styles.header}&gt;</p><p class="source-code">        &lt;span className={styles.logo}&gt;</p><p class="source-code">          <strong class="bold">&lt;img</strong></p><p class="source-code">            <strong class="bold">height={45}</strong></p><p class="source-code">            <strong class="bold">alt="crm logo"</strong></p><p class="source-code">            <strong class="bold">src="https://img.icons8.com/ios-filled/</strong></p><p class="source-code"><strong class="bold">                 50/ffffff/customer-insight.png"</strong></p><p class="source-code">          <strong class="bold">/&gt;</strong></p><p class="source-code">          &amp;nbsp; &amp;nbsp;</p><p class="source-code">          &lt;h1 className={styles.title}&gt;Umi CRM&lt;/h1&gt;</p><p class="source-code">        &lt;/span&gt;</p><p class="source-code">        <strong class="bold">&lt;SelectLang className={styles.language} /&gt;</strong></p><p class="source-code">      &lt;/span&gt;</p><p class="source-code">      &lt;div className={styles.container}&gt;</p><p class="source-code">        &lt;LoginForm /&gt;</p><p class="source-code">      &lt;/div&gt;</p><p class="source-code">    &lt;/div&gt;</p><p class="source-code">  );</p><p class="source-code">}</p></li>
			</ol>
			<p>We created a page header to display our application's logo and the language selector.</p>
			<ol>
				<li value="2">Now, add the <a id="_idIndexMarker252"/>CSS classes to style the title, the language selector, and the login form container in the <strong class="source-inline">index.less</strong> file as follows:<p class="source-code">@import '~antd/es/style/themes/default.less';</p><p class="source-code">.title {</p><p class="source-code">  text-align: center;</p><p class="source-code">}</p><p class="source-code">.container {</p><p class="source-code">  display: flex;</p><p class="source-code">  flex-direction: column;</p><p class="source-code">  align-items: center;</p><p class="source-code">}</p><p class="source-code">.language {</p><p class="source-code">  color: white;</p><p class="source-code">}</p></li>
				<li>Next, add the CSS class to style the header and logo in the <strong class="source-inline">index.less</strong> file as follows:<p class="source-code">.header {</p><p class="source-code">  display: flex;</p><p class="source-code">  flex-flow: row nowrap;</p><p class="source-code">  justify-content: space-between;</p><p class="source-code">  padding: 10px;</p><p class="source-code">  margin-bottom: 20px;</p><p class="source-code">  background: #1895bb;</p><p class="source-code">  background: linear-gradient(50deg, #1895bb 0%,</p><p class="source-code">                              #14cfbd 100%);</p><p class="source-code">  &gt; .logo {</p><p class="source-code">    width: 95%;</p><p class="source-code">    display: flex;</p><p class="source-code">    flex-flow: row nowrap;</p><p class="source-code">    justify-content: center;</p><p class="source-code">    &gt; h1 {</p><p class="source-code">      color: white;</p><p class="source-code">    }</p><p class="source-code">  }</p><p class="source-code">}</p></li>
				<li>Let's also make some<a id="_idIndexMarker253"/> changes to the <strong class="source-inline">LoginForm</strong> component styles. Refactor the <strong class="source-inline">index.less</strong> file in the <strong class="source-inline">LoginForm</strong> folder as follows:<p class="source-code"><strong class="bold">@import '~antd/es/style/themes/default.less';</strong></p><p class="source-code">.container {</p><p class="source-code">  :global {</p><p class="source-code">    #components-form-demo-normal-login .login-form {</p><p class="source-code">      <strong class="bold">width: 450px;</strong></p><p class="source-code">      <strong class="bold">margin: 5%;</strong></p><p class="source-code">      @media screen and (max-width: <strong class="bold">@screen-sm</strong>) {</p><p class="source-code">        <strong class="bold">width: 90%;</strong></p><p class="source-code">      }</p><p class="source-code">    }</p><p class="source-code">    #components-form-demo-normal-login </p><p class="source-code">      .login-form-forgot {</p><p class="source-code">      float: right;</p><p class="source-code">    }</p><p class="source-code">    #components-form-demo-normal-login </p><p class="source-code">      .login-form-button {</p><p class="source-code">      width: 100%;</p><p class="source-code">    }</p><p class="source-code">  }</p><p class="source-code">}</p></li>
			</ol>
			<p>We modified the<a id="_idIndexMarker254"/> form's <strong class="source-inline">width</strong> and <strong class="source-inline">margin</strong> and defined <strong class="source-inline">width</strong> as <strong class="source-inline">100%</strong> on small screens using the <strong class="source-inline">@screen-sm</strong> breakpoint from the default Ant Design variables.</p>
			<p>These are all the changes we need on the login page. The result should look like the following:</p>
			<div>
				<div id="_idContainer036" class="IMG---Figure">
					<img src="image/Figure_4.01_B18503.jpg" alt="Figure 4.1 – Login page with the theme applied&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.1 – Login page with the theme applied</p>
			<p>If you access our<a id="_idIndexMarker255"/> application on a mobile device, you will notice that it doesn't seem right, although we have developed a fully responsive login page. We'll learn how to solve this problem by defining the application's default template.</p>
			<h2 id="_idParaDest-56"><a id="_idTextAnchor060"/>Defining the default HTML template</h2>
			<p>If you are familiar <a id="_idIndexMarker256"/>with developing responsive websites, you'll know that the problem with our application pages is <a id="_idIndexMarker257"/>the <strong class="bold">viewport</strong> scale on mobile devices. We need to provide an HTML meta tag with the correct viewport attributes on each application page to solve the problem. As you already know, our application<a id="_idIndexMarker258"/> is a <strong class="bold">single-page application</strong> (<strong class="bold">SPA</strong>), so we only need to modify one HTML document.</p>
			<p>Umi provides an option to customize the default HTML template for our application, which is the <strong class="source-inline">document.ejs</strong> file. If a file named <strong class="source-inline">document.ejs</strong> exists in the <strong class="source-inline">src/pages</strong> folder, Umi will use it as the default HTML document.</p>
			<p>You can also access the application configuration in the <strong class="source-inline">document.ejs</strong> file using the <strong class="source-inline">context.config</strong> variable. Consider the following example:</p>
			<p class="source-code">&lt;!doctype html&gt;</p>
			<p class="source-code">&lt;html&gt;</p>
			<p class="source-code">&lt;head&gt;</p>
			<p class="source-code">  &lt;title&gt;</p>
			<p class="source-code">    <strong class="bold">&lt;%= context.config.layout.title %&gt;</strong></p>
			<p class="source-code">  &lt;/title&gt;</p>
			<p class="source-code">&lt;/head&gt;</p>
			<p class="source-code">&lt;body&gt;</p>
			<p class="source-code">  &lt;div id="root"&gt;&lt;/div&gt;</p>
			<p class="source-code">&lt;/body&gt;</p>
			<p class="source-code">&lt;/html&gt;</p>
			<p>In this example, we <a id="_idIndexMarker259"/>defined the content of the HTML title tag as the <strong class="source-inline">layout.title</strong> configuration present in the <strong class="source-inline">config/config.ts</strong> file.</p>
			<p>Let's create the default HTML template for our application. </p>
			<p>Create a new file named <strong class="source-inline">document.ejs</strong> in the <strong class="source-inline">src/pages</strong> folder, and create the template as follows:</p>
			<p class="source-code">&lt;!doctype html&gt;</p>
			<p class="source-code">&lt;html&gt;</p>
			<p class="source-code">&lt;head&gt;</p>
			<p class="source-code">  &lt;meta charset="utf-8" /&gt;</p>
			<p class="source-code">  <strong class="bold">&lt;meta name="viewport" content="width=device-width,</strong></p>
			<p class="source-code"><strong class="bold">    initial-scale=1.0" /&gt;</strong></p>
			<p class="source-code">  &lt;title&gt;Umi CRM&lt;/title&gt;</p>
			<p class="source-code">&lt;/head&gt;</p>
			<p class="source-code">&lt;body style="background-color: whitesmoke;"&gt;</p>
			<p class="source-code">  &lt;div id="root"&gt;&lt;/div&gt;</p>
			<p class="source-code">&lt;/body&gt;</p>
			<p class="source-code">&lt;/html&gt;</p>
			<p>We set the viewport scale to <strong class="source-inline">1.0</strong> and the content width to the same device screen width.</p>
			<p>The following <a id="_idIndexMarker260"/>screenshot shows the difference between the login page with the viewport meta tag on a mobile device and without it:</p>
			<div>
				<div id="_idContainer037" class="IMG---Figure">
					<img src="image/Figure_4.02_B18503.jpg" alt="Figure 4.2 – Login page without viewport scale (left side) and with viewport scale (right side)&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.2 – Login page without viewport scale (left side) and with viewport scale (right side)</p>
			<p>In this section, we created a Umi mock file and requests to simulate the user authentication. We also modified the login page and defined the viewport scale to correctly display the application's pages on mobile devices by creating the default HTML template for our application.</p>
			<p>In the next section, we'll learn how to store and globally access user information after the users log in.</p>
			<h1 id="_idParaDest-57"><a id="_idTextAnchor061"/>Storing and globally accessing user information</h1>
			<p>In this section, we'll configure the <strong class="source-inline">plugin-initial-state</strong> plugin to store and globally access user information.</p>
			<p>To configure the<a id="_idIndexMarker261"/> initial state, we only need to create a function named <strong class="source-inline">getInitialState</strong> in the <strong class="source-inline">app.tsx</strong> file. The <strong class="source-inline">getInitialState</strong> function will be executed <a id="_idIndexMarker262"/>before React renders the entire application, and its return value will be used as the global state. We can use the <strong class="source-inline">@@initialState</strong> model to access the values.</p>
			<p>Let's configure the initial state by following these steps:</p>
			<ol>
				<li value="1">Create a new file called <strong class="source-inline">globalState.d.ts</strong> in the <strong class="source-inline">types</strong> folder, and create the <strong class="source-inline">GlobalState</strong> interface as follows:<p class="source-code">import { User } from '@/types/user.d';</p><p class="source-code">export interface GlobalState {</p><p class="source-code">  login?: (email: string, password: string) =&gt; </p><p class="source-code">    Promise&lt;User&gt;;</p><p class="source-code">  logout?: () =&gt; Promise&lt;void&gt;;</p><p class="source-code">  fetchUser?: () =&gt; Promise&lt;User&gt;;</p><p class="source-code">  currentUser?: User;</p><p class="source-code">}</p></li>
				<li>Create the <strong class="source-inline">getInitialState</strong> function in the <strong class="source-inline">app.tsx</strong> file located in the <strong class="source-inline">src</strong> folder as follows:<p class="source-code">import routes from '../config/routes';</p><p class="source-code">import { RunTimeLayoutConfig, history } from 'umi';</p><p class="source-code">import HeaderOptions from './components/HeaderOptions';</p><p class="source-code">import { getCurrentUser, userLogin, userLogout } from './services/user';</p><p class="source-code">import { GlobalState } from './types/globalState';</p><p class="source-code">export async function getInitialState(): </p><p class="source-code">  Promise&lt;GlobalState&gt; {</p><p class="source-code">  const <strong class="bold">fetchUser</strong> = async () =&gt; </p><p class="source-code">    await getCurrentUser();</p><p class="source-code">  const <strong class="bold">logout</strong> = async () =&gt; {</p><p class="source-code">    await userLogout(), history.push('/login');</p><p class="source-code">  };</p><p class="source-code">  const <strong class="bold">login</strong> = </p><p class="source-code">    async (email: string, password: string) =&gt; {</p><p class="source-code">    return await userLogin(email, password);</p><p class="source-code">  };</p><p class="source-code">  const <strong class="bold">currentUser</strong> = await fetchUser();</p><p class="source-code">  <strong class="bold">return {</strong></p><p class="source-code">    <strong class="bold">login,</strong></p><p class="source-code">    <strong class="bold">logout,</strong></p><p class="source-code">    <strong class="bold">fetchUser,</strong></p><p class="source-code">    <strong class="bold">currentUser,</strong></p><p class="source-code">  <strong class="bold">};</strong></p><p class="source-code">}</p></li>
			</ol>
			<p>In the <a id="_idIndexMarker263"/>preceding code block, we created functions to log in, log out, fetch user data, and return it as the initial state value.</p>
			<p>Now, we can access the <a id="_idIndexMarker264"/>user information by reading the <strong class="source-inline">currentUser</strong> property. </p>
			<p>Next, let's read the initial state in the layout header by following these steps:</p>
			<ol>
				<li value="1">In the <strong class="source-inline">index.tsx</strong> file, under the <strong class="source-inline">src/components</strong> folder, read the initial state on the <strong class="source-inline">HeaderMenu</strong> component as follows:<p class="source-code">export default function HeaderMenu() {</p><p class="source-code">  const { initialState, setInitialState } = </p><p class="source-code">    <strong class="bold">useModel('@@initialState');</strong></p><p class="source-code">  const <strong class="bold">userLogout</strong> = () =&gt; {</p><p class="source-code">    initialState?.logout?.();</p><p class="source-code">    <strong class="bold">setInitialState</strong>((state) =&gt; ({</p><p class="source-code">      ...state,</p><p class="source-code">      currentUser: undefined,</p><p class="source-code">    }));</p><p class="source-code">  };</p></li>
			</ol>
			<p>We created the <strong class="source-inline">userLogout</strong> function to log out and set the <strong class="source-inline">currentUser</strong> state to <strong class="source-inline">undefined</strong>.</p>
			<ol>
				<li value="2">Now, in the <strong class="source-inline">Menu</strong> component, add the <strong class="source-inline">onClick</strong> event to execute the <strong class="source-inline">userLogout</strong> function when users click on the logout menu item as follows:<p class="source-code">const options = (</p><p class="source-code">    &lt;Menu className=</p><p class="source-code">      {styles.menu} <strong class="bold">onClick={userLogout}</strong>&gt;</p><p class="source-code">      &lt;Menu.Item key="center"&gt;</p><p class="source-code">        &lt;LogoutOutlined /&gt; Logout</p><p class="source-code">      &lt;/Menu.Item&gt;</p><p class="source-code">    &lt;/Menu&gt;</p><p class="source-code">  );</p></li>
				<li>Finally, add the<a id="_idIndexMarker265"/> user's name below the <strong class="source-inline">Avatar</strong> component as follows:<p class="source-code">return (</p><p class="source-code">    &lt;Dropdown className=</p><p class="source-code">      {styles.dropdown} overlay={options}&gt;</p><p class="source-code">      &lt;span&gt;</p><p class="source-code">        &lt;Avatar size="small" className=</p><p class="source-code">          {styles.avatar} icon={&lt;UserOutlined /&gt;} /&gt;</p><p class="source-code">        &lt;span className={`${styles.name} anticon`}&gt;</p><p class="source-code">          <strong class="bold">{initialState?.currentUser?.name}</strong></p><p class="source-code">        &lt;/span&gt;</p><p class="source-code">      &lt;/span&gt;</p><p class="source-code">    &lt;/Dropdown&gt;</p><p class="source-code">  );</p></li>
			</ol>
			<p>Next, let's read the <a id="_idIndexMarker266"/>user information on the home page by following these steps:</p>
			<ol>
				<li value="1">In the <strong class="source-inline">index.tsx</strong> file under the <strong class="source-inline">pages/Home</strong> folder, read the initial state as follows:<p class="source-code"><strong class="bold">const { initialState } = useModel('@@initialState');</strong></p></li>
				<li>Next, add the user's name, role, and company as follows:<p class="source-code">&lt;div className={styles.content}&gt;</p><p class="source-code">  &lt;div className={styles.contentTitle}&gt;</p><p class="source-code">    &lt;FormattedMessage id="greetings.hello" /&gt; </p><p class="source-code">      <strong class="bold">{initialState?.currentUser?.name}</strong>,{' '}</p><p class="source-code">    &lt;FormattedMessage id="greetings.welcome" /&gt;.</p><p class="source-code">  &lt;/div&gt;</p><p class="source-code">  &lt;div&gt;</p><p class="source-code">    <strong class="bold">{initialState?.currentUser?.role?.title}</strong> |{' '}</p><p class="source-code">    <strong class="bold">{initialState?.currentUser?.company}</strong></p><p class="source-code">  &lt;/div&gt;</p><p class="source-code">&lt;/div&gt;</p></li>
			</ol>
			<p>We also need to execute the <strong class="source-inline">login</strong> function on the login page. Follow these steps to develop the login flow:</p>
			<ol>
				<li value="1">Add the following function to the <strong class="source-inline">index.tsx</strong> file in the <strong class="source-inline">pages/Login/LoginForm</strong> folder:<p class="source-code">const { initialState, setInitialState } = useModel('@@initialState');</p><p class="source-code">  const onFinish = async (values: any) =&gt; {</p><p class="source-code">    const user = await <strong class="bold">initialState?.login?.(</strong></p><p class="source-code"><strong class="bold">      values.username, values.password);</strong></p><p class="source-code">    if (user) {</p><p class="source-code">      <strong class="bold">setInitialState((state) =&gt; ({</strong></p><p class="source-code"><strong class="bold">        ...state,</strong></p><p class="source-code"><strong class="bold">        currentUser: user,</strong></p><p class="source-code"><strong class="bold">      }));</strong></p><p class="source-code">    }</p><p class="source-code">  };</p></li>
			</ol>
			<p>When the user sends the login form, we execute the <strong class="source-inline">login</strong> function, and if the login is successful, we save the user information on the initial state.</p>
			<ol>
				<li value="2">Now, add the <a id="_idIndexMarker267"/>following React effect to the <strong class="source-inline">index.tsx</strong> file in the <strong class="source-inline">pages/Login</strong> folder:<p class="source-code">const { initialState } = useModel('@@initialState');</p><p class="source-code">  useEffect(() =&gt; {</p><p class="source-code">    <strong class="bold">if (initialState?.currentUser?.isLoggedIn)</strong></p><p class="source-code"><strong class="bold">      history.push('/');</strong></p><p class="source-code">  }, [initialState?.currentUser]); </p></li>
			</ol>
			<p>Here, we defined that when the <strong class="source-inline">currentUser</strong> state changes, we redirect the user to the home page if the login succeeds.</p>
			<p>When users log in to the application, we redirect them to the home page, but we need to turn users back to the login page when they log out and no longer have access to other pages. We can set this behavior by reading the initial state in the layout runtime configuration.</p>
			<p>Add the following lines to the <strong class="source-inline">onPageChange</strong> function in the <strong class="source-inline">layout</strong> configuration in the <strong class="source-inline">app.tsx</strong> file:</p>
			<p class="source-code">export const layout: RunTimeLayoutConfig = (<strong class="bold">{ initialState }</strong>) =&gt; {</p>
			<p class="source-code">  return {</p>
			<p class="source-code">    routes,</p>
			<p class="source-code">    rightContentRender: () =&gt; &lt;HeaderOptions /&gt;,</p>
			<p class="source-code">    onPageChange: () =&gt; {</p>
			<p class="source-code">      <strong class="bold">const isLoggedIn =</strong></p>
			<p class="source-code"><strong class="bold">      initialState?.currentUser?.isLoggedIn;</strong></p>
			<p class="source-code">      <strong class="bold">const location = history.location.pathname;</strong></p>
			<p class="source-code">      <strong class="bold">if (!isLoggedIn &amp;&amp; location != '/login') </strong></p>
			<p class="source-code"><strong class="bold">        history.push(`/login`);</strong></p>
			<p class="source-code">    },</p>
			<p class="source-code">  };</p>
			<p class="source-code">};</p>
			<p>Here, we defined<a id="_idIndexMarker268"/> redirecting the user to the login page if the user is not logged in and the current page is not the login page.</p>
			<p>In this section, we configured our application's initial state, read the user information on the home page and in the <strong class="source-inline">MenuHeader</strong> component, and set the login flow by adding some lines to the layout configuration and the login page.</p>
			<p>In the next section, we'll learn how to use <strong class="source-inline">plugin-access</strong> to block unauthorized access.</p>
			<h1 id="_idParaDest-58"><a id="_idTextAnchor062"/>Protecting application routes based on user roles</h1>
			<p>In this section, we'll <a id="_idIndexMarker269"/>configure the Umi <strong class="source-inline">plugin-access</strong> plugin to define user permissions and protect routes and features from unauthorized access.</p>
			<p>To configure the access plugin, we must create an <strong class="source-inline">access.ts</strong> file in the <strong class="source-inline">src</strong> folder. The <strong class="source-inline">access.ts</strong> file must export a function that returns an object, and each property of that object must be a Boolean value representing permissions. Consider the following example:</p>
			<p class="source-code">export default function (initialState: any) {</p>
			<p class="source-code">  <strong class="bold">const { access } = initialState;</strong></p>
			<p class="source-code">  return {</p>
			<p class="source-code">    <strong class="bold">readOnly: access == 'basic',</strong></p>
			<p class="source-code">  };</p>
			<p class="source-code">}</p>
			<p>In this example, we read the <strong class="source-inline">access</strong> property from the initial state and returned the <strong class="source-inline">readOnly: true</strong> permission if <strong class="source-inline">access</strong> is equal to <strong class="source-inline">basic</strong>.</p>
			<p>Let's create an <strong class="source-inline">access.ts</strong> file for our application.</p>
			<p>Create a new file called <strong class="source-inline">access.ts</strong> in the <strong class="source-inline">src</strong> folder and create the <strong class="source-inline">default</strong> function as follows:</p>
			<p class="source-code">import { GlobalState } from './types/globalState';</p>
			<p class="source-code">export default function (initialState: GlobalState) {</p>
			<p class="source-code">  const { currentUser } = initialState;</p>
			<p class="source-code">  return {</p>
			<p class="source-code">    <strong class="bold">canAdmin: currentUser?.role?.id == 0,</strong></p>
			<p class="source-code">  };</p>
			<p class="source-code">}</p>
			<p>In the preceding code block, we defined the users with <strong class="source-inline">role id</strong> equal to <strong class="source-inline">0</strong> (sales manager) as the application administrators.</p>
			<p>Now, to demonstrate how to use the <strong class="source-inline">canAdmin</strong> permission, let's create a new page that only administrators can<a id="_idIndexMarker270"/> access by following these steps:</p>
			<ol>
				<li value="1">Create a new page in the <strong class="source-inline">pages</strong> folder by running the following command:<p class="source-code"><strong class="bold">yarn umi g page /Workflow/index --typescript --less</strong></p></li>
				<li>In the <strong class="source-inline">index.tsx</strong> file, add the <strong class="source-inline">ProTable</strong> component as follows:<p class="source-code">import ProTable from '@ant-design/pro-table';</p><p class="source-code">import { Button } from 'antd';</p><p class="source-code">import { PageContainer } from '@ant-design/pro-layout';</p><p class="source-code">import { PlusOutlined } from '@ant-design/icons';</p><p class="source-code">import { FormattedMessage } from '@/.umi/plugin-locale/localeExports';</p><p class="source-code">import columns from './columns';</p><p class="source-code">export default function Page() {</p><p class="source-code">  return (</p><p class="source-code">    &lt;PageContainer&gt;</p><p class="source-code">      &lt;ProTable&lt;any&gt;</p><p class="source-code">        columns={columns}</p><p class="source-code">        dataSource={workflow}</p><p class="source-code">        rowKey="id"</p><p class="source-code">        search={false}</p><p class="source-code">        pagination={{ pageSize: 5 }}</p><p class="source-code">        dateFormatter="string"</p><p class="source-code">        toolBarRender={() =&gt; [</p><p class="source-code">          &lt;Button key="button" icon={&lt;PlusOutlined /&gt;}</p><p class="source-code">           type="primary"&gt;</p><p class="source-code">            &lt;FormattedMessage id="table.new" /&gt;</p><p class="source-code">          &lt;/Button&gt;,</p><p class="source-code">        ]}</p><p class="source-code">      /&gt;</p><p class="source-code">    &lt;/PageContainer&gt;</p><p class="source-code">  );</p><p class="source-code">}</p></li>
			</ol>
			<p>We created a<a id="_idIndexMarker271"/> simple <strong class="source-inline">ProTable</strong> component to list workflow configurations.</p>
			<ol>
				<li value="3">Next, add the data source to fill <strong class="source-inline">ProTable</strong> as follows:<p class="source-code">const workflow = [</p><p class="source-code">  {</p><p class="source-code">    id: 0,</p><p class="source-code">    name: 'AssignEmail',</p><p class="source-code">    table: 'Opportunity',</p><p class="source-code">    type: 0,</p><p class="source-code">    trigger: 0,</p><p class="source-code">  },</p><p class="source-code">  {</p><p class="source-code">    id: 1,</p><p class="source-code">    name: 'NewOpportunity',</p><p class="source-code">    table: 'Analytics',</p><p class="source-code">    type: 1,</p><p class="source-code">    trigger: 1,</p><p class="source-code">  },</p><p class="source-code">];</p></li>
				<li>In the <strong class="source-inline">pages/Workflow</strong> folder, create a new file called <strong class="source-inline">columns.tsx</strong> and add the<a id="_idIndexMarker272"/> column definitions as follows:<p class="source-code">import { ProColumns } from '@ant-design/pro-table';</p><p class="source-code">import { FormattedMessage } from 'umi';</p><p class="source-code">const columns: ProColumns&lt;any&gt;[] = [</p><p class="source-code">  {</p><p class="source-code">    title: &lt;FormattedMessage id="table.workflow.name"</p><p class="source-code">           /&gt;,</p><p class="source-code">    dataIndex: 'name',</p><p class="source-code">  },</p><p class="source-code">  {</p><p class="source-code">    title: &lt;FormattedMessage id="table.workflow.type"</p><p class="source-code">           /&gt;,</p><p class="source-code">    dataIndex: 'type',</p><p class="source-code">  },</p><p class="source-code">  {</p><p class="source-code">    title: &lt;FormattedMessage id="table.workflow.table"</p><p class="source-code">           /&gt;,</p><p class="source-code">    dataIndex: 'table',</p><p class="source-code">  },</p><p class="source-code">  {</p><p class="source-code">    title: &lt;FormattedMessage id="table.options" /&gt;,</p><p class="source-code">    valueType: 'option',</p><p class="source-code">    hideInSetting: true,</p><p class="source-code">    hideInDescriptions: true,</p><p class="source-code">    render: () =&gt; [</p><p class="source-code">      &lt;a&gt;</p><p class="source-code">        &lt;FormattedMessage id="table.edit" /&gt;</p><p class="source-code">      &lt;/a&gt;,</p><p class="source-code">    ],</p><p class="source-code">  },</p><p class="source-code">];</p><p class="source-code">export default columns;</p></li>
				<li>Add the <a id="_idIndexMarker273"/>following text to the <strong class="source-inline">en-US.ts</strong> file in the <strong class="source-inline">locales</strong> folder:<p class="source-code">'table.workflow.name': 'Name',</p><p class="source-code">'table.workflow.type': 'Type',</p><p class="source-code">'table.workflow.table': 'Table',</p></li>
				<li>Now, add the route configuration to the workflow page to the <strong class="source-inline">routes.ts</strong> file as follows:<p class="source-code">{</p><p class="source-code">  path: '/workflow',</p><p class="source-code">  name: 'workflow',</p><p class="source-code">  <strong class="bold">access: 'canAdmin',</strong></p><p class="source-code">  icon: 'DeploymentUnitOutlined',</p><p class="source-code">  component: '@/pages/Workflow',</p><p class="source-code">},</p></li>
			</ol>
			<p>Notice the <strong class="source-inline">access</strong> property in the route configuration. In the <strong class="source-inline">access</strong> property, we can set the permissions defined in the <strong class="source-inline">access.ts</strong> file. Now, only users with the sales manager role can access the workflow page.</p>
			<ol>
				<li value="7">We can<a id="_idIndexMarker274"/> also define in the layout configuration a default page to display when users don't have sufficient permissions to access a page. Add the following definition to the layout configuration in the <strong class="source-inline">app.tsx</strong> file:<p class="source-code"><strong class="bold">unAccessible: (</strong></p><p class="source-code">  <strong class="bold">&lt;Result</strong></p><p class="source-code">    status="403"</p><p class="source-code">    title="403"</p><p class="source-code">    subTitle="Sorry, you are not authorized to access </p><p class="source-code">              this page."</p><p class="source-code">    extra={</p><p class="source-code">        &lt;Button type="primary" <strong class="bold">onClick={() =&gt; </strong></p><p class="source-code"><strong class="bold">          history.push('/')}</strong>&gt;</p><p class="source-code">          Back to Home</p><p class="source-code">        &lt;/Button&gt;</p><p class="source-code">    }</p><p class="source-code">  /&gt;</p><p class="source-code">)</p></li>
			</ol>
			<p>We added<a id="_idIndexMarker275"/> the <strong class="source-inline">Result</strong> component from Ant Design to display the unauthorized error page and a button so users can go back to the home page. Here's how the page will look:</p>
			<div>
				<div id="_idContainer038" class="IMG---Figure">
					<img src="image/Figure_4.03_B18503.jpg" alt="Figure 4.3 – Unauthorized error page&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.3 – Unauthorized error page</p>
			<p>We have now created the <strong class="source-inline">access.ts</strong> file and used the <strong class="source-inline">canAdmin</strong> permission to protect the workflow page. Next, we'll learn how to use permissions to protect other application features.</p>
			<h2 id="_idParaDest-59"><a id="_idTextAnchor063"/>Using the useAccess hook</h2>
			<p>We can use the<a id="_idIndexMarker276"/> permissions we created in the <strong class="source-inline">access.ts</strong> file to authorize users to execute any actions in our application using the <strong class="source-inline">useAccess</strong> hook and the <strong class="source-inline">Access</strong> component. Consider the following example:</p>
			<p class="source-code">import { useAccess } from "umi";</p>
			<p class="source-code">const Page = (props) =&gt; {</p>
			<p class="source-code">  const [disabled, setDisabled] = useState&lt;any&gt;();</p>
			<p class="source-code">  <strong class="bold">const access = useAccess();</strong></p>
			<p class="source-code">  <strong class="bold">if (access.readOnly) {</strong></p>
			<p class="source-code">    <strong class="bold">setDisabled(true);</strong></p>
			<p class="source-code">  <strong class="bold">}</strong></p>
			<p class="source-code">  return <strong class="bold">&lt;Button disabled={disabled}&gt; Edit &lt;/Button&gt;;</strong></p>
			<p class="source-code">};</p>
			<p class="source-code">export default Page;</p>
			<p>In this example, we read the <strong class="source-inline">readOnly</strong> permission to define whether the <strong class="bold">Edit</strong> button will be disabled.</p>
			<p>Now, consider <a id="_idIndexMarker277"/>another example using the <strong class="source-inline">Access</strong> component:</p>
			<p class="source-code">import { useAccess } from "umi";</p>
			<p class="source-code">const Page = (props) =&gt; {</p>
			<p class="source-code">  const access = useAccess();</p>
			<p class="source-code">  return (</p>
			<p class="source-code">    &lt;Access</p>
			<p class="source-code">      <strong class="bold">accessible={access.readAndWrite}</strong></p>
			<p class="source-code">      <strong class="bold">fallback={&lt;div&gt;You are not allowed to write </strong></p>
			<p class="source-code"><strong class="bold">                content.&lt;/div&gt;}</strong></p>
			<p class="source-code">    &gt;</p>
			<p class="source-code">      &lt;TextArea&gt;&lt;/TextArea&gt;</p>
			<p class="source-code">    &lt;/Access&gt;</p>
			<p class="source-code">  );</p>
			<p class="source-code">};</p>
			<p class="source-code">export default Page;</p>
			<p>In this example, we'll render the content in the <strong class="source-inline">fallback</strong> property if the user doesn't have the <strong class="source-inline">readAndWrite</strong> permission instead of rendering the <strong class="source-inline">TextArea</strong> component.</p>
			<p>Let's use the <strong class="source-inline">useAccess</strong> hook to allow administrators to assign an opportunity to an inside sales representative by following these steps:</p>
			<ol>
				<li value="1">Add the following line to the <strong class="source-inline">index.tsx</strong> file in the <strong class="source-inline">pages/Opportunities</strong> folder to read the <strong class="source-inline">canAdmin</strong> permission:<p class="source-code"><strong class="bold">const { canAdmin } = useAccess();</strong></p></li>
				<li>Next, add the following properties to the <strong class="source-inline">ProTable</strong> component:<p class="source-code">rowSelection={<strong class="bold">canAdmin &amp;&amp; { onChange: () =&gt; {} }</strong>}</p><p class="source-code">tableAlertOptionRender={() =&gt; &lt;a&gt;Assign&lt;/a&gt;}</p></li>
			</ol>
			<p>We defined<a id="_idIndexMarker278"/> that only if the user has the <strong class="source-inline">canAdmin</strong> permission, we'll apply the <strong class="source-inline">onChange</strong> event, enabling the <strong class="source-inline">ProTable</strong> row selection. </p>
			<p>Now, if the user is an administrator, they can assign an opportunity as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer039" class="IMG---Figure">
					<img src="image/Figure_4.04_B18503.jpg" alt="Figure 4.4 – Assign opportunity feature&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.4 – Assign opportunity feature</p>
			<p>In this section, we<a id="_idIndexMarker279"/> created the <strong class="source-inline">access.ts</strong> file and defined the administrator permissions based on the user role. Then, we used the <strong class="source-inline">canAdmin</strong> permission to block unauthorized access to the workflow page and the row selection feature.</p>
			<p>In the next section, you'll learn how to handle HTTP error responses by configuring the umi-request library.</p>
			<h1 id="_idParaDest-60"><a id="_idTextAnchor064"/>Handling HTTP error responses</h1>
			<p>In this section, we'll configure the<a id="_idIndexMarker280"/> umi-request library to handle error responses and display visual feedback.</p>
			<p>We'll use the <strong class="source-inline">errorHandler</strong> function, one of the many <a id="_idIndexMarker281"/>umi-request library configurations. I recommend you read the documentation available at <a href="https://github.com/umijs/umi-request">https://github.com/umijs/umi-request</a> to learn more about other features.</p>
			<p>The umi-request library will trigger the <strong class="source-inline">errorHandler</strong> function every time it receives an HTTP error response, and we will read the response status and show a message to inform the user why the action they tried to execute failed.</p>
			<p>Follow these steps to configure the umi-request library:</p>
			<ol>
				<li value="1">In the <strong class="source-inline">app.tsx</strong> file, create <a id="_idIndexMarker282"/>a new function and add the <strong class="source-inline">request</strong> configuration <a id="_idIndexMarker283"/>as follows:<p class="source-code">const errorHandler = (error: ResponseError) =&gt; {</p><p class="source-code">  const { response } = error;</p><p class="source-code">  let messages = undefined;</p><p class="source-code">  switch (<strong class="bold">getLocale()</strong>) {</p><p class="source-code">    <strong class="bold">case 'en-US':</strong></p><p class="source-code">     <strong class="bold"> messages = eng;</strong></p><p class="source-code">      break;</p><p class="source-code">    <strong class="bold">case 'pt-BR':</strong></p><p class="source-code">      <strong class="bold">messages = port;</strong></p><p class="source-code">      break;</p><p class="source-code">  }</p><p class="source-code">  if (response) {</p><p class="source-code">    <strong class="bold">message.error(messages[response.status]);</strong></p><p class="source-code">  } else if (!response) {</p><p class="source-code">    <strong class="bold">message.error(messages['empty']);</strong></p><p class="source-code">  }</p><p class="source-code">  throw error;</p><p class="source-code">};</p><p class="source-code"><strong class="bold">export const request: RequestConfig = { errorHandler };</strong></p></li>
			</ol>
			<p>We used <a id="_idIndexMarker284"/>the <strong class="source-inline">getLocale()</strong> function from Umi to define in what language we'll display the messages. Next, we displayed an error message based on the response status or empty response and exported the request configuration with the <strong class="source-inline">errorHandler</strong> function.</p>
			<ol>
				<li value="2">Next, we need to<a id="_idIndexMarker285"/> define the messages. In the <strong class="source-inline">src/locales</strong> folder, under the <strong class="source-inline">en-US</strong> folder, create a new file called <strong class="source-inline">http.ts</strong> and add the following messages:<p class="source-code">export default {</p><p class="source-code">  400: 'The request failed.',</p><p class="source-code">  401: 'Invalid credentials, you are not </p><p class="source-code">        authenticated.',</p><p class="source-code">  403: 'You cannot perform this operation.',</p><p class="source-code">  404: 'Resource not found.',</p><p class="source-code">  405: 'Operation not allowed.',</p><p class="source-code">  406: 'The operation cannot be completed.',</p><p class="source-code">  410: 'The service is no longer available',</p><p class="source-code">  422: 'Could not process your request.',</p><p class="source-code">  500: 'Internal error, contact administrator.',</p><p class="source-code">  502: 'Internal service communication failed.',</p><p class="source-code">  503: 'Service temporarily unavailable.',</p><p class="source-code">  504: 'The maximum wait time for an answer has </p><p class="source-code">        expired.',</p><p class="source-code">  empty: 'Failed to connect to services',</p><p class="source-code">};</p></li>
			</ol>
			<p>You also need to download the Portuguese version of the <strong class="source-inline">http.ts</strong> file available in the GitHub repository of this book and place it in the <strong class="source-inline">locales/pt-BR</strong> folder.</p>
			<ol>
				<li value="3">Now, import<a id="_idIndexMarker286"/> the <strong class="source-inline">http.ts</strong> file from the <strong class="source-inline">en-US</strong> and <strong class="source-inline">pt-BR</strong> folders in the <strong class="source-inline">app.ts</strong> file as follows:<p class="source-code">import eng from './locales/en-US/http';</p><p class="source-code">import port from './locales/pt-BR/http';</p></li>
			</ol>
			<p>When the Umi request<a id="_idIndexMarker287"/> receives an HTTP error response, the user will see a message as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer040" class="IMG---Figure">
					<img src="image/Figure_4.05_B18503.jpg" alt="Figure 4.5 – Feedback message on failed request&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.5 – Feedback message on failed request</p>
			<p>In this section, we configured the umi-request library to handle HTTP error responses and display a feedback message to inform the user what happened. </p>
			<h1 id="_idParaDest-61"><a id="_idTextAnchor065"/>Summary</h1>
			<p>In this chapter, we created the login page and the <strong class="source-inline">document.ejs</strong> file, and learned how to set the viewport scale to display our pages on mobile devices correctly. You learned how to store and globally access data by configuring the initial state plugin and reading the initial state properties on the login and home page.</p>
			<p>We created user permissions by configuring the access plugin and created the workflow page on which we blocked unauthorized access using the access plugin. We enabled the <strong class="source-inline">ProTable</strong> row selection feature only for authorized users using the access plugin.</p>
			<p>Finally, we configured the umi-request library to handle HTTP error responses and display feedback messages to inform users what happened.</p>
			<p>In the next chapter, you'll learn about code style, formatting, and how to improve your code using <strong class="bold">linters</strong> and formatting tools.</p>
		</div>
	</body></html>