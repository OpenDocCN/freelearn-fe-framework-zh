<html><head></head><body>
<div id="_idContainer161" class="calibre2">
<h1 class="chapter-number" id="_idParaDest-340"><a id="_idTextAnchor343" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1.1">19</span></h1>
<h1 id="_idParaDest-341" class="calibre5"><a id="_idTextAnchor344" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.2.1">Deploying a Next.js App</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.3.1">After learning about advanced Next.js concepts, it’s time to learn how to deploy a Next.js app. </span><span class="kobospan" id="kobo.3.2">The easiest way to deploy Next.js apps is by using the Vercel platform, provided by the company that develops the Next.js framework. </span><span class="kobospan" id="kobo.3.3">After learning how to deploy our app on the Vercel platform, we are going to learn how to create a custom deployment setup </span><span><span class="kobospan" id="kobo.4.1">using Docker.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.5.1">In this chapter, we are going to cover the following </span><span><span class="kobospan" id="kobo.6.1">main topics:</span></span></p>
<ul class="calibre10">
<li class="calibre11"><span class="kobospan" id="kobo.7.1">Deploying a Next.js app </span><span><span class="kobospan" id="kobo.8.1">with Vercel</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.9.1">Creating a custom deployment setup for </span><span><span class="kobospan" id="kobo.10.1">Next.js apps</span></span></li>
</ul>
<h1 id="_idParaDest-342" class="calibre5"><a id="_idTextAnchor345" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.11.1">Technical requirements</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.12.1">Before we start, please install all requirements from </span><a href="B19385_01.xhtml#_idTextAnchor016" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.13.1">Chapter 1</span></em></span></a><em class="italic"><span class="kobospan" id="kobo.14.1">, Preparing for Full-Stack Development</span></em><span class="kobospan" id="kobo.15.1">, and </span><a href="B19385_02.xhtml#_idTextAnchor028" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.16.1">Chapter 2</span></em></span></a><em class="italic"><span class="kobospan" id="kobo.17.1">, Getting to Know Node.js </span></em><span><em class="italic"><span class="kobospan" id="kobo.18.1">and MongoDB</span></em></span><span><span class="kobospan" id="kobo.19.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.20.1">The versions listed in those chapters are the ones used in the book. </span><span class="kobospan" id="kobo.20.2">While installing a newer version should not be an issue, please note that certain steps might work differently on a newer version. </span><span class="kobospan" id="kobo.20.3">If you are having an issue with the code and steps provided in this book, please try using the versions mentioned in </span><a href="B19385_01.xhtml#_idTextAnchor016" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.21.1">Chapter 1</span></em></span></a><em class="italic"> </em><span><span class="kobospan" id="kobo.22.1">and</span></span><span><em class="italic"><span class="kobospan" id="kobo.23.1"> 2.</span></em></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.24.1">You can find the code for this chapter on </span><span><span class="kobospan" id="kobo.25.1">GitHub: </span></span><a href="https://github.com/PacktPublishing/Modern-Full-Stack-React-Projects/tree/main/ch19" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.26.1">https://github.com/PacktPublishing/Modern-Full-Stack-React-Projects/tree/main/ch19</span></span></a><span><span class="kobospan" id="kobo.27.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.28.1">The CiA video for this chapter can be found </span><span><span class="kobospan" id="kobo.29.1">at: </span></span><a href="https://youtu.be/ERBFy5mHwek" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.30.1">https://youtu.be/ERBFy5mHwek</span></span></a><span><span class="kobospan" id="kobo.31.1">.</span></span></p>
<h1 id="_idParaDest-343" class="calibre5"><a id="_idTextAnchor346" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.32.1">Deploying a Next.js app with Vercel</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.33.1">We are</span><a id="_idIndexMarker1027" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.34.1"> going to start by deploying our app on Vercel, a platform where we </span><a id="_idIndexMarker1028" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.35.1">can deploy our apps for free in a simple and convenient way. </span><span class="kobospan" id="kobo.35.2">Follow these steps to get started deploying our Next.js app </span><span><span class="kobospan" id="kobo.36.1">with Vercel:</span></span></p>
<ol class="calibre15">
<li class="calibre11"><span class="kobospan" id="kobo.37.1">Copy the existing </span><strong class="source-inline1"><span class="kobospan" id="kobo.38.1">ch18</span></strong><span class="kobospan" id="kobo.39.1"> folder to a new </span><strong class="source-inline1"><span class="kobospan" id="kobo.40.1">ch19</span></strong><span class="kobospan" id="kobo.41.1"> folder by running the </span><span><span class="kobospan" id="kobo.42.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.43.1">$ cp -R ch18 ch19</span></strong></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.44.1">Open the </span><strong class="source-inline1"><span class="kobospan" id="kobo.45.1">ch19</span></strong><span class="kobospan" id="kobo.46.1"> folder in </span><span><span class="kobospan" id="kobo.47.1">VS Code.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.48.1">Install </span><a id="_idIndexMarker1029" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.49.1">the Vercel CLI tool as a global package with the </span><span><span class="kobospan" id="kobo.50.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.51.1">$ npm install -g vercel@33.5.3</span></strong></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.52.1">Run the </span><span><span class="kobospan" id="kobo.53.1">Vercel CLI:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.54.1">$ vercel</span></strong></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.55.1">You will </span><a id="_idIndexMarker1030" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.56.1">be asked to log in to Vercel. </span><span class="kobospan" id="kobo.56.2">Select either of the login methods and follow the steps provided by Vercel to </span><span><span class="kobospan" id="kobo.57.1">log in.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.58.1">After successfully logging in, you will be asked questions about the deployment of your project, confirm all of them with the default values provided by pressing </span><em class="italic"><span class="kobospan" id="kobo.59.1">Enter</span></em><span class="kobospan" id="kobo.60.1">/</span><em class="italic"><span class="kobospan" id="kobo.61.1">Return</span></em><span class="kobospan" id="kobo.62.1"> until the Vercel CLI attempts to build </span><span><span class="kobospan" id="kobo.63.1">your project.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer155">
<span class="kobospan" id="kobo.64.1"><img alt="Figure 19.1 – Attempting to deploy our app to Vercel" src="image/B19385_19_1.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.65.1">Figure 19.1 – Attempting to deploy our app to Vercel</span></p>
<ol class="calibre15">
<li value="7" class="calibre11"><span class="kobospan" id="kobo.66.1">While the</span><a id="_idIndexMarker1031" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.67.1"> project is building, you can visit the URL provided in the CLI to see the current state</span><a id="_idIndexMarker1032" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.68.1"> of the build process (make sure you are logged in to Vercel in the same browser), as shown in the </span><span><span class="kobospan" id="kobo.69.1">following screenshot:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer156">
<span class="kobospan" id="kobo.70.1"><img alt="Figure 19.2 – Monitoring the build process in the browser" src="image/B19385_19_2_new.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.71.1">Figure 19.2 – Monitoring the build process in the browser</span></p>
<ol class="calibre15">
<li value="8" class="calibre11"><span class="kobospan" id="kobo.72.1">Unfortunately, the</span><a id="_idIndexMarker1033" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.73.1"> build fails because the </span><strong class="source-inline1"><span class="kobospan" id="kobo.74.1">DATABASE_URL</span></strong><span class="kobospan" id="kobo.75.1"> environment variable is</span><a id="_idIndexMarker1034" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.76.1"> set </span><span><span class="kobospan" id="kobo.77.1">to </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.78.1">mongodb://localhost:27017/blog</span></strong></span><span><span class="kobospan" id="kobo.79.1">.</span></span></li>
</ol>
<p class="calibre3"><span class="kobospan" id="kobo.80.1">We now need to adjust this environment variable </span><span><span class="kobospan" id="kobo.81.1">in Vercel.</span></span></p>
<h2 id="_idParaDest-344" class="calibre7"><a id="_idTextAnchor347" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.82.1">Setting environment variables in Vercel</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.83.1">Follow</span><a id="_idIndexMarker1035" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.84.1"> these steps to set up the necessary environment variables </span><span><span class="kobospan" id="kobo.85.1">in Vercel:</span></span></p>
<ol class="calibre15">
<li class="calibre11"><span class="kobospan" id="kobo.86.1">Re-use the existing database cluster created in MongoDB Atlas or follow the steps in the </span><em class="italic"><span class="kobospan" id="kobo.87.1">Creating a MongoDB Atlas database</span></em><span class="kobospan" id="kobo.88.1"> section of </span><a href="B19385_05.xhtml#_idTextAnchor090" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.89.1">Chapter 5</span></em></span></a><span class="kobospan" id="kobo.90.1"> to create a new database cluster. </span><span class="kobospan" id="kobo.90.2">You should now have a connection string for </span><span><span class="kobospan" id="kobo.91.1">your database.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.92.1">Verify that the connection string works by executing the </span><span><span class="kobospan" id="kobo.93.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.94.1">$ mongosh "&lt;connection-string&gt;"</span></strong></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.95.1">If you are re-using the existing database cluster, make sure to clear the database/collections, as the posts and users used to have a slightly different format in </span><a href="B19385_05.xhtml#_idTextAnchor090" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.96.1">Chapter 5</span></em></span></a><span class="kobospan" id="kobo.97.1">! </span><span class="kobospan" id="kobo.97.2">Run the following commands inside the MongoDB Shell to clear </span><span><span class="kobospan" id="kobo.98.1">the collections:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.99.1">
&gt; db.posts.drop()
&gt; db.users.drop()</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.100.1">Go to </span><a href="https://vercel.com/" class="calibre6 pcalibre1 pcalibre"><span class="kobospan" id="kobo.101.1">https://vercel.com/</span></a><span class="kobospan" id="kobo.102.1"> and</span><a id="_idIndexMarker1036" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.103.1"> log in with the same login provider you </span><span><span class="kobospan" id="kobo.104.1">used earlier.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.105.1">You should see an overview of your projects, including the </span><strong class="source-inline1"><span class="kobospan" id="kobo.106.1">ch19</span></strong><span class="kobospan" id="kobo.107.1"> project we created earlier via the Vercel CLI, as shown in the </span><span><span class="kobospan" id="kobo.108.1">following screenshot:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer157">
<span class="kobospan" id="kobo.109.1"><img alt="Figure 19.3 – The Vercel dashboard" src="image/B19385_19_3.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.110.1">Figure 19.3 – The Vercel dashboard</span></p>
<ol class="calibre15">
<li value="6" class="calibre11"><span class="kobospan" id="kobo.111.1">Click</span><a id="_idIndexMarker1037" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.112.1"> on the </span><strong class="source-inline1"><span class="kobospan" id="kobo.113.1">ch19</span></strong><span class="kobospan" id="kobo.114.1"> project, then go to the </span><strong class="bold"><span class="kobospan" id="kobo.115.1">Settings</span></strong><span class="kobospan" id="kobo.116.1"> tab, select </span><strong class="bold"><span class="kobospan" id="kobo.117.1">Environment Variables</span></strong><span class="kobospan" id="kobo.118.1"> on the sidebar, and create a new environment variable by entering </span><strong class="source-inline1"><span class="kobospan" id="kobo.119.1">DATABASE_URL</span></strong><span class="kobospan" id="kobo.120.1"> as the </span><strong class="bold"><span class="kobospan" id="kobo.121.1">Key</span></strong><span class="kobospan" id="kobo.122.1"> and the previously obtained connection string as </span><strong class="bold"><span class="kobospan" id="kobo.123.1">Value</span></strong><span class="kobospan" id="kobo.124.1">, as shown in the </span><span><span class="kobospan" id="kobo.125.1">following screenshot:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer158">
<span class="kobospan" id="kobo.126.1"><img alt="Figure 19.4 – Adding an environment variable in Vercel" src="image/B19385_19_4.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.127.1">Figure 19.4 – Adding an environment variable in Vercel</span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.128.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.129.1">For production apps, you would also set the </span><strong class="source-inline1"><span class="kobospan" id="kobo.130.1">JWT_SECRET</span></strong><span class="kobospan" id="kobo.131.1"> environment variable to a random secret here. </span><span class="kobospan" id="kobo.131.2">Additionally, you would set the </span><strong class="source-inline1"><span class="kobospan" id="kobo.132.1">BASE_URL</span></strong><span class="kobospan" id="kobo.133.1"> environment variable to the URL of the production deployment of your app. </span><span class="kobospan" id="kobo.133.2">For example, if the public URL of your blog is going to be </span><strong class="source-inline1"><span class="kobospan" id="kobo.134.1">https://ch19-omnidan.vercel.app/</span></strong><span class="kobospan" id="kobo.135.1">, you would set the </span><strong class="source-inline1"><span class="kobospan" id="kobo.136.1">BASE_URL</span></strong> <span><span class="kobospan" id="kobo.137.1">to that.</span></span></p>
<ol class="calibre15">
<li value="7" class="calibre11"><span class="kobospan" id="kobo.138.1">Click</span><a id="_idIndexMarker1038" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.139.1"> the </span><strong class="bold"><span class="kobospan" id="kobo.140.1">Save</span></strong><span class="kobospan" id="kobo.141.1"> button below the environment variables to save </span><span><span class="kobospan" id="kobo.142.1">your changes.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.143.1">Run the Vercel CLI again to attempt </span><span><span class="kobospan" id="kobo.144.1">another deployment:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.145.1">$ vercel</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.146.1">Alternatively, you can trigger a rebuild from the Vercel </span><span><span class="kobospan" id="kobo.147.1">web UI.</span></span></p></li> <li class="calibre11"><span class="kobospan" id="kobo.148.1">You will see that it deploys successfully now, visit the </span><strong class="bold"><span class="kobospan" id="kobo.149.1">Preview</span></strong><span class="kobospan" id="kobo.150.1"> URL provided by the Vercel CLI</span><a id="_idIndexMarker1039" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.151.1"> in your browser to see our blog application </span><span><span class="kobospan" id="kobo.152.1">loading successfully:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer159">
<span class="kobospan" id="kobo.153.1"><img alt="Figure 19.5 – Working “Preview” deployment of our app" src="image/B19385_19_5.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.154.1">Figure 19.5 – Working “Preview” deployment of our app</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.155.1">Interestingly, Vercel CLI now made a </span><strong class="bold"><span class="kobospan" id="kobo.156.1">Preview</span></strong><span class="kobospan" id="kobo.157.1"> deployment for us. </span><span class="kobospan" id="kobo.157.2">This is the default behavior in Vercel. </span><span class="kobospan" id="kobo.157.3">It will first deploy to a </span><strong class="bold"><span class="kobospan" id="kobo.158.1">Preview</span></strong><span class="kobospan" id="kobo.159.1"> environment, where we can test everything out to make sure our app works fine. </span><span class="kobospan" id="kobo.159.2">The </span><strong class="bold"><span class="kobospan" id="kobo.160.1">Preview</span></strong><span class="kobospan" id="kobo.161.1"> environment is only accessible if you are logged in via Vercel. </span><span class="kobospan" id="kobo.161.2">We can also invite others to test our app here and add comments to it via the Vercel toolbar at </span><span><span class="kobospan" id="kobo.162.1">the bottom.</span></span></p>
<ol class="calibre15">
<li value="10" class="calibre11"><span class="kobospan" id="kobo.163.1"> Now that we have confirmed our app works, we can deploy it to production, </span><span><span class="kobospan" id="kobo.164.1">as follows:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.165.1">$ vercel --prod</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.166.1">The following screenshot shows a </span><strong class="bold"><span class="kobospan" id="kobo.167.1">Preview</span></strong><span class="kobospan" id="kobo.168.1"> and a </span><strong class="bold"><span class="kobospan" id="kobo.169.1">Production</span></strong><span class="kobospan" id="kobo.170.1"> deployment being made</span><a id="_idIndexMarker1040" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.171.1"> with the </span><span><span class="kobospan" id="kobo.172.1">Vercel CLI:</span></span></p></li> </ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer160">
<span class="kobospan" id="kobo.173.1"><img alt="Figure 19.6 – Deploying our app to “Preview” and “Production” environments with the Vercel CLI" src="image/B19385_19_6.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.174.1">Figure 19.6 – Deploying our app to “Preview” and “Production” environments with the Vercel CLI</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.175.1">Now our app is deployed on the </span><strong class="bold"><span class="kobospan" id="kobo.176.1">Production</span></strong><span class="kobospan" id="kobo.177.1"> environment and is accessible to anyone, without having to log in </span><span><span class="kobospan" id="kobo.178.1">via Vercel!</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.179.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.180.1">The URL provided in the Vercel CLI output is not accessible to anyone; you need to use one of the domains specified in the </span><strong class="bold"><span class="kobospan" id="kobo.181.1">Domains</span></strong><span class="kobospan" id="kobo.182.1"> section on the Vercel dashboard. </span><span class="kobospan" id="kobo.182.2">The default should </span><span><span class="kobospan" id="kobo.183.1">be </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.184.1">https://ch19-&lt;vercel-username&gt;.vercel.app/</span></strong></span><span><span class="kobospan" id="kobo.185.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.186.1">As we can see, deploying our app with Vercel is very easy and convenient. </span><span class="kobospan" id="kobo.186.2">However, in some cases, we want to deploy our app on our own infrastructure. </span><span class="kobospan" id="kobo.186.3">Let’s learn how to create a custom deployment setup for Next.js </span><span><span class="kobospan" id="kobo.187.1">apps now.</span></span></p>
<h1 id="_idParaDest-345" class="calibre5"><a id="_idTextAnchor348" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.188.1">Creating a custom deployment setup for Next.js apps</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.189.1">We are</span><a id="_idIndexMarker1041" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.190.1"> now going to learn how to set up a custom deployment for Next.js apps using Docker. </span><span class="kobospan" id="kobo.190.2">We have already learned the </span><a id="_idIndexMarker1042" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.191.1">basics of deploying apps using Docker in </span><a href="B19385_05.xhtml#_idTextAnchor090" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.192.1">Chapter 5</span></em></span></a><span class="kobospan" id="kobo.193.1">, so please refer to that chapter if anything is unclear, or if you need a refresher on Docker. </span><span class="kobospan" id="kobo.193.2">Let’s get started setting up our Next.js app for a Docker </span><span><span class="kobospan" id="kobo.194.1">deployment now:</span></span></p>
<ol class="calibre15">
<li class="calibre11"><span class="kobospan" id="kobo.195.1">First, we need to change the output format for Next.js to </span><strong class="source-inline1"><span class="kobospan" id="kobo.196.1">standalone</span></strong><span class="kobospan" id="kobo.197.1">. </span><span class="kobospan" id="kobo.197.2">This option tells Next.js to create a </span><strong class="source-inline1"><span class="kobospan" id="kobo.198.1">.next/standalone</span></strong><span class="kobospan" id="kobo.199.1"> folder that only contains the</span><a id="_idIndexMarker1043" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.200.1"> necessary files for a production deployment, including only the necessary </span><strong class="source-inline1"><span class="kobospan" id="kobo.201.1">node_modules</span></strong><span class="kobospan" id="kobo.202.1">. </span><span class="kobospan" id="kobo.202.2">This </span><a id="_idIndexMarker1044" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.203.1">folder can then be deployed without having to install </span><strong class="source-inline1"><span class="kobospan" id="kobo.204.1">node_modules</span></strong><span class="kobospan" id="kobo.205.1"> again. </span><span class="kobospan" id="kobo.205.2">Edit </span><strong class="source-inline1"><span class="kobospan" id="kobo.206.1">next.config.mjs</span></strong><span class="kobospan" id="kobo.207.1"> and adjust the config, </span><span><span class="kobospan" id="kobo.208.1">as follows:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.209.1">
/** @type {import('next').NextConfig} */
const nextConfig = {
</span><strong class="bold1"><span class="kobospan1" id="kobo.210.1">  output: 'standalone',</span></strong><span class="kobospan1" id="kobo.211.1">
}
export default nextConfig</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.212.1">Now, we create a </span><strong class="source-inline1"><span class="kobospan" id="kobo.213.1">.dockerignore</span></strong><span class="kobospan" id="kobo.214.1"> file to ignore certain files that should not be included in </span><span><span class="kobospan" id="kobo.215.1">our image:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.216.1">
node_modules
.env*
.vscode
.git</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.217.1">Create a new </span><strong class="source-inline1"><span class="kobospan" id="kobo.218.1">Dockerfile</span></strong><span class="kobospan" id="kobo.219.1">, start by defining a </span><strong class="source-inline1"><span class="kobospan" id="kobo.220.1">base</span></strong><span class="kobospan" id="kobo.221.1"> image </span><span><span class="kobospan" id="kobo.222.1">from </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.223.1">node:20</span></strong></span><span><span class="kobospan" id="kobo.224.1">:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.225.1">
FROM node:20 AS base</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.226.1">Then, define a new image for building the app, based on the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.227.1">base</span></strong></span><span><span class="kobospan" id="kobo.228.1"> image:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.229.1">
FROM base AS build</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.230.1">Set the working directory to the </span><strong class="source-inline1"><span class="kobospan" id="kobo.231.1">/app</span></strong><span class="kobospan" id="kobo.232.1"> folder and copy over the </span><strong class="source-inline1"><span class="kobospan" id="kobo.233.1">package.json</span></strong><span class="kobospan" id="kobo.234.1"> and </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.235.1">package-lock.json</span></strong></span><span><span class="kobospan" id="kobo.236.1"> files:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.237.1">
WORKDIR /app
COPY package.json .
</span><span class="kobospan1" id="kobo.237.2">COPY package-lock.json .</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.238.1">Now, install</span><a id="_idIndexMarker1045" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.239.1"> all dependencies, and additionally install </span><strong class="source-inline1"><span class="kobospan" id="kobo.240.1">sharp</span></strong><span class="kobospan" id="kobo.241.1">, which is used by Next.js to resize and optimize images </span><span><span class="kobospan" id="kobo.242.1">in production:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.243.1">
RUN npm install
RUN npm install sharp</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.244.1">Copy over all files from </span><span><span class="kobospan" id="kobo.245.1">our project:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.246.1">
COPY . </span><span class="kobospan1" id="kobo.246.2">.</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.247.1">Next, define </span><a id="_idIndexMarker1046" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.248.1">the arguments for the build process. </span><span class="kobospan" id="kobo.248.2">We are going to define all environment variables here because Next.js also uses them during the build process to statically build </span><span><span class="kobospan" id="kobo.249.1">certain routes:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.250.1">
ARG DATABASE_URL
ARG JWT_SECRET
ARG BASE_URL</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.251.1">We can now run the </span><strong class="source-inline1"><span class="kobospan" id="kobo.252.1">build</span></strong><span class="kobospan" id="kobo.253.1"> command, </span><span><span class="kobospan" id="kobo.254.1">as follows:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.255.1">
RUN npm run build</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.256.1">Define a new image for the final app, based on the </span><strong class="source-inline1"><span class="kobospan" id="kobo.257.1">base</span></strong><span class="kobospan" id="kobo.258.1"> image </span><span><span class="kobospan" id="kobo.259.1">as well:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.260.1">
FROM base AS final</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.261.1">We also define the </span><span><span class="kobospan" id="kobo.262.1">working directory:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.263.1">
WORKDIR /app</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.264.1">We set up the permissions to run our app as a special </span><strong class="source-inline1"><span class="kobospan" id="kobo.265.1">nextjs</span></strong><span class="kobospan" id="kobo.266.1"> user instead </span><span><span class="kobospan" id="kobo.267.1">of root:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.268.1">
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.269.1">Now, copy over</span><a id="_idIndexMarker1047" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.270.1"> the necessary files to run a standalone Next.js server from the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.271.1">build</span></strong></span><span><span class="kobospan" id="kobo.272.1"> image:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.273.1">
COPY --from=build /app/public ./public
RUN mkdir -p .next
RUN chown nextjs:nodejs .next
COPY --from=build /app/.next/standalone ./
COPY --from=build /app/.next/static ./.next/static</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.274.1">We </span><a id="_idIndexMarker1048" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.275.1">define the </span><strong class="source-inline1"><span class="kobospan" id="kobo.276.1">PORT</span></strong><span class="kobospan" id="kobo.277.1">, </span><strong class="source-inline1"><span class="kobospan" id="kobo.278.1">HOSTNAME</span></strong><span class="kobospan" id="kobo.279.1">, and </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.280.1">NODE_ENV</span></strong></span><span><span class="kobospan" id="kobo.281.1"> variables:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.282.1">
EXPOSE 3000
ENV PORT 3000
ENV HOSTNAME "0.0.0.0"
ENV NODE_ENV production</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.283.1">Then, we execute the standalone Next.js server as the </span><strong class="source-inline1"><span class="kobospan" id="kobo.284.1">nextjs</span></strong><span class="kobospan" id="kobo.285.1"> user we </span><span><span class="kobospan" id="kobo.286.1">defined earlier:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.287.1">
USER nextjs
CMD ["node", "server.js"]</span></pre></li> <li class="calibre11"><span class="kobospan" id="kobo.288.1">Make sure the database server is running in a </span><span><span class="kobospan" id="kobo.289.1">Docker container.</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.290.1">Now we can build the Docker image by running the </span><span><span class="kobospan" id="kobo.291.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.292.1">$ docker build \</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.293.1">  -t blog-nextjs \</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.294.1">  --build-arg "DATABASE_URL=mongodb://host.docker.internal:27017/blog" \</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.295.1">  --build-arg "JWT_SECRET=replace-with-random-secret" \</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.296.1">  --build-arg "BASE_URL=http://localhost:3000" \</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.297.1">  .</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.298.1">In the preceding command, we specified </span><strong class="source-inline"><span class="kobospan" id="kobo.299.1">blog-nextjs</span></strong><span class="kobospan" id="kobo.300.1"> as the name for our image </span><a id="_idIndexMarker1049" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.301.1">and the necessary environment variables for building the image. </span><span class="kobospan" id="kobo.301.2">Do not forget the dot (</span><strong class="source-inline"><span class="kobospan" id="kobo.302.1">.</span></strong><span class="kobospan" id="kobo.303.1">) at the </span><a id="_idIndexMarker1050" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.304.1">end of the command, as that is what specifies the build context, including where to look for </span><span><span class="kobospan" id="kobo.305.1">the </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.306.1">Dockerfile</span></strong></span><span><span class="kobospan" id="kobo.307.1">!</span></span></p></li> </ol>
<p class="callout-heading"><span class="kobospan" id="kobo.308.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.309.1">You can check out the official example </span><strong class="source-inline1"><span class="kobospan" id="kobo.310.1">Dockerfile</span></strong><span class="kobospan" id="kobo.311.1"> from Next.js for an up-to-date </span><span><span class="kobospan" id="kobo.312.1">version: </span></span><a href="https://github.com/vercel/next.js/blob/canary/examples/with-docker/Dockerfile" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.313.1">https://github.com/vercel/next.js/blob/canary/examples/with-docker/Dockerfile</span></span></a></p>
<ol class="calibre15">
<li value="18" class="calibre11"><span class="kobospan" id="kobo.314.1">Finally, run a new Docker container, </span><span><span class="kobospan" id="kobo.315.1">as follows:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.316.1">$ docker run \</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.317.1">  -d \</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.318.1">  --name blog-app \</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.319.1">  -p 3000:3000 \</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.320.1">  -e "DATABASE_URL=mongodb://host.docker.internal:27017/blog" \</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.321.1">  -e "JWT_SECRET=replace-with-random-secret" \</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.322.1">  -e "BASE_URL=http://localhost:3000" \</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.323.1">  --restart unless-stopped \</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.324.1">  blog-nextjs</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.325.1">In the preceding command, we specified the running of a container with the name </span><strong class="source-inline"><span class="kobospan" id="kobo.326.1">blog-app</span></strong><span class="kobospan" id="kobo.327.1"> in the background (daemon mode) published to port </span><strong class="source-inline"><span class="kobospan" id="kobo.328.1">3000</span></strong><span class="kobospan" id="kobo.329.1">, then specified the environment variables and told Docker to restart the container if it crashes. </span><span class="kobospan" id="kobo.329.2">Lastly, we specified the image name, which is </span><strong class="source-inline"><span class="kobospan" id="kobo.330.1">blog-nextjs</span></strong><span class="kobospan" id="kobo.331.1"> (the image we built in the </span><span><span class="kobospan" id="kobo.332.1">previous step).</span></span></p></li> <li class="calibre11"><span class="kobospan" id="kobo.333.1">Visit </span><strong class="source-inline1"><span class="kobospan" id="kobo.334.1">http://localhost:3000</span></strong><span class="kobospan" id="kobo.335.1"> and you will see the blog </span><span><span class="kobospan" id="kobo.336.1">running successfully!</span></span></li>
</ol>
<p class="calibre3"><span class="kobospan" id="kobo.337.1">Now that we</span><a id="_idIndexMarker1051" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.338.1"> have a Docker container, we could </span><a id="_idIndexMarker1052" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.339.1">deploy it to a cloud service (or our own server), just like we did in </span><a href="B19385_05.xhtml#_idTextAnchor090" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.340.1">Chapter 5</span></em></span></a><span class="kobospan" id="kobo.341.1">. </span><span class="kobospan" id="kobo.341.2">While it is slightly more effort to set up a custom deployment for a Next.js app, it is still quite straightforward to do a </span><span><span class="kobospan" id="kobo.342.1">simple setup!</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.343.1">For more advanced setups, such as multiple instances, you would need to set up a shared volume between the instances so the cache and optimized images can be shared (on Vercel, this is done automatically behind the scenes). </span><span class="kobospan" id="kobo.343.2">However, such a setup is out of the scope of this book. </span><span class="kobospan" id="kobo.343.3">You can check out the Next.js docs on self-hosting for more information on how to do </span><span><span class="kobospan" id="kobo.344.1">this: </span></span><a href="https://nextjs.org/docs/app/building-your-application/deploying#self-hosting" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.345.1">https://nextjs.org/docs/app/building-your-application/deploying#self-hosting</span></span></a><span><span class="kobospan" id="kobo.346.1">.</span></span></p>
<h1 id="_idParaDest-346" class="calibre5"><a id="_idTextAnchor349" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.347.1">Summary</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.348.1">In this chapter, we first learned how to deploy a Next.js app using Vercel. </span><span class="kobospan" id="kobo.348.2">Then, we learned how to create a custom deployment setup </span><span><span class="kobospan" id="kobo.349.1">using Docker.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.350.1">In the next and final chapter, </span><a href="B19385_20.xhtml#_idTextAnchor350" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.351.1">Chapter 20</span></em></span></a><em class="italic"><span class="kobospan" id="kobo.352.1">, Diving Deeper into Full-stack Development</span></em><span class="kobospan" id="kobo.353.1">, we are going to briefly cover various advanced full-stack development topics that have been left out of this book so far, giving you an idea of how to continue your journey of learning full-stack web development </span><span><span class="kobospan" id="kobo.354.1">with React.</span></span></p>
</div>
</body></html>