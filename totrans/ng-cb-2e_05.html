<html><head></head><body>
<div class="Basic-Text-Frame" id="_idContainer103">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">5</span></h1>
<h1 class="chapterTitle" id="_idParaDest-157"><span class="koboSpan" id="kobo.2.1">Angular and RxJS – Awesomeness Combined</span></h1>
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.3.1">Angular</span></strong><span class="koboSpan" id="kobo.4.1"> and </span><strong class="keyWord"><span class="koboSpan" id="kobo.5.1">RxJS</span></strong><span class="koboSpan" id="kobo.6.1"> create a killer combination of awesomeness. </span><span class="koboSpan" id="kobo.6.2">By combining these, you can handle your data reactively, work with streams, and implement complex business logic in your Angular apps. </span><span class="koboSpan" id="kobo.6.3">That’s exactly what you’re going to learn about in this chapter.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.7.1">Here are the recipes we’re going to cover in this chapter:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.8.1">Sequential and parallel HTTP calls in Angular with RxJS</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.9.1">Listening to multiple observable streams</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.10.1">Unsubscribing streams to avoid memory leaks</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.11.1">Using Angular’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.12.1">async</span></code><span class="koboSpan" id="kobo.13.1"> pipe to unsubscribe streams automagically</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.14.1">Using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.15.1">map</span></code><span class="koboSpan" id="kobo.16.1"> operator to transform data</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.17.1">Using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.18.1">switchMap</span></code><span class="koboSpan" id="kobo.19.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.20.1">debounceTime</span></code><span class="koboSpan" id="kobo.21.1"> operators with autocompletes for better performance</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.22.1">Creating a custom RxJS operator</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.23.1">Retrying failed HTTP calls with RxJS</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-158"><span class="koboSpan" id="kobo.24.1">Technical requirements</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.25.1">For the recipes in this chapter, ensure your setup is complete as per the 'Technical Requirements' in the 'Angular-Cookbook-2E' GitHub repository. </span><span class="koboSpan" id="kobo.25.2">For setup details, visit: </span><a href="https://github.com/PacktPublishing/Angular-Cookbook-2E/tree/main/docs/technical-requirements.md"><span class="url"><span class="koboSpan" id="kobo.26.1">https://github.com/PacktPublishing/Angular-Cookbook-2E/tree/main/docs/technical-requirements.md</span></span></a><span class="koboSpan" id="kobo.27.1">. </span><span class="koboSpan" id="kobo.27.2">The starter code for this chapter is located at </span><a href="https://github.com/PacktPublishing/Angular-Cookbook-2E/tree/main/start/apps/chapter05"><span class="url"><span class="koboSpan" id="kobo.28.1">https://github.com/PacktPublishing/Angular-Cookbook-2E/tree/main/start/apps/chapter05</span></span></a><span class="koboSpan" id="kobo.29.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-159"><span class="koboSpan" id="kobo.30.1">Sequential and parallel http calls in Angular with RxJS</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.31.1">In this recipe, you’ll learn </span><a id="_idIndexMarker286"/><span class="koboSpan" id="kobo.32.1">how to use different RxJS operators to make sequential and parallel HTTP calls in Angular apps. </span><span class="koboSpan" id="kobo.32.2">We’ll work with the famous </span><a id="_idIndexMarker287"/><span class="koboSpan" id="kobo.33.1">Star Wars API (</span><strong class="keyWord"><span class="koboSpan" id="kobo.34.1">swapi</span></strong><span class="koboSpan" id="kobo.35.1">) to get some data to display on the UI.</span></p>
<h2 class="heading-2" id="_idParaDest-160"><span class="koboSpan" id="kobo.36.1">Getting ready</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.37.1">The app that we are going to work with resides in </span><code class="inlineCode"><span class="koboSpan" id="kobo.38.1">start/apps/chapter05/rx-seq-parallel-http</span></code><span class="koboSpan" id="kobo.39.1"> inside the cloned repository:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.40.1">Open the code repository in your code editor.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.41.1">Open the terminal, navigate to the code repository directory, and run the following command to serve the project:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.42.1">npm run serve rx-seq-parallel-http
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.43.1">This should open the app in a new browser tab, and you should see the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.44.1"><img alt="" role="presentation" src="../Images/B18469_05_01.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.45.1">Figure 5.1: The rx-seq-parallel-http app running on http://localhost:4200</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.46.1">Now that we have the app running, we will move on to the steps for the recipe.</span></p>
<h2 class="heading-2" id="_idParaDest-161"><span class="koboSpan" id="kobo.47.1">How to do it…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.48.1">We have an </span><a id="_idIndexMarker288"/><span class="koboSpan" id="kobo.49.1">Angular app that uses the Star Wars API (swapi) to fetch a person from Star Wars, and the films the person has been in. </span><span class="koboSpan" id="kobo.49.2">All of this happens using a lot of HTTP calls, and our code is totally garbage so far. </span><span class="koboSpan" id="kobo.49.3">This is because we first show the loader, but we hide it before we’ve retrieved all the data. </span><span class="koboSpan" id="kobo.49.4">Also, if you keep refreshing the page, you’ll see that the sequence of the films can change each time. </span><span class="koboSpan" id="kobo.49.5">Hence, we see the UI jumping a lot. </span><span class="koboSpan" id="kobo.49.6">Our desired approach is to fetch the person, then fetch all the films, and then hide the loader. </span><span class="koboSpan" id="kobo.49.7">We will implement this approach using RxJS. </span><span class="koboSpan" id="kobo.49.8">Let’s begin:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.50.1">First, we’ll avoid using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.51.1">setTimeout</span></code><span class="koboSpan" id="kobo.52.1"> function to rely on the person data being available in </span><code class="inlineCode"><span class="koboSpan" id="kobo.53.1">1500ms</span></code><span class="koboSpan" id="kobo.54.1">. </span><span class="koboSpan" id="kobo.54.2">We would rather move this inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.55.1">subscribe</span></code><span class="koboSpan" id="kobo.56.1"> block and will also handle errors appropriately. </span><span class="koboSpan" id="kobo.56.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.57.1">fetchData</span></code><span class="koboSpan" id="kobo.58.1"> method inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.59.1">app.component.ts</span></code><span class="koboSpan" id="kobo.60.1"> as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-title"><span class="koboSpan" id="kobo.61.1">fetchData</span></span><span class="koboSpan" id="kobo.62.1">() {
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.63.1">this</span></span><span class="koboSpan" id="kobo.64.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.65.1">loadingData</span></span><span class="koboSpan" id="kobo.66.1"> = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.67.1">true</span></span><span class="koboSpan" id="kobo.68.1">;
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.69.1">this</span></span><span class="koboSpan" id="kobo.70.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.71.1">swapi</span></span><span class="koboSpan" id="kobo.72.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.73.1">fetchPerson</span></span><span class="koboSpan" id="kobo.74.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.75.1">'1'</span></span><span class="koboSpan" id="kobo.76.1">).</span><span class="hljs-title"><span class="koboSpan" id="kobo.77.1">subscribe</span></span><span class="koboSpan" id="kobo.78.1">({
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.79.1">next</span></span><span class="koboSpan" id="kobo.80.1">: </span><span class="hljs-function"><span class="koboSpan" id="kobo.81.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.82.1">person</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.83.1">) =&gt;</span></span><span class="koboSpan" id="kobo.84.1"> {
          </span><span class="hljs-variable"><span class="koboSpan" id="kobo.85.1">this</span></span><span class="koboSpan" id="kobo.86.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.87.1">person</span></span><span class="koboSpan" id="kobo.88.1"> = person;
          </span><span class="hljs-variable"><span class="koboSpan" id="kobo.89.1">this</span></span><span class="koboSpan" id="kobo.90.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.91.1">person</span></span><span class="koboSpan" id="kobo.92.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.93.1">filmObjects</span></span><span class="koboSpan" id="kobo.94.1"> = [];
          </span><span class="hljs-variable"><span class="koboSpan" id="kobo.95.1">this</span></span><span class="koboSpan" id="kobo.96.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.97.1">person</span></span><span class="koboSpan" id="kobo.98.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.99.1">films</span></span><span class="koboSpan" id="kobo.100.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.101.1">forEach</span></span><span class="koboSpan" id="kobo.102.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.103.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.104.1">filmUrl</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.105.1">) =&gt;</span></span><span class="koboSpan" id="kobo.106.1"> {
            </span><span class="hljs-variable"><span class="koboSpan" id="kobo.107.1">this</span></span><span class="koboSpan" id="kobo.108.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.109.1">swapi</span></span><span class="koboSpan" id="kobo.110.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.111.1">fetchFilm</span></span><span class="koboSpan" id="kobo.112.1">(filmUrl).</span><span class="hljs-title"><span class="koboSpan" id="kobo.113.1">subscribe</span></span><span class="koboSpan" id="kobo.114.1">({
              </span><span class="hljs-attr"><span class="koboSpan" id="kobo.115.1">next</span></span><span class="koboSpan" id="kobo.116.1">: </span><span class="hljs-function"><span class="koboSpan" id="kobo.117.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.118.1">film</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.119.1">) =&gt;</span></span><span class="koboSpan" id="kobo.120.1"> {
                </span><span class="hljs-variable"><span class="koboSpan" id="kobo.121.1">this</span></span><span class="koboSpan" id="kobo.122.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.123.1">person</span></span><span class="koboSpan" id="kobo.124.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.125.1">filmObjects</span></span><span class="koboSpan" id="kobo.126.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.127.1">push</span></span><span class="koboSpan" id="kobo.128.1">(film);
                </span><span class="hljs-variable"><span class="koboSpan" id="kobo.129.1">this</span></span><span class="koboSpan" id="kobo.130.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.131.1">loadingData</span></span><span class="koboSpan" id="kobo.132.1"> = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.133.1">false</span></span><span class="koboSpan" id="kobo.134.1">;
              },
              </span><span class="hljs-attr"><span class="koboSpan" id="kobo.135.1">error</span></span><span class="koboSpan" id="kobo.136.1">: </span><span class="hljs-function"><span class="koboSpan" id="kobo.137.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.138.1">err</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.139.1">) =&gt;</span></span><span class="koboSpan" id="kobo.140.1"> {
                </span><span class="hljs-variable"><span class="koboSpan" id="kobo.141.1">console</span></span><span class="koboSpan" id="kobo.142.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.143.1">error</span></span><span class="koboSpan" id="kobo.144.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.145.1">'Error while fetching film'</span></span><span class="koboSpan" id="kobo.146.1">,
                  err);
              },
            });
          });
      },
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.147.1">error</span></span><span class="koboSpan" id="kobo.148.1">: </span><span class="hljs-function"><span class="koboSpan" id="kobo.149.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.150.1">err</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.151.1">) =&gt;</span></span><span class="koboSpan" id="kobo.152.1"> {
        </span><span class="hljs-variable"><span class="koboSpan" id="kobo.153.1">console</span></span><span class="koboSpan" id="kobo.154.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.155.1">error</span></span><span class="koboSpan" id="kobo.156.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.157.1">'Error while fetching person'</span></span><span class="koboSpan" id="kobo.158.1">, err);
      }
    });
  }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.159.1">This has a potential problem. </span><span class="koboSpan" id="kobo.159.2">And that is, as soon as the first film is retrieved, the loader is hidden because we set </span><code class="inlineCode"><span class="koboSpan" id="kobo.160.1">this.loadingData</span></code><span class="koboSpan" id="kobo.161.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.162.1">false</span></code><span class="koboSpan" id="kobo.163.1">.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="2"><span class="koboSpan" id="kobo.164.1">Now, we will add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.165.1">mergeMap</span></code><span class="koboSpan" id="kobo.166.1"> operator using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.167.1">pipe</span></code><span class="koboSpan" id="kobo.168.1"> method to be able to chain calls later. </span><span class="koboSpan" id="kobo.168.2">For now, we will just move the code for adding the </span><code class="inlineCode"><span class="koboSpan" id="kobo.169.1">filmObjects</span></code><span class="koboSpan" id="kobo.170.1"> array in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.171.1">this.person</span></code><span class="koboSpan" id="kobo.172.1"> object inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.173.1">mergeMap</span></code><span class="koboSpan" id="kobo.174.1"> callback. </span><span class="koboSpan" id="kobo.174.2">Update</span><a id="_idIndexMarker289"/><span class="koboSpan" id="kobo.175.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.176.1">fetchData</span></code><span class="koboSpan" id="kobo.177.1"> method as follows now:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.178.1">...
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.179.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.180.1"> { mergeMap, </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.181.1">of</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.182.1"> } </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.183.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.184.1">'</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.185.1">rxjs'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.186.1">;</span></strong></span><span class="koboSpan" id="kobo.187.1">
...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.188.1">fetchData</span></span><span class="koboSpan" id="kobo.189.1">() {
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.190.1">this</span></span><span class="koboSpan" id="kobo.191.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.192.1">loadingData</span></span><span class="koboSpan" id="kobo.193.1"> = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.194.1">true</span></span><span class="koboSpan" id="kobo.195.1">;
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.196.1">this</span></span><span class="koboSpan" id="kobo.197.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.198.1">swapi</span></span><span class="koboSpan" id="kobo.199.1">
      .</span><span class="hljs-title"><span class="koboSpan" id="kobo.200.1">fetchPerson</span></span><span class="koboSpan" id="kobo.201.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.202.1">'1'</span></span><span class="koboSpan" id="kobo.203.1">)
      .</span><span class="hljs-title"><span class="koboSpan" id="kobo.204.1">pipe</span></span><span class="koboSpan" id="kobo.205.1">(
        </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.206.1">mergeMap</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.207.1">((person) =&gt; {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.208.1">const</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.209.1"> personObj = {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.210.1">...person,</span></strong></span>
<span class="code-highlight"><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.211.1">filmObjects</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.212.1">: [],</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.213.1">};</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.214.1">return </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.215.1">of</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.216.1">(personObj);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.217.1">})</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.218.1">)</span></strong></span><span class="koboSpan" id="kobo.219.1">
      .</span><span class="hljs-title"><span class="koboSpan" id="kobo.220.1">subscribe</span></span><span class="koboSpan" id="kobo.221.1">({
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.222.1">next</span></span><span class="koboSpan" id="kobo.223.1">: </span><span class="hljs-function"><span class="koboSpan" id="kobo.224.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.225.1">person</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.226.1">) =&gt;</span></span><span class="koboSpan" id="kobo.227.1"> {
          </span><span class="hljs-variable"><span class="koboSpan" id="kobo.228.1">this</span></span><span class="koboSpan" id="kobo.229.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.230.1">person</span></span><span class="koboSpan" id="kobo.231.1"> = person;
          </span><span class="hljs-variable"><span class="koboSpan" id="kobo.232.1">this</span></span><span class="koboSpan" id="kobo.233.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.234.1">person</span></span><span class="koboSpan" id="kobo.235.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.236.1">films</span></span><span class="koboSpan" id="kobo.237.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.238.1">forEach</span></span><span class="koboSpan" id="kobo.239.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.240.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.241.1">filmUrl</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.242.1">) =&gt;</span></span><span class="koboSpan" id="kobo.243.1"> {
            </span><span class="hljs-variable"><span class="koboSpan" id="kobo.244.1">this</span></span><span class="koboSpan" id="kobo.245.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.246.1">swapi</span></span><span class="koboSpan" id="kobo.247.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.248.1">fetchFilm</span></span><span class="koboSpan" id="kobo.249.1">(filmUrl).</span><span class="hljs-title"><span class="koboSpan" id="kobo.250.1">subscribe</span></span><span class="koboSpan" id="kobo.251.1">({
              </span><span class="hljs-attr"><span class="koboSpan" id="kobo.252.1">next</span></span><span class="koboSpan" id="kobo.253.1">: </span><span class="hljs-function"><span class="koboSpan" id="kobo.254.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.255.1">film</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.256.1">) =&gt;</span></span><span class="koboSpan" id="kobo.257.1"> {
                </span><span class="hljs-variable"><span class="koboSpan" id="kobo.258.1">this</span></span><span class="koboSpan" id="kobo.259.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.260.1">person</span></span><span class="koboSpan" id="kobo.261.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.262.1">filmObjects</span></span><span class="koboSpan" id="kobo.263.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.264.1">push</span></span><span class="koboSpan" id="kobo.265.1">(film);
                </span><span class="hljs-variable"><span class="koboSpan" id="kobo.266.1">this</span></span><span class="koboSpan" id="kobo.267.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.268.1">loadingData</span></span><span class="koboSpan" id="kobo.269.1"> = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.270.1">false</span></span><span class="koboSpan" id="kobo.271.1">;
              },
              </span><span class="hljs-attr"><span class="koboSpan" id="kobo.272.1">error</span></span><span class="koboSpan" id="kobo.273.1">: </span><span class="hljs-function"><span class="koboSpan" id="kobo.274.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.275.1">err</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.276.1">) =&gt;</span></span><span class="koboSpan" id="kobo.277.1"> {
                </span><span class="hljs-variable"><span class="koboSpan" id="kobo.278.1">console</span></span><span class="koboSpan" id="kobo.279.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.280.1">error</span></span><span class="koboSpan" id="kobo.281.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.282.1">'Error while fetching film'</span></span><span class="koboSpan" id="kobo.283.1">, err);
              },
            });
          });
        },
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.284.1">error</span></span><span class="koboSpan" id="kobo.285.1">: </span><span class="hljs-function"><span class="koboSpan" id="kobo.286.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.287.1">err</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.288.1">) =&gt;</span></span><span class="koboSpan" id="kobo.289.1"> {
          </span><span class="hljs-variable"><span class="koboSpan" id="kobo.290.1">console</span></span><span class="koboSpan" id="kobo.291.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.292.1">error</span></span><span class="koboSpan" id="kobo.293.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.294.1">'Error while fetching person'</span></span><span class="koboSpan" id="kobo.295.1">, err);
        },
      });
  }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.296.1">Notice that the UI becomes </span><em class="italic"><span class="koboSpan" id="kobo.297.1">a bit better</span></em><span class="koboSpan" id="kobo.298.1">. </span><span class="koboSpan" id="kobo.298.2">The loader still hides as soon as one of the films is retrieved from the server. </span><span class="koboSpan" id="kobo.298.3">However, we want to hide the loader when all of them have been retrieved. </span><span class="koboSpan" id="kobo.298.4">Also, the sequence of the films is still unpredictable.</span></p> </li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.299.1">Now, we’ll </span><a id="_idIndexMarker290"/><span class="koboSpan" id="kobo.300.1">use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.301.1">forkJoin</span></code><span class="koboSpan" id="kobo.302.1"> function to make the API calls for the films in parallel and to wait for the combined response. </span><span class="koboSpan" id="kobo.302.2">We’re doing it instead of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.303.1">of</span></code><span class="koboSpan" id="kobo.304.1"> operator, which just passes the film URLs from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.305.1">mergeMap</span></code><span class="koboSpan" id="kobo.306.1"> function. </span><span class="koboSpan" id="kobo.306.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.307.1">fetchData</span></code><span class="koboSpan" id="kobo.308.1"> method as follows and update the imports at the top:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.309.1">import</span></span><span class="koboSpan" id="kobo.310.1"> { </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.311.1">forkJoin,</span></strong></span><span class="koboSpan" id="kobo.312.1"> mergeMap, </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.313.1">of</span></span> <span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.314.1">(//&lt;-- remove of)</span></strong></span><span class="koboSpan" id="kobo.315.1"> } from 'rxjs';
...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.316.1">fetchData</span></span><span class="koboSpan" id="kobo.317.1">() {
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.318.1">this</span></span><span class="koboSpan" id="kobo.319.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.320.1">loadingData</span></span><span class="koboSpan" id="kobo.321.1"> = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.322.1">true</span></span><span class="koboSpan" id="kobo.323.1">;
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.324.1">this</span></span><span class="koboSpan" id="kobo.325.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.326.1">swapi</span></span><span class="koboSpan" id="kobo.327.1">
      .</span><span class="hljs-title"><span class="koboSpan" id="kobo.328.1">fetchPerson</span></span><span class="koboSpan" id="kobo.329.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.330.1">'1'</span></span><span class="koboSpan" id="kobo.331.1">)
      .</span><span class="hljs-title"><span class="koboSpan" id="kobo.332.1">pipe</span></span><span class="koboSpan" id="kobo.333.1">(
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.334.1">mergeMap</span></span><span class="koboSpan" id="kobo.335.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.336.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.337.1">person</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.338.1">) =&gt;</span></span><span class="koboSpan" id="kobo.339.1"> {
          </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.340.1">const</span></span><span class="koboSpan" id="kobo.341.1"> personObj = {
            ...person,
            </span><span class="hljs-attr"><span class="koboSpan" id="kobo.342.1">filmObjects</span></span><span class="koboSpan" id="kobo.343.1">: [],
          };
          </span><span class="hljs-variable"><span class="koboSpan" id="kobo.344.1">this</span></span><span class="koboSpan" id="kobo.345.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.346.1">person</span></span><span class="koboSpan" id="kobo.347.1"> = personObj;
          </span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.348.1">return</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.349.1"> forkJoin</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.350.1">(</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.351.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.352.1">.person.films.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.353.1">map</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.354.1">((filmUrl) =&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.355.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.356.1">.swapi</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.357.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.358.1">fetchFilm</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.359.1">(filmUrl))</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.360.1">);</span></strong></span><span class="koboSpan" id="kobo.361.1">
        }),
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.362.1">catchError</span></span><span class="koboSpan" id="kobo.363.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.364.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.365.1">err</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.366.1">) =&gt;</span></span><span class="koboSpan" id="kobo.367.1"> {
          </span><span class="hljs-variable"><span class="koboSpan" id="kobo.368.1">console</span></span><span class="koboSpan" id="kobo.369.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.370.1">error</span></span><span class="koboSpan" id="kobo.371.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.372.1">'Error while fetching films'</span></span><span class="koboSpan" id="kobo.373.1">, err);
          </span><span class="hljs-title"><span class="koboSpan" id="kobo.374.1">alert</span></span><span class="koboSpan" id="kobo.375.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.376.1">'Could not get films. </span><span class="koboSpan" id="kobo.376.2">Please try again.'</span></span><span class="koboSpan" id="kobo.377.1">);
          </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.378.1">return</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.379.1">of</span></span><span class="koboSpan" id="kobo.380.1">([]);
        })
      )
      .</span><span class="hljs-title"><span class="koboSpan" id="kobo.381.1">subscribe</span></span><span class="koboSpan" id="kobo.382.1">({
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.383.1">next</span></span><span class="koboSpan" id="kobo.384.1">: </span><span class="hljs-function"><span class="koboSpan" id="kobo.385.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.386.1">films</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.387.1">) =&gt;</span></span><span class="koboSpan" id="kobo.388.1"> {
          </span><span class="hljs-variable"><span class="koboSpan" id="kobo.389.1">this</span></span><span class="koboSpan" id="kobo.390.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.391.1">person</span></span><span class="koboSpan" id="kobo.392.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.393.1">filmObjects</span></span><span class="koboSpan" id="kobo.394.1"> = films;
          </span><span class="hljs-variable"><span class="koboSpan" id="kobo.395.1">this</span></span><span class="koboSpan" id="kobo.396.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.397.1">loadingData</span></span><span class="koboSpan" id="kobo.398.1"> = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.399.1">false</span></span><span class="koboSpan" id="kobo.400.1">;
        },
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.401.1">error</span></span><span class="koboSpan" id="kobo.402.1">: </span><span class="hljs-function"><span class="koboSpan" id="kobo.403.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.404.1">err</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.405.1">) =&gt;</span></span><span class="koboSpan" id="kobo.406.1"> {
          </span><span class="hljs-variable"><span class="koboSpan" id="kobo.407.1">console</span></span><span class="koboSpan" id="kobo.408.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.409.1">error</span></span><span class="koboSpan" id="kobo.410.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.411.1">'Error while fetching person'</span></span><span class="koboSpan" id="kobo.412.1">, err);
        },
      });
  }
</span></code></pre>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.413.1">Woohoo! </span><span class="koboSpan" id="kobo.413.2">Now if you refresh the app, you’ll notice two things. </span><span class="koboSpan" id="kobo.413.3">First, the loader always stops only when all the data has been fetched. </span><span class="koboSpan" id="kobo.413.4">And second, the sequence of the films is always the same (and correct).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.414.1">Now that you’ve finished the recipe, let’s move on to the next section to understand how it all works.</span></p>
<h2 class="heading-2" id="_idParaDest-162"><span class="koboSpan" id="kobo.415.1">How it works…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.416.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.417.1">mergeMap</span></code><span class="koboSpan" id="kobo.418.1"> operator </span><a id="_idIndexMarker291"/><span class="koboSpan" id="kobo.419.1">allows us to chain observables by returning an </span><strong class="keyWord"><span class="koboSpan" id="kobo.420.1">observable</span></strong><span class="koboSpan" id="kobo.421.1"> from its callback. </span><span class="koboSpan" id="kobo.421.2">You can think of it like how we chain </span><code class="inlineCode"><span class="koboSpan" id="kobo.422.1">Promise.then</span></code><span class="koboSpan" id="kobo.423.1">, but this is for observables. </span><span class="koboSpan" id="kobo.423.2">A popular alternative is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.424.1">switchMap</span></code><span class="koboSpan" id="kobo.425.1"> operator, which works like the </span><code class="inlineCode"><span class="koboSpan" id="kobo.426.1">mergeMap</span></code><span class="koboSpan" id="kobo.427.1"> operator but also cancels the previous call/execution if called twice or more before the first call/execution completes. </span><span class="koboSpan" id="kobo.427.2">We first removed the </span><code class="inlineCode"><span class="koboSpan" id="kobo.428.1">setTimeout</span></code><span class="koboSpan" id="kobo.429.1"> function (which is mostly nonsensical to put into the code for these cases because the result is not always predictable with respect to time) and moved the logic of fetching films inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.430.1">subscribe</span></code><span class="koboSpan" id="kobo.431.1"> block of fetching the person. </span><span class="koboSpan" id="kobo.431.2">We also used the </span><code class="inlineCode"><span class="koboSpan" id="kobo.432.1">of</span></code><span class="koboSpan" id="kobo.433.1"> operator to return the </span><code class="inlineCode"><span class="koboSpan" id="kobo.434.1">personObject</span></code><span class="koboSpan" id="kobo.435.1"> object from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.436.1">mergeMap</span></code><span class="koboSpan" id="kobo.437.1"> function’s callback. </span><span class="koboSpan" id="kobo.437.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.438.1">mergeMap</span></code><span class="koboSpan" id="kobo.439.1"> function is used to chain observables together and, in our context, it can be chained to wait for one HTTP call to finish so we can execute the other ones. </span><span class="koboSpan" id="kobo.439.2">In </span><em class="italic"><span class="koboSpan" id="kobo.440.1">step 3</span></em><span class="koboSpan" id="kobo.441.1">, we intend to execute multiple HTTP calls together in parallel for all the films for the person. </span><span class="koboSpan" id="kobo.441.2">We do this using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.442.1">forkJoin</span></code><span class="koboSpan" id="kobo.443.1"> operator, which takes an array of observables. </span><span class="koboSpan" id="kobo.443.2">In this case, those observables are HTTP calls for each film. </span><code class="inlineCode"><span class="koboSpan" id="kobo.444.1">forkJoin</span></code><span class="koboSpan" id="kobo.445.1"> also makes it possible to wait for all the parallel calls to finish and then trigger the </span><code class="inlineCode"><span class="koboSpan" id="kobo.446.1">subscribe</span></code><span class="koboSpan" id="kobo.447.1"> block’s callback. </span><span class="koboSpan" id="kobo.447.2">One more thing </span><code class="inlineCode"><span class="koboSpan" id="kobo.448.1">forkJoin</span></code><span class="koboSpan" id="kobo.449.1"> does is it provides us with the responses in the form of an array having the responses in the same sequences as the observables. </span><span class="koboSpan" id="kobo.449.2">This makes the responses predictable, and we always show the same data on the UI.</span></p>
<h2 class="heading-2" id="_idParaDest-163"><span class="koboSpan" id="kobo.450.1">See also</span></h2>
<ul>
<li class="bulletList"><em class="italic"><span class="koboSpan" id="kobo.451.1">Catch the Dot Game</span></em><span class="koboSpan" id="kobo.452.1">—RxJS documentation (</span><a href="https://www.learnrxjs.io/learn-rxjs/recipes/catch-the-dot-game"><span class="url"><span class="koboSpan" id="kobo.453.1">https://www.learnrxjs.io/learn-rxjs/recipes/catch-the-dot-game</span></span></a><span class="koboSpan" id="kobo.454.1">)</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.455.1">RxJS </span><code class="inlineCode"><span class="koboSpan" id="kobo.456.1">mergeMap</span></code><span class="koboSpan" id="kobo.457.1"> operator documentation (</span><a href="https://www.learnrxjs.io/learn-rxjs/operators/transformation/mergemap"><span class="url"><span class="koboSpan" id="kobo.458.1">https://www.learnrxjs.io/learn-rxjs/operators/transformation/mergemap</span></span></a><span class="koboSpan" id="kobo.459.1">)</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.460.1">RxJS </span><code class="inlineCode"><span class="koboSpan" id="kobo.461.1">merge</span></code><span class="koboSpan" id="kobo.462.1"> operator documentation (</span><a href="https://www.learnrxjs.io/learn-rxjs/operators/combination/forkjoin"><span class="url"><span class="koboSpan" id="kobo.463.1">https://www.learnrxjs.io/learn-rxjs/operators/combination/forkjoin</span></span></a><span class="koboSpan" id="kobo.464.1">)</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-164"><span class="koboSpan" id="kobo.465.1">Listening to multiple observable streams</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.466.1">In this recipe, we’ll work with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.467.1">combineLatest</span></code><span class="koboSpan" id="kobo.468.1"> operator to listen to multiple observable </span><a id="_idIndexMarker292"/><span class="koboSpan" id="kobo.469.1">streams at once. </span><span class="koboSpan" id="kobo.469.2">Using this operator results in having an array as an output, combining all the streams. </span><span class="koboSpan" id="kobo.469.3">This approach is appropriate for when you want the latest output from all the streams, combined in a single subscription.</span></p>
<h2 class="heading-2" id="_idParaDest-165"><span class="koboSpan" id="kobo.470.1">Getting ready</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.471.1">The app that we are going to work with resides in </span><code class="inlineCode"><span class="koboSpan" id="kobo.472.1">start/apps/chapter05/rx-multiple-streams</span></code><span class="koboSpan" id="kobo.473.1"> inside the cloned repository:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.474.1">Open the code repository in your code editor.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.475.1">Open the terminal, navigate to the code repository directory, and run the following command to serve the project:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.476.1">npm run serve rx-multiple-streams
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.477.1">This should open the app in a new browser tab, and you should see the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.478.1"><img alt="" role="presentation" src="../Images/B18469_05_02.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.479.1">Figure 5.2: The rx-multiple-streams app running on http://localhost:4200</span></p> </li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.480.1">Now that we have the app running locally, let’s see the steps of the recipe in the next section.</span></p>
<h2 class="heading-2" id="_idParaDest-166"><span class="koboSpan" id="kobo.481.1">How to do it…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.482.1">For this recipe, we</span><a id="_idIndexMarker293"/><span class="koboSpan" id="kobo.483.1"> have an app that displays a box. </span><span class="koboSpan" id="kobo.483.2">The box has a size (width and height), a border radius, a background color, and a color for its text. </span><span class="koboSpan" id="kobo.483.3">It also has four inputs using</span><a id="_idIndexMarker294"/><span class="koboSpan" id="kobo.484.1"> the </span><strong class="keyWord"><span class="koboSpan" id="kobo.485.1">Reactive Forms</span></strong><span class="koboSpan" id="kobo.486.1"> API to modify all the mentioned factors. </span><span class="koboSpan" id="kobo.486.2">Right now, we have to apply the changes manually with the click of a button even if the inputs change. </span><span class="koboSpan" id="kobo.486.3">What if we could subscribe to the changes to the inputs and update the box right away without having the user click the button? </span><span class="koboSpan" id="kobo.486.4">That’s what we’re going to do here:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.487.1">We’ll begin by creating a method named </span><code class="inlineCode"><span class="koboSpan" id="kobo.488.1">listenToInputChanges</span></code><span class="koboSpan" id="kobo.489.1">. </span><span class="koboSpan" id="kobo.489.2">We’ll create an array of controls we want to work with. </span><span class="koboSpan" id="kobo.489.3">Update the code of </span><code class="inlineCode"><span class="koboSpan" id="kobo.490.1">home.component.ts</span></code><span class="koboSpan" id="kobo.491.1"> as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.492.1">...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.493.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.494.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.495.1">HomeComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.496.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.497.1">OnInit</span></span><span class="koboSpan" id="kobo.498.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.499.1">ngOnInit</span></span><span class="koboSpan" id="kobo.500.1">() {
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.501.1">this</span></span><span class="koboSpan" id="kobo.502.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.503.1">applyChanges</span></span><span class="koboSpan" id="kobo.504.1">();
  }
  </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.505.1">listenToInputChanges</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.506.1">() {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.507.1">const</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.508.1">controls</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.509.1">: </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.510.1">AbstractControl</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.511.1">[] = [</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.512.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.513.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.514.1">boxForm</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.515.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.516.1">controls</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.517.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.518.1">size</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.519.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.520.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.521.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.522.1">boxForm</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.523.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.524.1">controls</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.525.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.526.1">borderRadius</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.527.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.528.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.529.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.530.1">boxForm</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.531.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.532.1">controls</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.533.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.534.1">textColor</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.535.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.536.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.537.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.538.1">boxForm</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.539.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.540.1">controls</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.541.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.542.1">backgroundColor</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.543.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.544.1">];</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.545.1">}</span></strong></span><span class="koboSpan" id="kobo.546.1">
  ...
</span><span class="koboSpan" id="kobo.546.2">}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.547.1">Now we’ll loop over the controls to give them the initial value so that when the observable stream is subscribed, they have a value to work with. </span><span class="koboSpan" id="kobo.547.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.548.1">listenToInputChanges</span></code><span class="koboSpan" id="kobo.549.1"> method further as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.550.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.551.1"> { startWith } </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.552.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.553.1">'rxjs'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.554.1">;</span></strong></span><span class="koboSpan" id="kobo.555.1">
...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.556.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.557.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.558.1">HomeComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.559.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.560.1">OnInit</span></span><span class="koboSpan" id="kobo.561.1"> {
...
</span><span class="hljs-title"><span class="koboSpan" id="kobo.562.1">listenToInputChanges</span></span><span class="koboSpan" id="kobo.563.1">() {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.564.1">const</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.565.1">controls</span></span><span class="koboSpan" id="kobo.566.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.567.1">AbstractControl</span></span><span class="koboSpan" id="kobo.568.1">[] = [...];
    controls.</span><span class="hljs-title"><span class="koboSpan" id="kobo.569.1">map</span></span><span class="koboSpan" id="kobo.570.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.571.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.572.1">control</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.573.1">) =&gt;</span></span><span class="koboSpan" id="kobo.574.1">
      control.</span><span class="hljs-property"><span class="koboSpan" id="kobo.575.1">valueChanges</span></span><span class="koboSpan" id="kobo.576.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.577.1">pipe</span></span><span class="koboSpan" id="kobo.578.1">(</span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.579.1">startWith</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.580.1">(control.value)</span></strong></span><span class="koboSpan" id="kobo.581.1">)
    );
  }
}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.582.1">Now we’ll </span><a id="_idIndexMarker295"/><span class="koboSpan" id="kobo.583.1">replace the </span><code class="inlineCode"><span class="koboSpan" id="kobo.584.1">boxStyles</span></code><span class="koboSpan" id="kobo.585.1"> property with an </span><code class="inlineCode"><span class="koboSpan" id="kobo.586.1">Observable</span></code><span class="koboSpan" id="kobo.587.1"> named </span><code class="inlineCode"><span class="koboSpan" id="kobo.588.1">boxStyles$</span></code><span class="koboSpan" id="kobo.589.1">. </span><span class="koboSpan" id="kobo.589.2">Then we’ll wrap the </span><code class="inlineCode"><span class="koboSpan" id="kobo.590.1">valueChanges</span></code><span class="koboSpan" id="kobo.591.1"> streams of each form control inside a </span><code class="inlineCode"><span class="koboSpan" id="kobo.592.1">combineLatest</span></code><span class="koboSpan" id="kobo.593.1"> operator to join them. </span><span class="koboSpan" id="kobo.593.2">Finally, we’ll assign the result of this joined stream to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.594.1">boxStyles$</span></code><span class="koboSpan" id="kobo.595.1"> observable. </span><span class="koboSpan" id="kobo.595.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.596.1">home.component.ts</span></code><span class="koboSpan" id="kobo.597.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.598.1">...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.599.1">import</span></span><span class="koboSpan" id="kobo.600.1"> { </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.601.1">Observable</span></strong></span><span class="koboSpan" id="kobo.602.1">, </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.603.1">combineLatest</span></strong></span><span class="koboSpan" id="kobo.604.1">, startWith} </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.605.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.606.1">'rxjs'</span></span><span class="koboSpan" id="kobo.607.1">;
...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.608.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.609.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.610.1">HomeComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.611.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.612.1">OnInit</span></span><span class="koboSpan" id="kobo.613.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.614.1">OnDestroy</span></span><span class="koboSpan" id="kobo.615.1"> {
  ...
  </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.616.1">boxStyles$!: </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.617.1">Observable</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.618.1">&lt;</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.619.1">BoxStyles</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.620.1">&gt;;</span></strong></span><span class="koboSpan" id="kobo.621.1">
        ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.622.1">listenToInputChanges</span></span><span class="koboSpan" id="kobo.623.1">() {
    </span><span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.624.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.625.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.626.1">boxStyles$</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.627.1"> = </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.628.1">combineLatest</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.629.1">(</span></strong></span><span class="koboSpan" id="kobo.630.1">
      controls.</span><span class="hljs-title"><span class="koboSpan" id="kobo.631.1">map</span></span><span class="koboSpan" id="kobo.632.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.633.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.634.1">control</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.635.1">) =&gt;</span></span><span class="koboSpan" id="kobo.636.1">
        control.</span><span class="hljs-property"><span class="koboSpan" id="kobo.637.1">valueChanges</span></span><span class="koboSpan" id="kobo.638.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.639.1">pipe</span></span><span class="koboSpan" id="kobo.640.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.641.1">startWith</span></span><span class="koboSpan" id="kobo.642.1">(control.</span><span class="hljs-property"><span class="koboSpan" id="kobo.643.1">value</span></span><span class="koboSpan" id="kobo.644.1">))
      );
    </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.645.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.646.1">}</span></strong></span><span class="koboSpan" id="kobo.647.1">
  ...
</span><span class="koboSpan" id="kobo.647.2">}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.648.1">Now we will use a </span><code class="inlineCode"><span class="koboSpan" id="kobo.649.1">map</span></code><span class="koboSpan" id="kobo.650.1"> operator with </span><code class="inlineCode"><span class="koboSpan" id="kobo.651.1">pipe</span></code><span class="koboSpan" id="kobo.652.1"> on the combined stream to map it to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.653.1">BoxStyle</span></code><span class="koboSpan" id="kobo.654.1"> type values. </span><span class="koboSpan" id="kobo.654.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.655.1">listenToInputChanges</span></code><span class="koboSpan" id="kobo.656.1"> method in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.657.1">home/home.component.ts</span></code><span class="koboSpan" id="kobo.658.1"> file, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.659.1">import</span></span><span class="koboSpan" id="kobo.660.1"> { combineLatest, </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.661.1">map</span></strong></span><span class="koboSpan" id="kobo.662.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.663.1">Observable</span></span><span class="koboSpan" id="kobo.664.1">, startWith } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.665.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.666.1">'rxjs'</span></span><span class="koboSpan" id="kobo.667.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.668.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.669.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.670.1">HomeComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.671.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.672.1">OnInit</span></span><span class="koboSpan" id="kobo.673.1"> {
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.674.1">listenToInputChanges</span></span><span class="koboSpan" id="kobo.675.1">() {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.676.1">const</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.677.1">controls</span></span><span class="koboSpan" id="kobo.678.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.679.1">AbstractControl</span></span><span class="koboSpan" id="kobo.680.1">[] = [...];
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.681.1">this</span></span><span class="koboSpan" id="kobo.682.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.683.1">boxStyles$</span></span><span class="koboSpan" id="kobo.684.1"> = </span><span class="hljs-title"><span class="koboSpan" id="kobo.685.1">combineLatest</span></span><span class="koboSpan" id="kobo.686.1">(...)</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.687.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.688.1">pipe</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.689.1">(</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.690.1">map</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.691.1">(</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.692.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.693.1">[size, borderRadius, textColor,</span></strong></span>
<span class="code-highlight"><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.694.1">backgroundColor]</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.695.1">) =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.696.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.697.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.698.1"> { </span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.699.1">width</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.700.1">: </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.701.1">`</span></strong><strong class="hljs-subst-slc"><span class="koboSpan" id="kobo.702.1">${size}</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.703.1">px`</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.704.1">, </span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.705.1">height</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.706.1">: </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.707.1">`</span></strong><strong class="hljs-subst-slc"><span class="koboSpan" id="kobo.708.1">${size}</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.709.1">px`</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.710.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.711.1">backgroundColor</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.712.1">: backgroundColor,</span></strong></span>
<span class="code-highlight"><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.713.1">color</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.714.1">: textColor,</span></strong></span>
<span class="code-highlight"><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.715.1">borderRadius</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.716.1">: </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.717.1">`</span></strong><strong class="hljs-subst-slc"><span class="koboSpan" id="kobo.718.1">${borderRadius}</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.719.1">px`</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.720.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.721.1">};</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.722.1">})</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.723.1">);</span></strong></span><span class="koboSpan" id="kobo.724.1">
  }
}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.725.1">We </span><a id="_idIndexMarker296"/><span class="koboSpan" id="kobo.726.1">need to remove the </span><code class="inlineCode"><span class="koboSpan" id="kobo.727.1">setBoxStyles</span></code><span class="koboSpan" id="kobo.728.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.729.1">applyChanges</span></code><span class="koboSpan" id="kobo.730.1"> methods and the usages of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.731.1">applyChanges</span></code><span class="koboSpan" id="kobo.732.1"> method from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.733.1">home.component.ts</span></code><span class="koboSpan" id="kobo.734.1"> file. </span><span class="koboSpan" id="kobo.734.2">Update the file, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.735.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.736.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.737.1">HomeComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.738.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.739.1">OnInit</span></span><span class="koboSpan" id="kobo.740.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.741.1">ngOnInit</span></span><span class="koboSpan" id="kobo.742.1">() {
    </span><span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.743.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.744.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.745.1">listenToInputChanges</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.746.1">();</span></strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.747.1"> //← Add this call</span></strong></span><span class="koboSpan" id="kobo.748.1">
    ...
    </span><span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.749.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.750.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.751.1">applyChanges</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.752.1">(); </span></strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.753.1">//← Remove this call</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.754.1">}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.755.1">...</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.756.1">setBoxStyles</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.757.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.758.1">...</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.759.1">) {...}  </span></strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.760.1">//← Remove this method</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.761.1">applyChanges</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.762.1">() {...} </span></strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.763.1">//← Remove this method</span></strong></span><span class="koboSpan" id="kobo.764.1">
  ...
</span><span class="koboSpan" id="kobo.764.2">}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.765.1">We also need to remove the usage of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.766.1">applyChanges</span></code><span class="koboSpan" id="kobo.767.1"> method from the template as well. </span><span class="koboSpan" id="kobo.767.2">Remove the </span><code class="inlineCode"><span class="koboSpan" id="kobo.768.1">(ngSubmit)</span></code><span class="koboSpan" id="kobo.769.1"> handler from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.770.1">&lt;form&gt;</span></code><span class="koboSpan" id="kobo.771.1"> element in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.772.1">home.component.html</span></code><span class="koboSpan" id="kobo.773.1"> file so that it looks like this:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.774.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.775.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.776.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.777.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.778.1">"home"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.779.1"> [</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.780.1">formGroup</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.781.1">]=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.782.1">"boxForm"</span></span>
<span class="hljs-tag"> </span><span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.783.1">(</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.784.1">ngSubmit</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.785.1">)=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.786.1">"applyChanges()"</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.787.1">&lt;!--← Remove this--&gt;</span></strong></span><span class="koboSpan" id="kobo.788.1">
  ...
</span><span class="hljs-tag"><span class="koboSpan" id="kobo.789.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.790.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.791.1">&gt;</span></span>
</code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.792.1">We also need to get rid of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.793.1">submit-btn-container</span></code><span class="koboSpan" id="kobo.794.1"> element from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.795.1">home.component.html</span></code><span class="koboSpan" id="kobo.796.1"> template as we don’t need it anymore. </span><span class="koboSpan" id="kobo.796.2">Delete the following chunk from the file:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.797.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.798.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.799.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.800.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.801.1">"row submit-btn-container"</span></span><span class="hljs-tag"> </span><span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.802.1">&lt;!--← Remove this element --&gt;</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.803.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.804.1">button</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.805.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.806.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.807.1">"btn btn-primary"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.808.1">type</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.809.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.810.1">"submit"</span></span><span class="hljs-tag"> </span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.811.1">    (</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.812.1">click</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.813.1">)=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.814.1">"applyChanges()"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.815.1">&gt;</span></span><span class="koboSpan" id="kobo.816.1">Change Styles</span><span class="hljs-tag"><span class="koboSpan" id="kobo.817.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.818.1">button</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.819.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.820.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.821.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.822.1">&gt;</span></span>
</code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.823.1">Now that we can work with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.824.1">boxStyles$</span></code><span class="koboSpan" id="kobo.825.1"> Observable, let’s use it in the template, i.e., the </span><code class="inlineCode"><span class="koboSpan" id="kobo.826.1">home.component.html</span></code><span class="koboSpan" id="kobo.827.1"> file, instead of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.828.1">boxStyles</span></code><span class="koboSpan" id="kobo.829.1"> property:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.830.1">  ...
  </span><span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.831.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.832.1">div</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.833.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.834.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.835.1">"row"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.836.1"> *</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.837.1">ngIf</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.838.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.839.1">"boxStyles$ | async as</span></strong></span>
<span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.840.1">boxStyles"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.841.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.842.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.843.1">div</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.844.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.845.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.846.1">"box"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.847.1"> [</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.848.1">ngStyle</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.849.1">]=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.850.1">"boxStyles"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.851.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.852.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.853.1">div</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.854.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.855.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.856.1">"box__text"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.857.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.858.1">Hello World!</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.859.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.860.1">div</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.861.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.862.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.863.1">div</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.864.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.865.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.866.1">div</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.867.1">&gt;</span></strong></span><span class="koboSpan" id="kobo.868.1">
  ...
</span></code></pre>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.869.1">And voilà! </span><span class="koboSpan" id="kobo.869.2">If you</span><a id="_idIndexMarker297"/><span class="koboSpan" id="kobo.870.1"> refresh the app, you should be able to see the box appearing with the default styles. </span><span class="koboSpan" id="kobo.870.2">And if you change any of the options, you’ll see the changes reflected as well.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.871.1">Congratulations on finishing the recipe. </span><span class="koboSpan" id="kobo.871.2">You’re now the master of handling multiple streams using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.872.1">combineLatest</span></code><span class="koboSpan" id="kobo.873.1"> operator. </span><span class="koboSpan" id="kobo.873.2">See the next section to understand how it works.</span></p>
<h2 class="heading-2" id="_idParaDest-167"><span class="koboSpan" id="kobo.874.1">How it works…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.875.1">The beauty of </span><a id="_idIndexMarker298"/><span class="koboSpan" id="kobo.876.1">Reactive Forms is that they provide much more flexibility than the regular </span><code class="inlineCode"><span class="koboSpan" id="kobo.877.1">ngModel</span></code><span class="koboSpan" id="kobo.878.1"> binding or even template-driven forms. </span><span class="koboSpan" id="kobo.878.2">And for each form control, we can subscribe to its </span><code class="inlineCode"><span class="koboSpan" id="kobo.879.1">valueChanges</span></code><span class="koboSpan" id="kobo.880.1"> observable, which receives a new value whenever the input is changed. </span><span class="koboSpan" id="kobo.880.2">So, instead of relying on the </span><strong class="screenText"><span class="koboSpan" id="kobo.881.1">Submit</span></strong><span class="koboSpan" id="kobo.882.1"> button’s click, we subscribe directly to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.883.1">valueChanges</span></code><span class="koboSpan" id="kobo.884.1"> property of each </span><strong class="keyWord"><span class="koboSpan" id="kobo.885.1">form control</span></strong><span class="koboSpan" id="kobo.886.1">. </span><span class="koboSpan" id="kobo.886.2">In a </span><a id="_idIndexMarker299"/><span class="koboSpan" id="kobo.887.1">regular scenario, that would result in four different streams for four inputs, which means we would have four subscriptions that we need to take care of and make sure we unsubscribe them. </span><span class="koboSpan" id="kobo.887.2">This is where the </span><code class="inlineCode"><span class="koboSpan" id="kobo.888.1">combineLatest</span></code><span class="koboSpan" id="kobo.889.1"> operator comes into play. </span><span class="koboSpan" id="kobo.889.2">We used the </span><code class="inlineCode"><span class="koboSpan" id="kobo.890.1">combineLatest</span></code><span class="koboSpan" id="kobo.891.1"> operator to combine those four streams into one, which means we needed to unsubscribe only one stream on component destruction. </span><span class="koboSpan" id="kobo.891.2">But hey! </span><span class="koboSpan" id="kobo.891.3">Remember that we don’t need to do this if we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.892.1">async</span></code><span class="koboSpan" id="kobo.893.1"> pipe? </span><span class="koboSpan" id="kobo.893.2">That’s exactly what we did. </span><span class="koboSpan" id="kobo.893.3">We removed the subscription from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.894.1">home.component.ts</span></code><span class="koboSpan" id="kobo.895.1"> file and used the </span><code class="inlineCode"><span class="koboSpan" id="kobo.896.1">pipe</span></code><span class="koboSpan" id="kobo.897.1"> method with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.898.1">map</span></code><span class="koboSpan" id="kobo.899.1"> operator. </span><span class="koboSpan" id="kobo.899.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.900.1">map</span></code><span class="koboSpan" id="kobo.901.1"> operator transformed the data according to our needs and then returned the transformed data to be set to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.902.1">boxStyles$</span></code><span class="koboSpan" id="kobo.903.1"> observable. </span><span class="koboSpan" id="kobo.903.2">Finally, we used the </span><code class="inlineCode"><span class="koboSpan" id="kobo.904.1">async</span></code><span class="koboSpan" id="kobo.905.1"> pipe in our template to subscribe to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.906.1">boxStyles$</span></code><span class="koboSpan" id="kobo.907.1"> observable and assigned its value as </span><code class="inlineCode"><span class="koboSpan" id="kobo.908.1">[ngStyle]</span></code><span class="koboSpan" id="kobo.909.1"> to our box element. </span><span class="koboSpan" id="kobo.909.2">Since </span><code class="inlineCode"><span class="koboSpan" id="kobo.910.1">valueChanges</span></code><span class="koboSpan" id="kobo.911.1"> is a </span><code class="inlineCode"><span class="koboSpan" id="kobo.912.1">Subject</span></code><span class="koboSpan" id="kobo.913.1"> instead of a </span><code class="inlineCode"><span class="koboSpan" id="kobo.914.1">ReplaySubject</span></code><span class="koboSpan" id="kobo.915.1">, we also piped a </span><code class="inlineCode"><span class="koboSpan" id="kobo.916.1">startWith</span></code><span class="koboSpan" id="kobo.917.1"> with </span><code class="inlineCode"><span class="koboSpan" id="kobo.918.1">valueChanges</span></code><span class="koboSpan" id="kobo.919.1"> to </span><a id="_idIndexMarker300"/><span class="koboSpan" id="kobo.920.1">provide an initial value. </span><span class="koboSpan" id="kobo.920.2">If we don’t use </span><code class="inlineCode"><span class="koboSpan" id="kobo.921.1">startWith</span></code><span class="koboSpan" id="kobo.922.1">, the box won’t show unless all the inputs have a value changed manually at least once. </span><span class="koboSpan" id="kobo.922.2">Try it!</span></p>
<h2 class="heading-2" id="_idParaDest-168"><span class="koboSpan" id="kobo.923.1">See also</span></h2>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.924.1">combineLatest</span></code><span class="koboSpan" id="kobo.925.1"> operator documentation (</span><a href="https://www.learnrxjs.io/learn-rxjs/operators/combination/combinelatest"><span class="url"><span class="koboSpan" id="kobo.926.1">https://www.learnrxjs.io/learn-rxjs/operators/combination/combinelatest</span></span></a><span class="koboSpan" id="kobo.927.1">)</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.928.1">Visual representation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.929.1">combineLatest</span></code><span class="koboSpan" id="kobo.930.1"> operator (</span><a href="https://rxjs-dev.firebaseapp.com/api/index/function/combineLatest"><span class="url"><span class="koboSpan" id="kobo.931.1">https://rxjs-dev.firebaseapp.com/api/index/function/combineLatest</span></span></a><span class="koboSpan" id="kobo.932.1">)</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-169"><span class="koboSpan" id="kobo.933.1">Unsubscribing streams to avoid memory leaks</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.934.1">Streams are</span><a id="_idIndexMarker301"/><span class="koboSpan" id="kobo.935.1"> fun to work with and they’re awesome. </span><span class="koboSpan" id="kobo.935.2">You’ll know more about RxJS and</span><a id="_idIndexMarker302"/><span class="koboSpan" id="kobo.936.1"> streams when you’ve finished this chapter. </span><span class="koboSpan" id="kobo.936.2">One reality is facing unseen problems that occur when streams are used without caution. </span><span class="koboSpan" id="kobo.936.3">One of the biggest mistakes to make with streams is to not unsubscribe them when we no longer need them, and in this recipe, you’ll learn how to unsubscribe streams to avoid memory leaks in your Angular apps.</span></p>
<h2 class="heading-2" id="_idParaDest-170"><span class="koboSpan" id="kobo.937.1">Getting ready</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.938.1">The app that we are going to work with resides in </span><code class="inlineCode"><span class="koboSpan" id="kobo.939.1">start/apps/chapter05/rx-unsubscribing-streams</span></code><span class="koboSpan" id="kobo.940.1"> inside the cloned repository:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.941.1">Open the code repository in your code editor.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.942.1">Open the terminal, navigate to the code repository directory, and run the following command to serve the project:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.943.1">npm run serve rx-unsubscribing-streams
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.944.1">This should open the app in a new browser tab, and you should see the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.945.1"><img alt="" role="presentation" src="../Images/B18469_05_03.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.946.1">Figure 5.3: The rxjs-unsubscribing-streams app running on http://localhost:4200</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.947.1">Now that we</span><a id="_idIndexMarker303"/><span class="koboSpan" id="kobo.948.1"> have the app running locally, let’s see the steps of the recipe in the next section.</span></p>
<h2 class="heading-2" id="_idParaDest-171"><span class="koboSpan" id="kobo.949.1">How to do it…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.950.1">We currently have an app with two routes—that is, </span><strong class="screenText"><span class="koboSpan" id="kobo.951.1">Home</span></strong><span class="koboSpan" id="kobo.952.1"> and </span><strong class="screenText"><span class="koboSpan" id="kobo.953.1">About</span></strong><span class="koboSpan" id="kobo.954.1">. </span><span class="koboSpan" id="kobo.954.2">This is to show you that unhandled subscriptions can cause memory leaks in an app. </span><span class="koboSpan" id="kobo.954.3">The default route is </span><strong class="screenText"><span class="koboSpan" id="kobo.955.1">Home</span></strong><span class="koboSpan" id="kobo.956.1">, and in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.957.1">HomeComponent</span></code><span class="koboSpan" id="kobo.958.1"> class, we handle a single stream that outputs data using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.959.1">interval</span></code><span class="koboSpan" id="kobo.960.1"> operator function:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.961.1">Tap the </span><strong class="screenText"><span class="koboSpan" id="kobo.962.1">Start Stream</span></strong><span class="koboSpan" id="kobo.963.1"> button, and you should see the stream emitting values.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.964.1">Then, navigate to the </span><strong class="screenText"><span class="koboSpan" id="kobo.965.1">About</span></strong><span class="koboSpan" id="kobo.966.1"> page by tapping the </span><strong class="screenText"><span class="koboSpan" id="kobo.967.1">About</span></strong><span class="koboSpan" id="kobo.968.1"> button from the header (top right), and then come back to the </span><strong class="screenText"><span class="koboSpan" id="kobo.969.1">Home</span></strong><span class="koboSpan" id="kobo.970.1"> page.
    </span><p class="normal"><span class="koboSpan" id="kobo.971.1">Do you see anything weird? </span><span class="koboSpan" id="kobo.971.2">No? </span><span class="koboSpan" id="kobo.971.3">Everything looks fine, right? </span><span class="koboSpan" id="kobo.971.4">Well, not exactly.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.972.1">To see whether we have an unhandled subscription, let’s put </span><code class="inlineCode"><span class="koboSpan" id="kobo.973.1">console.log</span></code><span class="koboSpan" id="kobo.974.1"> inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.975.1">startStream</span></code><span class="koboSpan" id="kobo.976.1"> method in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.977.1">home.component.ts</span></code><span class="koboSpan" id="kobo.978.1"> file—specifically, inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.979.1">subscribe</span></code><span class="koboSpan" id="kobo.980.1"> function’s block, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.981.1">...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.982.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.983.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.984.1">HomeComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.985.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.986.1">OnInit</span></span><span class="koboSpan" id="kobo.987.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.988.1">startStream</span></span><span class="koboSpan" id="kobo.989.1">() {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.990.1">const</span></span><span class="koboSpan" id="kobo.991.1"> streamSource = </span><span class="hljs-title"><span class="koboSpan" id="kobo.992.1">interval</span></span><span class="koboSpan" id="kobo.993.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.994.1">1500</span></span><span class="koboSpan" id="kobo.995.1">);
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.996.1">this</span></span><span class="koboSpan" id="kobo.997.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.998.1">subscription</span></span><span class="koboSpan" id="kobo.999.1"> = streamSource.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1000.1">subscribe</span></span><span class="koboSpan" id="kobo.1001.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.1002.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1003.1">input</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1004.1">) =&gt;</span></span><span class="koboSpan" id="kobo.1005.1"> {
      </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1006.1">this</span></span><span class="koboSpan" id="kobo.1007.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1008.1">outputStreamData</span></span><span class="koboSpan" id="kobo.1009.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1010.1">push</span></span><span class="koboSpan" id="kobo.1011.1">(input);
      </span><span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1012.1">console</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1013.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1014.1">log</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1015.1">({ input });</span></strong></span><span class="koboSpan" id="kobo.1016.1">
    });
  }
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1017.1">stopStream</span></span><span class="koboSpan" id="kobo.1018.1">() {...}
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1019.1">If you now perform the same steps as mentioned in </span><em class="italic"><span class="koboSpan" id="kobo.1020.1">Step 1</span></em><span class="koboSpan" id="kobo.1021.1">, you’ll see the following output on the console, as shown in </span><em class="italic"><span class="koboSpan" id="kobo.1022.1">Figure 5.4</span></em><span class="koboSpan" id="kobo.1023.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1024.1"><img alt="" role="presentation" src="../Images/B18469_05_04.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1025.1">Figure 5.4: interval emitting values on the About page</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1026.1">Want to have some more fun? </span><span class="koboSpan" id="kobo.1026.2">Try performing </span><em class="italic"><span class="koboSpan" id="kobo.1027.1">Step 1</span></em><span class="koboSpan" id="kobo.1028.1"> a couple of times without refreshing the page even once. </span><span class="koboSpan" id="kobo.1028.2">What you’ll see will be </span><em class="italic"><span class="koboSpan" id="kobo.1029.1">chaos!</span></em></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.1030.1">So, to</span><a id="_idIndexMarker304"/><span class="koboSpan" id="kobo.1031.1"> solve the issue, we’ll use the simplest approach—that is, unsubscribing the stream when the user navigates away from the route. </span><span class="koboSpan" id="kobo.1031.2">Let’s implement the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1032.1">ngOnDestroy</span></code><span class="koboSpan" id="kobo.1033.1"> lifecycle method for that, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1034.1">import</span></span><span class="koboSpan" id="kobo.1035.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.1036.1">Component</span></span><span class="koboSpan" id="kobo.1037.1">, </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1038.1">OnDestroy</span></strong></span><span class="koboSpan" id="kobo.1039.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1040.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1041.1">'@angular/core'</span></span><span class="koboSpan" id="kobo.1042.1">;
...
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.1043.1">@Component</span></span><span class="koboSpan" id="kobo.1044.1">({...})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1045.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1046.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1047.1">HomeComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1048.1">implements</span></span> <span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1049.1">OnDestroy</span></strong></span><span class="koboSpan" id="kobo.1050.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1051.1">startStream</span></span><span class="koboSpan" id="kobo.1052.1">() {...}
  </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1053.1">ngOnDestroy</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1054.1">() {</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1055.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1056.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1057.1">stopStream</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1058.1">();</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1059.1">}</span></strong></span>
<span class="hljs-title"><span class="koboSpan" id="kobo.1060.1">stopStream</span></span><span class="koboSpan" id="kobo.1061.1">() {...}
}
</span></code></pre>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1062.1">Great! </span><span class="koboSpan" id="kobo.1062.2">If you follow the instructions from </span><em class="italic"><span class="koboSpan" id="kobo.1063.1">Step 1</span></em><span class="koboSpan" id="kobo.1064.1"> again, you’ll see that there’s no further log on the console </span><a id="_idIndexMarker305"/><span class="koboSpan" id="kobo.1065.1">once you navigate away from the </span><strong class="screenText"><span class="koboSpan" id="kobo.1066.1">Home</span></strong><span class="koboSpan" id="kobo.1067.1"> page, and our app doesn’t have an unhandled stream causing memory leaks now. </span><span class="koboSpan" id="kobo.1067.2">Read the next section to understand how it works.</span></p>
<h2 class="heading-2" id="_idParaDest-172"><span class="koboSpan" id="kobo.1068.1">How it works…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1069.1">When</span><a id="_idIndexMarker306"/><span class="koboSpan" id="kobo.1070.1"> we create an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1071.1">Observable/stream</span></code><span class="koboSpan" id="kobo.1072.1"> and we subscribe to it, RxJS automagically adds our provided </span><code class="inlineCode"><span class="koboSpan" id="kobo.1073.1">subscribe</span></code><span class="koboSpan" id="kobo.1074.1"> function block as a handler to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1075.1">Observable</span></code><span class="koboSpan" id="kobo.1076.1">. </span><span class="koboSpan" id="kobo.1076.2">So, whenever there’s a value emitted from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1077.1">Observable</span></code><span class="koboSpan" id="kobo.1078.1">, our method is supposed to be called. </span><span class="koboSpan" id="kobo.1078.2">The fun part is that Angular doesn’t automatically destroy that subscription/handler when the component unmounts or when you have navigated away from the route. </span><span class="koboSpan" id="kobo.1078.3">That’s because the core of observables is </span><strong class="keyWord"><span class="koboSpan" id="kobo.1079.1">RxJS</span></strong><span class="koboSpan" id="kobo.1080.1">, not Angular; therefore, it isn’t Angular’s responsibility to handle it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1081.1">Angular provides certain lifecycle methods, and we used the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1082.1">OnDestroy</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.1083.1">(ngOnDestroy)</span></code><span class="koboSpan" id="kobo.1084.1"> method. </span><span class="koboSpan" id="kobo.1084.2">So, we used the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1085.1">ngOnDestroy</span></code><span class="koboSpan" id="kobo.1086.1"> method to call the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1087.1">stopStream</span></code><span class="koboSpan" id="kobo.1088.1"> method so that the subscription is destroyed as soon as the user navigates away from the page. </span><span class="koboSpan" id="kobo.1088.2">This is possible because, when we navigate away from a route, Angular destroys that route and thus we can execute our </span><code class="inlineCode"><span class="koboSpan" id="kobo.1089.1">stopStream</span></code><span class="koboSpan" id="kobo.1090.1"> method.</span></p>
<h2 class="heading-2" id="_idParaDest-173"><span class="koboSpan" id="kobo.1091.1">There’s more…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1092.1">In a complex Angular app, there will be cases where you’d have more than one subscription in a component, and when the component is destroyed, you’d want to clean all those subscriptions at once. </span><span class="koboSpan" id="kobo.1092.2">Similarly, you might want to unsubscribe based on certain events/conditions rather than the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1093.1">OnDestroy</span></code><span class="koboSpan" id="kobo.1094.1"> lifecycle. </span><span class="koboSpan" id="kobo.1094.2">Here is an example where you have multiple subscriptions in hand, and you want to clean up all of them together when the component is destroyed:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-title"><span class="koboSpan" id="kobo.1095.1">startStream</span></span><span class="koboSpan" id="kobo.1096.1">() {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1097.1">const</span></span><span class="koboSpan" id="kobo.1098.1"> streamSource = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1099.1">interval</span></span><span class="koboSpan" id="kobo.1100.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1101.1">1500</span></span><span class="koboSpan" id="kobo.1102.1">);
    </span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1103.1">const</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1104.1"> secondStreamSource = </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1105.1">interval</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1106.1">(</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1107.1">3000</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1108.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1109.1">const</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1110.1"> fastestStreamSource = </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1111.1">interval</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1112.1">(</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1113.1">500</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1114.1">);</span></strong></span><span class="koboSpan" id="kobo.1115.1">
    streamSource.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1116.1">subscribe</span></span><span class="koboSpan" id="kobo.1117.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.1118.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1119.1">input</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1120.1">) =&gt;</span></span><span class="koboSpan" id="kobo.1121.1"> {
      </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1122.1">this</span></span><span class="koboSpan" id="kobo.1123.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1124.1">outputStreamData</span></span><span class="koboSpan" id="kobo.1125.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1126.1">push</span></span><span class="koboSpan" id="kobo.1127.1">(input);
      </span><span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1128.1">console</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1129.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1130.1">log</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1131.1">(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1132.1">'first stream output'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1133.1">, input);</span></strong></span><span class="koboSpan" id="kobo.1134.1">
    });
    </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1135.1">secondStreamSource.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1136.1">subscribe</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1137.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1138.1">input</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1139.1"> =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1140.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1141.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1142.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1143.1">outputStreamData</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1144.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1145.1">push</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1146.1">(input);</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1147.1">console</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1148.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1149.1">log</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1150.1">(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1151.1">'second stream output'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1152.1">, input)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1153.1">});</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1154.1">fastestStreamSource.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1155.1">subscribe</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1156.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1157.1">input</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1158.1"> =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1159.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1160.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1161.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1162.1">outputStreamData</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1163.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1164.1">push</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1165.1">(input);</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1166.1">console</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1167.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1168.1">log</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1169.1">(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1170.1">'fastest stream output'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1171.1">, input)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1172.1">});</span></strong></span><span class="koboSpan" id="kobo.1173.1">
  }
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1174.1">stopStream</span></span><span class="koboSpan" id="kobo.1175.1">() {
    </span><span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1176.1">// remove code from here</span></strong></span><span class="koboSpan" id="kobo.1177.1">
  }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1178.1">Notice that we’re </span><a id="_idIndexMarker307"/><span class="koboSpan" id="kobo.1179.1">not saving the </span><strong class="screenText"><span class="koboSpan" id="kobo.1180.1">subscription</span></strong><span class="koboSpan" id="kobo.1181.1"> from </span><code class="inlineCode"><span class="koboSpan" id="kobo.1182.1">streamSource</span></code><span class="koboSpan" id="kobo.1183.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1184.1">this.subscription</span></code><span class="koboSpan" id="kobo.1185.1"> anymore, and we have also removed the code from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1186.1">stopStream</span></code><span class="koboSpan" id="kobo.1187.1"> method. </span><span class="koboSpan" id="kobo.1187.2">The reason for this is that we don’t have individual properties/variables for each subscription. </span><span class="koboSpan" id="kobo.1187.3">Instead, we’ll have a single variable to work with. </span><span class="koboSpan" id="kobo.1187.4">Let’s look at the following recipe steps to get things rolling:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1188.1">First, we’ll create a property in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1189.1">HomeComponent</span></code><span class="koboSpan" id="kobo.1190.1"> class named </span><code class="inlineCode"><span class="koboSpan" id="kobo.1191.1">isStreamActive</span></code><span class="koboSpan" id="kobo.1192.1">:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1193.1">import</span></span><span class="koboSpan" id="kobo.1194.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.1195.1">Component</span></span><span class="koboSpan" id="kobo.1196.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1197.1">OnDestroy</span></span><span class="koboSpan" id="kobo.1198.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1199.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1200.1">'@angular/core'</span></span><span class="koboSpan" id="kobo.1201.1">;
  ...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1202.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1203.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1204.1">HomeComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1205.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1206.1">OnDestroy</span></span><span class="koboSpan" id="kobo.1207.1"> {
  isStreamActive = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1208.1">true</span></span><span class="koboSpan" id="kobo.1209.1">;
  ...
</span><span class="koboSpan" id="kobo.1209.2">}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1210.1">Now, we’ll import the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1211.1">takeWhile</span></code><span class="koboSpan" id="kobo.1212.1"> operator from </span><code class="inlineCode"><span class="koboSpan" id="kobo.1213.1">rxjs/operators</span></code><span class="koboSpan" id="kobo.1214.1">, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1215.1">import</span></span><span class="koboSpan" id="kobo.1216.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.1217.1">Component</span></span><span class="koboSpan" id="kobo.1218.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1219.1">OnInit</span></span><span class="koboSpan" id="kobo.1220.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1221.1">OnDestroy</span></span><span class="koboSpan" id="kobo.1222.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1223.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1224.1">'@angular/core'</span></span><span class="koboSpan" id="kobo.1225.1">;
...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1226.1">import</span></span><span class="koboSpan" id="kobo.1227.1"> { interval, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1228.1">Subscription</span></span><span class="koboSpan" id="kobo.1229.1">, </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1230.1">takeWhile</span></strong></span><span class="koboSpan" id="kobo.1231.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1232.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1233.1">'rxjs'</span></span><span class="koboSpan" id="kobo.1234.1">;
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1235.1">We’ll now use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1236.1">takeWhile</span></code><span class="koboSpan" id="kobo.1237.1"> operator with each of our streams to make them work only when the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1238.1">isStreamActive</span></code><span class="koboSpan" id="kobo.1239.1"> property is set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1240.1">true</span></code><span class="koboSpan" id="kobo.1241.1">. </span><span class="koboSpan" id="kobo.1241.2">Since </span><code class="inlineCode"><span class="koboSpan" id="kobo.1242.1">takeWhile</span></code><span class="koboSpan" id="kobo.1243.1"> takes a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1244.1">predicate</span></code><span class="koboSpan" id="kobo.1245.1"> method, it should look like this:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-title"><span class="koboSpan" id="kobo.1246.1">startStream</span></span><span class="koboSpan" id="kobo.1247.1">() {
    ...
    </span><span class="koboSpan" id="kobo.1247.2">streamSource
      </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1248.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1249.1">pipe</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1250.1">(</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1251.1">takeWhile</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1252.1">(</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1253.1">() =&gt;</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1254.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1255.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1256.1">isStreamActive</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1257.1">))</span></strong></span><span class="koboSpan" id="kobo.1258.1">
      .</span><span class="hljs-title"><span class="koboSpan" id="kobo.1259.1">subscribe</span></span><span class="koboSpan" id="kobo.1260.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1261.1">input</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1262.1"> =&gt;</span></span><span class="koboSpan" id="kobo.1263.1"> {...});
    secondStreamSource
      </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1264.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1265.1">pipe</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1266.1">(</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1267.1">takeWhile</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1268.1">(</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1269.1">() =&gt;</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1270.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1271.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1272.1">isStreamActive</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1273.1">))</span></strong></span><span class="koboSpan" id="kobo.1274.1">
      .</span><span class="hljs-title"><span class="koboSpan" id="kobo.1275.1">subscribe</span></span><span class="koboSpan" id="kobo.1276.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1277.1">input</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1278.1"> =&gt;</span></span><span class="koboSpan" id="kobo.1279.1"> {...});
    fastestStreamSource
      </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1280.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1281.1">pipe</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1282.1">(</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1283.1">takeWhile</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1284.1">(</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1285.1">() =&gt;</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1286.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1287.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1288.1">isStreamActive</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1289.1">))</span></strong></span><span class="koboSpan" id="kobo.1290.1">
      .</span><span class="hljs-title"><span class="koboSpan" id="kobo.1291.1">subscribe</span></span><span class="koboSpan" id="kobo.1292.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1293.1">input</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1294.1"> =&gt;</span></span><span class="koboSpan" id="kobo.1295.1"> {...});
  }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1296.1">If you click the </span><strong class="screenText"><span class="koboSpan" id="kobo.1297.1">Start Stream</span></strong><span class="koboSpan" id="kobo.1298.1"> button right now on the </span><strong class="screenText"><span class="koboSpan" id="kobo.1299.1">Home</span></strong><span class="koboSpan" id="kobo.1300.1"> page, you still won’t see any output or logs because the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1301.1">isStreamActive</span></code><span class="koboSpan" id="kobo.1302.1"> property is still </span><strong class="keyWord"><span class="koboSpan" id="kobo.1303.1">undefined</span></strong><span class="koboSpan" id="kobo.1304.1">.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.1305.1">To make</span><a id="_idIndexMarker308"/><span class="koboSpan" id="kobo.1306.1"> the streams work, we’ll set the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1307.1">isStreamActive</span></code><span class="koboSpan" id="kobo.1308.1"> property to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1309.1">true</span></code><span class="koboSpan" id="kobo.1310.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1311.1">startStream</span></code><span class="koboSpan" id="kobo.1312.1"> method. </span><span class="koboSpan" id="kobo.1312.2">The code should look like this:
        </span><pre class="programlisting code"><code class="hljs-code"> <span class="hljs-title"><span class="koboSpan" id="kobo.1313.1">ngOnDestroy</span></span><span class="koboSpan" id="kobo.1314.1">() {
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1315.1">this</span></span><span class="koboSpan" id="kobo.1316.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1317.1">stopStream</span></span><span class="koboSpan" id="kobo.1318.1">();
  }
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1319.1">startStream</span></span><span class="koboSpan" id="kobo.1320.1">() {
  </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1321.1">isStreamActive = </span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.1322.1">true</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1323.1">;</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1324.1">const</span></span><span class="koboSpan" id="kobo.1325.1"> streamSource = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1326.1">interval</span></span><span class="koboSpan" id="kobo.1327.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1328.1">1500</span></span><span class="koboSpan" id="kobo.1329.1">);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1330.1">const</span></span><span class="koboSpan" id="kobo.1331.1"> secondStreamSource = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1332.1">interval</span></span><span class="koboSpan" id="kobo.1333.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1334.1">3000</span></span><span class="koboSpan" id="kobo.1335.1">);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1336.1">const</span></span><span class="koboSpan" id="kobo.1337.1"> fastestStreamSource = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1338.1">interval</span></span><span class="koboSpan" id="kobo.1339.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1340.1">500</span></span><span class="koboSpan" id="kobo.1341.1">);
    ...
  </span><span class="koboSpan" id="kobo.1341.2">}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1342.1">After this step, if you now try to start the stream and navigate away from the page, you’ll still see the same issue with the streams—that is, they’ve not been unsubscribed.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="5"><span class="koboSpan" id="kobo.1343.1">To unsubscribe all streams at once, we’ll set the value of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1344.1">isStreamActive</span></code><span class="koboSpan" id="kobo.1345.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1346.1">false</span></code><span class="koboSpan" id="kobo.1347.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1348.1">stopStream</span></code><span class="koboSpan" id="kobo.1349.1"> method, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"> <span class="hljs-title"><span class="koboSpan" id="kobo.1350.1">stopStream</span></span><span class="koboSpan" id="kobo.1351.1">() {
    </span><span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1352.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1353.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1354.1">isStreamActive</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1355.1"> = </span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.1356.1">false</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1357.1">;</span></strong></span><span class="koboSpan" id="kobo.1358.1">
  }
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1359.1">Finally, update the template to handle which button is disabled based on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1360.1">isStreamActive</span></code><span class="koboSpan" id="kobo.1361.1"> property instead of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1362.1">subscription</span></code><span class="koboSpan" id="kobo.1363.1">. </span><span class="koboSpan" id="kobo.1363.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1364.1">home.component.html</span></code><span class="koboSpan" id="kobo.1365.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"> <span class="hljs-tag"><span class="koboSpan" id="kobo.1366.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1367.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1368.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1369.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1370.1">"home"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1371.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1372.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1373.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1374.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1375.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1376.1">"buttons-container"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1377.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1378.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1379.1">button</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1380.1"> [</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1381.1">disabled</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1382.1">]=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1383.1">"</span></span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1384.1">isStreamActive</span></strong></span><span class="hljs-string"><span class="koboSpan" id="kobo.1385.1">"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1386.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1387.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1388.1">"btn btn-</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1389.1">primary"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1390.1"> (</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1391.1">click</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1392.1">)=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1393.1">"startStream()"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1394.1">&gt;</span></span><span class="koboSpan" id="kobo.1395.1">Start
          Stream</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1396.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1397.1">button</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1398.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1399.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1400.1">button</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1401.1"> [</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1402.1">disabled</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1403.1">]=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1404.1">"</span></span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1405.1">!isStreamActive</span></strong></span><span class="hljs-string"><span class="koboSpan" id="kobo.1406.1">"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1407.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1408.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1409.1">"btn</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1410.1">btn-dark"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1411.1"> (</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1412.1">click</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1413.1">)=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1414.1">"stopStream()"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1415.1">&gt;</span></span><span class="koboSpan" id="kobo.1416.1">Stop
          Stream</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1417.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1418.1">button</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1419.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1420.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1421.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1422.1">&gt;</span></span><span class="koboSpan" id="kobo.1423.1">
      ...
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1424.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1425.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1426.1">&gt;</span></span>
</code></pre>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1427.1">And boom! </span><span class="koboSpan" id="kobo.1427.2">Now, if you </span><a id="_idIndexMarker309"/><span class="koboSpan" id="kobo.1428.1">navigate away from the route while the streams are emitting values, the streams will stop immediately as soon as you navigate away from the </span><strong class="screenText"><span class="koboSpan" id="kobo.1429.1">Home</span></strong><span class="koboSpan" id="kobo.1430.1"> route. </span><span class="koboSpan" id="kobo.1430.2">Voilà!</span></p>
<h2 class="heading-2" id="_idParaDest-174"><span class="koboSpan" id="kobo.1431.1">See also</span></h2>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1432.1">Read about RxJS subscription (</span><a href="https://www.learnrxjs.io/learn-rxjs/concepts/rxjs-primer#subscription"><span class="url"><span class="koboSpan" id="kobo.1433.1">https://www.learnrxjs.io/learn-rxjs/concepts/rxjs-primer#subscription</span></span></a><span class="koboSpan" id="kobo.1434.1">)</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1435.1">takeWhile</span></code><span class="koboSpan" id="kobo.1436.1"> operator docs (</span><a href="https://www.learnrxjs.io/learn-rxjs/operators/filtering/takewhile"><span class="url"><span class="koboSpan" id="kobo.1437.1">https://www.learnrxjs.io/learn-rxjs/operators/filtering/takewhile</span></span></a><span class="koboSpan" id="kobo.1438.1">)</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-175"><span class="koboSpan" id="kobo.1439.1">Using Angular’s async pipe to unsubscribe streams automatically</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1440.1">As </span><a id="_idIndexMarker310"/><span class="koboSpan" id="kobo.1441.1">you learned in the previous recipe, it is crucial to unsubscribe the streams you subscribe to. </span><span class="koboSpan" id="kobo.1441.2">What if we had an even simpler way to unsubscribe them when the component gets destroyed—that is, letting Angular take care of it somehow? </span><span class="koboSpan" id="kobo.1441.3">In this recipe, you’ll learn how to use Angular’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.1442.1">async</span></code><span class="koboSpan" id="kobo.1443.1"> pipe with an observable to directly bind the data in the stream to the Angular template instead of having to subscribe in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1444.1">*.component.ts</span></code><span class="koboSpan" id="kobo.1445.1"> file.</span></p>
<h2 class="heading-2" id="_idParaDest-176"><span class="koboSpan" id="kobo.1446.1">Getting ready</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1447.1">The app that we are going to work with resides in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1448.1">start/apps/chapter05/ng-async-pipe</span></code><span class="koboSpan" id="kobo.1449.1"> inside the cloned repository:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1450.1">Open the code repository in your code editor.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1451.1">Open the terminal, navigate to the code repository directory, and run the following command to serve the project:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1452.1">npm run serve ng-async-pipe
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1453.1">This </span><a id="_idIndexMarker311"/><span class="koboSpan" id="kobo.1454.1">should open the app in a new browser tab, and you should see the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1455.1"><img alt="" role="presentation" src="../Images/B18469_05_05.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1456.1">Figure 5.5: The ng-async-pipe app running on http://localhost:4200</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1457.1">Now that we have the app running locally, let’s see the steps of the recipe in the next section.</span></p>
<h2 class="heading-2" id="_idParaDest-177"><span class="koboSpan" id="kobo.1458.1">How to do it…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1459.1">The app we have right now has three streams/observables observing values at different intervals. </span><span class="koboSpan" id="kobo.1459.2">We’re relying on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1460.1">isStreamActive</span></code><span class="koboSpan" id="kobo.1461.1"> property to keep the subscription alive or make it stop when the property is set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1462.1">false</span></code><span class="koboSpan" id="kobo.1463.1">. </span><span class="koboSpan" id="kobo.1463.2">We’ll remove the usage of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1464.1">takeWhile</span></code><span class="koboSpan" id="kobo.1465.1"> and somehow make everything work similarly to what we have right now.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1466.1">First, add a property of type </span><code class="inlineCode"><span class="koboSpan" id="kobo.1467.1">Observable</span></code><span class="koboSpan" id="kobo.1468.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1469.1">HomeComponent</span></code><span class="koboSpan" id="kobo.1470.1"> class named </span><code class="inlineCode"><span class="koboSpan" id="kobo.1471.1">streamOutput$</span></code><span class="koboSpan" id="kobo.1472.1">. </span><span class="koboSpan" id="kobo.1472.2">Update the code in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1473.1">home.component.ts</span></code><span class="koboSpan" id="kobo.1474.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1475.1">...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1476.1">import</span></span><span class="koboSpan" id="kobo.1477.1"> { interval, </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1478.1">Observable</span></strong></span><span class="koboSpan" id="kobo.1479.1">, takeWhile } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1480.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1481.1">'rxjs'</span></span><span class="koboSpan" id="kobo.1482.1">;
...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1483.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1484.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1485.1">HomeComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1486.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1487.1">OnDestroy</span></span><span class="koboSpan" id="kobo.1488.1"> {
  ...
  </span><span class="koboSpan" id="kobo.1488.2">isStreamActive!: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1489.1">boolean</span></span><span class="koboSpan" id="kobo.1490.1">;
  </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1491.1">streamsOutput$!: </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1492.1">Observable</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1493.1">&lt;</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1494.1">number</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1495.1">&gt;;</span></strong></span>
<span class="hljs-title"><span class="koboSpan" id="kobo.1496.1">constructor</span></span><span class="koboSpan" id="kobo.1497.1">() { }
  ...
</span><span class="koboSpan" id="kobo.1497.2">}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1498.1">We’ll </span><a id="_idIndexMarker312"/><span class="koboSpan" id="kobo.1499.1">now combine all the streams to give out a single output—that is, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1500.1">outputStreamData</span></code><span class="koboSpan" id="kobo.1501.1"> array. </span><span class="koboSpan" id="kobo.1501.2">We’ll remove all the existing </span><code class="inlineCode"><span class="koboSpan" id="kobo.1502.1">pipe</span></code><span class="koboSpan" id="kobo.1503.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1504.1">subscribe</span></code><span class="koboSpan" id="kobo.1505.1"> functions from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1506.1">startStream</span></code><span class="koboSpan" id="kobo.1507.1"> method, so the code should now look like this:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1508.1">...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1509.1">import</span></span><span class="koboSpan" id="kobo.1510.1"> { interval, </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1511.1">merge</span></strong></span><span class="koboSpan" id="kobo.1512.1">, </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1513.1">scan</span></strong></span><span class="koboSpan" id="kobo.1514.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1515.1">Observable</span></span><span class="koboSpan" id="kobo.1516.1">, takeWhile } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1517.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1518.1">'rxjs'</span></span><span class="koboSpan" id="kobo.1519.1">;
...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1520.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1521.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1522.1">HomeComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1523.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1524.1">OnDestroy</span></span><span class="koboSpan" id="kobo.1525.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1526.1">startStream</span></span><span class="koboSpan" id="kobo.1527.1">() {
    ...
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1528.1">const</span></span><span class="koboSpan" id="kobo.1529.1"> fastestStreamSource = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1530.1">interval</span></span><span class="koboSpan" id="kobo.1531.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1532.1">500</span></span><span class="koboSpan" id="kobo.1533.1">);
    </span><span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1534.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1535.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1536.1">streamsOutput$</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1537.1"> = </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1538.1">merge</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1539.1">(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1540.1">streamSource,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1541.1">secondStreamSource,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1542.1">fastestStreamSource</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1543.1">).</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1544.1">pipe</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1545.1">(</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1546.1">scan</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1547.1">(</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1548.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1549.1">acc, next</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1550.1">) =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1551.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1552.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1553.1"> [...acc, next];</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1554.1">}, [] </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1555.1">as</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1556.1">number</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1557.1">[])</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1558.1">);</span></strong></span><span class="koboSpan" id="kobo.1559.1">
  }
  ...
</span><span class="koboSpan" id="kobo.1559.2">}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1560.1">Since we want to stop the stream on the </span><strong class="screenText"><span class="koboSpan" id="kobo.1561.1">Stop Stream</span></strong><span class="koboSpan" id="kobo.1562.1"> button click, we’ll use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1563.1">takeWhile</span></code><span class="koboSpan" id="kobo.1564.1"> operator in the stream to work with the stream to only emit values when we click the </span><strong class="screenText"><span class="koboSpan" id="kobo.1565.1">Start Stream</span></strong><span class="koboSpan" id="kobo.1566.1"> button and to stop when we hit the </span><strong class="screenText"><span class="koboSpan" id="kobo.1567.1">Stop Stream</span></strong><span class="koboSpan" id="kobo.1568.1"> button. </span><span class="koboSpan" id="kobo.1568.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1569.1">startStream</span></code><span class="koboSpan" id="kobo.1570.1"> method in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1571.1">home.component.ts</span></code><span class="koboSpan" id="kobo.1572.1"> as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-title"><span class="koboSpan" id="kobo.1573.1">startStream</span></span><span class="koboSpan" id="kobo.1574.1">() {
    ...
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1575.1">this</span></span><span class="koboSpan" id="kobo.1576.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1577.1">streamsOutput$</span></span><span class="koboSpan" id="kobo.1578.1"> = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1579.1">merge</span></span><span class="koboSpan" id="kobo.1580.1">(...).</span><span class="hljs-title"><span class="koboSpan" id="kobo.1581.1">pipe</span></span><span class="koboSpan" id="kobo.1582.1">(
      </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1583.1">takeWhile</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1584.1">(</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1585.1">() =&gt;</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1586.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1587.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1588.1">isStreamActive</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1589.1">),</span></strong></span>
<span class="hljs-title"><span class="koboSpan" id="kobo.1590.1">scan</span></span><span class="koboSpan" id="kobo.1591.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.1592.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1593.1">acc, next</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1594.1">) =&gt;</span></span><span class="koboSpan" id="kobo.1595.1"> {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1596.1">return</span></span><span class="koboSpan" id="kobo.1597.1"> [...acc, next];
      }, [] </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1598.1">as</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1599.1">number</span></span><span class="koboSpan" id="kobo.1600.1">[])
    </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1601.1">)</span></strong></span><span class="koboSpan" id="kobo.1602.1">
  }
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1603.1">Remove the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1604.1">ngOnDestroy</span></code><span class="koboSpan" id="kobo.1605.1"> method since our stream is going to unsubscribe automatically when we leave the component (go to another route). </span><span class="koboSpan" id="kobo.1605.2">This is because we’re using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1606.1">async</span></code><span class="koboSpan" id="kobo.1607.1"> pipe and Angular itself handles the subscription and unsubscription for us when using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1608.1">async pipe</span></code><span class="koboSpan" id="kobo.1609.1">. </span><span class="koboSpan" id="kobo.1609.2">Also, we should remove the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1610.1">implements OnDestroy</span></code><span class="koboSpan" id="kobo.1611.1"> statement and remove the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1612.1">OnDestroy</span></code><span class="koboSpan" id="kobo.1613.1"> import.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1614.1">Finally, modify</span><a id="_idIndexMarker313"/><span class="koboSpan" id="kobo.1615.1"> the template in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1616.1">home.component.html</span></code><span class="koboSpan" id="kobo.1617.1"> to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1618.1">streamOutput$</span></code><span class="koboSpan" id="kobo.1619.1"> observable with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1620.1">async</span></code><span class="koboSpan" id="kobo.1621.1"> pipe to loop over the output array:
        </span><pre class="programlisting code"><code class="hljs-code"> <span class="hljs-tag"><span class="koboSpan" id="kobo.1622.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1623.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1624.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1625.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1626.1">"output-stream"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1627.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1628.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1629.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1630.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1631.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1632.1">"input-stream__item"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1633.1"> *</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1634.1">ngFor</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1635.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1636.1">"let item of</span></span>
<span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1637.1">streamsOutput$ | async</span></strong></span><span class="hljs-string"><span class="koboSpan" id="kobo.1638.1">"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1639.1">&gt;</span></span><span class="koboSpan" id="kobo.1640.1">
        {{item}}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1641.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1642.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1643.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1644.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1645.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1646.1">&gt;</span></span>
</code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1647.1">To verify that the subscription </span><em class="italic"><span class="koboSpan" id="kobo.1648.1">really</span></em><span class="koboSpan" id="kobo.1649.1"> gets destroyed on component destruction, let’s put </span><code class="inlineCode"><span class="koboSpan" id="kobo.1650.1">console.log</span></code><span class="koboSpan" id="kobo.1651.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1652.1">startStream</span></code><span class="koboSpan" id="kobo.1653.1"> method inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1654.1">tap</span></code><span class="koboSpan" id="kobo.1655.1"> operator, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1656.1">import</span></span><span class="koboSpan" id="kobo.1657.1"> { ..., takeWhile, </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1658.1">tap</span></strong></span><span class="koboSpan" id="kobo.1659.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1660.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1661.1">'rxjs'</span></span><span class="koboSpan" id="kobo.1662.1">;
</span><span class="hljs-title"><span class="koboSpan" id="kobo.1663.1">startStream</span></span><span class="koboSpan" id="kobo.1664.1">() {
    ...
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1665.1">this</span></span><span class="koboSpan" id="kobo.1666.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1667.1">streamsOutput$</span></span><span class="koboSpan" id="kobo.1668.1"> = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1669.1">merge</span></span><span class="koboSpan" id="kobo.1670.1">(...).</span><span class="hljs-title"><span class="koboSpan" id="kobo.1671.1">pipe</span></span><span class="koboSpan" id="kobo.1672.1">(
      </span><span class="hljs-title"><span class="koboSpan" id="kobo.1673.1">takeWhile</span></span><span class="koboSpan" id="kobo.1674.1">(...),
      </span><span class="hljs-title"><span class="koboSpan" id="kobo.1675.1">scan</span></span><span class="koboSpan" id="kobo.1676.1">(...)</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1677.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1678.1">tap</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1679.1">(</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1680.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1681.1">output</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1682.1">) =&gt;</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1683.1">console</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1684.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1685.1">log</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1686.1">(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1687.1">'output'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1688.1">, output))</span></strong></span><span class="koboSpan" id="kobo.1689.1">
    )
  }
</span></code></pre>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1690.1">Hurray! </span><span class="koboSpan" id="kobo.1690.2">With this change, you can try refreshing the app; navigate away from the </span><strong class="screenText"><span class="koboSpan" id="kobo.1691.1">Home</span></strong><span class="koboSpan" id="kobo.1692.1"> route, and you’ll see that the console logs stop as soon as you navigate away from the homepage. </span><span class="koboSpan" id="kobo.1692.2">Also, you can start and stop the stream to see the output on the console. </span><span class="koboSpan" id="kobo.1692.3">Do you feel great about what we just got by removing all that extra code? </span><span class="koboSpan" id="kobo.1692.4">I certainly do. </span><span class="koboSpan" id="kobo.1692.5">We’ll see in the next section how it all works.</span></p>
<h2 class="heading-2" id="_idParaDest-178"><span class="koboSpan" id="kobo.1693.1">How it works…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1694.1">Angular’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.1695.1">async</span></code><span class="koboSpan" id="kobo.1696.1"> pipe automatically</span><a id="_idIndexMarker314"/><span class="koboSpan" id="kobo.1697.1"> destroys/unsubscribes the subscription as soon as the component is destroyed. </span><span class="koboSpan" id="kobo.1697.2">This gives us a great opportunity to use it where possible. </span><span class="koboSpan" id="kobo.1697.3">In the recipe, we basically combined all the streams using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1698.1">merge</span></code><span class="koboSpan" id="kobo.1699.1"> operator. </span><span class="koboSpan" id="kobo.1699.2">The fun part was that for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1700.1">streamsOutput$</span></code><span class="koboSpan" id="kobo.1701.1"> property, we wanted an observable of the output array on which we could loop over. </span><span class="koboSpan" id="kobo.1701.2">However, merging the streams only combines them and emits the latest value emitted by any of the streams. </span><span class="koboSpan" id="kobo.1701.3">So, we added a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1702.1">pipe</span></code><span class="koboSpan" id="kobo.1703.1"> function with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1704.1">scan</span></code><span class="koboSpan" id="kobo.1705.1"> operator to take the latest output of the combined stream and add it to an array of all the previously emitted outputs. </span><span class="koboSpan" id="kobo.1705.2">This sort of works like the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1706.1">reduce</span></code><span class="koboSpan" id="kobo.1707.1"> function of a JavaScript array.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1708.1">Fun fact—streams don’t emit any value unless they’re subscribed to. </span><span class="koboSpan" id="kobo.1708.2">“</span><em class="italic"><span class="koboSpan" id="kobo.1709.1">But Ahsan, we didn’t subscribe to the stream, we just merged and mapped the data. </span><span class="koboSpan" id="kobo.1709.2">Where’s the subscription?</span></em><span class="koboSpan" id="kobo.1710.1">” Glad you asked. </span><span class="koboSpan" id="kobo.1710.2">Angular’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.1711.1">async</span></code><span class="koboSpan" id="kobo.1712.1"> pipe subscribes to the stream itself, which triggers </span><code class="inlineCode"><span class="koboSpan" id="kobo.1713.1">console.log</span></code><span class="koboSpan" id="kobo.1714.1"> as well, which we added in </span><em class="italic"><span class="koboSpan" id="kobo.1715.1">Step 6</span></em><span class="koboSpan" id="kobo.1716.1"> using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1717.1">tap</span></code><span class="koboSpan" id="kobo.1718.1"> function.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.1719.1">IMPORTANT NOTE</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1720.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1721.1">async</span></code><span class="koboSpan" id="kobo.1722.1"> pipe has a limitation, which is that you cannot stop the subscription until the component is destroyed. </span><span class="koboSpan" id="kobo.1722.2">For cases where you want to subscribe and unsubscribe on a conditional basis, you’d want to go for operators such as the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1723.1">takeWhile/takeUntil</span></code><span class="koboSpan" id="kobo.1724.1"> operator or use a regular </span><code class="inlineCode"><span class="koboSpan" id="kobo.1725.1">unsubscribe</span></code><span class="koboSpan" id="kobo.1726.1"> function yourself when the component is destroyed.</span></p>
</div>
<h2 class="heading-2" id="_idParaDest-179"><span class="koboSpan" id="kobo.1727.1">See also</span></h2>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1728.1">Angular </span><code class="inlineCode"><span class="koboSpan" id="kobo.1729.1">async</span></code><span class="koboSpan" id="kobo.1730.1"> pipe documentation (</span><a href="https://angular.io/api/common/AsyncPipe"><span class="url"><span class="koboSpan" id="kobo.1731.1">https://angular.io/api/common/AsyncPipe</span></span></a><span class="koboSpan" id="kobo.1732.1">)</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-180"><span class="koboSpan" id="kobo.1733.1">Using the map operator to transform data</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1734.1">When </span><a id="_idIndexMarker315"/><span class="koboSpan" id="kobo.1735.1">making the API/HTTP calls in a web application, it is often the case that the server doesn’t return the data in a form that is </span><a id="_idIndexMarker316"/><span class="koboSpan" id="kobo.1736.1">easy to directly render to the UI. </span><span class="koboSpan" id="kobo.1736.2">We often need some sort of transformation of the data received from the server to map it to something our UI can work with. </span><span class="koboSpan" id="kobo.1736.3">In this recipe, you’re going to learn how to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1737.1">map</span></code><span class="koboSpan" id="kobo.1738.1"> operator to transform responses from an HTTP call.</span></p>
<h2 class="heading-2" id="_idParaDest-181"><span class="koboSpan" id="kobo.1739.1">Getting ready</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1740.1">The app that we </span><a id="_idIndexMarker317"/><span class="koboSpan" id="kobo.1741.1">are going to work with resides in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1742.1">start/apps/chapter05/rx-map-operator</span></code><span class="koboSpan" id="kobo.1743.1"> inside the cloned repository:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1744.1">Open the code repository in your code editor.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1745.1">Open the terminal, navigate to the code repository directory, and run the following command to serve the project:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1746.1">npm run serve rx-map-operator
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1747.1">This should open the app in a new browser tab, and you should see the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1748.1"><img alt="" role="presentation" src="../Images/B18469_05_06.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1749.1">Figure 5.6: The rx-map-operator app running on http://localhost:4200</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1750.1">Now that we have the app running locally, let’s see the steps of the recipe in the next section.</span></p>
<h2 class="heading-2" id="_idParaDest-182"><span class="koboSpan" id="kobo.1751.1">How to do it…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1752.1">Our template (</span><code class="inlineCode"><span class="koboSpan" id="kobo.1753.1">app.component.html</span></code><span class="koboSpan" id="kobo.1754.1">) for the app is set up already. </span><span class="koboSpan" id="kobo.1754.2">And so is our </span><code class="inlineCode"><span class="koboSpan" id="kobo.1755.1">app.component.ts</span></code><span class="koboSpan" id="kobo.1756.1"> file and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1757.1">appData</span></code><span class="koboSpan" id="kobo.1758.1"> data structure that we require.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1759.1">We’ll start</span><a id="_idIndexMarker318"/><span class="koboSpan" id="kobo.1760.1"> by creating a method in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1761.1">swapi.service.ts</span></code><span class="koboSpan" id="kobo.1762.1"> file to fetch the data. </span><span class="koboSpan" id="kobo.1762.2">We want only one function to be able to bring the data from different API calls, combine it, and return it. </span><span class="koboSpan" id="kobo.1762.3">Update the file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1763.1">...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1764.1">import</span></span><span class="koboSpan" id="kobo.1765.1"> { delay, forkJoin, </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1766.1">Observable</span></strong></span><span class="koboSpan" id="kobo.1767.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1768.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1769.1">'rxjs'</span></span><span class="koboSpan" id="kobo.1770.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1771.1">import</span></span><span class="koboSpan" id="kobo.1772.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.1773.1">IFilm</span></span><span class="koboSpan" id="kobo.1774.1">, </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1775.1">IPerson</span></strong></span><span class="koboSpan" id="kobo.1776.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1777.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1778.1">'./interfaces'</span></span><span class="koboSpan" id="kobo.1779.1">;
...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1780.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1781.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1782.1">SwapiService</span></span><span class="koboSpan" id="kobo.1783.1"> {
  ...
  </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1784.1">fetchData</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1785.1">(</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1786.1">personId</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1787.1">: </span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1788.1">string</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1789.1">): </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1790.1">Observable</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1791.1">&lt;{</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1792.1">person</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1793.1">:</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1794.1">IPerson</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1795.1">}&gt; {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1796.1">}</span></strong></span>
<span class="hljs-title"><span class="koboSpan" id="kobo.1797.1">fetchPerson</span></span><span class="koboSpan" id="kobo.1798.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1799.1">id: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1800.1">string</span></span><span class="koboSpan" id="kobo.1801.1">) {...}
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1802.1">fetchPersonFilms</span></span><span class="koboSpan" id="kobo.1803.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1804.1">films: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1805.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1806.1">[]</span></span><span class="koboSpan" id="kobo.1807.1">) {...}
}
</span></code></pre>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.1808.1">You’re going to see that TypeScript is mad at us. </span><span class="koboSpan" id="kobo.1808.2">Don’t worry about it. </span><span class="koboSpan" id="kobo.1808.3">We’ll make it happy in time</span></em><span class="koboSpan" id="kobo.1809.1">.</span></p> </li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="2"><span class="koboSpan" id="kobo.1810.1">Let’s add </span><a id="_idIndexMarker319"/><span class="koboSpan" id="kobo.1811.1">the following code to first get the person, and then get the films of that person in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1812.1">fetchData</span></code><span class="koboSpan" id="kobo.1813.1"> function:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1814.1">...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1815.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1816.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1817.1">SwapiService</span></span><span class="koboSpan" id="kobo.1818.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1819.1">fetchData</span></span><span class="koboSpan" id="kobo.1820.1">(</span><span class="hljs-attr"><span class="koboSpan" id="kobo.1821.1">personId</span></span><span class="koboSpan" id="kobo.1822.1">: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1823.1">string</span></span><span class="koboSpan" id="kobo.1824.1">): </span><span class="hljs-title"><span class="koboSpan" id="kobo.1825.1">Observable</span></span><span class="koboSpan" id="kobo.1826.1">&lt;{</span><span class="hljs-attr"><span class="koboSpan" id="kobo.1827.1">person</span></span><span class="koboSpan" id="kobo.1828.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.1829.1">IPerson</span></span><span class="koboSpan" id="kobo.1830.1">}&gt; {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1831.1">let</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.1832.1">personInfo</span></span><span class="koboSpan" id="kobo.1833.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.1834.1">IPerson</span></span><span class="koboSpan" id="kobo.1835.1">;
    </span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1836.1">return</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1837.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1838.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1839.1">fetchPerson</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1840.1">(personId)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1841.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1842.1">pipe</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1843.1">(</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1844.1">mergeMap</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1845.1">(</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1846.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1847.1">person</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1848.1">) =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1849.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1850.1">personInfo = person;</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1851.1">return</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1852.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1853.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1854.1">fetchPersonFilms</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1855.1">(person.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1856.1">films</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1857.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1858.1">})</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1859.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1860.1">}</span></strong></span><span class="koboSpan" id="kobo.1861.1">
  ...
</span><span class="koboSpan" id="kobo.1861.2">}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1862.1">Now we can decide what to do when we receive the films back.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.1863.1">We’ll map </span><a id="_idIndexMarker320"/><span class="koboSpan" id="kobo.1864.1">over the response from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1865.1">films</span></code><span class="koboSpan" id="kobo.1866.1"> HTTP calls and add that to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1867.1">personInfo</span></code><span class="koboSpan" id="kobo.1868.1"> object. </span><span class="koboSpan" id="kobo.1868.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1869.1">swapi.service.ts</span></code><span class="koboSpan" id="kobo.1870.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1871.1">...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1872.1">import</span></span><span class="koboSpan" id="kobo.1873.1"> { delay, forkJoin, </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1874.1">map</span></strong></span><span class="koboSpan" id="kobo.1875.1">, mergeMap, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1876.1">Observable</span></span><span class="koboSpan" id="kobo.1877.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1878.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1879.1">'rxjs'</span></span><span class="koboSpan" id="kobo.1880.1">;
...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1881.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1882.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1883.1">SwapiService</span></span><span class="koboSpan" id="kobo.1884.1"> {
 ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1885.1">fetchData</span></span><span class="koboSpan" id="kobo.1886.1">(</span><span class="hljs-attr"><span class="koboSpan" id="kobo.1887.1">personId</span></span><span class="koboSpan" id="kobo.1888.1">: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1889.1">string</span></span><span class="koboSpan" id="kobo.1890.1">): </span><span class="hljs-title"><span class="koboSpan" id="kobo.1891.1">Observable</span></span><span class="koboSpan" id="kobo.1892.1">&lt;{ </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1893.1">person</span></span><span class="koboSpan" id="kobo.1894.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.1895.1">IPerson</span></span><span class="koboSpan" id="kobo.1896.1"> }&gt; {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1897.1">let</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.1898.1">personInfo</span></span><span class="koboSpan" id="kobo.1899.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.1900.1">IPerson</span></span><span class="koboSpan" id="kobo.1901.1">;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1902.1">return</span></span> <span class="hljs-variable"><span class="koboSpan" id="kobo.1903.1">this</span></span><span class="koboSpan" id="kobo.1904.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1905.1">fetchPerson</span></span><span class="koboSpan" id="kobo.1906.1">(personId).</span><span class="hljs-title"><span class="koboSpan" id="kobo.1907.1">pipe</span></span><span class="koboSpan" id="kobo.1908.1">(
      </span><span class="hljs-title"><span class="koboSpan" id="kobo.1909.1">mergeMap</span></span><span class="koboSpan" id="kobo.1910.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.1911.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1912.1">person</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1913.1">) =&gt;</span></span><span class="koboSpan" id="kobo.1914.1"> {
        personInfo = person;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1915.1">return</span></span> <span class="hljs-variable"><span class="koboSpan" id="kobo.1916.1">this</span></span><span class="koboSpan" id="kobo.1917.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1918.1">fetchPersonFilms</span></span><span class="koboSpan" id="kobo.1919.1">(person.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1920.1">films</span></span><span class="koboSpan" id="kobo.1921.1">);
      })</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1922.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1923.1">map</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1924.1">(</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1925.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1926.1">films: IFilm[]</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1927.1">) =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1928.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1929.1">personInfo.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1930.1">filmObjects</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1931.1"> = films;</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1932.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1933.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1934.1">person</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1935.1">: personInfo,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1936.1">};</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1937.1">})</span></strong></span><span class="koboSpan" id="kobo.1938.1">
    );
  }
  ...
</span><span class="koboSpan" id="kobo.1938.2">}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1939.1">Finally, let’s </span><a id="_idIndexMarker321"/><span class="koboSpan" id="kobo.1940.1">use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1941.1">fetchData</span></code><span class="koboSpan" id="kobo.1942.1"> method from </span><code class="inlineCode"><span class="koboSpan" id="kobo.1943.1">SwapiService</span></code><span class="koboSpan" id="kobo.1944.1"> inside our </span><code class="inlineCode"><span class="koboSpan" id="kobo.1945.1">app.component.ts</span></code><strong class="keyWord"> </strong><span class="koboSpan" id="kobo.1946.1">file. </span><span class="koboSpan" id="kobo.1946.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1947.1">fetchData</span></code><span class="koboSpan" id="kobo.1948.1"> method in the file as follows and make sure you remove unused dependencies from the file:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1949.1">...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1950.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1951.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1952.1">AppComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1953.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1954.1">OnInit</span></span><span class="koboSpan" id="kobo.1955.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1956.1">fetchData</span></span><span class="koboSpan" id="kobo.1957.1">() {
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1958.1">this</span></span><span class="koboSpan" id="kobo.1959.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1960.1">loadingData</span></span><span class="koboSpan" id="kobo.1961.1"> = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1962.1">true</span></span><span class="koboSpan" id="kobo.1963.1">;
    </span><span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1964.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1965.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1966.1">swapi</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1967.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1968.1">fetchData</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1969.1">(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1970.1">'1'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1971.1">).</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1972.1">subscribe</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1973.1">(</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1974.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1975.1">response</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1976.1">) =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1977.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1978.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1979.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1980.1">appData</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1981.1"> = response;</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1982.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1983.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1984.1">loadingData</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1985.1"> = </span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.1986.1">false</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1987.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1988.1">});</span></strong></span><span class="koboSpan" id="kobo.1989.1">
  }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1990.1">And yes! </span><span class="koboSpan" id="kobo.1990.2">If </span><a id="_idIndexMarker322"/><span class="koboSpan" id="kobo.1991.1">you now refresh the app, you’ll notice that the data is being displayed in the view:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1992.1"><img alt="" role="presentation" src="../Images/B18469_05_07.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1993.1">Figure 5.7: The UI showing the received data from swapi</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1994.1">Now that you’ve </span><a id="_idIndexMarker323"/><span class="koboSpan" id="kobo.1995.1">finished the recipe, see the next section on how this works.</span></p>
<h2 class="heading-2" id="_idParaDest-183"><span class="koboSpan" id="kobo.1996.1">How it works…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1997.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1998.1">map</span></code><span class="koboSpan" id="kobo.1999.1"> operator is one of the most used RxJS operators of all time. </span><span class="koboSpan" id="kobo.1999.2">Especially in Angular when we make HTTP calls. </span><span class="koboSpan" id="kobo.1999.3">In this recipe, our target was to do as little work as possible in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2000.1">app.component.ts</span></code><span class="koboSpan" id="kobo.2001.1"> file. </span><span class="koboSpan" id="kobo.2001.2">That’s because as one of the community-adopted practices, the component should request data from the service and the service should give it in such a way that it can be bound to the UI variables as is. </span><span class="koboSpan" id="kobo.2001.3">The Angular documentation also encourages keeping the component’s code as tiny as possible. </span><span class="koboSpan" id="kobo.2001.4">It is also generally a good idea to distribute your code into different layers, i.e., in components, services, pipes, etc. </span><span class="koboSpan" id="kobo.2001.5">This is to be able to scale the application with ease, have better testing</span><a id="_idIndexMarker324"/><span class="koboSpan" id="kobo.2002.1"> possibilities, and be able to easily replace the layers with a completely different </span><a id="_idIndexMarker325"/><span class="koboSpan" id="kobo.2003.1">thing. </span><span class="koboSpan" id="kobo.2003.2">Therefore, we created this </span><code class="inlineCode"><span class="koboSpan" id="kobo.2004.1">fetchData</span></code><span class="koboSpan" id="kobo.2005.1"> method in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2006.1">SwapiService</span></code><span class="koboSpan" id="kobo.2007.1"> class to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2008.1">fetchPerson</span></code><span class="koboSpan" id="kobo.2009.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2010.1">fetchPersonFilms</span></code><span class="koboSpan" id="kobo.2011.1"> methods to first make the HTTP calls, and then we used the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2012.1">map</span></code><span class="koboSpan" id="kobo.2013.1"> operator to transform the data into exactly the data structure our component/UI is expecting.</span></p>
<h2 class="heading-2" id="_idParaDest-184"><span class="koboSpan" id="kobo.2014.1">See also</span></h2>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2015.1">map</span></code><span class="koboSpan" id="kobo.2016.1"> operator documentation (</span><a href="https://www.learnrxjs.io/learn-rxjs/operators/transformation/map"><span class="url"><span class="koboSpan" id="kobo.2017.1">https://www.learnrxjs.io/learn-rxjs/operators/transformation/map</span></span></a><span class="koboSpan" id="kobo.2018.1">)</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-185"><span class="koboSpan" id="kobo.2019.1">Using the switchMap and debounceTime operators with autocompletes for better performance</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2020.1">For a lot of apps, we</span><a id="_idIndexMarker326"/><span class="koboSpan" id="kobo.2021.1"> have features such as searching content as the user types. </span><span class="koboSpan" id="kobo.2021.2">This is a really good </span><strong class="keyWord"><span class="koboSpan" id="kobo.2022.1">User Experience</span></strong><span class="koboSpan" id="kobo.2023.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.2024.1">UX</span></strong><span class="koboSpan" id="kobo.2025.1">) as the user doesn’t have to press a</span><a id="_idIndexMarker327"/><span class="koboSpan" id="kobo.2026.1"> button to do a search. </span><span class="koboSpan" id="kobo.2026.2">However, if we send an HTTP call to the server on every key press, that’s going to result in a lot of HTTP calls being sent, and we can’t know which HTTP call will complete first; thus, we</span><a id="_idIndexMarker328"/><span class="koboSpan" id="kobo.2027.1"> can’t be sure if we will have the correct data shown in the view or not. </span><span class="koboSpan" id="kobo.2027.2">In this recipe, you’ll learn how to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2028.1">switchMap</span></code><span class="koboSpan" id="kobo.2029.1"> operator to cancel out the last subscription and create a new one instead. </span><span class="koboSpan" id="kobo.2029.2">This would result in canceling previous HTTP calls and keeping only one HTTP call—the last one. </span><span class="koboSpan" id="kobo.2029.3">We’ll use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2030.1">debounceTime</span></code><span class="koboSpan" id="kobo.2031.1"> operator to wait for the input to be idle before it even tries to make one call.</span></p>
<h2 class="heading-2" id="_idParaDest-186"><span class="koboSpan" id="kobo.2032.1">Getting ready</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2033.1">The app that we are going to work with resides in </span><code class="inlineCode"><span class="koboSpan" id="kobo.2034.1">start/apps/chapter05/rx-switchmap-operator</span></code><span class="koboSpan" id="kobo.2035.1"> inside the cloned repository:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2036.1">Open the code repository in your code editor.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2037.1">Open the terminal, navigate to the code repository directory, and run the following command to serve the project:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2038.1">npm run serve rx-switchmap-operato
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2039.1">This should open the app in a new browser tab, and you should see the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2040.1"><img alt="" role="presentation" src="../Images/B18469_05_08.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2041.1">Figure 5.8: The rx-switchmap-operator app running on http://localhost:4200</span></p> </li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2042.1">Now that</span><a id="_idIndexMarker329"/><span class="koboSpan" id="kobo.2043.1"> we have the app</span><a id="_idIndexMarker330"/><span class="koboSpan" id="kobo.2044.1"> running locally, open </span><strong class="screenText"><span class="koboSpan" id="kobo.2045.1">Chrome DevTools</span></strong><span class="koboSpan" id="kobo.2046.1"> and go to the </span><strong class="screenText"><span class="koboSpan" id="kobo.2047.1">Network</span></strong><span class="koboSpan" id="kobo.2048.1"> tab. </span><span class="koboSpan" id="kobo.2048.2">Type </span><code class="inlineCode"><span class="koboSpan" id="kobo.2049.1">wolf</span></code><span class="koboSpan" id="kobo.2050.1"> in the search input, and you’ll see four calls being sent to the API server, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2051.1"><img alt="" role="presentation" src="../Images/B18469_05_09.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2052.1">Figure 5.9: A separate HTTP call is sent for each input change</span></p>
<h2 class="heading-2" id="_idParaDest-187"><span class="koboSpan" id="kobo.2053.1">How to do it…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2054.1">You can start typing into</span><a id="_idIndexMarker331"/><span class="koboSpan" id="kobo.2055.1"> the search box on the homepage to see the filtered users, and if you see the </span><strong class="screenText"><span class="koboSpan" id="kobo.2056.1">Network</span></strong><span class="koboSpan" id="kobo.2057.1"> tab, you’ll notice that </span><a id="_idIndexMarker332"/><span class="koboSpan" id="kobo.2058.1">whenever the input changes, we send a new HTTP call. </span><span class="koboSpan" id="kobo.2058.2">Let’s avoid sending a call on each keypress by using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2059.1">switchMap</span></code><span class="koboSpan" id="kobo.2060.1"> operator.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2061.1">First, import the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2062.1">switchMap</span></code><span class="koboSpan" id="kobo.2063.1"> operator from </span><code class="inlineCode"><span class="koboSpan" id="kobo.2064.1">rxjs/operators</span></code><span class="koboSpan" id="kobo.2065.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2066.1">users/users.component.ts</span></code><span class="koboSpan" id="kobo.2067.1"> file, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2068.1">...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2069.1">import</span></span><span class="koboSpan" id="kobo.2070.1"> { mergeMap, startWith, takeWhile, </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2071.1">switchMap</span></strong></span><span class="koboSpan" id="kobo.2072.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2073.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2074.1">'rxjs/operators'</span></span><span class="koboSpan" id="kobo.2075.1">;
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.2076.1">We will now modify our subscription to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2077.1">username</span></code><span class="koboSpan" id="kobo.2078.1"> form control— specifically, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2079.1">valueChanges</span></code><span class="koboSpan" id="kobo.2080.1"> observable to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2081.1">switchMap</span></code><span class="koboSpan" id="kobo.2082.1"> operator for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2083.1">this.userService.searchUsers(query)</span></code><span class="koboSpan" id="kobo.2084.1"> method call. </span><span class="koboSpan" id="kobo.2084.2">This returns an </span><code class="inlineCode"><span class="koboSpan" id="kobo.2085.1">Observable</span></code><span class="koboSpan" id="kobo.2086.1"> containing the result of the HTTP call. </span><span class="koboSpan" id="kobo.2086.2">The code should look like this:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-title"><span class="koboSpan" id="kobo.2087.1">ngOnInit</span></span><span class="koboSpan" id="kobo.2088.1">() {
    ...
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.2089.1">this</span></span><span class="koboSpan" id="kobo.2090.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2091.1">searchForm</span></span><span class="koboSpan" id="kobo.2092.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2093.1">controls</span></span><span class="koboSpan" id="kobo.2094.1">[</span><span class="hljs-string"><span class="koboSpan" id="kobo.2095.1">'username'</span></span><span class="koboSpan" id="kobo.2096.1">].</span><span class="hljs-property"><span class="koboSpan" id="kobo.2097.1">valueChanges</span></span><span class="koboSpan" id="kobo.2098.1">
      .</span><span class="hljs-title"><span class="koboSpan" id="kobo.2099.1">pipe</span></span><span class="koboSpan" id="kobo.2100.1">(
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.2101.1">startWith</span></span><span class="koboSpan" id="kobo.2102.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2103.1">''</span></span><span class="koboSpan" id="kobo.2104.1">),
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.2105.1">takeWhile</span></span><span class="koboSpan" id="kobo.2106.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.2107.1">() =&gt;</span></span> <span class="hljs-variable"><span class="koboSpan" id="kobo.2108.1">this</span></span><span class="koboSpan" id="kobo.2109.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2110.1">componentAlive</span></span><span class="koboSpan" id="kobo.2111.1">),
        </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2112.1">switchMap</span></strong></span><span class="koboSpan" id="kobo.2113.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.2114.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2115.1">query</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2116.1">) =&gt;</span></span>
<span class="hljs-variable"><span class="koboSpan" id="kobo.2117.1">this</span></span><span class="koboSpan" id="kobo.2118.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2119.1">userService</span></span><span class="koboSpan" id="kobo.2120.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.2121.1">searchUsers</span></span><span class="koboSpan" id="kobo.2122.1">(query))
      )
      .</span><span class="hljs-title"><span class="koboSpan" id="kobo.2123.1">subscribe</span></span><span class="koboSpan" id="kobo.2124.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.2125.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2126.1">users</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2127.1">) =&gt;</span></span><span class="koboSpan" id="kobo.2128.1"> {...});
  }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2129.1">If you refresh the app now, open </span><strong class="screenText"><span class="koboSpan" id="kobo.2130.1">Chrome DevTools</span></strong><span class="koboSpan" id="kobo.2131.1">, and check the network type while typing </span><code class="inlineCode"><span class="koboSpan" id="kobo.2132.1">wolf</span></code><span class="koboSpan" id="kobo.2133.1"> really fast, you’ll see that all the previous calls are canceled and we only have the latest HTTP call succeeding:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2134.1"><img alt="" role="presentation" src="../Images/B18469_05_10.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2135.1">Figure 5.10: switchMap canceling prior HTTP calls</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2136.1">Well, this looks better, but the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2137.1">backend/api</span></code><span class="koboSpan" id="kobo.2138.1"> endpoint still receives those calls.</span></p> </li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.2139.1">We’re going</span><a id="_idIndexMarker333"/><span class="koboSpan" id="kobo.2140.1"> to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2141.1">debounceTime</span></code><span class="koboSpan" id="kobo.2142.1"> operator now to wait for the search input to be idle before starting to </span><a id="_idIndexMarker334"/><span class="koboSpan" id="kobo.2143.1">execute a call. </span><span class="koboSpan" id="kobo.2143.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2144.1">users.component.ts</span></code><span class="koboSpan" id="kobo.2145.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2146.1">...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2147.1">import</span></span><span class="koboSpan" id="kobo.2148.1"> {</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2149.1"> debounceTime, ..</span></strong></span><span class="koboSpan" id="kobo.2150.1">.} </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2151.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2152.1">'rxjs/operators'</span></span><span class="koboSpan" id="kobo.2153.1">;
...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2154.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2155.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2156.1">UsersComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2157.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2158.1">OnInit</span></span><span class="koboSpan" id="kobo.2159.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.2160.1">ngOnInit</span></span><span class="koboSpan" id="kobo.2161.1">() {
    ...
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.2162.1">this</span></span><span class="koboSpan" id="kobo.2163.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2164.1">searchForm</span></span><span class="koboSpan" id="kobo.2165.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2166.1">controls</span></span><span class="koboSpan" id="kobo.2167.1">[</span><span class="hljs-string"><span class="koboSpan" id="kobo.2168.1">'username'</span></span><span class="koboSpan" id="kobo.2169.1">].</span><span class="hljs-property"><span class="koboSpan" id="kobo.2170.1">valueChanges</span></span><span class="koboSpan" id="kobo.2171.1">
      .</span><span class="hljs-title"><span class="koboSpan" id="kobo.2172.1">pipe</span></span><span class="koboSpan" id="kobo.2173.1">(
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.2174.1">startWith</span></span><span class="koboSpan" id="kobo.2175.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2176.1">''</span></span><span class="koboSpan" id="kobo.2177.1">),
        </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2178.1">debounceTime</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2179.1">(</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.2180.1">500</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2181.1">),</span></strong></span>
<span class="hljs-title"><span class="koboSpan" id="kobo.2182.1">takeWhile</span></span><span class="koboSpan" id="kobo.2183.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.2184.1">() =&gt;</span></span> <span class="hljs-variable"><span class="koboSpan" id="kobo.2185.1">this</span></span><span class="koboSpan" id="kobo.2186.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2187.1">componentAlive</span></span><span class="koboSpan" id="kobo.2188.1">),
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.2189.1">switchMap</span></span><span class="koboSpan" id="kobo.2190.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.2191.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2192.1">query</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2193.1">) =&gt;</span></span>
<span class="hljs-variable"><span class="koboSpan" id="kobo.2194.1">this</span></span><span class="koboSpan" id="kobo.2195.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2196.1">userService</span></span><span class="koboSpan" id="kobo.2197.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.2198.1">searchUsers</span></span><span class="koboSpan" id="kobo.2199.1">(query))
      )
      .</span><span class="hljs-title"><span class="koboSpan" id="kobo.2200.1">subscribe</span></span><span class="koboSpan" id="kobo.2201.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.2202.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2203.1">users</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2204.1">) =&gt;</span></span><span class="koboSpan" id="kobo.2205.1"> {...});
  }
}
</span></code></pre>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.2206.1">Figure 5.11</span></em><span class="koboSpan" id="kobo.2207.1"> shows that there is only one call sent to the server, even after typing four letters in the search input:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2208.1"><img alt="" role="presentation" src="../Images/B18469_05_11.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2209.1">Figure 5.11: debounceTime waiting for the input to be idle</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2210.1">Woot! </span><span class="koboSpan" id="kobo.2210.2">We now</span><a id="_idIndexMarker335"/><span class="koboSpan" id="kobo.2211.1"> have</span><a id="_idIndexMarker336"/><span class="koboSpan" id="kobo.2212.1"> only one call that’ll succeed, process the data, and end up in the view; see the next section on how it works.</span></p>
<h2 class="heading-2" id="_idParaDest-188"><span class="koboSpan" id="kobo.2213.1">How it works…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2214.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2215.1">switchMap</span></code><span class="koboSpan" id="kobo.2216.1"> operator cancels the previous (inner) subscription and subscribes to a new observable instead. </span><span class="koboSpan" id="kobo.2216.2">In our case, the parent observable (the input element’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.2217.1">valueChanges</span></code><span class="koboSpan" id="kobo.2218.1"> emitter) emits a value, and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2219.1">switchMap</span></code><span class="koboSpan" id="kobo.2220.1"> operator cancels the previous operation in progress. </span><span class="koboSpan" id="kobo.2220.2">That’s why it cancels all the HTTP calls sent before in our example and just subscribes to the last one. </span><span class="koboSpan" id="kobo.2220.3">However, the call still reaches the API endpoint. </span><span class="koboSpan" id="kobo.2220.4">If this was our server, we may still receive the API calls, so we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2221.1">debounceTime</span></code><span class="koboSpan" id="kobo.2222.1"> operator on the form control to wait for the input to be idle (for 500 ms) before we even send our first call.</span></p>
<h2 class="heading-2" id="_idParaDest-189"><span class="koboSpan" id="kobo.2223.1">See also</span></h2>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2224.1">switchMap</span></code><span class="koboSpan" id="kobo.2225.1"> operator documentation (</span><a href="https://www.learnrxjs.io/learn-rxjs/operators/transformation/switchmap"><span class="url"><span class="koboSpan" id="kobo.2226.1">https://www.learnrxjs.io/learn-rxjs/operators/transformation/switchmap</span></span></a><span class="koboSpan" id="kobo.2227.1">)</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2228.1">debounceTime</span></code><span class="koboSpan" id="kobo.2229.1"> operator documentation (</span><a href="https://www.learnrxjs.io/learn-rxjs/operators/filtering/debouncetime"><span class="url"><span class="koboSpan" id="kobo.2230.1">https://www.learnrxjs.io/learn-rxjs/operators/filtering/debouncetime</span></span></a><span class="koboSpan" id="kobo.2231.1">)</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-190"><span class="koboSpan" id="kobo.2232.1">Creating a custom RxJS operator</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2233.1">By following</span><a id="_idIndexMarker337"/><span class="koboSpan" id="kobo.2234.1"> the other recipes in this chapter, I have to ask if you’ve become a fan of RxJS yet? </span><em class="italic"><span class="koboSpan" id="kobo.2235.1">Have you?</span></em><span class="koboSpan" id="kobo.2236.1"> Well, I am. </span><span class="koboSpan" id="kobo.2236.2">And in this recipe, you’re going to level up your RxJS game. </span><span class="koboSpan" id="kobo.2236.3">You’re going to create your own custom RxJS operator that just taps into any observable stream and logs the values on the console. </span><span class="koboSpan" id="kobo.2236.4">We’ll call it the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2237.1">logWithLabel</span></code><span class="koboSpan" id="kobo.2238.1"> operator.</span></p>
<h2 class="heading-2" id="_idParaDest-191"><span class="koboSpan" id="kobo.2239.1">Getting ready</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2240.1">The app that we are going to work with resides in </span><code class="inlineCode"><span class="koboSpan" id="kobo.2241.1">start/apps/chapter05/rx-custom-operator</span></code><span class="koboSpan" id="kobo.2242.1"> inside the cloned repository:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2243.1">Open the code repository in your code editor.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2244.1">Open the terminal, navigate to the code repository directory, and run the following command to serve the project:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2245.1">npm run serve rx-custom-operator
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2246.1">This should open the app in a new browser tab. </span><span class="koboSpan" id="kobo.2246.2">If you click the </span><strong class="screenText"><span class="koboSpan" id="kobo.2247.1">Start Stream</span></strong><span class="koboSpan" id="kobo.2248.1"> button while you have the DevTools open, you should see the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2249.1"><img alt="" role="presentation" src="../Images/B18469_05_12.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2250.1">Figure 5.12: The rx-custom-operator app running on http://localhost.4200</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2251.1">Let’s jump into the recipe steps in the next section.</span></p>
<h2 class="heading-2" id="_idParaDest-192"><span class="koboSpan" id="kobo.2252.1">How to do it…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2253.1">We’re going to </span><a id="_idIndexMarker338"/><span class="koboSpan" id="kobo.2254.1">create a custom RxJS operator named </span><code class="inlineCode"><span class="koboSpan" id="kobo.2255.1">logWithLabel</span></code><span class="koboSpan" id="kobo.2256.1">, which will log the values of the observable stream on the console with a label.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2257.1">Create a new file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2258.1">app</span></code><span class="koboSpan" id="kobo.2259.1"> folder and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.2260.1">log-with-label.ts</span></code><span class="koboSpan" id="kobo.2261.1">. </span><span class="koboSpan" id="kobo.2261.2">Then add the following code inside the file:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2262.1">import</span></span><span class="koboSpan" id="kobo.2263.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.2264.1">Observable</span></span><span class="koboSpan" id="kobo.2265.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2266.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2267.1">'rxjs/internal/Observable'</span></span><span class="koboSpan" id="kobo.2268.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2269.1">import</span></span><span class="koboSpan" id="kobo.2270.1"> { tap } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2271.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2272.1">'rxjs/operators'</span></span><span class="koboSpan" id="kobo.2273.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2274.1">const</span></span><span class="koboSpan" id="kobo.2275.1"> logWithLabel = &lt;T&gt;(
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2276.1">label</span></span><span class="koboSpan" id="kobo.2277.1">: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2278.1">string</span></span><span class="koboSpan" id="kobo.2279.1">
): </span><span class="hljs-function"><span class="koboSpan" id="kobo.2280.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2281.1">(source$: Observable&lt;T&gt;) =&gt; Observable&lt;T&gt;</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2282.1">) =&gt;</span></span><span class="koboSpan" id="kobo.2283.1"> {
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2284.1">return</span></span> <span class="hljs-function"><span class="koboSpan" id="kobo.2285.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2286.1">source$</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2287.1">) =&gt;</span></span><span class="koboSpan" id="kobo.2288.1"> source$.</span><span class="hljs-title"><span class="koboSpan" id="kobo.2289.1">pipe</span></span><span class="koboSpan" id="kobo.2290.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2291.1">tap</span></span><span class="koboSpan" id="kobo.2292.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.2293.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2294.1">value</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2295.1">) =&gt;</span></span>
<span class="hljs-variable"><span class="koboSpan" id="kobo.2296.1">console</span></span><span class="koboSpan" id="kobo.2297.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.2298.1">log</span></span><span class="koboSpan" id="kobo.2299.1">(label, value)));
};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2300.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2301.1">default</span></span><span class="koboSpan" id="kobo.2302.1"> logWithLabel;
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.2303.1">Now we can import the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2304.1">logWithLabel</span></code><span class="koboSpan" id="kobo.2305.1"> operator from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2306.1">log-with-label.ts</span></code><span class="koboSpan" id="kobo.2307.1"> file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2308.1">home/home.component.ts</span></code><span class="koboSpan" id="kobo.2309.1"> file, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2310.1">...
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2311.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2312.1"> logWithLabel </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2313.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2314.1">'../log-with-label'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2315.1">;</span></strong></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.2316.1">@Component</span></span><span class="koboSpan" id="kobo.2317.1">({...})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2318.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2319.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2320.1">HomeComponent</span></span><span class="koboSpan" id="kobo.2321.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.2322.1">startStream</span></span><span class="koboSpan" id="kobo.2323.1">() {
    ...
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.2324.1">this</span></span><span class="koboSpan" id="kobo.2325.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2326.1">streamsOutput$</span></span><span class="koboSpan" id="kobo.2327.1"> = </span><span class="hljs-title"><span class="koboSpan" id="kobo.2328.1">merge</span></span><span class="koboSpan" id="kobo.2329.1">(...).</span><span class="hljs-title"><span class="koboSpan" id="kobo.2330.1">pipe</span></span><span class="koboSpan" id="kobo.2331.1">(
      </span><span class="hljs-title"><span class="koboSpan" id="kobo.2332.1">takeWhile</span></span><span class="koboSpan" id="kobo.2333.1">(...),
      </span><span class="hljs-title"><span class="koboSpan" id="kobo.2334.1">scan</span></span><span class="koboSpan" id="kobo.2335.1">(...),
      </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2336.1">logWithLabel</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2337.1">(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2338.1">'stream-output'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2339.1">)</span></strong></span><span class="koboSpan" id="kobo.2340.1">
    );
  }
  ...
</span><span class="koboSpan" id="kobo.2340.2">}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2341.1">And that’s it! </span><span class="koboSpan" id="kobo.2341.2">If you refresh the app and click the </span><strong class="screenText"><span class="koboSpan" id="kobo.2342.1">Start Stream</span></strong><span class="koboSpan" id="kobo.2343.1"> button, you can see the output using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2344.1">logWithLabel</span></code><span class="koboSpan" id="kobo.2345.1"> operator, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2346.1"><img alt="" role="presentation" src="../Images/B18469_05_13.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2347.1">Figure 5.13: Logs using the logWithLabel custom RxJS operator</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2348.1">See the next</span><a id="_idIndexMarker339"/><span class="koboSpan" id="kobo.2349.1"> section to understand how it all works.</span></p>
<h2 class="heading-2" id="_idParaDest-193"><span class="koboSpan" id="kobo.2350.1">How it works…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2351.1">A custom RxJS operator is a function that should take an observable source stream and return </span><em class="italic"><span class="koboSpan" id="kobo.2352.1">something</span></em><span class="koboSpan" id="kobo.2353.1">. </span><span class="koboSpan" id="kobo.2353.2">That </span><em class="italic"><span class="koboSpan" id="kobo.2354.1">something</span></em><span class="koboSpan" id="kobo.2355.1"> is usually an observable. </span><span class="koboSpan" id="kobo.2355.2">In this recipe, we wanted to tap into the stream to log something on the console every time the stream emits a value. </span><span class="koboSpan" id="kobo.2355.3">We also wanted to have a custom label for the logs for this stream. </span><span class="koboSpan" id="kobo.2355.4">This is why we ended up creating the custom operator as a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2356.1">factory</span></code><span class="koboSpan" id="kobo.2357.1"> function that can take </span><code class="inlineCode"><span class="koboSpan" id="kobo.2358.1">label</span></code><span class="koboSpan" id="kobo.2359.1"> as input, i.e., when we call the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2360.1">logWithLabel</span></code><span class="koboSpan" id="kobo.2361.1"> function (let’s call it </span><code class="inlineCode"><span class="koboSpan" id="kobo.2362.1">function A</span></code><span class="koboSpan" id="kobo.2363.1">), it returns a function (let’s call it </span><code class="inlineCode"><span class="koboSpan" id="kobo.2364.1">function B</span></code><span class="koboSpan" id="kobo.2365.1">) from within. </span><span class="koboSpan" id="kobo.2365.2">The returned function (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2366.1">B</span></code><span class="koboSpan" id="kobo.2367.1">) is what RxJS calls with the observable stream when we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2368.1">logWithLabel</span></code><span class="koboSpan" id="kobo.2369.1"> method inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2370.1">pipe</span></code><span class="koboSpan" id="kobo.2371.1"> function of the stream. </span><span class="koboSpan" id="kobo.2371.2">Inside </span><code class="inlineCode"><span class="koboSpan" id="kobo.2372.1">function B</span></code><span class="koboSpan" id="kobo.2373.1">, we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2374.1">tap</span></code><span class="koboSpan" id="kobo.2375.1"> operator from RxJS to intercept the source observable and to log the values on the console using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2376.1">label</span></code><span class="koboSpan" id="kobo.2377.1"> provided.</span></p>
<h2 class="heading-2" id="_idParaDest-194"><span class="koboSpan" id="kobo.2378.1">See also</span></h2>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2379.1">tap</span></code><span class="koboSpan" id="kobo.2380.1"> operator documentation (</span><a href="https://rxjs.dev/api/operators/tap"><span class="url"><span class="koboSpan" id="kobo.2381.1">https://rxjs.dev/api/operators/tap</span></span></a><span class="koboSpan" id="kobo.2382.1">)</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2383.1">Observable</span></code><span class="koboSpan" id="kobo.2384.1"> documentation (</span><a href="https://rxjs.dev/guide/observable"><span class="url"><span class="koboSpan" id="kobo.2385.1">https://rxjs.dev/guide/observable</span></span></a><span class="koboSpan" id="kobo.2386.1">)</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-195"><span class="koboSpan" id="kobo.2387.1">Retrying failed HTTP calls with RxJS</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2388.1">In this recipe, you’re </span><a id="_idIndexMarker340"/><span class="koboSpan" id="kobo.2389.1">going to learn how to retry HTTP calls smartly with RxJS operators. </span><span class="koboSpan" id="kobo.2389.2">We’re going to use a technique </span><a id="_idIndexMarker341"/><span class="koboSpan" id="kobo.2390.1">called the </span><strong class="keyWord"><span class="koboSpan" id="kobo.2391.1">exponential backoff</span></strong><span class="koboSpan" id="kobo.2392.1"> technique. </span><span class="koboSpan" id="kobo.2392.2">This means that we retry the HTTP calls but with each next call having a delay more than the previous time for the attempt, and we stop after several maximum tries. </span><span class="koboSpan" id="kobo.2392.3">Sounds exciting? </span><span class="koboSpan" id="kobo.2392.4">Let’s get into it.</span></p>
<h2 class="heading-2" id="_idParaDest-196"><span class="koboSpan" id="kobo.2393.1">Getting ready</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2394.1">The app that we are going to work with resides in </span><code class="inlineCode"><span class="koboSpan" id="kobo.2395.1">start/apps/chapter05/rx-retry-http-calls</span></code><span class="koboSpan" id="kobo.2396.1"> inside the cloned repository:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2397.1">Open the code repository in your code editor.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2398.1">Open the terminal, navigate to the code repository directory, and run the following command to serve the project with the backend server:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2399.1">npm run serve rx-retry-http-calls with-server
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2400.1">This should open the app in a new browser tab, and you should see the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2401.1"><img alt="" role="presentation" src="../Images/B18469_05_14.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2402.1">Figure 5.14: The rx-retry-http-calls running on http://localhost.4200</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2403.1">Let’s jump into the recipe steps in the next section.</span></p>
<h2 class="heading-2" id="_idParaDest-197"><span class="koboSpan" id="kobo.2404.1">How to do it…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2405.1">We’re going </span><a id="_idIndexMarker342"/><span class="koboSpan" id="kobo.2406.1">to create a custom RxJS operator named </span><code class="inlineCode"><span class="koboSpan" id="kobo.2407.1">backoff</span></code><span class="koboSpan" id="kobo.2408.1"> that will retry the HTTP calls for us</span><a id="_idIndexMarker343"/><span class="koboSpan" id="kobo.2409.1"> with the exponential </span><code class="inlineCode"><span class="koboSpan" id="kobo.2410.1">backoff</span></code><span class="koboSpan" id="kobo.2411.1"> strategy.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2412.1">Create a new file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2413.1">app</span></code><span class="koboSpan" id="kobo.2414.1"> folder and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.2415.1">retry-backoff.ts</span></code><span class="koboSpan" id="kobo.2416.1">. </span><span class="koboSpan" id="kobo.2416.2">Then add the following code inside the file:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2417.1">import</span></span><span class="koboSpan" id="kobo.2418.1"> { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2419.1">of</span></span><span class="koboSpan" id="kobo.2420.1">, pipe, throwError } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2421.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2422.1">'rxjs'</span></span><span class="koboSpan" id="kobo.2423.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2424.1">import</span></span><span class="koboSpan" id="kobo.2425.1"> { retry } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2426.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2427.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2428.1">rxjs/operators'</span></span><span class="koboSpan" id="kobo.2429.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2430.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2431.1">function</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2432.1">retryBackoff</span></span><span class="koboSpan" id="kobo.2433.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2434.1">maxTries: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2435.1">number</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2436.1">, delay: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2437.1">number</span></span><span class="koboSpan" id="kobo.2438.1">) {
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2439.1">return</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2440.1">pipe</span></span><span class="koboSpan" id="kobo.2441.1">(
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2442.1">retry</span></span><span class="koboSpan" id="kobo.2443.1">({
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2444.1">delay</span></span><span class="koboSpan" id="kobo.2445.1">: </span><span class="hljs-function"><span class="koboSpan" id="kobo.2446.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2447.1">error, retryCount</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2448.1">) =&gt;</span></span><span class="koboSpan" id="kobo.2449.1"> {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2450.1">return</span></span><span class="koboSpan" id="kobo.2451.1"> retryCount &gt; maxTries ? </span><span class="hljs-title"><span class="koboSpan" id="kobo.2452.1">throwError</span></span><span class="koboSpan" id="kobo.2453.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.2454.1">() =&gt;</span></span><span class="koboSpan" id="kobo.2455.1">
          error) : </span><span class="hljs-title"><span class="koboSpan" id="kobo.2456.1">of</span></span><span class="koboSpan" id="kobo.2457.1">(retryCount);
      },
    })
  );
}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.2458.1">Now let’s use this operator in </span><code class="inlineCode"><span class="koboSpan" id="kobo.2459.1">app.component.ts</span></code><span class="koboSpan" id="kobo.2460.1"> to retry the HTTP calls. </span><span class="koboSpan" id="kobo.2460.2">Update the file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2461.1">...
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2462.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2463.1"> { retryBackoff } </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2464.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2465.1">'./retry-backoff'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2466.1">;</span></strong></span><span class="koboSpan" id="kobo.2467.1">
...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2468.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2469.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2470.1">AppComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2471.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2472.1">OnInit</span></span><span class="koboSpan" id="kobo.2473.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.2474.1">ngOnInit</span></span><span class="koboSpan" id="kobo.2475.1">(): </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2476.1">void</span></span><span class="koboSpan" id="kobo.2477.1"> {
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.2478.1">this</span></span><span class="koboSpan" id="kobo.2479.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2480.1">isMakingHttpCall</span></span><span class="koboSpan" id="kobo.2481.1"> = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2482.1">true</span></span><span class="koboSpan" id="kobo.2483.1">;
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.2484.1">this</span></span><span class="koboSpan" id="kobo.2485.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2486.1">http</span></span><span class="koboSpan" id="kobo.2487.1">
      .</span><span class="hljs-title"><span class="koboSpan" id="kobo.2488.1">get</span></span><span class="koboSpan" id="kobo.2489.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2490.1">'http://localhost:3333/api/bad-request'</span></span><span class="koboSpan" id="kobo.2491.1">)
      .</span><span class="hljs-title"><span class="koboSpan" id="kobo.2492.1">pipe</span></span><span class="koboSpan" id="kobo.2493.1">(
        </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2494.1">retryBackoff</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2495.1">(</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.2496.1">3</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2497.1">, </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.2498.1">300</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2499.1">),</span></strong></span>
<span class="hljs-title"><span class="koboSpan" id="kobo.2500.1">catchError</span></span><span class="koboSpan" id="kobo.2501.1">(...)
      )
      .</span><span class="hljs-title"><span class="koboSpan" id="kobo.2502.1">subscribe</span></span><span class="koboSpan" id="kobo.2503.1">(...);
  }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2504.1">If you refresh the app, you’ll notice that now we retry the HTTP calls. </span><span class="koboSpan" id="kobo.2504.2">But all of the retries are done instantly (notice the </span><strong class="screenText"><span class="koboSpan" id="kobo.2505.1">Waterfall</span></strong><span class="koboSpan" id="kobo.2506.1"> column), as shown in </span><em class="italic"><span class="koboSpan" id="kobo.2507.1">Figure 5.15</span></em><span class="koboSpan" id="kobo.2508.1">. </span><span class="koboSpan" id="kobo.2508.2">We don’t want that. </span><span class="koboSpan" id="kobo.2508.3">We want every next try to be done with an increasing delay.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2509.1"><img alt="" role="presentation" src="../Images/B18469_05_15.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2510.1">Figure 5.15: Retrying HTTP calls multiple times instantly</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.2511.1">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2512.1">retry-backoff.ts</span></code><span class="koboSpan" id="kobo.2513.1"> file to add a delay using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2514.1">timer</span></code><span class="koboSpan" id="kobo.2515.1"> operator and some </span><a id="_idIndexMarker344"/><span class="koboSpan" id="kobo.2516.1">calculations, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2517.1">import</span></span><span class="koboSpan" id="kobo.2518.1"> { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2519.1">of</span></span><span class="koboSpan" id="kobo.2520.1">, pipe, throwError, </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2521.1">timer</span></strong></span><span class="koboSpan" id="kobo.2522.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2523.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2524.1">'rxjs'</span></span><span class="koboSpan" id="kobo.2525.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2526.1">import</span></span><span class="koboSpan" id="kobo.2527.1"> { </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2528.1">map, mergeMap</span></strong></span><span class="koboSpan" id="kobo.2529.1">, retry } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2530.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2531.1">'rxjs/operators'</span></span><span class="koboSpan" id="kobo.2532.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2533.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2534.1">function</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2535.1">retryBackoff</span></span><span class="koboSpan" id="kobo.2536.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2537.1">maxTries: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2538.1">number</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2539.1">, delay: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2540.1">number</span></span><span class="koboSpan" id="kobo.2541.1">) {
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2542.1">return</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2543.1">pipe</span></span><span class="koboSpan" id="kobo.2544.1">(
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2545.1">retry</span></span><span class="koboSpan" id="kobo.2546.1">({
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2547.1">delay</span></span><span class="koboSpan" id="kobo.2548.1">: </span><span class="hljs-function"><span class="koboSpan" id="kobo.2549.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2550.1">error, retryCount</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2551.1">) =&gt;</span></span><span class="koboSpan" id="kobo.2552.1"> {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2553.1">return</span></span><span class="koboSpan" id="kobo.2554.1"> (
          retryCount &gt; maxTries ? </span><span class="hljs-title"><span class="koboSpan" id="kobo.2555.1">throwError</span></span><span class="koboSpan" id="kobo.2556.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.2557.1">() =&gt;</span></span><span class="koboSpan" id="kobo.2558.1"> error) :
            </span><span class="hljs-title"><span class="koboSpan" id="kobo.2559.1">of</span></span><span class="koboSpan" id="kobo.2560.1">(retryCount)
        )</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2561.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2562.1">pipe</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2563.1">(</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2564.1">map</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2565.1">(</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.2566.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.2567.1">count</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.2568.1">) =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2569.1"> count * count),</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2570.1">mergeMap</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2571.1">(</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.2572.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.2573.1">countSq</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.2574.1">) =&gt;</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2575.1">timer</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2576.1">(countSq * delay))</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2577.1">);</span></strong></span><span class="koboSpan" id="kobo.2578.1">
      },
    })
  );
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2579.1">And that’s it! </span><span class="koboSpan" id="kobo.2579.2">If you refresh the app, you’ll see that every next retry of the HTTP call </span><a id="_idIndexMarker345"/><span class="koboSpan" id="kobo.2580.1">has an increased delay compared to the previous one. </span><span class="koboSpan" id="kobo.2580.2">Notice how far off the last HTTP call is in the </span><strong class="screenText"><span class="koboSpan" id="kobo.2581.1">Waterfall</span></strong><span class="koboSpan" id="kobo.2582.1"> column (it is on the right edge of </span><em class="italic"><span class="koboSpan" id="kobo.2583.1">Figure 5.16</span></em><span class="koboSpan" id="kobo.2584.1">):</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2585.1"><img alt="" role="presentation" src="../Images/B18469_05_16.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2586.1">Figure 5.16: Retrying HTTP calls with exponential backoff</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2587.1">See the next section to understand how it all works.</span></p>
<h2 class="heading-2" id="_idParaDest-198"><span class="koboSpan" id="kobo.2588.1">How it works…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2589.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2590.1">retry</span></code><span class="koboSpan" id="kobo.2591.1"> operator </span><a id="_idIndexMarker346"/><span class="koboSpan" id="kobo.2592.1">has two overloads (at the time of writing this book). </span><span class="koboSpan" id="kobo.2592.2">One of them takes </span><code class="inlineCode"><span class="koboSpan" id="kobo.2593.1">number</span></code><span class="koboSpan" id="kobo.2594.1"> and RxJS will just have the observable retried the number of times equal to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2595.1">number</span></code><span class="koboSpan" id="kobo.2596.1"> (until it throws an exception). </span><span class="koboSpan" id="kobo.2596.2">The other overload is that it takes a configuration object. </span><span class="koboSpan" id="kobo.2596.3">In the configuration object, we’re using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2597.1">delay</span></code><span class="koboSpan" id="kobo.2598.1"> function to handle our logic. </span><span class="koboSpan" id="kobo.2598.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2599.1">delay</span></code><span class="koboSpan" id="kobo.2600.1"> function receives </span><code class="inlineCode"><span class="koboSpan" id="kobo.2601.1">error</span></code><span class="koboSpan" id="kobo.2602.1"> and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2603.1">retryCount</span></code><span class="koboSpan" id="kobo.2604.1"> from RxJS, which we use to throw the error if we have already done our maximum tries or to pass forward </span><code class="inlineCode"><span class="koboSpan" id="kobo.2605.1">retryCount</span></code><span class="koboSpan" id="kobo.2606.1">. </span><span class="koboSpan" id="kobo.2606.2">We get the maximum number of tries from our </span><code class="inlineCode"><span class="koboSpan" id="kobo.2607.1">retryBackoff</span></code><span class="koboSpan" id="kobo.2608.1"> function’s arguments. </span><span class="koboSpan" id="kobo.2608.2">Finally, we make the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2609.1">map</span></code><span class="koboSpan" id="kobo.2610.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2611.1">mergeMap</span></code><span class="koboSpan" id="kobo.2612.1"> opeartors work with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2613.1">delay</span></code><span class="koboSpan" id="kobo.2614.1">. </span><span class="koboSpan" id="kobo.2614.2">Using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2615.1">map</span></code><span class="koboSpan" id="kobo.2616.1"> operator, we take a square of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2617.1">retryCount</span></code><span class="koboSpan" id="kobo.2618.1"> variable’s value. </span><span class="koboSpan" id="kobo.2618.2">And then, in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2619.1">mergeMap</span></code><span class="koboSpan" id="kobo.2620.1"> operator, we multiply the square value with the delay provided to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2621.1">retryBackoff</span></code><span class="koboSpan" id="kobo.2622.1"> function. </span><span class="koboSpan" id="kobo.2622.2">As a result, every next request takes the delay equal to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2623.1">((retryCount * retryCount) * delay)</span></code><span class="koboSpan" id="kobo.2624.1">. </span><span class="koboSpan" id="kobo.2624.2">Notice that we’re using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2625.1">timer</span></code><span class="koboSpan" id="kobo.2626.1"> function to have RxJS wait before it can retry the HTTP call again.</span></p>
<h2 class="heading-2" id="_idParaDest-199"><span class="koboSpan" id="kobo.2627.1">See also</span></h2>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.2628.1">RxJS custom operators</span></strong><span class="koboSpan" id="kobo.2629.1"> (</span><a href="https://indepth.dev/posts/1421/rxjs-custom-operators"><span class="url"><span class="koboSpan" id="kobo.2630.1">https://indepth.dev/posts/1421/rxjs-custom-operators</span></span></a><span class="koboSpan" id="kobo.2631.1">)</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.2632.1">Exponential backoff</span></strong><span class="koboSpan" id="kobo.2633.1"> documentation (</span><a href="https://angular.io/guide/practical-observable-usage#exponential-backoff"><span class="url"><span class="koboSpan" id="kobo.2634.1">https://angular.io/guide/practical-observable-usage#exponential-backoff</span></span></a><span class="koboSpan" id="kobo.2635.1">)</span></li>
</ul>
<h1 class="heading-1"><span class="koboSpan" id="kobo.2636.1">Learn more on Discord</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2637.1">To join the Discord community for this book – where you can share feedback, ask questions to the author, and learn about new releases – follow the QR code below:</span></p>
<p class="normal"><a href="Chapter_5.xhtml"><span class="url"><span class="koboSpan" id="kobo.2638.1">https://packt.link/AngularCookbook2e</span></span></a></p>
<p class="normal"><span class="koboSpan" id="kobo.2639.1"><img alt="" role="presentation" src="../Images/QR_Code1388317275422265.png"/></span></p>
</div>
</body></html>