<html><head></head><body>
  <div id="_idContainer406" class="Basic-Text-Frame">
    <h1 class="chapterNumber">8</h1>
    <h1 id="_idParaDest-241" class="chapterTitle">Recipes – Reusability, Forms, and Caching</h1>
    <p class="normal">In the next two chapters, we will complete most of the implementation of LemonMart and round out our coverage of the router-first approach. In this chapter, I will reinforce the idea of a decoupled component architecture by creating a <em class="italic">reusable</em> and <em class="italic">routable</em> component<a id="_idIndexMarker763"/> that supports data binding. We will use <strong class="keyWord">Angular directives</strong> to reduce boilerplate code and leverage classes, interfaces, enums, validators, and pipes to maximize code reuse with TypeScript and ES features.</p>
    <p class="normal">In addition, we will create a <strong class="keyWord">multi-step form</strong> that architecturally scales<a id="_idIndexMarker764"/> well and supports a responsive design. Then, we will differentiate<a id="_idIndexMarker765"/> between user controls and components by introducing a <strong class="keyWord">lemon rater</strong> and a reusable form part that encapsulates the name object.</p>
    <p class="normal">This chapter covers a lot of ground. It is organized in a recipe format, so you can quickly refer to a particular implementation when working on your projects. I will cover the implementations’ architecture, design, and major components. I will highlight important pieces of code to explain how the solution comes together. Leveraging what you’ve learned so far, I expect you to fill in routine implementation and configuration details. However, you can always refer to the GitHub project if you are stuck.</p>
    <p class="normal">In this chapter, you will learn about the following topics:</p>
    <ul>
      <li class="bulletList">Implementing CRUD services with caching</li>
      <li class="bulletList">Multi-step responsive forms</li>
      <li class="bulletList">Reusing repeating template behavior with directives</li>
      <li class="bulletList">Calculated properties and DatePicker</li>
      <li class="bulletList">Typeahead support</li>
      <li class="bulletList">Dynamic form arrays</li>
      <li class="bulletList">Creating shared components</li>
      <li class="bulletList">Reviewing and saving form data</li>
      <li class="bulletList">Scalable form architecture with reusable parts</li>
      <li class="bulletList">Input masking</li>
      <li class="bulletList">Custom controls with <code class="inlineCode">ControlValueAccessor</code></li>
      <li class="bulletList">Layouts using a grid list</li>
      <li class="bulletList">Restoring cached data</li>
    </ul>
    <h1 id="_idParaDest-242" class="heading-1">Technical requirements</h1>
    <p class="normal">The most up-to-date versions of the sample code for the book are on GitHub at the repository linked in the following steps. The repository contains the final and completed state of the code. You can verify your progress at the end of this chapter by looking at the end-of-chapter snapshot of the code under the <code class="inlineCode">projects</code> folder.</p>
    <p class="normal">For <em class="italic">Chapter 8</em>:</p>
    <div class="note">
      <p class="normal">Be sure that <strong class="keyWord">lemon-mart-server</strong> is up and running. Refer to <em class="chapterRef">Chapter 7</em>, <em class="italic">Working with REST and GraphQL APIs</em>.</p>
    </div>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Clone the repo at <a href="https://github.com/duluca/lemon-mart"><span class="url">https://github.com/duluca/lemon-mart</span></a>.</li>
      <li class="numberedList">Execute <code class="inlineCode">npm install</code> in the root folder to install the dependencies.</li>
      <li class="numberedList">The beginning state of the project is reflected at:
        <pre class="programlisting con"><code class="hljs-con">projects/stage10
</code></pre>
      </li>
      <li class="numberedList">The end state of the project is reflected at:
        <pre class="programlisting con"><code class="hljs-con">projects/stage11
</code></pre>
      </li>
      <li class="numberedList">Add the stage name to any <code class="inlineCode">ng</code> command to act only on that stage:
        <pre class="programlisting con"><code class="hljs-con">npx ng build stage11
</code></pre>
      </li>
    </ol>
    <div class="packt_tip">
      <p class="normal">Note that the <code class="inlineCode">dist/stage11</code> folder at the root of the repository will contain the compiled result.</p>
    </div>
    <div class="note">
      <p class="normal">Beware that the source code provided in the book and the version on GitHub will likely differ. The ecosystem around these projects is ever-evolving. Between changes to how Angular CLI generates new code, bug fixes, new versions of libraries, or side-by-side implementations of multiple techniques, there’s a lot of variation impossible to account for. If you find errors or have questions, please create an issue or submit a pull request on GitHub.</p>
    </div>
    <p class="normal">Let’s start with implementing a user service to retrieve data and build a form to display and edit profile information. Later, we will refactor this form to abstract out its reusable parts.</p>
    <h1 id="_idParaDest-243" class="heading-1">Implementing CRUD services with caching</h1>
    <p class="normal">We need a service that can perform CRUD operations<a id="_idIndexMarker766"/> on a user so that we can implement<a id="_idIndexMarker767"/> a user profile. However, the service must be robust enough to withstand common errors. After all, it is very bad UX when users unintentionally lose the data they typed. Form data can be reset due to circumstances outside of a user’s control, like a network or validation error, or user errors, like hitting the back or refresh button by mistake. We will create a user service leveraging the <code class="inlineCode">CacheService</code> we built in <em class="chapterRef">Chapter 5</em>, <em class="italic">Designing Authentication and Authorization</em>, so keep a copy of user data in <code class="inlineCode">localStorage</code> while the server processes it. The service will implement the following interface and, as always, reference the abstract <code class="inlineCode">IUser</code> interface over the concrete user implementation:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IUserService</span> {
  <span class="hljs-title">getUser</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">IUser</span>&gt;
  <span class="hljs-title">updateUser</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">user</span>: <span class="hljs-title">IUser</span>): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">IUser</span>&gt;
  <span class="hljs-title">getUsers</span>(
    <span class="hljs-attr">pageSize</span>: <span class="hljs-built_in">number</span>,
    <span class="hljs-attr">searchText</span>: <span class="hljs-built_in">string</span>,
    <span class="hljs-attr">pagesToSkip</span>: <span class="hljs-built_in">number</span>
  ): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">IUsers</span>&gt;
}
</code></pre>
    <div class="note">
      <p class="normal">Before creating<a id="_idIndexMarker768"/> the service, start <strong class="keyWord">lemon-mart-server</strong> and set your application’s <code class="inlineCode">AuthMode</code> to <code class="inlineCode">CustomServer</code>.</p>
      <p class="normal">You can use <code class="inlineCode">npm run start:backend</code> to start the database and the server.</p>
    </div>
    <p class="normal">In this section, we will implement<a id="_idIndexMarker769"/> the <code class="inlineCode">getUser</code> and <code class="inlineCode">updateUser</code> functions. We will<a id="_idIndexMarker770"/> implement <code class="inlineCode">getUsers</code> in <em class="chapterRef">Chapter 9</em>, <em class="italic">Recipes – Master/Detail, Data Tables, and NgRx</em>, to support pagination with a data table.</p>
    <p class="normal">Start by creating the user service:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Create a <code class="inlineCode">UserService</code> under <code class="inlineCode">src/app/user/user</code>.</li>
      <li class="numberedList">Declare the <code class="inlineCode">IUserService</code> interface from the preceding snippet, excluding the <code class="inlineCode">getUsers</code> function.</li>
      <li class="numberedList">Ensure the <code class="inlineCode">UserService</code> class implements <code class="inlineCode">IUserService</code>.</li>
      <li class="numberedList">Inject the <code class="inlineCode">CacheService</code>, <code class="inlineCode">HttpClient</code>, and <code class="inlineCode">AuthService</code>, as shown here:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/user/user.</strong><strong class="hljs-property-slc">service</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IUserService</span> {
  <span class="hljs-title">getUser</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">Iuser</span>&gt;
  <span class="hljs-title">updateUser</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">user</span>: <span class="hljs-title">Iuser</span>): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">Iuser</span>&gt;
}
<span class="hljs-meta">@Injectable</span>({
  <span class="hljs-attr">providedIn</span>: <span class="hljs-string">'root'</span>,
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IUserService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> cache = <span class="hljs-title">inject</span>(<span class="hljs-title">CacheService</span>)
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> httpClient = <span class="hljs-title">inject</span>(<span class="hljs-title">HttpClient</span>)
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> authService = <span class="hljs-title">inject</span>(<span class="hljs-title">AuthService</span>)
  <span class="hljs-title">getUser</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">IUser</span>&gt; {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title">Error</span>(<span class="hljs-string">'Method not implemented.'</span>)
  }
  <span class="hljs-title">updateUser</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">user</span>: <span class="hljs-title">IUser</span>): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">IUser</span>&gt; {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title">Error</span>(<span class="hljs-string">'Method not implemented.'</span>)
  }
}
</code></pre>
      </li>
      <li class="numberedList">Implement the <code class="inlineCode">getUser</code> function, as shown here:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/user/user.</strong><strong class="hljs-property-slc">service</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-title">getUser</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">IUser</span>&gt; {
  <span class="hljs-keyword">if</span> (id === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title">throwError</span>(<span class="hljs-string">'User id is not set'</span>)
  }
  <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-property">httpClient</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title">IUser</span>&gt;(
    <span class="hljs-string">`</span><span class="hljs-subst">${environment.baseUrl}</span><span class="hljs-string">/v2/user/</span><span class="hljs-subst">${id}</span><span class="hljs-string">`</span>
  )
}
</code></pre>
      </li>
    </ol>
    <p class="normal">We provide a <code class="inlineCode">getUser</code> function that can load any user’s profile information. Note that the security for this function is provided in the server implementation with the authenticate middleware. The requestor<a id="_idIndexMarker771"/> can either get their profile<a id="_idIndexMarker772"/> or will need to be a manager. We use <code class="inlineCode">getUser</code> with a resolve guard later in the chapter.</p>
    <h2 id="_idParaDest-244" class="heading-2">Updating the cache</h2>
    <p class="normal">Implement <code class="inlineCode">updateUser</code>, which accepts<a id="_idIndexMarker773"/> an object that implements the <code class="inlineCode">IUser</code> interface so that data can be sent to a PUT endpoint:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/user/user.</strong><strong class="hljs-property-slc">service</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
  <span class="hljs-title">updateUser</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">user</span>: <span class="hljs-title">IUser</span>): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">IUser</span>&gt; {
    <span class="hljs-keyword">if</span> (id === <span class="hljs-string">''</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title">throwError</span>(<span class="hljs-string">'User id is not set'</span>)
    }
    <span class="hljs-comment">// cache user data in case of errors</span>
    <span class="hljs-variable">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title">setItem</span>(<span class="hljs-string">'draft-user'</span>, <span class="hljs-title">Object</span>.<span class="hljs-title">assign</span>(user, { <span class="hljs-attr">_id</span>: id }))
    <span class="hljs-keyword">const</span> updateResponse$ = <span class="hljs-variable">this</span>.<span class="hljs-property">httpClient</span>
      .<span class="hljs-property">put</span>&lt;<span class="hljs-title">IUser</span>&gt;(<span class="hljs-string">`</span><span class="hljs-subst">${environment.baseUrl}</span><span class="hljs-string">/v2/user/</span><span class="hljs-subst">${id}</span><span class="hljs-string">`</span>, user)
      .<span class="hljs-title">pipe</span>(<span class="hljs-title">map</span>(<span class="hljs-title">User</span>.<span class="hljs-property">Build</span>), <span class="hljs-title">catchError</span>(transformError))
    updateResponse$.<span class="hljs-title">subscribe</span>(
      <span class="hljs-function">(</span><span class="hljs-params">res</span><span class="hljs-function">) =&gt;</span> {
        <span class="hljs-variable">this</span>.<span class="hljs-property">authService</span>.<span class="hljs-property">currentUser$</span>.<span class="hljs-title">next</span>(res)
        <span class="hljs-variable">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title">removeItem</span>(<span class="hljs-string">'draft-user'</span>)
      },
      <span class="hljs-function">(</span><span class="hljs-params">err</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">throwError</span>(err)
    )
    <span class="hljs-keyword">return</span> updateResponse$
  }
</code></pre>
    <p class="normal">Note how the cache service is used with <code class="inlineCode">setItem</code> to save user-entered data if the <code class="inlineCode">put</code> call fails. When the call succeeds, we remove the cached data using <code class="inlineCode">removeItem</code>. Also, note how we hydrate a user returned from the server as a <code class="inlineCode">User</code> object with <code class="inlineCode">map(User.Build)</code>, which calls the constructor of <code class="inlineCode">class User</code>.</p>
    <p class="normal">Hydrate is a common term for populating an object with data from a database or a network request. For example, the <code class="inlineCode">User</code> JSON object we pass between components or receive from the server fits the <code class="inlineCode">IUser</code> interface but is not the <code class="inlineCode">class User</code> type. We serialize objects to JSON using the <code class="inlineCode">toJSON</code> method. When we hydrate and instantiate a new object from JSON, we reverse<a id="_idIndexMarker774"/> and deserialize the data.</p>
    <div class="note">
      <p class="normal">It is important to highlight that you should always stick to interfaces, not concrete implementations like <code class="inlineCode">User</code> when passing data around. This is the <strong class="keyWord">D</strong> in <strong class="keyWord">SOLID</strong> – the <strong class="keyWord">Dependency Inversion Principle</strong>. Referencing concrete implementations<a id="_idIndexMarker775"/> like <code class="inlineCode">User</code> creates a lot of risk because they change a lot, whereas an abstraction such as <code class="inlineCode">IUser</code> will seldom change. After all, you wouldn’t solder a lamp directly to the electrical wiring in the wall. Instead, you solder the lamp to a plug and then use the plug to get the electricity you need.</p>
    </div>
    <p class="normal">With this code completed, <code class="inlineCode">UserService</code> can now be used for basic CRUD operations.</p>
    <h1 id="_idParaDest-245" class="heading-1">Multi-step responsive forms</h1>
    <p class="normal">Overall, forms are a different<a id="_idIndexMarker776"/> beast than the rest of your application, and they require special architectural considerations. I don’t recommend over-engineering your form solution with dynamic templates or route-enabled components. By definition, the different parts of a form are tightly coupled. From the perspectives of maintainability and ease of implementation, creating one giant component is a better strategy than using some of the aforementioned strategies and over-engineering.</p>
    <p class="normal">We will implement a multi-step input form to capture user profile information in a single component. I will be covering my recommended technique to split forms up into multiple components later in the chapter, in the <em class="italic">Reusable form parts and scalability</em> section.</p>
    <div class="note">
      <p class="normal">Since the implementation of the form changes dramatically between this section and later in the chapter, you can find the code for the initial version on GitHub at <code class="inlineCode">projects/stage11/src/app/user/profile/profile.initial.component.ts</code> and <code class="inlineCode">projects/stage11/src/app/user/profile/profile.initial.component.html</code>.</p>
    </div>
    <p class="normal">We will also make this multi-step form responsive<a id="_idIndexMarker777"/> for mobile devices using media queries:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Let’s start by adding some helper data that will help us display an input form with options:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/data.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IUSState</span> {
  <span class="hljs-attr">code</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title">USStateFilter</span>(<span class="hljs-attr">value</span><span class="hljs-params">: </span><span class="hljs-built_in">string</span>): <span class="hljs-title">IUSState</span>[] {
  <span class="hljs-keyword">return</span> <span class="hljs-title">USStates</span>.<span class="hljs-title">filter</span>(<span class="hljs-function">(</span><span class="hljs-params">state</span><span class="hljs-function">) =&gt;</span> {
    <span class="hljs-keyword">return</span> (
      (state.<span class="hljs-property">code</span>.<span class="hljs-property">length</span> === <span class="hljs-number">2</span> &amp;&amp; 
       state.<span class="hljs-property">code</span>.<span class="hljs-title">toLowerCase</span>() === value.<span class="hljs-title">toLowerCase</span>()) ||
       state.<span class="hljs-property">name</span>.<span class="hljs-title">toLowerCase</span>().<span class="hljs-title">indexOf</span>(value.<span class="hljs-title">toLowerCase</span>()) === <span class="hljs-number">0</span>
    )
  })
}
<span class="hljs-keyword">const</span> <span class="hljs-title">USStates</span> = [
  { <span class="hljs-attr">code</span>: <span class="hljs-string">'AK'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Alaska'</span> },
  { <span class="hljs-attr">code</span>: <span class="hljs-string">'AL'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Alabama'</span> },
  ...
  { <span class="hljs-attr">code</span>: <span class="hljs-string">'WY'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Wyoming'</span> },
]
</code></pre>
      </li>
      <li class="numberedList">Add new validation rules to <code class="inlineCode">common/validations.ts</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/common/validations.</strong><strong class="hljs-property-slc">ts</strong></span>
...
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title">OptionalTextValidation</span> = [
  <span class="hljs-title">Validators</span>.<span class="hljs-title">minLength</span>(<span class="hljs-number">2</span>), 
  <span class="hljs-title">Validators</span>.<span class="hljs-title">maxLength</span>(<span class="hljs-number">50</span>)
]
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title">RequiredTextValidation</span> = 
  <span class="hljs-title">OptionalTextValidation</span>.<span class="hljs-title">concat</span>([<span class="hljs-title">Validators</span>.<span class="hljs-property">required</span>])
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title">OneCharValidation</span> = [
  <span class="hljs-title">Validators</span>.<span class="hljs-title">minLength</span>(<span class="hljs-number">1</span>), 
  <span class="hljs-title">Validators</span>.<span class="hljs-title">maxLength</span>(<span class="hljs-number">1</span>)
] 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title">USAZipCodeValidation</span> = [ 
  <span class="hljs-title">Validators</span>.<span class="hljs-property">required</span>, 
  <span class="hljs-title">Validators</span>.<span class="hljs-title">pattern</span>(<span class="hljs-regexp">/^\d{5}(?:[-\s]\d{4})?$/</span>),
]
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title">USAPhoneNumberValidation</span> = [ 
  <span class="hljs-title">Validators</span>.<span class="hljs-property">required</span>, 
  <span class="hljs-title">Validators</span>.<span class="hljs-title">pattern</span>(<span class="hljs-regexp">/^\D?(\d{3})\D?\D?(\d{3})\D?(\d{4})$/</span>), 
]
</code></pre>
      </li>
      <li class="numberedList">Now, implement <code class="inlineCode">profile.component.ts</code> as<a id="_idIndexMarker778"/> follows:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Role</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../auth/auth.enum'</span> 
<span class="hljs-keyword">import</span> { <span class="hljs-title">$enum</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'</span><span class="hljs-string">ts-enum-util'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">IName</span>, <span class="hljs-title">IPhone</span>, <span class="hljs-title">IUser</span>, <span class="hljs-title">PhoneType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../user/user'</span>
...
@<span class="hljs-title">Component</span>({ 
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-profile'</span>, 
  <span class="hljs-attr">templateUrl</span>: <span class="hljs-string">'./profile.component.html'</span>, 
  <span class="hljs-attr">styleUrls</span>: [<span class="hljs-string">'./profile.component.css'</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProfileComponent</span> implements <span class="hljs-title">OnInit</span> { 
  <span class="hljs-title">Role</span> = <span class="hljs-title">Role</span> 
  <span class="hljs-title">PhoneType</span> = <span class="hljs-title">PhoneType</span> 
  <span class="hljs-title">PhoneTypes</span> = $enum(<span class="hljs-title">PhoneType</span>).<span class="hljs-title">getKeys</span>() 
  <span class="hljs-attr">formGroup</span>: <span class="hljs-title">FormGroup</span> 
  <span class="hljs-attr">states$</span>: <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">IUSState</span>[]&gt; 
  userError = <span class="hljs-string">''</span> 
  <span class="hljs-attr">currentUserId</span>: string 
  <span class="hljs-title">constructor</span>(<span class="hljs-params"> </span>
<span class="hljs-params">    private formBuilder: FormBuilder, </span>
<span class="hljs-params">    private uiService: UiService, </span>
<span class="hljs-params">    private userService: UserService, </span>
<span class="hljs-params">    private authService: AuthService</span>
<span class="hljs-params">  </span>) {}
  private destroyRef = <span class="hljs-title">inject</span>(<span class="hljs-title">DestroyRef</span>)
  <span class="hljs-title">ngOnInit</span>() { 
    <span class="hljs-variable">this</span>.<span class="hljs-title">buildForm</span>() 
    <span class="hljs-variable">this</span>.<span class="hljs-property">authService</span>.<span class="hljs-property">currentUser$</span>.<span class="hljs-title">pipe</span>(
      <span class="hljs-title">filter</span>(<span class="hljs-function">(</span><span class="hljs-params">user</span><span class="hljs-function">) =&gt;</span> user !== <span class="hljs-literal">null</span>), 
      <span class="hljs-title">tap</span>(<span class="hljs-function">(</span><span class="hljs-params">user</span><span class="hljs-function">) =&gt;</span> { 
        <span class="hljs-variable">this</span>.<span class="hljs-property">currentUserId</span> = user.<span class="hljs-property">_id</span> 
        <span class="hljs-variable">this</span>.<span class="hljs-title">buildForm</span>(user) 
      }),
      <span class="hljs-title">takeUntilDestroyed</span>(<span class="hljs-variable">this</span>.<span class="hljs-property">destroyRef</span>) 
    ).<span class="hljs-title">subscribe</span>()
  }
  private <span class="hljs-keyword">get</span> <span class="hljs-title">currentUserRole</span>() { 
    <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-property">authService</span>.<span class="hljs-property">authStatus$</span>.<span class="hljs-property">value</span>.<span class="hljs-property">userRole</span> 
  }
  <span class="hljs-title">buildForm</span>(<span class="hljs-params">user?: IUser</span>) {}
  ...
}
</code></pre>
      </li>
    </ol>
    <p class="normal">Upon load, we request the current user from <code class="inlineCode">authService</code>, but this might take a while, so we first build an empty form with <code class="inlineCode">this.buildForm()</code> as the first statement. We also store the user’s ID in the <code class="inlineCode">currentUserId</code> property, which we will need later when implementing the <code class="inlineCode">save</code> functionality.</p>
    <div class="packt_tip">
      <p class="normal">Note that we filter out <code class="inlineCode">null</code> or <code class="inlineCode">undefined</code> users so that we don’t try to build the form in an invalid state.</p>
    </div>
    <p class="normal">The implementation above introduces a UX issue in the case where <code class="inlineCode">authService.currentUser$</code> is retrieved from an API. If the API takes over half a second (really, 340 ms) to return the data, there’ll be a noticeable pop-up of new information on the form. This will overwrite any text the user may have already entered.</p>
    <p class="normal">To prevent this, we could disable and reenable the form once the information is received. However, this component isn’t aware of where the information comes from; it merely subscribes to <code class="inlineCode">authService.currentUser$</code>, which may or may not ever return a value. Even if we could reliably tell that we are receiving data from an API, we would have to implement a bespoke solution in every component. </p>
    <p class="normal">Using an <code class="inlineCode">HttpInterceptor</code>, we can globally detect when API calls are triggered and completed; we can expose a <code class="inlineCode">signal</code> where components can individually subscribe to display a loading spinner, or we can leverage the <code class="inlineCode">UiService</code> to launch a global loading<a id="_idIndexMarker779"/> spinner to block the UI while data is retrieved from the server. In <em class="chapterRef">Chapter 9</em>, <em class="italic">Recipes – Master/Detail, Data Tables, and NgRx</em>, I cover how to implement a global spinner.</p>
    <div class="packt_tip">
      <p class="normal">A global spinner<a id="_idIndexMarker780"/> is the ultimate 80–20 solution. However, you may find that a global spinner is a non-starter in large applications with dozens of components continuously retrieving data. Complex UI requires expensive UX solutions. In this case, you will indeed want to implement a component-level spinner. This is demonstrated in the <em class="italic">Data tables with pagination</em> section of <em class="chapterRef">Chapter 9</em>, <em class="italic">Recipes – Master/Detail, Data Tables, and NgRx</em>.</p>
    </div>
    <p class="normal">Later in this chapter, we will implement a resolve guard to load a user based on their <code class="inlineCode">userId</code>, provided on a route to increase the reusability of this component.</p>
    <h2 id="_idParaDest-246" class="heading-2">Form controls and form groups</h2>
    <p class="normal">As you may recall, <code class="inlineCode">FormControl</code> objects<a id="_idIndexMarker781"/> are the most elemental parts<a id="_idIndexMarker782"/> of a form, usually representing<a id="_idIndexMarker783"/> a single input<a id="_idIndexMarker784"/> field. We can use <code class="inlineCode">FormGroup</code> to group together a collection of related <code class="inlineCode">FormControl</code> objects, such as the individual first, middle, and last parts of a person’s name. <code class="inlineCode">FormGroup</code> objects can also group together a mix of <code class="inlineCode">FormControl</code>, <code class="inlineCode">FormGroup</code>, and <code class="inlineCode">FormArray</code> objects. The latter object allows us to have dynamically repeating elements. <code class="inlineCode">FormArray</code> is covered later in the chapter in the <em class="italic">Dynamic form arrays</em> section.</p>
    <p class="normal">Our form has many input fields, so we will use a <code class="inlineCode">FormGroup</code> created by <code class="inlineCode">this.formBuilder.group</code> to house our various <code class="inlineCode">FormControl</code> objects. Additionally, children <code class="inlineCode">FormGroup</code> objects will allow us to maintain the correct shape of the data structure.</p>
    <div class="note">
      <p class="normal">Since the implementation of the form changes dramatically between this section and later in the chapter, you can find the code for the initial version on GitHub at <code class="inlineCode">projects/stage11/src/app/user/profile/profile.initial.component.ts</code> and <code class="inlineCode">projects/stage11/src/app/user/profile/profile.initial.component.html</code>.</p>
    </div>
    <p class="normal">Start building the <code class="inlineCode">buildForm</code> function, as follows:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
  <span class="hljs-title">buildForm</span>(<span class="hljs-params">user?: </span><span class="hljs-title">IUser</span>) { 
    <span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span> =
    <span class="hljs-variable">this</span>.<span class="hljs-property">formBuilder</span>.<span class="hljs-title">group</span>({
      <span class="hljs-attr">email</span>: [
        {
          <span class="hljs-attr">value</span>: user?.<span class="hljs-property">email</span> || <span class="hljs-string">''</span>,
          <span class="hljs-attr">disabled</span>: <span class="hljs-variable">this</span>.<span class="hljs-property">currentUserRole</span> !== <span class="hljs-title">Role</span>.<span class="hljs-property">Manager</span>,
        },
        <span class="hljs-title">EmailValidation</span>,
      ],
      <span class="hljs-attr">name</span>: <span class="hljs-variable">this</span>.<span class="hljs-property">formBuilder</span>.<span class="hljs-title">group</span>({
        <span class="hljs-attr">first</span>: [user?.<span class="hljs-property">name</span>?.<span class="hljs-property">first</span> || <span class="hljs-string">''</span>, <span class="hljs-title">RequiredTextValidation</span>],
        <span class="hljs-attr">middle</span>: [user?.<span class="hljs-property">name</span>?.<span class="hljs-property">middle</span> || <span class="hljs-string">''</span>, <span class="hljs-title">OneCharValidation</span>],
        <span class="hljs-attr">last</span>: [user?.<span class="hljs-property">name</span>?.<span class="hljs-property">last</span> || <span class="hljs-string">''</span>, <span class="hljs-title">RequiredTextValidation</span>],
      }),
      <span class="hljs-attr">role</span>: [
        {
          <span class="hljs-attr">value</span>: user?.<span class="hljs-property">role</span> || <span class="hljs-string">''</span>,
          <span class="hljs-attr">disabled</span>: <span class="hljs-variable">this</span>.<span class="hljs-property">currentUserRole</span> !== <span class="hljs-title">Role</span>.<span class="hljs-property">Manager</span>,
        },
        [<span class="hljs-title">Validators</span>.<span class="hljs-property">required</span>],
      ],
      <span class="hljs-attr">dateOfBirth</span>: [user?.<span class="hljs-property">dateOfBirth</span> || <span class="hljs-string">''</span>, <span class="hljs-title">Validators</span>.<span class="hljs-property">required</span>], 
      <span class="hljs-attr">address</span>: <span class="hljs-variable">this</span>.<span class="hljs-property">formBuilder</span>.<span class="hljs-title">group</span>({
        <span class="hljs-attr">line1</span>: [user?.<span class="hljs-property">address</span>?.<span class="hljs-property">line1</span> || <span class="hljs-string">''</span>, <span class="hljs-title">RequiredTextValidation</span>],
        <span class="hljs-attr">line2</span>: [user?.<span class="hljs-property">address</span>?.<span class="hljs-property">line2</span> || <span class="hljs-string">''</span>, <span class="hljs-title">OptionalTextValidation</span>],
        <span class="hljs-attr">city</span>: [user?.<span class="hljs-property">address</span>?.<span class="hljs-property">city</span> || <span class="hljs-string">''</span>, <span class="hljs-title">RequiredTextValidation</span>],
        <span class="hljs-attr">state</span>: [user?.<span class="hljs-property">address</span>?.<span class="hljs-property">state</span> || <span class="hljs-string">''</span>, <span class="hljs-title">RequiredTextValidation</span>],
        <span class="hljs-attr">zip</span>: [user?.<span class="hljs-property">address</span>?.<span class="hljs-property">zip</span> || <span class="hljs-string">''</span>, <span class="hljs-title">USAZipCodeValidation</span>],
      }),
    })
  }
</code></pre>
    <p class="normal"><code class="inlineCode">buildForm</code> optionally accepts<a id="_idIndexMarker785"/> an <code class="inlineCode">IUser</code> to prefill<a id="_idIndexMarker786"/> the form. Otherwise, all fields<a id="_idIndexMarker787"/> are set to their default<a id="_idIndexMarker788"/> values. The <code class="inlineCode">formGroup</code> property itself is the top-level <code class="inlineCode">FormGroup</code>. Various <code class="inlineCode">FormControls</code> are added to it, such as <code class="inlineCode">email</code>, with validators attached to them as needed. </p>
    <p class="normal">Note how <code class="inlineCode">name</code> and <code class="inlineCode">address</code> are their own <code class="inlineCode">FormGroup</code> objects. This parent-child relationship ensures the proper structure of the form data, when serialized to JSON, which fits the structure of <code class="inlineCode">IUser</code> in a manner that the rest of our application and server-side code can utilize.</p>
    <p class="normal">You will complete the implementation<a id="_idIndexMarker789"/> of the <code class="inlineCode">formGroup</code> independently<a id="_idIndexMarker790"/> by following<a id="_idIndexMarker791"/> the sample code provided<a id="_idIndexMarker792"/> for the chapter. I will review sections of the code piece by piece over the next few sections to explain certain key capabilities.</p>
    <h2 id="_idParaDest-247" class="heading-2">Stepper and responsive layout</h2>
    <p class="normal">Angular Material’s stepper<a id="_idIndexMarker793"/> ships with the <code class="inlineCode">MatStepperModule</code>. The stepper <a id="_idIndexMarker794"/>allows form inputs to be broken<a id="_idIndexMarker795"/> up into multiple steps so that the user is not overwhelmed with processing<a id="_idIndexMarker796"/> dozens of input fields simultaneously. The user can still track their place in the process, and as a side effect, as the developer, we break up our <code class="inlineCode">&lt;form&gt;</code> implementation and enforce validation rules on a step-by-step basis, or create optional workflows where certain steps can be skipped or required. As with all Material user controls, the stepper has been designed with a responsive UX. In the next few sections, we will implement three steps covering different form-input techniques in the process:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Account information:<ul>
          <li class="bulletList">Input validation</li>
          <li class="bulletList">Responsive layout with media queries</li>
          <li class="bulletList">Calculated properties</li>
          <li class="bulletList"><code class="inlineCode">DatePicker</code></li>
        </ul>
      </li>
      <li class="numberedList">Contact information:<ul>
          <li class="bulletList">Typeahead support</li>
          <li class="bulletList">Dynamic form arrays</li>
        </ul>
      </li>
      <li class="numberedList">Review:<ul>
          <li class="bulletList">Read-only views</li>
          <li class="bulletList">Saving and clearing data</li>
        </ul>
      </li>
    </ol>
    <p class="normal">Let’s start by adding the Angular material dependencies:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Import the following Material modules in <code class="inlineCode">profile.component.ts</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-title">MatAutocompleteModule</span>,
<span class="hljs-title">MatButtonModule</span>,
<span class="hljs-title">MatDatepickerModule</span>,
<span class="hljs-title">MatFormFieldModule</span>,
<span class="hljs-title">MatIconModule</span>,
<span class="hljs-title">MatInputModule</span>,
<span class="hljs-title">MatListModule</span>,
<span class="hljs-title">MatNativeDateModule</span>,
<span class="hljs-title">MatOptionModule</span>,
<span class="hljs-title">MatRadioModule</span>,
<span class="hljs-title">MatSelectModule</span>,
<span class="hljs-title">MatStepperModule</span>,
<span class="hljs-title">MatToolbarModule</span>,
</code></pre>
      </li>
      <li class="numberedList">Import other supporting modules:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-title">FlexModule</span>,
<span class="hljs-title">ReactiveFormsModule</span>,
...
</code></pre>
      </li>
      <li class="numberedList">Implement a horizontal<a id="_idIndexMarker797"/> stepper with a form<a id="_idIndexMarker798"/> containing<a id="_idIndexMarker799"/> the first <a id="_idIndexMarker800"/>step:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.component.html</strong></span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">mat-toolbar</span><span class="hljs-tag"> </span><span class="hljs-attr">color</span><span class="hljs-tag">=</span><span class="hljs-string">"accent"</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">h5</span><span class="hljs-tag">&gt;</span>User Profile<span class="hljs-tag">&lt;/</span><span class="hljs-name">h5</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-toolbar</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">mat-horizontal-stepper</span><span class="hljs-tag"> #</span><span class="hljs-attr">stepper</span><span class="hljs-tag">=</span><span class="hljs-string">"matHorizontalStepper"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-step</span><span class="hljs-tag"> [</span><span class="hljs-attr">stepControl</span><span class="hljs-tag">]=</span><span class="hljs-string">"formGroup"</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">form</span><span class="hljs-tag"> [</span><span class="hljs-attr">formGroup</span><span class="hljs-tag">]=</span><span class="hljs-string">"formGroup"</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">ng-template</span><span class="hljs-tag"> </span><span class="hljs-attr">matStepLabel</span><span class="hljs-tag">&gt;</span>Account Information<span class="hljs-tag">&lt;/</span><span class="hljs-name">ng-template</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"</span><span class="hljs-string">stepContent"</span><span class="hljs-tag">&gt;</span>
        ...
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">form</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-step</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-horizontal-stepper</span><span class="hljs-tag">&gt;</span>
</code></pre>
      </li>
      <li class="numberedList">Now, start implementing the <code class="inlineCode">name</code> row of the <code class="inlineCode">Account Information</code> step in place of the ellipses in the preceding step:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.component.html</strong></span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayout</span><span class="hljs-tag">=</span><span class="hljs-string">"row"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayout.lt-sm</span><span class="hljs-tag">=</span><span class="hljs-string">"column"</span><span class="hljs-tag">   </span>
<span class="hljs-tag">     [</span><span class="hljs-attr">formGroup</span><span class="hljs-tag">]=</span><span class="hljs-string">"formGroup.get('name')"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayoutGap</span><span class="hljs-tag">=</span><span class="hljs-string">"10px"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag"> </span><span class="hljs-attr">appearance</span><span class="hljs-tag">=</span><span class="hljs-string">"outline"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlex</span><span class="hljs-tag">=</span><span class="hljs-string">"40%"</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span><span class="hljs-attr">matInput</span><span class="hljs-tag"> </span><span class="hljs-attr">placeholder</span><span class="hljs-tag">=</span><span class="hljs-string">"First Name"</span>
<span class="hljs-tag">           </span><span class="hljs-attr">aria-label</span><span class="hljs-tag">=</span><span class="hljs-string">"First Name"</span><span class="hljs-tag"> </span><span class="hljs-attr">formControlName</span><span class="hljs-tag">=</span><span class="hljs-string">"first"</span><span class="hljs-tag">&gt;</span>
      @if (formGroup.get('name.first')?.hasError('required'))
      {
         <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>First Name is required<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>
      }
      @if (formGroup.get('name.first')?.hasError('minLength'))
      {
        <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>Must be at least 2 characters<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>
      }
      @if (formGroup.get('name.first')?.hasError('maxLength'))
      {
        <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>Can't exceed 50 characters<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>
      }
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag"> </span><span class="hljs-attr">appearance</span><span class="hljs-tag">=</span><span class="hljs-string">"outline"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlex</span><span class="hljs-tag">=</span><span class="hljs-string">"20%"</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span><span class="hljs-attr">matInput</span><span class="hljs-tag"> </span><span class="hljs-attr">placeholder</span><span class="hljs-tag">=</span><span class="hljs-string">"MI"</span><span class="hljs-tag"> </span>
<span class="hljs-tag">      </span><span class="hljs-attr">aria-label</span><span class="hljs-tag">=</span><span class="hljs-string">"Middle Initial"</span><span class="hljs-tag"> </span><span class="hljs-attr">formControlName</span><span class="hljs-tag">=</span><span class="hljs-string">"middle"</span><span class="hljs-tag">&gt;</span>
      @if (formGroup.get('name.middle')?.hasError('invalid'))
      {
        <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>Only initial<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>
      }
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag"> </span><span class="hljs-attr">appearance</span><span class="hljs-tag">=</span><span class="hljs-string">"outline"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlex</span><span class="hljs-tag">=</span><span class="hljs-string">"40%"</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span><span class="hljs-attr">matInput</span><span class="hljs-tag"> </span><span class="hljs-attr">placeholder</span><span class="hljs-tag">=</span><span class="hljs-string">"Last Name"</span><span class="hljs-tag"> </span>
<span class="hljs-tag">      </span><span class="hljs-attr">aria-label</span><span class="hljs-tag">=</span><span class="hljs-string">"Last Name"</span><span class="hljs-tag"> </span><span class="hljs-attr">formControlName</span><span class="hljs-tag">=</span><span class="hljs-string">"last"</span><span class="hljs-tag">&gt;</span>
      @if (formGroup.get('name.last')?.hasError('required'))
      {
        <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>Last Name is required<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>
      }
      @if (formGroup.get('name.last')?.hasError('minLength'))
      {
        <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>Must be at least 2 characters<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>
      }
      @if (formGroup.get('name.last')?.hasError('maxLength'))
      {
        <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>Can't exceed 50 characters<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>
      }  
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
</code></pre>
      </li>
      <li class="numberedList">Take your time understanding<a id="_idIndexMarker801"/> how the stepper<a id="_idIndexMarker802"/> and the form<a id="_idIndexMarker803"/> configuration work<a id="_idIndexMarker804"/> so far. You should<a id="_idIndexMarker805"/> see the first row render, pulling in data from the <strong class="keyWord">lemon-mart-server</strong>:
    <figure class="mediaobject"><img src="../Images/B20960_08_01.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 8.1: Multi-step form – step 1</p></li>
    </ol>
    <p class="normal">Note that adding <code class="inlineCode">fxLayout.lt-sm="column"</code> to a row with <code class="inlineCode">fxLayout="row"</code> enables a responsive layout for the form, as shown here:</p>
    <figure class="mediaobject"><img src="../Images/B20960_08_02.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 8.2: Multi-step form on mobile</p>
    <p class="normal">Before we move on to how to implement the <strong class="keyWord">Date of Birth</strong> ﬁeld, let’s reevaluate our strategy by implementing error messages.</p>
    <h1 id="_idParaDest-248" class="heading-1">Reusing repeating template behavior with directives</h1>
    <p class="normal">In the previous section, we implemented <a id="_idIndexMarker806"/>a <code class="inlineCode">mat-error</code> element<a id="_idIndexMarker807"/> for every validation error for every field part of the <code class="inlineCode">name</code> object. This quickly adds up to seven elements for three fields. In <em class="chapterRef">Chapter 5</em>, <em class="italic">Designing Authentication and Authorization</em>, we implemented <code class="inlineCode">common/validations.ts</code> to reuse validation rules. We can reuse the behavior we implement within <code class="inlineCode">mat-error</code>, or any other <code class="inlineCode">div</code> for that matter, using an attribute directive.</p>
    <h2 id="_idParaDest-249" class="heading-2">Attribute directives</h2>
    <p class="normal">In <em class="chapterRef">Chapter 1</em>, <em class="italic">Angular’s Architecture and Concepts</em>, I mentioned that<a id="_idIndexMarker808"/> Angular components represent the most basic unit of an Angular app. With components, we define custom HTML elements that can reuse features and functionality represented by a template and some TypeScript code. Conversely, a directive augments the capabilities of an existing element or component. In a sense, a component is a super directive that augments basic HTML capabilities.</p>
    <p class="normal">With this view in mind, we can define three kinds<a id="_idIndexMarker809"/> of directives:</p>
    <ul>
      <li class="bulletList">Components</li>
      <li class="bulletList">Structural directives</li>
      <li class="bulletList">Attribute directives</li>
    </ul>
    <p class="normal">Basically, components are directives with templates; this is the most common type of directive you will use. Structural directives modify the DOM by adding or removing elements, <code class="inlineCode">*ngIf</code> and <code class="inlineCode">*ngFor</code> being the canonical examples.</p>
    <div class="packt_tip">
      <p class="normal">As of Angular 17, you can use the <code class="inlineCode">@</code>-syntax to implement control flow and deferrable views, replacing <code class="inlineCode">*ngIf</code> and <code class="inlineCode">*ngFor</code> in favor of <code class="inlineCode">@if</code> or <code class="inlineCode">@for</code>, respectively. See the code snippet below for an example:</p>
      <pre class="programlisting code"><code class="hljs-code">@if (user.isHuman) {
  &lt;human-profile [data]="user" /&gt;
} @else if (user.isRobot) {
  &lt;!-- robot users are rare, so load their profiles lazily --&gt;
  @defer {
    &lt;robot-profile [data]="user" /&gt;
  }
} @else {
  &lt;p&gt;The profile is unknown!
}
</code></pre>
    </div>
    <p class="normal">Finally, attribute directives allow you to define new attributes to add to HTML elements or components, adding new behavior.</p>
    <p class="normal">Let’s implement an attribute directive that can encapsulate field-level error behavior.</p>
    <h2 id="_idParaDest-250" class="heading-2">Field error attribute directive</h2>
    <p class="normal">Imagine using a directive to reduce repetitive<a id="_idIndexMarker810"/> elements to display field errors. Consider the following example using the first name field as an example:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">example</strong></span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag"> </span><span class="hljs-attr">appearance</span><span class="hljs-tag">=</span><span class="hljs-string">"outline"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlex</span><span class="hljs-tag">=</span><span class="hljs-string">"40%"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-label</span><span class="hljs-tag">&gt;</span>First Name<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-label</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span><span class="hljs-attr">matInput</span><span class="hljs-tag"> </span><span class="hljs-attr">aria-label</span><span class="hljs-tag">=</span><span class="hljs-string">"First Name"</span><span class="hljs-tag"> </span><span class="hljs-attr">formControlName</span><span class="hljs-tag">=</span><span class="hljs-string">"first"</span><span class="hljs-tag"> #</span><span class="hljs-attr">name</span><span class="hljs-tag"> /&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-error</span><span class="hljs-tag"> </span><span class="code-highlight"><strong class="hljs-tag-slc">[</strong><strong class="hljs-attr-slc">input</strong><strong class="hljs-tag-slc">]=</strong><strong class="hljs-string-slc">"name"</strong><strong class="hljs-tag-slc"> [</strong><strong class="hljs-attr-slc">group</strong><strong class="hljs-tag-slc">]=</strong><strong class="hljs-string-slc">"formGroup.get('name')"</strong></span>
<span class="hljs-tag">    </span><span class="code-highlight"><strong class="hljs-tag-slc">[</strong><strong class="hljs-attr-slc">appFieldError</strong><strong class="hljs-tag-slc">]=</strong><strong class="hljs-string-slc">"ErrorSets.RequiredText"</strong><strong class="hljs-tag-slc">&gt;</strong></span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag">&gt;</span>
</code></pre>
    <p class="normal">We have the standard layout structure for a Material form field, but only a single <code class="inlineCode">mat-error</code> element exists. There are three new properties on <code class="inlineCode">mat-error</code>:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">input</code> binds to the HTML input element that was tagged with <code class="inlineCode">#name</code>, using a template reference variable so that we can tap into the blur event of the input element and read the <code class="inlineCode">placeholder</code>, <code class="inlineCode">aria-label</code>, and <code class="inlineCode">formControlName</code> properties.</li>
      <li class="bulletList"><code class="inlineCode">group</code> binds to the parent FormGroup object that contains the form control, so by using the <code class="inlineCode">formControlName</code> property from input, we can retrieve the <code class="inlineCode">formControl</code> object while avoiding extra code.</li>
      <li class="bulletList"><code class="inlineCode">appFieldError</code> binds to an array of validation errors that must be checked against the <code class="inlineCode">formControl</code> object, such as <code class="inlineCode">required</code>, <code class="inlineCode">minlength</code>, <code class="inlineCode">maxlength</code>, and <code class="inlineCode">invalid</code>.</li>
    </ul>
    <p class="normal">Using the preceding information, we can craft a directive that can render one or more lines of error messages inside the <code class="inlineCode">mat-error</code> element, effectively replicating the verbose method we used in the previous section.</p>
    <p class="normal">Let’s go ahead and create an attribute directive named <code class="inlineCode">FieldErrorDirective</code>:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Create <code class="inlineCode">FieldErrorDirective</code> under <code class="inlineCode">src/app/user-controls</code>.</li>
      <li class="numberedList">Define the directive’s selector as a bindable attribute named <code class="inlineCode">appFieldError</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user-controls/field-error/field-error.</strong><strong class="hljs-property-slc">directive</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-meta">@Directive</span>({
  <span class="hljs-attr">selector</span>: <span class="code-highlight"><strong class="hljs-string-slc">'[appFieldError]'</strong></span>,
})
</code></pre>
      </li>
      <li class="numberedList">Outside of the directive, define two new types named <code class="inlineCode">ValidationError</code> and <code class="inlineCode">ValidationErrorTuple</code>, which define the kinds of error conditions we will deal with and a structure that will allow us to attach a custom error message to the error type:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user-controls/field-error/field-error.</strong><strong class="hljs-property-slc">directive</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title">ValidationError</span> = 
   <span class="hljs-string">'required'</span> | <span class="hljs-string">'minlength'</span> | <span class="hljs-string">'maxlength'</span> | <span class="hljs-string">'invalid'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title">ValidationErrorTuple</span> = {
  <span class="hljs-attr">error</span>: <span class="hljs-title">ValidationError</span>;
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>
}
</code></pre>
      </li>
      <li class="numberedList">Like the way we grouped<a id="_idIndexMarker811"/> validations, let’s define two sets of commonly occurring error conditions so that we don’t have to type them out over and over again:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user-controls/field-error/field-error.</strong><strong class="hljs-property-slc">directive</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title">ErrorSets</span>: { [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-title">ValidationError</span>[] } = {
  <span class="hljs-title">OptionalText</span>: [<span class="hljs-string">'minlength'</span>, <span class="hljs-string">'maxlength'</span>],
  <span class="hljs-title">RequiredText</span>: [<span class="hljs-string">'minlength'</span>, <span class="hljs-string">'maxlength'</span>, <span class="hljs-string">'required'</span>],
}
</code></pre>
      </li>
      <li class="numberedList">Next, let’s define the <code class="inlineCode">@Input</code> targets for the directive:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user-controls/field-error/field-error.</strong><strong class="hljs-property-slc">directive</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FieldErrorDirective</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OnDestroy</span>, <span class="hljs-title">OnChanges</span> {
  <span class="hljs-meta">@Input</span>() <span class="hljs-attr">appFieldError</span>:
    | <span class="hljs-title">ValidationError</span>
    | <span class="hljs-title">ValidationError</span>[]
    | <span class="hljs-title">ValidationErrorTuple</span>
    | <span class="hljs-title">ValidationErrorTuple</span>[]
  <span class="hljs-meta">@Input</span>() <span class="hljs-attr">input</span>: <span class="hljs-title">HTMLInputElement</span> | <span class="hljs-literal">undefined</span>
  <span class="hljs-meta">@Input</span>() <span class="hljs-attr">group</span>: <span class="hljs-title">FormGroup</span>
  <span class="hljs-meta">@Input</span>() <span class="hljs-attr">fieldControl</span>: <span class="hljs-title">AbstractControl</span> | <span class="hljs-literal">null</span>
  <span class="hljs-meta">@Input</span>() <span class="hljs-attr">fieldLabel</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>
</code></pre>
     
    <div class="packt_tip">
      <p class="normal">Note that we already went over the purpose of the top three attributes. <code class="inlineCode">fieldControl</code> and <code class="inlineCode">fieldLabel</code> are optional attributes. If <code class="inlineCode">input</code> and <code class="inlineCode">group</code> are specified, the optional attributes can be auto-populated. Since they are class-wide variables, it made sense to expose them if the user wants to override the default behavior of the directive. This is an easy win to create flexible and reusable controls.</p>
    </div> </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">Import the element<a id="_idIndexMarker812"/> reference in the <code class="inlineCode">constructor</code>, which can be later used by a <code class="inlineCode">renderErrors</code> function to display error in the inner HTML of the <code class="inlineCode">mat-error</code> element:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user-controls/field-error/field-error.</strong><strong class="hljs-property-slc">directive</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">nativeElement</span>: <span class="hljs-title">HTMLElement</span>
  <span class="hljs-title">constructor</span>(<span class="hljs-keyword">private</span><span class="hljs-params"> </span><span class="hljs-attr">el</span><span class="hljs-params">: </span><span class="hljs-title">ElementRef</span>) {
    <span class="hljs-variable">this</span>.<span class="hljs-property">nativeElement</span> = <span class="hljs-variable">this</span>.<span class="hljs-property">el</span>.<span class="hljs-property">nativeElement</span>
  }
  <span class="hljs-title">renderErrors</span>(<span class="hljs-attr">errors</span><span class="hljs-params">: </span><span class="hljs-built_in">string</span>) {
    <span class="hljs-variable">this</span>.<span class="hljs-property">nativeElement</span>.<span class="hljs-property">innerText</span> = errors
  }
</code></pre>
      </li>
      <li class="numberedList">Implement a function that can return canned error messages, depending on the error type:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user-controls/field-error/field-error.</strong><strong class="hljs-property-slc">directive</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
  <span class="hljs-title">getStandardErrorMessage</span>(<span class="hljs-attr">error</span>: <span class="hljs-title">ValidationError</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">const</span> label = <span class="hljs-variable">this</span>.<span class="hljs-property">fieldLabel</span> || <span class="hljs-string">'</span><span class="hljs-string">Input'</span>
    <span class="hljs-keyword">switch</span> (error) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'required'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">`</span><span class="hljs-subst">${label}</span><span class="hljs-string"> is required`</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'minlength'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">`</span><span class="hljs-subst">${label}</span><span class="hljs-string"> must be at least </span><span class="hljs-subst">${</span>
<span class="hljs-subst">          </span><span class="hljs-variable">this</span><span class="hljs-subst">.fieldControl?.getError(error)?.requiredLength ?? </span><span class="hljs-number">2</span>
<span class="hljs-subst">        }</span><span class="hljs-string"> characters`</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'maxlength'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">`</span><span class="hljs-subst">${label}</span><span class="hljs-string"> can\'t exceed </span><span class="hljs-subst">${</span>
<span class="hljs-subst">          </span><span class="hljs-variable">this</span><span class="hljs-subst">.fieldControl?.getError(error)?.requiredLength ?? </span><span class="hljs-number">50</span>
<span class="hljs-subst">        }</span><span class="hljs-string"> characters`</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'invalid'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">`A valid </span><span class="hljs-subst">${label}</span><span class="hljs-string"> is required`</span>
    }
  }
</code></pre>
     
    <div class="packt_tip">
      <p class="normal">Note that we can dynamically extract the required <code class="inlineCode">minlength</code> or <code class="inlineCode">maxlength</code> from the <code class="inlineCode">fieldControl</code>, greatly reducing the number of custom messages we need to generate.</p>
    </div> </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="8">Implement the algorithm<a id="_idIndexMarker813"/> that can loop through all the elements in <code class="inlineCode">appFieldError</code> and the errors that need to be displayed in an array, using the <code class="inlineCode">getStandardErrorMessage</code> method:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user-controls/field-error/field-error.</strong><strong class="hljs-property-slc">directive</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-title">updateErrorMessage</span>() {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">errorsToDisplay</span>: <span class="hljs-built_in">string</span>[] = []
    <span class="hljs-keyword">const</span> errors = <span class="hljs-title">Array</span>.<span class="hljs-title">isArray</span>(<span class="hljs-variable">this</span>.<span class="hljs-property">appFieldError</span>)
      ? <span class="hljs-variable">this</span>.<span class="hljs-property">appFieldError</span>
      : [<span class="hljs-variable">this</span>.<span class="hljs-property">appFieldError</span>]
    errors.<span class="hljs-title">forEach</span>(
      <span class="hljs-function">(</span><span class="hljs-attr">error</span><span class="hljs-params">: </span><span class="hljs-title">ValidationError</span><span class="hljs-params"> </span>
<span class="hljs-params">            | { error: ValidationError; message: </span><span class="hljs-built_in">string</span><span class="hljs-params"> }</span><span class="hljs-function">) =&gt;</span> {
        <span class="hljs-keyword">const</span> errorCode = 
          <span class="hljs-keyword">typeof</span> error === <span class="hljs-string">'object'</span> ? error.<span class="hljs-property">error</span> : error 
        <span class="hljs-keyword">const</span> message =
          <span class="hljs-keyword">typeof</span> error === <span class="hljs-string">'object'</span>
            ? <span class="hljs-function">() =&gt;</span> error.<span class="hljs-property">message</span>
            : <span class="hljs-function">() =&gt;</span> <span class="hljs-variable">this</span>.<span class="hljs-title">getStandardErrorMessage</span>(errorCode)
        <span class="hljs-keyword">const</span> errorChecker =
          errorCode === <span class="hljs-string">'invalid'</span>
            ? <span class="hljs-function">() =&gt;</span> <span class="hljs-variable">this</span>.<span class="hljs-property">fieldControl</span>?.<span class="hljs-property">invalid</span>
            : <span class="hljs-function">() =&gt;</span> <span class="hljs-variable">this</span>.<span class="hljs-property">fieldControl</span>?.<span class="hljs-title">hasError</span>(errorCode)
        <span class="hljs-keyword">if</span> (<span class="hljs-title">errorChecker</span>()) {
          errorsToDisplay.<span class="hljs-title">push</span>(<span class="hljs-title">message</span>())
        }
      }
    )
    <span class="hljs-variable">this</span>.<span class="hljs-title">renderErrors</span>(errorsToDisplay.<span class="hljs-title">join</span>(<span class="hljs-string">'&lt;br&gt;'</span>))
  }
</code></pre>
     
    <p class="normal">Ultimately, we can display the error messages using the <code class="inlineCode">renderErrors</code> method.</p>
    <div class="packt_tip">
      <p class="normal">Note the use of function delegates, a technique that allows functions to be passed around and used as variables. Since this code will execute hundreds of times a minute, it is important to avoid unnecessary invocations. Function delegates help organize our code better while deferring the execution of their logic unless absolutely necessary. This pattern of coding allows for memorization techniques to enhance performance further. Refer to the <em class="italic">Further reading</em> section for more details.</p>
    </div> </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="9">Now, initialize <a id="_idIndexMarker814"/>the <code class="inlineCode">fieldControl</code> property, which represents a <code class="inlineCode">formControl</code>. We will listen to the <code class="inlineCode">valueChanges</code> events of the control, and if the validation status is invalid, then we execute our custom <code class="inlineCode">updateErrorMessage</code> logic to display error messages:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user-controls/field-error/field-error.</strong><strong class="hljs-property-slc">directive</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">private</span> <span class="hljs-attr">controlSubscription</span>: <span class="hljs-title">Subscription</span> | <span class="hljs-literal">undefined</span>
<span class="hljs-title">ngOnDestroy</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-variable">this</span>.<span class="hljs-title">unsubscribe</span>()
}
<span class="hljs-title">unsubscribe</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-variable">this</span>.<span class="hljs-property">controlSubscription</span>?.<span class="hljs-title">unsubscribe</span>()
}
<span class="hljs-title">initFieldControl</span>() {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">this</span>.<span class="hljs-property">input</span> &amp;&amp; <span class="hljs-variable">this</span>.<span class="hljs-property">group</span>) {
      <span class="hljs-keyword">const</span> controlName = <span class="hljs-variable">this</span>.<span class="hljs-property">input</span>.
        <span class="hljs-title">getAttribute</span>(<span class="hljs-string">'formControlName'</span>) ?? <span class="hljs-string">''</span>
      <span class="hljs-variable">this</span>.<span class="hljs-property">fieldControl</span> =
        <span class="hljs-variable">this</span>.<span class="hljs-property">fieldControl</span> || <span class="hljs-variable">this</span>.<span class="hljs-property">group</span>.<span class="hljs-title">get</span>(controlName)
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable">this</span>.<span class="hljs-property">fieldControl</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title">Error</span>( 
          <span class="hljs-string">`[appFieldError] couldn't bind to control </span><span class="hljs-subst">${controlName}</span><span class="hljs-string">`</span>
        )
      }
      <span class="hljs-variable">this</span>.<span class="hljs-title">unsubscribe</span>()
      <span class="hljs-variable">this</span>.<span class="hljs-property">controlSubscription</span> = <span class="hljs-variable">this</span>.<span class="hljs-property">fieldControl</span>?.<span class="hljs-property">valueChanges</span>
        .<span class="hljs-title">pipe</span>(
          <span class="hljs-title">filter</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable">this</span>.<span class="hljs-property">fieldControl</span>?.<span class="hljs-property">status</span> === <span class="hljs-string">'INVALID'</span>),
          <span class="hljs-title">tap</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable">this</span>.<span class="hljs-title">updateErrorMessage</span>())
        )
        .<span class="hljs-title">subscribe</span>()
    }
  }
</code></pre>
      
    <div class="packt_tip">
      <p class="normal">Note that since we’re subscribing to <code class="inlineCode">valueChanges</code>, we must also unsubscribe. We unsubscribe once with <code class="inlineCode">ngOnDestroy</code> and again right before subscribing. This is because <code class="inlineCode">initFieldControl</code> may be called multiple times. If we don’t clear the prior subscription, it will result in a memory leak and related performance issues.</p>
      <p class="normal">Additionally, if we can’t bind to a <code class="inlineCode">fieldControl</code>, we throw an error message, which usually points to a coding error.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="10">Finally, we configure all major attributes<a id="_idIndexMarker815"/> with the <code class="inlineCode">ngOnChanges</code> event, which triggers any time an <code class="inlineCode">@Input</code> attribute is updated. This ensures that, in the case where form elements could be dynamically added or removed, we will always consider the newest values. We call <code class="inlineCode">initFieldControl</code> to start listening to value changes, implement an <code class="inlineCode">onblur</code> event handler that triggers <code class="inlineCode">updateErrorMessage()</code> for the HTML input element, and assign the value of <code class="inlineCode">fieldLabel</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user-controls/field-error/field-error.</strong><strong class="hljs-property-slc">directive</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
  <span class="hljs-title">ngOnChanges</span>(<span class="hljs-attr">changes</span>: <span class="hljs-title">SimpleChanges</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable">this</span>.<span class="hljs-title">initFieldControl</span>()
    <span class="hljs-keyword">if</span> (changes.<span class="hljs-property">input</span>.<span class="hljs-property">firstChange</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable">this</span>.<span class="hljs-property">input</span>) {
        <span class="hljs-variable">this</span>.<span class="hljs-property">input</span>.<span class="hljs-property">onblur</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-variable">this</span>.<span class="hljs-title">updateErrorMessage</span>()
        <span class="hljs-variable">this</span>.<span class="hljs-property">fieldLabel</span> =
          <span class="hljs-variable">this</span>.<span class="hljs-property">fieldLabel</span> ||
          <span class="hljs-variable">this</span>.<span class="hljs-property">input</span>.<span class="hljs-property">placeholder</span> ||
          <span class="hljs-variable">this</span>.<span class="hljs-property">input</span>.<span class="hljs-title">getAttribute</span>(<span class="hljs-string">'aria-label'</span>) ||
          <span class="hljs-string">''</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title">Error</span>(
          <span class="hljs-string">`appFieldError.[input] couldn't bind to any input element`</span>
        )
      }
    }
  }
</code></pre>
      </li>
    </ol>
    <div class="packt_tip">
      <p class="normal">Note that if we can’t bind to an HTML <code class="inlineCode">input</code> element, this usually means that the developer simply forgot to wire things up correctly. In this case, we throw a new <code class="inlineCode">Error</code> object, which generates a helpful stack trace in the console, so you can pinpoint the location where the error occurs in the template.</p>
    </div>
    <p class="normal">This wraps up the implementation of the directive. Now, we need to package the directive in a module named <code class="inlineCode">field-error.module.ts</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user-controls/field-error/field-error.</strong><strong class="hljs-property-slc">directive</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
  <span class="hljs-meta">@NgModule</span>({
  <span class="hljs-attr">imports</span>: [<span class="hljs-title">CommonModule</span>, <span class="hljs-title">ReactiveFormsModule</span>],
  <span class="hljs-attr">declarations</span>: [<span class="hljs-title">FieldErrorDirective</span>],
  <span class="hljs-attr">exports</span>: [<span class="hljs-title">FieldErrorDirective</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FieldErrorModule</span> {}
</code></pre>
    <p class="normal">Now, go ahead and use the directive in our existing forms:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Import the module in <code class="inlineCode">app.module.ts</code> and <code class="inlineCode">user.module.ts</code>.</li>
      <li class="numberedList">Update <code class="inlineCode">profile.component.html</code> with the new directive.</li>
      <li class="numberedList">Update <code class="inlineCode">login.component.html</code> with the new directive.</li>
    </ol>
    <div class="packt_tip">
      <p class="normal">Be sure to define <code class="inlineCode">ErrorSets</code> as a public property variable in the <code class="inlineCode">component</code> class so that you can use it in the template.</p>
    </div>
    <p class="normal">Test your forms to ensure that our validation messages are displayed as expected and there are no console errors.</p>
    <p class="normal">Congratulations! You’ve learned how to inject<a id="_idIndexMarker816"/> new behavior into other elements and components using directives. By doing this, we can avoid a lot of repeated code and standardize error messages across our app.</p>
    <div class="note">
      <p class="normal">Before moving on, finish implementing the form by looking at the implementation on GitHub. You can find the code for the form template at <code class="inlineCode">projects/stage11/src/app/user/profile/profile.initial.component.html</code> and the <code class="inlineCode">component</code> class at <code class="inlineCode">projects/stage11/src/app/user/profile/profile.initial.component.ts</code>.</p>
      <p class="normal">Do not include the <code class="inlineCode">app-lemon-rater</code> and <code class="inlineCode">app-view-user</code> elements, and remove the <code class="inlineCode">mask</code> attribute from the phone number, which we will implement later in the chapter.</p>
    </div>
    <p class="normal">Here, you can see the User Profile<a id="_idIndexMarker817"/> as it appears on LemonMart:</p>
    <figure class="mediaobject"><img src="../Images/B20960_08_03.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 8.3: Profile component in a mostly completed state</p>
    <p class="normal">Next, we will review the <code class="inlineCode">profile</code> component and see how the <strong class="screenText">Date of Birth</strong> ﬁeld works.</p>
    <h1 id="_idParaDest-251" class="heading-1">Calculated properties and DatePicker</h1>
    <p class="normal">We can display calculated properties<a id="_idIndexMarker818"/> based on user input. For example, to display a person’s age based on their date of birth, introduce class properties that calculate the age and display it as follows:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
now = <span class="hljs-keyword">new</span> <span class="hljs-title">Date</span>()
<span class="hljs-keyword">get</span> <span class="hljs-title">dateOfBirth</span>() {
  <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span>.<span class="hljs-title">get</span>(<span class="hljs-string">'dateOfBirth'</span>)?.<span class="hljs-property">value</span> || <span class="hljs-variable">this</span>.<span class="hljs-property">now</span>
}
<span class="hljs-keyword">get</span> <span class="hljs-title">age</span>() {
  <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-property">now</span>.<span class="hljs-title">getFullYear</span>() - <span class="hljs-variable">this</span>.<span class="hljs-property">dateOfBirth</span>.<span class="hljs-title">getFullYear</span>()
}
</code></pre>
    <p class="normal">The implementation for the <code class="inlineCode">age</code> property<a id="_idIndexMarker819"/> getter is not the most performant option. To calculate the age, we call the <code class="inlineCode">getFullYear()</code> function of <code class="inlineCode">this.now</code> and <code class="inlineCode">this.dateOfBirth</code>. As a property referenced in the template, Angular’s change detection algorithm will call <code class="inlineCode">age</code> up to 60 times per second, mixed with other elements on the screen, which can lead to major<a id="_idIndexMarker820"/> performance issues. You can resolve this issue by creating a <strong class="keyWord">pure custom pipe</strong> so that Angular understands only to check the <code class="inlineCode">age</code> property if one of its dependent values changes.</p>
    <p class="normal">You can read more<a id="_idIndexMarker821"/> about pure pipes at <a href="https://angular.dev/guide/pipes/change-detection"><span class="url">https://angular.dev/guide/pipes/change-detection</span></a>.</p>
    <div class="note">
      <p class="normal">Another option<a id="_idIndexMarker822"/> would be to use <strong class="keyWord">computed signals</strong>. Like calculated properties, computed signals are read-only signals that derive their value from other signals.</p>
      <p class="normal">We could rewrite the code above like below:</p>
      <pre class="programlisting code"><code class="hljs-code">  now = new Date()
  dateOfBirth = 
    signal(
     this.formGroup.get('dateOfBirth')?.value || this.now
    )
  age = computed(() =&gt; 
    this.now.getFullYear() - this.dateOfBirth().getFullYear())
</code></pre>
      <p class="normal">We create <code class="inlineCode">dateOfBirth</code> as a <strong class="keyWord">signal</strong> and <code class="inlineCode">age</code> as a <strong class="keyWord">computed signal</strong>. With this setup, <code class="inlineCode">age</code> will be updated if and only if <code class="inlineCode">dateOfBirth</code> changes. As you can see, the implementation is straightforward, and Angular’s change detection algorithm will do the right thing by default.</p>
      <p class="normal">Except for <a id="_idIndexMarker823"/>one wrinkle! Due to the absence of <strong class="keyWord">signal-based components</strong> and the requisite <code class="inlineCode">FormGroup</code> support, we can’t readily use <code class="inlineCode">dateOfBirth</code> or <code class="inlineCode">age</code> in reactive forms.</p>
      <p class="normal">This helps you appreciate <a id="_idIndexMarker824"/>how big a change signals are for Angular. Read more at <a href="https://angular.dev/guide/signals#computed-signals"><span class="url">https://angular.dev/guide/signals#computed-signals</span></a>.</p>
    </div>
    <p class="normal">To validate a date within the last hundred years, implement a <code class="inlineCode">minDate</code> class property:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
  minDate = <span class="hljs-keyword">new</span> <span class="hljs-title">Date</span>(
    <span class="hljs-variable">this</span>.<span class="hljs-property">now</span>.<span class="hljs-title">getFullYear</span>() - <span class="hljs-number">100</span>,
    <span class="hljs-variable">this</span>.<span class="hljs-property">now</span>.<span class="hljs-title">getMonth</span>(),
    <span class="hljs-variable">this</span>.<span class="hljs-property">now</span>.<span class="hljs-title">getDate</span>()
  )
</code></pre>
    <p class="normal">The usage of the calculated properties<a id="_idIndexMarker825"/> in the template looks like this:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.component.html</strong></span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag"> </span><span class="hljs-attr">appearance</span><span class="hljs-tag">=</span><span class="hljs-string">"outline"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlex</span><span class="hljs-tag">=</span><span class="hljs-string">"50%"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-label</span><span class="hljs-tag">&gt;</span>Date of Birth<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-label</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span><span class="hljs-attr">matInput</span><span class="hljs-tag"> </span><span class="hljs-attr">aria-label</span><span class="hljs-tag">=</span><span class="hljs-string">"Date of Birth"</span><span class="hljs-tag"> </span><span class="hljs-attr">formControlName</span><span class="hljs-tag">=</span><span class="hljs-string">"dateOfBirth"</span>
<span class="hljs-tag">    </span><span class="code-highlight"><strong class="hljs-tag-slc">[</strong><strong class="hljs-attr-slc">min</strong><strong class="hljs-tag-slc">]=</strong><strong class="hljs-string-slc">"minDate"</strong><strong class="hljs-tag-slc"> [</strong><strong class="hljs-attr-slc">max</strong><strong class="hljs-tag-slc">]=</strong><strong class="hljs-string-slc">"now"</strong></span><span class="hljs-tag"> [</span><span class="hljs-attr">matDatepicker</span><span class="hljs-tag">]=</span><span class="hljs-string">"dateOfBirthPicker"</span><span class="hljs-tag"> #</span><span class="hljs-attr">dob</span><span class="hljs-tag"> /&gt;</span>
  @if (formGroup.get('dateOfBirth')?.value) {
    <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-hint</span><span class="hljs-tag">&gt;</span> {{ age }} year(s) old <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-hint</span><span class="hljs-tag">&gt;</span>
  }
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-datepicker-toggle</span><span class="hljs-tag"> </span><span class="hljs-attr">matSuffix</span><span class="hljs-tag"> [</span><span class="hljs-attr">for</span><span class="hljs-tag">]=</span><span class="hljs-string">"dateOfBirthPicker"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-datepicker-toggle</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-datepicker</span><span class="hljs-tag"> #</span><span class="hljs-attr">dateOfBirthPicker</span><span class="hljs-tag">&gt;&lt;/</span><span class="hljs-name">mat-datepicker</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-error</span><span class="hljs-tag"> [</span><span class="hljs-attr">input</span><span class="hljs-tag">]=</span><span class="hljs-string">"dob"</span><span class="hljs-tag"> [</span><span class="hljs-attr">group</span><span class="hljs-tag">]=</span><span class="hljs-string">"formGroup"</span>
<span class="hljs-tag">    [</span><span class="hljs-attr">appFieldError</span><span class="hljs-tag">]=</span>
<span class="hljs-tag">      </span><span class="hljs-string">"</span><span class="hljs-string">{error: 'invalid', message: 'Date must be within the last 100 years'}"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag">&gt;</span>
</code></pre>
    <div class="packt_tip">
      <p class="normal">Refer to the highlighted <code class="inlineCode">[min]</code> and <code class="inlineCode">[max]</code> attributes in the preceding snippet to apply the hundred-year date range.</p>
    </div>
    <p class="normal">The <code class="inlineCode">DatePicker</code> in action<a id="_idIndexMarker826"/> appears as follows:</p>
    <figure class="mediaobject"><img src="../Images/B20960_08_04.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 8.4: Selecting a date with DatePicker</p>
    <p class="normal">Note that dates beyond <a id="_idIndexMarker827"/>April 26, 2020 are grayed out. After the date is selected, the calculated<a id="_idIndexMarker828"/> age is displayed as follows:</p>
    <figure class="mediaobject"><img src="../Images/B20960_08_05.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 8.5: Calculated age property</p>
    <p class="normal">Now, let’s move on to the next step, <strong class="screenText">Contact Information</strong>, and see how we can enable a convenient way to display and input the state portion of the address field.</p>
    <h1 id="_idParaDest-252" class="heading-1">Typeahead support</h1>
    <p class="normal">In <code class="inlineCode">buildForm</code>, we set a listener<a id="_idIndexMarker829"/> on <code class="inlineCode">address.state</code> to support a typeahead filtering drop-down experience:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">const</span> state = <span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span>.<span class="hljs-title">get</span>(<span class="hljs-string">'address.state'</span>)
<span class="hljs-keyword">if</span> (state != <span class="hljs-literal">null</span>) {
  <span class="hljs-variable">this</span>.<span class="hljs-property">states$</span> = state.<span class="hljs-property">valueChanges</span>.<span class="hljs-title">pipe</span>(
    <span class="hljs-title">startWith</span>(<span class="hljs-string">''</span>),
    <span class="hljs-title">map</span>(<span class="hljs-function">(</span><span class="hljs-params">value</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">USStateFilter</span>(value))
  )
}
</code></pre>
    <p class="normal">On the template, implement <code class="inlineCode">mat-autocomplete</code>, bound to the filtered states array with an <code class="inlineCode">async</code> pipe:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.component.html</strong></span>
...
<span class="hljs-tag">&lt;</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag"> </span><span class="hljs-attr">appearance</span><span class="hljs-tag">=</span><span class="hljs-string">"outline"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlex</span><span class="hljs-tag">=</span><span class="hljs-string">"30%"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-label</span><span class="hljs-tag">&gt;</span>State<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-label</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span><span class="hljs-attr">type</span><span class="hljs-tag">=</span><span class="hljs-string">"text"</span><span class="hljs-tag"> </span><span class="hljs-attr">aria-label</span><span class="hljs-tag">=</span><span class="hljs-string">"State"</span><span class="hljs-tag"> </span><span class="hljs-attr">matInput</span><span class="hljs-tag"> </span><span class="hljs-attr">formControlName</span><span class="hljs-tag">=</span><span class="hljs-string">"</span><span class="hljs-string">state"</span>
<span class="hljs-tag">    [</span><span class="hljs-attr">matAutocomplete</span><span class="hljs-tag">]=</span><span class="hljs-string">"stateAuto"</span><span class="hljs-tag"> #</span><span class="hljs-attr">state</span><span class="hljs-tag"> /&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-autocomplete</span><span class="hljs-tag"> #</span><span class="hljs-attr">stateAuto</span><span class="hljs-tag">=</span><span class="hljs-string">"matAutocomplete"</span><span class="hljs-tag">&gt;</span>
    @for (state of states$ | async; track state) {
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-option</span><span class="hljs-tag"> [</span><span class="hljs-attr">value</span><span class="hljs-tag">]=</span><span class="hljs-string">"state.name"</span><span class="hljs-tag">&gt;</span>
        {{ state.name }}
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-option</span><span class="hljs-tag">&gt;</span>
    }
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-autocomplete</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-error</span><span class="hljs-tag"> [</span><span class="hljs-attr">input</span><span class="hljs-tag">]=</span><span class="hljs-string">"state"</span><span class="hljs-tag"> [</span><span class="hljs-attr">group</span><span class="hljs-tag">]=</span><span class="hljs-string">"formGroup.get('address')"</span>
<span class="hljs-tag">    </span><span class="hljs-attr">appFieldError</span><span class="hljs-tag">=</span><span class="hljs-string">"required"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag">&gt;</span> 
...
</code></pre>
    <p class="normal">Here’s how it looks when a user enters the character <code class="inlineCode">V</code>:</p>
    <figure class="mediaobject"><img src="../Images/B20960_08_06.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 8.6: Dropdown with typeahead support</p>
    <p class="normal">In the next section, let’s enable the input of multiple phone numbers.</p>
    <h1 id="_idParaDest-253" class="heading-1">Dynamic form arrays</h1>
    <p class="normal">Note that the <code class="inlineCode">phones</code> property<a id="_idIndexMarker830"/> is an array, potentially allowing for many inputs. We can implement this by building a <code class="inlineCode">FormArray</code> with the <code class="inlineCode">this.formBuilder.array</code> function. We also define several helper functions to make it easier to build the <code class="inlineCode">FormArray</code>:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">buildPhoneFormControl</code> helps to build <code class="inlineCode">FormGroup</code> objects of individual entries.</li>
      <li class="bulletList"><code class="inlineCode">buildPhoneArray</code> creates as many <code class="inlineCode">FormGroup</code> objects as needed, or if the form is empty, it creates an empty entry.</li>
      <li class="bulletList"><code class="inlineCode">addPhone</code> adds a new empty <code class="inlineCode">FromGroup</code> object to the <code class="inlineCode">FormArray</code>.</li>
      <li class="bulletList"><code class="inlineCode">get phonesArray()</code> is a convenient property to get the <code class="inlineCode">phones</code> control from the form.</li>
    </ul>
    <p class="normal">Let’s see how the implementation comes together:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
<span class="hljs-attr">phones</span>: <span class="hljs-variable">this</span>.<span class="hljs-property">formBuilder</span>.<span class="hljs-title">array</span>(<span class="hljs-variable">this</span>.<span class="hljs-title">buildPhoneArray</span>(user?.<span class="hljs-property">phones</span> || [])),
...
  <span class="hljs-keyword">private</span> <span class="hljs-title">buildPhoneArray</span>(<span class="hljs-attr">phones</span><span class="hljs-params">: </span><span class="hljs-title">IPhone</span><span class="hljs-params">[]</span>) {
    <span class="hljs-keyword">const</span> groups = []
    <span class="hljs-keyword">if</span> (phones?.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      groups.<span class="hljs-title">push</span>(<span class="hljs-variable">this</span>.<span class="hljs-title">buildPhoneFormControl</span>(<span class="hljs-number">1</span>))
    } <span class="hljs-keyword">else</span> {
      phones.<span class="hljs-title">forEach</span>(<span class="hljs-function">(</span><span class="hljs-params">p</span><span class="hljs-function">) =&gt;</span> {
        groups.<span class="hljs-title">push</span>(
          <span class="hljs-variable">this</span>.<span class="hljs-title">buildPhoneFormControl</span>(p.<span class="hljs-property">id</span>, p.<span class="hljs-property">type</span>, p.<span class="hljs-property">digits</span>)
        )
      })
    }
    <span class="hljs-keyword">return</span> groups
      } 
<span class="hljs-keyword">  private</span> <span class="hljs-title">buildPhoneFormControl</span>(
<span class="hljs-params">    </span><span class="hljs-attr">id</span><span class="hljs-params">: </span><span class="hljs-built_in">number</span><span class="hljs-params">, </span><span class="hljs-keyword">type</span><span class="hljs-params">?: </span><span class="hljs-built_in">string</span><span class="hljs-params">, phoneNumber?: </span><span class="hljs-built_in">string</span>
  ) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-property">formBuilder</span>.<span class="hljs-title">group</span>({
      <span class="hljs-attr">id</span>: [id],
      <span class="hljs-attr">type</span>: [<span class="hljs-keyword">type</span> || <span class="hljs-string">''</span>, <span class="hljs-title">Validators</span>.<span class="hljs-property">required</span>],
      <span class="hljs-attr">digits</span>: [phoneNumber || <span class="hljs-string">''</span>, <span class="hljs-title">USAPhoneNumberValidation</span>],
  })
} 
...
</code></pre>
    <p class="normal"><code class="inlineCode">buildPhoneArray</code> supports the initialization<a id="_idIndexMarker831"/> of a form with a single phone input or by filling it with the existing data, working in tandem with <code class="inlineCode">buildPhoneFormControl</code>. The latter function comes in handy when a user clicks on an <strong class="screenText">Add</strong> button to create a new row for the entry:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
<span class="hljs-title">addPhone</span>() { <span class="hljs-variable">this</span>.<span class="hljs-property">phonesArray</span>.<span class="hljs-title">push</span>(
<span class="hljs-variable">this</span>.<span class="hljs-title">buildPhoneFormControl</span>(
  <span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span>.<span class="hljs-title">get</span>(<span class="hljs-string">'phones'</span>).<span class="hljs-property">value</span>.<span class="hljs-property">length</span> + <span class="hljs-number">1</span>)
)
}
<span class="hljs-keyword">get</span> <span class="hljs-title">phonesArray</span>(): <span class="hljs-title">FormArray</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span>.<span class="hljs-title">get</span>(<span class="hljs-string">'phones'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title">FormArray</span>
}
...
</code></pre>
    <p class="normal">The <code class="inlineCode">phonesArray</code> property getter is a common pattern that makes accessing certain form properties easier. However, in this case, it is also necessary because <code class="inlineCode">get('phones')</code> must be typecast<a id="_idIndexMarker832"/> to <code class="inlineCode">FormArray</code> so that we can access the <code class="inlineCode">length</code> property on it on the template:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.component.html</strong></span>
...
<span class="hljs-tag">&lt;</span><span class="hljs-name">mat-list</span><span class="hljs-tag"> </span><span class="hljs-attr">formArrayName</span><span class="hljs-tag">=</span><span class="hljs-string">"phones"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">h2</span><span class="hljs-tag"> </span><span class="hljs-attr">mat-subheader</span><span class="hljs-tag">&gt;</span>Phone Number(s)
    <span class="hljs-tag">&lt;</span><span class="hljs-name">button</span><span class="hljs-tag"> </span><span class="hljs-attr">mat-button</span><span class="hljs-tag"> (</span><span class="hljs-attr">click</span><span class="hljs-tag">)=</span><span class="hljs-string">"addPhone()"</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-icon</span><span class="hljs-tag">&gt;</span>add<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-icon</span><span class="hljs-tag">&gt;</span>
      Add Phone
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">button</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">h2</span><span class="hljs-tag">&gt;</span>
  @for (position of phonesArray.controls; track position; let i = $index) 
  {
    <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-list-item</span><span class="hljs-tag"> [</span><span class="hljs-attr">formGroupName</span><span class="hljs-tag">]=</span><span class="hljs-string">"i"</span><span class="hljs-tag">&gt;</span> 
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag"> </span><span class="hljs-attr">appearance</span><span class="hljs-tag">=</span><span class="hljs-string">"outline"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlex</span><span class="hljs-tag">=</span><span class="hljs-string">"100px"</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-label</span><span class="hljs-tag">&gt;</span>Type<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-label</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-select</span><span class="hljs-tag"> </span><span class="hljs-attr">formControlName</span><span class="hljs-tag">=</span><span class="hljs-string">"type"</span><span class="hljs-tag">&gt;</span>
          @for (type of PhoneTypes; track type) {
            <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-option</span><span class="hljs-tag"> [</span><span class="hljs-attr">value</span><span class="hljs-tag">]=</span><span class="hljs-string">"convertTypeToPhoneType(type)"</span><span class="hljs-tag">&gt;</span>
              {{ type }}
            <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-option</span><span class="hljs-tag">&gt;</span>
          }      
       <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-select</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag"> </span><span class="hljs-attr">appearance</span><span class="hljs-tag">=</span><span class="hljs-string">"outline"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlex</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlexOffset</span><span class="hljs-tag">=</span><span class="hljs-string">"10px"</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-label</span><span class="hljs-tag">&gt;</span>Number<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-label</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span><span class="hljs-attr">matInput</span><span class="hljs-tag"> </span><span class="hljs-attr">type</span><span class="hljs-tag">=</span><span class="hljs-string">"text"</span><span class="hljs-tag"> </span><span class="hljs-attr">formControlName</span><span class="hljs-tag">=</span><span class="hljs-string">"digits"</span>
<span class="hljs-tag">        </span><span class="hljs-attr">aria-label</span><span class="hljs-tag">=</span><span class="hljs-string">"Phone number"</span><span class="hljs-tag"> </span><span class="hljs-attr">prefix</span><span class="hljs-tag">=</span><span class="hljs-string">"+1"</span><span class="hljs-tag"> /&gt;</span>
        @if (phonesArray.controls[i].invalid &amp;&amp; 
             phonesArray.controls[i].touched) {
          <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>A valid phone number is required<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>
        }     
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">button</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlex</span><span class="hljs-tag">=</span><span class="hljs-string">"33px"</span><span class="hljs-tag"> </span><span class="hljs-attr">mat-icon-button</span>
<span class="hljs-tag">      (</span><span class="hljs-attr">click</span><span class="hljs-tag">)=</span><span class="hljs-string">"</span><span class="code-highlight"><strong class="hljs-string-slc">phonesArray.removeAt(i)</strong></span><span class="hljs-string">"</span><span class="hljs-tag">&gt;</span> 
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-icon</span><span class="hljs-tag">&gt;</span>delete<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-icon</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">button</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-list-item</span><span class="hljs-tag">&gt;</span>
  }
<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-list</span><span class="hljs-tag">&gt;</span> 
...
</code></pre>
    <div class="note">
      <p class="normal">Note the highlighted <code class="inlineCode">convertTypeToPhoneType</code> function, which converts a <code class="inlineCode">string</code> to <code class="inlineCode">enum PhoneType</code>.</p>
      <p class="normal">Also highlighted in the preceding code block is how the <code class="inlineCode">remove</code> function is implemented inline in the template, making it easier to read and maintain.</p>
    </div>
    <p class="normal">Let’s see how the dynamic array<a id="_idIndexMarker833"/> should be working:</p>
    <figure class="mediaobject"><img src="../Images/B20960_08_07.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 8.7: Multiple inputs using FormArray</p>
    <p class="normal">Now that we’re done inputting data, we can move on to the last step of the stepper, <strong class="keyWord">Review</strong>. However, as was mentioned earlier, the <strong class="keyWord">Review</strong> step uses the <code class="inlineCode">&lt;app-view-user&gt;</code> directive to display its data. Let’s build that view first.</p>
    <h1 id="_idParaDest-254" class="heading-1">Creating shared components</h1>
    <p class="normal">Here’s a minimal implementation<a id="_idIndexMarker834"/> of the <code class="inlineCode">&lt;app-view-user&gt;</code> directive, a prerequisite for the <strong class="keyWord">Review</strong> step.</p>
    <p class="normal">Create a new <code class="inlineCode">viewUser</code> component<a id="_idIndexMarker835"/> under the <code class="inlineCode">user</code> folder structure, as follows:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/view-user/view-user.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">AsyncPipe</span>, <span class="hljs-title">DatePipe</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common'</span>
<span class="hljs-keyword">import</span> {
  <span class="hljs-title">Component</span>, inject, <span class="hljs-title">Input</span>, <span class="hljs-title">OnChanges</span>, <span class="hljs-title">SimpleChanges</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">MatButtonModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/material/button'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">MatCardModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/material/card'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">MatIconModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/material/icon'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Router</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">IUser</span>, <span class="hljs-title">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../user/user'</span>
@<span class="hljs-title">Component</span>({
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-view-user'</span>,
  <span class="hljs-attr">template</span>: <span class="hljs-string">`</span>
<span class="hljs-string">    @if (currentUser) {</span>
<span class="hljs-string">      &lt;div&gt;</span>
<span class="hljs-string">        &lt;mat-card appearance="outlined"&gt;</span>
<span class="hljs-string">          &lt;mat-card-header&gt;</span>
<span class="hljs-string">            &lt;div mat-card-avatar&gt;</span>
<span class="hljs-string">              &lt;mat-icon&gt;account_circle&lt;/mat-icon&gt;</span>
<span class="hljs-string">            &lt;/div&gt;</span>
<span class="hljs-string">            &lt;mat-card-title&gt;{{ currentUser.fullName }}&lt;/mat-card-title&gt;</span>
<span class="hljs-string">            &lt;mat-card-subtitle&gt;{{ currentUser.role }}&lt;/mat-card-subtitle&gt;</span>
<span class="hljs-string">          &lt;/mat-card-header&gt;</span>
<span class="hljs-string">          &lt;mat-card-content&gt;</span>
<span class="hljs-string">            &lt;p&gt;&lt;span class="mat-input bold"&gt;E-mail&lt;/span&gt;&lt;/p&gt;</span>
<span class="hljs-string">            &lt;p&gt;{{ currentUser.email }}&lt;/p&gt;</span>
<span class="hljs-string">            &lt;p&gt;&lt;span class="mat-input bold"&gt;Date of Birth&lt;/span&gt;&lt;/p&gt;</span>
<span class="hljs-string">            &lt;p&gt;{{ currentUser.dateOfBirth | date: 'mediumDate' }}&lt;/p&gt;</span>
<span class="hljs-string">          &lt;/mat-card-content&gt;</span>
<span class="hljs-string">          @if (editMode) {</span>
<span class="hljs-string">            &lt;mat-card-actions&gt;</span>
<span class="hljs-string">              &lt;button mat-button mat-raised-button (click)="editUser(currentUser._id)"&gt;</span>
<span class="hljs-string">                Edit</span>
<span class="hljs-string">              &lt;/button&gt;</span>
<span class="hljs-string">            &lt;/mat-card-actions&gt;</span>
<span class="hljs-string">          }</span>
<span class="hljs-string">        &lt;/mat-card&gt;</span>
<span class="hljs-string">      &lt;/div&gt;</span>
<span class="hljs-string">    }</span>
<span class="hljs-string">  `</span>,
  <span class="hljs-attr">styles</span>: <span class="hljs-string">`</span>
<span class="hljs-string">    .bold {</span>
<span class="hljs-string">      font-weight: bold;</span>
<span class="hljs-string">    }</span>
<span class="hljs-string">`</span>,
  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">imports</span>: [<span class="hljs-title">MatCardModule</span>, <span class="hljs-title">MatIconModule</span>, <span class="hljs-title">MatButtonModule</span>, <span class="hljs-title">AsyncPipe</span>, <span class="hljs-title">DatePipe</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ViewUserComponent</span> implements <span class="hljs-title">OnChanges</span> {
  private readonly router = <span class="hljs-title">inject</span>(<span class="hljs-title">Router</span>)
  @<span class="hljs-title">Input</span>() user!: <span class="hljs-title">IUser</span>
  currentUser = <span class="hljs-keyword">new</span> <span class="hljs-title">User</span>()
  <span class="hljs-keyword">get</span> <span class="hljs-title">editMode</span>() {
    <span class="hljs-keyword">return</span> !<span class="hljs-variable">this</span>.<span class="hljs-property">user</span>
  }
  <span class="hljs-title">ngOnChanges</span>(<span class="hljs-attr">changes</span>: <span class="hljs-title">SimpleChanges</span>): <span class="hljs-keyword">void</span> {
    <span class="hljs-variable">this</span>.<span class="hljs-property">currentUser</span> = <span class="hljs-title">User</span>.<span class="hljs-title">Build</span>(changes[<span class="hljs-string">'user'</span>].<span class="hljs-property">currentValue</span>)
  }
  <span class="hljs-title">editUser</span>(<span class="hljs-params">id: string</span>) {
    <span class="hljs-variable">this</span>.<span class="hljs-property">router</span>.<span class="hljs-title">navigate</span>([<span class="hljs-string">'/user/profile'</span>, id])
  }
}
</code></pre>
    <p class="normal">The preceding component uses input binding with <code class="inlineCode">@Input</code> to get user data compliant with the <code class="inlineCode">IUser</code> interface from an outside component. We implement the <code class="inlineCode">ngOnChanges</code> lifecycle hook, which fires whenever the bound data changes. In this event, we hydrate the simple JSON object stored in the <code class="inlineCode">user</code> property as an instance of the <code class="inlineCode">User</code> class with <code class="inlineCode">User.Build</code>.</p>
    <p class="normal">We then assign the <code class="inlineCode">User</code> object to the property <code class="inlineCode">this.currentUser</code>. Even if we wanted to, we couldn’t directly bind to the user property, because calculated properties such as <code class="inlineCode">fullName</code> can only work if data is hydrated into an instance of the <code class="inlineCode">User</code> class. Angular 17.1 introduces signal-based inputs in developer preview. We could define user like <code class="inlineCode">user = input&lt;IUser&gt;()</code> and leverage effect and a computed signal to streamline our implementation. In the current state of our code, we incur a heavy change detection penalty given the number of properties we’re binding to. However in signal-based component there would be no such penalty. I look forward to refactoring this component, when signal-based components are released.</p>
    <p class="normal">Now, we are ready to complete the multi-step form.</p>
    <h1 id="_idParaDest-255" class="heading-1">Reviewing and saving form data</h1>
    <p class="normal">On the last step<a id="_idIndexMarker836"/> of the multistep form, users<a id="_idIndexMarker837"/> should be able to review<a id="_idIndexMarker838"/> and then save<a id="_idIndexMarker839"/> the form data. As a good practice, a successful <code class="inlineCode">POST</code> request will return the data that was saved back to the browser. We can then reload the form with the information received back from the server:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
<span class="hljs-keyword">async</span> <span class="hljs-title">save</span>(<span class="hljs-params">form: FormGroup</span>) {
    <span class="hljs-variable">this</span>.<span class="hljs-property">userService</span>
      .<span class="hljs-title">updateUser</span>(<span class="hljs-variable">this</span>.<span class="hljs-property">currentUserId</span>, form.<span class="hljs-property">value</span>)
      .<span class="hljs-title">pipe</span>(<span class="hljs-title">first</span>())
      .<span class="hljs-title">subscribe</span>({
        <span class="hljs-attr">next</span>: <span class="hljs-function">(</span><span class="hljs-params">res: IUser</span><span class="hljs-function">) =&gt;</span> {
          <span class="hljs-variable">this</span>.<span class="hljs-title">patchUser</span>(res)
          <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">formGroup</strong><strong class="hljs-slc">.</strong><strong class="hljs-title-slc">patchValue</strong><strong class="hljs-slc">(res)</strong></span>
          <span class="hljs-variable">this</span>.<span class="hljs-property">uiService</span>.<span class="hljs-title">showToast</span>(<span class="hljs-string">'Updated user'</span>)
        },
        <span class="hljs-attr">error</span>: <span class="hljs-function">(</span><span class="hljs-params">err: string</span><span class="hljs-function">) =&gt;</span> (<span class="hljs-variable">this</span>.<span class="hljs-property">userError</span> = err),
      })
  }
...
</code></pre>
    <div class="packt_tip">
      <p class="normal">Note that <code class="inlineCode">updateUser</code> returns the saved value of the user. It is possible that the database returns a different version of <code class="inlineCode">user</code> than what we had before, so we use <code class="inlineCode">formGroup.patchValue</code> to update the data powering the form. The form automatically updates to reflect any changes.</p>
    </div>
    <p class="normal">If there are errors when saving the data, they’ll be set to <code class="inlineCode">userError</code> to be displayed on the form. Before saving the data, we present it in a compact format with the reusable <code class="inlineCode">app-view-user</code> component, which we can bind the form data to:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.component.html</strong></span>
...
<span class="hljs-tag">&lt;</span><span class="hljs-name">mat-step</span><span class="hljs-tag"> [</span><span class="hljs-attr">stepControl</span><span class="hljs-tag">]=</span><span class="hljs-string">"formGroup"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">form</span><span class="hljs-tag"> [</span><span class="hljs-attr">formGroup</span><span class="hljs-tag">]=</span><span class="hljs-string">"formGroup"</span><span class="hljs-tag"> (</span><span class="hljs-attr">ngSubmit</span><span class="hljs-tag">)=</span><span class="hljs-string">"save(formGroup)"</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">ng-template</span><span class="hljs-tag"> </span><span class="hljs-attr">matStepLabel</span><span class="hljs-tag">&gt;</span>Review<span class="hljs-tag">&lt;/</span><span class="hljs-name">ng-template</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"stepContent"</span><span class="hljs-tag">&gt;</span>
      Review and update your user profile.
      <span class="code-highlight"><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">app-view-user</strong><strong class="hljs-tag-slc"> [</strong><strong class="hljs-attr-slc">user</strong><strong class="hljs-tag-slc">]=</strong><strong class="hljs-string-slc">"formGroup.getRawValue()"</strong><strong class="hljs-tag-slc">&gt;&lt;/</strong><strong class="hljs-name-slc">app-view-user</strong><strong class="hljs-tag-slc">&gt;</strong></span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayout</span><span class="hljs-tag">=</span><span class="hljs-string">"row"</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"margin-top"</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">button</span><span class="hljs-tag"> </span><span class="hljs-attr">mat-button</span><span class="hljs-tag"> </span><span class="hljs-attr">matStepperPrevious</span><span class="hljs-tag">&gt;</span>Back<span class="hljs-tag">&lt;/</span><span class="hljs-name">button</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"flex-spacer"</span><span class="hljs-tag">&gt;&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
      @if (userError) {
        <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"</span><span class="hljs-string">mat-caption error"</span><span class="hljs-tag">&gt;</span>{{ <span class="code-highlight"><strong class="hljs-slc">userError</strong></span> }}<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
      } 
      <span class="hljs-tag">&lt;</span><span class="hljs-name">button</span><span class="hljs-tag"> </span><span class="hljs-attr">mat-button</span><span class="hljs-tag"> </span><span class="hljs-attr">color</span><span class="hljs-tag">=</span><span class="hljs-string">"warn"</span><span class="hljs-tag"> (</span><span class="hljs-attr">click</span><span class="hljs-tag">)=</span><span class="hljs-string">"</span><span class="code-highlight"><strong class="hljs-string-slc">stepper.reset()</strong></span><span class="hljs-string">"</span><span class="hljs-tag">&gt;</span>
        Reset
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">button</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">button</span><span class="hljs-tag"> </span><span class="hljs-attr">mat-raised-button</span><span class="hljs-tag"> </span><span class="hljs-attr">matStepperNext</span><span class="hljs-tag"> </span><span class="hljs-attr">color</span><span class="hljs-tag">=</span><span class="hljs-string">"primary"</span><span class="hljs-tag"> </span>
<span class="hljs-tag">        </span><span class="hljs-attr">type</span><span class="hljs-tag">=</span><span class="hljs-string">"submit"</span><span class="hljs-tag"> [</span><span class="hljs-attr">disabled</span><span class="hljs-tag">]=</span><span class="hljs-string">"formGroup.invalid"</span><span class="hljs-tag">&gt;</span>
        Update
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">button</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">form</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-step</span><span class="hljs-tag">&gt;</span>
...
</code></pre>
    <div class="note">
      <p class="normal">Note that we use <code class="inlineCode">formGroup.getRawValue()</code> to extract the JSON of the form data. See how we bind <code class="inlineCode">userError</code> to display error messages. Also, the <strong class="screenText">Reset</strong> button uses <code class="inlineCode">stepper.reset()</code>, which can conveniently reset all the user input.</p>
    </div>
    <p class="normal">This is<a id="_idIndexMarker840"/> how<a id="_idIndexMarker841"/> the final<a id="_idIndexMarker842"/> product<a id="_idIndexMarker843"/> should appear:</p>
    <figure class="mediaobject"><img src="../Images/B20960_08_08.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 8.8: Review step</p>
    <p class="normal">Now that the user profile input is done, we are about halfway to our eventual goal of creating a master/detail view where a <strong class="keyWord">Manager</strong> can click on a user and view their profile details. We still have a lot more code to add, and along the way, we have fallen into a pattern of adding lots of boilerplate code to load the requisite data for a component.</p>
    <p class="normal">Next, let’s refactor our form<a id="_idIndexMarker844"/> to make our code reusable<a id="_idIndexMarker845"/> and scalable, so even<a id="_idIndexMarker846"/> if our form has dozens<a id="_idIndexMarker847"/> of fields, the code is still maintainable, and we don’t introduce an exponential cost increase to make changes.</p>
    <h1 id="_idParaDest-256" class="heading-1">Scalable form architecture with reusable parts</h1>
    <p class="normal">As mentioned in the introduction<a id="_idIndexMarker848"/> to the <em class="italic">Multi-step responsive forms</em> section, forms are tightly coupled beasts that can grow large, and using the wrong architectural pattern to scale your implementation can cause significant issues when implementing new features or maintaining existing ones.</p>
    <p class="normal">To demonstrate how you can break up your form into multiple parts, we will refactor it to extract the highlighted section in the following screenshot, the name <code class="inlineCode">FormGroup</code>, as its own component. The technique to accomplish this is the same as you’d use when you want to put each step of your form into a separate component:</p>
    <figure class="mediaobject"><img src="../Images/B20960_08_09.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 8.9: User profile’s name part highlighted</p>
    <p class="normal">By making the name <code class="inlineCode">FormGroup</code> reusable, you will also learn about how you can reuse the business logic that you build into that <code class="inlineCode">FormGroup</code> in other forms. We will extract the name <code class="inlineCode">FormGroup</code> logic into a new component<a id="_idIndexMarker849"/> named <code class="inlineCode">NameInputComponent</code>. In doing so, we also have an opportunity to extract some reusable form functionality to a <code class="inlineCode">BaseFormComponent</code> as an <code class="inlineCode">abstract</code> <code class="inlineCode">class</code>.</p>
    <p class="normal">There are going to be several components that are working together here, including <code class="inlineCode">ProfileComponent</code>, <code class="inlineCode">ViewUserComponent</code>, and <code class="inlineCode">NameInputComponent</code>. We need all the values in these three components to be up to date as the user enters them.</p>
    <p class="normal"><code class="inlineCode">ProfileComponent</code> will own the master form to which we’ll need to register any child form. Once we do this, all the form validation techniques you’ve learned so far will still apply.</p>
    <p class="normal">This is a key way to make your form able to scale across many components and continue to be easy to work with, without introducing unnecessary validation overhead. Hence, it is useful to review the different interactions between these objects to solidify your understanding of the asynchronous and decoupled nature of their behavior:</p>
    <figure class="mediaobject"><img src="../Images/B20960_08_10.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 8.10: Form component interactions</p>
    <div class="packt_tip">
      <p class="normal">In this section, we combine many of the concepts you’ve learned throughout the book. Utilize the preceding diagram to understand how the various form components interact.</p>
      <p class="normal">In the preceding diagram, properties in bold indicate data binding. Underlined function elements indicate event registrations. Arrows show the points of connection between the components.</p>
    </div>
    <p class="normal">The workflow begins with the instantiation<a id="_idIndexMarker850"/> of <code class="inlineCode">ProfileComponent</code>. The <code class="inlineCode">OnInit</code> event of the component begins building the <code class="inlineCode">formGroup</code> object, while asynchronously loading any potential <code class="inlineCode">initialData</code> that may need to be patched into the forms. Refer to the preceding diagram for a visual representation of <code class="inlineCode">initialData</code> coming in from a service or cache.</p>
    <p class="normal"><code class="inlineCode">NameInputComponent</code> is used in the <code class="inlineCode">ProfileComponent</code> form as <code class="inlineCode">&lt;app-name-input&gt;</code>. To synchronize <code class="inlineCode">initialData</code> with the <code class="inlineCode">NameInputComponent</code>, we bind a <code class="inlineCode">nameInitialData$</code> subject using the <code class="inlineCode">async</code> pipe, since <code class="inlineCode">initialData</code> comes in asynchronously.</p>
    <p class="normal"><code class="inlineCode">NameInputComponent</code> implements the <code class="inlineCode">OnChanges</code> lifecycle hook, so whenever <code class="inlineCode">nameInitialData$</code> updates, its value is patched into the <code class="inlineCode">NameInputComponent</code> form.</p>
    <p class="normal">Like <code class="inlineCode">ProfileComponent</code>, <code class="inlineCode">NameInputComponent</code> also implements the <code class="inlineCode">OnInit</code> event to construct its <code class="inlineCode">formGroup</code> object. Since this is an asynchronous event, <code class="inlineCode">NameInputComponent</code> needs to expose a <code class="inlineCode">formReady</code> event that <code class="inlineCode">ProfileComponent</code> can subscribe to. Once the <code class="inlineCode">formGroup</code> object is ready, we emit the event and the <code class="inlineCode">registerForm</code> function on <code class="inlineCode">ProfileComponent</code> triggers. <code class="inlineCode">registerForm</code> adds the <code class="inlineCode">formGroup</code> object of <code class="inlineCode">NameInputComponent</code> as a child element to the parent <code class="inlineCode">formGroup</code> on <code class="inlineCode">ProfileComponent</code>.</p>
    <p class="normal"><code class="inlineCode">ViewUserComponent</code> is used in the <code class="inlineCode">ProfileComponent</code> form as <code class="inlineCode">&lt;app-view-user&gt;</code>. When the values in the parent form change, we need <code class="inlineCode">&lt;app-view-user&gt;</code> to stay current. We bind to the <code class="inlineCode">user</code> property on <code class="inlineCode">ViewUserComponent</code>, which implements <code class="inlineCode">OnChanges</code> to receive updates. Every time there is an update, the <code class="inlineCode">User</code> object is hydrated from the <code class="inlineCode">IUser</code> object, so calculated fields such as <code class="inlineCode">fullName</code> can continue working. The updated <code class="inlineCode">User</code> is then assigned to <code class="inlineCode">currentUser</code>, bound to the template..</p>
    <p class="normal">We will begin by building<a id="_idIndexMarker851"/> a <code class="inlineCode">BaseFormComponent</code>, which <code class="inlineCode">NameInputComponent</code> and <code class="inlineCode">ProfileComponent</code> will then implement.</p>
    <h2 id="_idParaDest-257" class="heading-2">Abstract form component</h2>
    <p class="normal">We can share common functionality <a id="_idIndexMarker852"/>and standardize the implementation<a id="_idIndexMarker853"/> of all components that implement a form by implementing a base abstract class. An abstract class cannot be instantiated on its own because it wouldn’t make sense to do so, since it will not have a template, making it useless on its own.</p>
    <div class="packt_tip">
      <p class="normal">Note that <code class="inlineCode">BaseFormComponent</code> is just a <code class="inlineCode">class</code> and not an Angular component.</p>
    </div>
    <p class="normal"><code class="inlineCode">BaseFormComponent</code> will standardize the following:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">@Input initialData</code> and <code class="inlineCode">disable</code> as binding targets</li>
      <li class="bulletList">The <code class="inlineCode">@Output formReady</code> event</li>
      <li class="bulletList"><code class="inlineCode">formGroup</code>, and the <code class="inlineCode">FormGroup</code> to be used in the template’s <code class="inlineCode">buildForm</code> function to build the <code class="inlineCode">formGroup</code></li>
    </ul>
    <p class="normal">With the preceding assumptions, the base class can provide some generic functionality:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">patchUpdatedData</code> can update the data (partially or fully) in the <code class="inlineCode">formGroup</code> without rebuilding it.</li>
      <li class="bulletList"><code class="inlineCode">registerForm</code> and <code class="inlineCode">deregisterForm</code> can register or deregister child forms.</li>
      <li class="bulletList"><code class="inlineCode">deregisterAllForms</code> can automatically deregister any registered child form.</li>
      <li class="bulletList"><code class="inlineCode">hasChanged</code> can determine whether <code class="inlineCode">initialData</code> has changed, given a <code class="inlineCode">SimpleChange</code> object provided by the <code class="inlineCode">ngOnChange</code> event handler.</li>
      <li class="bulletList"><code class="inlineCode">patchUpdatedDataIfChanged</code> leverages <code class="inlineCode">hasChanged</code> and uses <code class="inlineCode">patchUpdatedData</code> to update the data if, and only if, there has been an update to <code class="inlineCode">initialData</code> and <code class="inlineCode">formGroup</code> is already initialized.</li>
    </ul>
    <p class="normal">Create a new<a id="_idIndexMarker854"/> class, <code class="inlineCode">BaseFormComponent</code>, under <code class="inlineCode">src/common</code> as <a id="_idIndexMarker855"/>follows:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/common/base-form.</strong><strong class="hljs-property-slc">class</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">EventEmitter</span>, <span class="hljs-title">Input</span>, <span class="hljs-title">Output</span>, <span class="hljs-title">SimpleChange</span>, <span class="hljs-title">SimpleChanges</span> } 
   <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">AbstractControl</span>, <span class="hljs-title">FormGroup</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/forms'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BaseFormComponent</span>&lt;<span class="hljs-title">TFormData</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span>&gt; {
  <span class="hljs-meta">@Input</span>() <span class="hljs-attr">initialData</span>: <span class="hljs-title">TFormData</span>
  <span class="hljs-meta">@Input</span>() <span class="hljs-attr">disable</span>: <span class="hljs-built_in">boolean</span>
  <span class="hljs-meta">@Output</span>() <span class="hljs-attr">formReady</span>: <span class="hljs-title">EventEmitter</span>&lt;<span class="hljs-title">AbstractControl</span>&gt;
  <span class="hljs-attr">formGroup</span>: <span class="hljs-title">FormGroup</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">registeredForms</span>: <span class="hljs-built_in">string</span>[] = []
  <span class="hljs-title">constructor</span>() {
    <span class="hljs-variable">this</span>.<span class="hljs-property">formReady</span> = <span class="hljs-keyword">new</span> <span class="hljs-title">EventEmitter</span>&lt;<span class="hljs-title">AbstractControl</span>&gt;(<span class="hljs-literal">true</span>)
  }
  <span class="hljs-keyword">abstract</span> <span class="hljs-title">buildForm</span>(initialData?: <span class="hljs-title">TFormData</span>): <span class="hljs-title">FormGroup</span>
  <span class="hljs-title">patchUpdatedData</span>(<span class="hljs-attr">data</span><span class="hljs-params">: </span><span class="hljs-built_in">object</span>) {
    <span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span>.<span class="hljs-title">patchValue</span>(data, { <span class="hljs-attr">onlySelf</span>: <span class="hljs-literal">false</span> })
  }
  <span class="hljs-title">patchUpdatedDataIfChanged</span>(<span class="hljs-attr">changes</span><span class="hljs-params">: </span><span class="hljs-title">SimpleChanges</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span> &amp;&amp; <span class="hljs-variable">this</span>.<span class="hljs-title">hasChanged</span>(changes.<span class="hljs-property">initialData</span>)) {
      <span class="hljs-variable">this</span>.<span class="hljs-title">patchUpdatedData</span>(<span class="hljs-variable">this</span>.<span class="hljs-property">initialData</span>)
    }
  }
  <span class="hljs-title">emitFormReady</span>(<span class="hljs-attr">control</span><span class="hljs-params">: </span><span class="hljs-title">AbstractControl</span><span class="hljs-params"> | </span><span class="hljs-literal">null</span><span class="hljs-params"> = </span><span class="hljs-literal">null</span>) {
    <span class="hljs-variable">this</span>.<span class="hljs-property">formReady</span>.<span class="hljs-title">emit</span>(control || <span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span>)
  }
  <span class="hljs-title">registerForm</span>(<span class="hljs-attr">name</span><span class="hljs-params">: </span><span class="hljs-built_in">string</span><span class="hljs-params">, </span><span class="hljs-attr">control</span><span class="hljs-params">: </span><span class="hljs-title">AbstractControl</span>) {
    <span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span>.<span class="hljs-title">setControl</span>(name, control)
    <span class="hljs-variable">this</span>.<span class="hljs-property">registeredForms</span>.<span class="hljs-title">push</span>(name)
  }
  <span class="hljs-title">deregisterForm</span>(<span class="hljs-attr">name</span><span class="hljs-params">: </span><span class="hljs-built_in">string</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span>.<span class="hljs-title">contains</span>(name)) {
      <span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span>.<span class="hljs-title">removeControl</span>(name)
    }
  }
  <span class="hljs-keyword">protected</span> <span class="hljs-title">deregisterAllForms</span>() {
    <span class="hljs-variable">this</span>.<span class="hljs-property">registeredForms</span>.<span class="hljs-title">forEach</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable">this</span>.<span class="hljs-title">deregisterForm</span>(name))
  }
  <span class="hljs-keyword">protected</span> <span class="hljs-title">hasChanged</span>(<span class="hljs-attr">change</span>: <span class="hljs-title">SimpleChange</span>): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">return</span> change?.<span class="hljs-property">previousValue</span> !== change?.<span class="hljs-property">currentValue</span>
  }
}
</code></pre>
    <p class="normal">Let’s implement <code class="inlineCode">NameInputComponent</code> using the <code class="inlineCode">BaseFormComponent</code>.</p>
    <h2 id="_idParaDest-258" class="heading-2">Implementing a reusable form part</h2>
    <p class="normal">Start by identifying<a id="_idIndexMarker856"/> the name <code class="inlineCode">FormGroup</code> in the <code class="inlineCode">profile</code> component code and template files:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">The following is the name <code class="inlineCode">FormGroup</code> implementation:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
<span class="hljs-attr">name</span>: <span class="hljs-variable">this</span>.<span class="hljs-property">formBuilder</span>.<span class="hljs-title">group</span>({
  <span class="hljs-attr">first</span>: [user?.<span class="hljs-property">name</span>?.<span class="hljs-property">first</span> || <span class="hljs-string">''</span>, <span class="hljs-title">RequiredTextValidation</span>],
  <span class="hljs-attr">middle</span>: [user?.<span class="hljs-property">name</span>?.<span class="hljs-property">middle</span> || <span class="hljs-string">''</span>, <span class="hljs-title">OneCharValidation</span>],
  <span class="hljs-attr">last</span>: [user?.<span class="hljs-property">name</span>?.<span class="hljs-property">last</span> || <span class="hljs-string">''</span>, <span class="hljs-title">RequiredTextValidation</span>],
}),
...
</code></pre>
      </li>
    </ol>
    <div class="packt_tip">
      <p class="normal">Note that when we move these validation rules to a new component, we still want them to be in effect when determining the overall validation status of the parent form. We achieve this using the <code class="inlineCode">registerForm</code> function we implemented in the previous section. Once our new <code class="inlineCode">FormGroup</code> is registered with the existing one, they work the same way as before our refactor.</p>
    </div>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Next is the name <code class="inlineCode">FormGroup</code> template:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.component.html</strong></span>
...
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayout</span><span class="hljs-tag">=</span><span class="hljs-string">"row"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayout.lt-sm</span><span class="hljs-tag">=</span><span class="hljs-string">"column"</span>
<span class="hljs-tag">  [</span><span class="hljs-attr">formGroup</span><span class="hljs-tag">]=</span><span class="hljs-string">"</span><span class="hljs-string">formGroup.get('name')"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayoutGap</span><span class="hljs-tag">=</span><span class="hljs-string">"10px"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag"> </span><span class="hljs-attr">appearance</span><span class="hljs-tag">=</span><span class="hljs-string">"outline"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlex</span><span class="hljs-tag">=</span><span class="hljs-string">"40%"</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-label</span><span class="hljs-tag">&gt;</span>First Name<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-label</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span><span class="hljs-attr">matInput</span><span class="hljs-tag"> </span><span class="hljs-attr">aria-label</span><span class="hljs-tag">=</span><span class="hljs-string">"First Name"</span><span class="hljs-tag"> </span>
<span class="hljs-tag">           </span><span class="hljs-attr">formControlName</span><span class="hljs-tag">=</span><span class="hljs-string">"first"</span><span class="hljs-tag"> #</span><span class="hljs-attr">name</span><span class="hljs-tag"> /&gt;</span>
    ...
<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
...
</code></pre>
      </li>
    </ol>
    <p class="normal">You will be moving<a id="_idIndexMarker857"/> most of this code to the new component.</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">Create a new <code class="inlineCode">NameInputComponent</code> under the <code class="inlineCode">user</code> folder.</li>
      <li class="numberedList">Extend the class from <code class="inlineCode">BaseFormComponent</code>.</li>
      <li class="numberedList">Inject <code class="inlineCode">FormBuilder</code> into the <code class="inlineCode">constructor</code>:</li>
    </ol>
    <div class="packt_tip">
      <p class="normal">For components with small or limited pieces of functionality, I prefer creating them with an inline template and styling so that it is easier to change the code from one place.</p>
    </div>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/name-input/name-input.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NameInputComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseFormComponent</span>&lt;<span class="hljs-title">IName</span>&gt; {
  <span class="hljs-title">constructor</span>(<span class="hljs-keyword">private</span><span class="hljs-params"> </span><span class="hljs-attr">formBuilder</span><span class="hljs-params">: </span><span class="hljs-title">FormBuilder</span>) {
    <span class="hljs-variable">super</span>()
  }
  <span class="hljs-title">buildForm</span>(initialData?: <span class="hljs-title">IName</span>): <span class="hljs-title">FormGroup</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title">Error</span>(<span class="hljs-string">"Method not implemented."</span>);
  }
  ...
}
</code></pre>
    <div class="packt_tip">
      <p class="normal">Remember that the base class already implements the <code class="inlineCode">formGroup</code>, <code class="inlineCode">initialData</code>, <code class="inlineCode">disable</code>, and <code class="inlineCode">formReady</code> properties, so you don’t need to redefine them.</p>
    </div>
    <div class="note">
      <p class="normal">Note that we must implement the <code class="inlineCode">buildForm</code> function, since it was defined as abstract. This is a great way to enforce standards across developers. Also, note that the implementing class can override any base function provided by simply redefining the function with the <code class="inlineCode">override</code> keyword. You’ll see this in action when we refactor the <code class="inlineCode">ProfileComponent</code>.</p>
    </div>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Implement the <code class="inlineCode">buildForm</code> function.</li>
      <li class="numberedList">Set the <code class="inlineCode">name</code> property<a id="_idIndexMarker858"/> part of the <code class="inlineCode">formGroup</code> in <code class="inlineCode">ProfileComponent</code> to <code class="inlineCode">null</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/name-input/name-input.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NameInputComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OnInit</span> {
  ...
  <span class="hljs-title">buildForm</span>(initialData?: <span class="hljs-title">IName</span>): <span class="hljs-title">FormGroup</span> {
    <span class="hljs-keyword">const</span> name = initialData
    <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-property">formBuilder</span>.<span class="hljs-title">group</span>({
      <span class="hljs-attr">first</span>: [name?.<span class="hljs-property">first</span> : <span class="hljs-string">''</span>, <span class="hljs-title">RequiredTextValidation</span>],
      <span class="hljs-attr">middle</span>: [name?.<span class="hljs-property">middle</span> : <span class="hljs-string">''</span>, <span class="hljs-title">OneCharValidation</span>], 
      <span class="hljs-attr">last</span>: [name?.<span class="hljs-property">last</span> : <span class="hljs-string">''</span>, <span class="hljs-title">RequiredTextValidation</span>],
    })
  }
</code></pre>
      </li>
      <li class="numberedList">Implement the template by bringing over the content from <code class="inlineCode">ProfileComponent</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/name-input/name-input.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-attr">template</span>: <span class="hljs-string">`</span>
<span class="hljs-string">    &lt;form [formGroup]="formGroup"&gt;</span>
<span class="hljs-string">      &lt;div fxLayout="row" fxLayout.lt-sm="column"</span>
<span class="hljs-string">        fxLayoutGap="10px"&gt;</span>
<span class="hljs-string">        ...</span>
<span class="hljs-string">      &lt;/div&gt;</span>
<span class="hljs-string">    &lt;/form&gt;</span>
<span class="hljs-string">  `</span>,
</code></pre>
      </li>
      <li class="numberedList">Implement the <code class="inlineCode">ngOnInit</code> event handler:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/name-input/name-input.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-title">ngOnInit</span>() {
  <span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span> = <span class="hljs-variable">this</span>.<span class="hljs-title">buildForm</span>(<span class="hljs-variable">this</span>.<span class="hljs-property">initialData</span>)
  <span class="hljs-variable">this</span>.<span class="hljs-property">formReady</span>.<span class="hljs-title">emit</span>(<span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span>)
}
</code></pre>
      </li>
    </ol>
    <div class="packt_tip">
      <p class="normal">Getting the <code class="inlineCode">ngOnInit</code> event handler’s implementation right in every <code class="inlineCode">BaseFormComponent</code> implementation is critical. The preceding example is fairly standard behavior for any <code class="inlineCode">child</code> component you may implement.</p>
      <p class="normal">Note that the implementation in <code class="inlineCode">ProfileComponent</code> will be a bit different.</p>
    </div>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="9">Implement the <code class="inlineCode">ngOnChanges</code> event handler, leveraging the base <code class="inlineCode">patchUpdatedDataIfChanged</code> behavior:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/name-input/name-input.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-title">ngOnChanges</span>(<span class="hljs-attr">changes</span><span class="hljs-params">: </span><span class="hljs-title">SimpleChanges</span>) {
  <span class="hljs-variable">this</span>.<span class="hljs-property">disable</span> ?
    <span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span>?.<span class="hljs-title">disable</span>() : <span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span>?.<span class="hljs-title">enable</span>()
  <span class="hljs-variable">this</span>.<span class="hljs-title">patchUpdatedDataIfChanged</span>(changes)
}
</code></pre>
      </li>
    </ol>
    <div class="packt_tip">
      <p class="normal">Note that in <code class="inlineCode">patchUpdatedDataIfChanged</code>, setting <code class="inlineCode">onlySelf</code> to <code class="inlineCode">false</code> will cause the parent form also to update. You can override the function if you’d like to optimize this behavior.</p>
    </div>
    <p class="normal">Now, you have a fully implemented <code class="inlineCode">NameInputComponent</code> that you can integrate<a id="_idIndexMarker859"/> into <code class="inlineCode">ProfileComponent</code>.</p>
    <div class="note">
      <p class="normal">To verify your <code class="inlineCode">ProfileComponent</code> code going forward, refer to <code class="inlineCode">projects/stage11/src/app/user/profile/profile.component.ts</code> and <code class="inlineCode">projects/stage11/src/app/user/profile/profile.component.html</code>.</p>
    </div>
    <p class="normal">Before you begin using <code class="inlineCode">NameInputComponent</code>, perform the following refactors.</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="10">Refactor <code class="inlineCode">ProfileComponent</code> to extend <code class="inlineCode">BaseFormComponent</code> and conform to its default values as needed.</li>
      <li class="numberedList">Define a readonly <code class="inlineCode">nameInitialData$</code> property with the <code class="inlineCode">BehaviorSubject&lt;IName&gt;</code> type, and initialize it with empty strings.</li>
      <li class="numberedList">Replace the content in <code class="inlineCode">ProfileComponent</code> with the new <code class="inlineCode">&lt;app-name-input&gt;</code> component:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.component.html</strong></span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">mat-horizontal-stepper</span><span class="hljs-tag"> #</span><span class="hljs-attr">stepper</span><span class="hljs-tag">=</span><span class="hljs-string">"matHorizontalStepper"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-step</span><span class="hljs-tag"> [</span><span class="hljs-attr">stepControl</span><span class="hljs-tag">]=</span><span class="hljs-string">"formGroup"</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">form</span><span class="hljs-tag"> [</span><span class="hljs-attr">formGroup</span><span class="hljs-tag">]=</span><span class="hljs-string">"formGroup"</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">ng-template</span><span class="hljs-tag"> </span><span class="hljs-attr">matStepLabel</span><span class="hljs-tag">&gt;</span>Account Information<span class="hljs-tag">&lt;/</span><span class="hljs-name">ng-template</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"stepContent"</span><span class="hljs-tag">&gt;</span>
          <span class="code-highlight"><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">app-name-input</strong><strong class="hljs-tag-slc"> [</strong><strong class="hljs-attr-slc">initialData</strong><strong class="hljs-tag-slc">]=</strong><strong class="hljs-string-slc">"nameInitialData$ | async"</strong></span>
            <span class="code-highlight"><strong class="hljs-tag-slc">(</strong><strong class="hljs-attr-slc">formReady</strong><strong class="hljs-tag-slc">)=</strong><strong class="hljs-string-slc">"registerForm('name', $event)"</strong><strong class="hljs-tag-slc">&gt;</strong></span>
          <span class="hljs-tag">&lt;/</span><span class="hljs-name">app-name-input</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
        ...
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">ng-template</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">form</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-step</span><span class="hljs-tag">&gt;</span>
  ...
<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-horizontal-stepper</span><span class="hljs-tag">&gt;</span>
</code></pre>
      </li>
    </ol>
    <p class="normal">Note that the base form component function, <code class="inlineCode">registerForm</code>, is leveraged here.</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="13">Ensure that your <code class="inlineCode">ngOnInit</code> is implemented<a id="_idIndexMarker860"/> correctly:</li>
    </ol>
    <div class="packt_tip">
      <p class="normal">Note that some additional refactors are present on the updated <code class="inlineCode">ProfileComponent</code>, such as the <code class="inlineCode">patchUser</code> function seen in the following snippet. Don’t miss these updates when you update your component.</p>
    </div>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-title">ngOnInit</span>() {
  <span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span> = <span class="hljs-variable">this</span>.<span class="hljs-title">buildForm</span>()
  <span class="hljs-variable">this</span>.<span class="hljs-property">authService</span>.<span class="hljs-property">currentUser$</span>
    .<span class="hljs-title">pipe</span>(
      <span class="hljs-title">filter</span>((user) =&gt; user != <span class="hljs-literal">null</span>),
      <span class="hljs-title">tap</span>((user) =&gt; <span class="hljs-variable">this</span>.<span class="hljs-title">patchUser</span>(user)),
      <span class="hljs-title">takeUntilDestroyed</span>(<span class="hljs-variable">this</span>.destroyRef)
    )
    .<span class="hljs-title">subscribe</span>()
}
</code></pre>
    <p class="normal">It is important to update the current form’s data with <code class="inlineCode">pathUpdatedData</code>, as well as <code class="inlineCode">nameInitialData$</code>, when there’s an update to <code class="inlineCode">initialData</code>.</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="14">Ensure that <code class="inlineCode">ngOnDestroy</code> is implemented correctly:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
  <span class="hljs-title">ngOnDestroy</span>() {
    <span class="hljs-variable">this</span>.<span class="hljs-title">deregisterAllForms</span>()
  }
</code></pre>
      </li>
    </ol>
    <p class="normal">You can leverage the base class functionality<a id="_idIndexMarker861"/> to deregister from all child forms automatically.</p>
    <p class="normal">Next, let’s learn about masking user input to increase our data quality.</p>
    <h1 id="_idParaDest-259" class="heading-1">Input masking</h1>
    <p class="normal">Masking user input<a id="_idIndexMarker862"/> is an input UX tool and also a data quality one. I’m a fan of the <code class="inlineCode">ngx-mask</code> library, which makes it easy to implement input masking in Angular. We will demonstrate input masking by updating the phone number input field, ensuring that users input a valid phone number, as shown in the following screenshot:</p>
    <figure class="mediaobject"><img src="../Images/B20960_08_11.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 8.11: Phone number field with input masking</p>
    <p class="normal">Set up your input masking as follows:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Install the library via npm with <code class="inlineCode">npm i ngx-mask</code>.</li>
      <li class="numberedList">Either use the environment<a id="_idIndexMarker863"/> provider, <code class="inlineCode">provideEnvironmentNgxMask()</code>, in <code class="inlineCode">app.config.ts</code> or <code class="inlineCode">provideNgxMask()</code> in your feature module, <code class="inlineCode">user.module.ts</code>.</li>
      <li class="numberedList">Import the <code class="inlineCode">NgxMaskDirective </code>in <code class="inlineCode">profile.component.html</code>:</li>
      <li class="numberedList">Update the <code class="inlineCode">number</code> field in <code class="inlineCode">ProfileComponent</code> as follows:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.component.html</strong></span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag"> </span><span class="hljs-attr">appearance</span><span class="hljs-tag">=</span><span class="hljs-string">"outline"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlex</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlexOffset</span><span class="hljs-tag">=</span><span class="hljs-string">"10px"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-label</span><span class="hljs-tag">&gt;</span>Number<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-label</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span><span class="hljs-attr">matInput</span><span class="hljs-tag"> </span><span class="hljs-attr">type</span><span class="hljs-tag">=</span><span class="hljs-string">"text"</span><span class="hljs-tag"> </span><span class="hljs-attr">formControlName</span><span class="hljs-tag">=</span><span class="hljs-string">"number"</span>
<span class="hljs-tag">    </span><span class="hljs-attr">prefix</span><span class="hljs-tag">=</span><span class="hljs-string">"+1"</span><span class="hljs-tag"> </span><span class="code-highlight"><strong class="hljs-attr-slc">mask</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"(000) 000-0000"</strong><strong class="hljs-tag-slc"> [</strong><strong class="hljs-attr-slc">showMaskTyped</strong><strong class="hljs-tag-slc">]=</strong><strong class="hljs-string-slc">"true"</strong></span><span class="hljs-tag"> /&gt;</span>
    @if (phonesArray.controls[i].invalid &amp;&amp; 
         phonesArray.controls[i].touched) {
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>A valid phone number is required<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>
    } 
<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag">&gt;</span>
</code></pre>
      </li>
    </ol>
    <p class="normal">And it’s that simple. You can learn more about the module and its capabilities on GitHub at <a href="https://github.com/JsDaddy/ngx-mask"><span class="url">https://github.com/JsDaddy/ngx-mask</span></a>.</p>
    <h1 id="_idParaDest-260" class="heading-1">Custom controls with ControlValueAccessor</h1>
    <p class="normal">So far, we’ve learned about forms<a id="_idIndexMarker864"/> using standard form controls and input controls provided by Angular Material. However, it is possible for you to create custom user controls. If you implement the <code class="inlineCode">ControlValueAccessor</code> interface, then your custom controls will play nicely with forms and the <code class="inlineCode">ControlValueAccessor</code> interface’s validation engine.</p>
    <p class="normal">We will be creating the custom rater control shown in the following screenshot and will place it as a control on the first step of <code class="inlineCode">ProfileComponent</code>:</p>
    <figure class="mediaobject"><img src="../Images/B20960_08_12.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 8.12: The lemon rater user control</p>
    <p class="normal">User controls are inherently highly reusable, tightly coupled, and customized components to enable <a id="_idIndexMarker865"/>rich user interactions. Let’s implement one.</p>
    <h2 id="_idParaDest-261" class="heading-2">Implementing a custom rating control</h2>
    <p class="normal">The Lemon Rater will dynamically highlight<a id="_idIndexMarker866"/> the number of lemons selected as the user interacts with the control in real time. As such, creating a high-quality custom control is an expensive endeavor. However, it is entirely worthwhile to spend the effort on elements of your application that define your brand and/or make up the core of the UX.</p>
    <div class="note">
      <p class="normal">The Lemon Rater is a modified version of Jennifer Wadella’s Galaxy Rating App sample found at <a href="https://github.com/tehfedaykin/galaxy-rating-app"><span class="url">https://github.com/tehfedaykin/galaxy-rating-app</span></a>. I highly recommend watching Jennifer’s Ng-Conf 2019 talk on <code class="inlineCode">ControlValueAccessor</code>, linked in the <em class="italic">Further reading</em> section.</p>
    </div>
    <p class="normal">Set up your custom rating control as follows:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Generate a new component called <code class="inlineCode">LemonRater</code> under the <code class="inlineCode">user-controls</code> folder.</li>
      <li class="numberedList">In <code class="inlineCode">LemonRater</code>, implement the <code class="inlineCode">ControlValueAccess</code> interface:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user-controls/lemon-rater/lemon-rater.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LemonRaterComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ControlValueAccessor</span> {
  disabled = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">internalValue</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title">value</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-property">internalValue</span>
  }
  <span class="hljs-attr">onChanged</span>: <span class="hljs-built_in">any</span> = <span class="hljs-function">() =&gt;</span> {}
  <span class="hljs-attr">onTouched</span>: <span class="hljs-built_in">any</span> = <span class="hljs-function">() =&gt;</span> {}
  <span class="hljs-title">writeValue</span>(<span class="hljs-attr">obj</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable">this</span>.<span class="hljs-property">internalValue</span> = obj
  }
  <span class="hljs-title">registerOnChange</span>(<span class="hljs-attr">fn</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable">this</span>.<span class="hljs-property">onChanged</span> = fn
  }
  <span class="hljs-title">registerOnTouched</span>(<span class="hljs-attr">fn</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable">this</span>.<span class="hljs-property">onTouched</span> = fn
  }
  setDisabledState?(<span class="hljs-attr">isDisabled</span>: <span class="hljs-built_in">boolean</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable">this</span>.<span class="hljs-property">disabled</span> = isDisabled
  }
}
</code></pre>
      </li>
      <li class="numberedList">Add the <code class="inlineCode">NG_VALUE_ACCESSOR</code> provider with the <code class="inlineCode">multi</code> property set to <code class="inlineCode">true</code>. This will register our component<a id="_idIndexMarker867"/> with the form’s change events, so form values can be updated when the user interacts with the rater:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user-controls/lemon-rater/lemon-rater.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-meta">@Component</span>({
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-lemon-rater'</span>,   
  <span class="hljs-attr">templateUrl</span>: <span class="hljs-string">'lemon-rater.component.html'</span>,
  <span class="hljs-attr">styleUrls</span>: [<span class="hljs-string">'lemon-rater.component.css'</span>],
  <span class="hljs-attr">providers</span>: [
    {
      <span class="hljs-attr">provide</span>: <span class="hljs-variable">NG_VALUE_ACCESSOR</span>,
      <span class="hljs-attr">useExisting</span>: <span class="hljs-title">forwardRef</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title">LemonRaterComponent</span>),
      <span class="hljs-attr">multi</span>: <span class="hljs-literal">true</span>,
    },
  ],  
  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">imports</span>: [<span class="hljs-title">NgClass</span>],
</code></pre>
        <div class="note">
          <p class="normal"><code class="inlineCode">forwardRef</code> allows us<a id="_idIndexMarker868"/> to refer to components<a id="_idIndexMarker869"/> not yet defined. There’s more at <a href="https://angular.dev/api/core/forwardRef"><span class="url">https://angular.dev/api/core/forwardRef</span></a>.</p>
        </div>
      </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Implement a custom rating scheme with a function, allowing us to set the selected rating based on user input:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user-controls/lemon-rater/lemon-rater.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LemonRaterComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ControlValueAccessor</span> { 
  <span class="hljs-meta">@ViewChild</span>(<span class="hljs-string">'displayText'</span>, { <span class="hljs-attr">static</span>: <span class="hljs-literal">false</span> }) displayTextRef!: <span class="hljs-title">ElementRef</span>
  disabled = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">private</span> internalValue!: <span class="hljs-built_in">number</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title">value</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-property">internalValue</span>
  }
  
  ratings = <span class="hljs-title">Object</span>.<span class="hljs-title">freeze</span>([
    {
      <span class="hljs-attr">value</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">text</span>: <span class="hljs-string">'no zest'</span>,
    },
    {
      <span class="hljs-attr">value</span>: <span class="hljs-number">2</span>,
      <span class="hljs-attr">text</span>: <span class="hljs-string">'neither a lemon or a lime '</span>,
    },
    {
      <span class="hljs-attr">value</span>: <span class="hljs-number">3</span>,
      <span class="hljs-attr">text</span>: <span class="hljs-string">'a true lemon'</span>,
    },
  ])
  ...
  <span class="hljs-title">setRating</span>(<span class="hljs-attr">lemon</span><span class="hljs-params">: </span><span class="hljs-built_in">any</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">this</span>.<span class="hljs-property">disabled</span>) {
      <span class="hljs-variable">this</span>.<span class="hljs-property">internalValue</span> = lemon.<span class="hljs-property">value</span>
      <span class="hljs-variable">this</span>.<span class="hljs-property">ratingText</span> = lemon.<span class="hljs-property">text</span>
      <span class="hljs-variable">this</span>.<span class="hljs-title">onChanged</span>(lemon.<span class="hljs-property">value</span>)
      <span class="hljs-variable">this</span>.<span class="hljs-title">onTouched</span>()
    }
  }
  <span class="hljs-title">setDisplayText</span>() {
    <span class="hljs-variable">this</span>.<span class="hljs-title">setSelectedText</span>(<span class="hljs-variable">this</span>.<span class="hljs-property">internalValue</span>)
  }
  <span class="hljs-keyword">private</span> <span class="hljs-title">setSelectedText</span>(<span class="hljs-attr">value</span><span class="hljs-params">: </span><span class="hljs-built_in">number</span>) {
    <span class="hljs-variable">this</span>.<span class="hljs-property">displayTextRef</span>.<span class="hljs-property">nativeElement</span>.<span class="hljs-property">textContent</span> = 
      <span class="hljs-variable">this</span>.<span class="hljs-title">getSelectedText</span>(value)
  }
  <span class="hljs-keyword">private</span> <span class="hljs-title">getSelectedText</span>(<span class="hljs-attr">value</span><span class="hljs-params">: </span><span class="hljs-built_in">number</span>) {
    <span class="hljs-keyword">let</span> text = <span class="hljs-string">''</span>
    <span class="hljs-keyword">if</span> (value) {
      text = <span class="hljs-variable">this</span>.<span class="hljs-property">ratings</span>
        .<span class="hljs-title">find</span>(<span class="hljs-function">(</span><span class="hljs-params">i</span><span class="hljs-function">) =&gt;</span> i.<span class="hljs-property">value</span> === value)?.<span class="hljs-property">text</span> || <span class="hljs-string">''</span>
    }
    <span class="hljs-keyword">return</span> text
  }
}
</code></pre>
      
    <div class="packt_tip">
      <p class="normal">Note that by using <code class="inlineCode">@ViewChild</code>, we’re getting the HTML element named <code class="inlineCode">#displayText</code> (highlighted in the following template). Using <code class="inlineCode">setSelectText</code>, we replace the <code class="inlineCode">textContent</code> of the element.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Implement the template, referring<a id="_idIndexMarker870"/> to the sample code for the contents of the <code class="inlineCode">svg</code> tag:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user-controls/lemon-rater/lemon-rater.component.html</strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">i</strong><strong class="hljs-tag-slc"> #</strong><strong class="hljs-attr-slc">displayText</strong><strong class="hljs-tag-slc">&gt;&lt;/</strong><strong class="hljs-name-slc">i</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc"> </strong></span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"lemons"</span><span class="hljs-tag"> [</span><span class="hljs-attr">ngClass</span><span class="hljs-tag">]=</span><span class="hljs-string">"{'disabled': disabled}"</span><span class="hljs-tag">&gt;</span> 
  @for (lemon of ratings; track lemon) { 
    <span class="hljs-tag">&lt;</span><span class="hljs-name">svg</span><span class="hljs-tag"> </span><span class="hljs-attr">width</span><span class="hljs-tag">=</span><span class="hljs-string">"24px"</span><span class="hljs-tag"> </span><span class="hljs-attr">height</span><span class="hljs-tag">=</span><span class="hljs-string">"24px"</span><span class="hljs-tag"> </span><span class="hljs-attr">viewBox</span><span class="hljs-tag">=</span><span class="hljs-string">"0 0 513 513"</span>
<span class="hljs-tag">         [</span><span class="hljs-attr">attr.title</span><span class="hljs-tag">]=</span><span class="hljs-string">"lemon.text"</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"lemon rating"</span>
<span class="hljs-tag">         [</span><span class="hljs-attr">ngClass</span><span class="hljs-tag">]=</span><span class="hljs-string">"{'selected': lemon.value &lt;= value}"</span>
<span class="hljs-tag">         (</span><span class="hljs-attr">mouseover</span><span class="hljs-tag">)=</span>
<span class="hljs-tag">           </span><span class="hljs-string">"displayText.textContent = !disabled ? lemon.text : ''"</span>
<span class="hljs-tag">         (</span><span class="hljs-attr">mouseout</span><span class="hljs-tag">)=</span><span class="hljs-string">"setDisplayText()"</span>
<span class="hljs-tag">         (</span><span class="hljs-attr">click</span><span class="hljs-tag">)=</span><span class="hljs-string">"setRating(lemon)"</span>
<span class="hljs-tag">     &gt;</span>
     ...
     <span class="hljs-tag">&lt;/</span><span class="hljs-name">svg</span><span class="hljs-tag">&gt;</span>
  }
<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
</code></pre>
      
    <p class="normal">The three most important attributes in the template are <code class="inlineCode">mouseover</code>, <code class="inlineCode">mouseout</code>, and <code class="inlineCode">click</code>. The <code class="inlineCode">mouseover</code> attribute displays the text for the rating the user is currently hovering over, <code class="inlineCode">mouseout</code> resets the display text to the selected value, and <code class="inlineCode">click</code> calls the <code class="inlineCode">setRating</code> method we implemented to record the user’s selection. However, the control can have even richer user interactivity by highlighting the number of lemons when the user hovers over a rating or selects it. We will accomplish this via some CSS magic.</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">Implement the CSS for the user control:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user-controls/lemon-rater/lemon-rater.component.css</strong></span>
<span class="hljs-selector-class">.lemons</span> {
  <span class="hljs-attribute">cursor</span>: pointer;
}
<span class="hljs-selector-class">.lemons</span><span class="hljs-selector-pseudo">:hover</span> <span class="hljs-selector-class">.lemon</span> <span class="hljs-selector-id">#fill-area</span> {
  <span class="hljs-attribute">fill</span>: <span class="hljs-number">#ffe200</span> <span class="hljs-meta">!important</span>;
}
<span class="hljs-selector-class">.lemons.disabled</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">cursor</span>: not-allowed;
}
<span class="hljs-selector-class">.lemons.disabled</span><span class="hljs-selector-pseudo">:hover</span> <span class="hljs-selector-class">.lemon</span> <span class="hljs-selector-id">#fill-area</span> {
  <span class="hljs-attribute">fill</span>: <span class="hljs-number">#d8d8d8</span> <span class="hljs-meta">!important</span>;
}
<span class="hljs-selector-class">.lemons</span> <span class="hljs-selector-class">.lemon</span> {
  <span class="hljs-attribute">float</span>: left; <span class="hljs-attribute">margin</span>: <span class="hljs-number">0px</span> <span class="hljs-number">5px</span>;
}
<span class="hljs-selector-class">.lemons</span> <span class="hljs-selector-class">.lemon</span> <span class="hljs-selector-id">#fill-area</span> {
  <span class="hljs-attribute">fill</span>: <span class="hljs-number">#d8d8d8</span>;
}
<span class="hljs-selector-class">.lemons</span> <span class="hljs-selector-class">.lemon</span><span class="hljs-selector-pseudo">:hover</span>~<span class="hljs-selector-class">.lemon</span> <span class="hljs-selector-id">#fill-area</span> {
  <span class="hljs-attribute">fill</span>: <span class="hljs-number">#d8d8d8</span> <span class="hljs-meta">!important</span>;
}
<span class="hljs-selector-class">.lemons</span> <span class="hljs-selector-class">.lemon.selected</span> <span class="hljs-selector-id">#fill-area</span> {
  <span class="hljs-attribute">fill</span>: <span class="hljs-number">#ffe200</span> <span class="hljs-meta">!important</span>;
}
<span class="hljs-selector-class">.lemons</span> <span class="hljs-selector-class">.dad.heart</span> <span class="hljs-selector-id">#ada</span> { 
  <span class="hljs-attribute">fill</span>: <span class="hljs-number">#6a0dad</span> <span class="hljs-meta">!important</span>;
}
</code></pre>
      </li>
    </ol>
    <p class="normal">The most interesting bit is with <code class="inlineCode">.lemons .lemon:hover~.lemon #fill-area</code>. Note that the operator <code class="inlineCode">~</code> , or the general sibling combinator, selects a range of elements so that a dynamic number of lemons will be highlighted<a id="_idIndexMarker871"/> as the user hovers over them.</p>
    <div class="packt_tip">
      <p class="normal"><code class="inlineCode">#fill-area</code> refers to a <code class="inlineCode">&lt;path&gt;</code> defined <a id="_idIndexMarker872"/>within the lemon .<code class="inlineCode">svg</code>, allowing the lemon’s color to be adjusted dynamically. I had to manually inject this ID field into the .<code class="inlineCode">svg</code> file.</p>
    </div>
    <p class="normal">Now, let’s see how you can use this new user control in a form.</p>
    <h2 id="_idParaDest-262" class="heading-2">Using custom controls in forms</h2>
    <p class="normal">We will use the lemon rater<a id="_idIndexMarker873"/> in the <code class="inlineCode">profile</code> component<a id="_idIndexMarker874"/> to capture the Limoncu level of the employee.</p>
    <div class="packt_tip">
      <p class="normal">Limoncu is a Turkish word for a person who grows or sells lemons, and it is also LemonMart’s proprietary employee engagement and performance measurement system.</p>
    </div>
    <p class="normal">Let’s integrate the lemon rater:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Start by importing the <code class="inlineCode">LemonRaterComponent</code> in <code class="inlineCode">profile.component.ts</code>.</li>
      <li class="numberedList">Ensure that the level form control is initialized in <code class="inlineCode">buildForm</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-meta">buildForm</span>(initialData?: <span class="hljs-meta">IUser</span>): <span class="hljs-meta">FormGroup</span> {
  ...
  <span class="hljs-attr">level</span>: [user?.level || <span class="hljs-attr">0</span>, Validators.required], 
  ...
}
</code></pre>
      </li>
      <li class="numberedList">Insert the lemon rater as the last element of the first <code class="inlineCode">mat-step</code>, inside the <code class="inlineCode">form</code> element:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.component.html</strong></span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayout</span><span class="hljs-tag">=</span><span class="hljs-string">"row"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayout.lt-sm</span><span class="hljs-tag">=</span><span class="hljs-string">"column"</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"margin-top"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayoutGap</span><span class="hljs-tag">=</span><span class="hljs-string">"10px"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-label</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"mat-body-1"</span><span class="hljs-tag">&gt;</span>Select the Limoncu level:
    <span class="hljs-tag">&lt;</span><span class="hljs-name">app-lemon-rater</span><span class="hljs-tag"> </span><span class="hljs-attr">formControlName</span><span class="hljs-tag">=</span><span class="hljs-string">"level"</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">app-lemon-rater</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-label</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
</code></pre>
      </li>
    </ol>
    <p class="normal">We integrate with the custom control by implementing <code class="inlineCode">formControlName</code> like any other control.</p>
    <p class="normal">Congratulations! You should<a id="_idIndexMarker875"/> have a working custom control<a id="_idIndexMarker876"/> that is integrated with your form.</p>
    <h1 id="_idParaDest-263" class="heading-1">Layouts using a grid list</h1>
    <p class="normal">The Flex Layout<a id="_idIndexMarker877"/> library is great<a id="_idIndexMarker878"/> for laying out content using CSS Flexbox. Angular Material provides another mechanism to lay out content, using CSS Grid with its Grid List functionality. A good way to demonstrate this functionality is by implementing a helpful list of fake login information in the <code class="inlineCode">LoginComponent</code>, demonstrated here:</p>
    <figure class="mediaobject"><img src="../Images/B20960_08_13.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 8.13: Login helper with the grid list</p>
    <p class="normal">Implement your<a id="_idIndexMarker879"/> list as<a id="_idIndexMarker880"/> follows:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Start by defining a <code class="inlineCode">roles</code> property that is an array of all the roles:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/login/login.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
roles = <span class="hljs-title">Object</span>.<span class="hljs-title">keys</span>(<span class="hljs-title">Role</span>)
</code></pre>
      </li>
      <li class="numberedList">Import <code class="inlineCode">MatExpansionModule</code> and <code class="inlineCode">MatGridListModule</code> in <code style="font-weight: bold;" class="codeHighlighted">login.component.ts</code>.</li>
      <li class="numberedList">Implement a new <code class="inlineCode">mat-card-content</code> below the existing one:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/login/login.component.html</strong></span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayout</span><span class="hljs-tag">=</span><span class="hljs-string">"row"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayoutAlign</span><span class="hljs-tag">=</span><span class="hljs-string">"center"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-card</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlex</span><span class="hljs-tag">=</span><span class="hljs-string">"400px"</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-card-header</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-card-title</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"mat-headline"</span><span class="hljs-tag">&gt;</span>Hello, Limoncu!<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-card-title</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-card-header</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-card-content</span><span class="hljs-tag">&gt;</span>
      ...
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-card-content</span><span class="hljs-tag">&gt;</span>
    <span class="code-highlight"><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">mat-card-content</strong><strong class="hljs-tag-slc">&gt;</strong></span>
    <span class="code-highlight"><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">mat-card-content</strong><strong class="hljs-tag-slc">&gt;</strong></span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-card</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
</code></pre>
      </li>
      <li class="numberedList">Inside the new <code class="inlineCode">mat-card-content</code>, put in a label<a id="_idIndexMarker881"/> to display the authentication<a id="_idIndexMarker882"/> mode:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/login/login.component.html</strong></span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayout</span><span class="hljs-tag">=</span><span class="hljs-string">"row"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayoutAlign</span><span class="hljs-tag">=</span><span class="hljs-string">"start center"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayoutGap</span><span class="hljs-tag">=</span><span class="hljs-string">"10px"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">span</span><span class="hljs-tag">&gt;</span>Authentication Mode: <span class="hljs-tag">&lt;/</span><span class="hljs-name">span</span><span class="hljs-tag">&gt;&lt;</span><span class="hljs-name">i</span><span class="hljs-tag">&gt;</span>{{ authMode }}<span class="hljs-tag">&lt;/</span><span class="hljs-name">i</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
</code></pre>
      </li>
      <li class="numberedList">Beneath the label, implement an expansion list:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/login/login.component.html</strong></span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">mat-accordion</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-expansion-panel</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-expansion-panel-header</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-panel-title</span><span class="hljs-tag">&gt;</span>
          Fake Login Info
        <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-panel-title</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-expansion-panel-header</span><span class="hljs-tag">&gt;</span>
    ...
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-expansion-panel</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-accordion</span><span class="hljs-tag">&gt;</span>
</code></pre>
      </li>
      <li class="numberedList">After <code class="inlineCode">mat-expansion-panel-header</code>, in the area marked with ellipses in the preceding step, implement a table of roles and email addresses, along with some hint text regarding password length, using <code class="inlineCode">mat-grid-list</code>, as shown in the following code block:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/login/login.component.html</strong></span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">mat-grid-list</span><span class="hljs-tag"> </span><span class="hljs-attr">cols</span><span class="hljs-tag">=</span><span class="hljs-string">"3"</span><span class="hljs-tag"> </span><span class="hljs-attr">rowHeight</span><span class="hljs-tag">=</span><span class="hljs-string">"48px"</span><span class="hljs-tag"> </span><span class="hljs-attr">role</span><span class="hljs-tag">=</span><span class="hljs-string">"list"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-grid-tile</span><span class="hljs-tag"> [</span><span class="code-highlight"><strong class="hljs-attr-slc">colspan</strong></span><span class="hljs-tag">]=</span><span class="hljs-string">"3"</span><span class="hljs-tag"> </span><span class="hljs-attr">role</span><span class="hljs-tag">=</span><span class="hljs-string">"listitem"</span>
<span class="hljs-tag">  </span><span class="hljs-attr">style</span><span class="hljs-tag">=</span><span class="hljs-string">"background: pink"</span><span class="hljs-tag">&gt;</span>
    Use any 8 character string as password
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-grid-tile</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-grid-tile</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-grid-tile-header</span><span class="hljs-tag">&gt;</span>Role<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-grid-tile-header</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-grid-tile</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-grid-tile</span><span class="hljs-tag"> [</span><span class="hljs-attr">colspan</span><span class="hljs-tag">]=</span><span class="hljs-string">"2"</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-grid-tile-header</span><span class="hljs-tag">&gt;</span>E-mail<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-grid-tile-header</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-grid-tile</span><span class="hljs-tag">&gt;</span>
  @for (role of roles; track role; let oddRow = $odd) {
    <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-grid-tile</span>
<span class="hljs-tag">        </span><span class="hljs-attr">role</span><span class="hljs-tag">=</span><span class="hljs-string">"listitem"</span>
<span class="hljs-tag">        [</span><span class="hljs-attr">style.background</span><span class="hljs-tag">]=</span><span class="hljs-string">"oddRow ? 'lightGray' : 'white'"</span><span class="hljs-tag">&gt;</span>
        {{ role }}
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-grid-tile</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-grid-tile</span>
<span class="hljs-tag">        [</span><span class="hljs-attr">colspan</span><span class="hljs-tag">]=</span><span class="hljs-string">"2"</span>
<span class="hljs-tag">        </span><span class="hljs-attr">role</span><span class="hljs-tag">=</span><span class="hljs-string">"listitem"</span>
<span class="hljs-tag">        [</span><span class="hljs-attr">style.background</span><span class="hljs-tag">]=</span><span class="hljs-string">"oddRow ? 'lightGray' : 'white'"</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">fxFlex</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayoutAlign</span><span class="hljs-tag">=</span><span class="hljs-string">"end center"</span><span class="hljs-tag">&gt;</span>
          @if (role.toLowerCase() === 'none') {
            <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>Any <span class="hljs-symbol">&amp;#64;</span>test.com email<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
          } @else {
            {{ role.toLowerCase() }}<span class="hljs-symbol">&amp;#64;</span>test.com
          }
          <span class="hljs-tag">&lt;</span><span class="hljs-name">button</span>
<span class="hljs-tag">            </span><span class="hljs-attr">mat-button</span>
<span class="hljs-tag">            (</span><span class="hljs-attr">click</span><span class="hljs-tag">)=</span><span class="hljs-string">"</span>
<span class="hljs-string">              this.loginForm.patchValue({</span>
<span class="hljs-string">                email: role.toLowerCase() + '@test.com',</span>
<span class="hljs-string">                password: 'whatever'</span>
<span class="hljs-string">              })</span>
<span class="hljs-string">            "</span><span class="hljs-tag">&gt;</span>
            Fill
          <span class="hljs-tag">&lt;/</span><span class="hljs-name">button</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-grid-tile</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
  }
<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-grid-list</span><span class="hljs-tag">&gt;</span>
</code></pre>
      </li>
    </ol>
    <p class="normal">We use <code class="inlineCode">colspan</code> to control<a id="_idIndexMarker883"/> the width of each row <a id="_idIndexMarker884"/>and cell. We leverage <code class="inlineCode">fxLayoutAlign</code> to right-align the contents of the <strong class="screenText">E-mail</strong> column. We use <code class="inlineCode">@if; @else</code> control flow operators to selectively display content. Finally, a <strong class="screenText">Fill</strong> button helps<a id="_idIndexMarker885"/> us to populate the login form with fake<a id="_idIndexMarker886"/> login information.</p>
    <div class="note">
      <p class="normal">In your application, you can use an expansion panel to communicate password complexity requirements to your users.</p>
    </div>
    <p class="normal">You can read more<a id="_idIndexMarker887"/> about expansion<a id="_idIndexMarker888"/> panels at <a href="https://material.angular.io/components/expansion"><span class="url">https://material.angular.io/components/expansion</span></a> and Grid List at <a href="https://material.angular.io/components/grid-list/overview"><span class="url">https://material.angular.io/components/grid-list/overview</span></a>.</p>
    <h1 id="_idParaDest-264" class="heading-1">Restoring cached data</h1>
    <p class="normal">At the beginning of the chapter, when implementing<a id="_idIndexMarker889"/> the <code class="inlineCode">updateUser</code> method in <code class="inlineCode">UserService</code>, we cached the <code class="inlineCode">user</code> object in case of any errors that may wipe out user-provided data:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/user/user.</strong><strong class="hljs-property-slc">service</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-title">updateUser</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">user</span>: <span class="hljs-title">IUser</span>): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">IUser</span>&gt; {
  ...
  <span class="hljs-title">This</span>.<span class="hljs-property">cache</span>.<span class="hljs-title">setItem</span>(<span class="hljs-string">'draft-user'</span>, user)
  ...
}
</code></pre>
    <p class="normal">Consider a scenario where the user may be temporarily offline when they attempt to save their data. In this case, our <code class="inlineCode">updateUser</code> function will save the data.</p>
    <p class="normal">Let’s see how we can restore this data in <code class="inlineCode">ProfileComponent</code> when loading the user profile:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Start by adding functions named <code class="inlineCode">loadFromCache</code> and <code class="inlineCode">clearCache</code> to the <code class="inlineCode">ProfileComponent</code> class:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">private</span> <span class="hljs-title">loadFromCache</span>(): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">User</span> | <span class="hljs-literal">null</span>&gt; {
  <span class="hljs-keyword">let</span> user = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> draftUser = <span class="hljs-variable">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title">getItem</span>(<span class="hljs-string">'draft-user'</span>)
    <span class="hljs-keyword">if</span> (draftUser != <span class="hljs-literal">null</span>) {
      user = <span class="hljs-title">User</span>.<span class="hljs-title">Build</span>(<span class="hljs-title">JSON</span>.<span class="hljs-title">parse</span>(draftUser))
    }
    <span class="hljs-keyword">if</span> (user) {
      <span class="hljs-variable">this</span>.<span class="hljs-property">uiService</span>.<span class="hljs-title">showToast</span>(<span class="hljs-string">'</span><span class="hljs-string">Loaded data from cache'</span>)
    }
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable">this</span>.<span class="hljs-title">clearCache</span>()
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title">of</span>(user)
} 
<span class="hljs-title">clearCache</span>() {
  <span class="hljs-variable">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title">removeItem</span>(<span class="hljs-string">'</span><span class="hljs-string">draft-user'</span>)
}
</code></pre>
      
    <div class="packt_tip">
      <p class="normal">After loading the data, we parse the data into a JSON object, using <code class="inlineCode">JSON.parse</code>, and then hydrate the <code class="inlineCode">User</code> object with <code class="inlineCode">User.Build</code>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">Update the template<a id="_idIndexMarker890"/> to call the <code class="inlineCode">clearCache</code> function so that when the user resets the form, we also clear the cache:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile.component.html</strong></span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">button</span><span class="hljs-tag"> </span><span class="hljs-attr">mat-button</span><span class="hljs-tag"> </span><span class="hljs-attr">color</span><span class="hljs-tag">=</span><span class="hljs-string">"</span><span class="hljs-string">warn"</span>
<span class="hljs-tag">    (</span><span class="hljs-attr">click</span><span class="hljs-tag">)=</span><span class="hljs-string">"stepper.reset(); </span><span class="code-highlight"><strong class="hljs-string-slc">clearCache()</strong></span><span class="hljs-string">"</span><span class="hljs-tag">&gt;</span>
  Reset
<span class="hljs-tag">&lt;/</span><span class="hljs-name">button</span><span class="hljs-tag">&gt;</span>
</code></pre>
      </li>
      <li class="numberedList">Update <code class="inlineCode">ngOnInit</code> to conditionally load data from the cache or the latest <code class="inlineCode">currentUser$</code> from <code class="inlineCode">authService</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-title">ngOnInit</span>() {
  <span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span> = <span class="hljs-variable">this</span>.<span class="hljs-title">buildForm</span>()
  <span class="hljs-title">combineLatest</span>([
        <span class="hljs-variable">this</span>.<span class="hljs-title">loadFromCache</span>(),
        <span class="hljs-variable">this</span>.<span class="hljs-property">authService</span>.<span class="hljs-property">currentUser$</span>,
      ])
        .<span class="hljs-title">pipe</span>(
        <span class="hljs-title">takeUntilDestroyed</span>(<span class="hljs-variable">this</span>.<span class="hljs-property">destroyRef</span>),
          <span class="hljs-title">filter</span>(
            <span class="hljs-function">(</span><span class="hljs-params">[cachedUser, me]</span><span class="hljs-function">) =&gt;</span> 
              cachedUser != <span class="hljs-literal">null</span> || me != <span class="hljs-literal">null</span>
          ),
          <span class="hljs-title">tap</span>(
            <span class="hljs-function">(</span><span class="hljs-params">[cachedUser, me]</span><span class="hljs-function">) =&gt;</span> 
              <span class="hljs-variable">this</span>.<span class="hljs-title">patchUser</span>(cachedUser || me)
          )
        )
        .<span class="hljs-title">subscribe</span>()
}
</code></pre>
      </li>
    </ol>
    <p class="normal">We leverage the <code class="inlineCode">combineLatest</code> operator<a id="_idIndexMarker891"/> to combine the outputs of <code class="inlineCode">loadFromCache</code> and <code class="inlineCode">currentUser$</code>. We check that one of the streams returns a non-null value. If a cached user exists, it precedes the value received from <code class="inlineCode">currentUser$</code>.</p>
    <p class="normal">You can test your cache by setting the network status of your browser to offline, as shown here:</p>
    <figure class="mediaobject"><img src="../Images/B20960_08_14.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 8.14: Offline network status</p>
    <p class="normal">Set the network status of your browser to offline as follows:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In Chrome DevTools, navigate to the <strong class="screenText">Network</strong> tab.</li>
      <li class="numberedList">Select <strong class="screenText">Offline</strong> in the dropdown marked as <strong class="screenText">2</strong> in the preceding screenshot.</li>
      <li class="numberedList">Update the form data, such as the name, and hit <strong class="screenText">Update</strong>.</li>
      <li class="numberedList">You’ll see an error reading <strong class="screenText">An unknown error has occurred</strong>, displayed at the bottom of the form.</li>
      <li class="numberedList">You’ll see that your PUT request has failed in the <strong class="screenText">Network</strong> tab.</li>
      <li class="numberedList">Now, refresh your browser window, and observe that the new name you entered is still present.</li>
    </ol>
    <p class="normal">Refer to the following screenshot, which shows<a id="_idIndexMarker892"/> the toast notification you get after loading data from the cache:</p>
    <figure class="mediaobject"><img src="../Images/B20960_08_15.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 8.15: Data loaded from the cache</p>
    <p class="normal">Implementing a great caching UX is incredibly challenging. I provided a rudimentary method to show what is possible. However, many edge cases can impact how caching in your application works.</p>
    <p class="normal">In my case, the cache stubbornly sticks around until we successfully save the data to the server. This may be frustrating<a id="_idIndexMarker893"/> for some users.</p>
    <p class="normal">Congratulations! You’ve successfully implemented a sophisticated form to capture data from your users!</p>
    <h1 id="_idParaDest-265" class="heading-1">Exercise</h1>
    <p class="normal">Practice new concepts like signals and <code class="inlineCode">@defer</code> in Angular by updating <code class="inlineCode">UserService</code> and the multi-step <code class="inlineCode">ProfileComponent</code> form:</p>
    <ul>
      <li class="bulletList">Update <code class="inlineCode">UserService</code> and its related components to use <code class="inlineCode">signal</code> instead of <code class="inlineCode">BehaviorSubject</code>.</li>
      <li class="bulletList">Use <code class="inlineCode">@defer</code> to delay the rendering of conditional views.</li>
      <li class="bulletList">Implement an expansion panel in <code class="inlineCode">LoginComponent</code> to communicate password complexity requirements to your users.</li>
    </ul>
    <h1 id="_idParaDest-266" class="heading-1">Summary</h1>
    <p class="normal">This chapter covered forms, directives, and user control-related functionality for LemonMart. Using data binding, we created reusable components that can be embedded within another component. We showed that you can use PUT to send data to a server and cache data input by a user. We also created a multi-step input form that is responsive to changing screen sizes. We removed the boilerplate code from our components by leveraging reusable form parts, a base form class to house common functionality, and an attribute directive to encapsulate field-level error behavior and messages.</p>
    <p class="normal">We created dynamic form elements with a date picker, typeahead support, and form arrays. We implemented interactive controls with input masking and the lemon rater. Using the <code class="inlineCode">ControlValueAccessor</code> interface, we integrated the lemon rater seamlessly with our form. We showed that we can scale the size and complexity of our forms linearly by extracting the name as its form section. Additionally, we covered building layouts using a grid list.</p>
    <p class="normal">In the next chapter, we will further enhance our components to orchestrate them using the router. We will also implement a master/detail view and a data table and explore NgRx as an alternative to RxJS/BehaviorSubject.</p>
    <h1 id="_idParaDest-267" class="heading-1">Further reading</h1>
    <ul>
      <li class="bulletList"><em class="italic">Reactive forms</em>, 2024: <a href="https://angular.dev/guide/forms/reactive-forms"><span class="url">https://angular.dev/guide/forms/reactive-forms</span></a></li>
      <li class="bulletList"><em class="italic">Attribute directives</em>, 2024: <a href="https://angular.dev/guide/directives/attribute-directives"><span class="url">https://angular.dev/guide/directives/attribute-directives</span></a></li>
      <li class="bulletList"><em class="italic">Meet Angular’s New Control Flow</em>, 2023: <a href="https://blog.angular.io/meet-angulars-new-control-flow-a02c6eee7843 "><span class="url">https://blog.angular.io/meet-angulars-new-control-flow-a02c6eee7843</span></a></li>
      <li class="bulletList"><em class="italic">rxweb: Good way to show the error messages in Angular Reactive Forms</em>, Ajay Ojha, 2019: <a href="https://medium.com/@oojhaajay/rxweb-good-way-to-show-the-error-messages-in-angular-reactive-forms-c27429f51278"><span class="url">https://medium.com/@oojhaajay/rxweb-good-way-to-show-the-error-messages-in-angular-reactive-forms-c27429f51278</span></a></li>
      <li class="bulletList"><em class="italic">The Control Value Accessor</em>, Jennifer Wadella, 2019: <a href="https://www.youtube.com/watch?v=kVbLSN0AW-Y"><span class="url">https://www.youtube.com/watch?v=kVbLSN0AW-Y</span></a></li>
      <li class="bulletList"><em class="italic">CSS Combinators</em>, 2020: <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors#Combinators "><span class="url">https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors#Combinators</span></a></li>
      <li class="bulletList"><em class="italic">Memoization in JavaScript</em>, Sumit Kumar Singh, 2023: <a href="https://designtechworld.medium.com/memoization-in-javascript-282d5fad29c8 "><span class="url">https://designtechworld.medium.com/memoization-in-javascript-282d5fad29c8</span></a></li>
      <li class="bulletList"><em class="italic">Why you should never use function calls in Angular template expressions</em>, Jurgen Van de Moere, 2019: <a href="https://medium.com/showpad-engineering/why-you-should-never-use-function-calls-in-angular-template-expressions-e1a50f9c0496"><span class="url">https://medium.com/showpad-engineering/why-you-should-never-use-function-calls-in-angular-template-expressions-e1a50f9c0496</span></a></li>
    </ul>
    <h1 id="_idParaDest-268" class="heading-1">Questions</h1>
    <p class="normal">Answer the following questions as best as possible to ensure you’ve understood the key concepts from this chapter without googling anything. Do you know if you got all the answers right? Visit <a href="https://angularforenterprise.com/self-assessment"><span class="url">https://angularforenterprise.com/self-assessment</span></a> for more:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">What is the difference between a component and a user control?</li>
      <li class="numberedList">What is an attribute directive?</li>
      <li class="numberedList">What is the <code class="inlineCode">@</code>-syntax?</li>
      <li class="numberedList">What is the purpose of the <code class="inlineCode">ControlValueAccessor</code> interface?</li>
      <li class="numberedList">What is serialization, deserialization, and hydration?</li>
      <li class="numberedList">What does it mean to patch values on a form?</li>
      <li class="numberedList">How do you associate two independent <code class="inlineCode">FormGroup</code> objects with each other?</li>
    </ol>
  </div>
</body></html>