<html><head></head><body>
<div id="_idContainer086">
<h1 class="chapter-number" id="_idParaDest-153"><a id="_idTextAnchor311"/><a id="_idTextAnchor312"/><span class="koboSpan" id="kobo.1.1">12</span></h1>
<h1 id="_idParaDest-154"><a id="_idTextAnchor313"/><span class="koboSpan" id="kobo.2.1">Packaging Everything – Best Practices for Deployment</span></h1>
<p><span class="koboSpan" id="kobo.3.1">After architecting, developing, and testing your application, it’s time to deploy it to </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">your users.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">In this chapter, we will learn the best practices for generating production packages and how to use automation tools to maximize the team’s productivity and effectiveness at this point in </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">the project.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">In this chapter, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">following topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.9.1">Deploying </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">the backend</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.11.1">Differentiating environments</span></span></li>
<li><span class="koboSpan" id="kobo.12.1">Preparing the </span><span class="No-Break"><span class="koboSpan" id="kobo.13.1">production bundle</span></span></li>
<li><span class="koboSpan" id="kobo.14.1">Mounting a Docker image </span><span class="No-Break"><span class="koboSpan" id="kobo.15.1">with Nginx</span></span></li>
<li><span class="koboSpan" id="kobo.16.1">Deploying a page to Azure Static </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1">Web Apps</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.18.1">By the end of this chapter, you will be able to use the Angular CLI to generate a package optimized for production and CI/CD tools to automate this process for </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">your team.</span></span></p>
<h1 id="_idParaDest-155"><a id="_idTextAnchor314"/><span class="koboSpan" id="kobo.20.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.21.1">To follow the instructions in this chapter, you’ll need </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">the following:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.23.1">Visual Studio Code</span></strong><span class="koboSpan" id="kobo.24.1"> (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.25.1">VSCode</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">) (</span></span><a href="https://code.visualstudio.com/Download"><span class="No-Break"><span class="koboSpan" id="kobo.27.1">https://code.visualstudio.com/Download</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.28.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.29.1">Node.js 18 or </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">higher (</span></span><a href="https://nodejs.org/en/download/"><span class="No-Break"><span class="koboSpan" id="kobo.31.1">https://nodejs.org/en/download/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.32.1">)</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.33.1">Docker (</span></span><a href="https://www.docker.com/"><span class="No-Break"><span class="koboSpan" id="kobo.34.1">https://www.docker.com/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.35.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.36.1">Docker for </span><span class="No-Break"><span class="koboSpan" id="kobo.37.1">VSCode (</span></span><a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-docker"><span class="No-Break"><span class="koboSpan" id="kobo.38.1">https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-docker</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.39.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.40.1">An Azure </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">account (</span></span><a href="https://azure.microsoft.com"><span class="No-Break"><span class="koboSpan" id="kobo.42.1">https://azure.microsoft.com</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.43.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.44.1">The Azure </span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">CLI (</span></span><a href="https://learn.microsoft.com/en-us/cli/azure/"><span class="No-Break"><span class="koboSpan" id="kobo.46.1">https://learn.microsoft.com/en-us/cli/azure/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.47.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.48.1">Azure Functions Core </span><span class="No-Break"><span class="koboSpan" id="kobo.49.1">Tools (</span></span><a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-run-local"><span class="No-Break"><span class="koboSpan" id="kobo.50.1">https://learn.microsoft.com/en-us/azure/azure-functions/functions-run-local</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.51.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.52.1">Azure Tools for </span><span class="No-Break"><span class="koboSpan" id="kobo.53.1">VSCode (</span></span><a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.vscode-node-azure-pack"><span class="No-Break"><span class="koboSpan" id="kobo.54.1">https://marketplace.visualstudio.com/items?itemName=ms-vscode.vscode-node-azure-pack</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.55.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.56.1">The NestJS </span><span class="No-Break"><span class="koboSpan" id="kobo.57.1">CLI (</span></span><a href="https://docs.nestjs.com/cli/overview"><span class="No-Break"><span class="koboSpan" id="kobo.58.1">https://docs.nestjs.com/cli/overview</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.59.1">)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.60.1">The code files for this chapter are available </span><span class="No-Break"><span class="koboSpan" id="kobo.61.1">at </span></span><a href="https://github.com/PacktPublishing/Angular-Design-Patterns-and-Best-Practices/tree/main/ch12"><span class="No-Break"><span class="koboSpan" id="kobo.62.1">https://github.com/PacktPublishing/Angular-Design-Patterns-and-Best-Practices/tree/main/ch12</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.63.1">.</span></span></p>
<h1 id="_idParaDest-156"><a id="_idTextAnchor315"/><span class="koboSpan" id="kobo.64.1">Deploying the backend</span></h1>
<p><span class="koboSpan" id="kobo.65.1">Before </span><a id="_idIndexMarker534"/><span class="koboSpan" id="kobo.66.1">preparing our gym diary project for production, let’s first upload the backend to a cloud service so that our page has access to </span><span class="No-Break"><span class="koboSpan" id="kobo.67.1">the data.</span></span></p>
<p><span class="koboSpan" id="kobo.68.1">We chose the Azure service for this book, but the concepts in this chapter can also be applied to other cloud services, such</span><a id="_idIndexMarker535"/><span class="koboSpan" id="kobo.69.1"> as AWS</span><a id="_idIndexMarker536"/><span class="koboSpan" id="kobo.70.1"> (</span><a href="https://aws.amazon.com"><span class="koboSpan" id="kobo.71.1">https://aws.amazon.com</span></a><span class="koboSpan" id="kobo.72.1">) and </span><span class="No-Break"><span class="koboSpan" id="kobo.73.1">GCP (</span></span><a href="https://cloud.google.com"><span class="No-Break"><span class="koboSpan" id="kobo.74.1">https://cloud.google.com</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.75.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.76.1">The backend of this example does </span><a id="_idIndexMarker537"/><span class="koboSpan" id="kobo.77.1">not use a database and was built using the NestJS framework (</span><a href="https://nestjs.com/"><span class="koboSpan" id="kobo.78.1">https://nestjs.com/</span></a><span class="koboSpan" id="kobo.79.1">), which actually has an architecture completely inspired by Angular, but for the backend! </span><span class="koboSpan" id="kobo.79.2">This framework allows you to add cloud deployment capabilities with Azure. </span><span class="koboSpan" id="kobo.79.3">To prepare your backend for deployment, in the command line of your operating system, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.80.1">project</span></strong><span class="koboSpan" id="kobo.81.1"> folder (</span><strong class="source-inline"><span class="koboSpan" id="kobo.82.1">/gym-diary-backend</span></strong><span class="koboSpan" id="kobo.83.1">), run the </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">following commands:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.85.1">
npm install @schematics/angular
nest add @nestjs/azure-func-http</span></pre> <p><span class="koboSpan" id="kobo.86.1">The</span><a id="_idIndexMarker538"/><span class="koboSpan" id="kobo.87.1"> first command installs the Angular Schematic package, which will be used to build </span><span class="No-Break"><span class="koboSpan" id="kobo.88.1">the application.</span></span></p>
<p><span class="koboSpan" id="kobo.89.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.90.1">nest add</span></strong><span class="koboSpan" id="kobo.91.1"> command has the same functionality as Angular’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.92.1">ng add</span></strong><span class="koboSpan" id="kobo.93.1"> command, and here, in addition to installing the dependencies for deployment on Azure, it also configures and creates the necessary files for </span><span class="No-Break"><span class="koboSpan" id="kobo.94.1">this task.</span></span></p>
<p><span class="koboSpan" id="kobo.95.1">With the tools from the </span><em class="italic"><span class="koboSpan" id="kobo.96.1">Technical requirements</span></em><span class="koboSpan" id="kobo.97.1"> section installed, we first need to create an Azure Functions project. </span><span class="koboSpan" id="kobo.97.2">To do this, let’s go to the Azure portal in the </span><strong class="bold"><span class="koboSpan" id="kobo.98.1">Function App</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.99.1">menu option:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer071">
<span class="koboSpan" id="kobo.100.1"><img alt="Figure 12.1 – Function App menu option" src="image/B19562_12_1.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.101.1">Figure 12.1 – Function App menu option</span></p>
<p><span class="koboSpan" id="kobo.102.1">Azure has several ways to run a backend service, and one of the simplest is through Azure Functions. </span><span class="koboSpan" id="kobo.102.2">With it, we can upload our service without needing to configure a server, as the provider will take care of </span><span class="No-Break"><span class="koboSpan" id="kobo.103.1">these details.</span></span></p>
<p><span class="koboSpan" id="kobo.104.1">We then need to perform some basic configurations. </span><span class="koboSpan" id="kobo.104.2">To do this, we will click on </span><strong class="bold"><span class="koboSpan" id="kobo.105.1">+ Create</span></strong><span class="koboSpan" id="kobo.106.1">. </span><span class="koboSpan" id="kobo.106.2">Once done, we will be presented with the </span><span class="No-Break"><span class="koboSpan" id="kobo.107.1">following screen:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer072">
<span class="koboSpan" id="kobo.108.1"><img alt="Figure 12.2 – Azure Functions service configuration" src="image/B19562_12_2.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.109.1">Figure 12.2 – Azure Functions service configuration</span></p>
<p><span class="koboSpan" id="kobo.110.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.111.1">Subscription</span></strong><span class="koboSpan" id="kobo.112.1"> field, you</span><a id="_idIndexMarker539"/><span class="koboSpan" id="kobo.113.1"> need to choose your Azure subscription. </span><span class="koboSpan" id="kobo.113.2">In the </span><strong class="bold"><span class="koboSpan" id="kobo.114.1">Resource Group</span></strong><span class="koboSpan" id="kobo.115.1"> field, you can select a group that you already have; if you don’t have one, you can create a new one and enter its name. </span><span class="koboSpan" id="kobo.115.2">The </span><strong class="bold"><span class="koboSpan" id="kobo.116.1">Function App name</span></strong><span class="koboSpan" id="kobo.117.1"> field is important as it will initially be the address of your endpoint. </span><span class="koboSpan" id="kobo.117.2">It is possible to buy a specific URL or place this API behind an Azure API gateway (https://azure.microsoft.com/en-us/products/api-management), although this is not required for our example. </span><span class="koboSpan" id="kobo.117.3">We will deploy directly from the code, so leave </span><strong class="bold"><span class="koboSpan" id="kobo.118.1">Do you want to deploy code or container image?</span></strong><span class="koboSpan" id="kobo.119.1"> as </span><strong class="bold"><span class="koboSpan" id="kobo.120.1">Code</span></strong><span class="koboSpan" id="kobo.121.1">. </span><span class="koboSpan" id="kobo.121.2">The project’s runtime stack should</span><a id="_idIndexMarker540"/><span class="koboSpan" id="kobo.122.1"> be set to </span><strong class="bold"><span class="koboSpan" id="kobo.123.1">NodeJS</span></strong><span class="koboSpan" id="kobo.124.1">, version </span><strong class="bold"><span class="koboSpan" id="kobo.125.1">18 LTS</span></strong><span class="koboSpan" id="kobo.126.1">. </span><span class="koboSpan" id="kobo.126.2">For the project region, select one close to you, or </span><strong class="bold"><span class="koboSpan" id="kobo.127.1">East US</span></strong><span class="koboSpan" id="kobo.128.1">, which is the default option. </span><span class="koboSpan" id="kobo.128.2">Finally, </span><strong class="bold"><span class="koboSpan" id="kobo.129.1">Operating System</span></strong><span class="koboSpan" id="kobo.130.1"> should be set to </span><strong class="bold"><span class="koboSpan" id="kobo.131.1">Linux</span></strong><span class="koboSpan" id="kobo.132.1">. </span><span class="koboSpan" id="kobo.132.2">The </span><strong class="bold"><span class="koboSpan" id="kobo.133.1">Hosting options and plans</span></strong><span class="koboSpan" id="kobo.134.1"> option should be set to </span><strong class="bold"><span class="koboSpan" id="kobo.135.1">Consumption (Serverless)</span></strong><span class="koboSpan" id="kobo.136.1"> as we do not need any more specific features in </span><span class="No-Break"><span class="koboSpan" id="kobo.137.1">this case.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer073">
<span class="koboSpan" id="kobo.138.1"><img alt="Figure 12.3 – Hosting options and plans" src="image/B19562_12_3.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.139.1">Figure 12.3 – Hosting options and plans</span></p>
<p><span class="koboSpan" id="kobo.140.1">Once we are done filling in all the necessary information, click on </span><strong class="bold"><span class="koboSpan" id="kobo.141.1">Review + Create</span></strong><span class="koboSpan" id="kobo.142.1">. </span><span class="koboSpan" id="kobo.142.2">On the next screen, confirm your information and execute </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">the creation:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer074">
<span class="koboSpan" id="kobo.144.1"><img alt="Figure 12.4 – Azure Functions service created" src="image/B19562_12_4.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.145.1">Figure 12.4 – Azure Functions service created</span></p>
<p><span class="koboSpan" id="kobo.146.1">To publish </span><a id="_idIndexMarker541"/><span class="koboSpan" id="kobo.147.1">our backend to the created service, we will use the VS plugin. </span><span class="koboSpan" id="kobo.147.2">Open the backend project, left-click, and select </span><strong class="bold"><span class="koboSpan" id="kobo.148.1">Deploy to Function App…</span></strong><span class="koboSpan" id="kobo.149.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.150.1">following figure:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer075">
<span class="koboSpan" id="kobo.151.1"><img alt="Figure 12.5 – VSCode extension for publishing Azure Functions" src="image/B19562_12_5.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.152.1">Figure 12.5 – VSCode extension for publishing Azure Functions</span></p>
<p><span class="koboSpan" id="kobo.153.1">The extension will get the list of services created from your account, so select the one we created from the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.154.1">AZURE</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.155.1"> panel.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer076">
<span class="koboSpan" id="kobo.156.1"><img alt="Figure 12.6 – VSCode AZURE panel" src="image/B19562_12_6.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.157.1">Figure 12.6 – VSCode AZURE panel</span></p>
<p><span class="koboSpan" id="kobo.158.1">After publication, the </span><a id="_idIndexMarker542"/><span class="koboSpan" id="kobo.159.1">Azure service will point you to a public URL with your service. </span><span class="koboSpan" id="kobo.159.2">Access it in a browser with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.160.1">/exercise</span></strong><span class="koboSpan" id="kobo.161.1"> endpoint to check whether the service </span><span class="No-Break"><span class="koboSpan" id="kobo.162.1">is live.</span></span></p>
<p><span class="koboSpan" id="kobo.163.1"> The return of the published URL should be a list similar to </span><span class="No-Break"><span class="koboSpan" id="kobo.164.1">the following:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.165.1">
{"items":id":"30","description":"Plank"},{"id":"29","description":"Dumbbell Bench Press"},{"id":"28","description":"Seated Leg Curl"},{"id":"27","description":"Cable Curl"},{"id":"26","description":"Glute Bridge"},{"id":"25","description":"Skull Crusher"},{"id":"24","description":"Arnold Press"},{"id":"23","description":"Inverted Row"},{"id":"22","description":"Chest Fly"},{"id":"21","description":"Hanging Leg Raise"},{"id":"20","description":"Side Lateral Raise"},{"id":"19","description":"Front Squat"},{"id":"18","description":"Seated Row"},{"id":"17","description":"Romanian Deadlift"},{"id":"16","description":"Bicep Curl"},{"id":"15","description":"Calf Raise"},{"id":"14","description":"Tricep Dip"},{"id":"13","description":"Push-up"},{"id":"12","description":"Leg Curl"},{"id":"11","description":"Incline Bench Press"},{"id":"10","description":"Hammer Curl"}, {"id":"9","description":"Lunges"},{"id":"8","description":"Dumbbell Curl"},{"id":"7","description":"Pull-up"},{"id":"6","description":"Shoulder Press"},{"id":"5","description":"Bench Press"},{"id":"4","description":"Leg Press"},{"id":"3","description":"Barbell 
Row"},{"id":"2","description":"Squat"},{"id":"1","description":"Deadlift"}],"hasNext":false}</span></pre> <p><span class="koboSpan" id="kobo.166.1">One last </span><a id="_idIndexMarker543"/><span class="koboSpan" id="kobo.167.1">configuration we must do is configure the service’s CORS to enable our local application to connect to the cloud service. </span><span class="koboSpan" id="kobo.167.2">In the Azure console, click on the created service and then on the </span><strong class="bold"><span class="koboSpan" id="kobo.168.1">CORS</span></strong><span class="koboSpan" id="kobo.169.1"> tab and set the </span><strong class="bold"><span class="koboSpan" id="kobo.170.1">Allowed Origins</span></strong><span class="koboSpan" id="kobo.171.1"> field </span><span class="No-Break"><span class="koboSpan" id="kobo.172.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.173.1">*</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.174.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer077">
<span class="koboSpan" id="kobo.175.1"><img alt="Figure 12.7 – CORS configuration" src="image/B19562_12_7.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.176.1">Figure 12.7 – CORS configuration</span></p>
<p><span class="koboSpan" id="kobo.177.1">With our </span><a id="_idIndexMarker544"/><span class="koboSpan" id="kobo.178.1">backend service online, we will focus on how to access it from our application in the next section. </span><span class="koboSpan" id="kobo.178.2">An important point is to always remember to turn off the service in Azure so as not to incur unnecessary costs when going through this book’s examples in your </span><span class="No-Break"><span class="koboSpan" id="kobo.179.1">Azure accou</span><a id="_idTextAnchor316"/><span class="koboSpan" id="kobo.180.1">nt.</span></span></p>
<h1 id="_idParaDest-157"><a id="_idTextAnchor317"/><span class="koboSpan" id="kobo.181.1">Differentiating environments</span></h1>
<p><span class="koboSpan" id="kobo.182.1">After </span><a id="_idIndexMarker545"/><span class="koboSpan" id="kobo.183.1">finishing the task of deploying our backend, we need to change our frontend project to make requests to our cloud infrastructure. </span><span class="koboSpan" id="kobo.183.2">But here, a problem arises. </span><span class="koboSpan" id="kobo.183.3">We want to access our published backend when we are in production, but the team needs to continue accessing the API locally to develop new features in a more practical way. </span><span class="koboSpan" id="kobo.183.4">How can we have the best of </span><span class="No-Break"><span class="koboSpan" id="kobo.184.1">both worlds?</span></span></p>
<p><span class="koboSpan" id="kobo.185.1">The answer to this, once again, was thought up by the Angular team and is the creation of configuration files for each </span><span class="No-Break"><span class="koboSpan" id="kobo.186.1">development environment.</span></span></p>
<p><span class="koboSpan" id="kobo.187.1">Until version 14 of Angular, these files were already standard when creating the project (the </span><strong class="source-inline"><span class="koboSpan" id="kobo.188.1">ng new</span></strong><span class="koboSpan" id="kobo.189.1"> command). </span><span class="koboSpan" id="kobo.189.2">However, to simplify new projects and reduce the learning curve, these files were removed for </span><span class="No-Break"><span class="koboSpan" id="kobo.190.1">new projects.</span></span></p>
<p><span class="koboSpan" id="kobo.191.1">But we shouldn’t worry because to add them, we can use the Angular CLI. </span><span class="koboSpan" id="kobo.191.2">On the command line, use the </span><span class="No-Break"><span class="koboSpan" id="kobo.192.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.193.1">
ng generate environments</span></pre> <p><span class="koboSpan" id="kobo.194.1">After</span><a id="_idIndexMarker546"/><span class="koboSpan" id="kobo.195.1"> executing the preceding command, the Angular CLI creates the </span><strong class="source-inline"><span class="koboSpan" id="kobo.196.1">environments</span></strong><span class="koboSpan" id="kobo.197.1"> folder, and inside it, we have the </span><strong class="source-inline"><span class="koboSpan" id="kobo.198.1">environment.development.ts</span></strong><span class="koboSpan" id="kobo.199.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.200.1">environment.ts</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.201.1"> files.</span></span></p>
<p><span class="koboSpan" id="kobo.202.1">These TypeScript files have only one object, and this object is where we will place all the settings that we need to differentiate between production and development environments. </span><span class="koboSpan" id="kobo.202.2">We will first change the </span><strong class="source-inline"><span class="koboSpan" id="kobo.203.1">environment.development.ts</span></strong><span class="koboSpan" id="kobo.204.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.205.1">like so:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.206.1">
export const environment = {
  production: false,
  apiUrl: 'http://localhost:3000'
};</span></pre> <p><span class="koboSpan" id="kobo.207.1">In these objects, we declare a flag to indicate that this is a configuration of the development environment and the URL of our local backend service. </span><span class="koboSpan" id="kobo.207.2">We will now change the </span><strong class="source-inline"><span class="koboSpan" id="kobo.208.1">environment.ts</span></strong><span class="koboSpan" id="kobo.209.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.210.1">like so:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.211.1">
export const environment = {
  production: true,
  apiUrl: 'https://gymdiaryangularboook.azurewebsites.net/api',
};</span></pre> <p><span class="koboSpan" id="kobo.212.1">Here, we are doing the same but indicating the production environment of our application. </span><span class="koboSpan" id="kobo.212.2">The backend address will be the one created in the </span><span class="No-Break"><span class="koboSpan" id="kobo.213.1">previous section.</span></span></p>
<p><span class="koboSpan" id="kobo.214.1">To use these files, we must import them and refactor the </span><strong class="source-inline"><span class="koboSpan" id="kobo.215.1">HostInterceptor</span></strong><span class="koboSpan" id="kobo.216.1"> service to </span><span class="No-Break"><span class="koboSpan" id="kobo.217.1">use it:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.218.1">
. </span><span class="koboSpan" id="kobo.218.2">. </span><span class="koboSpan" id="kobo.218.3">.
</span><span class="koboSpan" id="kobo.218.4">import { environment } from 'src/environments/environment';
@Injectable()
export class HostInterceptor implements HttpInterceptor {
  intercept(
    request: HttpRequest&lt;unknown&gt;,
    next: HttpHandler
  ): Observable&lt;HttpEvent&lt;unknown&gt;&gt; {
    const url = environment.apiUrl;
. </span><span class="koboSpan" id="kobo.218.5">. </span><span class="koboSpan" id="kobo.218.6">.
</span><span class="koboSpan" id="kobo.218.7">}</span></pre> <p><span class="koboSpan" id="kobo.219.1">In our</span><a id="_idIndexMarker547"/><span class="koboSpan" id="kobo.220.1"> interceptor service, which is responsible for adding the URL to our requests (for more details, see </span><a href="B19562_08.xhtml#_idTextAnchor225"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.221.1">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.222.1">, </span><em class="italic"><span class="koboSpan" id="kobo.223.1">Improving Backend Integrations: the Interceptor Pattern</span></em><span class="koboSpan" id="kobo.224.1">), we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.225.1">environment</span></strong><span class="koboSpan" id="kobo.226.1"> object property to determine </span><span class="No-Break"><span class="koboSpan" id="kobo.227.1">the URL.</span></span></p>
<p><span class="koboSpan" id="kobo.228.1">A point of attention here is that we must import the </span><strong class="source-inline"><span class="koboSpan" id="kobo.229.1">environment.ts</span></strong><span class="koboSpan" id="kobo.230.1"> file for this variable because Angular makes the change when generating </span><span class="No-Break"><span class="koboSpan" id="kobo.231.1">the build.</span></span></p>
<p><span class="koboSpan" id="kobo.232.1">To make it clear which environment we are in, we will change the </span><strong class="source-inline"><span class="koboSpan" id="kobo.233.1">AppComponent</span></strong><span class="koboSpan" id="kobo.234.1"> component </span><span class="No-Break"><span class="koboSpan" id="kobo.235.1">like so:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.236.1">
. </span><span class="koboSpan" id="kobo.236.2">. </span><span class="koboSpan" id="kobo.236.3">.
</span><span class="koboSpan" id="kobo.236.4">import { environment } from 'src/environments/environment';
import { ToastrService } from 'ngx-toastr';
@Component({
  selector: 'app-root',
  templateUrl: './app.component.html',
  styleUrls: ['./app.component.css'],
})
export class AppComponent implements OnInit {
  loadService = inject(LoadService);
  toaster = inject(ToastrService);
  title = 'gym-diary';
  ngOnInit(): void {
    if (environment.production) {
      this.toaster.info('Production Build!');
    } else {
      this.toaster.info('Development Build!');
    }
  }
}</span></pre> <p><span class="koboSpan" id="kobo.237.1">In this change, we are</span><a id="_idIndexMarker548"/><span class="koboSpan" id="kobo.238.1"> using the toaster service (for more details, refer to </span><a href="B19562_08.xhtml#_idTextAnchor225"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.239.1">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.240.1">,</span><em class="italic"><span class="koboSpan" id="kobo.241.1"> Improving Backend Integrations: the Interceptor Pattern</span></em><span class="koboSpan" id="kobo.242.1">) to indicate, when the user enters the page, which environment they </span><span class="No-Break"><span class="koboSpan" id="kobo.243.1">are in.</span></span></p>
<p><span class="koboSpan" id="kobo.244.1">Let’s run our application using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">ng serve</span></strong><span class="koboSpan" id="kobo.246.1"> command, and we will get the </span><span class="No-Break"><span class="koboSpan" id="kobo.247.1">following result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer078">
<span class="koboSpan" id="kobo.248.1"><img alt="Figure 12.8 – Application in development mode" src="image/B19562_12_8.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.249.1">Figure 12.8 – Application in development mode</span></p>
<p><span class="koboSpan" id="kobo.250.1">If we log in to our </span><a id="_idIndexMarker549"/><span class="koboSpan" id="kobo.251.1">application, we can see, by looking at the developer tools in the </span><strong class="bold"><span class="koboSpan" id="kobo.252.1">Networks</span></strong><span class="koboSpan" id="kobo.253.1"> tab, that the application is making requests to our local backend. </span><span class="koboSpan" id="kobo.253.2">To run our Angular project as a production build, we can use the </span><span class="No-Break"><span class="koboSpan" id="kobo.254.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.255.1">
ng serve --configuration production</span></pre> <p><span class="koboSpan" id="kobo.256.1">When accessing our </span><a id="_idIndexMarker550"/><span class="koboSpan" id="kobo.257.1">application, we can see in the message on the screen that requests are made to the service published in our </span><span class="No-Break"><span class="koboSpan" id="kobo.258.1">cloud service:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer079">
<span class="koboSpan" id="kobo.259.1"><img alt="Figure 12.9 – Application in production mode" src="image/B19562_12_9.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.260.1">Figure 12.9 – Application in production mode</span></p>
<p><span class="koboSpan" id="kobo.261.1">With our service </span><a id="_idIndexMarker551"/><span class="koboSpan" id="kobo.262.1">prepared for multiple environments, we can now see how we can better prepare it for deployment in the </span><span class="No-Break"><span class="koboSpan" id="kobo.263.1">next</span><a id="_idTextAnchor318"/> <a id="_idTextAnchor319"/><span class="koboSpan" id="kobo.264.1">section.</span></span></p>
<h1 id="_idParaDest-158"><a id="_idTextAnchor320"/><span class="koboSpan" id="kobo.265.1">Preparing the production bundle</span></h1>
<p><span class="koboSpan" id="kobo.266.1">The </span><a id="_idIndexMarker552"/><span class="koboSpan" id="kobo.267.1">environmental needs of a frontend application running in production are different from the development environment we have seen so far in </span><span class="No-Break"><span class="koboSpan" id="kobo.268.1">the book.</span></span></p>
<p><span class="koboSpan" id="kobo.269.1">When we are developing, we look for speed in compilation, powerful debugging, and profiling tools to analyze our code, as well as generating boilerplate code, among </span><span class="No-Break"><span class="koboSpan" id="kobo.270.1">other features.</span></span></p>
<p><span class="koboSpan" id="kobo.271.1">Even though it costs more to process on our local machine, requires more space to generate instrumented bundles to be able to perform debugging, and requires greater network consumption to download development tools, all of this is important for the team’s productivity, and the Angular framework delivers it in a </span><span class="No-Break"><span class="koboSpan" id="kobo.272.1">robust ecosystem.</span></span></p>
<p><span class="koboSpan" id="kobo.273.1">When we are talking about frontend web code running in production, the objective is almost the opposite. </span><span class="koboSpan" id="kobo.273.2">We want our code to be as small and optimized as possible, to be downloaded and executed by our users in the most performant </span><span class="No-Break"><span class="koboSpan" id="kobo.274.1">way possible.</span></span></p>
<p><span class="koboSpan" id="kobo.275.1">With this objective in mind, the Angular framework has a robust and simple build tool for generating the </span><span class="No-Break"><span class="koboSpan" id="kobo.276.1">production package.</span></span></p>
<p><span class="koboSpan" id="kobo.277.1">To run it, we need to use the following command in our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.278.1">project</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.279.1"> folder:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.280.1">
ng build</span></pre> <p><span class="koboSpan" id="kobo.281.1">This command will create the package that we will run in production in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.282.1">dist</span></strong><span class="koboSpan" id="kobo.283.1"> folder of </span><span class="No-Break"><span class="koboSpan" id="kobo.284.1">our project.</span></span></p>
<p><span class="koboSpan" id="kobo.285.1">But to deepen our knowledge of the Angular framework, let’s understand what the basis for this build process is. </span><span class="koboSpan" id="kobo.285.2">The answer is in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.286.1">angular.json</span></strong><span class="koboSpan" id="kobo.287.1"> file. </span><span class="koboSpan" id="kobo.287.2">Let’s analyze some important properties of </span><span class="No-Break"><span class="koboSpan" id="kobo.288.1">the build:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.289.1">
"configurations": {
  "production": {
    "budgets": [
      {
        "type": "initial",
        "maximumWarning": "500kb",
        "maximumError": "1mb"
      },
      {
        "type": "anyComponentStyle",
        "maximumWarning": "2kb",
        "maximumError": "4kb"
      }
    ],
    "outputHashing": "all"
  },
  . </span><span class="koboSpan" id="kobo.289.2">. </span><span class="koboSpan" id="kobo.289.3">.
</span><span class="koboSpan" id="kobo.289.4">  "defaultConfiguration": "production"
}</span></pre> <p><span class="koboSpan" id="kobo.290.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.291.1">configurations</span></strong><span class="koboSpan" id="kobo.292.1"> property, we have definitions of the types of environments that we can have in our project. </span><span class="koboSpan" id="kobo.292.2">Initially, the Angular CLI creates two configurations: production </span><span class="No-Break"><span class="koboSpan" id="kobo.293.1">and development.</span></span></p>
<p><span class="koboSpan" id="kobo.294.1">In the </span><a id="_idIndexMarker553"/><span class="koboSpan" id="kobo.295.1">production configuration, we have the </span><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">budgets</span></strong><span class="koboSpan" id="kobo.297.1"> property, which determines the maximum size that our package must have in addition to defining the maximum size that a unitary component </span><span class="No-Break"><span class="koboSpan" id="kobo.298.1">must have.</span></span></p>
<p><span class="koboSpan" id="kobo.299.1">If your project exceeds this size, Angular may show a warning in the production console or even not build </span><span class="No-Break"><span class="koboSpan" id="kobo.300.1">your project.</span></span></p>
<p><span class="koboSpan" id="kobo.301.1">This is important because we need to generate the smallest file possible as this results in a greater perception of performance for our users, especially if they are using a device on a </span><span class="No-Break"><span class="koboSpan" id="kobo.302.1">3G network.</span></span></p>
<p><span class="koboSpan" id="kobo.303.1">One way to reduce file sizes is to use Angular’s lazy-loading capabilities (for more details on this feature, see </span><a href="B19562_02.xhtml#_idTextAnchor081"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.304.1">Chapter 2</span></em></span></a><span class="koboSpan" id="kobo.305.1">, </span><em class="italic"><span class="koboSpan" id="kobo.306.1">Organizing </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.307.1">Your Application</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.308.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.309.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.310.1">outputHashing</span></strong><span class="koboSpan" id="kobo.311.1"> attribute ensures that the files generated by the application have their names added to </span><span class="No-Break"><span class="koboSpan" id="kobo.312.1">a hash.</span></span></p>
<p><span class="koboSpan" id="kobo.313.1">This is important </span><a id="_idIndexMarker554"/><span class="koboSpan" id="kobo.314.1">because most public clouds and </span><strong class="bold"><span class="koboSpan" id="kobo.315.1">Content Delivery Networks</span></strong><span class="koboSpan" id="kobo.316.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.317.1">CDNs</span></strong><span class="koboSpan" id="kobo.318.1">) cache the application based on the name of the files. </span><span class="koboSpan" id="kobo.318.2">When we generate a new </span><a id="_idIndexMarker555"/><span class="koboSpan" id="kobo.319.1">version of our app, we want this cache to be invalidated to deliver the new version to </span><span class="No-Break"><span class="koboSpan" id="kobo.320.1">our users.</span></span></p>
<p><span class="koboSpan" id="kobo.321.1">Finally, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.322.1">defaultConfiguration</span></strong><span class="koboSpan" id="kobo.323.1"> property determines that if no parameter is passed, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.324.1">ng build</span></strong><span class="koboSpan" id="kobo.325.1"> command will execute with the configuration indicated in it, in this </span><span class="No-Break"><span class="koboSpan" id="kobo.326.1">case, production.</span></span></p>
<p><span class="koboSpan" id="kobo.327.1">These configurations can be expanded and new ones created depending on your project needs. </span><span class="koboSpan" id="kobo.327.2">In our case, we will leave it with the </span><span class="No-Break"><span class="koboSpan" id="kobo.328.1">default configuration.</span></span></p>
<p><span class="koboSpan" id="kobo.329.1">When running the build in production configurations, Angular performs the </span><span class="No-Break"><span class="koboSpan" id="kobo.330.1">following processes:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.331.1">Ahead-of-Time (AOT) compilation</span></strong><span class="koboSpan" id="kobo.332.1">: Angular </span><a id="_idIndexMarker556"/><span class="koboSpan" id="kobo.333.1">compiles templates and CSS files in addition to </span><span class="No-Break"><span class="koboSpan" id="kobo.334.1">TypeScript files.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.335.1">Production mode</span></strong><span class="koboSpan" id="kobo.336.1">: The </span><a id="_idIndexMarker557"/><span class="koboSpan" id="kobo.337.1">application has some validations optimized for running </span><span class="No-Break"><span class="koboSpan" id="kobo.338.1">in production.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.339.1">Bundling</span></strong><span class="koboSpan" id="kobo.340.1">: It </span><a id="_idIndexMarker558"/><span class="koboSpan" id="kobo.341.1">bundles all component files, templates, services and libraries in files separated </span><span class="No-Break"><span class="koboSpan" id="kobo.342.1">by modules.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.343.1">Minification</span></strong><span class="koboSpan" id="kobo.344.1">: From the </span><a id="_idIndexMarker559"/><span class="koboSpan" id="kobo.345.1">files generated by TypeScript, it concatenates and eliminates whitespace and comments to generate the smallest </span><span class="No-Break"><span class="koboSpan" id="kobo.346.1">files possible.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.347.1">Uglification</span></strong><span class="koboSpan" id="kobo.348.1">: It </span><a id="_idIndexMarker560"/><span class="koboSpan" id="kobo.349.1">rewrites generated code for variables, function names, and small, cryptic modules to make it difficult to reverse engineer the frontend code delivered to the </span><span class="No-Break"><span class="koboSpan" id="kobo.350.1">user’s browser.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.351.1">Dead code elimination</span></strong><span class="koboSpan" id="kobo.352.1">: Also known as </span><strong class="bold"><span class="koboSpan" id="kobo.353.1">tree shaking</span></strong><span class="koboSpan" id="kobo.354.1">, this is the process of not including components</span><a id="_idIndexMarker561"/><span class="koboSpan" id="kobo.355.1"> in bundles that are not referenced in the code and do not need to be</span><a id="_idIndexMarker562"/><span class="koboSpan" id="kobo.356.1"> present in the </span><span class="No-Break"><span class="koboSpan" id="kobo.357.1">production package.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.358.1">All these</span><a id="_idIndexMarker563"/><span class="koboSpan" id="kobo.359.1"> processes are done with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.360.1">ng build</span></strong><span class="koboSpan" id="kobo.361.1"> command and with the configuration that was set when your project was created. </span><span class="koboSpan" id="kobo.361.2">It is important to note that this process improves with each new version of Angular and is another reason to always keep your project up to date with the </span><span class="No-Break"><span class="koboSpan" id="kobo.362.1">latest versions.</span></span></p>
<p><span class="koboSpan" id="kobo.363.1">In the next section, we will create a Docker image with our code built and run by t</span><a id="_idTextAnchor321"/><span class="koboSpan" id="kobo.364.1">he Nginx </span><span class="No-Break"><span class="koboSpan" id="kobo.365.1">web server.</span></span></p>
<h1 id="_idParaDest-159"><a id="_idTextAnchor322"/><span class="koboSpan" id="kobo.366.1">Mounting a Docker image with Nginx</span></h1>
<p><span class="koboSpan" id="kobo.367.1">Until this </span><a id="_idIndexMarker564"/><span class="koboSpan" id="kobo.368.1">chapter, we have been using the web server </span><a id="_idIndexMarker565"/><span class="koboSpan" id="kobo.369.1">included in the Angular package to run our application locally. </span><span class="koboSpan" id="kobo.369.2">Although very competent, it focuses purely on the developer’s experience and does not have the performance and scalability capabilities required by the </span><span class="No-Break"><span class="koboSpan" id="kobo.370.1">production environment.</span></span></p>
<p><span class="koboSpan" id="kobo.371.1">For this purpose, we use production-grade web servers. </span><span class="koboSpan" id="kobo.371.2">One of the most popular is Nginx (pronounced </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.372.1">Engine X</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.373.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.374.1">To configure it, we need to create a file in the root of our project called </span><strong class="source-inline"><span class="koboSpan" id="kobo.375.1">nginx.default.conf</span></strong><span class="koboSpan" id="kobo.376.1"> and add the following </span><span class="No-Break"><span class="koboSpan" id="kobo.377.1">to it:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.378.1">
server {
  listen 80;
  sendfile on;
  default_type application/octet-stream;
  gzip on;
  gzip_http_version 1.1;
  gzip_disable      "MSIE [1-6]\.";
  gzip_min_length   1100;
  gzip_vary         on;
  gzip_proxied      expired no-cache no-store private auth;
  gzip_types        text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript;
  gzip_comp_level   9;
  root /usr/share/nginx/html;
  location / {
    try_files $uri $uri/ /index.html =404;
  }
}</span></pre> <p><span class="koboSpan" id="kobo.379.1">In this configuration file, the first three properties (</span><strong class="source-inline"><span class="koboSpan" id="kobo.380.1">listen</span></strong><span class="koboSpan" id="kobo.381.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.382.1">sendfile</span></strong><span class="koboSpan" id="kobo.383.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.384.1">default_type</span></strong><span class="koboSpan" id="kobo.385.1">) aim to configure the exposed port and prepare the server to send our project’s </span><span class="No-Break"><span class="koboSpan" id="kobo.386.1">package files.</span></span></p>
<p><span class="koboSpan" id="kobo.387.1">The properties </span><a id="_idIndexMarker566"/><span class="koboSpan" id="kobo.388.1">starting with </span><strong class="source-inline"><span class="koboSpan" id="kobo.389.1">gzip</span></strong><span class="koboSpan" id="kobo.390.1"> configure the delivery of files </span><a id="_idIndexMarker567"/><span class="koboSpan" id="kobo.391.1">with the native web compression data </span><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">gzip</span></strong><span class="koboSpan" id="kobo.393.1">, further reducing the files delivered to our </span><span class="No-Break"><span class="koboSpan" id="kobo.394.1">user’s browser.</span></span></p>
<p><span class="koboSpan" id="kobo.395.1">The last part of the file determines the first page to be served. </span><span class="koboSpan" id="kobo.395.2">As we are in a </span><strong class="bold"><span class="koboSpan" id="kobo.396.1">Single-Page Application</span></strong><span class="koboSpan" id="kobo.397.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.398.1">SPA</span></strong><span class="koboSpan" id="kobo.399.1">), the</span><a id="_idIndexMarker568"/><span class="koboSpan" id="kobo.400.1"> first file to be delivered </span><span class="No-Break"><span class="koboSpan" id="kobo.401.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.402.1">index.html</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.403.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.404.1">With this configuration, we can run Nginx, but instead of installing it natively on our local machine, we will use Docker to </span><span class="No-Break"><span class="koboSpan" id="kobo.405.1">run it.</span></span></p>
<p><span class="koboSpan" id="kobo.406.1">Docker is a tool widely used in today’s modern systems and aims to compartmentalize an application’s environment. </span><span class="koboSpan" id="kobo.406.2">In other words, by configuring a file, we can create an environment for our application where it can be run both on our local machine and on a cloud provider with the same dependencies </span><span class="No-Break"><span class="koboSpan" id="kobo.407.1">and versions.</span></span></p>
<p><span class="koboSpan" id="kobo.408.1">Let’s exemplify its use by first creating a file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.409.1">.dockerignore</span></strong><span class="koboSpan" id="kobo.410.1"> in our project’s root and adding the following </span><span class="No-Break"><span class="koboSpan" id="kobo.411.1">to it:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.412.1">
node_modules</span></pre> <p><span class="koboSpan" id="kobo.413.1">Using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.414.1">.gitignore</span></strong><span class="koboSpan" id="kobo.415.1"> file as an example, we are ensuring that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.416.1">node_modules</span></strong><span class="koboSpan" id="kobo.417.1"> folder will not</span><a id="_idIndexMarker569"/><span class="koboSpan" id="kobo.418.1"> be copied to the image . </span><span class="koboSpan" id="kobo.418.2">Keep in mind that the</span><a id="_idIndexMarker570"/><span class="koboSpan" id="kobo.419.1"> image and the service that will be run from it (called a container in the Docker ecosystem) is as if it were a new machine and we will only copy what our application needs </span><span class="No-Break"><span class="koboSpan" id="kobo.420.1">to run.</span></span></p>
<p><span class="koboSpan" id="kobo.421.1">The next step is to create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.422.1">dockerfile</span></strong><span class="koboSpan" id="kobo.423.1"> file and add the following code </span><span class="No-Break"><span class="koboSpan" id="kobo.424.1">to it:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.425.1">
FROM node:18-alpine as build
COPY package.json package-lock.json ./
RUN npm ci &amp;&amp; mkdir /gym-app &amp;&amp; mv ./node_modules ./gym-app/
WORKDIR /gym-app
COPY . </span><span class="koboSpan" id="kobo.425.2">.
</span><span class="koboSpan" id="kobo.425.3">RUN npm run build
FROM nginx:1.25-alpine
COPY nginx.default.conf /etc/nginx/conf.d/default.conf
RUN rm -rf /usr/share/nginx/html/*
COPY --from=build /gym-app/dist/gym-diary /usr/share/nginx/html
CMD ["nginx", "-g", "daemon off;"]</span></pre> <p><span class="koboSpan" id="kobo.426.1">In this file, we are using the multi-stage build technique to create our image. </span><span class="koboSpan" id="kobo.426.2">First, we build the application and then use the result of this build to create the final image. </span><span class="koboSpan" id="kobo.426.3">This way, our image becomes smaller and </span><span class="No-Break"><span class="koboSpan" id="kobo.427.1">more optimized.</span></span></p>
<p><span class="koboSpan" id="kobo.428.1">The first stage, which we call </span><strong class="source-inline"><span class="koboSpan" id="kobo.429.1">build</span></strong><span class="koboSpan" id="kobo.430.1"> here, is based on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.431.1">node:18-alpine</span></strong><span class="koboSpan" id="kobo.432.1"> image, which is a minimal image with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.433.1">Alpine</span></strong><span class="koboSpan" id="kobo.434.1"> Linux distribution and version 18 of </span><span class="No-Break"><span class="koboSpan" id="kobo.435.1">Node.js included.</span></span></p>
<p><span class="koboSpan" id="kobo.436.1">Then, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.437.1">package.json</span></strong><span class="koboSpan" id="kobo.438.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.439.1">package-lock.json</span></strong><span class="koboSpan" id="kobo.440.1"> files are copied and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.441.1">npm ci</span></strong><span class="koboSpan" id="kobo.442.1"> command is run to install </span><span class="No-Break"><span class="koboSpan" id="kobo.443.1">the package.</span></span></p>
<p><span class="koboSpan" id="kobo.444.1">Then, with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.445.1">COPY . </span><span class="koboSpan" id="kobo.445.2">.</span></strong><span class="koboSpan" id="kobo.446.1"> command, all project code is copied (except the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.447.1">node_module</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.448.1"> folder).</span></span></p>
<p><span class="koboSpan" id="kobo.449.1">At the end of this stage, our application bundle is generated using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.450.1">npm run </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.451.1">build</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.452.1"> command.</span></span></p>
<p><span class="koboSpan" id="kobo.453.1">The next stage, which </span><a id="_idIndexMarker571"/><span class="koboSpan" id="kobo.454.1">will be production, is based on</span><a id="_idIndexMarker572"/><span class="koboSpan" id="kobo.455.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.456.1">nginx:1.25-alpine</span></strong><span class="koboSpan" id="kobo.457.1"> image because to run the web server, we only need a Linux distribution such as </span><span class="No-Break"><span class="koboSpan" id="kobo.458.1">Nginx installed.</span></span></p>
<p><span class="koboSpan" id="kobo.459.1">The next task is to copy the configuration file for the Nginx installation, delete the example file that comes with the tool, and copy the files generated in the previous stage to </span><span class="No-Break"><span class="koboSpan" id="kobo.460.1">this one.</span></span></p>
<p><span class="koboSpan" id="kobo.461.1">The line </span><strong class="source-inline"><span class="koboSpan" id="kobo.462.1">["nginx", "-g", "daemon off;"]</span></strong><span class="koboSpan" id="kobo.463.1"> runs Nginx and makes it ready to deliver </span><span class="No-Break"><span class="koboSpan" id="kobo.464.1">our application.</span></span></p>
<p><span class="koboSpan" id="kobo.465.1">To mount the image, right-click on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.466.1">dockerfile</span></strong><span class="koboSpan" id="kobo.467.1"> file in VSCode and select the </span><strong class="bold"><span class="koboSpan" id="kobo.468.1">Build </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.469.1">Image</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.470.1"> option.</span></span></p>
<p><span class="koboSpan" id="kobo.471.1">To run the Docker container locally, use the </span><span class="No-Break"><span class="koboSpan" id="kobo.472.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.473.1">
docker run -p 8080:80 gymdiary</span></pre> <p><span class="koboSpan" id="kobo.474.1">By </span><a id="_idIndexMarker573"/><span class="koboSpan" id="kobo.475.1">accessing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.476.1">http://localhost:8080</span></strong><span class="koboSpan" id="kobo.477.1"> URL, we</span><a id="_idIndexMarker574"/><span class="koboSpan" id="kobo.478.1"> have our application running in production mode. </span><span class="koboSpan" id="kobo.478.2">Another way to put our project on the web is by using Azure Static Web Apps. </span><span class="koboSpan" id="kobo.478.3">We will wo</span><a id="_idTextAnchor323"/><a id="_idTextAnchor324"/><span class="koboSpan" id="kobo.479.1">rk on this in the </span><span class="No-Break"><span class="koboSpan" id="kobo.480.1">next section.</span></span></p>
<h1 id="_idParaDest-160"><a id="_idTextAnchor325"/><span class="koboSpan" id="kobo.481.1">Deploying a page to Azure Static Web Apps</span></h1>
<p><span class="koboSpan" id="kobo.482.1">With the</span><a id="_idIndexMarker575"/><span class="koboSpan" id="kobo.483.1"> Docker image we created, we can run our </span><a id="_idIndexMarker576"/><span class="koboSpan" id="kobo.484.1">project on any cloud provider that offers container services. </span><span class="koboSpan" id="kobo.484.2">However, there are other ways to deploy our </span><span class="No-Break"><span class="koboSpan" id="kobo.485.1">Angular project.</span></span></p>
<p><span class="koboSpan" id="kobo.486.1">One of these alternatives is Azure Static Web Apps, a service that specializes in web page design and allows automatic integration with GitHub. </span><span class="koboSpan" id="kobo.486.2">Let’s see it in practice in </span><span class="No-Break"><span class="koboSpan" id="kobo.487.1">our project.</span></span></p>
<p><span class="koboSpan" id="kobo.488.1">The first requirement is that your project is on GitHub, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.489.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer080">
<span class="koboSpan" id="kobo.490.1"><img alt="Figure 12.10 – GitHub repository for frontend project" src="image/B19562_12_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.491.1">Figure 12.10 – GitHub repository for frontend project</span></p>
<p><span class="koboSpan" id="kobo.492.1">If you have copied the project repository, place the </span><strong class="source-inline"><span class="koboSpan" id="kobo.493.1">gym-diary</span></strong><span class="koboSpan" id="kobo.494.1"> folder in your own </span><span class="No-Break"><span class="koboSpan" id="kobo.495.1">GitHub project.</span></span></p>
<p><span class="koboSpan" id="kobo.496.1">To configure the Azure service, go to the account portal and search for </span><strong class="source-inline"><span class="koboSpan" id="kobo.497.1">Static </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.498.1">Web Apps</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.499.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.500.1">Click on the </span><strong class="bold"><span class="koboSpan" id="kobo.501.1">Create Static Web App</span></strong><span class="koboSpan" id="kobo.502.1"> button and the service form will be presented </span><span class="No-Break"><span class="koboSpan" id="kobo.503.1">to you.</span></span></p>
<p><span class="koboSpan" id="kobo.504.1">In the first part, we</span><a id="_idIndexMarker577"/><span class="koboSpan" id="kobo.505.1"> have the </span><a id="_idIndexMarker578"/><span class="No-Break"><span class="koboSpan" id="kobo.506.1">following fields:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.507.1">Subscription</span></strong><span class="koboSpan" id="kobo.508.1">: Select your </span><span class="No-Break"><span class="koboSpan" id="kobo.509.1">Azure subscription.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.510.1">Resource Group</span></strong><span class="koboSpan" id="kobo.511.1">: Create or define a group for this service. </span><span class="koboSpan" id="kobo.511.2">In Azure, every resource must be linked to a </span><span class="No-Break"><span class="koboSpan" id="kobo.512.1">resource group.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.513.1">Name</span></strong><span class="koboSpan" id="kobo.514.1">: Provide a name for your </span><span class="No-Break"><span class="koboSpan" id="kobo.515.1">frontend project.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.516.1">Plan type</span></strong><span class="koboSpan" id="kobo.517.1">: Select the tier of your environment. </span><span class="koboSpan" id="kobo.517.2">The more resources, the higher the cost, but for our example, we will just use the </span><span class="No-Break"><span class="koboSpan" id="kobo.518.1">free plan.</span></span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer081">
<span class="koboSpan" id="kobo.519.1"><img alt="Figure 12.11 – Azure Static Web App creation" src="image/B19562_12_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.520.1">Figure 12.11 – Azure Static Web App creation</span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.521.1">Source</span></strong><span class="koboSpan" id="kobo.522.1">: In this field, we identify whether our project is on GitHub or in the </span><span class="No-Break"><span class="koboSpan" id="kobo.523.1">Azure repository.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.524.1">Organization</span></strong><span class="koboSpan" id="kobo.525.1">: The name of the GitHub user or organization that you want to select the repository from. </span><span class="koboSpan" id="kobo.525.2">It is important that your user has high access permission, such as maintainer </span><span class="No-Break"><span class="koboSpan" id="kobo.526.1">or admin.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.527.1">Repository</span></strong><span class="koboSpan" id="kobo.528.1">: Azure will list all the repositories that you have access to in the </span><span class="No-Break"><span class="koboSpan" id="kobo.529.1">selected organization..</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.530.1">Branch</span></strong><span class="koboSpan" id="kobo.531.1">: The branch </span><a id="_idIndexMarker579"/><span class="koboSpan" id="kobo.532.1">of the repository that you want</span><a id="_idIndexMarker580"/> <span class="No-Break"><span class="koboSpan" id="kobo.533.1">to deploy.</span></span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer082">
<span class="koboSpan" id="kobo.534.1"><img alt=" Figure 12.12 – Deployment details configuration" src="image/B19562_12_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.535.1"> Figure 12.12 – Deployment details configuration</span></p>
<p><span class="koboSpan" id="kobo.536.1">In the second part, we have the specific configuration for our project </span><span class="No-Break"><span class="koboSpan" id="kobo.537.1">using Angular:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.538.1">Build Presets</span></strong><span class="koboSpan" id="kobo.539.1">: The Azure service supports several frontend technologies. </span><span class="koboSpan" id="kobo.539.2">Here, in this case, we will </span><span class="No-Break"><span class="koboSpan" id="kobo.540.1">choose </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.541.1">Angular</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.542.1">.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.543.1">App location</span></strong><span class="koboSpan" id="kobo.544.1">: We must indicate within GitHub which folder contains the Angular project, as our project is in the root of the repo. </span><span class="koboSpan" id="kobo.544.2">We can leave it </span><span class="No-Break"><span class="koboSpan" id="kobo.545.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.546.1">/</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.547.1">.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.548.1">Api location</span></strong><span class="koboSpan" id="kobo.549.1">: This is an optional field if you want to point to a backend service deployed in Azure. </span><span class="koboSpan" id="kobo.549.2">Here, in this example, we are going to leave </span><span class="No-Break"><span class="koboSpan" id="kobo.550.1">it blank.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.551.1">Output location</span></strong><span class="koboSpan" id="kobo.552.1">: We</span><a id="_idIndexMarker581"/><span class="koboSpan" id="kobo.553.1"> must place the location where</span><a id="_idIndexMarker582"/><span class="koboSpan" id="kobo.554.1"> the build is generated within the repository. </span><span class="koboSpan" id="kobo.554.2">In the case of our project, we will </span><span class="No-Break"><span class="koboSpan" id="kobo.555.1">set </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.556.1">dist/gym-diary/</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.557.1">.</span></span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer083">
<span class="koboSpan" id="kobo.558.1"><img alt="Figure 12.13 – Preset settings" src="image/B19562_12_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.559.1">Figure 12.13 – Preset settings</span></p>
<p><span class="koboSpan" id="kobo.560.1">Once done, click on </span><strong class="bold"><span class="koboSpan" id="kobo.561.1">Review and Create</span></strong><span class="koboSpan" id="kobo.562.1">, and on the next screen, confirm the operation. </span><span class="koboSpan" id="kobo.562.2">Azure will begin processing, and once ready, it will display the created </span><span class="No-Break"><span class="koboSpan" id="kobo.563.1">service dashboard:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer084">
<span class="koboSpan" id="kobo.564.1"><img alt="Figure 12.14 – Service dashboard created" src="image/B19562_12_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.565.1">Figure 12.14 – Service dashboard created</span></p>
<p><span class="koboSpan" id="kobo.566.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.567.1">URL</span></strong><span class="koboSpan" id="kobo.568.1"> field, you will see the URL created by Azure for our project. </span><span class="koboSpan" id="kobo.568.2">Select it and our system will be presented as soon as the deploy status is </span><strong class="bold"><span class="koboSpan" id="kobo.569.1">Ready</span></strong><span class="koboSpan" id="kobo.570.1">. </span><span class="koboSpan" id="kobo.570.2">So, we have our project up and running </span><a id="_idIndexMarker583"/><span class="koboSpan" id="kobo.571.1">in the cloud. </span><span class="koboSpan" id="kobo.571.2">You can configure other settings, such </span><a id="_idIndexMarker584"/><span class="koboSpan" id="kobo.572.1">as adding your own URL, although remember that some settings are not available in the </span><span class="No-Break"><span class="koboSpan" id="kobo.573.1">free plan.</span></span></p>
<p><span class="koboSpan" id="kobo.574.1">The most interesting thing about this feature is that it implements a GitHub action in </span><span class="No-Break"><span class="koboSpan" id="kobo.575.1">our repository:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer085">
<span class="koboSpan" id="kobo.576.1"><img alt="Figure 12.15 – GitHub action" src="image/B19562_12_15.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.577.1">Figure 12.15 – GitHub action</span></p>
<p><span class="koboSpan" id="kobo.578.1">What is a GitHub action? </span><span class="koboSpan" id="kobo.578.2">It is a GitHub feature that allows the creation and execution of scripts to automate</span><a id="_idIndexMarker585"/><span class="koboSpan" id="kobo.579.1"> tasks, such as, in our example, deploying to the </span><span class="No-Break"><span class="koboSpan" id="kobo.580.1">Azure service.</span></span></p>
<p><span class="koboSpan" id="kobo.581.1">With our configuration, the Azure wizard created and ran the script in our </span><span class="No-Break"><span class="koboSpan" id="kobo.582.1">GitHub repository.</span></span></p>
<p><span class="koboSpan" id="kobo.583.1">A bonus is that our generated script is configured to execute and deploy with each push we make to the repository, updating ou</span><a id="_idTextAnchor326"/><span class="koboSpan" id="kobo.584.1">r application deployed in </span><span class="No-Break"><span class="koboSpan" id="kobo.585.1">the cloud.</span></span></p>
<h1 id="_idParaDest-161"><a id="_idTextAnchor327"/><span class="koboSpan" id="kobo.586.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.587.1">In this chapter, we explored the techniques and capabilities of Angular when deploying our application </span><span class="No-Break"><span class="koboSpan" id="kobo.588.1">to production.</span></span></p>
<p><span class="koboSpan" id="kobo.589.1">We started by uploading our backend to the cloud, where it will be available for our </span><span class="No-Break"><span class="koboSpan" id="kobo.590.1">frontend application.</span></span></p>
<p><span class="koboSpan" id="kobo.591.1">Then, we adapted our application to differentiate the development environment and the production environment using the Angular feature of </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.592.1">environment.ts</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.593.1"> files.</span></span></p>
<p><span class="koboSpan" id="kobo.594.1">We explored the </span><strong class="source-inline"><span class="koboSpan" id="kobo.595.1">ng build</span></strong><span class="koboSpan" id="kobo.596.1"> command and all the tasks that Angular performs for us to make our application as lean as possible to be faster for </span><span class="No-Break"><span class="koboSpan" id="kobo.597.1">our users.</span></span></p>
<p><span class="koboSpan" id="kobo.598.1">We learned about Docker and how we can package our Angular application to run on a web server such as Nginx regardless of the type of machine our application </span><span class="No-Break"><span class="koboSpan" id="kobo.599.1">runs on.</span></span></p>
<p><span class="koboSpan" id="kobo.600.1">Finally, we learned about another way to deploy to the cloud with the Azure Static Web Apps service and saw how it automates this process by creating a GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.601.1">action script.</span></span></p>
<p><span class="koboSpan" id="kobo.602.1">In the next chapter, we will explore the latest Angular innovations, including </span><span class="No-Break"><span class="koboSpan" id="kobo.603.1">Angular Signals.</span></span></p>
</div>
</body></html>