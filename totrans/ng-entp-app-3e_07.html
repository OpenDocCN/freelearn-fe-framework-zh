<html><head></head><body>
  <div id="_idContainer351">
    <h1 class="chapterNumber">7</h1>
    <h1 id="_idParaDest-212" class="chapterTitle">Working with REST and GraphQL APIs</h1>
    <p class="normal">In <em class="chapterRef">Chapter 1</em>, <em class="italic">Angular’s Architecture and Concepts</em>, I introduced you to the wider architecture in which web applications exist, and in <em class="chapterRef">Chapter 3</em>, <em class="italic">Architecting an Enterprise App</em>, we discussed various performance bottlenecks that can impact the success of your app. However, your web app can only perform as well as your full-stack architecture performs. If you’re working with an inadequate API design or a slow database, you will spend your time implementing band-aid solutions instead of addressing the root cause of the issues. The moment we move away from the minimalist mindset and start patching holes, we are on our way to constructing a fragile tower that is at risk of collapsing or very expensive to maintain. In short, the choices made in full-stack architecture can profoundly impact the success of your web application. You and your team simply cannot afford to be ignorant of how APIs are designed. Often, the correct way to implement a new feature<a id="_idIndexMarker620"/> or fix a performance issue is by redesigning an API endpoint. The <strong class="keyWord">MEAN</strong> stack, using <strong class="keyWord">MongoDB</strong>, <strong class="keyWord">Express</strong>, <strong class="keyWord">Angular</strong>, and <strong class="keyWord">Node.js</strong>, is a popular set of technologies aligned around similar technologies that should ease adoption by web developers. My take on the MEAN stack is minimal MEAN, which prioritizes ease of use, well-being, and effectiveness, the main<a id="_idIndexMarker621"/> ingredients for a great <strong class="keyWord">DevEx</strong>.</p>
    <p class="normal">In the past two chapters, we designed and implemented a <strong class="keyWord">Role-Based Access Control </strong>(<strong class="keyWord">RBAC</strong>) mechanism for our app. In <em class="chapterRef">Chapter 5</em>, <em class="italic">Designing Authentication and Authorization</em>, we dove into security considerations, covered how JWT authentication works, learned how to safely handle data with TypeScript, and tapped into <strong class="keyWord">Object Oriented Programming</strong> (<strong class="keyWord">OOP</strong>) design with inheritance and abstraction to build an extendable auth service. In <em class="chapterRef">Chapter 6</em>, <em class="italic">Implementing Role-Based Navigation</em>, we designed a conditional navigation experience using our auth service and implemented auth providers for custom APIs and Google Firebase.</p>
    <p class="normal">In this chapter, I’ll introduce you to the LemonMart server, which implements JWT auth, REST, and GraphQL APIs. We will use these APIs to implement two custom auth providers in Angular. This will allow you to make authenticated calls to support recipes I will cover in <em class="chapterRef">Chapter 8</em>, <em class="italic">Recipes – Reusability, Forms, and Caching, and Caching</em>, and <em class="chapterRef">Chapter 9</em>, <em class="italic">Recipes – Master/Detail, Data Tables, and NgRx</em>.</p>
    <p class="normal">This chapter covers a lot of ground. It is designed to serve as a roadmap to the GitHub repository (<a href="https://github.com/duluca/lemon-mart-server"><span class="url">https://github.com/duluca/lemon-mart-server</span></a>). I cover the architecture, design, and major components of the implementation. I highlight important pieces of code to explain how the solution comes together but avoid going into implementation details. It is more important that you understand why we are implementing various components rather than having a strong grasp of the implementation details. For this chapter, I recommend that you read and understand the server code versus trying to recreate it on your own.</p>
    <p class="normal">We begin by covering full-stack architecture, the LemonMart server’s monorepo design, and how to use Docker Compose to run a three-tier application with a web app, server, and database. Then, we will review REST and GraphQL API design, implementation, and documentation. For REST, we will leverage the <strong class="keyWord">OpenAPI</strong> specification with <strong class="keyWord">SwaggerUI</strong>. For GraphQL, we will leverage <strong class="keyWord">GraphQL schemas</strong> with <strong class="keyWord">Apollo Studio</strong>. Both APIs will be implemented using Express.js and TypeScript. Then, we will cover the implementation of a MongoDB <strong class="keyWord">Object Document Mapper</strong> (<strong class="keyWord">ODM</strong>) using the DocumentTS library to store users with login credentials. Finally, we will implement a token-based auth function to secure our APIs and the corresponding auth providers in Angular.</p>
    <p class="normal">In this chapter, you will learn about the following:</p>
    <ul>
      <li class="bulletList">Full-stack architecture</li>
      <li class="bulletList">Working with monorepos</li>
      <li class="bulletList">Designing APIs</li>
      <li class="bulletList">Implementing APIs with Express.js</li>
      <li class="bulletList">A MongoDB ODM with DocumentTS</li>
      <li class="bulletList">Implementing JWT auth</li>
      <li class="bulletList">A custom server auth provider</li>
    </ul>
    <h1 id="_idParaDest-213" class="heading-1">Technical requirements</h1>
    <p class="normal">The most up-to-date versions of the sample code for the book can be found on GitHub at the following linked repository. The repository contains the final and completed state of the code. This chapter requires the Docker Desktop and Postman applications.</p>
    <div class="note">
      <p class="normal">It is critical that you get <strong class="keyWord">lemon-mart-server</strong> up and running on your development environment and have <strong class="keyWord">lemon-mart</strong> communicate with it. Refer to the instructions documented here or in the <code class="inlineCode">README</code> on GitHub to get your server up and running.</p>
    </div>
    <p class="normal">For server-side implementation in<em class="italic"> Chapter 7</em>:</p>
    <ul>
      <li class="bulletList">Clone the <code class="inlineCode">lemon-mart-server</code> repository using the <code class="inlineCode">--recurse-submodules</code> option:
        <pre class="programlisting con"><code class="hljs-con">git clone --recurse-submodules https://github.com/duluca/lemon-mart-server
</code></pre>
      </li>
      <li class="bulletList">In the VS Code terminal, execute <code class="inlineCode">cd web-app; git checkout master</code> to ensure the submodule from <a href="https://github.com/duluca/lemon-mart"><span class="url">https://github.com/duluca/lemon-mart</span></a> is on the master branch.
    <div class="note">
      <p class="normal">Later, in the <em class="italic">Git submodules</em> section, you can configure the <code class="inlineCode">web-app</code> folder to pull from your <code class="inlineCode">lemon-mart</code> server.</p>
    </div></li>
    </ul>
    <ul>
      <li class="bulletList">Execute <code class="inlineCode">npm install</code> in the <code class="inlineCode">root</code> folder to install dependencies.<div class="note">
          <p class="normal">Note that running the <code class="inlineCode">npm install</code> command in the root folder triggers a script, which also installs dependencies under the <code class="inlineCode">server</code> and <code class="inlineCode">web-app</code> folders.</p>
        </div>
      </li>
    </ul>
    <ul>
      <li class="bulletList">Execute <code class="inlineCode">npm run init:env</code> in the root folder to configure environment variables in <code class="inlineCode">.env</code> files.
    <div class="note">
      <p class="normal">This command will create two <code class="inlineCode">.env</code> files, one in the root folder and the other under the <code class="inlineCode">server</code> folder, to contain your private configuration information. The initial files are generated based on the <code class="inlineCode">example.env</code> file. You can modify these files later and set your own secure secrets.</p>
    </div></li>
    </ul>
    <ul>
      <li class="bulletList">Execute <code class="inlineCode">npm run build</code> in the root folder, which builds the server and the web app.
    <div class="note">
      <p class="normal">Note that the web app is built using a new configuration named <code class="inlineCode">--configuration=lemon-mart-server</code>, which uses <code class="inlineCode">src/environments/environment.lemon-mart-server.ts</code>.</p>
    </div></li>
    </ul>
    <ul>
      <li class="bulletList">Execute <code class="inlineCode">docker compose up --build</code> to run containerized versions of the server, web app, and a MongoDB database.
    <div class="note">
      <p class="normal">Note that the web app is containerized using a new file named <code class="inlineCode">nginx.Dockerfile</code>.</p>
    </div></li>
    </ul>
    <ul>
      <li class="bulletList">Navigate to <code class="inlineCode">http://localhost:8080</code> to view the web app.<div class="note">
          <p class="normal">To log in, click the <strong class="screenText">Fill</strong> button to populate the email and password fields with the default demo credentials.</p>
        </div>
      </li>
    </ul>
    <ul>
      <li class="bulletList">Navigate to <code class="inlineCode">http://localhost:3000</code> to view the server landing page:
    <figure class="mediaobject"><img src="../Images/B20960_07_01.png" alt="A screenshot of a phone  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 7.1: LemonMart Server landing page</p></li>
    </ul>
    <ul>
      <li class="bulletList">Navigate to <code class="inlineCode">http://localhost:3000/api-docs</code> to view interactive API documentation.</li>
      <li class="bulletList">You can use <code class="inlineCode">npm run start:database</code> to only start the database, and <code class="inlineCode">npm start</code> on the <code class="inlineCode">server</code> folder for debugging.</li>
      <li class="bulletList">You can use <code class="inlineCode">npm run start:backend</code> to only start the database and the server, and <code class="inlineCode">npm start</code> on the <code class="inlineCode">web-app</code> folder for debugging.</li>
    </ul>
    <p class="normal">For client-side implementations in<em class="italic"> Chapter 7</em>:</p>
    <ul>
      <li class="bulletList">Clone the repository: <a href="https://github.com/duluca/lemon-mart"><span class="url">https://github.com/duluca/lemon-mart</span></a>.</li>
      <li class="bulletList">Execute <code class="inlineCode">npm install</code> in the root folder to install dependencies.</li>
      <li class="bulletList">The beginning state of the project is reflected at:
        <pre class="programlisting con"><code class="hljs-con">projects/stage8
</code></pre>
      </li>
      <li class="bulletList">The end state of the project is reflected at:
        <pre class="programlisting con"><code class="hljs-con">projects/stage10
</code></pre>
      </li>
      <li class="bulletList">Add the stage name to any <code class="inlineCode">ng</code> command to act only on that stage:
        <pre class="programlisting con"><code class="hljs-con">npx ng build stage10
</code></pre>
      </li>
    </ul>
    <div class="packt_tip">
      <p class="normal">Note that the <code class="inlineCode">dist/stage10</code> folder at the root of the repository will contain the compiled result.</p>
    </div>
    <div class="note">
      <p class="normal">Beware that the source code provided in the book and the version on GitHub are likely to be different. The ecosystem around these projects is ever-evolving. Between changes in how Angular CLI generates new code, bug fixes, new versions of libraries, and side-by-side implementations of multiple techniques, there are a lot of variations that are impossible to account for. If you find errors or have questions, please create an issue or submit a pull request on GitHub.</p>
    </div>
    <p class="normal">With your LemonMart server up and running, we are ready to explore the architecture of the MEAN stack. By the end of this section, you should have your own version of LemonMart communicating with the server.</p>
    <h1 id="_idParaDest-214" class="heading-1">Full-stack architecture</h1>
    <p class="normal"><strong class="keyWord">Full-stack</strong> refers to the entire stack<a id="_idIndexMarker622"/> of software that makes an application work, from databases to servers, APIs, and the web and/or mobile apps that leverage them. The mythical full-stack developer is all-knowing and can comfortably operate in all verticals of the profession. It is next to impossible to specialize in all things<em class="italic"> software-related</em> and to be considered an expert in every given topic. However, to be considered an expert in a single topic, you must also be well-versed in related topics. When learning about a new topic, it is very helpful to keep your tooling and language consistent to absorb new information without additional noise.</p>
    <p class="normal">For these reasons, I opted to introduce you to the MEAN stack, rather than Spring Boot using Java or ASP.NET using C#. By sticking to familiar tools and languages such as TypeScript, VS Code, npm, GitHub, Jasmine/Jest, Docker, and CircleCI, you can better understand how a full-stack implementation comes together and become a better web developer.</p>
    <h2 id="_idParaDest-215" class="heading-2">Minimal MEAN</h2>
    <p class="normal">Choosing the <strong class="keyWord">ideal stack</strong> for your project<a id="_idIndexMarker623"/> is difficult. First<a id="_idIndexMarker624"/> and foremost, your technical architecture should be adequate to meet business needs. For example, if you’re trying to deliver an artificial intelligence project with Node.js, you’re likely using the wrong stack. Our focus will be on delivering web applications, but beyond that, we have other parameters to consider, including the following:</p>
    <ul>
      <li class="bulletList">Ease of use</li>
      <li class="bulletList">Happiness</li>
      <li class="bulletList">Effectiveness</li>
    </ul>
    <p class="normal">If your development team will be working<a id="_idIndexMarker625"/> on your application for an extended <a id="_idIndexMarker626"/>period, it is very important to consider factors beyond compatibility. Your stack, choice of tool, and coding style can have a significant impact if your codebase is easy to use, keeps your developers happy, or makes them feel like effective contributors to the project.</p>
    <p class="normal">A well-configured stack is key for a great DevEx. This can be the difference between a towering stack of dried-out pancakes or a delicious short stack, with the right amount of butter and syrup.</p>
    <p class="normal">By introducing too many libraries and dependencies, you can slow down your progress, make your code difficult to maintain, and find yourself in a feedback loop of introducing more libraries to resolve the issues of other libraries. The only way to win this game is to simply not play it.</p>
    <p class="normal">If you take your time to learn how to work with a few fundamental libraries, you can become a far more effective developer. In essence, you can do more with less. My advice would be to:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Think</strong> before you write a single line of code and apply the 80-20 rule.</li>
      <li class="bulletList"><strong class="keyWord">Wait</strong> for libraries and tools to mature, skipping the betas.</li>
      <li class="bulletList"><strong class="keyWord">Fast</strong> by reducing your gluttony for new packages and tools, mastering the fundamentals instead.</li>
    </ul>
    <div class="packt_tip">
      <p class="normal">Watch my 2017 Ng conference talk entitled <em class="italic">Do More with Less JavaScript</em> on YouTube at <a href="https://www.youtube.com/watch?v=Sd1aM8181kc"><span class="url">https://www.youtube.com/watch?v=Sd1aM8181kc</span></a>.</p>
    </div>
    <p class="normal">This minimalist mindset is the design philosophy behind minimal MEAN. You can review a reference implementation on GitHub at <a href="https://github.com/duluca/minimal-mean"><span class="url">https://github.com/duluca/minimal-mean</span></a>. Refer to the following diagram for the overall architecture:</p>
    <figure class="mediaobject"><img src="../Images/B20960_07_02.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 7.2: Minimal MEAN software stack and tooling</p>
    <p class="normal">Let’s go over<a id="_idIndexMarker627"/> the components<a id="_idIndexMarker628"/> of the architecture:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Angular</strong>: You know this one. Angular<a id="_idIndexMarker629"/> is the presentation<a id="_idIndexMarker630"/> layer. The output of an Angular build is a set of static files that can be hosted using the minimal Docker container, <code class="inlineCode">duluca/minimal-nginx-web-server,</code> or <code class="inlineCode">duluca/minimal-node-web-server</code>.</li>
      <li class="bulletList"><strong class="keyWord">Express.js</strong>: This is our API layer. Express is a fast, unopinionated, and minimalist web framework for Node.js. Express has a vast plugin ecosystem that is almost guaranteed to meet every need. NestJS is built on Express and is a good alternative for well-established teams. In minimal MEAN, we leverage a few Express middleware:<ul>
          <li class="bulletList"><code class="inlineCode">cors</code>: configures cross-origin resource-sharing settings</li>
          <li class="bulletList"><code class="inlineCode">compression</code>: zips packets sent across the wire to lower bandwidth use</li>
          <li class="bulletList"><code class="inlineCode">morgan</code>: logs HTTP requests</li>
          <li class="bulletList"><code class="inlineCode">express.static:</code> function to serve the content of the <code class="inlineCode">public</code> folder</li>
          <li class="bulletList"><code class="inlineCode">graphql: </code>to host GraphQL endpoint</li>
        </ul>
      </li>
    </ul>
    <p class="normal">You can read more about Express.js at <a href="https://expressjs.com/"><span class="url">https://expressjs.com/</span></a></p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Node.js</strong>: This is the server runtime; Express runs on Node so that the business layer will be implemented in Node. Node is a lightweight and efficient JavaScript runtime that uses an event-driven, non-blocking I/O model that suits high-performance and real-time applications. You can increase the reliability of your Node applications by using TypeScript to develop your application.
    <div class="note">
      <p class="normal">Node runs everywhere, from fridges to smartwatches. Refer to the blog post by Frank Rosner on non-blocking I/O for a more in-depth explanation of the topic at <a href="https://blog.codecentric.de/en/2019/04/explain-non-blocking-i-o-like-im-five/"><span class="url">https://blog.codecentric.de/en/2019/04/explain-non-blocking-i-o-like-im-five/</span></a>.</p>
    </div></li>
    </ul>
    <ul>
      <li class="bulletList"><strong class="keyWord">MongoDB</strong>: This is the persistence layer. MongoDB<a id="_idIndexMarker631"/> is a document-oriented<a id="_idIndexMarker632"/> database with dynamic JSON-like schemas. Read more about<a id="_idIndexMarker633"/> MongoDB at <a href="https://www.mongodb.com/"><span class="url">https://www.mongodb.com/</span></a>.</li>
    </ul>
    <p class="normal">The MEAN stack is preferred because it leverages the major benefit of using a JSON-based database, which means that you don’t need to transform your data from one format to another, as it crosses the layers of your stack – a major pain point when dealing with .NET, Java, and SQL servers. You can retrieve, display, edit, and update the data using only JSON. In addition, the MongoDB native driver for Node is mature, performant, and capable. I have developed a library called <code class="inlineCode">document-ts</code>, which aims to simplify interacting with MongoDB by introducing rich document objects that are easy to code. DocumentTS is a very thin TypeScript-based MongoDB helper with optional, rich ODM convenience features. Read more about DocumentTS at <a href="https://github.com/duluca/document-ts"><span class="url">https://github.com/duluca/document-ts</span></a>.</p>
    <p class="normal">Minimal MEAN leverages<a id="_idIndexMarker634"/> most of the same tooling and languages<a id="_idIndexMarker635"/> we use for Angular development. This enables developers to switch between frontend and backend development with minimal context switching.</p>
    <h2 id="_idParaDest-216" class="heading-2">NestJS</h2>
    <p class="normal">Minimal MEAN intentionally sticks<a id="_idIndexMarker636"/> to the basics, so you <a id="_idIndexMarker637"/>can learn more about the underlying technologies. While I have delivered production systems using minimal MEAN for larger teams with varying skill levels, this barebones development experience may not be appropriate. In this case, you may consider NestJS, a popular framework for implementing full-stack Node.js apps. NestJS has a rich feature set with an architecture and coding style resembling Angular.</p>
    <div class="note">
      <p class="normal">Feeling adventurous? Create a NestJS app by executing:</p>
      <pre class="programlisting con"><code class="hljs-con">$ npx @nestjs/cli new your-app-name --strict
</code></pre>
    </div>
    <p class="normal"> </p>
    <p class="normal">Nest is built on Express and provides syntactic sugar and concepts to build a scalable backend solution. The framework heavily borrows ideas from Angular to implement dependency injection, guards, interceptors, pipes, modules, and providers. The<a id="_idIndexMarker638"/> built-in resource <a id="_idIndexMarker639"/>generator can scaffold entity classes, <strong class="keyWord">CRUD</strong> (<strong class="keyWord">Create</strong>, <strong class="keyWord">Retrieve</strong>, <strong class="keyWord">Update</strong>, <strong class="keyWord">Delete</strong>) controllers, <strong class="keyWord">Data Transfer Objects</strong> (<strong class="keyWord">DTOs</strong>), and services.</p>
    <p class="normal">For example:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npx nest g resource users
</code></pre>
    <p class="normal">When creating a resource, you can choose between creating a REST, GraphQL, microservice, or WebSocket endpoint:</p>
    <pre class="programlisting con"><code class="hljs-con">? What transport layer do you use?
&gt; REST API 
  GraphQL (code first)
  GraphQL (schema first)
  Microservice (non-HTTP)
  WebSockets
</code></pre>
    <p class="normal">Nest supports OpenAPI for REST documentation, and GraphQL also supports schema-first and code-first development for GraphQL. For a library with so many features, Nest’s explicit Microservice support is welcome, where a fast boot-up time and small framework size are critical for operations. All these features are supported by detailed documentation at <a href="https://docs.nestjs.com/"><span class="url">https://docs.nestjs.com/</span></a>.</p>
    <div class="packt_tip">
      <p class="normal">Kudos to Kamil Mysliwiec and Mark Pieszak for creating a great tool and fostering a vibrant community around NestJS. Should<a id="_idIndexMarker640"/> you ever need it, you can solicit consulting services at <a href="https://trilon.io/"><span class="url">https://trilon.io/</span></a>.</p>
    </div>
    <p class="normal">If you visit the documentation site, you may be overwhelmed with the many options on offer. This is why I recommend <a id="_idIndexMarker641"/>using a feature-rich library like this after you have mastered the basics<a id="_idIndexMarker642"/> with minimal MEAN.</p>
    <p class="normal">You can read more<a id="_idIndexMarker643"/> about NestJS at <a href="https://nestjs.com/"><span class="url">https://nestjs.com/</span></a>.</p>
    <p class="normal">Next, let’s learn about monorepos, their benefits, and their downsides. I will share how you can combine Nx, Nest, and Angular in a monorepo, and then cover how LemonMart server uses Git submodules to create a monorepo.</p>
    <h1 id="_idParaDest-217" class="heading-1">Working with monorepos</h1>
    <p class="normal">A <strong class="keyWord">monorepo</strong> (<strong class="keyWord">monolithic repository</strong>) is a software development<a id="_idIndexMarker644"/> strategy to host code from multiple projects in a single repository. This allows for unified versioning, simplified dependency management, and easier code sharing across projects. In a monorepo, developers can jump between projects within the same IDE window and reference code more easily across projects, such as sharing TypeScript interfaces between the frontend and the backend, ensuring that data objects line up every time.</p>
    <div class="note">
      <p class="normal">You can enable access to multiple projects in the same IDE window using multi-root workspaces in VS Code, where you can add multiple projects to display in the <em class="italic">Explorer</em> window. However, a monorepo combines projects at the source control level, allowing us to build them together<a id="_idIndexMarker645"/> on our CI server. Read more about multi-root workspaces at <a href="https://code.visualstudio.com/docs/editor/multi-root-workspaces"><span class="url">https://code.visualstudio.com/docs/editor/multi-root-workspaces</span></a>.</p>
    </div>
    <p class="normal">Having access to code from multiple projects makes it possible to commit atomic changes, meaning changes made across projects can be combined into a single commit. This brings a distinct advantage by making it easy to push changes that may otherwise require coordination across multiple repos, deployments, and systems in one place. All processes around maintaining<a id="_idIndexMarker646"/> code quality and standards also become simplified. There’s one <strong class="keyWord">Pull Request</strong> (<strong class="keyWord">PR</strong>) to review, one deployment to verify, and one set of checks to enforce.</p>
    <p class="normal">So why is every project not a monorepo? In large applications, having too many files in the project can become a significant issue. It would require every developer to have top-of-the-line hardware and CI/CD servers to run on expensive, high-performance hardware. In addition, automating the deployment of such a project can become a very complex task. Finally, a new team member joining the team can find it overwhelming.</p>
    <p class="normal">While monorepos at least date back to the early 2000s, they were impractical to leverage as a strategy for most, except the top tech companies worldwide. In 2019, when Google released the open-source Bazel build tool, itself based on a 2015 internal project called Blaze, the idea became<a id="_idIndexMarker647"/> feasible for smaller-scale projects. In the JavaScript, TypeScript, and web app development world, Nx, developed by ex-Googlers, has risen to prominence. In terms of managing, building, and publishing packages, Lerna is a cousin of Nx.</p>
    <h2 id="_idParaDest-218" class="heading-2">Nx monorepo</h2>
    <p class="normal">As mentioned in <em class="chapterRef">Chapter 3</em>, <em class="italic">Architecting an Enterprise App</em>, Nx is a next-generation<a id="_idIndexMarker648"/> build system with<a id="_idIndexMarker649"/> first-class monorepo support and powerful integrations. Nx offers an opinionated architecture, which is welcome for large teams and enterprises. Nx also has a cloud offering, where it’ll leverage a distributed cache and parallelization to optimize builds without your team investing in complicated infrastructure work.</p>
    <p class="normal">You can set up a new Nx workspace by executing:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npx create-nx-workspace@latest
</code></pre>
    <p class="normal">Alternatively, you can migrate an existing project by executing the following command in the project folder:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npx nx@latest init
</code></pre>
    <p class="normal">By default, this will give you a monorepo configuration with one app. You can use Nx generators to add libraries that can be shared across components and other modules. By separating code into distinct libraries, multiple people working on the project simultaneously are less likely to have merge conflicts. However, if you follow the router-first architecture and segregate duties<a id="_idIndexMarker650"/> between feature modules, you can get similar results. There’s more at <a href="https://nx.dev/getting-started"><span class="url">https://nx.dev/getting-started</span></a>.</p>
    <p class="normal">The question is, is it worth it? Many experts use it as a standard tool; however, in my pursuit of minimalism, I’m not a fan of bringing a tank to a knife fight. There’s a cost to introducing a sophisticated piece of tech like this to a team. There’s a steep learning curve to adopt such a tool. </p>
    <p class="normal">When you layer JavaScript, TypeScript, Git, Nx, Angular, libraries, Node, npm, and other server-side tech on top of each other, the cognitive load required to navigate these tools goes through the roof. Furthermore, each one of these tools requires expertise to correctly configure, maintain, and upgrade them over time.</p>
    <p class="normal">On modern hardware (at least ones not addled by enterprise-grade <em class="italic">slow-everything-down-so-we-can-make-extra-sure-you-don’t-have-a-virus</em> software installed on it), Angular apps with several hundred components build fast enough. With the adoption of esbuild and Vite, this should improve even further. Nx’s distributed cache and centralized dependency management features may tip the scales for you. Always assess your needs carefully before starting a new project; running on autopilot, it’s easy to either under- or overestimate your needs.</p>
    <p class="normal">I want to make one thing crystal clear. If you are working<a id="_idIndexMarker651"/> with thousands of components, then Nx<a id="_idIndexMarker652"/> is a requirement.</p>
    <div class="note">
      <p class="normal">Most Angular monorepos only contain frontend code. To configure a full-stack monorepo using NestJS in an existing Angular workspace, install the Nest schematic and generate a new project within the Nx workspace:</p>
      <pre class="programlisting con"><code class="hljs-con">$ npm i -D @nrwl/nest
$ npx nx g @nrwl/nest:application apps/your-api
</code></pre>
      <p class="normal">You can read more about this at <a href="https://www.thisdot.co/blog/nx-workspace-with-angular-and-nest/"><span class="url">https://www.thisdot.co/blog/nx-workspace-with-angular-and-nest/</span></a>.</p>
    </div>
    <p class="normal">Next, let’s see how LemonMart server’s monorepo is configured.</p>
    <h2 id="_idParaDest-219" class="heading-2">Git submodules</h2>
    <p class="normal">Git submodules<a id="_idIndexMarker653"/> help you share code<a id="_idIndexMarker654"/> between multiple repositories while keeping the commits separate. Frontend developers may choose to only work using the frontend repository, whereas full-stack developers will prefer access to all code. Git submodules also provide a convenient way for existing projects to be combined.</p>
    <p class="normal">Observe the overall structure of the <code class="inlineCode">lemon-mart-server</code> project, where you are going to have three main folders, as shown here:</p>
    <pre class="programlisting code"><code class="hljs-code">lemon-mart-server
├───bin
├───web-app (snapshot of lemon-mart)
├───server
│   package.json
│   README.md
</code></pre>
    <p class="normal">The <code class="inlineCode">bin</code> folder contains helper scripts or tools, the <code class="inlineCode">web-app</code> folder represents your frontend, and <code class="inlineCode">server</code> contains the source code for the backend. In our case, the <code class="inlineCode">web-app</code> folder is the <code class="inlineCode">lemon-mart</code> project. Instead of copying and pasting the code from the existing project, we leverage Git submodules to link two repositories together. The <code class="inlineCode">package.json</code> file contains scripts that assist in the initialization, updating, and cleaning up of Git submodules, like <code class="inlineCode">modules:update</code> to fetch the latest version of the web app.</p>
    <div class="note">
      <p class="normal">I recommend<a id="_idIndexMarker655"/> that you perform the following actions on the version of <code class="inlineCode">lemon-mart-server</code> that you cloned from GitHub. Otherwise, you will need to create a new project and execute <code class="inlineCode">npm init -y</code> to get things started.</p>
    </div>
    <p class="normal">To initialize the web-app folder with your project:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Update <code class="inlineCode">webAppGitUrl</code> with the URL to your own project.</li>
      <li class="numberedList">Execute <code class="inlineCode">webapp:clean</code> to remove the existing <code class="inlineCode">web-app</code> folder.</li>
      <li class="numberedList">Finally, execute the <code class="inlineCode">webapp:init</code> command to initialize your project in the <code class="inlineCode">web-app</code> folder:
        <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npm run webapp:init
</code></pre>
      </li>
    </ol>
    <p class="normal">Going forward, execute the <code class="inlineCode">modules:update</code> command<a id="_idIndexMarker656"/> to update the code<a id="_idIndexMarker657"/> in the submodule. To pull the submodules after cloning the repo in another environment, execute <code class="inlineCode">npm modules:init</code>. If you ever need to reset the environment and restart, then execute <code class="inlineCode">webapp:clean</code> to clean Git’s cache and remove the folder.</p>
    <div class="packt_tip">
      <p class="normal">Note that you can have multiple submodules in your repository. The <code class="inlineCode">modules:update</code> command will update all the submodules.</p>
    </div>
    <p class="normal">Your web application code is now available in the folder named <code class="inlineCode">web-app</code>. Additionally, you should be able to see both projects under VS Code’s <strong class="screenText">SOURCE CONTROL</strong> pane, as shown here:</p>
    <figure class="mediaobject"><img src="../Images/B20960_07_03.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 7.3: VS Code source control providers</p>
    <p class="normal">Using VS Code’s source control, you can independently<a id="_idIndexMarker658"/> perform Git actions<a id="_idIndexMarker659"/> on either repository.</p>
    <div class="packt_tip">
      <p class="normal">If things get messy with your submodule, simply <code class="inlineCode">cd</code> into the submodule directory, execute <code class="inlineCode">git pull</code>, and then <code class="inlineCode">git checkout main</code> to restore the main branch. Using this technique, you may check out any branch from your project and submit PRs.</p>
    </div>
    <p class="normal">Now that our submodule is ready, let’s see how the server project is configured so that we can configure our CI server.</p>
    <h2 id="_idParaDest-220" class="heading-2">CircleCI config</h2>
    <p class="normal">One of the benefits of using Git<a id="_idIndexMarker660"/> submodules is that we can verify<a id="_idIndexMarker661"/> that our frontend and backend work in the same CI pipeline. The <code class="inlineCode">config.yml</code> file implements two jobs, part of the workflow shown here:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">.circleci/config.yml</strong></span>
<span class="hljs-string">...</span>
<span class="hljs-attr">workflows:</span>
  <span class="hljs-attr">build-and-test-compose:</span>
    <span class="hljs-attr">jobs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">build_server</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">build_webapp</span>
</code></pre>
    <p class="normal">The pipeline checks out the code, verifies the security of the packages we’re using with <code class="inlineCode">audit-ci</code>, installs dependencies, checks for styling and linting errors, runs tests, and checks for code coverage levels.</p>
    <p class="normal">The test commands implicitly build the server code, which is stored under the <code class="inlineCode">dist</code> folder. In the final step, we move the <code class="inlineCode">dist</code> folder into the workspace so that we can use it at a later stage.</p>
    <p class="normal">The CI pipeline will build the server and the web app in parallel, with an option to run the <code class="inlineCode">deploy</code> job if the jobs succeed<a id="_idIndexMarker662"/> on the main branch. There are more details on CI/CD in <em class="italic">Chapter 10, Releasing to Production</em><em class="italic"><a id="_idIndexMarker663"/></em><em class="italic"> with CI/CD</em>.</p>
    <p class="normal">Next, let’s see the difference between RESTful and GraphQL APIs.</p>
    <h1 id="_idParaDest-221" class="heading-1">Designing APIs</h1>
    <p class="normal">In <em class="chapterRef">Chapter 3</em>, <em class="italic">Architecting an Enterprise App</em>, I cover the importance<a id="_idIndexMarker664"/> of a stateless, data-driven design as part of Router-first architecture. As part of this goal, I highlight identifying major data entities that your app will operate around as an important activity. It’s no mistake that API design also greatly benefits by designing around major data entities.</p>
    <p class="normal">In full-stack development, nailing down the API design early on is important. If your frontend and backend teams can agree on major data entities and the shape of those entities, then both teams can agree on a contract to go off and build their own respective pieces of software. In Router-first architecture, I highlight the importance of leveraging TypeScript interfaces to quickly stub out the architecture of your app. Backend teams can conduct similar activities.</p>
    <p class="normal">A little bit of early design work and agreement ensures integration between these components can be established very early on, and with CI/CD pipelines, we can ensure it doesn’t disintegrate.</p>
    <div class="note">
      <p class="normal">CI is critical to success. One<a id="_idIndexMarker665"/> of the most infamous cases where teams didn’t integrate critical systems until too late was the disastrous launch of HealthCare.gov in 2013. Even though 300 people worked on it, and $300,000,000 was spent on this project, it failed. In total, 1.7 billion dollars had to be spent to rescue the project and make it successful. The US federal government can afford to do this. Your enterprise won’t be as accepting.</p>
    </div>
    <p class="normal">There are further considerations<a id="_idIndexMarker666"/> in designing your API, and if frontend and backend developers collaborate closely to achieve shared design goals, the chance of project success is greatly improved.</p>
    <p class="normal">Some high-level goals<a id="_idIndexMarker667"/> are listed as follows:</p>
    <ul>
      <li class="bulletList">Minimize data transmitted between the client and server.</li>
      <li class="bulletList">Stick to well-established design patterns (e.g., pagination API design).</li>
      <li class="bulletList">Design to reduce business logic implementation on the client.</li>
      <li class="bulletList">Design around major data entities.</li>
      <li class="bulletList">Flatten data structures when crossing boundaries.</li>
      <li class="bulletList">Do not expose database keys or foreign key relationships.</li>
      <li class="bulletList">Version endpoints from the get-go.</li>
    </ul>
    <p class="normal">You should aim to implement all the business logic behind your API surface. The frontend should only contain presentation logic. Any <code class="inlineCode">if</code> statement implemented by the frontend should also be verified in the backend.</p>
    <p class="normal">As discussed in <em class="chapterRef">Chapter 1</em>, <em class="italic">Angular’s Architecture and Concepts</em>, it is critical to aim for a stateless design in both the backend and frontend. Every request should utilize non-blocking I/O methods and not rely on existing sessions. This is the key to seamlessly scaling your web application code on cloud platforms. Sessions are notorious for scaling out and using a lot of memory.</p>
    <p class="normal">Whenever you’re implementing a project, it is important to limit, if not eliminate, experimentation. This is especially true in full-stack projects. The downstream effect of missteps in API design can be profound and impossible to correct once your application goes live. Proofs of concept are ideal places to experiment and validate ideas and new technologies. Their one great feature is how disposable they are.</p>
    <p class="normal">Next, let’s go over designing REST and GraphQL APIs around major data entities. In this case, we’ll review the implementation of an API surrounding users, including authentication. In both cases, we will rely on an API specification language. For REST, we will use the OpenAPI specification, and for GraphQL, the schemas specification, to document the design so that we can concretely<a id="_idIndexMarker668"/> communicate the intent of the API to team members. Later, these specs become interactive tools, reflecting the capability of our APIs.</p>
    <h2 id="_idParaDest-222" class="heading-2">REST APIs</h2>
    <p class="normal"><strong class="keyWord">REST </strong>(<strong class="keyWord">representational state transfer</strong>) is commonly used<a id="_idIndexMarker669"/> to create stateless, reliable web applications leveraging HTTP methods (verbs) like <strong class="keyWord">GET</strong>, <strong class="keyWord">POST</strong>, <strong class="keyWord">PUT</strong>, and <strong class="keyWord">DELETE</strong>. REST APIs are well defined and static. Like any public API, once released, it is very difficult, if not impossible, to change their interface. It is always possible to extend but hard to optimize for emergent use cases, like mobile or purpose-built apps that need to use the API differently. This usually leads to a great expansion of the API surface as teams implement specific APIs to match new needs. This can lead to maintainability challenges if there are a half-dozen separate codebase to access the same piece of data.</p>
    <p class="normal">From a frontend developer’s perspective, working with APIs they didn’t write can be a perplexing experience. Most public APIs and businesses that publish APIs usually resolve this by publishing high-quality documentation and examples. This takes time and money. However, a fast-moving team in an enterprise environment can’t afford to wait for such documentation to be manually created.</p>
    <p class="normal">Enter OpenAPI, aka Swagger. OpenAPI specs can document API names, routes, input and return parameter types, encoding, authentication, request headers, and expected HTTP status codes. This level of detail leaves little room for interpretation of how an API should be consumed, reducing friction and buggy code – all critical ingredients to avoid late-stage integration challenges.</p>
    <p class="normal">The OpenAPI spec can be defined in the YAML or JSON format. Using this spec file, you can render an interactive UI for your API. Install the Swagger Viewer VS Code extension and preview the <code class="inlineCode">swagger.yaml</code> file under the <code class="inlineCode">server</code> folder:</p>
    <div class="packt_tip">
      <p class="normal">There’s also the OpenAPI (Swagger) Editor extension, which is a feature-rich alternative. At the time of publishing, this extension doesn’t support OpenAPI version 3.1.0.</p>
    </div>
    <figure class="mediaobject"><img src="../Images/B20960_07_04.png" alt="A screenshot of a computer  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 7.4: Swagger.yaml preview</p>
    <p class="normal">Using the Swagger UI view, you can try out commands<a id="_idIndexMarker670"/> and execute them against your server environment once it’s implemented.</p>
    <h3 id="_idParaDest-223" class="heading-3">OpenAPI Spec</h3>
    <p class="normal">We are using the OpenAPI spec<a id="_idIndexMarker671"/> version <code class="inlineCode">openapi: 3.1.0</code>. The OpenAPI spec<a id="_idIndexMarker672"/> can document metadata about your server, various components of your API, like security schemes, responses, data schemas, and input parameters, and finally, the paths that define your HTTP endpoints.</p>
    <p class="normal">Let’s go over the major components of the <code class="inlineCode">swagger.yaml</code> file located under the <code class="inlineCode">server</code> folder:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">The YAML file starts<a id="_idIndexMarker673"/> with general information<a id="_idIndexMarker674"/> and target servers:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/swagger.yaml</strong></span>
<span class="hljs-attr">openapi:</span> <span class="hljs-number">3.1.0</span>
<span class="hljs-attr">info:</span>
  <span class="hljs-attr">title:</span> <span class="hljs-string">lemon-mart-server</span>
  <span class="hljs-attr">description:</span> <span class="hljs-string">LemonMart</span> <span class="hljs-string">API</span>
  <span class="hljs-attr">version:</span> <span class="hljs-string">"3.0.0</span><span class="code-highlight"><strong class="hljs-string-slc">"</strong></span>
<span class="code-highlight"><strong class="hljs-attr-slc">servers</strong></span><span class="hljs-attr">:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">url:</span> <span class="hljs-string">http://localhost:3000</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">Local</span> <span class="hljs-string">environment</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">url:</span> <span class="hljs-string">https://mystagingserver.com</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">Staging</span> <span class="hljs-string">environment</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">url:</span> <span class="hljs-string">https://myprodserver.com</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">Production</span> <span class="hljs-string">environment</span>
</code></pre>
      </li>
      <li class="numberedList">Under <code class="inlineCode">components</code>, we define common <code class="inlineCode">securitySchemes</code> and responses, which define the authentication scheme we intend to implement and how the shape of our error message response will appear:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/swagger.yaml</strong></span>
<span class="code-highlight"><strong class="hljs-string-slc">...</strong></span>
<span class="code-highlight"><strong class="hljs-attr-slc">components:</strong></span>
  <span class="code-highlight"><strong class="hljs-attr-slc">securitySchemes:</strong></span>
    <span class="hljs-attr">bearerAuth:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">http</span>
      <span class="hljs-attr">scheme:</span> <span class="hljs-string">bearer</span>
      <span class="hljs-attr">bearerFormat:</span> <span class="hljs-string">JWT</span>
  <span class="code-highlight"><strong class="hljs-attr-slc">responses:</strong></span>
    <span class="hljs-attr">UnauthorizedError:</span>
      <span class="hljs-attr">description:</span> <span class="hljs-string">Unauthorized</span>
      <span class="hljs-attr">content:</span>
        <span class="hljs-attr">application/json:</span>
          <span class="hljs-attr">schema:</span>
            <span class="hljs-string">$ref:</span> <span class="hljs-string">"#/components/schemas/ServerMessage"</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
</code></pre>
      
    <div class="note">
      <p class="normal">Note the usage of <code class="inlineCode">$ref</code> to reuse repeating elements. You can see <code class="inlineCode">ServerMessage</code> being defined here.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Under <code class="inlineCode">components</code>, we define<a id="_idIndexMarker675"/> shared data <code class="inlineCode">schemas</code>, which<a id="_idIndexMarker676"/> declare the data entities that we either take in as input or return to the client:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/swagger.yaml</strong></span>
<span class="hljs-string">...</span>
  <span class="code-highlight"><strong class="hljs-attr-slc">schemas:</strong></span>
    <span class="hljs-attr">ServerMessage:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
      <span class="hljs-attr">properties:</span>
        <span class="hljs-attr">message:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
    <span class="hljs-attr">Role:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
      <span class="hljs-attr">enum:</span> [<span class="hljs-string">none</span>, <span class="hljs-string">clerk</span>, <span class="hljs-string">cashier</span>, <span class="hljs-string">manager</span>]
    <span class="hljs-string">...</span>
</code></pre>
      </li>
      <li class="numberedList">Under <code class="inlineCode">components</code>, we define shared <code class="inlineCode">parameters</code>, making it easy to reuse common patterns such as paginated endpoints:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/swagger.yaml</strong></span>
<span class="hljs-string">...</span>
  <span class="code-highlight"><strong class="hljs-attr-slc">parameters:</strong></span>
    <span class="hljs-attr">filterParam:</span>
      <span class="hljs-attr">in:</span> <span class="hljs-string">query</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">filter</span>
      <span class="hljs-attr">required:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">schema:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
      <span class="hljs-attr">description:</span> <span class="hljs-string">Search</span> <span class="hljs-string">text</span> <span class="hljs-string">to</span> <span class="hljs-string">filter</span> <span class="hljs-string">the</span> <span class="hljs-string">result</span> <span class="hljs-string">set</span> <span class="hljs-string">by</span>
<span class="hljs-string">...</span>
</code></pre>
      </li>
      <li class="numberedList">Under <code class="inlineCode">paths</code>, we define REST endpoints, such as a <code class="inlineCode">post</code> endpoint for the <code class="inlineCode">/login</code> path:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/swagger.yaml</strong></span>
<span class="hljs-string">...</span>
<span class="code-highlight"><strong class="hljs-attr-slc">paths:</strong></span>
  <span class="hljs-string">/v1/login:</span>
    <span class="hljs-attr">post:</span>
      <span class="hljs-attr">description:</span> <span class="hljs-string">|</span>
        <span class="hljs-string">Generates</span> <span class="hljs-string">a</span> <span class="hljs-string">JWT,</span> <span class="hljs-string">given</span> <span class="hljs-string">the</span> <span class="hljs-string">correct</span> <span class="hljs-string">credentials.</span>
      <span class="hljs-attr">requestBody:</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">content:</span>
          <span class="hljs-attr">application/json:</span>
            <span class="hljs-attr">schema:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
              <span class="hljs-attr">properties:</span>
                <span class="hljs-attr">email:</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                <span class="hljs-attr">password:</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
              <span class="hljs-attr">required:</span>
                <span class="hljs-bullet">-</span> <span class="hljs-string">email</span>
                <span class="hljs-bullet">-</span> <span class="hljs-string">password</span>
      <span class="hljs-attr">responses:</span>
        <span class="hljs-attr">'200':</span> <span class="hljs-comment"># Response</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">OK</span>
          <span class="hljs-attr">content:</span>
            <span class="hljs-attr">application/json:</span>
              <span class="hljs-attr">schema:</span>
                <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
                <span class="hljs-attr">properties:</span>
                  <span class="hljs-attr">accessToken:</span>
                    <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                <span class="hljs-attr">description:</span> <span class="hljs-string">JWT</span> <span class="hljs-string">token</span> <span class="hljs-string">that</span> <span class="hljs-string">contains</span> <span class="hljs-string">userId</span> <span class="hljs-string">as</span> <span class="hljs-string">subject,</span> <span class="hljs-string">email</span> <span class="hljs-string">and</span> <span class="hljs-string">role</span> <span class="hljs-string">as</span> <span class="hljs-string">data</span> <span class="hljs-string">payload.</span>
        <span class="hljs-attr">'401':</span>
          <span class="hljs-string">$ref:</span> <span class="hljs-string">'#/components/responses/UnauthorizedError'</span>
</code></pre>
      
    <div class="note">
      <p class="normal">Note that <code class="inlineCode">requestBody</code> defines input variables that are required with a type of <code class="inlineCode">string</code>. Under <code class="inlineCode">responses</code>, we can define how a successful <code class="inlineCode">200</code> response and an unsuccessful <code class="inlineCode">401</code> response to a request appear. In the former case, we return an <code class="inlineCode">accessToken</code>, while in the latter case, we return an <code class="inlineCode">UnauthorizedError</code>, as defined in <em class="italic">step 2</em>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">Under <code class="inlineCode">paths</code>, we define<a id="_idIndexMarker677"/> the remaining<a id="_idIndexMarker678"/> paths:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/swagger.yaml</strong></span>
<span class="hljs-string">...</span>
<span class="code-highlight"><strong class="hljs-attr-slc">paths:</strong></span>
  <span class="hljs-string">/v1/auth/me:</span>
    <span class="hljs-attr">get:</span> <span class="hljs-string">...</span>
  <span class="hljs-string">/v2/users:</span>
    <span class="hljs-attr">get:</span> <span class="hljs-string">...</span>
    <span class="hljs-attr">post:</span> <span class="hljs-string">...</span>
  <span class="hljs-string">/v2/users/{id}:</span>
    <span class="hljs-attr">get:</span> <span class="hljs-string">...</span>
    <span class="hljs-attr">put:</span> <span class="hljs-string">...</span>
      
</code></pre>
      </li>
    </ol>
    <p class="normal">The OpenAPI spec is powerful, allowing you to define intricate requirements on how users should be able to interact with your API. The OpenAPI spec can be found at <a href="https://spec.openapis.org/oas/latest.html"><span class="url">https://spec.openapis.org/oas/latest.html</span></a>. It is an invaluable resource while developing your own API definition.</p>
    <p class="normal">Our overarching goal is to integrate<a id="_idIndexMarker679"/> this interactive documentation<a id="_idIndexMarker680"/> with our Express.js APIs. Now, let’s see how you can implement such an API.</p>
    <h3 id="_idParaDest-224" class="heading-3">OpenAPI spec with Express</h3>
    <p class="normal">Configuring Swagger with Express<a id="_idIndexMarker681"/> is a manual<a id="_idIndexMarker682"/> process. But this is a good thing. Forcing yourself to manually document endpoints has a positive side effect. By slowing down, you will get the opportunity to consider your implementation from the perspective of the consumer of the API. This perspective will help you resolve potential issues with your endpoints during development, avoiding annoying, if not costly, rework.</p>
    <p class="normal">Let’s look at an example of how you can directly embed the OpenAPI spec alongside your code in chunks:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/src/v1/routes/authRouter.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * </span><span class="hljs-doctag">@openapi</span>
<span class="hljs-comment"> * /v1/auth/me:</span>
<span class="hljs-comment"> *   get:</span>
<span class="hljs-comment"> *     description: Gets the `User` object of the logged in user</span>
<span class="hljs-comment"> *     responses:</span>
<span class="hljs-comment"> *       '200':</span>
<span class="hljs-comment"> *         description: OK</span>
<span class="hljs-comment"> *         content:</span>
<span class="hljs-comment"> *           application/json:</span>
<span class="hljs-comment"> *             schema:</span>
<span class="hljs-comment"> *               $ref: '#/components/schemas/User'</span>
<span class="hljs-comment"> *       '401':</span>
<span class="hljs-comment"> *         $ref: '#/components/responses/UnauthorizedError'</span>
<span class="hljs-comment"> */</span>
router.<span class="hljs-title">get</span>(<span class="hljs-string">'/me'</span>, <span class="hljs-title">authenticate</span>(), <span class="hljs-keyword">async</span> (<span class="hljs-attr">_req</span>: <span class="hljs-title">Request</span>, <span class="hljs-attr">res</span>: <span class="hljs-title">Response</span>) =&gt; {
  <span class="hljs-keyword">if</span> (res.<span class="hljs-property">locals</span>.<span class="hljs-property">currentUser</span>) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title">send</span>(res.<span class="hljs-property">locals</span>.<span class="hljs-property">currentUser</span>)
  }
  <span class="hljs-keyword">return</span> res.<span class="hljs-title">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title">send</span>({ <span class="hljs-attr">message</span>: <span class="hljs-title">AuthenticationRequiredMessage</span> })
})
</code></pre>
    <p class="normal">In this example, we use the <code class="inlineCode">JSDoc</code> documentation syntax that starts with <code class="inlineCode">/**</code> and then define the relevant part<a id="_idIndexMarker683"/> of the OpenAPI spec right<a id="_idIndexMarker684"/> after the <code class="inlineCode">@openapi</code> identifier. We can still reference components defined elsewhere, as shown with the <code class="inlineCode">$ref</code> statements to the <code class="inlineCode">User</code> and <code class="inlineCode">UnauthorizedError</code> objects.</p>
    <p class="normal">The major benefit of integrating the spec alongside your code is that the developer knows exactly how the server should respond to a <code class="inlineCode">/me GET</code> request. If a user exists, we respond with a <code class="inlineCode">User</code> object; if not, we throw a <code class="inlineCode">401</code> error that adheres to the shape of the <code class="inlineCode">UnauthorizedError</code> object. Using some automated tools, we can still generate the same interactive Swagger UI covered earlier, so testers and developers can discover or test the API directly from a web interface. </p>
    <p class="normal">As the API implementation evolves, this setup makes it easy for developers to keep the spec up to date. By making it easy, we incentivize everyone involved with the desire to keep Swagger UI working because all team members benefit from it. By creating a virtuous cycle, we achieve the ideal of <strong class="keyWord">living documentation</strong>. Normally, initial designs become useless as they grow stale, but instead, we can have an automated and interactive solution that delivers ongoing value.</p>
    <p class="normal">We are going to use two helper libraries to help us integrate the inline spec into the codebase:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">swagger-jsdoc</code>: This allows us to implement OpenAPI specs right on top of the relevant code by using the <code class="inlineCode">@openapi</code> identifier in a <code class="inlineCode">JSDoc</code> comment block, generating a <code class="inlineCode">swagger.json</code> file as output.</li>
      <li class="bulletList"><code class="inlineCode">swagger-ui-express</code>: This consumes the <code class="inlineCode">swagger.json</code> file to display the interactive Swagger UI web interface.</li>
    </ul>
    <p class="normal">Let’s explore how Swagger is configured to work with Express.js:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">The dependencies and type information for TypeScript are shown here:
        <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npm i swagger-jsdoc swagger-ui-express
<span class="hljs-con-meta">$</span> npm i -D @types/swagger-jsdoc @types/swagger-ui-express
</code></pre>
      </li>
      <li class="numberedList">Let’s explore<a id="_idIndexMarker685"/> the <code class="inlineCode">docs-config.ts</code> file, which<a id="_idIndexMarker686"/> configures the base OpenAPI definition:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/src/docs-config.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> swaggerJsdoc <span class="hljs-keyword">from</span> <span class="hljs-string">'swagger-jsdoc'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Options</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'swagger-jsdoc'</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> packageJson <span class="hljs-keyword">from</span> <span class="hljs-string">'../package.json'</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: <span class="hljs-title">Options</span> = {
  <span class="hljs-attr">swaggerDefinition</span>: {
    <span class="hljs-attr">openapi</span>: <span class="hljs-string">'3.1.0'</span>,
    <span class="hljs-attr">components</span>: {},
    <span class="hljs-attr">info</span>: {
      <span class="hljs-attr">title</span>: packageJson.<span class="hljs-property">name</span>,
      <span class="hljs-attr">version</span>: packageJson.<span class="hljs-property">version</span>,
      <span class="hljs-attr">description</span>: packageJson.<span class="hljs-property">description</span>,
    },
    <span class="hljs-attr">servers</span>: [
      {
        <span class="hljs-attr">url</span>: <span class="hljs-string">'http://localhost:3000'</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">'Local environment'</span>,
      },
      {
        <span class="hljs-attr">url</span>: <span class="hljs-string">'https://mystagingserver.com'</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">'Staging environment'</span>,
      },
      {
        <span class="hljs-attr">url</span>: <span class="hljs-string">'https://myprodserver.com'</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">'Production environment'</span>,
      },
    ],
  },
  <span class="hljs-attr">apis</span>: [
    <span class="hljs-string">'**/models/*.js'</span>, 
    <span class="hljs-string">'**/v1/routes/*.js'</span>, 
    <span class="hljs-string">'**/v2/routes/*. js'</span>
  ],
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> specs = <span class="hljs-title">swaggerJsdoc</span>(options)
</code></pre>
     
    <p class="normal">Modify the <code class="inlineCode">servers</code> property <a id="_idIndexMarker687"/>to include the location<a id="_idIndexMarker688"/> of your testing, staging, or production environments. This allows consumers of your API to test the API using the web interface without additional tooling. Note that the <code class="inlineCode">apis</code> property informs the code files that <code class="inlineCode">swaggerJsdoc</code> should parse when constructing the <code class="inlineCode">swagger.json</code> file. This routine runs during the bootstrapping of the server, which is why we reference the transpiled <code class="inlineCode">.js</code> files instead of <code class="inlineCode">.ts</code> files.</p> </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Bootstrap the <code class="inlineCode">swagger</code> config in <code class="inlineCode">app.ts</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/src/app.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> swaggerUi <span class="hljs-keyword">from</span> <span class="hljs-string">'</span><span class="hljs-string">swagger-ui-express'</span>
<span class="hljs-keyword">import</span> { specs } <span class="hljs-keyword">from</span> <span class="hljs-string">'./docs-config'</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title">express</span>()
app.<span class="hljs-title">use</span>(<span class="hljs-title">cors</span>())
...
<span class="code-highlight"><strong class="hljs-slc">app.</strong><strong class="hljs-title-slc">use</strong><strong class="hljs-slc">(</strong><strong class="hljs-string-slc">'/api-docs'</strong><strong class="hljs-slc">, swaggerUi.</strong><strong class="hljs-property-slc">serve</strong><strong class="hljs-slc">, swaggerUi.</strong><strong class="hljs-title-slc">setup</strong><strong class="hljs-slc">(specs))</strong></span>
<span class="code-highlight"><strong class="hljs-slc">app.</strong><strong class="hljs-title-slc">get</strong><strong class="hljs-slc">(</strong><strong class="hljs-string-slc">'/swagger'</strong><strong class="hljs-slc">, </strong><strong class="hljs-keyword-slc">function</strong><strong class="hljs-slc"> (</strong><strong class="hljs-params-slc">_req, res</strong><strong class="hljs-slc">) {</strong></span>
<span class="code-highlight"><strong class="hljs-slc">  res.</strong><strong class="hljs-title-slc">json</strong><strong class="hljs-slc">(specs)</strong></span>
<span class="code-highlight"><strong class="hljs-slc">})</strong></span>
...
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> app
</code></pre>
      </li>
    </ol>
    <p class="normal">Specs contain the content of the <code class="inlineCode">swagger.json</code> file, which is then passed to <code class="inlineCode">swaggerUi</code>. Then, using the <code class="inlineCode">server</code> middleware, we can configure <code class="inlineCode">swaggerUi</code> to host the web interface at <code class="inlineCode">/api-docs</code>. We can also serve the JSON file from an endpoint to consume it in another tool, at <code class="inlineCode">/swagger</code>, as shown above.</p>
    <div class="packt_tip">
      <p class="normal">Even after integrating the spec file alongside the code, developers must manually ensure that the spec and the code match. This process can be automated, including generating TypeScript-based API handlers to prevent coding mistakes.</p>
      <p class="normal">A community-driven list of high-quality<a id="_idIndexMarker689"/> and modern tools for OpenAPI can be found at <a href="https://openapi.tools/"><span class="url">https://openapi.tools/</span></a>.</p>
    </div>
    <p class="normal">Now that you understand how we can<a id="_idIndexMarker690"/> design a REST API<a id="_idIndexMarker691"/> and create living documentation around it, it’s time to learn about GraphQL, which bakes these ideas into its core design.</p>
    <h2 id="_idParaDest-225" class="heading-2">GraphQL APIs</h2>
    <p class="normal"><strong class="keyWord">GraphQL</strong> (<strong class="keyWord">Graph Query Language</strong>), invented at Facebook, is a modern<a id="_idIndexMarker692"/> query language for APIs that offers a more flexible, robust, and efficient alternative to the traditional REST API. In GraphQL, instead of HTTP verbs, you write a query to GET data, a mutation to POST, PUT, or DELETE data, and subscriptions to push data in the style of WebSockets. Unlike REST, which exposes a fixed set of endpoints for each resource, GraphQL allows clients to request exactly the data they need, no more and no less. This means clients can shape the responses according to their requirements, leading to fewer over-fetching and under-fetching issues. We no longer need to design the perfect API surface to get optimal results.</p>
    <p class="normal">In the realm of full-stack development, as touched upon in the <em class="italic">Designing APIs</em> section, the importance of designing around major data entities cannot be overstated. GraphQL shines in this aspect. Its type system ensures the API shapes around these major data entities, providing a clear contract between the frontend and backend teams. This type system, defined in the GraphQL schema, acts as the contract, specifying the data types that can be fetched and the set of operations available.</p>
    <p class="normal">For frontend developers, diving into a GraphQL API can be a refreshing experience. The introspective nature of GraphQL means that the schema can be queried for details about itself. </p>
    <p class="normal">This self-documenting feature ensures that developers always have an up-to-date reference, eliminating the need for separate, manually maintained documentation. This is especially beneficial for agile teams in enterprise settings where waiting for documentation isn’t always feasible.</p>
    <p class="normal">Enter the GraphQL Playground or GraphiQL interactive environments, where developers can test and explore GraphQL queries in real time. Much like Swagger UI for OpenAPI, these tools provide immediate feedback, allowing developers to understand the structure, types, and operations of the API. This hands-on approach reduces the learning curve and fosters a deeper understanding of the API’s capabilities.</p>
    <p class="normal">Next, let’s explore how to design GraphQL APIs around major data entities, ensuring that they align with the principles laid out in our Router-first architecture and other best practices.</p>
    <h3 id="_idParaDest-226" class="heading-3">GraphQL schema</h3>
    <p class="normal">The GraphQL schema is at the heart<a id="_idIndexMarker693"/> of any GraphQL API, acting as the contract between the client and the server. It describes the structure and capabilities of the API by defining types and the relationships between the types. These types model the major data entities that the API operates on.</p>
    <p class="normal">Let’s begin by exploring the <code class="inlineCode">graphql.schema</code> file located under <code class="inlineCode">server/graphql</code>:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Using the <code class="inlineCode">type</code> keyword, we can define data objects:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/graphql/graphql.schema</strong></span>
type <span class="hljs-keyword">User</span> {
  address: Address
  dateOfBirth: String
  email: String<span class="hljs-operator">!</span>
  id: ID<span class="hljs-operator">!</span>
  level: <span class="hljs-type">Float</span>
  name: Name<span class="hljs-operator">!</span>
  phones: [Phone]
  picture: String
  role: Role<span class="hljs-operator">!</span>
  userStatus: <span class="hljs-type">Boolean</span><span class="hljs-operator">!</span>
  fullName: String
}
</code></pre>
      
    <p class="normal">This <code class="inlineCode">User</code> type has scalar fields like the <code class="inlineCode">id</code> and <code class="inlineCode">email</code> fields, representing primitive value types like <code class="inlineCode">ID</code>, <code class="inlineCode">String</code>, <code class="inlineCode">Int</code>, <code class="inlineCode">Float</code>, and <code class="inlineCode">Boolean</code>. The bang symbol <code class="inlineCode">!</code> indicates these fields are required. We can also define relationships between types, such as <code class="inlineCode">Name</code> or <code class="inlineCode">Phone</code>. The square brackets <code class="inlineCode">[]</code> indicate that <code class="inlineCode">phones</code> is an array of <code class="inlineCode">Phone</code> objects.</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">We can also define enums and use them like a scalar type:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server</strong><strong class="hljs-operator-slc">/</strong><strong class="hljs-slc">graphql</strong><strong class="hljs-operator-slc">/</strong><strong class="hljs-slc">graphql.schema</strong></span>
enum Role {
  <span class="hljs-keyword">None</span>
  Clerk
  Cashier
  Manager
}
</code></pre>
      </li>
      <li class="numberedList">Using the reserved type <code class="inlineCode">Query</code>, we can define how data can be retrieved:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server</strong><strong class="hljs-operator-slc">/</strong><strong class="hljs-slc">graphql</strong><strong class="hljs-operator-slc">/</strong><strong class="hljs-slc">graphql.schema</strong></span>
type Query {
  # Gets a `<span class="hljs-keyword">User</span>` object <span class="hljs-keyword">by</span> id
  # Equivalent <span class="hljs-keyword">to</span> <span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>v2<span class="hljs-operator">/</span>users<span class="hljs-operator">/</span>{id}
  <span class="hljs-keyword">user</span>(id: ID<span class="hljs-operator">!</span>): <span class="hljs-keyword">User</span> 
}
</code></pre>
      
    <p class="normal">We can define acceptable arguments and the return type.</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Using the reserved<a id="_idIndexMarker694"/> type <code class="inlineCode">Mutation</code>, we can define how the state can be modified:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/graphql/graphql.schema</strong></span>
type Mutation {
  # Generates a JWT, given correct credentials.
  # Equivalent <span class="hljs-keyword">to</span> POST <span class="hljs-operator">/</span>v1<span class="hljs-operator">/</span>auth<span class="hljs-operator">/</span>login
  login(email: String<span class="hljs-operator">!</span>, password: String<span class="hljs-operator">!</span>): JWT
  # <span class="hljs-keyword">Create</span> a <span class="hljs-keyword">new</span> `<span class="hljs-keyword">User</span>`
  # Equivalent <span class="hljs-keyword">to</span> POST <span class="hljs-operator">/</span>v2<span class="hljs-operator">/</span>users
  createUser(userInput: UserInput<span class="hljs-operator">!</span>): <span class="hljs-keyword">User</span>
}
</code></pre>
      
    <p class="normal">We can define a login or a <code class="inlineCode">createUser</code> method. Note that <code class="inlineCode">createUser</code> takes an input object, which is required if we want to pass a whole object as an argument.</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Input objects are declared with the <code class="inlineCode">input</code> keyword:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/graphql/graphql.schema</strong></span>
input UserInput {
  address: AddressInput
  dateOfBirth: String
  email: String<span class="hljs-operator">!</span>
  level: <span class="hljs-type">Float</span>
  name: NameInput<span class="hljs-operator">!</span>
  phones: [PhoneInput]
  picture: String
  role: Role<span class="hljs-operator">!</span>
  userStatus: <span class="hljs-type">Boolean</span><span class="hljs-operator">!</span>
}
</code></pre>
      </li>
    </ol>
    <p class="normal">Note that any related object must also use the input declaration. Output types and input data can’t be mixed.</p>
    <div class="packt_tip">
      <p class="normal">As you may have noticed, we can also add descriptions to document our API using the # symbol or, optionally, the triple quote <code class="inlineCode">"""</code> syntax.</p>
    </div>
    <p class="normal">The schema is defined using the GraphQL <strong class="keyWord">Schema Definition Language</strong> (<strong class="keyWord">SDL</strong>). You can access the SDL specification<a id="_idIndexMarker695"/> at <a href="https://graphql.org/"><span class="url">https://graphql.org/</span></a>. It’s an essential resource for anyone crafting a well-defined GraphQL API.</p>
    <p class="normal">Overall, the schema provides a strict contract between the client and the server. It makes explicit the data shapes and capabilities available. Frontend and backend teams can build features in parallel against<a id="_idIndexMarker696"/> this contract, and tooling like GraphQL Playground makes the schema interactive.</p>
    <p class="normal">We will use the Apollo GraphQL library to help construct the schema programmatically in our Express server.</p>
    <h3 id="_idParaDest-227" class="heading-3">Apollo with Express</h3>
    <p class="normal">Apollo GraphQL is a comprehensive<a id="_idIndexMarker697"/> and widely adopted suite<a id="_idIndexMarker698"/> of tools and services designed to help developers build, manage, and scale GraphQL applications with ease. Developed by the Meteor Development Group, Apollo has become synonymous with GraphQL development for many developers, due to its robust features and developer-friendly approach. Here’s a breakdown of Apollo GraphQL:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Apollo Client</strong>: A state-of-the-art GraphQL<a id="_idIndexMarker699"/> client that manages local and remote data. It integrates seamlessly with any JavaScript frontend framework, such as React, Vue, or Angular. Apollo Client provides features like caching, optimistic UI updates, and real-time subscriptions, making it easier to fetch, cache, and modify application data.</li>
      <li class="bulletList"><strong class="keyWord">Apollo Server</strong>: A community-driven, open-source<a id="_idIndexMarker700"/> GraphQL server that works with any GraphQL schema. Apollo Server provides performance tracing and error tracking and supports schema stitching, allowing for the merging<a id="_idIndexMarker701"/> of multiple GraphQL APIs into one unified API.</li>
      <li class="bulletList"><strong class="keyWord">Apollo Client Developer Tools</strong>: Browser extensions offering<a id="_idIndexMarker702"/> rich in-browser development experience. Developers can view their GraphQL store, inspect active queries, and interact with their GraphQL server using the built-in GraphiQL IDE.</li>
    </ul>
    <p class="normal">Apollo provides more advanced dev tools with Apollo Studio as part of its cloud offering. Apollo Federation allows organizations to divide their monolithic GraphQL API into smaller, more maintainable microservices. It provides a means to compose multiple GraphQL services into a single data graph. Apollo Link allows developers to create chainable “links” to handle tasks like logging, request retries, and even offline caching.</p>
    <p class="normal">In essence, Apollo GraphQL provides a holistic approach to GraphQL development, offering tools and services catering to beginners and advanced users. Whether you’re building a small application or scaling a large enterprise system, Apollo’s tools ensure great DevEx.</p>
    <p class="normal">The GraphQL schema and the GraphQL library are inseparable, so we don’t have to take extra steps to configure the schema definition to work with the codebase, as we did with OpenAPI. </p>
    <div class="note">
      <p class="normal">To generate types <a id="_idIndexMarker703"/>from a GraphQL schema, follow the guidance provided at <a href="https://www.apollographql.com/docs/apollo-server/workflow/generate-types/"><span class="url">https://www.apollographql.com/docs/apollo-server/workflow/generate-types/</span></a>.</p>
    </div>
    <p class="normal">Next, let’s see how you<a id="_idIndexMarker704"/> can configure your schema <a id="_idIndexMarker705"/>and Apollo with Express.js:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Install the Apollo server:
        <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> @apollo/server
</code></pre>
      </li>
      <li class="numberedList">Open the <code class="inlineCode">api.graphql.ts</code> file, which configures the Apollo server:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/src/graphql/api.</strong><strong class="hljs-property-slc">graphql</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
<span class="hljs-keyword">import</span> { resolvers } <span class="hljs-keyword">from</span> <span class="hljs-string">'./resolvers'</span>
<span class="hljs-keyword">const</span> typeDefs = <span class="hljs-title">readFileSync</span>(<span class="hljs-string">'./src/graphql/schema.graphql'</span>, 
...
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title">useGraphQL</span>(<span class="hljs-attr">app</span><span class="hljs-params">: </span><span class="hljs-title">Express</span>) {
  <span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title">ApolloServer</span>&lt;<span class="hljs-title">AuthContext</span>&gt;({
    typeDefs,
    resolvers,
  })
  <span class="hljs-keyword">await</span> server.<span class="hljs-title">start</span>()
  ...
  )
}
</code></pre>
      </li>
      <li class="numberedList">Using <code class="inlineCode">node:fs</code>, we read the schema file into the <code class="inlineCode">typeDefs</code> object and pass it into a new <code class="inlineCode">ApolloServer</code> instance along with a reference to the resolvers. Finally, we call <code class="inlineCode">server.start()</code> and export the <code class="inlineCode">useGraphQL</code> function.</li>
      <li class="numberedList">Bootstrap the Apollo server in <code class="inlineCode">index.ts</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/src/index.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> app <span class="hljs-keyword">from</span> <span class="hljs-string">'./app'</span>
...
<span class="code-highlight"><strong class="hljs-keyword-slc">async</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">function</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">start</strong><strong class="hljs-slc">() {</strong></span>
  <span class="code-highlight"><strong class="hljs-slc">...</strong></span>
  <span class="code-highlight"><strong class="hljs-title-slc">Instance</strong><strong class="hljs-slc"> = http.</strong><strong class="hljs-title-slc">createServer</strong><strong class="hljs-slc">(app)</strong></span>
  <span class="code-highlight"><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">useGraphQL</strong><strong class="hljs-slc">(app)</strong></span>
        ...
      }
      <span class="hljs-title">start</span>()
</code></pre>
      </li>
    </ol>
    <p class="normal">In <code class="inlineCode">index.ts</code>, right after we create<a id="_idIndexMarker706"/> an instance of the Express<a id="_idIndexMarker707"/> server, which is defined by the app variable, we call the <code class="inlineCode">useGraphQL</code> function to start it up. This configuration allows us to implement REST and GraphQL APIs side by side. GraphQL APIs and the interactive Explorer tools can be accessed at <code class="inlineCode">/graphql</code>, as shown below:</p>
    <p class="normal"><img src="../Images/B20960_07_05.png" alt="A screenshot of a computer  Description automatically generated"/></p>
    <p class="packt_figref">Figure 7.5: GraphQL Explorer</p>
    <p class="normal">Now that you understand<a id="_idIndexMarker708"/> the differences between REST<a id="_idIndexMarker709"/> and GraphQL APIs and how we can configure them equivalently with Express.js, let’s take a look at the overall architecture of the server.</p>
    <h1 id="_idParaDest-228" class="heading-1">Implementing APIs with Express.js</h1>
    <p class="normal">Let’s go over the architecture<a id="_idIndexMarker710"/> and file structure of our backend so that<a id="_idIndexMarker711"/> we get an understanding of how the server is bootstrapped, how routing is configured for API endpoints, how public resources are served, and how services are configured.</p>
    <p class="normal">Review the file structure of our Express server:</p>
    <pre class="programlisting code"><code class="hljs-code">server/src
├── api.ts
├── app.ts
├── config.ts
├── docs-config.ts
├── graphql
│   ├── api.graphql.ts
│   ├── helpers.ts
│   └── resolvers.ts
├── index.ts
├── models
│   ├── enums.ts
│   ├── phone.ts
│   └── user.ts
├── public
├── services
│   ├── authService.ts
│   └── userService.ts
├── v1
│   ├── index.ts
│   └── routes
│       └── authRouter.ts
└── v2
    ├── index.ts
    └── routes
        └── userRouter.ts
</code></pre>
    <p class="normal">Next, we’ll review the purpose<a id="_idIndexMarker712"/> and the interaction between these files<a id="_idIndexMarker713"/> by looking at a component diagram, giving us an overview of the architecture and the dependency tree:</p>
    <figure class="mediaobject"><img src="../Images/B20960_07_06.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 7.6: Express server architecture</p>
    <p class="normal"><code class="inlineCode">index.ts</code> contains a <code class="inlineCode">start</code> function, which bootstraps the application, leveraging four major helpers:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">config.ts</code>: Manages environment variables and settings.</li>
      <li class="bulletList"><code class="inlineCode">app.ts</code>: Configures Express.js and defines all API paths, and then routers implement the paths and leverage services that contain the business logic. Services use models, such as <code class="inlineCode">user.ts</code>, to access the database.</li>
      <li class="bulletList"><code class="inlineCode">api.graphql.ts</code>: Configures GraphQL, resolvers implement queries, and mutators leverage the same services and then resolvers implement queries and mutators and leverage the same services to access the database.</li>
      <li class="bulletList"><code class="inlineCode">document-ts</code>: Establishes a connection to the database, configures it, and leverages <code class="inlineCode">user.ts</code> to configure a seed user during startup.</li>
    </ul>
    <p class="normal">You can see that the components at the top of the diagram are responsible for startup and configuration chores, including configuring API paths, which represent the <strong class="keyWord">API</strong> layer. The <strong class="keyWord">Business</strong> layer should contain most of the business logic for the app, while data access is handled in the <strong class="keyWord">Persistence</strong> layer.</p>
    <p class="normal">Refer to the following implementation<a id="_idIndexMarker714"/> of <code class="inlineCode">index.ts</code>, which shows a simplified<a id="_idIndexMarker715"/> version showing all major components in sequence:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/src/index.</strong><strong class="hljs-property-slc">ts</strong></span>
...
<span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> <span class="hljs-attr">server</span>: http.<span class="hljs-property">Server</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title">start</span>() {
  <span class="hljs-keyword">await</span> <span class="hljs-variable">document</span>.<span class="hljs-title">connect</span>(config.<span class="hljs-property">MongoUri</span>, config.<span class="hljs-property">IsProd</span>)
  server = http.<span class="hljs-title">createServer</span>(app)
  <span class="hljs-keyword">await</span> <span class="hljs-title">useGraphQL</span>(app)
  server.<span class="hljs-title">listen</span>(config.<span class="hljs-property">Port</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-variable">console</span>.<span class="hljs-title">log</span>(<span class="hljs-string">`Server listening on port </span><span class="hljs-subst">${config.Port}</span><span class="hljs-string">...`</span>)
  })
}
<span class="hljs-title">start</span>()
</code></pre>
    <p class="normal">Note that the last line<a id="_idIndexMarker716"/> of code shown, <code class="inlineCode">start()</code>, is the function call<a id="_idIndexMarker717"/> that triggers the server’s initialization.</p>
    <p class="normal">Now, let’s investigate how the Express server is set up.</p>
    <h2 id="_idParaDest-229" class="heading-2">Bootstrapping the server</h2>
    <p class="normal"><code class="inlineCode">app.ts</code> configures Express.js, along<a id="_idIndexMarker718"/> with serving static assets, routing, and versioning. Express.js leverages middleware functions to integrate with libraries or your code. Middleware are functions that execute during the lifecycle of a request to the Express server. Middleware functions have access to the request and response objects and the following middleware function in the application’s request-response cycle. This access allows them to execute any code, make changes, end the request-response cycle, and call the next middleware in the stack. In the code below, cors, logger, and compression are library functions, and later in the chapter, we will go over the implementation of a custom authenticate middleware:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/src/app.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> api <span class="hljs-keyword">from</span> <span class="hljs-string">'./api'</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title">express</span>()
app.<span class="hljs-title">use</span>(<span class="hljs-title">cors</span>())
app.<span class="hljs-title">use</span>(express.<span class="hljs-title">json</span>())
app.<span class="hljs-title">use</span>(express.<span class="hljs-title">urlencoded</span>({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }))
app.<span class="hljs-title">use</span>(<span class="hljs-title">logger</span>(<span class="hljs-string">'dev'</span>))
app.<span class="hljs-title">use</span>(<span class="hljs-title">compression</span>())
app.<span class="hljs-title">use</span>(<span class="hljs-string">'</span><span class="hljs-string">/'</span>, express.<span class="hljs-title">static</span>(path.<span class="hljs-title">join</span>(__dirname, <span class="hljs-string">'../public'</span>), { <span class="hljs-attr">redirect</span>: <span class="hljs-literal">false</span> }))
app.<span class="hljs-title">use</span>(api)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> app
</code></pre>
    <p class="normal">In the preceding code, note that configuring Express is straightforward with the <code class="inlineCode">use()</code> method. First, we configure <code class="inlineCode">cors</code>, and then <code class="inlineCode">express</code> parsers, <code class="inlineCode">logger</code>, and <code class="inlineCode">compression</code>.</p>
    <p class="normal">Next, using the <code class="inlineCode">express.static</code> function, we serve the <code class="inlineCode">public</code> folder at the root’s route, <code class="inlineCode">/</code>, so that we can display some useful information about our server, as shown in <em class="italic">Figure 7.1</em> at the beginning of this chapter.</p>
    <p class="normal">Finally, we configure the router, which is defined in <code class="inlineCode">api.ts</code>.</p>
    <h2 id="_idParaDest-230" class="heading-2">REST routes and versioning</h2>
    <p class="normal"><code class="inlineCode">api.ts</code> configures<a id="_idIndexMarker719"/> the Express<a id="_idIndexMarker720"/> router. Refer to<a id="_idIndexMarker721"/> the following<a id="_idIndexMarker722"/> implementation:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/src/api.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Router</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>
<span class="hljs-keyword">import</span> api_v1 <span class="hljs-keyword">from</span> <span class="hljs-string">'./v1'</span>
<span class="hljs-keyword">import</span> api_v2 <span class="hljs-keyword">from</span> <span class="hljs-string">'./v2'</span>
<span class="hljs-keyword">const</span> api = <span class="hljs-title">Router</span>()
<span class="hljs-comment">// Configure all routes here</span>
api.<span class="hljs-title">use</span>(<span class="hljs-string">'/v1'</span>, api_v1)
api.<span class="hljs-title">use</span>(<span class="hljs-string">'/v2'</span>, api_v2)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> api
</code></pre>
    <p class="normal">In this case, we have two child routes for <code class="inlineCode">v1</code> and <code class="inlineCode">v2</code>. It is critical to always version the APIs you implement. Once an API becomes public, it can be tricky, even impossible sometimes, to simply phase out an API for a newer version. Even minor code changes or slight differences in the API can cause clients to break. You must pay careful attention to only making backward-compatible changes to your API.</p>
    <p class="normal">At some point, you will need to completely rewrite the endpoint to meet new requirements, performance, and business needs, at which point, you can simply implement a <code class="inlineCode">v2</code> version of your endpoint while leaving the <code class="inlineCode">v1</code> implementation unchanged. This allows you to innovate at the pace you need to while keeping legacy consumers of your app functional.</p>
    <p class="normal">In short, you should version every<a id="_idIndexMarker723"/> API you create. By doing this, you force your consumers<a id="_idIndexMarker724"/> to version their HTTP calls to your API. Over <a id="_idIndexMarker725"/>time, you can<a id="_idIndexMarker726"/> transition, duplicate, and retire APIs under different versions. Consumers then have a choice to call whichever version of the API works for them.</p>
    <p class="normal">Configuring a route is trivial. Let’s see the configuration for <code class="inlineCode">v2</code>, as shown:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/src/v2/index.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Router</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>
<span class="hljs-keyword">import</span> userRouter <span class="hljs-keyword">from</span> <span class="hljs-string">'./routes/userRouter'</span>
<span class="hljs-keyword">const</span> router = <span class="hljs-title">Router</span>()
<span class="hljs-comment">// Configure all v2 routers here</span>
router.<span class="hljs-title">use</span>(<span class="hljs-string">'/users?'</span>, userRouter)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router
</code></pre>
    <div class="packt_tip">
      <p class="normal">The question mark at the end of <code class="inlineCode">/users?</code> means that both <code class="inlineCode">/user</code> and <code class="inlineCode">/users</code> will work against operations implemented in <code class="inlineCode">userRouter</code>. This is a great way to avoid typos while allowing the developer to choose the plurality that makes sense for the operation.</p>
    </div>
    <p class="normal">In <code class="inlineCode">userRouter</code>, you can implement the GET, POST, PUT, and DELETE operations. Refer to the following implementation:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/src/v2/routes/userRouter.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">const</span> router = <span class="hljs-title">Router</span>()
router.<span class="hljs-title">get</span>(<span class="hljs-string">'/'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">req</span>: <span class="hljs-title">Request</span>, <span class="hljs-attr">res</span>: <span class="hljs-title">Response</span>) =&gt; {})
router.<span class="hljs-title">post</span>(<span class="hljs-string">'/'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">req</span>: <span class="hljs-title">Request</span>, <span class="hljs-attr">res</span>: <span class="hljs-title">Response</span>) =&gt; {})
router.<span class="hljs-title">get</span>(<span class="hljs-string">'/:userId'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">req</span>: <span class="hljs-title">Request</span>, <span class="hljs-attr">res</span>: <span class="hljs-title">Response</span>) =&gt; {})
router.<span class="hljs-title">put</span>(<span class="hljs-string">'/:userId'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">req</span>: <span class="hljs-title">Request</span>, <span class="hljs-attr">res</span>: <span class="hljs-title">Response</span>) =&gt; {})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router
</code></pre>
    <p class="normal">In the preceding code, you<a id="_idIndexMarker727"/> can observe<a id="_idIndexMarker728"/> the use of route parameters. You can consume<a id="_idIndexMarker729"/> route parameters through<a id="_idIndexMarker730"/> a request object, such as <code class="inlineCode">req.params.userId</code>.</p>
    <div class="packt_tip">
      <p class="normal">Note that all routes in the sample code are tagged as <code class="inlineCode">async</code> because they will all make a database call, which we are going to await. If your route is synchronous, then you don’t require the <code class="inlineCode">async</code> keyword.</p>
    </div>
    <p class="normal">Next, let’s investigate GraphQL resolvers.</p>
    <h2 id="_idParaDest-231" class="heading-2">GraphQL resolvers</h2>
    <p class="normal">GraphQL resolvers are implemented<a id="_idIndexMarker731"/> in <code class="inlineCode">resolvers.ts</code>. The GraphQL server<a id="_idIndexMarker732"/> performs a breadth-first traversal of the query and recursively calls resolvers to generate the response.</p>
    <p class="normal">Let me elaborate – when a GraphQL server gets a query, it processes the request layer by layer, starting from the top-level fields and moving horizontally across the structure, like a search that moves across<a id="_idIndexMarker733"/> each level of a tree before going deeper, known as breadth-first traversal. For each field it encounters, the server invokes a specific function called a resolver, designed<a id="_idIndexMarker734"/> to fetch the data for that field. If a field is complex and contains nested subfields, the resolver for that field will, in turn, call upon other resolvers for each of these subfields. This process repeats itself, descending into the query’s hierarchy as needed until all the data for the query is retrieved and can be assembled into the structured response that matches the original query layout.</p>
    <p class="normal">Refer to the following implementation:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/src/graphql/resolvers.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> resolvers = {
  <span class="hljs-title">Query</span>: {
    <span class="hljs-attr">me</span>: <span class="hljs-function">() =&gt;</span> ...,
    <span class="hljs-attr">user</span>: <span class="hljs-function">() =&gt;</span> ...,
    <span class="hljs-attr">users</span>: <span class="hljs-function">() =&gt;</span> ...,
  },
  <span class="hljs-title">Mutation</span>: {
    <span class="hljs-attr">login</span>: <span class="hljs-function">() =&gt;</span> ...,
    },
    <span class="hljs-attr">createUser</span>: <span class="hljs-function">() =&gt;</span> ...,
    <span class="hljs-attr">updateUser</span>: <span class="hljs-function">() =&gt;</span> ...,
  },
</code></pre>
    <p class="normal">In the snippet above, we define<a id="_idIndexMarker735"/> a resolver function for each query and mutation<a id="_idIndexMarker736"/> implemented in the scheme. Each resolver takes in four arguments <code class="inlineCode">(parent</code>, <code class="inlineCode">args</code>, <code class="inlineCode">contextValue</code>, <code class="inlineCode">info)</code>: <code class="inlineCode">parent</code> can be used to access a parent resolver, <code class="inlineCode">args</code> contains any input arguments passed in, <code class="inlineCode">contextValue</code> stores session data useful for auth, and <code class="inlineCode">info</code> contains metadata about the query itself. Next, let’s look at the <code class="inlineCode">type</code> resolvers:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/src/graphql/resolvers.</strong><strong class="hljs-property-slc">ts</strong></span>
  <span class="hljs-title">User</span>: {
    <span class="hljs-attr">id</span>: <span class="hljs-function">(</span><span class="hljs-attr">obj</span><span class="hljs-params">: </span><span class="hljs-title">User</span><span class="hljs-function">) =&gt;</span> obj.<span class="hljs-property">_id</span>.<span class="hljs-title">toString</span>(),
    <span class="hljs-attr">role</span>: <span class="hljs-function">(</span><span class="hljs-attr">obj</span><span class="hljs-params">: </span><span class="hljs-title">User</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">EnumValues</span>.<span class="hljs-title">getNameFromValue</span>(<span class="hljs-title">Role</span>, obj.<span class="hljs-property">role</span>),
    <span class="hljs-attr">phones</span>: <span class="hljs-function">(</span><span class="hljs-attr">obj</span><span class="hljs-params">: </span><span class="hljs-title">User</span><span class="hljs-function">) =&gt;</span> (obj.<span class="hljs-property">phones</span> ? <span class="hljs-title">wrapAsArray</span>(obj.<span class="hljs-property">phones</span>) : []),
    <span class="hljs-attr">dateOfBirth</span>: <span class="hljs-function">(</span><span class="hljs-attr">obj</span><span class="hljs-params">: </span><span class="hljs-title">User</span><span class="hljs-function">) =&gt;</span> obj.<span class="hljs-property">dateOfBirth</span>?.<span class="hljs-title">toISOString</span>(),
  },
  <span class="hljs-title">Phone</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-function">(</span><span class="hljs-attr">obj</span><span class="hljs-params">: { </span><span class="hljs-keyword">type</span><span class="hljs-params">: </span><span class="hljs-built_in">string</span><span class="hljs-params"> }</span><span class="hljs-function">) =&gt;</span>
      <span class="hljs-title">EnumValues</span>.<span class="hljs-title">getNameFromValue</span>(<span class="hljs-title">PhoneType</span>, obj.<span class="hljs-property">type</span>),
  },
  <span class="hljs-title">Users</span>: {
    <span class="hljs-attr">data</span>: <span class="hljs-function">(</span><span class="hljs-attr">obj</span><span class="hljs-params">: </span><span class="hljs-title">Users</span><span class="hljs-function">) =&gt;</span> (obj.<span class="hljs-property">data</span> ? <span class="hljs-title">wrapAsArray</span>(obj.<span class="hljs-property">data</span>) : []),
  },
}
</code></pre>
    <p class="normal">For non-scalar types, arrays, or enums, we may need to provide a transformation so that GraphQL can appropriately unpack the data retrieved from the database. The good part is we only need to provide a resolver for specific properties of objects that need such manipulation.</p>
    <div class="note">
      <p class="normal">Resolvers may seem simple, but they can fulfill very complex needs, e.g., a simple request from a client may involve making multiple service and database calls and collating the results into an efficient response, just so the client can display it.</p>
    </div>
    <p class="normal">The atomic nature of resolvers<a id="_idIndexMarker737"/> means we only need to implement them once. Next, let’s explore how services<a id="_idIndexMarker738"/> are configured.</p>
    <h2 id="_idParaDest-232" class="heading-2">Services</h2>
    <p class="normal">We don’t want to implement <a id="_idIndexMarker739"/>our business logic in the router files, which represent <a id="_idIndexMarker740"/>our API layer. The API layer should largely consist of transforming data and making calls to the business logic layer.</p>
    <p class="normal">You can implement services using Node.js and TypeScript features. No fancy dependency injection is necessary. The sample application implements two services – <code class="inlineCode">authService</code> and <code class="inlineCode">userService</code>.</p>
    <p class="normal">For example, in <code class="inlineCode">userService.ts</code>, you can implement a function called <code class="inlineCode">createNewUser</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/src/services/userService.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">IUser</span>, <span class="hljs-title">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../models/user'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title">createNewUser</span>(<span class="hljs-attr">userData</span><span class="hljs-params">: </span><span class="hljs-title">IUser</span>):
  <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">User</span> | <span class="hljs-built_in">boolean</span>&gt; {
  <span class="hljs-comment">// create user</span>
}
</code></pre>
    <p class="normal"><code class="inlineCode">createNewUser</code> accepts <code class="inlineCode">userData</code> in the shape of <code class="inlineCode">IUser</code>, and when it is done creating the user, it returns an instance of <code class="inlineCode">User</code>. We can then use this function in our router as follows:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">server/src/v2/routes/userRouter.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { createNewUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../services/userService'</span>
router.<span class="hljs-title">post</span>(<span class="hljs-string">'/'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">req</span>: <span class="hljs-title">Request</span>, <span class="hljs-attr">res</span>: <span class="hljs-title">Response</span>) =&gt; {
  <span class="hljs-keyword">const</span> userData = req.<span class="hljs-property">body</span> <span class="hljs-keyword">as</span> <span class="hljs-title">IUser</span>
  <span class="hljs-keyword">const</span> success = <span class="hljs-keyword">await</span> <span class="hljs-title">createNewUser</span>(userData)
  <span class="hljs-keyword">if</span> (success <span class="hljs-keyword">instanceof</span> <span class="hljs-title">User</span>) {
    res.<span class="hljs-title">send</span>(success)
  } <span class="hljs-keyword">else</span> {
    res.<span class="hljs-title">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title">send</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'Failed to create user.'</span> })
  }
})
</code></pre>
    <p class="normal">We can await the result of <code class="inlineCode">createNewUser</code> and, if successful, return the created object as a response to the POST request.</p>
    <div class="packt_tip">
      <p class="normal">Note that even though we cast <code class="inlineCode">req.body</code> as <code class="inlineCode">IUser</code>, this is only a development time comfort feature. At runtime, the consumer may pass any number of properties to the body. Careless handling of request parameters is one of the primary ways your code can be maliciously exploited.</p>
    </div>
    <p class="normal">Congratulations! Now, you have a good understanding of how our Express server works. Next, let’s look at how to connect to MongoDB.</p>
    <h1 id="_idParaDest-233" class="heading-1">MongoDB ODM with DocumentTS</h1>
    <p class="normal">DocumentTS acts as an <strong class="keyWord">ODM</strong>, implementing<a id="_idIndexMarker741"/> a layer of models to enable rich and customizable<a id="_idIndexMarker742"/> interaction with database objects. ODM<a id="_idIndexMarker743"/> is the document-based database equivalent of an <strong class="keyWord">Object Relational Mapper</strong> (<strong class="keyWord">ORM</strong>) in relational databases. Think of Hibernate or Entity Framework. If you’re not familiar with these concepts, I recommend that you do further research before moving on.</p>
    <div class="packt_tip">
      <p class="normal">To get started, you can check<a id="_idIndexMarker744"/> out the following article, <em class="italic">MongoDB ORMs, ODMs, and Libraries</em>, at <a href="https://www.mongodb.com/developer/products/mongodb/mongodb-orms-odms-libraries"><span class="url">https://www.mongodb.com/developer/products/mongodb/mongodb-orms-odms-libraries</span></a>.</p>
    </div>
    <p class="normal">At its core, DocumentTS leverages the Node.js driver for MongoDB. The makers of MongoDB implement this driver. It guarantees the best performance and feature parity with new MongoDB releases, whereas third-party libraries often lag in supporting new features. By using the <code class="inlineCode">database.getDbInstance</code> method, you can access the native driver directly. Otherwise, you will access Mongo through the models that you implement. Refer to the following diagram for an overview:</p>
    <figure class="mediaobject"><img src="../Images/B20960_07_07.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 7.7: DocumentTS overview</p>
    <div class="packt_tip">
      <p class="normal">You can read more about MongoDB’s Node.js driver at <a href="https://mongodb.github.io/node-mongodb-native/"><span class="url">https://mongodb.github.io/node-mongodb-native/</span></a>.</p>
    </div>
    <p class="normal">For more details on how DocumentTS<a id="_idIndexMarker745"/> works and the configuration details, refer<a id="_idIndexMarker746"/> to the project wiki on GitHub at <a href="https://github.com/duluca/document-ts/wiki"><span class="url">https://github.com/duluca/document-ts/wiki</span></a>. The wiki covers connecting to the database, defining models that implement <code class="inlineCode">IDocument</code>, and configuring serialization and deserialization of data. Models allow calculated properties like <code class="inlineCode">fullName</code> to be included in client responses while excluding fields like passwords. Passwords are also prevented from being saved to the database in clear text.</p>
    <p class="normal">The overview continues by demonstrating how to create indexes and query the database with aggregation. It creates a unique index on email, so duplicate emails cannot be registered. A weighted text index assists in filtering query results. DocumentTS aims to provide a convenient yet optional layer on top of the native MongoDB driver to help build fully async web applications. Developers are directly exposed to the MongoDB driver, so they learn<a id="_idIndexMarker747"/> how to work with the database instead<a id="_idIndexMarker748"/> of just the library.</p>
    <p class="normal">Let’s see how you can fetch data using the new user model.</p>
    <h1 id="_idParaDest-234" class="heading-1">Implementing JWT auth</h1>
    <p class="normal">In <em class="chapterRef">Chapter 5</em>, <em class="italic">Designing Authentication and Authorization</em>, we discussed<a id="_idIndexMarker749"/> implementing a JWT-based authentication mechanism. In LemonMart, you implemented a base auth service that can be extended for custom authentication services.</p>
    <p class="normal">We’ll leverage three packages for our implementation:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">jsonwebtoken</code>: Used to create and encode JWTs</li>
      <li class="bulletList"><code class="inlineCode">bcryptjs</code>: Used to hash and salt a user’s password before saving it in the database, so we never store a user’s password in plain text</li>
      <li class="bulletList"><code class="inlineCode">uuid</code>: A generated universally unique identifier that is useful when resetting a user’s password to a random value</li>
    </ul>
    <div class="packt_tip">
      <p class="normal">A hash function is a consistently repeatable, one-way encryption method, which means you get the same output every time you provide the same input, but even if you have access to the hashed value, you cannot readily figure out what information it stores. We can, however, compare whether the user has entered the correct password by hashing the user’s input and comparing the hash of their input to that of the stored hash of their password.</p>
    </div>
    <p class="normal">The auth service hashes user passwords before storing them and compares hashed passwords on login. The <code class="inlineCode">createJwt</code> function generates a JWT access token upon successful login. The authenticate middleware decodes the JWT and loads the user into the response stream for authenticated endpoints.</p>
    <div class="packt_tip">
      <p class="normal">Note the vagueness of the incorrect email/password messages in the code. This is done so that bad actors cannot fish the system to exploit the authentication system.</p>
    </div>
    <p class="normal">For password hashing, the <code class="inlineCode">User</code> model’s <code class="inlineCode">setPassword</code> method uses bcrypt’s <code class="inlineCode">genSalt</code> and <code class="inlineCode">hash</code> functions. The <code class="inlineCode">comparePassword</code> method compares the hashed stored password with the hashed user input. This ensures passwords are never stored in plain text.</p>
    <p class="normal">The login API endpoint finds the user by email, calls <code class="inlineCode">comparePassword</code> to validate the password, and, on success, calls <code class="inlineCode">createJwt</code> to generate a signed JWT with user details like email, role, etc. The JWT is returned to the client as the <code class="inlineCode">accessToken</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Example of hashing and salting password</span>
user.<span class="hljs-property">setPassword</span> = <span class="hljs-keyword">async</span> (password) =&gt; {
  <span class="hljs-keyword">const</span> salt = <span class="hljs-keyword">await</span> bcrypt.<span class="hljs-title">genSalt</span>(<span class="hljs-number">10</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> bcrypt.<span class="hljs-title">hash</span>(password, salt); 
}
</code></pre>
    <p class="normal">The authenticate middleware decodes the JWT, finds the user by the encoded <code class="inlineCode">id</code>, and injects the user into <code class="inlineCode">res.locals.currentUser</code>. Authenticated endpoints like <code class="inlineCode">/me</code> can conveniently access the user’s info. It also handles role-based access by checking options like <code class="inlineCode">requiredRole</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Example of JWT-based login</span>
router.<span class="hljs-title">post</span>(<span class="hljs-string">'</span><span class="hljs-string">/login'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title">User</span>.<span class="hljs-title">findByEmail</span>(req.<span class="hljs-property">body</span>.<span class="hljs-property">email</span>);
  <span class="hljs-keyword">if</span> (user &amp;&amp; user.<span class="hljs-title">comparePassword</span>(req.<span class="hljs-property">body</span>.<span class="hljs-property">password</span>)) {
    <span class="hljs-keyword">const</span> accessToken = <span class="hljs-title">createJwt</span>(user);
    <span class="hljs-keyword">return</span> res.<span class="hljs-title">send</span>({accessToken});
  }
  <span class="hljs-keyword">return</span> res.<span class="hljs-title">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title">send</span>(<span class="hljs-string">'</span><span class="hljs-string">Invalid credentials'</span>);
})
</code></pre>
    <div class="packt_tip">
      <p class="normal">When retrieving a user by email, remember that emails are case-insensitive, so you should always convert the input to lowercase. You can improve this implementation further by validating the email and stripping any white space, script tags, or even rogue Unicode characters. Consider using libraries such as <code class="inlineCode">express-validator</code><a id="_idIndexMarker750"/> or <code class="inlineCode">express-sanitizer</code>.</p>
    </div>
    <h2 id="_idParaDest-235" class="heading-2">Authenticating middleware</h2>
    <p class="normal">The <code class="inlineCode">authenticate</code> function<a id="_idIndexMarker751"/> is a middleware we can use in our API implementations<a id="_idIndexMarker752"/> to ensure that only authenticated users with appropriate permissions can access an endpoint. Remember that real security is achieved in your backend implementation, and this <code class="inlineCode">authenticate</code> function is your gatekeeper.</p>
    <p class="normal"><code class="inlineCode">authenticate</code> takes a nullable <code class="inlineCode">options</code> object to verify the current user’s role with the <code class="inlineCode">requiredRole</code> property, so if an API is configured as shown below, only a manager can access that API:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-title">authenticate</span>(<span class="code-highlight"><strong class="hljs-slc">{ </strong><strong class="hljs-attr-slc">requiredRole</strong><strong class="hljs-slc">: </strong><strong class="hljs-title-slc">Role</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">Manager</strong><strong class="hljs-slc"> }</strong></span>)
</code></pre>
    <p class="normal">In certain cases, we want a user to be able to update their own records but also allow managers to update everyone else’s records. In this case, we leverage the <code class="inlineCode">permitIfSelf</code> property, as shown here:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-title">authenticate</span>({
    <span class="hljs-attr">requiredRole</span>: <span class="hljs-title">Role</span>.<span class="hljs-property">Manager</span>,
    <span class="code-highlight"><strong class="hljs-attr-slc">permitIfSelf</strong><strong class="hljs-slc">: {</strong></span>
      <span class="code-highlight"><strong class="hljs-attr-slc">idGetter</strong><strong class="hljs-slc">: </strong><strong class="hljs-function-slc">(</strong><strong class="hljs-params-slc">req: Request</strong><strong class="hljs-function-slc">) =&gt;</strong><strong class="hljs-slc"> req.</strong><strong class="hljs-property-slc">body</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">_id</strong><strong class="hljs-slc">,</strong></span>
      <span class="code-highlight"><strong class="hljs-attr-slc">requiredRoleCanOverride</strong><strong class="hljs-slc">: </strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">,</strong></span>
    <span class="code-highlight"><strong class="hljs-slc">},</strong></span>
  }),
</code></pre>
    <p class="normal">In this case, if the <code class="inlineCode">_id</code> of the updated<a id="_idIndexMarker753"/> record matches the current<a id="_idIndexMarker754"/> user’s <code class="inlineCode">_id</code>, then the user can update their own record. Since <code class="inlineCode">requiredRoleCanOverride</code> is set to <code class="inlineCode">true</code>, a manager can update any record. If it were set to <code class="inlineCode">false</code>, this wouldn’t be allowed. By mixing and matching these properties, you can cover a vast majority of your gatekeeping needs.</p>
    <div class="packt_tip">
      <p class="normal">Note that <code class="inlineCode">idGetter</code> is a function delegate so that you can specify how the <code class="inlineCode">_id</code> property should be accessed when the <code class="inlineCode">authenticate</code> middleware executes.</p>
    </div>
    <p class="normal">See the following example implementation of a simplified <code class="inlineCode">authenticate</code> middleware and its usage:</p>
    <div class="note">
      <p class="normal">The full implementation can be found at <code class="inlineCode">server/src/services/auth.service.ts</code>.</p>
    </div>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Authenticate middleware</span>
<span class="hljs-keyword">function</span> <span class="hljs-title">authenticate</span>(<span class="hljs-params">options</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title">decodeAndFindUser</span>(req.<span class="hljs-property">headers</span>.<span class="hljs-property">authorization</span>);
    <span class="hljs-keyword">if</span> (user) {
      <span class="hljs-comment">// Check role if required</span>
      <span class="hljs-keyword">if</span> (options.<span class="hljs-property">requiredRole</span> &amp;&amp; user.<span class="hljs-property">role</span> !== options.<span class="hljs-property">requiredRole</span>) {
        <span class="hljs-keyword">return</span> res.<span class="hljs-title">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title">send</span>(<span class="hljs-string">"Forbidden"</span>);
      }
      
      <span class="hljs-comment">// Attach user to response </span>
      res.<span class="hljs-property">locals</span>.<span class="hljs-property">user</span> = user;
      
      <span class="hljs-keyword">return</span> <span class="hljs-title">next</span>();
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> res.<span class="hljs-title">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title">send</span>(<span class="hljs-string">'Unauthenticated'</span>);
    }
  }
}
<span class="hljs-comment">// Usage in RESTful route</span>
router.<span class="hljs-title">get</span>(<span class="hljs-string">'/me'</span>, <span class="hljs-title">authenticate</span>(), <span class="hljs-function">(</span><span class="hljs-params">req, res</span><span class="hljs-function">) </span>
<span class="hljs-function">  =&gt;</span> res.<span class="hljs-title">send</span>(res.<span class="hljs-property">locals</span>.<span class="hljs-property">user</span>)
)
</code></pre>
    <p class="normal">The <code class="inlineCode">authenticate</code> method is implemented as Express.js middleware. It can read the request header for an authorization token, verify the validity of the JWT provided, load the current user, and inject it into the response stream, so an authenticated API endpoint can conveniently access the current user’s information. This is shown by the <code class="inlineCode">me</code> API above. If successful, the middleware calls the <code class="inlineCode">next()</code> function to yield control back to Express. If unsuccessful, then the API can’t be called.</p>
    <div class="packt_tip">
      <p class="normal">Note that <code class="inlineCode">authenticateHelper</code> returns useful error messages, so users aren’t confused if they try to execute an action they’re not permitted to execute.</p>
    </div>
    <p class="normal">In GraphQL, authentication<a id="_idIndexMarker755"/> and authorization are handled<a id="_idIndexMarker756"/> separately. At the Express.js level, we apply the <code class="inlineCode">authenticate</code> middleware to the <code class="inlineCode">/graphql</code> route. However, for explorer, introspection, and login functions to work, we must create exceptions to the rule. See the code below, which implements this logic:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// GraphQL authentication</span>
app.<span class="hljs-title">use</span>(<span class="hljs-string">'</span><span class="hljs-string">/graphql'</span>, <span class="hljs-title">authenticate</span>({ 
    <span class="hljs-attr">authOverridingOperations</span>: [<span class="hljs-string">'Login'</span>] 
  })
)
<span class="hljs-comment">// Usage in GraphQL resolver</span>
<span class="hljs-attr">me</span>: <span class="hljs-function">(</span><span class="hljs-params">parent, args, contextValue</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">authorize</span>(contextValue),
</code></pre>
    <div class="note">
      <p class="normal">See <code class="inlineCode">server/src/graphql/resolvers.ts</code> to see the full implementation of the auth in action.</p>
    </div>
    <p class="normal">The <code class="inlineCode">authOverridingOperations</code> property signals to <code class="inlineCode">authenticate</code> that it should permit calls for introspection and the <code class="inlineCode">Login</code> function. All other calls to other GraphQL functions will now be authenticated with the authentication context available in resolvers. In the resolvers, we can use the <code class="inlineCode">authorize</code> method (located at <code class="inlineCode">server/src/graphql/helpers.ts</code>) to check if the requestor can see the resource they’re trying to access. The <code class="inlineCode">contextValue</code> stores<a id="_idIndexMarker757"/> the session context similar<a id="_idIndexMarker758"/> to how <code class="inlineCode">res.local</code> works in Express.</p>
    <p class="normal">Next, let’s implement two custom auth providers, one for REST and another for GraphQL. </p>
    <h1 id="_idParaDest-236" class="heading-1">Custom server auth provider</h1>
    <p class="normal">Now that you understand<a id="_idIndexMarker759"/> the auth implementation in our server, we can implement a custom auth provider in LemonMart, as covered in <em class="chapterRef">Chapter 6</em>, <em class="italic">Implementing Role-Based Navigation</em>:</p>
    <div class="note">
      <p class="normal">You must implement this custom auth provider in your Angular app.</p>
    </div>
    <div class="packt_tip">
      <p class="normal">The code sample for this section is in the <code class="inlineCode">projects/stage10</code> folder in the <code class="inlineCode">lemon-mart-app</code> <code class="inlineCode">app</code> or <code class="inlineCode">web-app</code> folder.</p>
    </div>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Start by creating a <code class="inlineCode">baseUrl</code> variable in <code class="inlineCode">environment.ts</code> so that we can connect to your server.</li>
      <li class="numberedList">In <code class="inlineCode">environment.ts</code> and <code class="inlineCode">environment.prod.ts</code>, implement a <code class="inlineCode">baseUrl</code> variable.</li>
      <li class="numberedList">Also, select <code class="inlineCode">authMode</code> as <code class="inlineCode">AuthMode.CustomServer</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">web-app/src/environments/environment.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="code-highlight"><strong class="hljs-slc">web-app/src/environments/environment.</strong><strong class="hljs-property-slc">prod</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> environment = {
  ...
  <span class="hljs-attr">baseUrl</span>: <span class="hljs-string">'</span><span class="hljs-string">http://localhost:3000'</span>,
  <span class="hljs-attr">authMode</span>: <span class="hljs-title">AuthMode</span>.<span class="hljs-property">CustomServer</span>,
</code></pre>
      </li>
      <li class="numberedList">Install a helper library to programmatically access TypeScript enum values:
        <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npm i ts-enum-util
</code></pre>
      </li>
      <li class="numberedList">Implement the RESTful custom authentication<a id="_idIndexMarker760"/> provider using <code class="inlineCode">HttpClient</code>, as shown here:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">web-app/src/app/auth/auth.</strong><strong class="hljs-property-slc">custom</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">service</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { $enum } <span class="hljs-keyword">from</span> <span class="hljs-string">'ts-enum-util'</span>
...
<span class="hljs-meta">@Injectable</span>(<span class="hljs-meta">@Injectable</span>({ <span class="hljs-attr">providedIn</span>: <span class="hljs-string">'root'</span> }))
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomAuthService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">httpClient</span>: <span class="hljs-title">HttpClient</span> = <span class="hljs-title">inject</span>(<span class="hljs-title">HttpClient</span>)
  <span class="hljs-keyword">protected</span> <span class="hljs-title">authProvider</span>(
    <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-built_in">string</span>
  ): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">IServerAuthResponse</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-property">httpClient</span>.<span class="hljs-property">post</span>&lt;<span class="hljs-title">IServerAuthResponse</span>&gt;
      (<span class="hljs-string">`</span><span class="hljs-subst">${environment.baseUrl}</span><span class="hljs-string">/v1/auth/login`</span>, {
        email,
        password,
      })
      .<span class="hljs-title">pipe</span>(<span class="hljs-title">first</span>())
  }
  <span class="hljs-keyword">protected</span> <span class="hljs-title">transformJwtToken</span>(<span class="hljs-attr">token</span>: <span class="hljs-title">IJwtToken</span>): <span class="hljs-title">IAuthStatus</span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">isAuthenticated</span>: token.<span class="hljs-property">email</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>,
      <span class="hljs-attr">userId</span>: token.<span class="hljs-property">sub</span>,
      <span class="hljs-attr">userRole</span>: $enum(<span class="hljs-title">Role</span>)
        .<span class="hljs-title">asValueOrDefault</span>(token.<span class="hljs-property">role</span>, <span class="hljs-title">Role</span>.<span class="hljs-property">None</span>),
      <span class="hljs-attr">userEmail</span>: token.<span class="hljs-property">email</span>,
      <span class="hljs-attr">userPicture</span>: token.<span class="hljs-property">picture</span>,
    } <span class="hljs-keyword">as</span> <span class="hljs-title">IAuthStatus</span>
  }
  <span class="hljs-keyword">protected</span> <span class="hljs-title">getCurrentUser</span>(): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">User</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-property">httpClient</span>
      .<span class="hljs-property">get</span>&lt;<span class="hljs-title">IUser</span>&gt;(<span class="hljs-string">`</span><span class="hljs-subst">${environment.baseUrl}</span><span class="hljs-string">/v1/auth/me`</span>)
        .<span class="hljs-title">pipe</span>(
        <span class="hljs-title">first</span>(),
        <span class="hljs-title">map</span>(<span class="hljs-function">(</span><span class="hljs-params">user</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">User</span>.<span class="hljs-title">Build</span>(user)),
          <span class="hljs-title">catchError</span>(transformError)
        )
  }
}
</code></pre>
      </li>
      <li class="numberedList">The <code class="inlineCode">authProvider</code> method calls our <code class="inlineCode">/v1/auth/login</code> method, and <code class="inlineCode">getCurrentUser</code> calls <code class="inlineCode">/v1/auth/me</code> to retrieve the current user.
    <div class="packt_tip">
      <p class="normal">Ensure that calls to <code class="inlineCode">login</code> methods always happen on HTTPS. Otherwise, you will send user credentials on the open internet. This is ripe for eavesdroppers on public Wi-Fi networks to steal user credentials.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">Implement the GraphQL custom<a id="_idIndexMarker761"/> authentication provider using Apollo Client, as shown here:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">web-app/src/app/auth/auth.</strong><strong class="hljs-property-slc">graphql</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">custom</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">service</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable">GET_ME</span>, <span class="hljs-variable">LOGIN</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth.graphql.queries'</span>
...
<span class="hljs-meta">@Injectable</span>({ <span class="hljs-attr">providedIn</span>: <span class="hljs-string">'root'</span> })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomGraphQLAuthService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">apollo</span>: <span class="hljs-title">Apollo</span> = <span class="hljs-title">inject</span>(<span class="hljs-title">Apollo</span>)
  <span class="hljs-keyword">protected</span> <span class="hljs-title">authProvider</span>(
    <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-built_in">string</span>
  ): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">IServerAuthResponse</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-property">apollo</span>
      .<span class="hljs-property">mutate</span>&lt;{ <span class="hljs-attr">login</span>: <span class="hljs-title">IServerAuthResponse</span> }&gt;({
        <span class="hljs-attr">mutation</span>: <span class="hljs-variable">LOGIN</span>,
        <span class="hljs-attr">variables</span>: {
          email,
          password,
        },
      })
      .<span class="hljs-title">pipe</span>(
        <span class="hljs-title">first</span>(),
        <span class="hljs-title">map</span>(<span class="hljs-function">(</span><span class="hljs-params">result</span><span class="hljs-function">) =&gt;</span> 
          result.<span class="hljs-property">data</span>?.<span class="hljs-property">login</span> <span class="hljs-keyword">as</span> <span class="hljs-title">IServerAuthResponse</span>
        )
      )
    }
  <span class="hljs-keyword">protected</span> <span class="hljs-title">transformJwtToken</span>(<span class="hljs-attr">token</span>: <span class="hljs-title">IJwtToken</span>): <span class="hljs-title">IAuthStatus</span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">isAuthenticated</span>: token.<span class="hljs-property">email</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>,
      <span class="hljs-attr">userId</span>: token.<span class="hljs-property">sub</span>,
      <span class="hljs-attr">userRole</span>: $enum(<span class="hljs-title">Role</span>).<span class="hljs-title">asValueOrDefault</span>(
        token.<span class="hljs-property">role</span>,
        <span class="hljs-title">Role</span>.<span class="hljs-property">None</span>
      ),
      <span class="hljs-attr">userEmail</span>: token.<span class="hljs-property">email</span>,
      <span class="hljs-attr">userPicture</span>: token.<span class="hljs-property">picture</span>,
    } <span class="hljs-keyword">as</span> <span class="hljs-title">IAuthStatus</span>
  }
  <span class="hljs-keyword">protected</span> <span class="hljs-title">getCurrentUser</span>(): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">User</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-property">apollo</span>
      .<span class="hljs-property">watchQuery</span>&lt;{ <span class="hljs-attr">me</span>: <span class="hljs-title">IUser</span> }&gt;({
        <span class="hljs-attr">query</span>: <span class="hljs-variable">GET_ME</span>,
      })
      .<span class="hljs-property">valueChanges</span>.<span class="hljs-title">pipe</span>(
        <span class="hljs-title">first</span>(),
        <span class="hljs-title">map</span>(<span class="hljs-function">(</span><span class="hljs-params">result</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">User</span>.<span class="hljs-title">Build</span>(result.<span class="hljs-property">data</span>.<span class="hljs-property">me</span>))
      )
  }
}
</code></pre>
        <div class="packt_tip">
          <p class="normal">Note that the <code class="inlineCode">LOGIN</code> mutation and <code class="inlineCode">Me</code> query are implemented in <code class="inlineCode">auth.graphql.queries.ts</code>. Otherwise, they take up too much space for the service code to be readable.</p>
        </div>
      </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="8">Update <code class="inlineCode">authFactory</code> to return<a id="_idIndexMarker762"/> the new provider for the <code class="inlineCode">AuthMode.CustomServer</code> option:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">web-app/src/app/auth/auth.</strong><strong class="hljs-property-slc">factory</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title">authFactory</span>() {
  ...
  <span class="hljs-keyword">case</span> <span class="hljs-title">AuthMode</span>.<span class="hljs-property">CustomServer</span>:
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">CustomAuthService</span>()
  <span class="hljs-keyword">case</span> <span class="hljs-title">AuthMode</span>.<span class="hljs-property">CustomGraphQL</span>:
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">CustomGraphQLAuthService</span>()
}
</code></pre>
      </li>
      <li class="numberedList">Start your web app to make sure that things are working.</li>
    </ol>
    <p class="normal">Congratulations! You now grasp how code works across the entire software stack, from the database to the front and back ends.</p>
    <h1 id="_idParaDest-237" class="heading-1">Summary</h1>
    <p class="normal">In this chapter, we covered full-stack architecture. You learned about building a minimal MEAN stack. You now know how to create a monorepo for a full-stack application and configure a Node.js server with TypeScript. You learned about monorepos, containerizing a Node.js server, and declaratively defining infrastructure with Docker Compose. Using Docker Compose with CircleCI, we saw how you can verify your infrastructure in a CI environment.</p>
    <p class="normal">You learned how to design a RESTful API using OpenAPI and GraphQL using Apollo, set up an Express.js app, and configure it such that you can generate interactive documentation for your APIs. You learned about the benefits of using DocumentTS with MongoDB.</p>
    <p class="normal">You then implemented a JWT-based authentication service with an <code class="inlineCode">authenticate</code> middleware to secure API endpoints and allow for RBAC. Finally, you implemented two custom authentication providers in Angular. For REST, we used <code class="inlineCode">HttpClient</code>, and for GraphQL, Apollo Client.</p>
    <p class="normal">The next two chapters will explore Angular recipes to create forms and data tables. In <em class="chapterRef">Chapter 8</em>, <em class="italic">Recipes – Reusability, Forms, and Caching</em>, and <em class="chapterRef">Chapter 9</em>, <em class="italic">Recipes – Master/Detail, Data Tables, and NgRx</em>, we will tie everything together by sticking to a decoupled component architecture, smartly choosing between creating user controls and components and maximizing code reuse, with various TypeScript, RxJS, NgRx, and Angular coding techniques.</p>
    <div class="packt_tip">
      <p class="normal">For the rest of the book, you will want your LemonMart server and MongoDB instance up and running to verify the correct functionality of your forms and tables as you implement them.</p>
    </div>
    <h1 id="_idParaDest-238" class="heading-1">Exercise</h1>
    <p class="normal">You secured your endpoints using the <code class="inlineCode">authenticate</code> middleware. You configured Postman to send a valid token so that you can communicate with your secured endpoints. By way of an exercise, try removing the <code class="inlineCode">authenticate</code> middleware and calling the same endpoint with and without a valid token. Re-add the middleware, and then try the same thing again. Observe the different responses you get from the server.</p>
    <h1 id="_idParaDest-239" class="heading-1">Further reading</h1>
    <ul>
      <li class="bulletList"><em class="italic">What is DX? (Developer Experience)</em>, Albert Cavalcante, 2019, <a href="https://medium.com/@albertcavalcante/what-is-dx-developer-experience-401a0e44a9d9 "><span class="url">https://medium.com/@albertcavalcante/what-is-dx-developer-experience-401a0e44a9d9</span></a></li>
      <li class="bulletList"><em class="italic">Overview of Blocking versus Non-Blocking</em>, 2023, <a href="https://nodejs.org/en/docs/guides/blocking-vs-non-blocking/"><span class="url">https://nodejs.org/en/docs/guides/blocking-vs-non-blocking/</span></a></li>
      <li class="bulletList"><em class="italic">Explain Non-Blocking I/O like I’m Five, Frank Rosner</em>, 2019, <a href="https://blog.codecentric.de/en/2019/04/explain-non-blocking-i-o-like-im-five/"><span class="url">https://blog.codecentric.de/en/2019/04/explain-non-blocking-i-o-like-im-five/</span></a></li>
      <li class="bulletList"><em class="italic">OpenAPI Specification</em>, 2023, <a href="https://swagger.io/docs/specification"><span class="url">https://swagger.io/docs/specification</span></a></li>
      <li class="bulletList"><em class="italic">Serialization</em>, 2023, <a href="https://en.wikipedia.org/wiki/Serialization"><span class="url">https://en.wikipedia.org/wiki/Serialization</span></a></li>
      <li class="bulletList"><em class="italic">JSON</em>, 2023, <a href="https://en.wikipedia.org/wiki/JSON"><span class="url">https://en.wikipedia.org/wiki/JSON</span></a></li>
      <li class="bulletList"><em class="italic">Aggregation in MongoDB</em>, 2023, <a href="https://docs.mongodb.com/manual/aggregation"><span class="url">https://docs.mongodb.com/manual/aggregation</span></a></li>
      <li class="bulletList"><em class="italic">Apollo Authentication</em>, 2023, <a href="https://www.apollographql.com/docs/react/networking/authentication"><span class="url">https://www.apollographql.com/docs/react/networking/authentication</span></a></li>
      <li class="bulletList"><em class="italic">Setting Up Authentication and Authorization with Apollo Federation</em>, 2023, <a href="https://www.apollographql.com/blog/backend/auth/setting-up-authentication-and-authorization-apollo-federation/"><span class="url">https://www.apollographql.com/blog/backend/auth/setting-up-authentication-and-authorization-apollo-federation/</span></a></li>
      <li class="bulletList"><em class="italic">Apollo Built-in error codes</em>, 2023, <a href="https://www.apollographql.com/docs/apollo-server/data/errors#built-in-error-codes"><span class="url">https://www.apollographql.com/docs/apollo-server/data/errors#built-in-error-codes</span></a></li>
      <li class="bulletList"><em class="italic">Apollo Router &amp; Gateway architecture</em>, 2023, <a href="https://www.apollographql.com/docs/federation/building-supergraphs/router "><span class="url">https://www.apollographql.com/docs/federation/building-supergraphs/router</span></a></li>
    </ul>
    <h1 id="_idParaDest-240" class="heading-1">Questions</h1>
    <p class="normal">Answer the following questions to ensure you’ve understood the key concepts from this chapter without googling anything. Do you know if you got all the answers right? Visit <a href="https://angularforenterprise.com/self-assessment"><span class="url">https://angularforenterprise.com/self-assessment</span></a> for more:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">What are the main components that make for a great developer experience?</li>
      <li class="numberedList">What is a <code class="inlineCode">.env</code> file?</li>
      <li class="numberedList">What is the purpose of the <code class="inlineCode">authenticate</code> middleware?</li>
      <li class="numberedList">How does Docker Compose differ from using the Dockerfile?</li>
      <li class="numberedList">What is an ODM? How does it differ from an ORM?</li>
      <li class="numberedList">What is middleware?</li>
      <li class="numberedList">What are the uses of the OpenAPI spec?</li>
      <li class="numberedList">How would you refactor code for the <code class="inlineCode">/v2/users/{id} PUT</code> endpoint in <code class="inlineCode">userRouter.ts</code> so that the code is reusable?</li>
      <li class="numberedList">What are the major differentiators between REST and GraphQL?</li>
      <li class="numberedList">What are the similarities between OpenAPI and the GraphQL schema?</li>
    </ol>
    <h1 class="heading-1">Join our community on Discord</h1>
    <p class="normal">Join our community’s Discord space for discussions with the authors and other readers:</p>
    <p class="normal"><a href="Chapter_7.xhtml"><span class="url">https://packt.link/AngularEnterpise3e</span></a></p>
    <p class="normal"><img src="../Images/QR_Code1116411172100421421.png" alt="" role="presentation"/></p>
  </div>
</body></html>