<html><head></head><body>
<div id="sbo-rt-content"><div class="Basic-Text-Frame" id="_idContainer132">
<h1 class="chapterNumber">13</h1>
<h1 class="chapterTitle" id="_idParaDest-198">Understanding GraphQL with a Real Project</h1>
<p class="normal"><strong class="keyWord">GraphQL </strong>is a powerful<a id="_idIndexMarker500"/> query language designed to work seamlessly with APIs, allowing them to efficiently interact with your existing data. Unlike traditional REST APIs, GraphQL provides a comprehensive overview of the data in your API, making it easy to request only the exact data you need and nothing more. This not only streamlines your API requests but also makes it easier to optimize and improve your APIs when necessary. Additionally, GraphQL comes equipped with powerful developer tools to further enhance your development experience.</p>
<p class="normal">In this chapter, we’ll delve into the practical application of GraphQL by building a basic login and user registration system for a real-world project. By exploring how GraphQL can be utilized in this context, you’ll gain a comprehensive understanding of the language and be able to apply it effectively in your own projects.</p>
<p class="normal">We will cover the following topics in this chapter:</p>
<ul>
<li class="bulletList">Installing PostgreSQL</li>
<li class="bulletList">Creating environment variables with a <code class="inlineCode">.env</code> file</li>
<li class="bulletList">Configuring Apollo Server</li>
<li class="bulletList">Defining GraphQL queries and mutations</li>
<li class="bulletList">Working with resolvers</li>
<li class="bulletList">Creating Sequelize models</li>
<li class="bulletList">Implementing JWT</li>
<li class="bulletList">Using GraphQL Playground</li>
<li class="bulletList">Performing authentication</li>
</ul>
<h1 class="heading-1" id="_idParaDest-199">Technical requirements</h1>
<p class="normal">To complete this chapter, you will need the following:</p>
<ul>
<li class="bulletList">Node.js 19+</li>
<li class="bulletList">Visual Studio Code</li>
<li class="bulletList">PostgreSQL</li>
<li class="bulletList">Homebrew (<a href="https://brew.sh"><span class="url">https://brew.sh</span></a>)</li>
<li class="bulletList">pgAdmin 4 (<a href="https://www.pgadmin.org/download/"><span class="url">https://www.pgadmin.org/download/</span></a>)</li>
</ul>
<p class="normal">You can find the code for this chapter in this book’s GitHub repository at <a href="https://github.com/PacktPublishing/React-18-Design-Patterns-and-Best-Practices-Fourth-Edition/tree/main/Chapter13"><span class="url">https://github.com/PacktPublishing/React-18-Design-Patterns-and-Best-Practices-Fourth-Edition/tree/main/Chapter13</span></a>.</p>
<h1 class="heading-1" id="_idParaDest-200">Building a backend login system using PostgreSQL, Apollo Server, GraphQL, Sequelize, and JSON Web Tokens</h1>
<p class="normal">In this <a id="_idIndexMarker501"/>section, we <a id="_idIndexMarker502"/>will <a id="_idIndexMarker503"/>be <a id="_idIndexMarker504"/>building<a id="_idIndexMarker505"/> a <a id="_idIndexMarker506"/>backend <a id="_idIndexMarker507"/>login<a id="_idIndexMarker508"/> system<a id="_idIndexMarker509"/> using <a id="_idIndexMarker510"/>PostgreSQL, Apollo Server, GraphQL, Sequelize, and <strong class="keyWord">JSON Web Tokens</strong> (<strong class="keyWord">JWTs</strong>). We <a id="_idIndexMarker511"/>will utilize PostgreSQL for data storage, Sequelize to perform database operations, Apollo Server to create a GraphQL API, GraphQL to shape our API, and JWTs for user authentication and authorization. Whether you are a beginner or an experienced developer, this guide will offer a comprehensive understanding of how to integrate these technologies into a robust and secure backend login system. Let us dive in.</p>
<h1 class="heading-1" id="_idParaDest-201">Installing PostgreSQL</h1>
<p class="normal">For this example, we<a id="_idIndexMarker512"/> will use a PostgreSQL database, so you’ll need to install PostgreSQL to be able to run this project on your machine. </p>
<p class="normal">PostgreSQL is an excellent choice for our database. <em class="italic">Why?</em> It excels in keeping data secure and well organized, even in the event of an unexpected issue. It has the capability to handle various types of data, which proves to be extremely convenient. Additionally, PostgreSQL is extensible, enabling it to go beyond the basics. It operates efficiently and can manage a substantial number of users concurrently. </p>
<p class="normal">Moreover, it boasts robust security features that ensure the protection of our data. Being an open-source platform, it is not only free but also benefits from a large community actively working toward its improvement. If you have prior experience with other databases, PostgreSQL is easy to comprehend, as it adheres to the same standards. Furthermore, it can handle considerable amounts of data and accommodate numerous users simultaneously. This is precisely why it stands as a reliable choice for projects such as our login system.</p>
<p class="normal">If you have a macOS machine, the easiest way to install PostgreSQL is by doing so with Homebrew. You just need to run the following command:</p>
<pre class="programlisting con"><code class="hljs-con">brew install postgres
</code></pre>
<p class="normal">Once you’ve installed it, you need to run the following command:</p>
<pre class="programlisting con"><code class="hljs-con">ln -sfv /usr/local/opt/postgresql/*.plist ~/Library/LaunchAgents
</code></pre>
<p class="normal">This command creates a symbolic link (a type of shortcut) from the PostgreSQL <code class="inlineCode">plist</code> files (which are configuration files used by macOS) to your <code class="inlineCode">~/Library/LaunchAgents</code> directory. The options used with the <code class="inlineCode">ln -sfv</code> command are as follows: “<strong class="keyWord">s</strong>” for <strong class="keyWord">symbolic</strong> (to create a symbolic link), “<strong class="keyWord">f</strong>” for <strong class="keyWord">force</strong> (to remove existing destination files), and “<strong class="keyWord">v</strong>” for <strong class="keyWord">verbose</strong> (to display what is happening).</p>
<p class="normal">Then, you can create two new aliases to start and stop your PostgreSQL server:</p>
<pre class="programlisting con"><code class="hljs-con">alias pg_start="launchctl load ~/Library/LaunchAgents"
alias pg_stop="launchctl unload ~/Library/LaunchAgents"
</code></pre>
<p class="normal">Now, you should be able to start your PostgreSQL server by using <code class="inlineCode">pg_start</code> or stop it with <code class="inlineCode">pg_stop</code>. After this, you need to create your first database, like so:</p>
<pre class="programlisting con"><code class="hljs-con">createdb `whoami`
</code></pre>
<p class="normal">Now, you can connect to PostgreSQL using the <code class="inlineCode">psql</code> command. If you get an error stating the role <code class="inlineCode">"postgresql</code>" does not exist, you can fix it by running the following command:</p>
<pre class="programlisting con"><code class="hljs-con">createuser -s postgres
</code></pre>
<p class="normal">If you did<a id="_idIndexMarker513"/> everything correctly, you should see something like this:</p>
<p class="packt_figref"><img alt="A black screen with white text  Description automatically generated" height="106" src="../Images/B18414_13_01.png" width="259"/></p>
<p class="packt_figref">Figure 13.1: psql</p>
<div class="note">
<p class="normal">If you use Windows, you can<a id="_idIndexMarker514"/> download PostgreSQL at <a href="https://www.postgresql.org/download/windows/"><span class="url">https://www.postgresql.org/download/windows/</span></a> and for those that use Linux (Ubuntu), you can <a id="_idIndexMarker515"/>download it from <a href="https://www.postgresql.org/download/linux/ubuntu/"><span class="url">https://www.postgresql.org/download/linux/ubuntu/</span></a>.</p>
</div>
<h2 class="heading-2" id="_idParaDest-202">Best tools for PostgreSQL database management</h2>
<p class="normal">The best tool for <a id="_idIndexMarker516"/>PostgreSQL database management <a id="_idIndexMarker517"/>is <strong class="keyWord">pgAdmin 4</strong> (<a href="https://www.pgadmin.org/download/"><span class="url">https://www.pgadmin.org/download/</span></a>). I like this tool as it can be used to create new servers, users, and databases and can be used to perform SQL queries and work with data. Remember to create a database in order to use it in this example.</p>
<p class="normal">Sometimes, you may get an error when you start your PostgreSQL server that could say something like <strong class="keyWord">FATAL lock file “postmaster.pid” already exists. </strong>If you get this error, you can easily fix it by running the following command:</p>
<pre class="programlisting con"><code class="hljs-con">rm /usr/local/var/postgres/postmaster.pi 
</code></pre>
<p class="normal">With this, you will be able to start your PostgreSQL server. </p>
<p class="normal">Now that we have completed the setup of PostgreSQL and have the pgAdmin tool available for <a id="_idIndexMarker518"/>easier database management, we can shift our focus to the next task, which is building our backend project.</p>
<h1 class="heading-1" id="_idParaDest-203">Creating our backend project</h1>
<p class="normal">First, you need to <a id="_idIndexMarker519"/>create a backend directory in your GraphQL project (<code class="inlineCode">graphql/backend</code>). After that, let’s review the huge list of NPM packages you will need to install (focusing on the most relevant):</p>
<pre class="programlisting con"><code class="hljs-con">npm init --yes
npm install @apollo/server@4.7.3 @contentpi/lib@1.0.10 @graphql-tools/load-files@7.0.0 @graphql-tools/merge@9.0.0 @graphql-tools/schema@10.0.0 body-parser@1.20.2 cors@2.8.5 dotenv@16.1.4 express@4.18.2 graphql-middleware@6.1.34 graphql-tag@2.12.6 jsonwebtoken@9.0.0 pg@8.11.0 pg-hstore@2.3.4 pm2@5.3.0 sequelize@6.32.0 ts-node@10.9.1
npm install --save-dev prettier@2.8.8 ts-node-dev@2.0.0 typescript@5.1.3 eslint@8.42.0 @types/jsonwebtoken@9.0.2 @types/cors@2.8.13
</code></pre>
<p class="normal">Please note that some readers of my last book encountered issues with certain code that did not work as intended. This is due to updates to package versions since the time of writing. </p>
<p class="normal">To ensure that the code in this book functions correctly, I have specified the specific versions of packages that I use. It’s important to note that newer versions of these packages may contain breaking changes that could impact the functionality of the code, so it’s recommended that you use the specified versions to avoid any issues.</p>
<p class="normal">The scripts you should have in your <code class="inlineCode">package.json</code> file should be as follows:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-attr">  "dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ts-node-dev src/index.ts"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">  "build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rm -rf dist &amp;&amp; tsc -p . --traceResolution"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">  "lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint . --ext .js,.tsx,.ts"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">  "lint:fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"</span><span class="hljs-string">eslint . --fix --ext .js,.tsx,.ts"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">  "test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"jest src"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">In the next section, we are going to configure our environment variables.</p>
<h2 class="heading-2" id="_idParaDest-204">Configuring our .env file</h2>
<p class="normal">A <code class="inlineCode">.env</code> file (also known as <em class="italic">dotenv</em>) is a configuration file to specify your application’s <a id="_idIndexMarker520"/>environment variables. Normally your<a id="_idIndexMarker521"/> application won’t change in development, staging, or production environments but they normally need a different configuration. The most common variables to change are the base URL, API URL, or even your API keys.</p>
<p class="normal">Before we jump into the actual login code, we need to create a file called <code class="inlineCode">.env</code> (normally, this file is<a id="_idIndexMarker522"/> ignored by <strong class="keyWord">.gitignore</strong>), which will allow us to use private data, such as the database connection and security secrets. A file already exists in the repository <a id="_idIndexMarker523"/>called <strong class="keyWord">.env.example</strong>; you just need to rename it and put your connection data inside it. The <code class="inlineCode">.env file</code> will look something like this:</p>
<pre class="programlisting con"><code class="hljs-con">DB_DIALECT=postgres
DB_PORT=5432
DB_HOST=localhost
DB_DATABASE=&lt;your-database&gt;
DB_USERNAME=&lt;your-username&gt;
DB_PASSWORD=&lt;your-password&gt;
</code></pre>
<h2 class="heading-2" id="_idParaDest-205">Creating a basic config file</h2>
<p class="normal">For this project, we <a id="_idIndexMarker524"/>need to create a config file to store some security data, which should be created at <strong class="keyWord">/backend/config/config.json</strong>. </p>
<p class="normal">Here, we will define some basic configurations, such as our server’s port and some security information:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
<span class="hljs-attr">  "server"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-attr">  "port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4000</span>
<span class="hljs-punctuation">},</span>
<span class="hljs-attr">  "security"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-attr">  "secretKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"C0nt3ntP1"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">  "expiresIn"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"7d"</span>
<span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">Then, you need to create an <strong class="keyWord">index.ts</strong> file in the config directory. This will bring in all the database connection information we defined in the <code class="inlineCode">.env</code> file using the dotenv package and then<a id="_idIndexMarker525"/> export <a id="_idIndexMarker526"/>three<a id="_idIndexMarker527"/> configuration<a id="_idIndexMarker528"/> variables called <strong class="keyWord">$db</strong>,<strong class="keyWord"> $security</strong>, and <strong class="keyWord">$server</strong>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> dotenv <span class="hljs-keyword">from</span> <span class="hljs-string">'</span><span class="hljs-string">dotenv'</span>
<span class="hljs-keyword">import</span> config <span class="hljs-keyword">from</span> <span class="hljs-string">'./config.json'</span>
dotenv.<span class="hljs-title">config</span>()
type <span class="hljs-title">Db</span> = {
<span class="hljs-attr">  dialect</span>: string
<span class="hljs-attr">  host</span>: string
<span class="hljs-attr">  port</span>: string
<span class="hljs-attr">  database</span>: string
<span class="hljs-attr">  username</span>: string
<span class="hljs-attr">  password</span>: string
}
type <span class="hljs-title">Security</span> = {
<span class="hljs-attr">  secretKey</span>: string
<span class="hljs-attr">  expiresIn</span>: string
}
type <span class="hljs-title">Server</span> = {
<span class="hljs-attr">  port</span>: number
}
<span class="hljs-keyword">const</span> <span class="hljs-attr">db</span>: <span class="hljs-title">Db</span> = {
<span class="hljs-attr">  dialect</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_DIALECT</span> || <span class="hljs-string">''</span>,
<span class="hljs-attr">  port</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_PORT</span> || <span class="hljs-string">''</span>,
<span class="hljs-attr">  host</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_HOST</span> || <span class="hljs-string">''</span>,
<span class="hljs-attr">  database</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_DATABASE</span> || <span class="hljs-string">''</span>,
<span class="hljs-attr">  username</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_USERNAME</span> || <span class="hljs-string">''</span>,
<span class="hljs-attr">  password</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_PASSWORD</span> || <span class="hljs-string">''</span>
}
<span class="hljs-keyword">const</span> { security, server } = config
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">$db</span>: <span class="hljs-title">Db</span> = db
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">$security</span>: <span class="hljs-title">Security</span> = security
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">$server</span>: <span class="hljs-title">Server</span> = server
</code></pre>
<p class="normal">If your <code class="inlineCode">.env</code> file is not in the <code class="inlineCode">root</code> directory or does not exist, all your variables are going to be <strong class="keyWord">undefined</strong>. </p>
<p class="normal">Once you have configured your file and verified the security details of your project, the subsequent step toward enhancing our project involves the utilization and setup of Apollo Server. This invaluable tool facilitates the management of<a id="_idIndexMarker529"/> data exchanges between your server and client, streamlining the communication process.</p>
<h1 class="heading-1" id="_idParaDest-206">Configuring Apollo Server</h1>
<p class="normal">Apollo Server is a<a id="_idIndexMarker530"/> highly popular open-source library for working with GraphQL, both as a server and client. With extensive documentation and straightforward implementation, it has become a go-to choice for many developers. Its intuitive interface and flexible architecture make it easy to customize and adapt to your specific needs, while its robust features and reliable performance ensure seamless integration with your existing code base. Whether you’re a seasoned developer or new to GraphQL, Apollo Server is a powerful tool that can help you take your projects to the next level.</p>
<p class="normal">The following diagram explains how Apollo Server works in the client and the server:</p>
<p class="packt_figref"><img alt="Diagram  Description automatically generated" height="278" src="../Images/B18414_13_02.png" width="484"/></p>
<p class="packt_figref">Figure 13.2: Apollo Server</p>
<p class="normal">Apollo Server facilitates efficient communication between your app or website and the associated database. By utilizing GraphQL, it enables the frontend part of your app to request specific data from the backend in a single operation, resulting in a faster and smoother data exchange. In essence, it serves as an effective intermediary between your user interface and the database.</p>
<p class="normal">For our setup, we will use Express to establish our Apollo Server and the Sequelize <strong class="keyWord">Object Relational Mapper</strong> (<strong class="keyWord">ORM</strong>) to handle our PostgreSQL database. Express is a popular<a id="_idIndexMarker531"/> choice to configure Apollo Server due to its seamless integration with Apollo and its flexibility, which provides developers with greater freedom. Express.js is a lightweight and performance-optimized framework suitable for applications of various sizes, from small to large and scalable ones. Moreover, its maturity and extensive community support make it a reliable option. Its simplicity, especially for those already familiar with JavaScript and Node.js, enables a quick and efficient Apollo Server setup. Therefore, we will begin by <a id="_idIndexMarker532"/>importing the necessary components.</p>
<p class="normal">The required file can be found at <code class="inlineCode">/backend/src/index.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { makeExecutableSchema } <span class="hljs-keyword">from</span> <span class="hljs-string">'@graphql-tools/schema'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">ApolloServer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@apollo/server'</span>
<span class="hljs-keyword">import</span> { expressMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">'@apollo/server/express4'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">ApolloServerPluginDrainHttpServer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@apollo/server/plugin/drainHttpServer'</span>
<span class="hljs-keyword">import</span> cors <span class="hljs-keyword">from</span> <span class="hljs-string">'cors'</span>
<span class="hljs-keyword">import</span> http <span class="hljs-keyword">from</span> <span class="hljs-string">'http'</span>
<span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>
<span class="hljs-keyword">import</span> { applyMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">'graphql-middleware'</span>
<span class="hljs-keyword">import</span> { json } <span class="hljs-keyword">from</span> <span class="hljs-string">'body-parser'</span>
<span class="hljs-keyword">import</span> { $server } <span class="hljs-keyword">from</span> <span class="hljs-string">'../config'</span>
<span class="hljs-keyword">import</span> resolvers <span class="hljs-keyword">from</span> <span class="hljs-string">'./graphql/resolvers'</span>
<span class="hljs-keyword">import</span> typeDefs <span class="hljs-keyword">from</span> <span class="hljs-string">'./graphql/types'</span>
<span class="hljs-keyword">import</span> models <span class="hljs-keyword">from</span> <span class="hljs-string">'./models'</span>
</code></pre>
<p class="normal">First, we need to set up our <code class="inlineCode">Express.js application</code> and <code class="inlineCode">cors</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">const</span> app = <span class="hljs-title">express</span>()
<span class="hljs-keyword">const</span> corsOptions = {
<span class="hljs-attr">  origin</span>: <span class="hljs-string">'*'</span>,
<span class="hljs-attr">  credentials</span>: <span class="hljs-literal">true</span>
}
app.<span class="hljs-title">use</span>(<span class="hljs-title">cors</span>(corsOptions))
app.<span class="hljs-title">use</span>(<span class="hljs-function">(</span><span class="hljs-params">req, res, next</span><span class="hljs-function">) =&gt;</span> {
  res.<span class="hljs-title">header</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, <span class="hljs-string">'*'</span>)
  res.<span class="hljs-title">header</span>(
<span class="hljs-string">    'Access-Control-Allow-Headers'</span>, 
<span class="hljs-string">    'Origin, X-Requested-With, Content-Type, Accept'</span>
)
<span class="hljs-title">next</span>()
})
</code></pre>
<p class="normal">Then, we need to create our schema using <code class="inlineCode">applyMiddleware</code> and <code class="inlineCode">makeExecutableSchema</code> by passing <code class="inlineCode">typeDefs</code> and <code class="inlineCode">resolvers</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Schema</span>
<span class="hljs-keyword">const</span> schema = <span class="hljs-title">applyMiddleware</span>(
<span class="hljs-title">  makeExecutableSchema</span>({
<span class="hljs-title">    </span>typeDefs,
<span class="hljs-title">    </span>resolvers
  })
)
</code></pre>
<p class="normal">After that, we need to create an instance of Apollo Server, where we need to pass the schema and the plugins:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Apollo Server</span>
<span class="hljs-keyword">const</span> apolloServer = <span class="hljs-keyword">new</span> <span class="hljs-title">ApolloServer</span>({
<span class="hljs-title">  </span>schema,
<span class="hljs-attr">  plugins</span>: [<span class="hljs-title">ApolloServerPluginDrainHttpServer</span>({ httpServer })]
})
</code></pre>
<p class="normal">Finally, we need to synchronize Sequelize. Here, we pass some optional variables (<code class="inlineCode">alter</code> and <code class="inlineCode">force</code>). If <code class="inlineCode">force</code> is true and you change your Sequelize models, this will delete your tables, including their values, and force you to create the tables again, while<a id="_idIndexMarker533"/> if <code class="inlineCode">force</code> is <code class="inlineCode">false</code> and <code class="inlineCode">alter</code> is <code class="inlineCode">true</code>, then you will only update the table fields, without this affecting your values. So, you need to be careful with this option, as you can lose all your data by accident. Then, after the sync, we must run our Apollo Server, which listens to port <code class="inlineCode">4000</code> (<strong class="keyWord">$server.port</strong>):</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">const</span> <span class="hljs-title">main</span> = <span class="hljs-keyword">async</span> () =&gt; {
<span class="hljs-title">  </span><span class="hljs-keyword">const</span> alter = <span class="hljs-literal">true</span>
<span class="hljs-title">  </span><span class="hljs-keyword">const</span> force = <span class="hljs-literal">false</span>
<span class="hljs-title">  </span><span class="hljs-keyword">await</span> apolloServer.<span class="hljs-title">start</span>()
<span class="hljs-title">  </span><span class="hljs-keyword">await</span> models.<span class="hljs-property">sequelize</span>.<span class="hljs-title">sync</span>({ alter, force })
<span class="hljs-title">  </span>app.<span class="hljs-title">use</span>(
<span class="hljs-title">    </span><span class="hljs-string">'/graphql'</span>,
<span class="hljs-title">    </span>cors&lt;cors.<span class="hljs-property">CorsRequest</span>&gt;(),
<span class="hljs-title">    json</span>(),
<span class="hljs-title">    expressMiddleware</span>(apolloServer, {
<span class="hljs-attr">  </span><span class="hljs-title">    </span><span class="hljs-attr">context</span>: <span class="hljs-keyword">async</span> () =&gt; ({ models })
<span class="hljs-title">    </span>})
<span class="hljs-title">  </span>)
<span class="hljs-title">  </span><span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt;(<span class="hljs-function">(</span><span class="hljs-params">resolve</span><span class="hljs-function">) =&gt;</span> httpServer.<span class="hljs-title">listen</span>({ 
<span class="hljs-attr">  </span><span class="hljs-title">  </span><span class="hljs-attr">port</span>: $server.<span class="hljs-property">port</span> 
<span class="hljs-title">  </span>}, resolve))
<span class="hljs-variable">  console</span>.<span class="hljs-title">log</span>(<span class="hljs-string">`</span>🚀<span class="hljs-string"> Server ready at http://localhost:</span><span class="hljs-subst">${$server.port}</span><span class="hljs-string">/graphql`</span>)
}
<span class="hljs-title">main</span>()
</code></pre>
<p class="normal">This process will help us in synchronizing our database with our models, ensuring that any <a id="_idIndexMarker534"/>modifications made to the models will automatically update the corresponding tables.</p>
<h1 class="heading-1" id="_idParaDest-207">Defining our GraphQL types, queries, and mutations</h1>
<p class="normal">Now that you have created your Apollo Server instance, the next step is to create your GraphQL types. When setting up a GraphQL server like Apollo, creating GraphQL types is crucial. These types ensure that the data returned from your API is reliable and conforms to the expected structure. They act as a helpful reference for available data and its expected format. By using types, your application can precisely request the required data, resulting in faster execution and reduced data consumption. Additionally, types help maintain data consistency, resulting in a robust, comprehensible, and efficient API.</p>
<h2 class="heading-2" id="_idParaDest-208">Scalar types</h2>
<p class="normal">The first<a id="_idIndexMarker535"/> thing you need to do is define your scalar types at <code class="inlineCode">/backend/src/graphql/types/Scalar.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> gql <span class="hljs-keyword">from</span> <span class="hljs-string">'graphql-tag'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> gql<span class="hljs-string">`</span>
<span class="hljs-string">  scalar UUID</span>
<span class="hljs-string">  scalar Datetime</span>
<span class="hljs-string">  scalar JSON</span>
</code></pre>
<p class="normal">Now, let’s create our <code class="inlineCode">User</code> type (<code class="inlineCode">backend/src/graphql/types/User.ts</code>):</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> gql <span class="hljs-keyword">from</span> <span class="hljs-string">'graphql-tag'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> gql<span class="hljs-string">`</span>
<span class="hljs-string">  type User {</span>
<span class="hljs-string">  id: UUID!</span>
<span class="hljs-string">  username: String!</span>
<span class="hljs-string">  email: String!</span>
<span class="hljs-string">  password: String!</span>
<span class="hljs-string">  role: String!</span>
<span class="hljs-string">  active: Boolean!</span>
<span class="hljs-string">  createdAt: Datetime!</span>
<span class="hljs-string">  updatedAt: Datetime!</span>
<span class="hljs-string">}</span>
<span class="hljs-string">`</span>
</code></pre>
<p class="normal">As you can see, we use some <a id="_idIndexMarker536"/>scalar types such as <strong class="keyWord">UUID</strong> and <strong class="keyWord">Datetime</strong> to define <a id="_idIndexMarker537"/>some fields in our <code class="inlineCode">User</code> type. In this case, when you define a type in GraphQL, you need to do so with the <code class="inlineCode">type</code> keyword, followed by the type’s name capitalized. Then, you can define your fields inside the curly braces, <code class="inlineCode">{}</code>.</p>
<p class="normal">There are<a id="_idIndexMarker538"/> some <a id="_idIndexMarker539"/>primitive <a id="_idIndexMarker540"/>data<a id="_idIndexMarker541"/> types in GraphQL such as <code class="inlineCode">String</code>, <code class="inlineCode">Boolean</code>, <code class="inlineCode">Float</code>, and <code class="inlineCode">Int</code>. You can define custom scalar types as we did with <strong class="keyWord">UUID</strong>, <strong class="keyWord">Datetime</strong>, and <strong class="keyWord">JSON</strong>, and you can also define custom types such as the <code class="inlineCode">User</code> type and specify whether we want<a id="_idIndexMarker542"/> an array of that type, for example, <code class="inlineCode">[User]</code>.</p>
<div class="note">
<p class="normal">The <code class="inlineCode">!</code> character after the types means the field is non-nullable.</p>
</div>
<h2 class="heading-2" id="_idParaDest-209">Queries</h2>
<p class="normal">GraphQL queries<a id="_idIndexMarker543"/> are used to read or fetch values from a data store. Now that you know how to define custom types, let’s define our <code class="inlineCode">Query</code> type. Here, we will define <code class="inlineCode">getUsers</code> and <code class="inlineCode">getUser</code>. The first will retrieve a list of users, while the second will bring us the data of the specific user:</p>
<pre class="programlisting code"><code class="hljs-code">type <span class="hljs-title">Query</span> {
<span class="hljs-title">  getUser</span>(<span class="hljs-attr">at</span>: <span class="hljs-title">String</span>!): <span class="hljs-title">User</span>!
<span class="hljs-attr">  getUsers</span>: [<span class="hljs-title">User</span>!]
}
</code></pre>
<p class="normal">In this case, our <code class="inlineCode">getUsers</code> query will return an array of users (<code class="inlineCode">[User!]</code>), while our <code class="inlineCode">getUser</code> query, which requires the <code class="inlineCode">at</code> (access token) attribute, will return a single <code class="inlineCode">User!</code>. Remember that with any query you add here, you will need to define it under your <code class="inlineCode">resolvers</code> later (we will do that in the next section).</p>
<h2 class="heading-2" id="_idParaDest-210">Mutations</h2>
<p class="normal">Mutations are used to<a id="_idIndexMarker544"/> write or post values: that is, to modify data in the data store: and return a value if you want to do some comparisons with <code class="inlineCode">REST</code>, such <a id="_idIndexMarker545"/>as <a id="_idIndexMarker546"/>perform <a id="_idIndexMarker547"/>any <code class="inlineCode">POST</code>, <code class="inlineCode">PUT</code>, <code class="inlineCode">PATCH</code>, or <code class="inlineCode">DELETE</code> actions. The <code class="inlineCode">Mutation</code> <a id="_idIndexMarker548"/>type works exactly the same as the <code class="inlineCode">Query</code> type, in that you need to define your mutations and specify what arguments you will receive and what data you will return:</p>
<pre class="programlisting code"><code class="hljs-code">type <span class="hljs-title">Mutation</span> {
<span class="hljs-title">  createUser</span>(<span class="hljs-attr">input</span>: <span class="hljs-title">CreateUserInput</span>): <span class="hljs-title">User</span>!
<span class="hljs-title">  login</span>(<span class="hljs-attr">input</span>: <span class="hljs-title">LoginInput</span>): <span class="hljs-title">Token</span>!
}
</code></pre>
<p class="normal">As you can see, we have defined two mutations. The first is <strong class="keyWord">createUser</strong>, to register or create a new user in our data store, while the second one is to perform a <strong class="keyWord">login</strong>. As you may have noticed, both receive the input argument with some different values (<code class="inlineCode">CreateUserInput</code> and <code class="inlineCode">LoginInput</code>), called <strong class="keyWord">input types</strong>, which are used as <a id="_idIndexMarker549"/>query or mutation parameters. Finally, they will return the <code class="inlineCode">User!</code> and <code class="inlineCode">Token!</code> types, respectively. Let’s learn how to define those inputs:</p>
<pre class="programlisting code"><code class="hljs-code">type <span class="hljs-title">Token</span> {
<span class="hljs-attr"> token</span>: <span class="hljs-title">String</span>!
}
input <span class="hljs-title">CreateUserInput</span> {
 <span class="hljs-attr">username</span>: <span class="hljs-title">String</span>!
 <span class="hljs-attr">password</span>: <span class="hljs-title">String</span>!
 <span class="hljs-attr">email</span>: <span class="hljs-title">String</span>!
 <span class="hljs-attr">active</span>: <span class="hljs-title">Boolean</span>!
 <span class="hljs-attr">role</span>: <span class="hljs-title">String</span>!
}
input <span class="hljs-title">LoginInput</span> {
 <span class="hljs-attr">emailOrUsername</span>: <span class="hljs-title">String</span>!
 <span class="hljs-attr">password</span>: <span class="hljs-title">String</span>!
}
</code></pre>
<p class="normal">The inputs are normally used with mutations, but you can also use them with queries.</p>
<h2 class="heading-2" id="_idParaDest-211">Merging type definitions</h2>
<p class="normal">Now that we’ve <a id="_idIndexMarker550"/>defined all our types, queries, and mutations, we need to merge all our GraphQL files to create our GraphQL schema, which is basically one big file containing all our GraphQL definitions.</p>
<p class="normal">For this, you need to create a file called <code class="inlineCode">/backend/src/graphql/types/index.ts</code> that contains the following code:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { mergeTypeDefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@graphql-tools/merge'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">Scalar</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Scalar'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">User</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./User'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">mergeTypeDefs</span>([<span class="hljs-title">Scalar</span>, <span class="hljs-title">User</span>])
</code></pre>
<p class="normal">After successfully merging your type definitions into one comprehensive GraphQL schema, the next critical step is to create resolvers. Resolvers are functions that<a id="_idIndexMarker551"/> have the responsibility of fetching and generating the data that corresponds to the fields defined in your GraphQL schema.</p>
<h1 class="heading-1" id="_idParaDest-212">Creating our resolvers</h1>
<p class="normal">A resolver is <a id="_idIndexMarker552"/>a function that’s responsible for generating data for a field in your GraphQL schema. It can normally generate the data in any way you want, in that it can fetch data from a database or by using a third-party API.</p>
<p class="normal">To create our user resolvers, you need to create a file called <code class="inlineCode">/backend/src/graphql/resolvers/user.ts</code>. Let’s create a skeleton of what our resolver should look like. Here, we need to specify the functions that are defined under <strong class="keyWord">Query</strong> and <strong class="keyWord">Mutation</strong> in our GraphQL schema. So, your resolver should look like this:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
<span class="hljs-title">  Query</span>: {
<span class="hljs-title">    </span><span class="hljs-attr">getUsers</span>: <span class="hljs-function">() =&gt;</span> {},
    <span class="hljs-attr">getUser</span>: <span class="hljs-function">() =&gt;</span> {}
  },
<span class="hljs-title">  Mutation</span>: {
    <span class="hljs-attr">createUser</span>: <span class="hljs-function">() =&gt;</span> {},
    <span class="hljs-attr">login</span>: <span class="hljs-function">() =&gt;</span> {}
  }
}
</code></pre>
<p class="normal">As you can see, we return an object with two main<a id="_idIndexMarker553"/> nodes called <strong class="keyWord">Query</strong> and <strong class="keyWord">Mutation</strong>, and<a id="_idIndexMarker554"/> we map the queries and the mutations we defined in our GraphQL schema (the <code class="inlineCode">User.ts</code> file). Of course, we need to make some changes to receive some parameters and return some data, but I wanted to show you the basic skeleton of a resolver file first.</p>
<p class="normal">The first thing <a id="_idIndexMarker555"/>you need to do is add some imports to the file:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { doLogin, getUserBy } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../lib/auth'</span>
<span class="hljs-keyword">import</span> { getUserData } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../lib/jwt'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">ICreateUserInput</span>, <span class="hljs-title">IloginInput</span>, <span class="hljs-title">Imodels</span>, <span class="hljs-title">Itoken</span>, <span class="hljs-title">Iuser</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../types'</span>
</code></pre>
<p class="normal">We will create the <strong class="keyWord">getUsers </strong>and<strong class="keyWord"> getUser</strong> functions in the next section.</p>
<h2 class="heading-2" id="_idParaDest-213">Creating the getUsers query</h2>
<p class="normal">Our first<a id="_idIndexMarker556"/> method <a id="_idIndexMarker557"/>will be the <strong class="keyWord">getUsers</strong> query. Let’s see how we need to define it:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr">getUsers</span>: (
<span class="hljs-attr">_</span>: any, 
<span class="hljs-attr">args</span>: any, 
<span class="hljs-attr">ctx</span>: { <span class="hljs-attr">models</span>: <span class="hljs-title">Imodels</span> }
): <span class="hljs-title">Iuser</span>[] =&gt; ctx.<span class="hljs-property">models</span>.<span class="hljs-property">User</span>.<span class="hljs-title">findAll</span>(),
</code></pre>
<p class="normal">In any query or mutation method, we always receive four parameters: the parent (defined as <code class="inlineCode">_</code>), arguments (defined as <code class="inlineCode">args</code>), the context (defined as <code class="inlineCode">ctx</code>), and info (which is optional).</p>
<p class="normal">If you want to simplify the code a little bit, you can destructure the context, like this:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr">getUsers</span>: (
<span class="hljs-attr">_</span>: any, 
<span class="hljs-attr">args</span>: any, 
{ models }: { <span class="hljs-attr">models</span>: <span class="hljs-title">Imodels</span> }
): <span class="hljs-title">Iuser</span>[] =&gt; ctx.<span class="hljs-property">models</span>.<span class="hljs-property">User</span>.<span class="hljs-title">findAll</span>(),
</code></pre>
<p class="normal">In our next resolver function, we are going to destructure our arguments as well. Just as a reminder, the context is passed in our Apollo Server setup (we did this previously):</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Apollo Server</span>
<span class="hljs-keyword">const</span> apolloServer = <span class="hljs-keyword">new</span> <span class="hljs-title">ApolloServer</span>({
schema,
<span class="hljs-attr">context</span>: <span class="hljs-keyword">async</span> () =&gt; ({
models
})
})
</code></pre>
<p class="normal">The context is <a id="_idIndexMarker558"/>very<a id="_idIndexMarker559"/> important when we need to share something globally in our resolvers.</p>
<h2 class="heading-2" id="_idParaDest-214">Creating the getUser query</h2>
<p class="normal">This function <a id="_idIndexMarker560"/>needs to be <code class="inlineCode">async</code> because we need to <a id="_idIndexMarker561"/>perform some asynchronous operations, such as getting the connected user via an <code class="inlineCode">at</code> (access token) if a user already has a valid session. Then, we can validate whether this is a real user by looking at our database. This helps stop people from modifying the cookies or trying to do some form of injection. If we don’t find a connected user, then we return an object of the user that contains empty data:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr">getUser</span>: <span class="hljs-keyword">async</span> (
<span class="hljs-attr">_</span>: any, 
{ at }: { <span class="hljs-attr">at</span>: string }, 
{ models }: { <span class="hljs-attr">models</span>: <span class="hljs-title">IModels</span> }
): <span class="hljs-title">Promise</span>&lt;any&gt; =&gt; {
<span class="hljs-comment">// Get current connected user</span>
<span class="hljs-keyword">const</span> connectedUser = <span class="hljs-keyword">await</span> <span class="hljs-title">getUserData</span>(at)
<span class="hljs-keyword">if</span> (connectedUser) {
<span class="hljs-comment">// Validating if the user is still valid</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title">getUserBy</span>({
<span class="hljs-attr">id</span>: connectedUser.<span class="hljs-property">id</span>,
<span class="hljs-attr">email</span>: connectedUser.<span class="hljs-property">email</span>,
<span class="hljs-attr">active</span>: connectedUser.<span class="hljs-property">active</span>
},
[connectedUser.<span class="hljs-property">role</span>],
models
)
 
<span class="hljs-keyword">if</span> (user) {
<span class="hljs-keyword">return</span> connectedUser
}
}
<span class="hljs-keyword">return</span> {
<span class="hljs-attr">id</span>: <span class="hljs-string">''</span>,
<span class="hljs-attr">username</span>: <span class="hljs-string">''</span>,
<span class="hljs-attr">password</span>: <span class="hljs-string">''</span>,
<span class="hljs-attr">email</span>: <span class="hljs-string">''</span>,
<span class="hljs-attr">role</span>: <span class="hljs-string">''</span>,
<span class="hljs-attr">active</span>: <span class="hljs-literal">false</span>
}
}
</code></pre>
<h2 class="heading-2" id="_idParaDest-215">Creating the mutations</h2>
<p class="normal">Our mutations<a id="_idIndexMarker562"/> are very simple: we just need to<a id="_idIndexMarker563"/> execute some functions and pass all our arguments by spreading the input value (this comes from our GraphQL schema). Let’s see what our <code class="inlineCode">Mutation</code> node should look like:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-title">Mutation</span>: {
<span class="hljs-attr">createUser</span>: (
<span class="hljs-attr">_</span>: any,
{ input }: { <span class="hljs-attr">input</span>: <span class="hljs-title">ICreateUserInput</span> },
{ models }: { <span class="hljs-attr">models</span>: <span class="hljs-title">IModels</span> }
): <span class="hljs-params">IUser</span><span class="hljs-function"> =&gt;</span> models.<span class="hljs-property">User</span>.<span class="hljs-title">create</span>({ ...input }),
<span class="hljs-attr">login</span>: (
<span class="hljs-attr">_</span>: any,
{ input }: { <span class="hljs-attr">input</span>: <span class="hljs-title">ILoginInput</span> },
{ models }: { <span class="hljs-attr">models</span>: <span class="hljs-title">IModels</span> }
): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">IToken</span>&gt; =&gt; <span class="hljs-title">doLogin</span>(input.<span class="hljs-property">email</span>, input.<span class="hljs-property">password</span>, models)
}
</code></pre>
<p class="normal">You need to pass the <strong class="keyWord">email</strong>, <strong class="keyWord">password</strong>, and <strong class="keyWord">models</strong> to the <code class="inlineCode">doLogin</code> function.</p>
<h2 class="heading-2" id="_idParaDest-216">Merging our resolvers</h2>
<p class="normal">As we did with <a id="_idIndexMarker564"/>our <code class="inlineCode">types</code> definitions, we need to merge all our resolvers using the <code class="inlineCode">@graphql-tools</code> packages. You need to create the following file at <code class="inlineCode">/backend/src/graphql/resolvers/index.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { mergeResolvers } <span class="hljs-keyword">from</span> <span class="hljs-string">'@graphql-tools/merge'</span>
<span class="hljs-keyword">import</span> user <span class="hljs-keyword">from</span> <span class="hljs-string">'./user'</span>
<span class="hljs-keyword">const</span> resolvers = <span class="hljs-title">mergeResolvers</span>([user])
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> resolvers
</code></pre>
<p class="normal">This will combine all your resolvers into an array of resolvers. </p>
<p class="normal">Once your resolvers are merged, bringing all your data-fetching functions into one coherent structure, it’s time to move on to the next phase: creating Sequelize models. Sequelize is a powerful tool that simplifies the interaction between your<a id="_idIndexMarker565"/> application and various databases, translating complex SQL commands into user-friendly JavaScript.</p>
<h1 class="heading-1" id="_idParaDest-217">Using the Sequelize ORM</h1>
<p class="normal">Sequelize is a<a id="_idIndexMarker566"/> popular ORM library for Node.js. It enables developers to interact with databases like MySQL, PostgreSQL, SQLite, and Microsoft SQL Server by abstracting the underlying SQL commands into higher-level, easy-to-use JavaScript objects and methods.</p>
<p class="normal">Using Sequelize, developers can perform database operations like creating, updating, deleting, and querying records without having to write raw SQL queries. Sequelize also helps with defining data models, managing associations between tables, and handling database migrations.</p>
<p class="normal">Some key features of Sequelize ORM include:</p>
<ul>
<li class="bulletList"><strong class="keyWord">Model definition</strong>: Sequelize <a id="_idIndexMarker567"/>allows you to define models with their attributes, data types, and constraints, which map to tables in the underlying database.</li>
<li class="bulletList"><strong class="keyWord">Associations</strong>: You can easily define relationships between models, such as one-to-one, one-to-many, and many-to-many, which map to foreign key constraints in the database.</li>
<li class="bulletList"><strong class="keyWord">Querying</strong>: Sequelize provides a robust querying system that allows you to fetch, filter, sort, and paginate data without writing raw SQL.</li>
<li class="bulletList"><strong class="keyWord">Transactions</strong>: It supports transactions for performing multiple database operations atomically.</li>
<li class="bulletList"><strong class="keyWord">Migrations</strong>: Sequelize offers a migration system to manage schema changes over time and keep your database schema in sync with your application’s code.</li>
</ul>
<h2 class="heading-2" id="_idParaDest-218">Creating a user model in Sequelize</h2>
<p class="normal">Before we jump <a id="_idIndexMarker568"/>into the authentication<a id="_idIndexMarker569"/> functions, we need to create our <code class="inlineCode">User</code> model in Sequelize. For this, we need to create a file at <code class="inlineCode">/backend/src/models/User.ts</code>. Our model will have the following fields:</p>
<ul>
<li class="bulletList"><code class="inlineCode">id</code></li>
<li class="bulletList"><code class="inlineCode">username</code></li>
<li class="bulletList"><code class="inlineCode">password</code></li>
<li class="bulletList"><code class="inlineCode">email</code></li>
<li class="bulletList"><code class="inlineCode">role</code></li>
<li class="bulletList"><code class="inlineCode">active</code></li>
</ul>
<p class="normal">Let’s see the code:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { encrypt } <span class="hljs-keyword">from</span> <span class="hljs-string">'@contentpi/lib'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">IDataTypes</span>, <span class="hljs-title">IUser</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../types'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> (<span class="hljs-attr">sequelize</span>: any, <span class="hljs-title">DataTypes</span>: <span class="hljs-title">IDataTypes</span>): <span class="hljs-params">IUser</span><span class="hljs-function"> =&gt;</span> {
<span class="hljs-keyword">const</span> <span class="hljs-title">User</span> = sequelize.<span class="hljs-title">define</span>(<span class="hljs-string">'User'</span>, {
<span class="hljs-attr">id</span>: {
<span class="hljs-attr">primaryKey</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">type</span>: <span class="hljs-title">DataTypes</span>.<span class="hljs-property">UUID</span>,
<span class="hljs-attr">defaultValue</span>: <span class="hljs-title">DataTypes</span>.<span class="hljs-title">UUIDV4</span>()
},
<span class="hljs-attr">username</span>: {
<span class="hljs-attr">type</span>: <span class="hljs-title">DataTypes</span>.<span class="hljs-property">STRING</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">validate</span>: {
<span class="hljs-attr">isAlphanumeric</span>: {
<span class="hljs-attr">args</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">msg</span>: <span class="hljs-string">'</span><span class="hljs-string">The user just accepts alphanumeric characters'</span>
},
<span class="hljs-attr">len</span>: {
<span class="hljs-attr">args</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">20</span>],
<span class="hljs-attr">msg</span>: <span class="hljs-string">'The username must be from 4 to 20 characters'</span>
}
}
},
<span class="hljs-attr">password</span>: {
<span class="hljs-attr">type</span>: <span class="hljs-title">Datatypes</span>.<span class="hljs-property">STRING</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>
},
<span class="hljs-attr">email</span>: {
<span class="hljs-attr">type</span>: <span class="hljs-title">DataTypes</span>.<span class="hljs-property">STRING</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">validate</span>: {
<span class="hljs-attr">isEmail</span>: {
<span class="hljs-attr">args</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">msg</span>: <span class="hljs-string">'Invalid email'</span>
}
}
},
<span class="hljs-attr">role</span>: {
<span class="hljs-attr">type</span>: <span class="hljs-title">DataTypes</span>.<span class="hljs-property">STRING</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">defaultValue</span>: <span class="hljs-string">'user'</span>
},
<span class="hljs-attr">active</span>: {
<span class="hljs-attr">type</span>: <span class="hljs-title">DataTypes</span>.<span class="hljs-property">BOOLEAN</span>,
<span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">defaultValue</span>: <span class="hljs-literal">false</span>
}
},
{
<span class="hljs-attr">hooks</span>: {
<span class="hljs-attr">beforeCreate</span>: (<span class="hljs-attr">user</span>: <span class="hljs-title">IUser</span>): <span class="hljs-params">void</span><span class="hljs-function"> =&gt;</span> {
user.<span class="hljs-property">password</span> = <span class="hljs-title">encrypt</span>(user.<span class="hljs-property">password</span>)
}
}
}
)
<span class="hljs-keyword">return</span> <span class="hljs-title">User</span>
}
</code></pre>
<p class="normal">As you can <a id="_idIndexMarker570"/>see, we are defining a Sequelize Hook <a id="_idIndexMarker571"/>called <code class="inlineCode">beforeCreate</code>, which<a id="_idIndexMarker572"/> helps us <strong class="keyWord">encrypt</strong> (using <strong class="keyWord">sha1</strong>) the user password right before the data is saved. Finally, we return the <code class="inlineCode">User</code> model.</p>
<h2 class="heading-2" id="_idParaDest-219">Connecting Sequelize to a PostgreSQL database</h2>
<p class="normal">Now that <a id="_idIndexMarker573"/>we’ve created the <a id="_idIndexMarker574"/>user model, we need to connect Sequelize to our PostgreSQL database and put all our models together. </p>
<p class="normal">You need to <a id="_idIndexMarker575"/>add the following code to the <code class="inlineCode">/backend/src/models/index.ts</code> file:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">Sequelize</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'sequelize'</span>
<span class="hljs-keyword">import</span> { $db } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../config'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">IModels</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../types'</span>
<span class="hljs-comment">// Db Connection</span>
<span class="hljs-keyword">const</span> { dialect, port, host, database, username, password } = $db
<span class="hljs-comment">// Connecting to the database</span>
<span class="hljs-keyword">const</span> uri = <span class="hljs-string">`</span><span class="hljs-subst">${dialect}</span><span class="hljs-string">://</span><span class="hljs-subst">${username}</span><span class="hljs-string">:</span><span class="hljs-subst">${password}</span><span class="hljs-string">@</span><span class="hljs-subst">${host}</span><span class="hljs-string">:</span><span class="hljs-subst">${port}</span><span class="hljs-string">/</span><span class="hljs-subst">${database}</span><span class="hljs-string">`</span>
<span class="hljs-keyword">const</span> sequelize = <span class="hljs-keyword">new</span> <span class="hljs-title">Sequelize</span>(uri)
<span class="hljs-comment">// Models</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">models</span>: <span class="hljs-title">IModels</span> = {
<span class="hljs-title">User</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'</span><span class="hljs-string">./User'</span>).<span class="hljs-title">default</span>(sequelize, <span class="hljs-title">Sequelize</span>),
sequelize
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> models
</code></pre>
<h1 class="heading-1" id="_idParaDest-220">Authentication functions</h1>
<p class="normal">Step by step, we <a id="_idIndexMarker576"/>are putting all the puzzle pieces together. Now, let’s look at the authentication functions we will use to validate whether a user is connected or not and get the user’s data. For this, we need to use JWTs.</p>
<p class="normal">JWT is an open standard outlined in RFC 7519 (<a href="https://tools.ietf.org/html/rfc7519"><span class="url">https://tools.ietf.org/html/rfc7519</span></a>). It serves as a valuable tool to transmit information between parties as a JSON object. One of the primary advantages of JWTs is their digital signature, which allows them to be easily verified and trusted. The token is signed using the HMAC algorithm and a secret or a public key pair using RSA or ECDSA, ensuring that it remains secure and tamper-proof. This makes JWTs a reliable choice for authentication and authorization purposes in a wide range of applications.</p>
<h2 class="heading-2" id="_idParaDest-221">Creating JWT functions</h2>
<p class="normal">Let’s create <a id="_idIndexMarker577"/>some functions<a id="_idIndexMarker578"/> that will help verify a JWT and get the user data. For this, we need to create the <code class="inlineCode">jwtVerify</code>, <code class="inlineCode">getUserData</code>, and <code class="inlineCode">createToken</code> functions. This file should be created at <code class="inlineCode">/backend/src/lib/jwt.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { encrypt, getBase64, setBase64 } <span class="hljs-keyword">from</span> <span class="hljs-string">'@contentpi/lib'</span>
<span class="hljs-keyword">import</span> jwt <span class="hljs-keyword">from</span> <span class="hljs-string">'jsonwebtoken'</span>
<span class="hljs-keyword">import</span> { $security } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../config'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">IUser</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../types'</span>
<span class="hljs-keyword">const</span> { secretKey } = $security
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title">jwtVerify</span>(<span class="hljs-params">accessToken: string, cb: any</span>): <span class="hljs-keyword">void</span> {
<span class="hljs-comment">// Verifiying our JWT token using the accessToken and the secretKey</span>
jwt.<span class="hljs-title">verify</span>(accessToken, secretKey, <span class="hljs-function">(</span><span class="hljs-params">error: any, accessTokenData: any = {}</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: user } = accessTokenData
<span class="hljs-comment">// If we get an error or the user is not found we return false</span>
<span class="hljs-keyword">if</span> (error || !user) {
<span class="hljs-keyword">return</span> <span class="hljs-title">cb</span>(<span class="hljs-literal">false</span>)
}
<span class="hljs-comment">// The user data is on base64 and getBase64 will retreive the</span>
<span class="hljs-comment">// information as JSON object</span>
<span class="hljs-keyword">const</span> userData = <span class="hljs-title">getBase64</span>(user)
<span class="hljs-keyword">return</span> <span class="hljs-title">cb</span>(userData)
})
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title">getUserData</span>(<span class="hljs-params">accessToken: string</span>): <span class="hljs-title">Promise</span>&lt;any&gt; {
<span class="hljs-comment">// We resolve the jwtVerify promise to get the user data</span>
<span class="hljs-keyword">const</span> <span class="hljs-title">UserPromise</span> = <span class="hljs-keyword">new</span> <span class="hljs-title">Promise</span>(<span class="hljs-function">(</span><span class="hljs-params">resolve</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">jwtVerify</span>(accessToken, <span class="hljs-function">(</span><span class="hljs-params">user: any</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">resolve</span>(user)))
<span class="hljs-comment">// This will get the user data or false (if the user is not connected)</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title">UserPromise</span>
<span class="hljs-keyword">return</span> user
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> createToken = <span class="hljs-keyword">async</span> (<span class="hljs-attr">user</span>: <span class="hljs-title">IUser</span>): <span class="hljs-title">Promise</span>&lt;string[]&gt; =&gt; {
<span class="hljs-comment">// Extracting the user data</span>
<span class="hljs-keyword">const</span> { id, username, password, email, role, active } = user
<span class="hljs-comment">// Encrypting our password by combining the secretKey and the password</span>
<span class="hljs-comment">// and converting it to base64</span>
<span class="hljs-keyword">const</span> token = <span class="hljs-title">setBase64</span>(<span class="hljs-string">`</span><span class="hljs-subst">${encrypt($security.secretKey)}${password}</span><span class="hljs-string">`</span>)
<span class="hljs-comment">// The "token" is an alias for password in this case</span>
<span class="hljs-keyword">const</span> userData = {
id,
username,
email,
role,
active,
token
}
<span class="hljs-comment">// We sign our JWT token and we save the data as Base64</span>
<span class="hljs-keyword">const</span> _createToken = jwt.<span class="hljs-title">sign</span>({ <span class="hljs-attr">data</span>: <span class="hljs-title">setBase64</span>(userData) }, $security.<span class="hljs-property">secretKey</span>, {
<span class="hljs-attr">expiresIn</span>: $security.<span class="hljs-property">expiresIn</span>
})
<span class="hljs-keyword">return</span> <span class="hljs-title">Promise</span>.<span class="hljs-title">all</span>([_createToken])
}
</code></pre>
<p class="normal">As you can <a id="_idIndexMarker579"/>see, <code class="inlineCode">jwt.sign</code> is used to<a id="_idIndexMarker580"/> create a new JWT, while <code class="inlineCode">jwt.verify</code> is used to validate our JWT.</p>
<h2 class="heading-2" id="_idParaDest-222">Creating authentication functions</h2>
<p class="normal">Now that we’ve <a id="_idIndexMarker581"/>created the JWT functions, we need to create some functions that will help us log in at <code class="inlineCode">/backend/src/lib/auth.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { encrypt, isPasswordMatch } <span class="hljs-keyword">from</span> <span class="hljs-string">'@contentpi/lib'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">IToken</span>, <span class="hljs-title">IModels</span>, <span class="hljs-title">IUser</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../types'</span>
<span class="hljs-keyword">import</span> { createToken } <span class="hljs-keyword">from</span> <span class="hljs-string">'./jwt'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getUserBy = <span class="hljs-keyword">async</span> (<span class="hljs-attr">where</span>: any, <span class="hljs-attr">models</span>: <span class="hljs-title">IModels</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">IUser</span>&gt; =&gt; {
</code></pre>
<p class="normal">We find a user by a <code class="inlineCode">WHERE</code> condition:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> models.<span class="hljs-property">User</span>.<span class="hljs-title">findOne</span>({
where,
<span class="hljs-attr">raw</span>: <span class="hljs-literal">true</span>
})
<span class="hljs-keyword">return</span> user
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> doLogin = <span class="hljs-keyword">async</span> (
<span class="hljs-attr">email</span>: string,
<span class="hljs-attr">password</span>: string,
<span class="hljs-attr">models</span>: <span class="hljs-title">IModels</span>
): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">IToken</span>&gt; =&gt; {
</code></pre>
<p class="normal">Finding a user by email:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title">getUserBy</span>({ email }, models)
</code></pre>
<p class="normal">If the user does not exist, we return <code class="inlineCode">Invalid Login</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">if</span> (!user) {
<span class="hljs-keyword">  throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title">Error</span>(<span class="hljs-string">'Invalid Login'</span>)
}
</code></pre>
<p class="normal">We verify that our encrypted password is the same as the <code class="inlineCode">user.password</code> value:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">const</span> passwordMatch = <span class="hljs-title">isPasswordMatch</span>(<span class="hljs-title">encrypt</span>(password), user.<span class="hljs-property">password</span>)
</code></pre>
<p class="normal">We validate that the user is active:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">const</span> isActive = user.<span class="hljs-property">active</span>
</code></pre>
<p class="normal">If the password does not match, we return <code class="inlineCode">Invalid Login</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">if</span> (!passwordMatch) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title">Error</span>(<span class="hljs-string">'Invalid Login'</span>)
}
</code></pre>
<p class="normal">If the account is not active, we return an error:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">if</span> (!isActive) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title">Error</span>(<span class="hljs-string">'Your account is not activated yet'</span>)
}
</code></pre>
<p class="normal">If the user exists, the password is correct and the account is active, then we create the JWT:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">const</span> [token] = <span class="hljs-keyword">await</span> <span class="hljs-title">createToken</span>(user)
<span class="hljs-comment">// Finally we return the token to Graphql</span>
<span class="hljs-keyword">return</span> {
  token
}
}
</code></pre>
<p class="normal">Here, we<a id="_idIndexMarker582"/> validate whether the user exists by email, whether the password is correct, and whether the account is active in order to create the JWT.</p>
<h2 class="heading-2" id="_idParaDest-223">Defining types and interfaces</h2>
<p class="normal">Finally, we need<a id="_idIndexMarker583"/> to define our types and interfaces for all our Sequelize models and GraphQL inputs. For this, you need to create a file at <code class="inlineCode">/backend/src/types/types.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">export</span> type <span class="hljs-title">User</span> = {
<span class="hljs-attr">  username</span>: string
  <span class="hljs-attr">password</span>: string
  <span class="hljs-attr">email</span>: string
  <span class="hljs-attr">role</span>: string
  <span class="hljs-attr">active</span>: boolean
}
<span class="hljs-keyword">export</span> type <span class="hljs-title">Sequelize</span> = {
  _defaults?: any
  name?: string
  options?: any
  associate?: any
}
</code></pre>
<p class="normal">Now, let’s create our interfaces at <code class="inlineCode">/backend/src/types/interfaces.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">Sequelize</span>, <span class="hljs-title">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./types'</span>
<span class="hljs-keyword">export</span> interface <span class="hljs-title">IDataTypes</span> {
<span class="hljs-attr">UUID</span>: string
<span class="hljs-title">UUIDV4</span>(): string
<span class="hljs-attr">STRING</span>: string
<span class="hljs-attr">BOOLEAN</span>: boolean
<span class="hljs-attr">TEXT</span>: string
<span class="hljs-attr">INTEGER</span>: number
<span class="hljs-attr">DATE</span>: string
<span class="hljs-attr">FLOAT</span>: number
}
<span class="hljs-keyword">export</span> interface <span class="hljs-title">IUser</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">User</span>, <span class="hljs-title">Sequelize</span> {
<span class="hljs-attr">id</span>: string
token?: string
createdAt?: <span class="hljs-title">Date</span>
updatedAt?: <span class="hljs-title">Date</span>
}
<span class="hljs-keyword">export</span> interface <span class="hljs-title">ICreateUserInput</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">User</span> {}
<span class="hljs-keyword">export</span> interface <span class="hljs-title">ILoginInput</span> {
<span class="hljs-attr">email</span>: string
<span class="hljs-attr">password</span>: string
}
<span class="hljs-keyword">export</span> interface <span class="hljs-title">IToken</span> {
<span class="hljs-attr">token</span>: string
}
<span class="hljs-keyword">export</span> interface <span class="hljs-title">IModels</span> {
<span class="hljs-title">User</span>: any
<span class="hljs-attr">sequelize</span>: any
}
</code></pre>
<p class="normal">Finally, we <a id="_idIndexMarker584"/>need to export both files in <code class="inlineCode">/backend/src/types/index.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./interfaces'</span>
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./types'</span>
</code></pre>
<p class="normal">When you need to add more models, remember to always add your types and interfaces to those files.</p>
<p class="normal">Finally, you <a id="_idIndexMarker585"/>need to create your <code class="inlineCode">tsconfig.json</code> file in the <code class="inlineCode">root</code> directory:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./src"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"esModuleInterop"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"commonjs"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"noImplicitAny"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"outDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"resolveJsonModule"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sourceMap"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"typeRoots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/@types"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"./node_modules/@types"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">},</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"</span><span class="hljs-string">src/**/*.ts"</span><span class="hljs-punctuation">],</span>
  <span class="hljs-attr">"exclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"node_modules"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">In the next section, we will run our project and create our tables.</p>
<h1 class="heading-1" id="_idParaDest-224">Running our project for the first time</h1>
<p class="normal">Next up, we’re <a id="_idIndexMarker586"/>going to start our project for the first time. If we’ve done everything right, we’ll see our <code class="inlineCode">Users</code> table being set up and our Apollo Server will start running.</p>
<p class="normal">In this part, we’ll cover how to start our project. After that, we’ll explore how to use our GraphQL API. We’ll learn about testing queries, which allow us to retrieve data, and mutations, which enable us to modify data. We’ll also discuss validations, which are checks to ensure the correctness of our data. Lastly, we’ll delve into the process of user login. Let’s get started!</p>
<p class="normal">If you followed the previous sections correctly and run the <code class="inlineCode">npm run dev</code> command, you should be able to see that the <code class="inlineCode">Users</code> table has been created and that Apollo Server is running on port <code class="inlineCode">4000</code>:</p>
<p class="packt_figref"><img alt="A picture containing background pattern  Description automatically generated" height="209" src="../Images/B18414_13_03.png" width="825"/></p>
<p class="packt_figref">Figure 13.3: Running our project for the first time</p>
<p class="normal">Now, let’s say that you <a id="_idIndexMarker587"/>want to modify your user model and change the <code class="inlineCode">"username"</code> field to <code class="inlineCode">"username2"</code>. Let’s see what will happen:</p>
<pre class="programlisting con"><code class="hljs-con">[INFO] 23:45:16 Restarting: /Users/czantany/projects/React-Design-Patterns-and-Best-Practices-Third-Edition/Chapter05/graphql/backend/src/models/User.ts has been modified
Executing (default): CREATE TABLE IF NOT EXISTS "Users" ("id" UUID NOT NULL , "username2" VARCHAR(255) NOT NULL UNIQUE, "password" VARCHAR(255) NOT NULL, "email" VARCHAR(255) NOT NULL UNIQUE, "privilege" VARCHAR(255) NOT NULL DEFAULT 'user', "active" BOOLEAN NOT NULL DEFAULT false, "createdAt" TIMESTAMP WITH TIME ZONE NOT NULL, "updatedAt" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id"));
Executing (default): ALTER TABLE "public"."Users" ADD COLUMN "username2" VARCHAR(255) NOT NULL UNIQUE;
Executing (default): ALTER TABLE "Users" ALTER COLUMN "password" SET NOT NULL;ALTER TABLE "Users" ALTER COLUMN "password" DROP DEFAULT;ALTER TABLE "Users" ALTER COLUMN "password" TYPE VARCHAR(255);
Executing (default): ALTER TABLE "Users" ALTER COLUMN "email" SET NOT NULL;ALTER TABLE "Users" ALTER COLUMN "email" DROP DEFAULT;ALTER TABLE "Users" ADD UNIQUE ("email");ALTER TABLE "Users" ALTER COLUMN "email" TYPE VARCHAR(255) ;
Executing (default): ALTER TABLE "Users" ALTER COLUMN "privilege" SET NOT NULL;ALTER TABLE "Users" ALTER COLUMN "privilege" SET DEFAULT 'user';ALTER TABLE "Users" ALTER COLUMN "privilege" TYPE VARCHAR(255);
Executing (default): ALTER TABLE "Users" ALTER COLUMN "active" SET NOT NULL;ALTER TABLE "Users" ALTER COLUMN "active" SET DEFAULT false;ALTER TABLE "Users" ALTER COLUMN "active" TYPE BOOLEAN;
Executing (default): ALTER TABLE "Users" ALTER COLUMN "createdAt" SET NOT NULL;ALTER TABLE "Users" ALTER COLUMN "createdAt" DROP DEFAULT;ALTER TABLE "Users" ALTER COLUMN "createdAt" TYPE TIMESTAMP WITH TIME ZONE;
Running on http://localhost:4000/graphql
</code></pre>
<p class="normal">This will execute the following SQL query:</p>
<pre class="programlisting code"><code class="hljs-code">Executing (<span class="hljs-keyword">default</span>): <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> "public"."Users" <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> "username2" <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">UNIQUE</span>;
Executing (<span class="hljs-keyword">default</span>): <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> "public"."Users" <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">COLUMN</span> "username";
</code></pre>
<p class="normal">Now, let’s suppose you changed the <code class="inlineCode">force</code> constant in your <code class="inlineCode">index.ts</code> file to <code class="inlineCode">true</code>. The following will happen:</p>
<p class="packt_figref"><img alt="Graphical user interface, text  Description automatically generated" height="147" src="../Images/B18414_13_04.png" width="825"/></p>
<p class="packt_figref">Figure 13.4: DROP TABLE IF EXISTS</p>
<p class="normal">As you can <a id="_idIndexMarker588"/>see, if <code class="inlineCode">force</code> is <code class="inlineCode">true</code>, it will execute <code class="inlineCode">DROP TABLE IF EXISTS "Users" CASCADE;</code>. This will completely remove your table and values and then recreate your table from scratch. That’s why you need to be careful when you use the <code class="inlineCode">force</code> option.</p>
<p class="normal">At this point, if you open <a href="http://localhost:4000/graphql"><span class="url">http://localhost:4000/graphql</span></a>, you should be able to see your new GraphQL Explorer:</p>
<p class="packt_figref"><img alt="" height="690" src="../Images/B18414_13_05.png" width="825"/></p>
<p class="packt_figref">Figure 13.5: GraphQL Explorer</p>
<p class="normal">Click on <a id="_idIndexMarker589"/>the <strong class="keyWord">Query your server</strong> button and then we are ready to test our queries and mutations.</p>
<h2 class="heading-2" id="_idParaDest-225">Testing GraphQL queries and mutations</h2>
<p class="normal">Great! At this point, you’re <a id="_idIndexMarker590"/>very close to<a id="_idIndexMarker591"/> executing your first GraphQL query and mutation. The first query we will execute is going to be <code class="inlineCode">getUsers</code>. The following is the correct syntax to run a query:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">query</span> {
<span class="hljs-keyword">getUsers</span> {
<span class="hljs-built_in">id</span>
username
email
role
}
}
</code></pre>
<p class="normal">When you don’t have any attribute to pass to the query, you just need to specify the name of the query under the <code class="inlineCode">query {...}</code> block and then specify the fields you want to retrieve once you’ve executed your query. In this case, we want to fetch the <code class="inlineCode">id</code>, <code class="inlineCode">username</code>, <code class="inlineCode">email</code>, and <code class="inlineCode">role</code> fields.</p>
<p class="normal">If you run this query, you will probably get an empty array of data. This is because we don’t have any users registered yet:</p>
<p class="packt_figref"><img alt="" height="307" src="../Images/B18414_13_06.png" width="825"/></p>
<p class="packt_figref">Figure 13.6: getUsers query</p>
<p class="normal">This means we <a id="_idIndexMarker592"/>need to execute our <code class="inlineCode">createUser mutation</code> in order <a id="_idIndexMarker593"/>to register our first user. One thing I like about GraphQL Explorer is that you have all the schema documentation in the <strong class="screenText">Schema</strong> icon on the left-hand side. If you click on the <strong class="screenText">Schema</strong> icon, you will see all your queries and mutations listed. </p>
<p class="normal">Let’s click there and select our <code class="inlineCode">createUser mutation</code> to see what needs to be called and what data may be returned:</p>
<p class="packt_figref"><img alt="Graphical user interface, application, Teams  Description automatically generated" height="497" src="../Images/B18414_13_07.png" width="826"/></p>
<p class="packt_figref">Figure 13.7: Schema</p>
<p class="normal">As you <a id="_idIndexMarker594"/>can<a id="_idIndexMarker595"/> see, the <code class="inlineCode">createUser mutation</code> needs an <code class="inlineCode">input</code> argument, which is <code class="inlineCode">CreateUserInput</code>. Let’s click on that input:</p>
<p class="packt_figref"><img alt="Graphical user interface, application, Teams  Description automatically generated" height="525" src="../Images/B18414_13_08.png" width="825"/></p>
<p class="packt_figref">Figure 13.8: CreateUserInput</p>
<p class="normal">Awesome! Now, we<a id="_idIndexMarker596"/> know that we need<a id="_idIndexMarker597"/> to pass the <strong class="keyWord">username</strong>, <strong class="keyWord">password</strong>, <strong class="keyWord">email</strong>, <strong class="keyWord">role</strong>, and <strong class="keyWord">active</strong> fields in order to create a new user. Let’s do this!</p>
<p class="normal">Create a new tab so that you don’t lose the code of your first query and then write the mutation:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-title">mutation</span><span class="hljs-params">(</span><span class="hljs-variable">$input</span><span class="hljs-params">: CreateUserInput)</span> {
  <span class="hljs-title">createUser</span><span class="hljs-params">(input: </span><span class="hljs-variable">$input</span><span class="hljs-params">)</span> {
    id
    username
    email
    role
    active
  }
}
</code></pre>
<p class="normal">As you can see, your mutation needs to be written under the <code class="inlineCode">mutation {...}</code> block, and you must pass the <code class="inlineCode">input</code> argument as an object in the <strong class="keyWord">Variables</strong> section. Finally, you must specify the fields you want to retrieve once the mutation has been executed correctly. If everything is OK, you should see something like this:</p>
<p class="packt_figref"><img alt="Graphical user interface, text, application  Description automatically generated" height="469" src="../Images/B18414_13_09.png" width="825"/></p>
<p class="packt_figref">Figure 13.9: CreateUser mutation</p>
<p class="normal">If you’re<a id="_idIndexMarker598"/> curious<a id="_idIndexMarker599"/> and wish to take a look at the terminal where you run your Apollo Server, you will see the SQL query that was performed for this user:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> "Users" ("id","username","password","email","role","active","createdAt","updatedAt") <span class="hljs-keyword">VALUES</span> ($<span class="hljs-number">1</span>,$<span class="hljs-number">2</span>,$<span class="hljs-number">3</span>,$<span class="hljs-number">4</span>,$<span class="hljs-number">5</span>,$<span class="hljs-number">6</span>,$<span class="hljs-number">7</span>,$<span class="hljs-number">8</span>) 
</code></pre>
<p class="normal">The <code class="inlineCode">VALUES</code> variables are handled by Apollo Server, so you won’t see the actual values in there, but you can find out which operation is being executed in the database.</p>
<p class="normal">Now, go back to your first query (<code class="inlineCode">getUsers</code>) and run it again!</p>
<p class="packt_figref"><img alt="Graphical user interface, text, application  Description automatically generated" height="319" src="../Images/B18414_13_10.png" width="825"/></p>
<p class="packt_figref">Figure 13.10: getUsers query</p>
<p class="normal">Nice: this is your <a id="_idIndexMarker600"/>first query and mutation <a id="_idIndexMarker601"/>that have been executed correctly in GraphQL. If you want to see this data in your database, you can use OmniDB or PgAdmin4 to view your <code class="inlineCode">Users</code> table in your PostgreSQL database:</p>
<p class="packt_figref"><img alt="Graphical user interface, text, application  Description automatically generated" height="332" src="../Images/B18414_13_11.png" width="825"/></p>
<p class="packt_figref">Figure 13.11: Database query</p>
<p class="normal">As you can <a id="_idIndexMarker602"/>see, our first record has its own <code class="inlineCode">id</code> field (UUID) and <a id="_idIndexMarker603"/>also has an encrypted password field (remember our <code class="inlineCode">beforeCreate</code> Hook in the user model?). By default, Sequelize will create the <code class="inlineCode">createdAt</code> and <code class="inlineCode">updatedAt</code> fields.</p>
<h2 class="heading-2" id="_idParaDest-226">Testing model validations and querying users</h2>
<p class="normal">As you may<a id="_idIndexMarker604"/> recall, regarding <a id="_idIndexMarker605"/>our<a id="_idIndexMarker606"/> user <a id="_idIndexMarker607"/>model, you will want to make sure all the validations we did work fine, such as whether the user is unique or whether their email is valid and unique. You just need to execute the exact same mutation again:</p>
<p class="packt_figref"><img alt="Text  Description automatically generated with medium confidence" height="816" src="../Images/B18414_13_12.png" width="591"/></p>
<p class="packt_figref">Figure 13.12: Username must be unique</p>
<p class="normal">As you<a id="_idIndexMarker608"/> can <a id="_idIndexMarker609"/>see, we<a id="_idIndexMarker610"/> will get a “<strong class="keyWord">username must be unique</strong>” error<a id="_idIndexMarker611"/> message because we’ve already registered the “admin” username. Now, let’s try to change the username to “<strong class="keyWord">admin2</strong>” but leave the email as is (<strong class="keyWord">admin@js.education</strong>):</p>
<p class="packt_figref"><img alt="Text  Description automatically generated with low confidence" height="786" src="../Images/B18414_13_13.png" width="567"/></p>
<p class="packt_figref">Figure 13.13: Email must be unique</p>
<p class="normal">We will<a id="_idIndexMarker612"/> also<a id="_idIndexMarker613"/> get<a id="_idIndexMarker614"/> an “<strong class="keyWord">email must be unique</strong>” error<a id="_idIndexMarker615"/> for the email. Now, try to change the email to something invalid, such as <strong class="keyWord">admin@myfakedomain</strong>:</p>
<p class="packt_figref"><img alt="A picture containing timeline  Description automatically generated" height="860" src="../Images/B18414_13_14.png" width="621"/></p>
<p class="packt_figref">Figure 13.14: Invalid email</p>
<p class="normal">Now, we’re<a id="_idIndexMarker616"/> getting <a id="_idIndexMarker617"/>an <code class="inlineCode">"Invalid email"</code> error<a id="_idIndexMarker618"/> message. This <a id="_idIndexMarker619"/>is just amazing, don’t you think? Now, let’s stop playing with the validations and add a new valid user (<strong class="keyWord">username</strong>: admin2 and <strong class="keyWord">email</strong>: admin2@js.education). Once you’ve created your second user, run our <strong class="keyWord">getUsers</strong> query once more. However, this time, add the <code class="inlineCode">active</code> field to the list of fields we want to return:</p>
<p class="packt_figref"><img alt="A screenshot of a computer  Description automatically generated with medium confidence" height="418" src="../Images/B18414_13_15.png" width="821"/></p>
<p class="packt_figref">Figure 13.15: getUsers query</p>
<p class="normal">Now, we have<a id="_idIndexMarker620"/> two <a id="_idIndexMarker621"/>registered<a id="_idIndexMarker622"/> users, and<a id="_idIndexMarker623"/> both are inactive accounts (<code class="inlineCode">"active" = false</code>).</p>
<p class="normal">One thing I love about GraphQL is that when you’re writing your queries or mutations and you don’t remember a certain field, GraphQL will always show you the list of available fields for that query or mutation. For example, if you just write the letter <code class="inlineCode">p</code> for the password, you will see something like this:</p>
<p class="packt_figref"><img alt="A screenshot of a computer  Description automatically generated with medium confidence" height="307" src="../Images/B18414_13_16.png" width="480"/></p>
<p class="packt_figref">Figure 13.16: Autocomplete</p>
<p class="normal">Now, we <a id="_idIndexMarker624"/>are <a id="_idIndexMarker625"/>ready <a id="_idIndexMarker626"/>to<a id="_idIndexMarker627"/> try and log in!</p>
<h2 class="heading-2" id="_idParaDest-227">Performing a login</h2>
<p class="normal">I want to congratulate <a id="_idIndexMarker628"/>you for getting to this point in this book: I know we have covered a lot, but we are almost there! Now, we are going to try and log in with GraphQL (how crazy is that?).</p>
<p class="normal">First, we need to write our login mutation:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-title">mutation</span><span class="hljs-params">(</span><span class="hljs-variable">$input</span><span class="hljs-params">: LoginInput)</span> {
  <span class="hljs-title">login</span><span class="hljs-params">(input: </span><span class="hljs-variable">$input</span><span class="hljs-params">)</span> {
    token
  }
}
</code></pre>
<p class="normal">Then, we need to log our user in by using “<code class="inlineCode">fake@email.com</code>" as our email and “<code class="inlineCode">123456</code>" as our password. These do not exist in our database:</p>
<p class="packt_figref"><img alt="Graphical user interface, text  Description automatically generated" height="428" src="../Images/B18414_13_17.png" width="825"/></p>
<p class="packt_figref">Figure 13.17: Invalid login after using non-existent login details</p>
<p class="normal">Because the email does not exist in our database, an <code class="inlineCode">Invalid Login</code> error message will be<a id="_idIndexMarker629"/> returned. Now, let’s add the correct email but use a fake password:</p>
<p class="packt_figref"><img alt="Text  Description automatically generated" height="463" src="../Images/B18414_13_18.png" width="825"/></p>
<p class="packt_figref">Figure 13.18: Invalid login after inputting the correct email but a fake password</p>
<p class="normal">As you can see, we receive the exact same error (<code class="inlineCode">Invalid Login</code>). This is because we don’t want to provide too much information about what’s wrong with the login, as someone may be trying to hack into your system. If we say something such as <code class="inlineCode">Invalid password</code> or <code class="inlineCode">Your email does not exist in our system</code>, we give the attackers extra information that they may find useful.</p>
<p class="normal">Now, let’s try to <a id="_idIndexMarker630"/>connect with the correct user and password (<code class="inlineCode">admin@js.education</code> and <code class="inlineCode">123456</code>) and see what happens:</p>
<p class="packt_figref"><img alt="Text  Description automatically generated" height="510" src="../Images/B18414_13_19.png" width="825"/></p>
<p class="packt_figref">Figure 13.19: Your account is not activated yet</p>
<p class="normal">Now, we receive an error stating<strong class="keyWord"> </strong><code class="inlineCode">Your account is not activated yet</code>. This is OK because our user has not been activated yet. Normally, when a user is registered in a system, you need to send a link to their email so that they can activate their account. We don’t have this feature at the moment, but let’s suppose we sent that email, and the user has already activated their account. We can simulate this by manually changing the value in our database using OnmiDB or PgAdmin4. </p>
<p class="normal">We can do this by performing an <code class="inlineCode">UPDATE</code> SQL query:</p>
<p class="packt_figref"><img alt="Graphical user interface, text, application, email  Description automatically generated" height="421" src="../Images/B18414_13_20.png" width="825"/></p>
<p class="packt_figref">Figure 13.20: UPDATE SQL query</p>
<p class="normal">Now, let’s try<a id="_idIndexMarker631"/> to log in again!</p>
<p class="packt_figref"><img alt="Text  Description automatically generated" height="279" src="../Images/B18414_13_21.png" width="825"/></p>
<p class="packt_figref">Figure 13.21: Login token</p>
<p class="normal">Nice: we are in, baby! This is you at this point:</p>
<p class="packt_figref"><img alt="" height="290" src="../Images/B18414_13_22.png" width="382"/></p>
<p class="packt_figref">Figure 13.22: Anonymous</p>
<p class="normal">Now that we’ve <a id="_idIndexMarker632"/>logged in and retrieved our JWT, let’s copy that huge string and use it in our <strong class="keyWord">getUser</strong> query to see whether we can get the user’s data:</p>
<p class="packt_figref"><img alt="" height="584" src="../Images/B18414_13_23.png" width="504"/></p>
<p class="packt_figref">Figure 13.23: Access token </p>
<p class="normal">If everything <a id="_idIndexMarker633"/>went well, then you should get the user’s data:</p>
<p class="packt_figref"><img alt="Graphical user interface, text, application  Description automatically generated" height="304" src="../Images/B18414_13_24.png" width="513"/></p>
<p class="packt_figref">Figure 13.24: getUser data</p>
<p class="normal">If you change or remove any letter from the string (meaning the token is invalid), then you should get empty user data:</p>
<p class="packt_figref"><img alt="Text  Description automatically generated" height="315" src="../Images/B18414_13_25.png" width="240"/></p>
<p class="packt_figref">Figure 13.25: Empty getUser data</p>
<p class="normal">Now that our<a id="_idIndexMarker634"/> login system works perfectly in the backend, it is time to implement this in the frontend application. We’ll do this in the next section.</p>
<h1 class="heading-1" id="_idParaDest-228">Building a frontend login system with Apollo Client</h1>
<p class="normal">In the previous <a id="_idIndexMarker635"/>section, we learned how to build the backend for a login system using Apollo Server to create our GraphQL queries and mutations. You are probably thinking, <em class="italic">Great, I have the backend working, but how can I use this on the frontend?</em> And you’re right: I always like to explain things with full examples and not just show basic things, even if this will take longer to do. So let’s get started!</p>
<p class="normal">You can find the code for the example in this section at <a href="https://github.com/PacktPublishing/React-18-Design-Patterns-and-Best-Practices-Fourth-Edition/tree/main/Chapter13/graphql/frontend"><span class="url">https://github.com/PacktPublishing/React-18-Design-Patterns-and-Best-Practices-Fourth-Edition/tree/main/Chapter13/graphql/frontend</span></a>. </p>
<h2 class="heading-2" id="_idParaDest-229">Configuring Webpack 5</h2>
<p class="normal">Instead of <a id="_idIndexMarker636"/>using a <strong class="keyWord">vite</strong> project, we <a id="_idIndexMarker637"/>will configure a React <a id="_idIndexMarker638"/>project from scratch using Webpack 5 and Node.js.</p>
<p class="normal">The first thing we need to do is create the frontend directory and install all the packages inside. To do this, we will execute the following commands:</p>
<pre class="programlisting con"><code class="hljs-con">npm init --yes
npm install @apollo/client@3.7.0 @contentpi/lib@1.0.10 cookie-parser@1.4.6 cors@2.8.5 dotenv-webpack@8.0.1 express@4.18.2 jsonwebtoken@8.5.1 pm2@5.2.2 react@18.2.0 react-dom@18.2.0 react-cookie@4.1.1 react-router-dom@6.4.2 run-script-webpack-plugin@0.1.1 styled-components@5.3.6 typescript-plugin-styled-components@2.0.0 webpack-node-externals@3.0.0
npm install --save-dev @babel/core@7.19.3 @babel/preset-env@7.19.4 @babel/preset-react@7.18.6 @types/node@18.11.3 buffer@6.0.3 cross-env@7.0.3 crypto-browserify@3.12.0 dotenv@16.0.3 html-webpack-plugin@5.5.0 npm-run-all@4.1.5 prettier@2.7.1 stream-browserify@3.0.0 ts-loader@9.4.1 ts-node@10.9.1 ts-node-dev@2.0.0 typescript@4.8.4 webpack@5.74.0 webpack-cli@4.10.0 webpack-dev-server@4.11.1 webpackbar@5.0.2
</code></pre>
<p class="normal">The <code class="inlineCode">buffer</code>, <code class="inlineCode">crypto-browserify</code>, and <code class="inlineCode">stream-browserify</code> are polyfills that were included by default in Webpack up to and including version 4. However, in the latest version (Webpack 5), these are not included anymore, so you will get the following error:</p>
<p class="packt_figref"><img alt="Text  Description automatically generated" height="143" src="../Images/B18414_13_26.png" width="825"/></p>
<p class="packt_figref">Figure 13.26: Webpack &lt; 5 used to include polyfills for Node.js core modules by default</p>
<p class="normal">You need to have those scripts in your <code class="inlineCode">package.json</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm-run-all clean build:production:*"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"build:production:client"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack --env mode=production --env presets=client"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"build:production:server"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"</span><span class="hljs-string">webpack --env mode=production --env presets=server"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"clean"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rm -rf dist"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cross-env DEBUG=server:* npm-run-all clean serve:dev"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"analyze"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cross-env ANALYZE=true cross-env DEBUG=server:* npm-run-all clean serve:*"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pm2 start apps.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"stop"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pm2 stop apps.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"restart"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pm2 restart apps.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"serve:dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cross-env NODE_ENV=development ts-node ./src/server/devServer.ts"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"webpack"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cross-env NODE_ENV=production webpack"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint . --ext .js,.tsx,.ts"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"lint:fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"</span><span class="hljs-string">eslint . --fix --ext .js,.tsx,.ts"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"jest src"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"test:coverage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"jest src --coverage"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">I like to split my Webpack configuration into separate files to identify more easily what is for the<a id="_idIndexMarker639"/> client, for<a id="_idIndexMarker640"/> the server, for development, and for production. First let’s create our <code class="inlineCode">presets</code> directory under <code class="inlineCode">/frontend/webpack/presets</code>, and then create our <code class="inlineCode">webpack.client.ts</code> to specify our client configuration:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> <span class="hljs-title">HtmlWebpackPlugin</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'html-webpack-plugin'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Configuration</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">BundleAnalyzerPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack-bundle-analyzer'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">WebpackBar</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'webpackbar'</span>
<span class="hljs-keyword">const</span> isAnalyze = <span class="hljs-title">Boolean</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">ANALYZE</span>) <span class="hljs-comment">// This is to analyze the bundles sizes</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">webpackClientConfig</span>: <span class="hljs-function">(</span><span class="hljs-params">args: { mode: string }</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">Configuration</span> = <span class="hljs-function">(</span><span class="hljs-params">{ mode }</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-keyword">const</span> isProductionMode = mode === <span class="hljs-string">'production'</span>
<span class="hljs-keyword">const</span> title = <span class="hljs-string">'My Website Title'</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">webpackConfig</span>: <span class="hljs-title">Configuration</span> = {
<span class="hljs-attr">entry</span>: {
<span class="hljs-attr">main</span>: <span class="hljs-string">'./src/client/index.tsx'</span> <span class="hljs-comment">// Entry for the client app</span>
},
<span class="hljs-attr">output</span>: {
<span class="hljs-attr">publicPath</span>: <span class="hljs-string">'http://localhost:3001/'</span> <span class="hljs-comment">// This is for webpack-dev-server</span>
},
<span class="hljs-attr">plugins</span>: [
<span class="hljs-keyword">new</span> <span class="hljs-title">HtmlWebpackPlugin</span>({
title,
<span class="hljs-attr">template</span>: <span class="hljs-string">'./src/client/index.xhtml'</span>,
<span class="hljs-attr">filename</span>: <span class="hljs-string">'./index.xhtml'</span>
}),
<span class="hljs-keyword">new</span> <span class="hljs-title">WebpackBar</span>({
<span class="hljs-attr">name</span>: <span class="hljs-string">'client'</span>,
<span class="hljs-attr">color</span>: <span class="hljs-string">'#2EA1F8'</span>
})
]
}
<span class="hljs-keyword">if</span> (isProductionMode) {
webpackConfig.<span class="hljs-property">output</span> = {
<span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].js'</span>,
<span class="hljs-attr">chunkFilename</span>: <span class="hljs-string">'[name].js'</span>,
<span class="hljs-attr">publicPath</span>: <span class="hljs-string">'/'</span>
}
}
<span class="hljs-keyword">if</span> (isAnalyze) {
webpackConfig.<span class="hljs-property">plugins</span> = [
...(webpackConfig.<span class="hljs-property">plugins</span> || []),
<span class="hljs-keyword">new</span> <span class="hljs-title">BundleAnalyzerPlugin</span>({
<span class="hljs-attr">analyzerPort</span>: <span class="hljs-number">9001</span>
})
]
}
<span class="hljs-keyword">return</span> webpackConfig
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> webpackClientConfig
</code></pre>
<p class="normal">That is our <a id="_idIndexMarker641"/>client<a id="_idIndexMarker642"/> preset; now let’s create the server preset under <code class="inlineCode">/frontend/webpack/presets/webpack.server.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { resolve } <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">RunScriptWebpackPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'run-script-webpack-plugin'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Configuration</span>, <span class="hljs-title">IgnorePlugin</span>, optimize } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">BundleAnalyzerPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack-bundle-analyzer'</span>
<span class="hljs-keyword">import</span> nodeExternals <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack-node-externals'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">WebpackBar</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'webpackbar'</span>
<span class="hljs-keyword">const</span> isAnalyze = <span class="hljs-title">Boolean</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">ANALYZE</span>)
<span class="hljs-keyword">const</span> <span class="hljs-attr">webpackServerConfig</span>: <span class="hljs-function">(</span><span class="hljs-params">args: { mode: string }</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">Configuration</span> = <span class="hljs-function">(</span><span class="hljs-params">{ mode }</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-keyword">const</span> isDevelopment = mode === <span class="hljs-string">'development'</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">webpackConfig</span>: <span class="hljs-title">Configuration</span> = {
<span class="hljs-attr">target</span>: <span class="hljs-string">'node'</span>, <span class="hljs-comment">// Target node is only for server</span>
<span class="hljs-attr">entry</span>: <span class="hljs-string">'</span><span class="hljs-string">./src/server/index.ts'</span>, <span class="hljs-comment">// Entry for the server app</span>
<span class="hljs-attr">output</span>: {
<span class="hljs-attr">libraryTarget</span>: <span class="hljs-string">'commonjs2'</span>,
<span class="hljs-attr">filename</span>: <span class="hljs-string">'server.js'</span>,
<span class="hljs-attr">path</span>: <span class="hljs-title">resolve</span>(<span class="hljs-string">'dist'</span>)
},
<span class="hljs-attr">externals</span>: [<span class="hljs-title">nodeExternals</span>()], <span class="hljs-comment">// Ignoring all node_modules</span>
<span class="hljs-attr">plugins</span>: [
<span class="hljs-keyword">new</span> optimize.<span class="hljs-title">LimitChunkCountPlugin</span>({
<span class="hljs-attr">maxChunks</span>: <span class="hljs-number">1</span>
}),
<span class="hljs-keyword">new</span> <span class="hljs-title">IgnorePlugin</span>({
<span class="hljs-attr">resourceRegExp</span>: <span class="hljs-regexp">/\.((sc|c)ss|jpe?g|png|gif|svg)$/i</span>
}),
<span class="hljs-keyword">new</span> <span class="hljs-title">WebpackBar</span>({
<span class="hljs-attr">name</span>: <span class="hljs-string">'server'</span>,
<span class="hljs-attr">color</span>: <span class="hljs-string">'#2EA1F8'</span>,
<span class="hljs-attr">profile</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">basic</span>: <span class="hljs-literal">false</span>
})
]
}
<span class="hljs-keyword">if</span> (isDevelopment) {
webpackConfig.<span class="hljs-property">watch</span> = <span class="hljs-literal">true</span>
<span class="hljs-keyword">if</span> (webpackConfig.<span class="hljs-property">entry</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title">Array</span>) {
webpackConfig.<span class="hljs-property">entry</span>.<span class="hljs-title">unshift</span>(<span class="hljs-string">'webpack/hot/poll?300'</span>) <span class="hljs-comment">// This is for HMR</span>
}
<span class="hljs-keyword">if</span> (webpackConfig.<span class="hljs-property">plugins</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title">Array</span>) {
webpackConfig.<span class="hljs-property">plugins</span>.<span class="hljs-title">push</span>(
<span class="hljs-keyword">new</span> <span class="hljs-title">RunScriptWebpackPlugin</span>({
<span class="hljs-attr">name</span>: <span class="hljs-string">'server.js'</span>,
<span class="hljs-attr">nodeArgs</span>: [<span class="hljs-string">'--inspect'</span>]
})
)
}
webpackConfig.<span class="hljs-property">externals</span> = [
<span class="hljs-title">nodeExternals</span>({
<span class="hljs-attr">allowlist</span>: [<span class="hljs-string">'webpack/hot/poll?300'</span>]
})
]
}
<span class="hljs-keyword">if</span> (isAnalyze) {
webpackConfig.<span class="hljs-property">plugins</span> = [
...(webpackConfig.<span class="hljs-property">plugins</span> || []),
<span class="hljs-keyword">new</span> <span class="hljs-title">BundleAnalyzerPlugin</span>({
<span class="hljs-attr">analyzerPort</span>: <span class="hljs-number">9002</span>
})
]
}
<span class="hljs-keyword">return</span> webpackConfig
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> webpackServerConfig
</code></pre>
<p class="normal">After you’ve created the presets, you need to create the <code class="inlineCode">loadPresets.ts</code> file that will handle those presets. This file must exist under <code class="inlineCode">/frontend/webpack/loadPresets.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">Configuration</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>
<span class="hljs-keyword">import</span> { merge } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack-merge'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">ConfigArgs</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./webpack.types'</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">loadPresets</span>: <span class="hljs-function">(</span><span class="hljs-params">mode: ConfigArgs</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">Configuration</span>&gt; = <span class="hljs-keyword">async</span> (env) =&gt; {
<span class="hljs-keyword">const</span> <span class="hljs-attr">presets</span>: string[] = ([] <span class="hljs-keyword">as</span> string[]).<span class="hljs-title">concat</span>(...[env.<span class="hljs-property">presets</span>])
<span class="hljs-keyword">const</span> webpackConfigs = <span class="hljs-keyword">await</span> <span class="hljs-title">Promise</span>.<span class="hljs-title">all</span>(
presets.<span class="hljs-title">map</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">presetName</span>: string) =&gt; {
<span class="hljs-keyword">try</span> {
<span class="hljs-comment">// Dynamically loading the presets</span>
<span class="hljs-keyword">const</span> {<span class="hljs-attr">default</span>: webpackConfig} = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">`./presets/webpack.</span><span class="hljs-subst">${presetName}</span><span class="hljs-string">`</span>)
<span class="hljs-keyword">return</span> <span class="hljs-title">Promise</span>.<span class="hljs-title">resolve</span>(<span class="hljs-title">webpackConfig</span>(env))
} <span class="hljs-keyword">catch</span> (err) {
<span class="hljs-keyword">return</span> <span class="hljs-title">Promise</span>.<span class="hljs-title">resolve</span>({})
}
})
)
<span class="hljs-keyword">return</span> <span class="hljs-title">merge</span>({}, ...webpackConfigs)
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> loadPresets
</code></pre>
<p class="normal">Besides the<a id="_idIndexMarker643"/> client<a id="_idIndexMarker644"/> and server presets, we need to create some other configuration files: one for development, another for production, and a file that will contain a common configuration between both. First let’s create the common configuration at <code class="inlineCode">/frontend/webpack/webpack.common.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> <span class="hljs-title">Dotenv</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'dotenv-webpack'</span>
<span class="hljs-keyword">import</span> { resolve } <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
<span class="hljs-keyword">import</span> createStyledComponentsTransformer <span class="hljs-keyword">from</span> <span class="hljs-string">'typescript-plugin-styled-components'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">Configuration</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>
<span class="hljs-keyword">const</span> styledComponentsTransformer = <span class="hljs-title">createStyledComponentsTransformer</span>()
<span class="hljs-keyword">const</span> <span class="hljs-attr">webpackCommonConfig</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title">Configuration</span> = <span class="hljs-function">() =&gt;</span> {
<span class="hljs-keyword">const</span> <span class="hljs-attr">webpackConfig</span>: <span class="hljs-title">Configuration</span> = {
<span class="hljs-attr">output</span>: {
<span class="hljs-attr">path</span>: <span class="hljs-title">resolve</span>(<span class="hljs-string">'</span><span class="hljs-string">dist'</span>) <span class="hljs-comment">// Output by default will be dist directory</span>
},
<span class="hljs-attr">resolve</span>: {
<span class="hljs-attr">extensions</span>: [<span class="hljs-string">'.ts'</span>, <span class="hljs-string">'.tsx'</span>, <span class="hljs-string">'.js'</span>, <span class="hljs-string">'.jsx'</span>, <span class="hljs-string">'.json'</span>],
<span class="hljs-attr">alias</span>: {
<span class="hljs-string">'~'</span>: <span class="hljs-title">resolve</span>(__dirname, <span class="hljs-string">'../src'</span>) <span class="hljs-comment">// Alias for src</span>
},
<span class="hljs-attr">fallback</span>: {
<span class="hljs-attr">crypto</span>: <span class="hljs-built_in">require</span>.<span class="hljs-title">resolve</span>(<span class="hljs-string">'crypto-browserify'</span>),
<span class="hljs-attr">buffer</span>: <span class="hljs-built_in">require</span>.<span class="hljs-title">resolve</span>(<span class="hljs-string">'buffer/'</span>),
<span class="hljs-attr">stream</span>: <span class="hljs-built_in">require</span>.<span class="hljs-title">resolve</span>(<span class="hljs-string">'stream-browserify'</span>)
}
},
<span class="hljs-attr">optimization</span>: { <span class="hljs-comment">// This is to split the bundle in main.js (app) and vendor.js (node_modules)</span>
<span class="hljs-attr">splitChunks</span>: {
<span class="hljs-attr">cacheGroups</span>: {
<span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>,
<span class="hljs-attr">commons</span>: {
<span class="hljs-attr">test</span>: <span class="hljs-regexp">/node_modules/</span>,
<span class="hljs-attr">name</span>: <span class="hljs-string">'vendor'</span>,
<span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>
}
}
}
},
<span class="hljs-attr">module</span>: {
<span class="hljs-attr">rules</span>: [
{
<span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(woff|woff2)$/</span>, <span class="hljs-comment">// For loading fonts</span>
<span class="hljs-attr">use</span>: {
<span class="hljs-attr">loader</span>: <span class="hljs-string">'url-loader'</span>
}
},
{
<span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(ts|tsx)$/</span>, <span class="hljs-comment">// For loading TypeScript files</span>
<span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules/</span>,
<span class="hljs-attr">use</span>: [
{
<span class="hljs-attr">loader</span>: <span class="hljs-string">'ts-loader'</span>,
<span class="hljs-attr">options</span>: {
<span class="hljs-attr">transpileOnly</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">getCustomTransformers</span>: <span class="hljs-function">() =&gt;</span> ({
<span class="hljs-attr">before</span>: [styledComponentsTransformer]
})
}
}
]
}
]
},
<span class="hljs-attr">plugins</span>: [<span class="hljs-keyword">new</span> <span class="hljs-title">Dotenv</span>()] <span class="hljs-comment">// This will load our .env variables into Webpack</span>
}
<span class="hljs-keyword">return</span> webpackConfig
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> webpackCommonConfig
</code></pre>
<p class="normal">Then we need to create the development configuration at <code class="inlineCode">/frontend/webpack/webpack.development.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">Configuration</span>, <span class="hljs-title">HotModuleReplacementPlugin</span>, <span class="hljs-title">NoEmitOnErrorsPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">webpackDevConfig</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title">Configuration</span> = <span class="hljs-function">() =&gt;</span> {
<span class="hljs-keyword">const</span> <span class="hljs-attr">webpackConfig</span>: <span class="hljs-title">Configuration</span> = {
<span class="hljs-attr">mode</span>: <span class="hljs-string">'development'</span>,
<span class="hljs-attr">devtool</span>: <span class="hljs-string">'source-map'</span>,
<span class="hljs-attr">output</span>: {
<span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].js'</span>
},
<span class="hljs-attr">plugins</span>: [<span class="hljs-keyword">new</span> <span class="hljs-title">HotModuleReplacementPlugin</span>(), <span class="hljs-keyword">new</span> <span class="hljs-title">NoEmitOnErrorsPlugin</span>()]
}
<span class="hljs-keyword">return</span> webpackConfig
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> webpackDevConfig
</code></pre>
<p class="normal">As you can see<a id="_idIndexMarker645"/> in development, we<a id="_idIndexMarker646"/> include the <code class="inlineCode">HotModuleReplacementPlugin</code> for the <strong class="keyWord">HMR</strong> to reload the site every time we make a change. After this, you need to create the production configuration file at <code class="inlineCode">/frontend/webpack/webpack.production.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">Configuration</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">webpackProdConfig</span>: <span class="hljs-function">(</span><span class="hljs-params">args: { presets: string[] }</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">Configuration</span> = <span class="hljs-function">() =&gt;</span> {
<span class="hljs-keyword">const</span> <span class="hljs-attr">webpackConfig</span>: <span class="hljs-title">Configuration</span> = {
<span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span> <span class="hljs-comment">// By default this mode minifies all code</span>
}
<span class="hljs-keyword">return</span> webpackConfig
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> webpackProdConfig
</code></pre>
<p class="normal">Finally, we have to create our Webpack types file at <code class="inlineCode">/frontend/webpack/webpack.types.ts</code>. These are the TypeScript types we will use for Webpack:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">export</span> type <span class="hljs-title">WebpackMode</span> = <span class="hljs-string">'production'</span> | <span class="hljs-string">'development'</span>
<span class="hljs-keyword">export</span> type <span class="hljs-title">ConfigArgs</span> = {
<span class="hljs-attr">mode</span>: <span class="hljs-title">WebpackMode</span>
<span class="hljs-attr">presets</span>: string[]
}
</code></pre>
<p class="normal">At this point, you need to create the <code class="inlineCode">index.xhtml</code> file, which should be at <code class="inlineCode">/frontend/src/client/index.xhtml</code>. This will be our initial HTML file handled by <code class="inlineCode">HtmlWebpackPlugin</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta">&lt;!DOCTYPE </span><span class="hljs-keyword">html</span><span class="hljs-meta">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">html</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">head</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">meta</span><span class="hljs-tag"> </span><span class="hljs-attr">charset</span><span class="hljs-tag">=</span><span class="hljs-string">"UTF-8"</span><span class="hljs-tag"> /&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">title</span><span class="hljs-tag">&gt;</span>&lt;%= htmlWebpackPlugin.options.title %&gt;<span class="hljs-tag">&lt;/</span><span class="hljs-name">title</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">head</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">body</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">id</span><span class="hljs-tag">=</span><span class="hljs-string">"root"</span><span class="hljs-tag">&gt;&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">body</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">html</span><span class="hljs-tag">&gt;</span>
</code></pre>
<p class="normal">In the<a id="_idIndexMarker647"/> next<a id="_idIndexMarker648"/> section, we will configure our TypeScript.</p>
<h2 class="heading-2" id="_idParaDest-230">Configuring our TypeScript</h2>
<p class="normal">TypeScript is<a id="_idIndexMarker649"/> a special <a id="_idIndexMarker650"/>version of JavaScript, the language typically used to write web apps. What makes TypeScript interesting is its ability to identify mistakes in our code earlier, potentially saving us significant time. This feature becomes particularly valuable when working on large-scale projects. Therefore, we will utilize TypeScript for our project. Let’s now delve into the process of setting it up.</p>
<p class="normal">Our <code class="inlineCode">tsconfig.json</code> file should look like this:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sourceMap"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lib"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"dom"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dom.iterable"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"esnext"</span><span class="hljs-punctuation">],</span>
    <span class="hljs-attr">"allowJs"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"skipLibCheck"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"esModuleInterop"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"allowSyntheticDefaultImports"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"forceConsistentCasingInFileNames"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"noFallthroughCasesInSwitch"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"commonjs"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"resolveJsonModule"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"isolatedModules"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"noEmit"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"jsx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"react-jsx"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"noImplicitAny"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"~/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/*"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">},</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src"</span><span class="hljs-punctuation">],</span>
  <span class="hljs-attr">"exclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"node_modules"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"**/*.test.tsx"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p class="normal">Now, let’s <a id="_idIndexMarker651"/>learn how<a id="_idIndexMarker652"/> to configure the Express server.</p>
<h2 class="heading-2" id="_idParaDest-231">Configuring the Express server</h2>
<p class="normal">Our application<a id="_idIndexMarker653"/> requires<a id="_idIndexMarker654"/> a Express server so that we can perform validations. These will help us find out whether the user is connected (using a custom middleware, which I’ll explain later) and can also configure our Express sessions. We have four main routes on our site:</p>
<ul>
<li class="bulletList"><code class="inlineCode">/</code>: Our home page (handled by React).</li>
<li class="bulletList"><code class="inlineCode">/dashboard</code>: Our dashboard, which is protected. Only connected users with god or admin permissions are allowed (handled by Express first then by React).</li>
<li class="bulletList"><code class="inlineCode">/login</code>: Our login page (handled by React).</li>
<li class="bulletList"><code class="inlineCode">/logout</code>: This will delete our existing session (handled by Express).</li>
</ul>
<p class="normal">Let’s look at our server code. The following file should exist at <code class="inlineCode">/frontend/src/server.ts</code>. This is in order to create our Express app and run our React app:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> cookieParser <span class="hljs-keyword">from</span> <span class="hljs-string">'cookie-parser'</span>
<span class="hljs-keyword">import</span> cors <span class="hljs-keyword">from</span> <span class="hljs-string">'</span><span class="hljs-string">cors'</span>
<span class="hljs-keyword">import</span> express, { <span class="hljs-title">Application</span>, <span class="hljs-title">Request</span>, <span class="hljs-title">Response</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>
<span class="hljs-keyword">import</span> { resolve } <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> config <span class="hljs-keyword">from</span> <span class="hljs-string">'../config'</span>
<span class="hljs-keyword">import</span> html <span class="hljs-keyword">from</span> <span class="hljs-string">'./html'</span>
<span class="hljs-keyword">import</span> { isConnected } <span class="hljs-keyword">from</span> <span class="hljs-string">'./lib/middlewares/user'</span>
<span class="hljs-comment">// Express application</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">app</span>: <span class="hljs-title">Application</span> = <span class="hljs-title">express</span>()
<span class="hljs-keyword">const</span> distDir = <span class="hljs-title">resolve</span>(<span class="hljs-string">'dist'</span>)
<span class="hljs-keyword">const</span> staticDir = <span class="hljs-title">resolve</span>(<span class="hljs-string">'</span><span class="hljs-string">src'</span>, <span class="hljs-string">'static'</span>)
<span class="hljs-comment">// Middlewares</span>
app.<span class="hljs-title">use</span>(express.<span class="hljs-title">json</span>())
app.<span class="hljs-title">use</span>(express.<span class="hljs-title">urlencoded</span>({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }))
app.<span class="hljs-title">use</span>(<span class="hljs-title">cookieParser</span>(config.<span class="hljs-property">security</span>.<span class="hljs-property">secretKey</span>))
app.<span class="hljs-title">use</span>(<span class="hljs-title">cors</span>({ <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">origin</span>: <span class="hljs-literal">true</span> }))
<span class="hljs-comment">// Static directories</span>
app.<span class="hljs-title">use</span>(express.<span class="hljs-title">static</span>(distDir))
app.<span class="hljs-title">use</span>(express.<span class="hljs-title">static</span>(staticDir))
<span class="hljs-comment">// Routes</span>
app.<span class="hljs-title">get</span>(<span class="hljs-string">'/login'</span>, <span class="hljs-title">isConnected</span>(<span class="hljs-literal">false</span>), <span class="hljs-function">(</span><span class="hljs-params">req: Request, res: Response</span><span class="hljs-function">) =&gt;</span> {
res.<span class="hljs-title">send</span>(<span class="hljs-title">html</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'My Website'</span> }))
})
app.<span class="hljs-title">get</span>(<span class="hljs-string">`/logout`</span>, <span class="hljs-function">(</span><span class="hljs-params">req: Request, res: Response</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-keyword">const</span> <span class="hljs-attr">redirect</span>: any = req.<span class="hljs-property">query</span>.<span class="hljs-property">redirectTo</span> || <span class="hljs-string">'/'</span>
res.<span class="hljs-title">clearCookie</span>(<span class="hljs-string">'at'</span>)
res.<span class="hljs-title">redirect</span>(redirect)
})
app.<span class="hljs-title">get</span>(<span class="hljs-string">'*'</span>, <span class="hljs-function">(</span><span class="hljs-params">req: Request, res: Response</span><span class="hljs-function">) =&gt;</span> {
res.<span class="hljs-title">send</span>(<span class="hljs-title">html</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'My Website'</span> }))
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> app
</code></pre>
<p class="normal">As you can see, we<a id="_idIndexMarker655"/> protect <a id="_idIndexMarker656"/>our dashboard route with the <code class="inlineCode">isConnected</code> middleware. Here, we validate that we only accept users that are not connected in the login route.</p>
<h2 class="heading-2" id="_idParaDest-232">Creating our frontend configuration</h2>
<p class="normal">Now, we need to <a id="_idIndexMarker657"/>create <a id="_idIndexMarker658"/>our frontend configuration. So, let’s create the configuration at <code class="inlineCode">/frontend/src/config.ts</code>. This file will assist us to manage our GraphQL port and server, as well as incorporate security configurations such as our secret key and the expiration options:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Types</span>
type <span class="hljs-variable">API</span> = {
<span class="hljs-attr">uri</span>: string
}
type <span class="hljs-title">Security</span> = {
<span class="hljs-attr">secretKey</span>: string
<span class="hljs-attr">expiresIn</span>: string
}
<span class="hljs-comment">// Environment Configuration</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">isProduction</span>: boolean = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">isDevelopment</span>: boolean = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">'production'</span>
<span class="hljs-comment">// Server Configuration</span>
<span class="hljs-keyword">const</span> devUrl = <span class="hljs-string">'localhost'</span>
<span class="hljs-keyword">const</span> prodUrl = <span class="hljs-string">'localhost'</span> <span class="hljs-comment">// change this to your production url</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">PORT</span>: number = <span class="hljs-title">Number</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span>) || <span class="hljs-number">3000</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">DEV_SERVER_PORT</span> = <span class="hljs-number">3001</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">GRAPHQL_PORT</span> = <span class="hljs-number">4000</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">GRAPHQL_SERVER</span> = isDevelopment ? devUrl : prodUrl
<span class="hljs-comment">// Paths Configuration</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">domain</span>: string = devUrl
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">baseUrl</span>: string = isProduction
? <span class="hljs-string">`https://</span><span class="hljs-subst">${domain}</span><span class="hljs-string">:</span><span class="hljs-subst">${PORT}</span><span class="hljs-string">`</span>
: <span class="hljs-string">`http://</span><span class="hljs-subst">${domain}</span><span class="hljs-string">:</span><span class="hljs-subst">${PORT}</span><span class="hljs-string">`</span> <span class="hljs-comment">// Remove port in actual production</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">publicPath</span>: string = isProduction 
? <span class="hljs-string">``</span> 
: <span class="hljs-string">`http://</span><span class="hljs-subst">${domain}</span><span class="hljs-string">:</span><span class="hljs-subst">${DEV_SERVER_PORT}</span><span class="hljs-string">/`</span>
<span class="hljs-comment">// API Configuration</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">api</span>: <span class="hljs-variable">API</span> = {
<span class="hljs-attr">uri</span>: <span class="hljs-string">`http://</span><span class="hljs-subst">${GRAPHQL_SERVER}</span><span class="hljs-string">:</span><span class="hljs-subst">${GRAPHQL_PORT}</span><span class="hljs-string">/graphql`</span>
}
<span class="hljs-comment">// Security Configuration</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">security</span>: <span class="hljs-title">Security</span> = {
<span class="hljs-attr">secretKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">SECURITY_SECRET_KEY</span> || <span class="hljs-string">''</span>,
<span class="hljs-attr">expiresIn</span>: <span class="hljs-string">'7d'</span>
}
</code></pre>
<p class="normal">Next, we need <a id="_idIndexMarker659"/>to<a id="_idIndexMarker660"/> create a user-called middleware and the <strong class="keyWord">jwt</strong> functions to validate whether the user is connected and has the correct privileges.</p>
<h2 class="heading-2" id="_idParaDest-233">Creating the user middleware</h2>
<p class="normal">In web development, a <a id="_idIndexMarker661"/>middleware<a id="_idIndexMarker662"/> is a function that has access to the request object (<strong class="keyWord">req</strong>), the response object (<strong class="keyWord">res</strong>), and the next function in the application’s request-response cycle. The next function is a function in the Express router that, when invoked, executes the middleware succeeding the current middleware. This creates a chain of functions, each of which can perform a specific task or modify the request and response objects as needed. By utilizing middleware, you can streamline your code and simplify complex processes. </p>
<p class="normal">The following diagram provides a visual representation of the middleware flow:</p>
<p class="packt_figref"><img alt="Bubble chart  Description automatically generated" height="250" src="../Images/B18414_13_27.png" width="817"/></p>
<p class="packt_figref">Figure 13.27: Visual representation of the middleware flow</p>
<p class="normal">In our case, we will create the <strong class="keyWord">isConnected</strong> middleware to validate if a user is connected and has the correct privileges. If not, we will break the flow and redirect them to the login page. If the user is valid, we will execute the next piece of middleware, which will render our React application. The following diagram describes this process:</p>
<p class="packt_figref"><img alt="A picture containing diagram  Description automatically generated" height="324" src="../Images/B18414_13_28.png" width="825"/></p>
<p class="packt_figref">Figure 13.28: Auth middleware </p>
<p class="normal">Let’s apply the <a id="_idIndexMarker663"/>theoretical <a id="_idIndexMarker664"/>part to our code. The required file should exist at <code class="inlineCode">/frontend/src/server/lib/middlewares/user.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">NextFunction</span>, <span class="hljs-title">Request</span>, <span class="hljs-title">Response</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>
<span class="hljs-keyword">import</span> { getUserData } <span class="hljs-keyword">from</span> <span class="hljs-string">'../jwt'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title">isConnected</span> = (<span class="hljs-params">isLogged = </span><span class="hljs-literal">true</span><span class="hljs-params">, roles = [</span><span class="hljs-string">'user'</span><span class="hljs-params">], redirectTo = </span><span class="hljs-string">'/'</span>) =&gt;
<span class="hljs-keyword">async</span> (<span class="hljs-attr">req</span>: <span class="hljs-title">Request</span>, <span class="hljs-attr">res</span>: <span class="hljs-title">Response</span>, <span class="hljs-attr">next</span>: <span class="hljs-title">NextFunction</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; =&gt; {
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title">getUserData</span>(req.<span class="hljs-property">cookies</span>.<span class="hljs-property">at</span>)
<span class="hljs-keyword">if</span> (!user &amp;&amp; !isLogged) {
<span class="hljs-keyword">return</span> <span class="hljs-title">next</span>()
}
<span class="hljs-keyword">if</span> (user &amp;&amp; isLogged) {
<span class="hljs-keyword">if</span> (roles.<span class="hljs-title">includes</span>(<span class="hljs-string">'god'</span>) &amp;&amp; roles.<span class="hljs-property">role</span> === <span class="hljs-string">'god'</span>) {
<span class="hljs-keyword">return</span> <span class="hljs-title">next</span>()
}
<span class="hljs-keyword">if</span> (roles.<span class="hljs-title">includes</span>(<span class="hljs-string">'admin'</span>) &amp;&amp; user.<span class="hljs-property">role</span> === <span class="hljs-string">'admin'</span>) {
<span class="hljs-keyword">return</span> <span class="hljs-title">next</span>()
}
<span class="hljs-keyword">if</span> (roles.<span class="hljs-title">includes</span>(<span class="hljs-string">'user'</span>) &amp;&amp; user.<span class="hljs-property">role</span> === <span class="hljs-string">'user'</span>) {
<span class="hljs-keyword">return</span> <span class="hljs-title">next</span>()
}
res.<span class="hljs-title">redirect</span>(redirectTo)
} <span class="hljs-keyword">else</span> {
res.<span class="hljs-title">redirect</span>(redirectTo)
}
}
</code></pre>
<p class="normal">Basically, with this middleware, we can control whether we want to validate whether the user is connected (<code class="inlineCode">isLogged = true</code>). Then, we can validate specific roles (<code class="inlineCode">roles = ['god', 'admin']</code>) and redirect the user if they are not connected or do not have the correct roles (<code class="inlineCode">redirectTo = '/'</code>).</p>
<p class="normal">As you can<a id="_idIndexMarker665"/> see, we are <a id="_idIndexMarker666"/>using the <code class="inlineCode">getUserData</code> function from <code class="inlineCode">jwt</code>. We’ll create our <code class="inlineCode">jwt</code> functions in the next section.</p>
<h2 class="heading-2" id="_idParaDest-234">Creating JWT functions</h2>
<p class="normal">Earlier, when I explained <a id="_idIndexMarker667"/>the<a id="_idIndexMarker668"/> backend code, I talked about JWTs. In the frontend, we need those functions to validate our token and get the user’s data. Let’s create a file containing the following code at <code class="inlineCode">/frontend/src/server/lib/jwt.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { getBase64 } <span class="hljs-keyword">from</span> <span class="hljs-string">'@contentpi/lib'</span>
<span class="hljs-keyword">import</span> jwt <span class="hljs-keyword">from</span> <span class="hljs-string">'jsonwebtoken'</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> config <span class="hljs-keyword">from</span> <span class="hljs-string">'~/config'</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">security</span>: { secretKey } } = config
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title">jwtVerify</span>(<span class="hljs-params">accessToken: string, cb: any</span>) {
jwt.<span class="hljs-title">verify</span>(accessToken, secretKey, <span class="hljs-function">(</span><span class="hljs-params">error: any, accessTokenData: any = {}</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: user } = accessTokenData
<span class="hljs-keyword">if</span> (error || !user) {
<span class="hljs-keyword">return</span> <span class="hljs-title">cb</span>(<span class="hljs-literal">null</span>)
}
<span class="hljs-keyword">const</span> userData = <span class="hljs-title">getBase64</span>(user)
<span class="hljs-keyword">return</span> <span class="hljs-title">cb</span>(userData)
})
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title">getUserData</span>(<span class="hljs-params">accessToken: string</span>): <span class="hljs-title">Promise</span>&lt;any&gt; {
<span class="hljs-keyword">const</span> <span class="hljs-title">UserPromise</span> = <span class="hljs-keyword">new</span> <span class="hljs-title">Promise</span>(
<span class="hljs-function">(</span><span class="hljs-params">resolve</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">jwtVerify</span>(accessToken, <span class="hljs-function">(</span><span class="hljs-params">user: any</span><span class="hljs-function">) =&gt;</span> <span class="hljs-title">resolve</span>(user))
)
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title">UserPromise</span>
<span class="hljs-keyword">return</span> user
}
</code></pre>
<p class="normal">As you can see, our <code class="inlineCode">getUserData</code> function will retrieve the user data using <code class="inlineCode">accessToken</code>, which we grabbed from the cookies. </p>
<p class="normal">A JWT must be valid for security reasons and to ensure that the user’s identity is verified. The server verifies this token whenever a user makes a request. If the token is invalid, the server will not fulfill the user’s request. Additionally, the token helps protect user information, as it cannot be altered without the server’s knowledge. Moreover, these tokens have an expiration time, requiring users to log in again. This prevents unauthorized individuals from using a stolen token to impersonate <a id="_idIndexMarker669"/>the user. Hence, ensuring<a id="_idIndexMarker670"/> the validity of a JWT is of utmost importance.</p>
<h2 class="heading-2" id="_idParaDest-235">Creating our GraphQL queries and mutations</h2>
<p class="normal">We’ve already<a id="_idIndexMarker671"/> created<a id="_idIndexMarker672"/> the required queries and mutations in our backend project. At this point, however, we need to create some files that will execute them in our frontend project. For now, we just need to define our <code class="inlineCode">getUserData</code> query and our login mutation to perform the login in the frontend. </p>
<p class="normal">Let’s create our <code class="inlineCode">getUser</code> query at <code class="inlineCode">/frontend/src/client/graphql/user/getUser.query.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { gql } <span class="hljs-keyword">from</span> <span class="hljs-string">'@apollo/client'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> gql<span class="hljs-string">`</span>
<span class="hljs-string">query getUser($at: String!) {</span>
<span class="hljs-string">getUser(at: $at) {</span>
<span class="hljs-string">id</span>
<span class="hljs-string">email</span>
<span class="hljs-string">username</span>
<span class="hljs-string">role</span>
<span class="hljs-string">active</span>
<span class="hljs-string">}</span>
<span class="hljs-string">}</span>
<span class="hljs-string">`</span>
</code></pre>
<p class="normal">Our login mutation should be at <code class="inlineCode">/frontend/src/graphql/user/login.mutation.ts</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { gql } <span class="hljs-keyword">from</span> <span class="hljs-string">'@apollo/client'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> gql<span class="hljs-string">`</span>
<span class="hljs-string">mutation login($email: String!, $password: String!) {</span>
<span class="hljs-string">login(input: { email: $email, password: $password }) {</span>
<span class="hljs-string">token</span>
<span class="hljs-string">}</span>
<span class="hljs-string">}</span>
<span class="hljs-string">`</span>
</code></pre>
<p class="normal">Now that we<a id="_idIndexMarker673"/> have defined<a id="_idIndexMarker674"/> our query and mutation, let’s create the user context so that we can use them.</p>
<h2 class="heading-2" id="_idParaDest-236">Creating user context to handle login and connected user</h2>
<p class="normal">In our user <a id="_idIndexMarker675"/>context, we <a id="_idIndexMarker676"/>will have a login method that will execute our mutation and validate whether the email and password are correct. We will also export the user data.</p>
<p class="normal">Let’s create this context at <code class="inlineCode">/frontend/src/client/contexts/user.tsx</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { useMutation, useQuery } <span class="hljs-keyword">from</span> <span class="hljs-string">'@apollo/client'</span>
<span class="hljs-keyword">import</span> { getGraphQlError, redirectTo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@contentpi/lib'</span>
<span class="hljs-keyword">import</span> { createContext, <span class="hljs-variable">FC</span>, <span class="hljs-title">ReactElement</span>, useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { useCookies } <span class="hljs-keyword">from</span> <span class="hljs-string">'</span><span class="hljs-string">react-cookie'</span>
<span class="hljs-keyword">import</span> <span class="hljs-variable">GET_USER_QUERY</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../graphql/user/getUser.query'</span>
<span class="hljs-keyword">import</span> <span class="hljs-variable">LOGIN_MUTATION</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../graphql/user/login.mutation'</span>
<span class="hljs-comment">// Interfaces</span>
interface <span class="hljs-title">IUserContext</span> {
<span class="hljs-title">login</span>(<span class="hljs-attr">input</span>: any): any
<span class="hljs-attr">connectedUser</span>: any
}
interface <span class="hljs-title">IProps</span> {
page?: string
<span class="hljs-attr">children</span>: <span class="hljs-title">ReactElement</span>
}
<span class="hljs-comment">// Creating context</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title">UserContext</span> = createContext&lt;<span class="hljs-title">IUserContext</span>&gt;({
<span class="hljs-attr">login</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">null</span>,
<span class="hljs-attr">connectedUser</span>: <span class="hljs-literal">null</span>
})
<span class="hljs-keyword">const</span> <span class="hljs-title">UserProvider</span>: <span class="hljs-variable">FC</span>&lt;<span class="hljs-title">IProps</span>&gt; = <span class="hljs-function">(</span><span class="hljs-params">{ page = </span><span class="hljs-string">''</span><span class="hljs-params">, children }</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-keyword">const</span> [cookies, setCookie] = <span class="hljs-title">useCookies</span>()
<span class="hljs-keyword">const</span> [connectedUser, setConnectedUser] = <span class="hljs-title">useState</span>(<span class="hljs-literal">null</span>)
<span class="hljs-comment">// Mutations</span>
<span class="hljs-keyword">const</span> [loginMutation] = <span class="hljs-title">useMutation</span>(<span class="hljs-variable">LOGIN_MUTATION</span>)
<span class="hljs-comment">// Queries</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: dataUser } = <span class="hljs-title">useQuery</span>(<span class="hljs-variable">GET_USER_QUERY</span>, {
<span class="hljs-attr">variables</span>: {
<span class="hljs-attr">at</span>: cookies.<span class="hljs-property">at</span> || <span class="hljs-string">''</span>
}
})
<span class="hljs-comment">// Effects</span>
<span class="hljs-title">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
<span class="hljs-keyword">if</span> (dataUser) {
<span class="hljs-keyword">if</span> (!dataUser.<span class="hljs-property">getUser</span>.<span class="hljs-property">id</span> &amp;&amp; page !== <span class="hljs-string">'login'</span>) {
<span class="hljs-comment">// If the user session is invalid and is on a different page than login</span>
<span class="hljs-comment">// we redirect them to login</span>
<span class="hljs-title">redirectTo</span>(<span class="hljs-string">'/login?redirectTo=/dashboard'</span>)
} <span class="hljs-keyword">else</span> {
<span class="hljs-comment">// If we have the user data available we save it in our connectedUser state</span>
<span class="hljs-title">setConnectedUser</span>(dataUser.<span class="hljs-property">getUser</span>)
}
}
}, [dataUser, page])
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title">login</span>(<span class="hljs-params">input: { email: string; password: string }</span>): <span class="hljs-title">Promise</span>&lt;any&gt; {
<span class="hljs-keyword">try</span> {
<span class="hljs-comment">// Executing our loginMutation passing the email and password</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: dataLogin } = <span class="hljs-keyword">await</span> <span class="hljs-title">loginMutation</span>({
<span class="hljs-attr">variables</span>: {
<span class="hljs-attr">email</span>: input.<span class="hljs-property">email</span>,
<span class="hljs-attr">password</span>: input.<span class="hljs-property">password</span>
}
})
<span class="hljs-keyword">if</span> (dataLogin) {
<span class="hljs-comment">// If the login was success, we save the token in our "at" cookie</span>
<span class="hljs-title">setCookie</span>(<span class="hljs-string">'at'</span>, dataLogin.<span class="hljs-property">login</span>.<span class="hljs-property">token</span>, { <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span> })
<span class="hljs-keyword">return</span> dataLogin.<span class="hljs-property">login</span>.<span class="hljs-property">token</span>
}
} <span class="hljs-keyword">catch</span> (err) {
<span class="hljs-comment">// If there is an error we return it</span>
<span class="hljs-keyword">return</span> <span class="hljs-title">getGraphQlError</span>(err)
}
}
<span class="hljs-comment">// Exporting our context</span>
<span class="hljs-keyword">const</span> context = {
login,
connectedUser
}
<span class="hljs-keyword">return</span> <span class="hljs-tag">&lt;</span><span class="hljs-name">UserContext.Provider</span><span class="hljs-tag"> </span><span class="hljs-attr">value</span><span class="hljs-tag">=</span><span class="hljs-string">{context}</span><span class="hljs-tag">&gt;</span>{children}<span class="hljs-tag">&lt;/</span><span class="hljs-name">UserContext.Provider</span><span class="hljs-tag">&gt;</span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">UserProvider</span>
</code></pre>
<p class="normal">As you can see, we handle the login and have the <code class="inlineCode">connectedUser</code> data in our context. Here, we<a id="_idIndexMarker677"/> execute <code class="inlineCode">GET_USER_QUERY</code> all the time to verify <a id="_idIndexMarker678"/>whether the user is connected (validating against the database and not just with the cookies).</p>
<h2 class="heading-2" id="_idParaDest-237">Configuring Apollo Client</h2>
<p class="normal">So far, we have<a id="_idIndexMarker679"/> created<a id="_idIndexMarker680"/> a lot of code, but none of it is going to work if we don’t configure Apollo Client. To configure Apollo Client, we need to add it to our index file at <code class="inlineCode">/frontend/src/client/index.tsx</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">ApolloClient</span>, <span class="hljs-title">ApolloProvider</span>, <span class="hljs-title">InMemoryCache</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@apollo/client'</span>
<span class="hljs-keyword">import</span> { render } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> config <span class="hljs-keyword">from</span> <span class="hljs-string">'../config'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">AppRoutes</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./AppRoutes'</span>
<span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title">ApolloClient</span>({
<span class="hljs-attr">uri</span>: config.<span class="hljs-property">api</span>.<span class="hljs-property">uri</span>,
<span class="hljs-attr">cache</span>: <span class="hljs-keyword">new</span> <span class="hljs-title">InMemoryCache</span>()
})
<span class="hljs-title">render</span>(
<span class="hljs-tag">&lt;</span><span class="hljs-name">ApolloProvider</span><span class="hljs-tag"> </span><span class="hljs-attr">client</span><span class="hljs-tag">=</span><span class="hljs-string">{client}</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">AppRoutes</span><span class="hljs-tag"> /&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">ApolloProvider</span><span class="hljs-tag">&gt;</span>,
<span class="hljs-variable">document</span>.<span class="hljs-title">querySelector</span>(<span class="hljs-string">'#root'</span>)
)
</code></pre>
<p class="normal">Basically, we pass <code class="inlineCode">config.api.uri</code>, which is where GraphQL Playground is running (<a href="http://localhost:4000/graphql"><span class="url">http://localhost:4000/graphql</span></a>), and then wrap our <code class="inlineCode">AppRoutes</code> component with the <code class="inlineCode">ApolloProvider</code> component.</p>
<h2 class="heading-2" id="_idParaDest-238">Creating our app routes</h2>
<p class="normal">We will use <code class="inlineCode">react-router-dom</code> to <a id="_idIndexMarker681"/>create <a id="_idIndexMarker682"/>our application routes. Let’s create the required code at <code class="inlineCode">/frontend/src/client/AppRoutes.tsx</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">BrowserRouter</span> <span class="hljs-keyword">as</span> <span class="hljs-title">Router</span>, <span class="hljs-title">Route</span>, <span class="hljs-title">Routes</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">DashboardPage</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./pages/dashboard'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">Error404</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./pages/error404'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">HomePage</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'</span><span class="hljs-string">./pages/home'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">LoginPage</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./pages/login'</span>
<span class="hljs-keyword">const</span> <span class="hljs-title">AppRoutes</span> = () =&gt; (
<span class="hljs-tag">&lt;&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">Router</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">Routes</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">Route</span><span class="hljs-tag"> </span><span class="hljs-attr">path</span><span class="hljs-tag">=</span><span class="hljs-string">"/"</span><span class="hljs-tag"> </span><span class="hljs-attr">element</span><span class="hljs-tag">=</span><span class="hljs-string">{</span><span class="hljs-tag">&lt;</span><span class="hljs-attr">HomePage</span><span class="hljs-tag"> /&gt;</span>} /&gt;
<span class="hljs-tag">&lt;</span><span class="hljs-name">Route</span><span class="hljs-tag"> </span><span class="hljs-attr">path</span><span class="hljs-tag">=</span><span class="hljs-string">"/dashboard"</span><span class="hljs-tag"> </span><span class="hljs-attr">element</span><span class="hljs-tag">=</span><span class="hljs-string">{</span><span class="hljs-tag">&lt;</span><span class="hljs-attr">DashboardPage</span><span class="hljs-tag"> /&gt;</span>} /&gt;
<span class="hljs-tag">&lt;</span><span class="hljs-name">Route</span><span class="hljs-tag"> </span><span class="hljs-attr">path</span><span class="hljs-tag">=</span><span class="hljs-string">"/login"</span><span class="hljs-tag"> </span><span class="hljs-attr">element</span><span class="hljs-tag">=</span><span class="hljs-string">{</span><span class="hljs-tag">&lt;</span><span class="hljs-attr">LoginPage</span><span class="hljs-tag"> /&gt;</span>} /&gt;
<span class="hljs-tag">&lt;</span><span class="hljs-name">Route</span><span class="hljs-tag"> </span><span class="hljs-attr">element</span><span class="hljs-tag">=</span><span class="hljs-string">{</span><span class="hljs-tag">&lt;</span><span class="hljs-attr">Error404</span><span class="hljs-tag"> /&gt;</span>} /&gt;
<span class="hljs-tag">&lt;/</span><span class="hljs-name">Routes</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">Router</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/&gt;</span>
)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">AppRoutes</span>
</code></pre>
<p class="normal">As you can see, we are adding some pages to our routes, such as <code class="inlineCode">HomePage</code>, <code class="inlineCode">DashboardPage</code> (protected), and <code class="inlineCode">LoginPage</code>. If the user tries to access a different URL, then we will <a id="_idIndexMarker683"/>display an <code class="inlineCode">Error404</code> component. We’ll create these pages in the next section.</p>
<h2 class="heading-2" id="_idParaDest-239">Creating our pages</h2>
<p class="normal">The <code class="inlineCode">Home</code> page <a id="_idIndexMarker684"/>should be at <code class="inlineCode">/frontend/src/client/pages/home.tsx</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">const</span> <span class="hljs-title">Page</span> = () =&gt; (
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">className</span><span class="hljs-tag">=</span><span class="hljs-string">"home"</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">h1</span><span class="hljs-tag">&gt;</span>Home<span class="hljs-tag">&lt;/</span><span class="hljs-name">h1</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">ul</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">li</span><span class="hljs-tag">&gt;&lt;</span><span class="hljs-name">a</span><span class="hljs-tag"> </span><span class="hljs-attr">href</span><span class="hljs-tag">=</span><span class="hljs-string">"/dashboard"</span><span class="hljs-tag">&gt;</span>Go to Dashboard<span class="hljs-tag">&lt;/</span><span class="hljs-name">a</span><span class="hljs-tag">&gt;&lt;/</span><span class="hljs-name">li</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">ul</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">Page</span>
</code></pre>
<p class="normal">The <code class="inlineCode">Dashboard</code> page should be at <code class="inlineCode">/frontend/src/client/pages/dashboard.tsx</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> <span class="hljs-title">DashboardLayout</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/dashboard/DashboardLayout'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">UserProvider</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'</span><span class="hljs-string">../contexts/user'</span>
<span class="hljs-keyword">const</span> <span class="hljs-title">Page</span> = () =&gt; (
<span class="hljs-tag">&lt;</span><span class="hljs-name">UserProvider</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">DashboardLayout</span><span class="hljs-tag"> /&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">UserProvider</span><span class="hljs-tag">&gt;</span>
)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">Page</span> 
</code></pre>
<p class="normal">The <code class="inlineCode">Login</code> page should be at <code class="inlineCode">/frontend/src/client/pages/login.tsx</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { isBrowser } <span class="hljs-keyword">from</span> <span class="hljs-string">'@contentpi/lib'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable">FC</span>, <span class="hljs-title">ReactElement</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">LoginLayout</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/users/LoginLayout'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">UserProvider</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../contexts/user'</span>
interface <span class="hljs-title">IProps</span> {
currentUrl?: string
}
<span class="hljs-keyword">const</span> <span class="hljs-title">Page</span>: <span class="hljs-variable">FC</span>&lt;<span class="hljs-title">IProps</span>&gt; = <span class="hljs-function">(</span><span class="hljs-params">{</span>
<span class="hljs-params">currentUrl = isBrowser() ? </span><span class="hljs-variable">window</span><span class="hljs-params">.location.search.replace(</span><span class="hljs-string">'?redirectTo='</span><span class="hljs-params">, </span><span class="hljs-string">''</span><span class="hljs-params">) : </span><span class="hljs-string">''</span>
<span class="hljs-params">}</span><span class="hljs-function">) =&gt;</span> (
<span class="hljs-tag">&lt;</span><span class="hljs-name">UserProvider</span><span class="hljs-tag"> </span><span class="hljs-attr">page</span><span class="hljs-tag">=</span><span class="hljs-string">"login"</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">LoginLayout</span><span class="hljs-tag"> </span><span class="hljs-attr">currentUrl</span><span class="hljs-tag">=</span><span class="hljs-string">{currentUrl}</span><span class="hljs-tag"> /&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">UserProvider</span><span class="hljs-tag">&gt;</span>
)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">Page</span>
</code></pre>
<p class="normal">Finally, we need to create our Error404 page <code class="inlineCode">(/frontend/src/client/pages/error404.tsx</code>):</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">const</span> <span class="hljs-title">Page</span> = () =&gt; (
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">className</span><span class="hljs-tag">=</span><span class="hljs-string">"error404"</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">h1</span><span class="hljs-tag">&gt;</span>Error404<span class="hljs-tag">&lt;/</span><span class="hljs-name">h1</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">Page</span>
</code></pre>
<p class="normal">We are almost<a id="_idIndexMarker685"/> done. The last piece of this puzzle is to create the <code class="inlineCode">Login</code> and <code class="inlineCode">Dashboard</code> components. We’ll do that in the next section.</p>
<h2 class="heading-2" id="_idParaDest-240">Creating our login components</h2>
<p class="normal">I created some <a id="_idIndexMarker686"/>basic <a id="_idIndexMarker687"/>components for our login and our dashboard. Of course, their styles can be improved, but let’s see how they work and how our login system is going to look.</p>
<p class="normal">The first file you need to create is called <code class="inlineCode">LoginLayout.tsx</code> at <code class="inlineCode">/frontend/src/client/components/users/LoginLayout.tsx</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-variable">FC</span>, useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">UserContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../contexts/user'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">Login</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Login'</span>
<span class="hljs-comment">// Interfaces</span>
interface <span class="hljs-title">IProps</span> {
<span class="hljs-attr">currentUrl</span>: string
}
<span class="hljs-keyword">const</span> <span class="hljs-title">Layout</span>: <span class="hljs-variable">FC</span>&lt;<span class="hljs-title">IProps</span>&gt; = <span class="hljs-function">(</span><span class="hljs-params">{ currentUrl }</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-keyword">const</span> { login } = <span class="hljs-title">useContext</span>(<span class="hljs-title">UserContext</span>)
<span class="hljs-keyword">return</span> <span class="hljs-tag">&lt;</span><span class="hljs-name">Login</span><span class="hljs-tag"> </span><span class="hljs-attr">login</span><span class="hljs-tag">=</span><span class="hljs-string">{login}</span><span class="hljs-tag"> </span><span class="hljs-attr">currentUrl</span><span class="hljs-tag">=</span><span class="hljs-string">{currentUrl}</span><span class="hljs-tag"> /&gt;</span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">Layout</span>
</code></pre>
<p class="normal">The layout file is useful when we want to add a specific layout to our components. It is also useful to consume data from a context and pass the data or functions as props.</p>
<p class="normal">Our <code class="inlineCode">Login</code> <a id="_idIndexMarker688"/>component should look like this (<code class="inlineCode">/frontend/src/client/components/users/Login.tsx</code>):</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { redirectTo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@contentpi/lib'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">ChangeEvent</span>, <span class="hljs-variable">FC</span>, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'</span><span class="hljs-string">react'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">IUser</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../types'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">StyledLogin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Login.styled'</span>
interface <span class="hljs-title">IProps</span> {
<span class="hljs-title">login</span>(<span class="hljs-attr">input</span>: any): any
<span class="hljs-attr">currentUrl</span>: string
}
<span class="hljs-keyword">const</span> <span class="hljs-title">Login</span>: <span class="hljs-variable">FC</span>&lt;<span class="hljs-title">IProps</span>&gt; = <span class="hljs-function">(</span><span class="hljs-params">{ login, currentUrl }</span><span class="hljs-function">) =&gt;</span> {
<span class="hljs-keyword">const</span> [values, setValues] = <span class="hljs-title">useState</span>({
<span class="hljs-attr">email</span>: <span class="hljs-string">''</span>,
<span class="hljs-attr">password</span>: <span class="hljs-string">''</span>
})
<span class="hljs-keyword">const</span> [errorMessage, setErrorMessage] = <span class="hljs-title">useState</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> [invalidLogin, setInvalidLogin] = <span class="hljs-title">useState</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> onChange = (<span class="hljs-attr">e</span>: <span class="hljs-title">ChangeEvent</span>&lt;<span class="hljs-title">HTMLInputElement</span>&gt;): <span class="hljs-params">void</span><span class="hljs-function"> =&gt;</span> {
<span class="hljs-keyword">const</span> { <span class="hljs-attr">target</span>: { name, value } } = e
<span class="hljs-keyword">if</span> (name) {
<span class="hljs-title">setValues</span>(<span class="hljs-function">(</span><span class="hljs-params">prevValues: any</span><span class="hljs-function">) =&gt;</span> ({
...prevValues,
[name]: value
}))
}
}
<span class="hljs-keyword">const</span> handleSubmit = <span class="hljs-keyword">async</span> (<span class="hljs-attr">user</span>: <span class="hljs-title">IUser</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; =&gt; {
<span class="hljs-comment">// Here we execute the login mutation</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title">login</span>(user)
<span class="hljs-keyword">if</span> (response.<span class="hljs-property">error</span>) {
<span class="hljs-title">setInvalidLogin</span>(<span class="hljs-literal">true</span>)
<span class="hljs-title">setErrorMessage</span>(response.<span class="hljs-property">message</span>)
} <span class="hljs-keyword">else</span> {
<span class="hljs-title">redirectTo</span>(currentUrl || <span class="hljs-string">'/'</span>)
}
}
<span class="hljs-keyword">return</span> (
<span class="hljs-tag">&lt;&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">StyledLogin</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">className</span><span class="hljs-tag">=</span><span class="hljs-string">"wrapper"</span><span class="hljs-tag">&gt;</span>
{invalidLogin &amp;&amp; <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">className</span><span class="hljs-tag">=</span><span class="hljs-string">"alert"</span><span class="hljs-tag">&gt;</span>{errorMessage}<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>}
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">className</span><span class="hljs-tag">=</span><span class="hljs-string">"form"</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">p</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span>
<span class="hljs-attr">autoComplete</span><span class="hljs-tag">=</span><span class="hljs-string">"off"</span>
<span class="hljs-attr">type</span><span class="hljs-tag">=</span><span class="hljs-string">"email"</span>
<span class="hljs-attr">className</span><span class="hljs-tag">=</span><span class="hljs-string">"email"</span>
<span class="hljs-attr">name</span><span class="hljs-tag">=</span><span class="hljs-string">"email"</span>
<span class="hljs-attr">placeholder</span><span class="hljs-tag">=</span><span class="hljs-string">"Email"</span>
<span class="hljs-attr">onChange</span><span class="hljs-tag">=</span><span class="hljs-string">{onChange}</span>
<span class="hljs-attr">value</span><span class="hljs-tag">=</span><span class="hljs-string">{values.email}</span>
<span class="hljs-tag">/&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">p</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">p</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">input</span>
<span class="hljs-attr">autoComplete</span><span class="hljs-tag">=</span><span class="hljs-string">"off"</span>
<span class="hljs-attr">type</span><span class="hljs-tag">=</span><span class="hljs-string">"password"</span>
<span class="hljs-attr">className</span><span class="hljs-tag">=</span><span class="hljs-string">"password"</span>
<span class="hljs-attr">name</span><span class="hljs-tag">=</span><span class="hljs-string">"password"</span>
<span class="hljs-attr">placeholder</span><span class="hljs-tag">=</span><span class="hljs-string">"Password"</span>
<span class="hljs-attr">onChange</span><span class="hljs-tag">=</span><span class="hljs-string">{onChange}</span>
<span class="hljs-attr">value</span><span class="hljs-tag">=</span><span class="hljs-string">{values.password}</span>
<span class="hljs-tag">/&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">p</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">className</span><span class="hljs-tag">=</span><span class="hljs-string">"actions"</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">button</span><span class="hljs-tag"> </span><span class="hljs-attr">name</span><span class="hljs-tag">=</span><span class="hljs-string">"login"</span><span class="hljs-tag"> </span><span class="hljs-attr">onClick</span><span class="hljs-tag">=</span><span class="hljs-string">{()</span><span class="hljs-tag"> =&gt;</span> handleSubmit(values)}&gt;Login<span class="hljs-tag">&lt;/</span><span class="hljs-name">button</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">StyledLogin</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/&gt;</span>
)
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">Login</span>
</code></pre>
<p class="normal">We’ll create<a id="_idIndexMarker689"/> the <code class="inlineCode"><a id="_idIndexMarker690"/></code><code class="inlineCode">dashboard</code> components next.</p>
<h2 class="heading-2" id="_idParaDest-241">Creating our dashboard components</h2>
<p class="normal">When creating<a id="_idIndexMarker691"/> our <code class="inlineCode"><a id="_idIndexMarker692"/></code><code class="inlineCode">dashboard</code> components, the first one should be the <code class="inlineCode">DashboardLayout.tsx</code> file at <code class="inlineCode">/frontend/src/client/components/dashboard/DashboardLayout.tsx</code>:</p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-variable">FC</span>, useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">UserContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../contexts/user'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title">Dashboard</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Dashboard'</span>
<span class="hljs-keyword">const</span> <span class="hljs-title">Layout</span>: <span class="hljs-variable">FC</span> = <span class="hljs-function">() =&gt;</span> {
<span class="hljs-keyword">const</span> { connectedUser } = <span class="hljs-title">useContext</span>(<span class="hljs-title">UserContext</span>)
<span class="hljs-comment">// We only render the Dashboard if the user is connected</span>
<span class="hljs-keyword">if</span> (connectedUser) {
<span class="hljs-keyword">return</span> <span class="hljs-tag">&lt;</span><span class="hljs-name">Dashboard</span><span class="hljs-tag"> </span><span class="hljs-attr">connectedUser</span><span class="hljs-tag">=</span><span class="hljs-string">{connectedUser}</span><span class="hljs-tag"> /&gt;</span>
}
<span class="hljs-keyword">return</span> <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> /&gt;</span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">Layout</span>
</code></pre>
<p class="normal">This is how we protect our <code class="inlineCode">dashboard</code> page to allow only connected users. Now, let’s create our <code class="inlineCode">dashboard</code> component at <code class="inlineCode">/frontend/src/components/dashboard/Dashboard.tsx</code>:</p>
<pre class="programlisting code"><code class="hljs-code">interface <span class="hljs-title">IProps</span> {
<span class="hljs-attr">connectedUser</span>: any
}
<span class="hljs-keyword">const</span> <span class="hljs-title">Dashboard</span> = (<span class="hljs-params">{ connectedUser }</span>) =&gt; (
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">className</span><span class="hljs-tag">=</span><span class="hljs-string">"dashboard"</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">h1</span><span class="hljs-tag">&gt;</span>Welcome, {connectedUser.username}!<span class="hljs-tag">&lt;/</span><span class="hljs-name">h1</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">ul</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">li</span><span class="hljs-tag">&gt;&lt;</span><span class="hljs-name">a</span><span class="hljs-tag"> </span><span class="hljs-attr">href</span><span class="hljs-tag">=</span><span class="hljs-string">"</span><span class="hljs-string">/logout"</span><span class="hljs-tag">&gt;</span>Logout<span class="hljs-tag">&lt;/</span><span class="hljs-name">a</span><span class="hljs-tag">&gt;&lt;/</span><span class="hljs-name">li</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">ul</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">Dashboard</span>
</code></pre>
<p class="normal">And with that, we’re done! We’ll test the login system in the next section.</p>
<h2 class="heading-2" id="_idParaDest-242">Testing our login system</h2>
<p class="normal">If you followed the<a id="_idIndexMarker693"/> previous <a id="_idIndexMarker694"/>sections correctly, then you should be able to run the login system successfully. To do this, we need to open three terminals:</p>
<ul>
<li class="bulletList">In the first one, you need to run your backend project (<strong class="keyWord">npm run dev</strong>).</li>
<li class="bulletList">In the other, you need to run the Node.js server in the frontend project (<strong class="keyWord">npm run dev</strong>).</li>
</ul>
<p class="normal">The third terminal is that when you open <code class="inlineCode">http://localhost:3000</code><strong class="keyWord"> </strong>for the first time, you should be able to see the <code class="inlineCode">Home</code> page:</p>
<p class="packt_figref"><img alt="Graphical user interface, text, application, email  Description automatically generated" height="202" src="../Images/B18414_13_29.png" width="429"/></p>
<p class="packt_figref">Figure 13.29: Home page</p>
<p class="normal">Then, if you click on the <strong class="screenText">Go to Dashboard</strong> (<a href="http://localhost:3000/dashboard"><span class="url">http://localhost:3000/dashboard</span></a>) link, you will be redirected to <a href="http://localhost:3000/login?redirectTo=/dashboard"><span class="url">http://localhost:3000/login?redirectTo=/dashboard</span></a>, as shown in the following screenshot:</p>
<figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" height="354" src="../Images/B18414_13_30.png" width="825"/></figure>
<p class="packt_figref">Figure 13.30: Login page</p>
<p class="normal">This is our login<a id="_idIndexMarker695"/> form. If you<a id="_idIndexMarker696"/> try to log in with fake credentials, you should get an error:</p>
<p class="packt_figref"><img alt="Graphical user interface, application  Description automatically generated" height="307" src="../Images/B18414_13_31.png" width="396"/></p>
<p class="packt_figref">Figure 13.31: Invalid login</p>
<p class="normal">If you want to see the GraphQL request, you can do so on the <strong class="screenText">Headers</strong> tab:</p>
<p class="packt_figref"><img alt="Text  Description automatically generated" height="278" src="../Images/B18414_13_32.png" width="825"/></p>
<p class="packt_figref">Figure 13.32: GraphQL request</p>
<p class="normal">Here, you can <a id="_idIndexMarker697"/>see the <a id="_idIndexMarker698"/>query you execute and the variables you send (email and password). You can see the response on the <strong class="screenText">Preview</strong> tab:</p>
<p class="packt_figref"><img alt="Text  Description automatically generated" height="211" src="../Images/B18414_13_33.png" width="825"/></p>
<p class="packt_figref">Figure 13.33: Invalid login</p>
<p class="normal">As you can see, we get an <code class="inlineCode">"Invalid Login"</code> error message, and that’s why we render it in our <code class="inlineCode">login</code> component. </p>
<p class="normal">Now, let’s try to connect with the correct account (<strong class="keyWord">admin@js.education </strong>and<strong class="keyWord"> 123456</strong>). If your login is correct, then you should be redirected to the dashboard, where you will see the following page:</p>
<p class="packt_figref"><img alt="Graphical user interface, text, application, chat or text message  Description automatically generated" height="193" src="../Images/B18414_13_34.png" width="412"/></p>
<p class="packt_figref">Figure 13.34: Welcome, admin! page</p>
<p class="normal">Additionally, you<a id="_idIndexMarker699"/> can take a<a id="_idIndexMarker700"/> look at the query being executed to retrieve the user data (<strong class="keyWord">getUser</strong>):</p>
<p class="packt_figref"><img alt="A screenshot of a computer screen  Description automatically generated" height="118" src="../Images/B18414_13_35.png" width="825"/></p>
<p class="packt_figref">Figure 13.35: getUser data</p>
<p class="normal">Here, you will see that the payload is returned:</p>
<p class="packt_figref"><img alt="Text  Description automatically generated" height="197" src="../Images/B18414_13_36.png" width="825"/></p>
<p class="packt_figref">Figure 13.36: getUserData payload</p>
<p class="normal">We get the user information from the access token (<strong class="keyWord">at</strong>). If you refresh the page, you should remain connected to the page. This is because we saved a cookie containing our token:</p>
<p class="packt_figref"><img alt="Text  Description automatically generated" height="178" src="../Images/B18414_13_37.png" width="825"/></p>
<p class="packt_figref">Figure 13.37: Cookies </p>
<p class="normal">Now, let’s try<a id="_idIndexMarker701"/> to modify <a id="_idIndexMarker702"/>the cookie by changing any letter of the token. For example, let’s change the first two letters (<strong class="keyWord">ey</strong>) to <strong class="keyWord">XX</strong>:</p>
<p class="packt_figref"><img alt="Table  Description automatically generated" height="122" src="../Images/B18414_13_38.png" width="350"/></p>
<p class="packt_figref">Figure 13.38: Updating a cookie</p>
<p class="normal">Here, you will receive empty data for the user. This will invalidate the session and redirect you to the login page again:</p>
<p class="packt_figref"><img alt="Text  Description automatically generated" height="207" src="../Images/B18414_13_39.png" width="825"/></p>
<p class="packt_figref">Figure 13.39: Empty data </p>
<p class="normal">Now, you have learned how to implement GraphQL in a backend and how to consume queries and mutations in the frontend.</p>
<p class="normal">This login system is part of a course I’m doing on YouTube, where I’m teaching viewers how to<a id="_idIndexMarker703"/> develop <a id="_idIndexMarker704"/>a headless CMS from scratch, so if you’re eager to learn more, you can check out the course at <a href="https://www.youtube.com/watch?v=4n1AfD6aV4M"><span class="url">https://www.youtube.com/watch?v=4n1AfD6aV4M</span></a>.</p>
<h1 class="heading-1" id="_idParaDest-243">Summary</h1>
<p class="normal">I hope you found this chapter on GraphQL, JWT creation, login functionality, and Sequelize model creation informative and engaging. It provided a wealth of valuable insights and practical tips that you can apply to your own projects, helping you to streamline your development process and achieve your goals more efficiently. By mastering these concepts, you’ll be better equipped to build robust, scalable applications that meet the needs of your users and drive your success. </p>
<p class="normal">Thank you for reading, and I look forward to sharing more with you in the next chapter, where you will learn how to create a monorepository and a multi-site project.</p>
</div>
</div></body></html>