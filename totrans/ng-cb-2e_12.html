<html><head></head><body>
<div class="Basic-Text-Frame" id="_idContainer277">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">12</span></h1>
<h1 class="chapterTitle" id="_idParaDest-406"><span class="koboSpan" id="kobo.2.1">Performance Optimization in Angular</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">Performance is always a concern in any product that you build for end users. </span><span class="koboSpan" id="kobo.3.2">It is a critical element in increasing the chances of someone using your app for the first time becoming a customer. </span><span class="koboSpan" id="kobo.3.3">Now, we can’t really improve an app’s performance until we identify potential possibilities for improvement and the methods to achieve this. </span><span class="koboSpan" id="kobo.3.4">In this chapter, you’ll learn some methods to deploy when it comes to improving Angular applications. </span><span class="koboSpan" id="kobo.3.5">You’ll learn how to analyze, optimize, and improve your Angular app’s performance using several techniques. </span><span class="koboSpan" id="kobo.3.6">Here are the recipes we’re going to cover in this chapter:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.4.1">Using </span><code class="inlineCode"><span class="koboSpan" id="kobo.5.1">OnPush</span></code><span class="koboSpan" id="kobo.6.1"> change detection to prune component subtrees</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.7.1">Detaching the change detector from components</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.8.1">Running </span><code class="inlineCode"><span class="koboSpan" id="kobo.9.1">async</span></code><span class="koboSpan" id="kobo.10.1"> events outside Angular with </span><code class="inlineCode"><span class="koboSpan" id="kobo.11.1">runOutsideAngular</span></code></li>
<li class="bulletList"><span class="koboSpan" id="kobo.12.1">Using </span><code class="inlineCode"><span class="koboSpan" id="kobo.13.1">trackBy</span></code><span class="koboSpan" id="kobo.14.1"> for lists with </span><code class="inlineCode"><span class="koboSpan" id="kobo.15.1">*ngFor</span></code></li>
<li class="bulletList"><span class="koboSpan" id="kobo.16.1">Moving heavy computation to pure pipes</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.17.1">Using web workers for heavy computation</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.18.1">Using performance budgets for auditing</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.19.1">Analyzing bundles with </span><code class="inlineCode"><span class="koboSpan" id="kobo.20.1">webpack-bundle-analyzer</span></code></li>
</ul>
<h1 class="heading-1" id="_idParaDest-407"><span class="koboSpan" id="kobo.21.1">Technical requirements</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.22.1">For the recipes in this chapter, ensure your setup is complete as per the 'Technical Requirements' in the 'Angular-Cookbook-2E' GitHub repository. </span><span class="koboSpan" id="kobo.22.2">For setup details, visit: </span><a href="https://github.com/PacktPublishing/Angular-Cookbook-2E/tree/main/docs/technical-requirements.md"><span class="url"><span class="koboSpan" id="kobo.23.1">https://github.com/PacktPublishing/Angular-Cookbook-2E/tree/main/docs/technical-requirements.md</span></span></a><span class="koboSpan" id="kobo.24.1">. </span><span class="koboSpan" id="kobo.24.2">The starter code for this chapter is located at </span><a href="https://github.com/PacktPublishing/Angular-Cookbook-2E/tree/main/start/apps/chapter12"><span class="url"><span class="koboSpan" id="kobo.25.1">https://github.com/PacktPublishing/Angular-Cookbook-2E/tree/main/start/apps/chapter12</span></span></a><span class="koboSpan" id="kobo.26.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-408"><span class="koboSpan" id="kobo.27.1">Using OnPush change detection to prune component subtrees</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.28.1">In today’s world of modern web</span><a id="_idIndexMarker955"/><span class="koboSpan" id="kobo.29.1"> applications, performance is one of the key factors</span><a id="_idIndexMarker956"/><span class="koboSpan" id="kobo.30.1"> for a great </span><strong class="keyWord"><span class="koboSpan" id="kobo.31.1">User Experience</span></strong><span class="koboSpan" id="kobo.32.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.33.1">UX</span></strong><span class="koboSpan" id="kobo.34.1">) and, ultimately, conversions for</span><a id="_idIndexMarker957"/><span class="koboSpan" id="kobo.35.1"> a business. </span><span class="koboSpan" id="kobo.35.2">In this recipe, the first recipe of this chapter, we’re going to discuss the fundamental or the most basic optimization you can do with your components wherever it seems appropriate, which is by using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.36.1">OnPush</span></code><span class="koboSpan" id="kobo.37.1"> change detection strategy. </span><span class="koboSpan" id="kobo.37.2">The app we’re working with has some performance issues, particularly with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.38.1">UserCardComponent</span></code><span class="koboSpan" id="kobo.39.1"> class. </span><span class="koboSpan" id="kobo.39.2">This is because it uses a getter function, </span><code class="inlineCode"><span class="koboSpan" id="kobo.40.1">randomColor</span></code><span class="koboSpan" id="kobo.41.1">, to generate a random color for its background. </span><span class="koboSpan" id="kobo.41.2">Behind the scenes, that function uses a </span><code class="inlineCode"><span class="koboSpan" id="kobo.42.1">factorial</span></code><span class="koboSpan" id="kobo.43.1"> function to add more processing time. </span><span class="koboSpan" id="kobo.43.2">But that is just to demonstrate a component that can cause the UI to hang if there is some complex calculation happening, along with multiple change detections being triggered.</span></p>
<h2 class="heading-2" id="_idParaDest-409"><span class="koboSpan" id="kobo.44.1">Getting ready</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.45.1">The app that we are going to work with resides in </span><code class="inlineCode"><span class="koboSpan" id="kobo.46.1">start/apps/chapter12/ng-on-push-strategy</span></code><span class="koboSpan" id="kobo.47.1"> inside the cloned repository:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.48.1">Open the code repository in your code editor.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.49.1">Open the terminal, navigate to the code repository directory, and run the following command to serve the project:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.50.1">npm run serve ng-on-push-strategy
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.51.1">This should open the app in a new browser tab, and you should see the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.52.1"><img alt="" role="presentation" src="../Images/B18469_12_01.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.53.1">Figure 12.1: The ng-on-push-strategy app running at http://localhost:4200</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.54.1">Click the button that says </span><strong class="screenText"><span class="koboSpan" id="kobo.55.1">Click Me </span></strong><span class="koboSpan" id="kobo.56.1">or try to search</span><a id="_idIndexMarker958"/><span class="koboSpan" id="kobo.57.1"> for some user. </span><span class="koboSpan" id="kobo.57.2">You’ll see that the app is too slow and often hangs. </span><span class="koboSpan" id="kobo.57.3">Now</span><a id="_idIndexMarker959"/><span class="koboSpan" id="kobo.58.1"> that we have the project served on the browser, let’s see the steps of the recipe in the next section.</span></p>
<h2 class="heading-2" id="_idParaDest-410"><span class="koboSpan" id="kobo.59.1">How to do it…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.60.1">We’re going to add some code to monitor how many times the </span><code class="inlineCode"><span class="koboSpan" id="kobo.61.1">randomColor</span></code><span class="koboSpan" id="kobo.62.1"> getter gets called. </span><span class="koboSpan" id="kobo.62.2">This will show the number of times the change detection in Angular gets triggered by default. </span><span class="koboSpan" id="kobo.62.3">We will also fix the issue and make it more performant (as much as we can) using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.63.1">OnPush</span></code><span class="koboSpan" id="kobo.64.1"> change detection strategy. </span><span class="koboSpan" id="kobo.64.2">Let’s get started:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.65.1">First, let’s make sure that the app is not too slow for your machine so that it makes your laptop/PC hang. </span><span class="koboSpan" id="kobo.65.2">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.66.1">src/app/app.config.ts</span></code><span class="koboSpan" id="kobo.67.1"> file and adjust the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.68.1">RANDOMIZATION_COUNT</span></code><span class="koboSpan" id="kobo.69.1"> token from </span><code class="inlineCode"><span class="koboSpan" id="kobo.70.1">9</span></code><span class="koboSpan" id="kobo.71.1"> to whatever suits you best.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.72.1">Then try to search for a user named </span><code class="inlineCode"><span class="koboSpan" id="kobo.73.1">Irineu</span></code><span class="koboSpan" id="kobo.74.1"> by entering their name in the search box. </span><span class="koboSpan" id="kobo.74.2">You’ll notice that the app still hangs and that it takes a few seconds to show the user. </span><span class="koboSpan" id="kobo.74.3">You’ll also notice that you don’t even see the typed letters in the search box as you type them. </span><span class="koboSpan" id="kobo.74.4">That is, there is a delay in rendering.
    </span><p class="normal"><span class="koboSpan" id="kobo.75.1">Let’s add some logic to the code. </span><span class="koboSpan" id="kobo.75.2">We’ll check how many times Angular calls the </span><code class="inlineCode"><span class="koboSpan" id="kobo.76.1">idUsingFactorial</span></code><span class="koboSpan" id="kobo.77.1"> method when the page loads.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.78.1">Let’s create a service that we will use to track the number of times a particular user card for a particular person is called. </span><span class="koboSpan" id="kobo.78.2">Run the following command from the workspace’s root folder to create a service:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.79.1">cd start &amp;&amp; nx g s services/logs --project ng-on-push-strategy
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.80.1">Choose </span><code class="inlineCode"><span class="koboSpan" id="kobo.81.1">@schematics/angular:service</span></code><span class="koboSpan" id="kobo.82.1"> when asked.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.83.1">Update the content</span><a id="_idIndexMarker960"/><span class="koboSpan" id="kobo.84.1"> of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.85.1">src/app/services/logs.service.ts</span></code><span class="koboSpan" id="kobo.86.1"> file</span><a id="_idIndexMarker961"/><span class="koboSpan" id="kobo.87.1"> as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.88.1">import</span></span><span class="koboSpan" id="kobo.89.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.90.1">Injectable</span></span><span class="koboSpan" id="kobo.91.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.92.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.93.1">'@angular/core'</span></span><span class="koboSpan" id="kobo.94.1">;
 
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.95.1">@Injectable</span></span><span class="koboSpan" id="kobo.96.1">({
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.97.1">providedIn</span></span><span class="koboSpan" id="kobo.98.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.99.1">'root'</span></span><span class="koboSpan" id="kobo.100.1">
})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.101.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.102.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.103.1">LogsService</span></span><span class="koboSpan" id="kobo.104.1"> {
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.105.1">logs</span></span><span class="koboSpan" id="kobo.106.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.107.1">Record</span></span><span class="koboSpan" id="kobo.108.1">&lt;</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.109.1">string</span></span><span class="koboSpan" id="kobo.110.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.111.1">number</span></span><span class="koboSpan" id="kobo.112.1">&gt; = {}
 
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.113.1">updateLogEntry</span></span><span class="koboSpan" id="kobo.114.1">(</span><span class="hljs-attr"><span class="koboSpan" id="kobo.115.1">email</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.116.1">: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.117.1">string</span></span><span class="koboSpan" id="kobo.118.1">) {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.119.1">if</span></span><span class="koboSpan" id="kobo.120.1"> (</span><span class="hljs-variable"><span class="koboSpan" id="kobo.121.1">this</span></span><span class="koboSpan" id="kobo.122.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.123.1">logs</span></span><span class="koboSpan" id="kobo.124.1">[email] === </span><span class="hljs-literal"><span class="koboSpan" id="kobo.125.1">undefined</span></span><span class="koboSpan" id="kobo.126.1">) {
      </span><span class="hljs-variable"><span class="koboSpan" id="kobo.127.1">this</span></span><span class="koboSpan" id="kobo.128.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.129.1">logs</span></span><span class="koboSpan" id="kobo.130.1"> = {
        ...</span><span class="hljs-variable"><span class="koboSpan" id="kobo.131.1">this</span></span><span class="koboSpan" id="kobo.132.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.133.1">logs</span></span><span class="koboSpan" id="kobo.134.1">,
        [email]: </span><span class="hljs-number"><span class="koboSpan" id="kobo.135.1">1</span></span><span class="koboSpan" id="kobo.136.1">
      }
    } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.137.1">else</span></span><span class="koboSpan" id="kobo.138.1"> {
      </span><span class="hljs-variable"><span class="koboSpan" id="kobo.139.1">this</span></span><span class="koboSpan" id="kobo.140.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.141.1">logs</span></span><span class="koboSpan" id="kobo.142.1"> = {
        ...</span><span class="hljs-variable"><span class="koboSpan" id="kobo.143.1">this</span></span><span class="koboSpan" id="kobo.144.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.145.1">logs</span></span><span class="koboSpan" id="kobo.146.1">,
        [email]: </span><span class="hljs-variable"><span class="koboSpan" id="kobo.147.1">this</span></span><span class="koboSpan" id="kobo.148.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.149.1">logs</span></span><span class="koboSpan" id="kobo.150.1">[email] + </span><span class="hljs-number"><span class="koboSpan" id="kobo.151.1">1</span></span><span class="koboSpan" id="kobo.152.1">
      }
    }
  }
}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.153.1">Now, inject the </span><code class="inlineCode"><span class="koboSpan" id="kobo.154.1">LogService</span></code><span class="koboSpan" id="kobo.155.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.156.1">src/app/component/user-card/user-card.component.ts</span></code><span class="koboSpan" id="kobo.157.1"> file. </span><span class="koboSpan" id="kobo.157.2">We will also create a getter (</span><code class="inlineCode"><span class="koboSpan" id="kobo.158.1">log</span></code><span class="koboSpan" id="kobo.159.1">) function to get the count for the user, and we will update the count whenever the </span><code class="inlineCode"><span class="koboSpan" id="kobo.160.1">randomColor</span></code><span class="koboSpan" id="kobo.161.1"> getter is called. </span><span class="koboSpan" id="kobo.161.2">Update the mentioned file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.162.1">...
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.163.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.164.1"> { </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.165.1">LogsService</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.166.1"> } </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.167.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.168.1">'../../services/logs.service'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.169.1">;</span></strong></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.170.1">@Component</span></span><span class="koboSpan" id="kobo.171.1">({...})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.172.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.173.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.174.1">UserCardComponent</span></span><span class="koboSpan" id="kobo.175.1"> {
  ...
  </span><span class="koboSpan" id="kobo.175.2">randomizationCount = </span><span class="hljs-title"><span class="koboSpan" id="kobo.176.1">inject</span></span><span class="koboSpan" id="kobo.177.1">(</span><span class="hljs-variable"><span class="koboSpan" id="kobo.178.1">RANDOMIZATION_COUNT</span></span><span class="koboSpan" id="kobo.179.1">);
  </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.180.1">logsService = </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.181.1">inject</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.182.1">(</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.183.1">LogsService</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.184.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.185.1">get</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.186.1">log</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.187.1">() {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.188.1">return</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.189.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.190.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.191.1">logsService</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.192.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.193.1">logs</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.194.1">[</span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.195.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.196.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.197.1">user</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.198.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.199.1">email</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.200.1">] ?? </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.201.1">0</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.202.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.203.1">}</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.204.1">get</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.205.1">randomColor</span></span><span class="koboSpan" id="kobo.206.1">() {
    </span><span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.207.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.208.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.209.1">logsService</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.210.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.211.1">updateLogEntry</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.212.1">(</span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.213.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.214.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.215.1">user</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.216.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.217.1">email</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.218.1">);</span></strong></span><span class="koboSpan" id="kobo.219.1">
    ...
  </span><span class="koboSpan" id="kobo.219.2">}
}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.220.1">Now, we will use the log</span><a id="_idIndexMarker962"/><span class="koboSpan" id="kobo.221.1"> in the template of the user card component</span><a id="_idIndexMarker963"/><span class="koboSpan" id="kobo.222.1"> to show the count. </span><span class="koboSpan" id="kobo.222.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.223.1">src/app/component/user-card/user-card.component.html</span></code><span class="koboSpan" id="kobo.224.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.225.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.226.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.227.1"> [</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.228.1">style.backgroundColor</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.229.1">]=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.230.1">"randomColor"</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.231.1">...</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.232.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.233.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.234.1">img</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.235.1">...</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.236.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.237.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.238.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.239.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.240.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.241.1">"card-body flex-1"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.242.1">&gt;</span></span><span class="koboSpan" id="kobo.243.1">...</span><span class="hljs-tag"><span class="koboSpan" id="kobo.244.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.245.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.246.1">&gt;</span></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.247.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.248.1">div</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.249.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.250.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.251.1">"p-4 bg-slate-900 text-green-300 rounded-md h-fit"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.252.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.253.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.254.1">div</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.255.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.256.1">Color Generation Count:</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.257.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.258.1">div</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.259.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.260.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.261.1">pre</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.262.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.263.1">{{log}}</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.264.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.265.1">pre</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.266.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.267.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.268.1">div</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.269.1">&gt;</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.270.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.271.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.272.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.273.1">If you look at the application now, you should see the </span><strong class="screenText"><span class="koboSpan" id="kobo.274.1">Color Generation Count</span></strong><span class="koboSpan" id="kobo.275.1"> as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.276.1"><img alt="" role="presentation" src="../Images/B18469_12_02.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.277.1">Figure 12.2: Color Generation Count being shown on page load</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="7"><span class="koboSpan" id="kobo.278.1">Now, click the </span><strong class="screenText"><span class="koboSpan" id="kobo.279.1">Click Me</span></strong><span class="koboSpan" id="kobo.280.1"> button. </span><span class="koboSpan" id="kobo.280.2">Then, focus (click) the </span><strong class="screenText"><span class="koboSpan" id="kobo.281.1">Quick Search </span></strong><span class="koboSpan" id="kobo.282.1">input and then click outside. </span><span class="koboSpan" id="kobo.282.2">Repeat</span><a id="_idIndexMarker964"/><span class="koboSpan" id="kobo.283.1"> this a few times and you should</span><a id="_idIndexMarker965"/><span class="koboSpan" id="kobo.284.1"> see that the colors are regenerated even though the cards are not supposed to be re-rendered. </span><em class="italic"><span class="koboSpan" id="kobo.285.1">Figure 12.3</span></em><span class="koboSpan" id="kobo.286.1"> shows how it should look:
    </span><figure class="mediaobject"><span class="koboSpan" id="kobo.287.1"><img alt="" role="presentation" src="../Images/B18469_12_03.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.288.1">Figure 12.3: Logs after interacting with the app without searching for anything</span></p>
<p class="normal"><span class="koboSpan" id="kobo.289.1">Notice that if you start searching for something, you’ll get even more re-renders. </span><span class="koboSpan" id="kobo.289.2">That’s because each key up and/or key down event will trigger more re-renders.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="8"><span class="koboSpan" id="kobo.290.1">To fix the issue, we will use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.291.1">OnPush</span></code><span class="koboSpan" id="kobo.292.1"> strategy and see how it changes the behavior of the user card component with respect to Angular’s change detection strategy. </span><span class="koboSpan" id="kobo.292.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.293.1">user-card.component.ts</span></code><span class="koboSpan" id="kobo.294.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.295.1">import</span></span><span class="koboSpan" id="kobo.296.1"> { </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.297.1">ChangeDetectionStrategy</span></strong></span><span class="koboSpan" id="kobo.298.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.299.1">Component</span></span><span class="koboSpan" id="kobo.300.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.301.1">Input</span></span><span class="koboSpan" id="kobo.302.1">, inject } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.303.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.304.1">'@angular/core'</span></span><span class="koboSpan" id="kobo.305.1">;
...
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.306.1">@Component</span></span><span class="koboSpan" id="kobo.307.1">({
  ...,
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.308.1">styleUrls</span></span><span class="koboSpan" id="kobo.309.1">: [</span><span class="hljs-string"><span class="koboSpan" id="kobo.310.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.311.1">./user-card.component.scss'</span></span><span class="koboSpan" id="kobo.312.1">],
  </span><span class="code-highlight"><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.313.1">changeDetection</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.314.1">: </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.315.1">ChangeDetectionStrategy</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.316.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.317.1">OnPush</span></strong></span><span class="koboSpan" id="kobo.318.1">
})
...
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.319.1">Now, if you try clicking</span><a id="_idIndexMarker966"/><span class="koboSpan" id="kobo.320.1"> the </span><strong class="screenText"><span class="koboSpan" id="kobo.321.1">Click Me</span></strong><span class="koboSpan" id="kobo.322.1"> button, focus</span><a id="_idIndexMarker967"/><span class="koboSpan" id="kobo.323.1"> in the search input and click outside, or do whatever else (apart from searching for users), you will see no change in the </span><strong class="screenText"><span class="koboSpan" id="kobo.324.1">Color Generation Count</span></strong><span class="koboSpan" id="kobo.325.1"> for the cards, as shown in </span><em class="italic"><span class="koboSpan" id="kobo.326.1">Figure 12.4</span></em><span class="koboSpan" id="kobo.327.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.328.1"><img alt="" role="presentation" src="../Images/B18469_12_04.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.329.1">Figure 12.4: The OnPush strategy preventing unnecessary renders</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.330.1">Great! </span><span class="koboSpan" id="kobo.330.2">By using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.331.1">OnPush</span></code><span class="koboSpan" id="kobo.332.1"> strategy, we were able to improve the overall performance of our </span><code class="inlineCode"><span class="koboSpan" id="kobo.333.1">UserCardComponent</span></code><span class="koboSpan" id="kobo.334.1">. </span><span class="koboSpan" id="kobo.334.2">The rest was just for fun. </span><span class="koboSpan" id="kobo.334.3">Now you know how to use this strategy, see the next section to understand how it works.</span></p>
<h2 class="heading-2" id="_idParaDest-411"><span class="koboSpan" id="kobo.335.1">How it works…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.336.1">Angular by default</span><a id="_idIndexMarker968"/><span class="koboSpan" id="kobo.337.1"> uses the </span><code class="inlineCode"><span class="koboSpan" id="kobo.338.1">Default</span></code><span class="koboSpan" id="kobo.339.1"> change detection</span><a id="_idIndexMarker969"/><span class="koboSpan" id="kobo.340.1"> strategy—or technically, it is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.341.1">ChangeDetectionStrategy.Default</span></code><span class="koboSpan" id="kobo.342.1"> enum from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.343.1">@angular/core</span></code><span class="koboSpan" id="kobo.344.1"> package. </span><span class="koboSpan" id="kobo.344.2">Since Angular doesn’t know about every component we create, it uses the default strategy to not encounter any surprises. </span><span class="koboSpan" id="kobo.344.3">This means that the framework will check for changes in the whole component tree whenever something might have changed. </span><span class="koboSpan" id="kobo.344.4">This might include user events, timers, XHRs, promises, etc. </span><span class="koboSpan" id="kobo.344.5">In a complex UI with lots of bindings, this can lead to performance degradation, especially when most of these components don’t change frequently or depend only on specific inputs.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.345.1">But as developers, if we know that a component will not change unless one of its </span><code class="inlineCode"><span class="koboSpan" id="kobo.346.1">@Input()</span></code><span class="koboSpan" id="kobo.347.1"> variables changes, we can—and we should—use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.348.1">OnPush</span></code><span class="koboSpan" id="kobo.349.1"> change detection strategy for that component. </span><span class="koboSpan" id="kobo.349.2">Why? </span><span class="koboSpan" id="kobo.349.3">Because it tells Angular to not run change detection until an </span><code class="inlineCode"><span class="koboSpan" id="kobo.350.1">@Input()</span></code><span class="koboSpan" id="kobo.351.1"> variable for the component</span><a id="_idIndexMarker970"/><span class="koboSpan" id="kobo.352.1"> changes. </span><span class="koboSpan" id="kobo.352.2">This strategy is an absolute winner for presentational components (sometimes called </span><code class="inlineCode"><span class="koboSpan" id="kobo.353.1">dumb</span></code><span class="koboSpan" id="kobo.354.1"> components), which are just supposed</span><a id="_idIndexMarker971"/><span class="koboSpan" id="kobo.355.1"> to show data using </span><code class="inlineCode"><span class="koboSpan" id="kobo.356.1">@Input()</span></code><span class="koboSpan" id="kobo.357.1"> variables/attributes and emit </span><code class="inlineCode"><span class="koboSpan" id="kobo.358.1">@Output()</span></code><span class="koboSpan" id="kobo.359.1"> events on interactions. </span><span class="koboSpan" id="kobo.359.2">These presentational components usually</span><a id="_idIndexMarker972"/><span class="koboSpan" id="kobo.360.1"> do not hold any business logic such as heavy computation, using services to make </span><strong class="keyWord"><span class="koboSpan" id="kobo.361.1">HTTP</span></strong><span class="koboSpan" id="kobo.362.1"> calls, and so on. </span><span class="koboSpan" id="kobo.362.2">Therefore, it is easier for us to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.363.1">OnPush</span></code><span class="koboSpan" id="kobo.364.1"> strategy in these components because they would only show different data when any of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.365.1">@Input()</span></code><span class="koboSpan" id="kobo.366.1"> attributes from the parent component change, that is, their reference should change. </span><span class="koboSpan" id="kobo.366.2">For example, if we had an array of users, there should be a completely new array now in order to run the change detection. </span><span class="koboSpan" id="kobo.366.3">If it is the same array but we have only added or removed an item, change detection with </span><code class="inlineCode"><span class="koboSpan" id="kobo.367.1">OnPush</span></code><span class="koboSpan" id="kobo.368.1"> will not be triggered.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.369.1">Since we are now using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.370.1">OnPush</span></code><span class="koboSpan" id="kobo.371.1"> strategy on our </span><code class="inlineCode"><span class="koboSpan" id="kobo.372.1">UserCardComponent</span></code><span class="koboSpan" id="kobo.373.1">, it only triggers change detection when we replace the entire </span><code class="inlineCode"><span class="koboSpan" id="kobo.374.1">users</span></code><span class="koboSpan" id="kobo.375.1"> array upon searching. </span><span class="koboSpan" id="kobo.375.2">This happens after the </span><code class="inlineCode"><span class="koboSpan" id="kobo.376.1">500ms</span></code><span class="koboSpan" id="kobo.377.1"> debounce (</span><em class="italic"><span class="koboSpan" id="kobo.378.1">line 31 </span></em><span class="koboSpan" id="kobo.379.1">in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.380.1">users.component.ts</span></code><span class="koboSpan" id="kobo.381.1"> file), so we only do it when the user stops typing. </span><span class="koboSpan" id="kobo.381.2">So, essentially, before the optimization, the default change detection was triggering on each keypress being a browser event, and now, it doesn’t.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.382.1">IMPORTANT NOTE</span></p>
<p class="normal"><span class="koboSpan" id="kobo.383.1">As you now know, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.384.1">OnPush</span></code><span class="koboSpan" id="kobo.385.1"> strategy only triggers the Angular change detection</span><a id="_idIndexMarker973"/><span class="koboSpan" id="kobo.386.1"> mechanism when one or more of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.387.1">@Input()</span></code><span class="koboSpan" id="kobo.388.1"> bindings changes. </span><span class="koboSpan" id="kobo.388.2">This means that if we change a property within the component (</span><code class="inlineCode"><span class="koboSpan" id="kobo.389.1">UserCardComponent</span></code><span class="koboSpan" id="kobo.390.1">), it will not be reflected in the view because the change detection mechanism won’t run in this case, since that property isn’t an </span><code class="inlineCode"><span class="koboSpan" id="kobo.391.1">@Input()</span></code><span class="koboSpan" id="kobo.392.1"> binding. </span><span class="koboSpan" id="kobo.392.2">You would have to mark the component as dirty so that Angular could check the component and run change detection. </span><span class="koboSpan" id="kobo.392.3">You’ll do this using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.393.1">ChangeDetectorRef</span></code><span class="koboSpan" id="kobo.394.1"> service—specifically, with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.395.1">markForCheck</span></code><span class="koboSpan" id="kobo.396.1"> method.</span></p>
</div>
<h2 class="heading-2" id="_idParaDest-412"><span class="koboSpan" id="kobo.397.1">See also</span></h2>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.398.1">Angular </span><code class="inlineCode"><span class="koboSpan" id="kobo.399.1">ChangeDetectionStrategy</span></code><span class="koboSpan" id="kobo.400.1"> official</span><a id="_idIndexMarker974"/><span class="koboSpan" id="kobo.401.1"> documentation: </span><a href="https://angular.io/api/core/ChangeDetectionStrategy"><span class="url"><span class="koboSpan" id="kobo.402.1">https://angular.io/api/core/ChangeDetectionStrategy</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.403.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.404.1">markForCheck</span></code><span class="koboSpan" id="kobo.405.1"> method official</span><a id="_idIndexMarker975"/><span class="koboSpan" id="kobo.406.1"> documentation: </span><a href="https://angular.io/api/core/ChangeDetectorRef#markforcheck "><span class="url"><span class="koboSpan" id="kobo.407.1">https://angular.io/api/core/ChangeDetectorRef#markforcheck</span></span></a></li>
</ul>
<h1 class="heading-1" id="_idParaDest-413"><span class="koboSpan" id="kobo.408.1">Detaching the change detector from components</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.409.1">In the previous recipe, we learned</span><a id="_idIndexMarker976"/><span class="koboSpan" id="kobo.410.1"> how to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.411.1">OnPush</span></code><span class="koboSpan" id="kobo.412.1"> strategy in our components</span><a id="_idIndexMarker977"/><span class="koboSpan" id="kobo.413.1"> to avoid Angular change detection running unless one of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.414.1">@Input()</span></code><span class="koboSpan" id="kobo.415.1"> bindings has changed. </span><span class="koboSpan" id="kobo.415.2">There is, however, another way to tell Angular to not run change detection at all for a particular component and its subtree. </span><span class="koboSpan" id="kobo.415.3">This cuts the component and its subtree from the change detection cycle completely, as shown in </span><em class="italic"><span class="koboSpan" id="kobo.416.1">Figure 12.5</span></em><span class="koboSpan" id="kobo.417.1">, which can result in an increase in the overall performance. </span><span class="koboSpan" id="kobo.417.2">This is also handy when you want full control of when to run change detection. </span><span class="koboSpan" id="kobo.417.3">In this recipe, you’ll learn how to completely detach the change detector from an Angular component to gain performance improvements.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.418.1"><img alt="" role="presentation" src="../Images/B18469_12_05.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.419.1">Figure 12.5: Change detector detached from component tree</span></p>
<h2 class="heading-2" id="_idParaDest-414"><span class="koboSpan" id="kobo.420.1">Getting ready</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.421.1">The app that we are going</span><a id="_idIndexMarker978"/><span class="koboSpan" id="kobo.422.1"> to work with resides in </span><code class="inlineCode"><span class="koboSpan" id="kobo.423.1">start/apps/chapter12/ng-cd-ref</span></code><span class="koboSpan" id="kobo.424.1"> inside</span><a id="_idIndexMarker979"/><span class="koboSpan" id="kobo.425.1"> the cloned repository:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.426.1">Open the code repository in your code editor.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.427.1">Open the terminal, navigate to the code repository directory, and run the following command to serve the project:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.428.1">npm run serve ng-cd-ref
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.429.1">This should open the app in a new browser tab, and you should see the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.430.1"><img alt="" role="presentation" src="../Images/B18469_12_06.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.431.1">Figure 12.6: The ng-cd-ref app running at http://localhost:4200</span></p> </li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.432.1">Click the button that says </span><strong class="screenText"><span class="koboSpan" id="kobo.433.1">Click Me</span></strong><span class="koboSpan" id="kobo.434.1"> Or try to search for some user. </span><span class="koboSpan" id="kobo.434.2">You’ll see that the app is too slow and often hangs. </span><span class="koboSpan" id="kobo.434.3">Now that</span><a id="_idIndexMarker980"/><span class="koboSpan" id="kobo.435.1"> we have the project served on the browser, let’s see the steps</span><a id="_idIndexMarker981"/><span class="koboSpan" id="kobo.436.1"> of the recipe in the next section.</span></p>
<h2 class="heading-2" id="_idParaDest-415"><span class="koboSpan" id="kobo.437.1">How to do it…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.438.1">The app we’re working with has some performance issues, particularly with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.439.1">UserCardComponent</span></code><span class="koboSpan" id="kobo.440.1"> class. </span><span class="koboSpan" id="kobo.440.2">This is because it uses a getter function, </span><code class="inlineCode"><span class="koboSpan" id="kobo.441.1">randomColor</span></code><span class="koboSpan" id="kobo.442.1">, to generate a random color for its background. </span><span class="koboSpan" id="kobo.442.2">Behind the scenes, that function uses a </span><code class="inlineCode"><span class="koboSpan" id="kobo.443.1">factorial</span></code><span class="koboSpan" id="kobo.444.1"> function to add more processing time. </span><span class="koboSpan" id="kobo.444.2">But that is just to demonstrate a component that can cause the UI to hang if there is some complex calculation happening along with multiple change detections being triggered. </span><span class="koboSpan" id="kobo.444.3">We’re going to add some code to monitor how many times the </span><code class="inlineCode"><span class="koboSpan" id="kobo.445.1">randomColor</span></code><span class="koboSpan" id="kobo.446.1"> getter gets called. </span><span class="koboSpan" id="kobo.446.2">This will show the number of times the change detection in Angular gets triggered by default. </span><span class="koboSpan" id="kobo.446.3">We will also fix the issue and make it more performant (as much as we can) by detaching the change detector completely from a particular component. </span><span class="koboSpan" id="kobo.446.4">Let’s get started:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.447.1">First, let’s make sure that the app is not too slow for your machine so that it makes your laptop/PC hang. </span><span class="koboSpan" id="kobo.447.2">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.448.1">src/app/app.config.ts</span></code><span class="koboSpan" id="kobo.449.1"> file and adjust the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.450.1">RANDOMIZATION_COUNT</span></code><span class="koboSpan" id="kobo.451.1"> token from </span><code class="inlineCode"><span class="koboSpan" id="kobo.452.1">9</span></code><span class="koboSpan" id="kobo.453.1"> to whatever suits you best.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.454.1">Then try to search for a user named </span><code class="inlineCode"><span class="koboSpan" id="kobo.455.1">Irineu</span></code><span class="koboSpan" id="kobo.456.1"> by entering their name in the search box. </span><span class="koboSpan" id="kobo.456.2">You’ll notice that the app still hangs and that it takes a few seconds to show the user. </span><span class="koboSpan" id="kobo.456.3">You’ll also notice that you don’t even see the letters in the search box as you type them. </span><span class="koboSpan" id="kobo.456.4">That is, there is a delay in rendering.
    </span><p class="normal"><span class="koboSpan" id="kobo.457.1">Let’s add some logic to the code. </span><span class="koboSpan" id="kobo.457.2">We’ll check how many times Angular calls the </span><code class="inlineCode"><span class="koboSpan" id="kobo.458.1">idUsingFactorial</span></code><span class="koboSpan" id="kobo.459.1"> method when the page loads.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.460.1">Let’s create a service</span><a id="_idIndexMarker982"/><span class="koboSpan" id="kobo.461.1"> that we will use to track the number </span><a id="_idIndexMarker983"/><span class="koboSpan" id="kobo.462.1">of times a particular user card for a particular person is called. </span><span class="koboSpan" id="kobo.462.2">Run the following command from the workspace’s root folder to create a service:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.463.1">cd start &amp;&amp; nx g s services/logs --project ng-cd-ref
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.464.1">Choose </span><code class="inlineCode"><span class="koboSpan" id="kobo.465.1">@schematics/angular:service</span></code><span class="koboSpan" id="kobo.466.1"> when asked.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.467.1">Update the content of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.468.1">src/app/services/logs.service.ts</span></code><span class="koboSpan" id="kobo.469.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.470.1">import</span></span><span class="koboSpan" id="kobo.471.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.472.1">Injectable</span></span><span class="koboSpan" id="kobo.473.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.474.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.475.1">'@angular/core'</span></span><span class="koboSpan" id="kobo.476.1">;
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.477.1">@Injectable</span></span><span class="koboSpan" id="kobo.478.1">({
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.479.1">providedIn</span></span><span class="koboSpan" id="kobo.480.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.481.1">'root'</span></span><span class="koboSpan" id="kobo.482.1">
})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.483.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.484.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.485.1">LogsService</span></span><span class="koboSpan" id="kobo.486.1"> {
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.487.1">logs</span></span><span class="koboSpan" id="kobo.488.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.489.1">Record</span></span><span class="koboSpan" id="kobo.490.1">&lt;</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.491.1">string</span></span><span class="koboSpan" id="kobo.492.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.493.1">number</span></span><span class="koboSpan" id="kobo.494.1">&gt; = {}
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.495.1">updateLogEntry</span></span><span class="koboSpan" id="kobo.496.1">(</span><span class="hljs-attr"><span class="koboSpan" id="kobo.497.1">email</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.498.1">: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.499.1">string</span></span><span class="koboSpan" id="kobo.500.1">) {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.501.1">if</span></span><span class="koboSpan" id="kobo.502.1"> (</span><span class="hljs-variable"><span class="koboSpan" id="kobo.503.1">this</span></span><span class="koboSpan" id="kobo.504.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.505.1">logs</span></span><span class="koboSpan" id="kobo.506.1">[email] === </span><span class="hljs-literal"><span class="koboSpan" id="kobo.507.1">undefined</span></span><span class="koboSpan" id="kobo.508.1">) {
      </span><span class="hljs-variable"><span class="koboSpan" id="kobo.509.1">this</span></span><span class="koboSpan" id="kobo.510.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.511.1">logs</span></span><span class="koboSpan" id="kobo.512.1"> = {
        ...</span><span class="hljs-variable"><span class="koboSpan" id="kobo.513.1">this</span></span><span class="koboSpan" id="kobo.514.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.515.1">logs</span></span><span class="koboSpan" id="kobo.516.1">,
        [email]: </span><span class="hljs-number"><span class="koboSpan" id="kobo.517.1">1</span></span><span class="koboSpan" id="kobo.518.1">
      }
    } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.519.1">else</span></span><span class="koboSpan" id="kobo.520.1"> {
      </span><span class="hljs-variable"><span class="koboSpan" id="kobo.521.1">this</span></span><span class="koboSpan" id="kobo.522.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.523.1">logs</span></span><span class="koboSpan" id="kobo.524.1"> = {
        ...</span><span class="hljs-variable"><span class="koboSpan" id="kobo.525.1">this</span></span><span class="koboSpan" id="kobo.526.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.527.1">logs</span></span><span class="koboSpan" id="kobo.528.1">,
        [email]: </span><span class="hljs-variable"><span class="koboSpan" id="kobo.529.1">this</span></span><span class="koboSpan" id="kobo.530.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.531.1">logs</span></span><span class="koboSpan" id="kobo.532.1">[email] + </span><span class="hljs-number"><span class="koboSpan" id="kobo.533.1">1</span></span><span class="koboSpan" id="kobo.534.1">
      }
    }
  }
}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.535.1">Now, inject the </span><code class="inlineCode"><span class="koboSpan" id="kobo.536.1">LogService</span></code><span class="koboSpan" id="kobo.537.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.538.1">src/app/component/user-card/user-card.component.ts</span></code><span class="koboSpan" id="kobo.539.1"> file. </span><span class="koboSpan" id="kobo.539.2">We will also create a getter (</span><code class="inlineCode"><span class="koboSpan" id="kobo.540.1">log</span></code><span class="koboSpan" id="kobo.541.1">) function to get the count for the user, and we will update the count whenever the </span><code class="inlineCode"><span class="koboSpan" id="kobo.542.1">randomColor</span></code><span class="koboSpan" id="kobo.543.1"> getter is called. </span><span class="koboSpan" id="kobo.543.2">Update the mentioned file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.544.1">...
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.545.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.546.1"> { </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.547.1">LogsService</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.548.1"> } </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.549.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.550.1">'../../services/logs.service'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.551.1">;</span></strong></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.552.1">@Component</span></span><span class="koboSpan" id="kobo.553.1">({...})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.554.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.555.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.556.1">UserCardComponent</span></span><span class="koboSpan" id="kobo.557.1"> {
  ...
  </span><span class="koboSpan" id="kobo.557.2">randomizationCount = </span><span class="hljs-title"><span class="koboSpan" id="kobo.558.1">inject</span></span><span class="koboSpan" id="kobo.559.1">(</span><span class="hljs-variable"><span class="koboSpan" id="kobo.560.1">RANDOMIZATION_COUNT</span></span><span class="koboSpan" id="kobo.561.1">);
  </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.562.1">logsService = </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.563.1">inject</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.564.1">(</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.565.1">LogsService</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.566.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.567.1">get</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.568.1">log</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.569.1">() {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.570.1">return</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.571.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.572.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.573.1">logsService</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.574.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.575.1">logs</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.576.1">[</span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.577.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.578.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.579.1">user</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.580.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.581.1">email</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.582.1">] ?? </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.583.1">0</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.584.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.585.1">}</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.586.1">get</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.587.1">randomColor</span></span><span class="koboSpan" id="kobo.588.1">() {
    </span><span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.589.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.590.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.591.1">logsService</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.592.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.593.1">updateLogEntry</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.594.1">(</span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.595.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.596.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.597.1">user</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.598.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.599.1">email</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.600.1">);</span></strong></span><span class="koboSpan" id="kobo.601.1">
    ...
  </span><span class="koboSpan" id="kobo.601.2">}
}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.602.1">Now, we will use the log</span><a id="_idIndexMarker984"/><span class="koboSpan" id="kobo.603.1"> in the template of the user card</span><a id="_idIndexMarker985"/><span class="koboSpan" id="kobo.604.1"> component to show the count. </span><span class="koboSpan" id="kobo.604.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.605.1">src/app/component/user-card/user-card.component.html</span></code><span class="koboSpan" id="kobo.606.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.607.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.608.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.609.1"> [</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.610.1">style.backgroundColor</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.611.1">]=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.612.1">"randomColor"</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.613.1">...</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.614.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.615.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.616.1">img</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.617.1">...</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.618.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.619.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.620.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.621.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.622.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.623.1">"card-body flex-1"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.624.1">&gt;</span></span><span class="koboSpan" id="kobo.625.1">...</span><span class="hljs-tag"><span class="koboSpan" id="kobo.626.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.627.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.628.1">&gt;</span></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.629.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.630.1">div</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.631.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.632.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.633.1">"p-4 bg-slate-900 text-green-300 rounded-md h-fit"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.634.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.635.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.636.1">div</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.637.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.638.1">Color Generation Count:</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.639.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.640.1">div</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.641.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.642.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.643.1">pre</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.644.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.645.1">{{log}}</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.646.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.647.1">pre</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.648.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.649.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.650.1">div</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.651.1">&gt;</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.652.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.653.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.654.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.655.1">If you look at the application now, you should see the </span><strong class="screenText"><span class="koboSpan" id="kobo.656.1">Color Generation Count </span></strong><span class="koboSpan" id="kobo.657.1">as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.658.1"><img alt="" role="presentation" src="../Images/B18469_12_07.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.659.1">Figure 12.7: Color Generation Count being shown on page load</span></p> </li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="7"><span class="koboSpan" id="kobo.660.1">Now, click the </span><strong class="screenText"><span class="koboSpan" id="kobo.661.1">Click Me</span></strong><span class="koboSpan" id="kobo.662.1"> button. </span><span class="koboSpan" id="kobo.662.2">Then</span><a id="_idIndexMarker986"/><span class="koboSpan" id="kobo.663.1"> focus (click) the </span><strong class="screenText"><span class="koboSpan" id="kobo.664.1">Quick Search</span></strong><span class="koboSpan" id="kobo.665.1"> input and then click outside. </span><span class="koboSpan" id="kobo.665.2">Repeat</span><a id="_idIndexMarker987"/><span class="koboSpan" id="kobo.666.1"> this a few times and you should see that the colors are regenerated even though the cards are not supposed to be re-rendered. </span><em class="italic"><span class="koboSpan" id="kobo.667.1">Figure 12.8</span></em><span class="koboSpan" id="kobo.668.1"> shows how it should look:
    </span><figure class="mediaobject"><span class="koboSpan" id="kobo.669.1"><img alt="" role="presentation" src="../Images/B18469_12_08.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.670.1">Figure 12.8: Logs after interacting with the app without searching for anything</span></p>
<p class="normal"><span class="koboSpan" id="kobo.671.1">Notice that if you start searching for something, you’ll get even more re-renders. </span><span class="koboSpan" id="kobo.671.2">That’s because each key up and/or key down event will trigger more re-renders.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="8"><span class="koboSpan" id="kobo.672.1">To fix the issue, we will detach the change detector reference from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.673.1">user-card</span></code><span class="koboSpan" id="kobo.674.1"> components when the component</span><a id="_idIndexMarker988"/><span class="koboSpan" id="kobo.675.1"> loads so there is no re-render afterward. </span><span class="koboSpan" id="kobo.675.2">This is assuming</span><a id="_idIndexMarker989"/><span class="koboSpan" id="kobo.676.1"> that the content of the card never changes. </span><span class="koboSpan" id="kobo.676.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.677.1">user-card.component.ts</span></code><span class="koboSpan" id="kobo.678.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.679.1">import</span></span><span class="koboSpan" id="kobo.680.1"> { </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.681.1">AfterViewInit</span></strong></span><span class="koboSpan" id="kobo.682.1">, </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.683.1">ChangeDetectorRef</span></strong></span><span class="koboSpan" id="kobo.684.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.685.1">Component</span></span><span class="koboSpan" id="kobo.686.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.687.1">Input</span></span><span class="koboSpan" id="kobo.688.1">, inject } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.689.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.690.1">'@angular/core'</span></span><span class="koboSpan" id="kobo.691.1">;
      ...
 
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.692.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.693.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.694.1">UserCardComponent</span></span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.695.1">implements</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.696.1">AfterViewInit</span></strong></span><span class="koboSpan" id="kobo.697.1"> {
  ...
  </span><span class="koboSpan" id="kobo.697.2">logsService = </span><span class="hljs-title"><span class="koboSpan" id="kobo.698.1">inject</span></span><span class="koboSpan" id="kobo.699.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.700.1">LogsService</span></span><span class="koboSpan" id="kobo.701.1">);
  </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.702.1">cdRef = </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.703.1">inject</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.704.1">(</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.705.1">ChangeDetectorRef</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.706.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.707.1">ngAfterViewInit</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.708.1">(): </span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.709.1">void</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.710.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.711.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.712.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.713.1">cdRef</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.714.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.715.1">detach</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.716.1">();</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.717.1">}</span></strong></span><span class="koboSpan" id="kobo.718.1">
  ...
</span><span class="koboSpan" id="kobo.718.2">}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.719.1">Now, if you try clicking the </span><strong class="screenText"><span class="koboSpan" id="kobo.720.1">Click Me</span></strong><span class="koboSpan" id="kobo.721.1"> button, focus on the search input and click outside, or do whatever else (apart from searching for users), you will see no change in the </span><strong class="screenText"><span class="koboSpan" id="kobo.722.1">Color Generation Count</span></strong><span class="koboSpan" id="kobo.723.1"> for the cards, as shown in </span><em class="italic"><span class="koboSpan" id="kobo.724.1">Figure 12.9</span></em><span class="koboSpan" id="kobo.725.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.726.1"><img alt="" role="presentation" src="../Images/B18469_12_09.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.727.1">Figure 12.9: Detached change detector preventing unnecessary renders</span></p>
<p class="normal"><span class="koboSpan" id="kobo.728.1">But what if something had to change in the components later? </span><span class="koboSpan" id="kobo.728.2">How do we get full control over the change detection?</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="9"><span class="koboSpan" id="kobo.729.1">Let’s assume that the app has a feature that changes the user’s name. </span><span class="koboSpan" id="kobo.729.2">We’ll hardcode the logic to change</span><a id="_idIndexMarker990"/><span class="koboSpan" id="kobo.730.1"> the last name of the first</span><a id="_idIndexMarker991"/><span class="koboSpan" id="kobo.731.1"> user. </span><span class="koboSpan" id="kobo.731.2">In this case, we would have to tell Angular to run the change detection. </span><span class="koboSpan" id="kobo.731.3">Let’s update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.732.1">users.component.html</span></code><span class="koboSpan" id="kobo.733.1"> file to update the </span><strong class="screenText"><span class="koboSpan" id="kobo.734.1">Click Me</span></strong><span class="koboSpan" id="kobo.735.1"> button in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.736.1">src/app/users/users.component.html</span></code><span class="koboSpan" id="kobo.737.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.738.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.739.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.740.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.741.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.742.1">"home"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.743.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.744.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.745.1">section</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.746.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.747.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.748.1">"flex flex-col gap-4 w-full"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.749.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.750.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.751.1">h2</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.752.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.753.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.754.1">"text-center text-2xl"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.755.1">&gt;</span></span><span class="koboSpan" id="kobo.756.1">Users</span><span class="hljs-tag"><span class="koboSpan" id="kobo.757.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.758.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.759.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.760.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.761.1">form</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.762.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.763.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.764.1">"input-container flex gap-4 w-full items</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.765.1">      -center mb-4"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.766.1"> [</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.767.1">formGroup</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.768.1">]=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.769.1">"searchForm"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.770.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.771.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.772.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.773.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.774.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.775.1">"relative flex-1"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.776.1">&gt;</span></span><span class="koboSpan" id="kobo.777.1">...</span><span class="hljs-tag"><span class="koboSpan" id="kobo.778.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.779.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.780.1">&gt;</span></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.781.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.782.1">button</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.783.1"> (</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.784.1">click</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.785.1">)=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.786.1">"updateName(users[0])"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.787.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.788.1">Update</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.789.1">Irineu's Name</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.790.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.791.1">button</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.792.1">&gt;</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.793.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.794.1">form</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.795.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.796.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.797.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.798.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.799.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.800.1">"secondary-container flex justify-center"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.801.1">&gt;</span></span><span class="koboSpan" id="kobo.802.1">...</span><span class="hljs-tag"><span class="koboSpan" id="kobo.803.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.804.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.805.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.806.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.807.1">section</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.808.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.809.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.810.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.811.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.812.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.813.1">ng-template</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.814.1"> #</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.815.1">loader</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.816.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.817.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.818.1">app-loader</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.819.1">&gt;&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.820.1">app-loader</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.821.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.822.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.823.1">ng-template</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.824.1">&gt;</span></span>
</code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.825.1">Let’s update the TypeScript file to add the function that updates the user’s name. </span><span class="koboSpan" id="kobo.825.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.826.1">src/app/users/users.component.ts</span></code><span class="koboSpan" id="kobo.827.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.828.1">      ...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.829.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.830.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.831.1">UsersComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.832.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.833.1">OnInit</span></span><span class="koboSpan" id="kobo.834.1"> {
  ...
 
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.835.1">usersTrackBy</span></span><span class="koboSpan" id="kobo.836.1">(</span><span class="hljs-attr"><span class="koboSpan" id="kobo.837.1">_index</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.838.1">: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.839.1">number</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.840.1">, </span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.841.1">user</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.842.1">: </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.843.1">IUser</span></span><span class="koboSpan" id="kobo.844.1">) {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.845.1">return</span></span><span class="koboSpan" id="kobo.846.1"> user.</span><span class="hljs-property"><span class="koboSpan" id="kobo.847.1">uuid</span></span><span class="koboSpan" id="kobo.848.1">;
  }
 
  </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.849.1">updateName</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.850.1">(</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.851.1">user</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.852.1">: </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.853.1">IUser</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.854.1">) {</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.855.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.856.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.857.1">users</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.858.1"> = </span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.859.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.860.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.861.1">users</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.862.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.863.1">map</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.864.1">(</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.865.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.866.1">userItem</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.867.1">) =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.868.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.869.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.870.1"> (userItem.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.871.1">uuid</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.872.1"> === user.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.873.1">uuid</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.874.1">) {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.875.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.876.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.877.1">...userItem,</span></strong></span>
<span class="code-highlight"><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.878.1">name</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.879.1">: {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.880.1">...userItem.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.881.1">name</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.882.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.883.1">last</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.884.1">: </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.885.1">'Test 123'</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.886.1">}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.887.1">}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.888.1">}</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.889.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.890.1"> userItem;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.891.1">})</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.892.1">}</span></strong></span><span class="koboSpan" id="kobo.893.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.894.1">If you click the </span><strong class="screenText"><span class="koboSpan" id="kobo.895.1">Update Irineu’s Name</span></strong><span class="koboSpan" id="kobo.896.1"> button, you’ll see no change</span><a id="_idIndexMarker992"/><span class="koboSpan" id="kobo.897.1"> in the UI. </span><span class="koboSpan" id="kobo.897.2">That is because the change</span><a id="_idIndexMarker993"/><span class="koboSpan" id="kobo.898.1"> detector is still detached from each user card component. </span><span class="koboSpan" id="kobo.898.2">So, the name changes, but you can’t see the change on the UI. </span><span class="koboSpan" id="kobo.898.3">See </span><em class="italic"><span class="koboSpan" id="kobo.899.1">Figure 12.10</span></em><span class="koboSpan" id="kobo.900.1">, in which the Angular (Chrome) DevTools show the value being updated in the component, but the UI doesn’t reflect it.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.901.1"><img alt="" role="presentation" src="../Images/B18469_12_10.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.902.1">Figure 12.10: User card not re-rendering due to detached change detector</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="11"><span class="koboSpan" id="kobo.903.1">To fix the issue, we will query the </span><code class="inlineCode"><span class="koboSpan" id="kobo.904.1">UserCard</span></code><span class="koboSpan" id="kobo.905.1"> components on the users page and will manually run the </span><code class="inlineCode"><span class="koboSpan" id="kobo.906.1">ChangeDetectorRef.detectChanges</span></code><span class="koboSpan" id="kobo.907.1"> method on the desired component. </span><span class="koboSpan" id="kobo.907.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.908.1">src/app/users/users.component.ts</span></code><span class="koboSpan" id="kobo.909.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.910.1">import</span></span><span class="koboSpan" id="kobo.911.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.912.1">Component</span></span><span class="koboSpan" id="kobo.913.1">, inject, </span><span class="hljs-title"><span class="koboSpan" id="kobo.914.1">OnInit</span></span><span class="koboSpan" id="kobo.915.1">, </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.916.1">QueryList</span></strong></span><span class="koboSpan" id="kobo.917.1">, </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.918.1">ViewChildren</span></strong><strong class="hljs-slc"> </strong></span><span class="koboSpan" id="kobo.919.1">} </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.920.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.921.1">'@angular/core'</span></span><span class="koboSpan" id="kobo.922.1">;
...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.923.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.924.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.925.1">UsersComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.926.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.927.1">OnInit</span></span><span class="koboSpan" id="kobo.928.1"> {
  </span><span class="code-highlight"><strong class="hljs-meta-slc"><span class="koboSpan" id="kobo.929.1">@ViewChildren</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.930.1">(</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.931.1">UserCardComponent</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.932.1">) userCards!:</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.933.1">QueryList</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.934.1">&lt;</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.935.1">UserCardComponent</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.936.1">&gt;;</span></strong></span><span class="koboSpan" id="kobo.937.1">
  users!: </span><span class="hljs-title"><span class="koboSpan" id="kobo.938.1">IUser</span></span><span class="koboSpan" id="kobo.939.1">[];
  ...
 
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.940.1">updateName</span></span><span class="koboSpan" id="kobo.941.1">(</span><span class="hljs-attr"><span class="koboSpan" id="kobo.942.1">user</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.943.1">: </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.944.1">IUser</span></span><span class="koboSpan" id="kobo.945.1">) {
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.946.1">this</span></span><span class="koboSpan" id="kobo.947.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.948.1">users</span></span><span class="koboSpan" id="kobo.949.1"> = </span><span class="hljs-variable"><span class="koboSpan" id="kobo.950.1">this</span></span><span class="koboSpan" id="kobo.951.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.952.1">users</span></span><span class="koboSpan" id="kobo.953.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.954.1">map</span></span><span class="koboSpan" id="kobo.955.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.956.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.957.1">userItem</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.958.1">) =&gt;</span></span><span class="koboSpan" id="kobo.959.1"> {
      ...
    </span><span class="koboSpan" id="kobo.959.2">})
    </span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.960.1">const</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.961.1"> matchingComponent = </span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.962.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.963.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.964.1">userCards</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.965.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.966.1">find</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.967.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.968.1">comp</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.969.1"> =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.970.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.971.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.972.1"> comp.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.973.1">user</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.974.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.975.1">uuid</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.976.1"> === user.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.977.1">uuid</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.978.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.979.1">})</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.980.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.981.1"> (matchingComponent) {</span></strong></span>
<span class="code-highlight"><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.982.1">setTimeout</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.983.1">(</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.984.1">() =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.985.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.986.1">matchingComponent.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.987.1">cdRef</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.988.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.989.1">detectChanges</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.990.1">();</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.991.1">}, </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.992.1">0</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.993.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.994.1">}</span></strong></span><span class="koboSpan" id="kobo.995.1">
  }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.996.1">Now, if you click the </span><strong class="screenText"><span class="koboSpan" id="kobo.997.1">Update Irineu’s Name</span></strong><span class="koboSpan" id="kobo.998.1"> button four times, you should see the count</span><a id="_idIndexMarker994"/><span class="koboSpan" id="kobo.999.1"> of the first user card to be </span><code class="inlineCode"><span class="koboSpan" id="kobo.1000.1">5</span></code><span class="koboSpan" id="kobo.1001.1">, while the rest</span><a id="_idIndexMarker995"/><span class="koboSpan" id="kobo.1002.1"> of the cards still render </span><code class="inlineCode"><span class="koboSpan" id="kobo.1003.1">1</span></code><span class="koboSpan" id="kobo.1004.1"> time, as shown in </span><em class="italic"><span class="koboSpan" id="kobo.1005.1">Figure 12.11</span></em><span class="koboSpan" id="kobo.1006.1">.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1007.1"><img alt="" role="presentation" src="../Images/B18469_12_11.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1008.1">Figure 12.11: Fully controlled change detection</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1009.1">Great! </span><span class="koboSpan" id="kobo.1009.2">Within a few steps, by using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1010.1">ChangeDetectorRef</span></code><span class="koboSpan" id="kobo.1011.1"> service from Angular, we were able to improve the overall performance of our </span><code class="inlineCode"><span class="koboSpan" id="kobo.1012.1">UserCardComponent</span></code><span class="koboSpan" id="kobo.1013.1">. </span><span class="koboSpan" id="kobo.1013.2">Not only did we improve it, but we also fully controlled it from the parent component (</span><code class="inlineCode"><span class="koboSpan" id="kobo.1014.1">UsersComponent</span></code><span class="koboSpan" id="kobo.1015.1">) according to our use case. </span><span class="koboSpan" id="kobo.1015.2">Now you know how to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1016.1">ChangeDetectorRef</span></code><span class="koboSpan" id="kobo.1017.1"> service, see the next section to understand how it works.</span></p>
<h2 class="heading-2" id="_idParaDest-416"><span class="koboSpan" id="kobo.1018.1">How it works…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1019.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1020.1">ChangeDetectorRef</span></code><span class="koboSpan" id="kobo.1021.1"> service provides a range of important methods to control change detection in Angular. </span><span class="koboSpan" id="kobo.1021.2">In the recipe, we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1022.1">detach</span></code><span class="koboSpan" id="kobo.1023.1"> method in our component’s (</span><code class="inlineCode"><span class="koboSpan" id="kobo.1024.1">UserCardComponent</span></code><span class="koboSpan" id="kobo.1025.1"> class’s) </span><code class="inlineCode"><span class="koboSpan" id="kobo.1026.1">ngAfterViewInit</span></code><span class="koboSpan" id="kobo.1027.1"> method to detach the Angular change detection mechanism from the component as soon as it is rendered for the first time. </span><span class="koboSpan" id="kobo.1027.2">As a result, no change detection is triggered on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1028.1">UserCardComponent</span></code><span class="koboSpan" id="kobo.1029.1"> class. </span><span class="koboSpan" id="kobo.1029.2">This is because Angular has a change detection tree in which each component is a node. </span><span class="koboSpan" id="kobo.1029.3">When we detach a component from the change detection tree, that component (as a tree node) is detached, and so are its child components (or nodes). </span><span class="koboSpan" id="kobo.1029.4">By doing this, we end up with absolutely no change detection happening for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1030.1">UserCardComponent</span></code><span class="koboSpan" id="kobo.1031.1"> class. </span><span class="koboSpan" id="kobo.1031.2">If there were any other components being used in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1032.1">UserCardComponent</span></code><span class="koboSpan" id="kobo.1033.1">, they would not have the change detection run for them either. </span><span class="koboSpan" id="kobo.1033.2">As a result, when we click the button or focus and blur the input on the users page, nothing is rendered, even after we update the first user’s name as we did in the recipe.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1034.1">Furthermore, when we need to show the changed name of the first user on the view, which requires the Angular change detection mechanism to be triggered, we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1035.1">detectChanges</span></code><span class="koboSpan" id="kobo.1036.1"> method from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1037.1">ChangeDetectorRef</span></code><span class="koboSpan" id="kobo.1038.1"> instance, right after we’ve assigned the updated users array to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1039.1">users</span></code><span class="koboSpan" id="kobo.1040.1"> property in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1041.1">UsersComponent</span></code><span class="koboSpan" id="kobo.1042.1"> class. </span><span class="koboSpan" id="kobo.1042.2">As a result, Angular runs the change detection mechanism, and we see the updated name on the first user card. </span><span class="koboSpan" id="kobo.1042.3">This gives us the ultimate power</span><a id="_idIndexMarker996"/><span class="koboSpan" id="kobo.1043.1"> to decide whether we want to detach</span><a id="_idIndexMarker997"/><span class="koboSpan" id="kobo.1044.1"> the change detection completely, reattach it, or manually run it for the only cases that require change detection.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1045.1">Now that you understand how the recipe works, see the next section for some useful links.</span></p>
<h2 class="heading-2" id="_idParaDest-417"><span class="koboSpan" id="kobo.1046.1">See also</span></h2>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1047.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1048.1">ChangeDetectorRef</span></code><span class="koboSpan" id="kobo.1049.1"> official</span><a id="_idIndexMarker998"/><span class="koboSpan" id="kobo.1050.1"> documentation: </span><a href="https://angular.io/api/core/ChangeDetectorRef "><span class="url"><span class="koboSpan" id="kobo.1051.1">https://angular.io/api/core/ChangeDetectorRef</span></span></a></li>
</ul>
<h1 class="heading-1" id="_idParaDest-418"><span class="koboSpan" id="kobo.1052.1">Running async events outside Angular with runOutsideAngular</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1053.1">Angular runs its change detection</span><a id="_idIndexMarker999"/><span class="koboSpan" id="kobo.1054.1"> mechanism on a couple</span><a id="_idIndexMarker1000"/><span class="koboSpan" id="kobo.1055.1"> of things, including—but not limited to—all browser events, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1056.1">keyup</span></code><span class="koboSpan" id="kobo.1057.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1058.1">keydown</span></code><span class="koboSpan" id="kobo.1059.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1060.1">click</span></code><span class="koboSpan" id="kobo.1061.1">, and so on. </span><span class="koboSpan" id="kobo.1061.2">It also runs change detection on </span><code class="inlineCode"><span class="koboSpan" id="kobo.1062.1">setTimeout</span></code><span class="koboSpan" id="kobo.1063.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1064.1">setInterval</span></code><span class="koboSpan" id="kobo.1065.1">, and Ajax HTTP calls. </span><span class="koboSpan" id="kobo.1065.2">If we had to avoid running change detection on any of these events, we’d have to tell Angular not to trigger change detection on them—for example, if you use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1066.1">setInterval</span></code><span class="koboSpan" id="kobo.1067.1"> method in your Angular component, it will trigger an Angular change detection cycle each time its callback method is called. </span><span class="koboSpan" id="kobo.1067.2">This can lead to a huge amount of change detection cycles and your app might even hang. </span><span class="koboSpan" id="kobo.1067.3">An ideal situation would be to be able to still use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1068.1">setInterval</span></code><span class="koboSpan" id="kobo.1069.1"> method and so on without triggering the change detection. </span><span class="koboSpan" id="kobo.1069.2">In this recipe, you’ll learn how to do exactly that. </span><span class="koboSpan" id="kobo.1069.3">You will learn how to execute code blocks outside of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1070.1">zone.js</span></code><span class="koboSpan" id="kobo.1071.1"> using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1072.1">NgZone</span></code><span class="koboSpan" id="kobo.1073.1"> service, particularly using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1074.1">runOutsideAngular</span></code><span class="koboSpan" id="kobo.1075.1"> method. </span><span class="koboSpan" id="kobo.1075.2">See </span><em class="italic"><span class="koboSpan" id="kobo.1076.1">Figure 12.12</span></em><span class="koboSpan" id="kobo.1077.1"> to understand the structure of the application:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1078.1"><img alt="" role="presentation" src="../Images/B18469_12_12.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1079.1">Figure 12.12: Component hierarchy for the ng-run-outside-angular app</span></p>
<h2 class="heading-2" id="_idParaDest-419"><span class="koboSpan" id="kobo.1080.1">Getting ready</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1081.1">The app that we are</span><a id="_idIndexMarker1001"/><span class="koboSpan" id="kobo.1082.1"> going to work</span><a id="_idIndexMarker1002"/><span class="koboSpan" id="kobo.1083.1"> with resides in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1084.1">start/apps/chapter12/ng-run-outside-angular</span></code><span class="koboSpan" id="kobo.1085.1"> inside the cloned repository:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1086.1">Open the code repository in your code editor.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1087.1">Open the terminal, navigate to the code repository directory, and run the following command to serve the project:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1088.1">npm run serve ng-run-outside-angular
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1089.1">This should open the app in a new browser tab, and you should see the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1090.1"><img alt="" role="presentation" src="../Images/B18469_12_13.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1091.1">Figure 12.13: The ng-run-outside-angular app running on http://localhost:4200</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1092.1">Now that we have the app</span><a id="_idIndexMarker1003"/><span class="koboSpan" id="kobo.1093.1"> running, let’s see the steps</span><a id="_idIndexMarker1004"/><span class="koboSpan" id="kobo.1094.1"> of the recipe in the next section.</span></p>
<h2 class="heading-2" id="_idParaDest-420"><span class="koboSpan" id="kobo.1095.1">How to do it…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1096.1">We have an app that shows a watch. </span><span class="koboSpan" id="kobo.1096.2">However, the change detection right now in the app is not optimal, and we have plenty of room for improvement. </span><span class="koboSpan" id="kobo.1096.3">We’ll try to remove any unnecessary change detection using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1097.1">runOutsideAngular</span></code><span class="koboSpan" id="kobo.1098.1"> method from </span><code class="inlineCode"><span class="koboSpan" id="kobo.1099.1">ngZone</span></code><span class="koboSpan" id="kobo.1100.1">. </span><span class="koboSpan" id="kobo.1100.2">Let us get started:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1101.1">The clock values are constantly updating. </span><span class="koboSpan" id="kobo.1101.2">Thus, we have change detection running for each update cycle. </span><span class="koboSpan" id="kobo.1101.3">Open the Chrome DevTools and switch to the </span><strong class="screenText"><span class="koboSpan" id="kobo.1102.1">Console</span></strong><span class="koboSpan" id="kobo.1103.1"> tab. </span><span class="koboSpan" id="kobo.1103.2">Type </span><strong class="screenText"><span class="koboSpan" id="kobo.1104.1">appLogs</span></strong><span class="koboSpan" id="kobo.1105.1"> and press </span><em class="keystroke"><span class="koboSpan" id="kobo.1106.1">Enter</span></em><span class="koboSpan" id="kobo.1107.1"> to see how many times the change detection has run for </span><code class="inlineCode"><span class="koboSpan" id="kobo.1108.1">WatchComponent</span></code><span class="koboSpan" id="kobo.1109.1"> and for the components rendering hours, minutes, seconds, and milliseconds. </span><span class="koboSpan" id="kobo.1109.2">It should look like this:
    </span><figure class="mediaobject"><span class="koboSpan" id="kobo.1110.1"><img alt="" role="presentation" src="../Images/B18469_12_14.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1111.1">Figure 12.14: The appLogs object reflecting the number of change detection runs</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="2"><span class="koboSpan" id="kobo.1112.1">To measure performance, let’s reduce</span><a id="_idIndexMarker1005"/><span class="koboSpan" id="kobo.1113.1"> our observation span</span><a id="_idIndexMarker1006"/><span class="koboSpan" id="kobo.1114.1"> in terms of time. </span><span class="koboSpan" id="kobo.1114.2">Let us add some code to turn off the interval timer in 4 seconds from the app’s start for the clock. </span><span class="koboSpan" id="kobo.1114.3">Modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1115.1">watch-box.component.ts</span></code><span class="koboSpan" id="kobo.1116.1"> file, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1117.1">...
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.1118.1">@Component</span></span><span class="koboSpan" id="kobo.1119.1">({...})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1120.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1121.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1122.1">WatchBoxComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1123.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1124.1">OnInit</span></span><span class="koboSpan" id="kobo.1125.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1126.1">ngOnInit</span></span><span class="koboSpan" id="kobo.1127.1">(): </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1128.1">void</span></span><span class="koboSpan" id="kobo.1129.1"> {
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1130.1">this</span></span><span class="koboSpan" id="kobo.1131.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1132.1">intervalTimer</span></span><span class="koboSpan" id="kobo.1133.1"> = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1134.1">setInterval</span></span><span class="koboSpan" id="kobo.1135.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.1136.1">() =&gt;</span></span><span class="koboSpan" id="kobo.1137.1"> {
      </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1138.1">this</span></span><span class="koboSpan" id="kobo.1139.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1140.1">timer</span></span><span class="koboSpan" id="kobo.1141.1">();
  }, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1142.1">1</span></span><span class="koboSpan" id="kobo.1143.1">);
    </span><span class="code-highlight"><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1144.1">setTimeout</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1145.1">(</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1146.1">() =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1147.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1148.1">clearInterval</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1149.1">(</span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1150.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1151.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1152.1">intervalTimer</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1153.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1154.1">}, </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1155.1">4000</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1156.1">);</span></strong></span><span class="koboSpan" id="kobo.1157.1">
  }
  ...
</span><span class="koboSpan" id="kobo.1157.2">}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1158.1">Refresh the app and wait for 4 seconds for the clock to stop. </span><span class="koboSpan" id="kobo.1158.2">Then, type </span><code class="inlineCode"><span class="koboSpan" id="kobo.1159.1">appLogs</span></code><span class="koboSpan" id="kobo.1160.1"> multiple times in the </span><strong class="screenText"><span class="koboSpan" id="kobo.1161.1">Console</span></strong><span class="koboSpan" id="kobo.1162.1"> tab, press </span><em class="keystroke"><span class="koboSpan" id="kobo.1163.1">Enter</span></em><span class="koboSpan" id="kobo.1164.1">, and see the results. </span><span class="koboSpan" id="kobo.1164.2">The clock stops but the animation is still running. </span><span class="koboSpan" id="kobo.1164.3">You should see that change detection for the </span><strong class="screenText"><span class="koboSpan" id="kobo.1165.1">watchComponentRender</span></strong><span class="koboSpan" id="kobo.1166.1"> key still increases, as follows:
    </span><figure class="mediaobject"><span class="koboSpan" id="kobo.1167.1"><img alt="" role="presentation" src="../Images/B18469_12_15.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1168.1">Figure 12.15: Change detection still running for the watch component</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.1169.1">Let’s also stop the animation</span><a id="_idIndexMarker1007"/><span class="koboSpan" id="kobo.1170.1"> inside the watch</span><a id="_idIndexMarker1008"/><span class="koboSpan" id="kobo.1171.1"> after 4 seconds. </span><span class="koboSpan" id="kobo.1171.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1172.1">watch.component.ts</span></code><span class="koboSpan" id="kobo.1173.1"> file, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1174.1">...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1175.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1176.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1177.1">WatchComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1178.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1179.1">OnInit</span></span><span class="koboSpan" id="kobo.1180.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1181.1">ngOnInit</span></span><span class="koboSpan" id="kobo.1182.1">(): </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1183.1">void</span></span><span class="koboSpan" id="kobo.1184.1"> {
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1185.1">this</span></span><span class="koboSpan" id="kobo.1186.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1187.1">intervalTimer</span></span><span class="koboSpan" id="kobo.1188.1"> = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1189.1">setInterval</span></span><span class="koboSpan" id="kobo.1190.1">(...}, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1191.1">30</span></span><span class="koboSpan" id="kobo.1192.1">);
    </span><span class="code-highlight"><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1193.1">setTimeout</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1194.1">(</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1195.1">() =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1196.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1197.1">clearInterval</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1198.1">(</span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1199.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1200.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1201.1">intervalTimer</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1202.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1203.1">}, </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1204.1">4000</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1205.1">);</span></strong></span><span class="koboSpan" id="kobo.1206.1">
  }
  ...
</span><span class="koboSpan" id="kobo.1206.2">}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1207.1">Refresh the app and wait for the animation to stop. </span><span class="koboSpan" id="kobo.1207.2">Have a look at the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1208.1">appLogs</span></code><span class="koboSpan" id="kobo.1209.1"> object in the Chrome DevTools. </span><span class="koboSpan" id="kobo.1209.2">You should see that change detection stops for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1210.1">watch</span></code><span class="koboSpan" id="kobo.1211.1"> key, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1212.1"><img alt="" role="presentation" src="../Images/B18469_12_16.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1213.1">Figure 12.16: Change detection stops after we stop the animation interval</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="5"><span class="koboSpan" id="kobo.1214.1">The desired outcome</span><a id="_idIndexMarker1009"/><span class="koboSpan" id="kobo.1215.1"> is to keep running the animation</span><a id="_idIndexMarker1010"/><span class="koboSpan" id="kobo.1216.1"> and the clock and not have additional change detection cycles running. </span><span class="koboSpan" id="kobo.1216.2">For this, let’s just stop the watch for now. </span><span class="koboSpan" id="kobo.1216.3">To do that, update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1217.1">watch-box.component.ts</span></code><span class="koboSpan" id="kobo.1218.1"> file, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1219.1">...
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.1220.1">@Component</span></span><span class="koboSpan" id="kobo.1221.1">({...})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1222.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1223.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1224.1">WatchBoxComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1225.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1226.1">OnInit</span></span><span class="koboSpan" id="kobo.1227.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1228.1">ngOnInit</span></span><span class="koboSpan" id="kobo.1229.1">(): </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1230.1">void</span></span><span class="koboSpan" id="kobo.1231.1"> {
    </span><span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1232.1">// this.intervalTimer = setInterval(() =&gt; {</span></strong></span>
<span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1233.1">//   this.timer();</span></strong></span>
<span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1234.1">// }, 1);</span></strong></span>
<span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1235.1">// setTimeout(() =&gt; {</span></strong></span>
<span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1236.1">//   clearInterval(this.intervalTimer);</span></strong></span>
<span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1237.1">// }, 4000);</span></strong></span><span class="koboSpan" id="kobo.1238.1">
  }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1239.1">Since we have now stopped the clock, the values for </span><code class="inlineCode"><span class="koboSpan" id="kobo.1240.1">appLogs</span></code><span class="koboSpan" id="kobo.1241.1"> for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1242.1">watchComponentRender</span></code><span class="koboSpan" id="kobo.1243.1"> key are now only based on the animation for these 4 seconds. </span><span class="koboSpan" id="kobo.1243.2">Refresh the app and wait for the animation to stop. </span><span class="koboSpan" id="kobo.1243.3">Type </span><code class="inlineCode"><span class="koboSpan" id="kobo.1244.1">appLogs</span></code><span class="koboSpan" id="kobo.1245.1"> in the Chrome DevTools (in the </span><strong class="screenText"><span class="koboSpan" id="kobo.1246.1">Console</span></strong><span class="koboSpan" id="kobo.1247.1"> tab). </span><span class="koboSpan" id="kobo.1247.2">You should now see a value between </span><code class="inlineCode"><span class="koboSpan" id="kobo.1248.1">250</span></code><span class="koboSpan" id="kobo.1249.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1250.1">270</span></code><span class="koboSpan" id="kobo.1251.1"> for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1252.1">watchComponentRender</span></code><span class="koboSpan" id="kobo.1253.1"> key.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="6"><span class="koboSpan" id="kobo.1254.1">Let us avoid running change detection</span><a id="_idIndexMarker1011"/><span class="koboSpan" id="kobo.1255.1"> on the animation by running the interval outside</span><a id="_idIndexMarker1012"/><span class="koboSpan" id="kobo.1256.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1257.1">ngZone</span></code><span class="koboSpan" id="kobo.1258.1"> service. </span><span class="koboSpan" id="kobo.1258.2">We will use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1259.1">runOutsideAngular</span></code><span class="koboSpan" id="kobo.1260.1"> method for this. </span><span class="koboSpan" id="kobo.1260.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1261.1">watch.component.ts</span></code><span class="koboSpan" id="kobo.1262.1"> file, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1263.1">import</span></span><span class="koboSpan" id="kobo.1264.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1265.1">ViewChild</span></span><span class="koboSpan" id="kobo.1266.1">,
  </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1267.1">inject</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1268.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1269.1">NgZone</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1270.1">,</span></strong></span><span class="koboSpan" id="kobo.1271.1">
} </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1272.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1273.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1274.1">@angular/core'</span></span><span class="koboSpan" id="kobo.1275.1">;
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.1276.1">@Component</span></span><span class="koboSpan" id="kobo.1277.1">({...})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1278.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1279.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1280.1">WatchComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1281.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1282.1">OnInit</span></span><span class="koboSpan" id="kobo.1283.1"> {zone = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1284.1">inject</span></span><span class="koboSpan" id="kobo.1285.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1286.1">NgZone</span></span><span class="koboSpan" id="kobo.1287.1">);
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1288.1">ngOnInit</span></span><span class="koboSpan" id="kobo.1289.1">(): </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1290.1">void</span></span><span class="koboSpan" id="kobo.1291.1"> {
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1292.1">if</span></span><span class="koboSpan" id="kobo.1293.1"> (!</span><span class="hljs-variable"><span class="koboSpan" id="kobo.1294.1">window</span></span><span class="koboSpan" id="kobo.1295.1">[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1296.1">'appLogs'</span></span><span class="koboSpan" id="kobo.1297.1">]) {
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1298.1">window</span></span><span class="koboSpan" id="kobo.1299.1">[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1300.1">'appLogs'</span></span><span class="koboSpan" id="kobo.1301.1">] = {};
  }
  </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1302.1">window</span></span><span class="koboSpan" id="kobo.1303.1">[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1304.1">'appLogs'</span></span><span class="koboSpan" id="kobo.1305.1">][ watchComponentRender] = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1306.1">0</span></span><span class="koboSpan" id="kobo.1307.1">;
    </span><span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1308.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1309.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1310.1">zone</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1311.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1312.1">runOutsideAngular</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1313.1">(</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1314.1">() =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1315.1"> {</span></strong></span><span class="koboSpan" id="kobo.1316.1">
   ...
      </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1317.1">setTimeout</span></span><span class="koboSpan" id="kobo.1318.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.1319.1">() =&gt;</span></span><span class="koboSpan" id="kobo.1320.1"> {
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1321.1">clearInterval</span></span><span class="koboSpan" id="kobo.1322.1">(</span><span class="hljs-variable"><span class="koboSpan" id="kobo.1323.1">this</span></span><span class="koboSpan" id="kobo.1324.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1325.1">intervalTimer</span></span><span class="koboSpan" id="kobo.1326.1">);
      }, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1327.1">4000</span></span><span class="koboSpan" id="kobo.1328.1">);
    </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1329.1">});</span></strong></span><span class="koboSpan" id="kobo.1330.1">
  }
  ...
</span><span class="koboSpan" id="kobo.1330.2">}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1331.1">Refresh the app and wait for about 5 seconds. </span><span class="koboSpan" id="kobo.1331.2">If you check the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1332.1">appLogs</span></code><span class="koboSpan" id="kobo.1333.1"> object now, you should see a decrease in the overall number of change detection runs for each of the properties, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1334.1"><img alt="" role="presentation" src="../Images/B18469_12_17.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1335.1">Figure 12.17: The appLogs object after using runOutsideAngular() in WatchComponent</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1336.1">Yay! </span><span class="koboSpan" id="kobo.1336.2">Notice that the value for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1337.1">watch</span></code><span class="koboSpan" id="kobo.1338.1"> key in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1339.1">appLogs</span></code><span class="koboSpan" id="kobo.1340.1"> object has decreased from about </span><code class="inlineCode"><span class="koboSpan" id="kobo.1341.1">260</span></code><span class="koboSpan" id="kobo.1342.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1343.1">4</span></code><span class="koboSpan" id="kobo.1344.1"> now. </span><span class="koboSpan" id="kobo.1344.2">This means that our animation now does not contribute to change detection at all, and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1345.1">watch</span></code><span class="koboSpan" id="kobo.1346.1"> component only renders 4 times in 4 seconds.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="7"><span class="koboSpan" id="kobo.1347.1">Remove the usage of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1348.1">clearInterval</span></code><span class="koboSpan" id="kobo.1349.1"> from the animation</span><a id="_idIndexMarker1013"/><span class="koboSpan" id="kobo.1350.1"> for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1351.1">WatchComponent</span></code><span class="koboSpan" id="kobo.1352.1"> class. </span><span class="koboSpan" id="kobo.1352.2">Thus, the background</span><a id="_idIndexMarker1014"/><span class="koboSpan" id="kobo.1353.1"> circle (blue circle) animation should start again. </span><span class="koboSpan" id="kobo.1353.2">Modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1354.1">watch.component.ts</span></code><span class="koboSpan" id="kobo.1355.1"> file, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1356.1">...
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.1357.1">@Component</span></span><span class="koboSpan" id="kobo.1358.1">({...})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1359.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1360.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1361.1">WatchComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1362.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1363.1">OnInit</span></span><span class="koboSpan" id="kobo.1364.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1365.1">ngOnInit</span></span><span class="koboSpan" id="kobo.1366.1">(): </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1367.1">void</span></span><span class="koboSpan" id="kobo.1368.1"> {
    ...
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1369.1">this</span></span><span class="koboSpan" id="kobo.1370.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1371.1">ngZone</span></span><span class="koboSpan" id="kobo.1372.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1373.1">runOutsideAngular</span></span><span class="koboSpan" id="kobo.1374.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.1375.1">() =&gt;</span></span><span class="koboSpan" id="kobo.1376.1"> {
      </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1377.1">this</span></span><span class="koboSpan" id="kobo.1378.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1379.1">intervalTimer</span></span><span class="koboSpan" id="kobo.1380.1"> = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1381.1">setInterval</span></span><span class="koboSpan" id="kobo.1382.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.1383.1">() =&gt;</span></span><span class="koboSpan" id="kobo.1384.1"> {
        </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1385.1">this</span></span><span class="koboSpan" id="kobo.1386.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1387.1">animate</span></span><span class="koboSpan" id="kobo.1388.1">();
      }, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1389.1">30</span></span><span class="koboSpan" id="kobo.1390.1">);
      </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1391.1">setTimeout</span></span><span class="koboSpan" id="kobo.1392.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.1393.1">() =&gt;</span></span><span class="koboSpan" id="kobo.1394.1"> { </span><span class="language-xml"><span class="koboSpan" id="kobo.1395.1">&lt;-- remove this</span></span>
<span class="language-xml"><span class="koboSpan" id="kobo.1396.1">        clearInterval(this.intervalTimer);</span></span>
<span class="language-xml"><span class="koboSpan" id="kobo.1397.1">      }, 4000);</span></span>
<span class="language-xml"><span class="koboSpan" id="kobo.1398.1">    });</span></span>
<span class="language-xml"><span class="koboSpan" id="kobo.1399.1">  }</span></span>
<span class="language-xml"><span class="koboSpan" id="kobo.1400.1">  ...</span></span>
<span class="language-xml"><span class="koboSpan" id="kobo.1401.1">}</span></span>
</code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1402.1">Finally, remove the usage</span><a id="_idIndexMarker1015"/><span class="koboSpan" id="kobo.1403.1"> of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1404.1">clearInterval</span></code><span class="koboSpan" id="kobo.1405.1"> from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1406.1">WatchBoxComponent</span></code><span class="koboSpan" id="kobo.1407.1"> class and uncomment </span><code class="inlineCode"><span class="koboSpan" id="kobo.1408.1">setInterval</span></code><span class="koboSpan" id="kobo.1409.1"> to run the clock. </span><span class="koboSpan" id="kobo.1409.2">Update</span><a id="_idIndexMarker1016"/><span class="koboSpan" id="kobo.1410.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1411.1">watch-box.component.ts</span></code><span class="koboSpan" id="kobo.1412.1"> file, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1413.1">import</span></span><span class="koboSpan" id="kobo.1414.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.1415.1">Component</span></span><span class="koboSpan" id="kobo.1416.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1417.1">OnInit</span></span><span class="koboSpan" id="kobo.1418.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1419.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1420.1">'@angular/core'</span></span><span class="koboSpan" id="kobo.1421.1">;
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.1422.1">@Component</span></span><span class="koboSpan" id="kobo.1423.1">({
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1424.1">selector</span></span><span class="koboSpan" id="kobo.1425.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1426.1">'app-watch-box'</span></span><span class="koboSpan" id="kobo.1427.1">,
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1428.1">templateUrl</span></span><span class="koboSpan" id="kobo.1429.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1430.1">'./watch-box.component.html'</span></span><span class="koboSpan" id="kobo.1431.1">,
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1432.1">styleUrls</span></span><span class="koboSpan" id="kobo.1433.1">: [</span><span class="hljs-string"><span class="koboSpan" id="kobo.1434.1">'./watch-box.component.scss'</span></span><span class="koboSpan" id="kobo.1435.1">],
})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1436.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1437.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1438.1">WatchBoxComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1439.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1440.1">OnInit</span></span><span class="koboSpan" id="kobo.1441.1"> {
  name = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1442.1">''</span></span><span class="koboSpan" id="kobo.1443.1">;
  time = {
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1444.1">hours</span></span><span class="koboSpan" id="kobo.1445.1">: </span><span class="hljs-number"><span class="koboSpan" id="kobo.1446.1">0</span></span><span class="koboSpan" id="kobo.1447.1">,
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1448.1">minutes</span></span><span class="koboSpan" id="kobo.1449.1">: </span><span class="hljs-number"><span class="koboSpan" id="kobo.1450.1">0</span></span><span class="koboSpan" id="kobo.1451.1">,
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1452.1">seconds</span></span><span class="koboSpan" id="kobo.1453.1">: </span><span class="hljs-number"><span class="koboSpan" id="kobo.1454.1">0</span></span><span class="koboSpan" id="kobo.1455.1">,
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1456.1">milliseconds</span></span><span class="koboSpan" id="kobo.1457.1">: </span><span class="hljs-number"><span class="koboSpan" id="kobo.1458.1">0</span></span><span class="koboSpan" id="kobo.1459.1">,
  };
  intervalTimer;
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1460.1">constructor</span></span><span class="koboSpan" id="kobo.1461.1">() {}
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1462.1">ngOnInit</span></span><span class="koboSpan" id="kobo.1463.1">(): </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1464.1">void</span></span><span class="koboSpan" id="kobo.1465.1"> {
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1466.1">this</span></span><span class="koboSpan" id="kobo.1467.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1468.1">intervalTimer</span></span><span class="koboSpan" id="kobo.1469.1"> = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1470.1">setInterval</span></span><span class="koboSpan" id="kobo.1471.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.1472.1">() =&gt;</span></span><span class="koboSpan" id="kobo.1473.1"> {
      </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1474.1">this</span></span><span class="koboSpan" id="kobo.1475.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1476.1">timer</span></span><span class="koboSpan" id="kobo.1477.1">();
    }, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1478.1">1</span></span><span class="koboSpan" id="kobo.1479.1">);
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1480.1">setTimeout</span></span><span class="koboSpan" id="kobo.1481.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.1482.1">() =&gt;</span></span><span class="koboSpan" id="kobo.1483.1"> { </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1484.1">//&lt;-- Remove this</span></span>
<span class="language-xml"><span class="koboSpan" id="kobo.1485.1">      clearInterval(this.intervalTimer);</span></span>
<span class="language-xml"><span class="koboSpan" id="kobo.1486.1">    }, 4000);</span></span>
<span class="language-xml"><span class="koboSpan" id="kobo.1487.1">  }</span></span>
<span class="language-xml"><span class="koboSpan" id="kobo.1488.1">  ...</span></span>
<span class="language-xml"><span class="koboSpan" id="kobo.1489.1">}</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1490.1">Refresh the app and check the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1491.1">appLogs</span></code><span class="koboSpan" id="kobo.1492.1"> object after a few seconds, multiple times. </span><span class="koboSpan" id="kobo.1492.2">You should see something like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1493.1"><img alt="" role="presentation" src="../Images/B18469_12_18.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1494.1">Figure 12.18: The appLogs object after performance optimization with runOutsideAngular()</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1495.1">Looking at the preceding screenshot, you might ask, “</span><em class="italic"><span class="koboSpan" id="kobo.1496.1">Ahsan! </span><span class="koboSpan" id="kobo.1496.2">What is this? </span><span class="koboSpan" id="kobo.1496.3">We still have an enormous number for the change detection runs for the </span></em><code class="inlineCode"><span class="koboSpan" id="kobo.1497.1">watchComponentRender</span></code><em class="italic"><span class="koboSpan" id="kobo.1498.1"> key compared to the milliseconds passed. </span><span class="koboSpan" id="kobo.1498.2">How is this performant exactly?</span></em><span class="koboSpan" id="kobo.1499.1">” Glad you asked! </span><span class="koboSpan" id="kobo.1499.2">I will tell you why in the </span><em class="italic"><span class="koboSpan" id="kobo.1500.1">How it works…</span></em><span class="koboSpan" id="kobo.1501.1"> section.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="9"><span class="koboSpan" id="kobo.1502.1">As a last step, stop</span><a id="_idIndexMarker1017"/><span class="koboSpan" id="kobo.1503.1"> the Angular server and run the following</span><a id="_idIndexMarker1018"/><span class="koboSpan" id="kobo.1504.1"> command to start the server in production mode:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1505.1">npm run serve:prod ng-run-outside-angular
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1506.1">Navigate to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1507.1">https://localhost:4200</span></code><span class="koboSpan" id="kobo.1508.1"> again. </span><span class="koboSpan" id="kobo.1508.2">Wait for a few seconds and then check the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1509.1">appLogs</span></code><span class="koboSpan" id="kobo.1510.1"> object in the </span><strong class="screenText"><span class="koboSpan" id="kobo.1511.1">Console</span></strong><span class="koboSpan" id="kobo.1512.1"> tab multiple times. </span><span class="koboSpan" id="kobo.1512.2">You should see the object, as follows:</span></li>
</ol>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1513.1"><img alt="" role="presentation" src="../Images/B18469_12_19.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1514.1">Figure 12.19: The appLogs object using the production build</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1515.1">Boom! </span><span class="koboSpan" id="kobo.1515.2">If you look at the preceding screenshot, you should see that the change detection run count for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1516.1">watchComponentRender</span></code><span class="koboSpan" id="kobo.1517.1"> key is always just a few cycles more than the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1518.1">milliseconds</span></code><span class="koboSpan" id="kobo.1519.1"> key. </span><span class="koboSpan" id="kobo.1519.2">This means that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1520.1">WatchComponent</span></code><span class="koboSpan" id="kobo.1521.1"> class is (almost) only re-rendered whenever we have the value</span><a id="_idIndexMarker1019"/><span class="koboSpan" id="kobo.1522.1"> of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1523.1">@Input()</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.1524.1">milliseconds</span></code><span class="koboSpan" id="kobo.1525.1"> binding updated. </span><span class="koboSpan" id="kobo.1525.2">But why a few cycles</span><a id="_idIndexMarker1020"/><span class="koboSpan" id="kobo.1526.1"> more? </span><span class="koboSpan" id="kobo.1526.2">See the next section to understand how it works!</span></p>
<h2 class="heading-2" id="_idParaDest-421"><span class="koboSpan" id="kobo.1527.1">How it works…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1528.1">In this recipe, we begin by looking at the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1529.1">appLogs</span></code><span class="koboSpan" id="kobo.1530.1"> object, which contains some key-value pairs. </span><span class="koboSpan" id="kobo.1530.2">The value for each key-value pair represents the number of times Angular ran change detection for a particular component. </span><span class="koboSpan" id="kobo.1530.3">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1531.1">hours</span></code><span class="koboSpan" id="kobo.1532.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1533.1">milliseconds</span></code><span class="koboSpan" id="kobo.1534.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1535.1">minutes</span></code><span class="koboSpan" id="kobo.1536.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1537.1">seconds</span></code><span class="koboSpan" id="kobo.1538.1"> keys represent the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1539.1">WatchTimeComponent</span></code><span class="koboSpan" id="kobo.1540.1"> instance for each of the values shown on the clock. </span><span class="koboSpan" id="kobo.1540.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1541.1">watchComponentRender</span></code><span class="koboSpan" id="kobo.1542.1"> key represents the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1543.1">WatchComponent</span></code><span class="koboSpan" id="kobo.1544.1"> instance’s change detection cycles.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1545.1">At the beginning of the recipe, we see that the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1546.1">watch</span></code><span class="koboSpan" id="kobo.1547.1"> key is more than twice the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1548.1">milliseconds</span></code><span class="koboSpan" id="kobo.1549.1"> key. </span><span class="koboSpan" id="kobo.1549.2">Why do we care about the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1550.1">milliseconds</span></code><span class="koboSpan" id="kobo.1551.1"> key at all? </span><span class="koboSpan" id="kobo.1551.2">Because the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1552.1">@Input()</span></code><span class="koboSpan" id="kobo.1553.1"> attribute binding </span><code class="inlineCode"><span class="koboSpan" id="kobo.1554.1">milliseconds</span></code><span class="koboSpan" id="kobo.1555.1"> changes most frequently in our application—that is, it changes every 1 </span><strong class="keyWord"><span class="koboSpan" id="kobo.1556.1">Millisecond</span></strong><span class="koboSpan" id="kobo.1557.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.1558.1">ms</span></strong><span class="koboSpan" id="kobo.1559.1">). </span><span class="koboSpan" id="kobo.1559.2">The second most frequently changed values are the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1560.1">xCoordinate</span></code><span class="koboSpan" id="kobo.1561.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1562.1">yCoordinate</span></code><span class="koboSpan" id="kobo.1563.1"> properties within the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1564.1">WatchComponent</span></code><span class="koboSpan" id="kobo.1565.1"> class, which change every 30 ms. </span><span class="koboSpan" id="kobo.1565.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1566.1">xCoordinate</span></code><span class="koboSpan" id="kobo.1567.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1568.1">yCoordinate</span></code><span class="koboSpan" id="kobo.1569.1"> values are not bound directly to the template (the HTML) because they change the </span><strong class="keyWord"><span class="koboSpan" id="kobo.1570.1">CSS</span></strong><span class="koboSpan" id="kobo.1571.1"> variables of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1572.1">stopWatch</span></code><span class="koboSpan" id="kobo.1573.1"> view child. </span><span class="koboSpan" id="kobo.1573.2">This happens inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1574.1">animate</span></code><span class="koboSpan" id="kobo.1575.1"> method, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1576.1">el.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1577.1">style</span></span><span class="koboSpan" id="kobo.1578.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1579.1">setProperty</span></span><span class="koboSpan" id="kobo.1580.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1581.1">'--x'</span></span><span class="koboSpan" id="kobo.1582.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1583.1">`</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1584.1">${</span></span><span class="hljs-variable"><span class="koboSpan" id="kobo.1585.1">this</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1586.1">.xCoordinate}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1587.1">px`</span></span><span class="koboSpan" id="kobo.1588.1">);
el.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1589.1">style</span></span><span class="koboSpan" id="kobo.1590.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1591.1">setProperty</span></span><span class="koboSpan" id="kobo.1592.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1593.1">'--y'</span></span><span class="koboSpan" id="kobo.1594.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1595.1">`</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1596.1">${</span></span><span class="hljs-variable"><span class="koboSpan" id="kobo.1597.1">this</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1598.1">.yCoordinate}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1599.1">px`</span></span><span class="koboSpan" id="kobo.1600.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1601.1">Thus, changing these values</span><a id="_idIndexMarker1021"/><span class="koboSpan" id="kobo.1602.1"> should not trigger change</span><a id="_idIndexMarker1022"/><span class="koboSpan" id="kobo.1603.1"> detection. </span><span class="koboSpan" id="kobo.1603.2">We begin by limiting the testing time to run the clock, using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1604.1">clearInterval</span></code><span class="koboSpan" id="kobo.1605.1"> method in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1606.1">WatchBoxComponent</span></code><span class="koboSpan" id="kobo.1607.1"> class so that the clock stops within 4 seconds, and we can evaluate the numbers. </span><span class="koboSpan" id="kobo.1607.2">In </span><em class="italic"><span class="koboSpan" id="kobo.1608.1">Figure 12.15</span></em><span class="koboSpan" id="kobo.1609.1">, we see that even after the clock stops, the change detection mechanism keeps triggering for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1610.1">WatchComponent</span></code><span class="koboSpan" id="kobo.1611.1"> class. </span><span class="koboSpan" id="kobo.1611.2">This increases the count for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1612.1">watch</span></code><span class="koboSpan" id="kobo.1613.1"> key in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1614.1">appLogs</span></code><span class="koboSpan" id="kobo.1615.1"> object as time passes. </span><span class="koboSpan" id="kobo.1615.2">We then stop the animation by using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1616.1">clearInterval</span></code><span class="koboSpan" id="kobo.1617.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1618.1">WatchComponent</span></code><span class="koboSpan" id="kobo.1619.1"> class. </span><span class="koboSpan" id="kobo.1619.2">This stops the background (blue circle) animation after 4 seconds as well. </span><span class="koboSpan" id="kobo.1619.3">In </span><em class="italic"><span class="koboSpan" id="kobo.1620.1">Figure 12.16</span></em><span class="koboSpan" id="kobo.1621.1">, we see that the count for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1622.1">watch</span></code><span class="koboSpan" id="kobo.1623.1"> key stops increasing after the animation stops.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1624.1">We then try to see the count of change detection only based on the animation. </span><span class="koboSpan" id="kobo.1624.2">In </span><em class="italic"><span class="koboSpan" id="kobo.1625.1">step 6</span></em><span class="koboSpan" id="kobo.1626.1">, we stop the clock. </span><span class="koboSpan" id="kobo.1626.2">Therefore, we only get a count based on the animation in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1627.1">appLogs</span></code><span class="koboSpan" id="kobo.1628.1"> object for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1629.1">watch</span></code><span class="koboSpan" id="kobo.1630.1"> key, which is a value between </span><code class="inlineCode"><span class="koboSpan" id="kobo.1631.1">250</span></code><span class="koboSpan" id="kobo.1632.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1633.1">270</span></code><span class="koboSpan" id="kobo.1634.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1635.1">We then introduce the magic </span><code class="inlineCode"><span class="koboSpan" id="kobo.1636.1">runOutsideAngular</span></code><span class="koboSpan" id="kobo.1637.1"> method into our code. </span><span class="koboSpan" id="kobo.1637.2">This method is part of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1638.1">NgZone</span></code><span class="koboSpan" id="kobo.1639.1"> service. </span><span class="koboSpan" id="kobo.1639.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1640.1">NgZone</span></code><span class="koboSpan" id="kobo.1641.1"> service is packaged with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1642.1">@angular/core</span></code><span class="koboSpan" id="kobo.1643.1"> package. </span><span class="koboSpan" id="kobo.1643.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1644.1">runOutsideAngular</span></code><span class="koboSpan" id="kobo.1645.1"> method accepts a method as a parameter. </span><span class="koboSpan" id="kobo.1645.2">This method is executed outside the Angular zone. </span><span class="koboSpan" id="kobo.1645.3">This means that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1646.1">setTimeout</span></code><span class="koboSpan" id="kobo.1647.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1648.1">setInterval</span></code><span class="koboSpan" id="kobo.1649.1"> methods used inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1650.1">runOutsideAngular</span></code><span class="koboSpan" id="kobo.1651.1"> method do not trigger the Angular change detection cycle. </span><span class="koboSpan" id="kobo.1651.2">But technically, why are we running this </span><code class="inlineCode"><span class="koboSpan" id="kobo.1652.1">setInterval</span></code><span class="koboSpan" id="kobo.1653.1"> outside the zone? </span><span class="koboSpan" id="kobo.1653.2">Because our interval calls the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1654.1">animate</span></code><span class="koboSpan" id="kobo.1655.1"> method, which updates the CSS variables </span><code class="inlineCode"><span class="koboSpan" id="kobo.1656.1">--x</span></code><span class="koboSpan" id="kobo.1657.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1658.1">--y</span></code><span class="koboSpan" id="kobo.1659.1">. </span><span class="koboSpan" id="kobo.1659.2">And since they automatically trigger the animation and no other property of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1660.1">WatchComponent</span></code><span class="koboSpan" id="kobo.1661.1"> class must be shown in the UI (requiring a re-render), we can move this code to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1662.1">runOutsideAngular</span></code><span class="koboSpan" id="kobo.1663.1"> method. </span><span class="koboSpan" id="kobo.1663.2">You can see in </span><em class="italic"><span class="koboSpan" id="kobo.1664.1">Figure 12.17</span></em><span class="koboSpan" id="kobo.1665.1"> that the count drops to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1666.1">4</span></code><span class="koboSpan" id="kobo.1667.1"> after using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1668.1">runOutsideAngular</span></code><span class="koboSpan" id="kobo.1669.1"> method.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1670.1">We then remove the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1671.1">clearInterval</span></code><span class="koboSpan" id="kobo.1672.1"> usage from both the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1673.1">WatchBoxComponent</span></code><span class="koboSpan" id="kobo.1674.1"> and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1675.1">WatchComponent</span></code><span class="koboSpan" id="kobo.1676.1"> classes—that is, to run the clock and the background (blue circle) animation again, as we did in the beginning. </span><span class="koboSpan" id="kobo.1676.2">In </span><em class="italic"><span class="koboSpan" id="kobo.1677.1">Figure 12.18</span></em><span class="koboSpan" id="kobo.1678.1">, we see that the count for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1679.1">watch</span></code><span class="koboSpan" id="kobo.1680.1"> key is around twice the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1681.1">milliseconds</span></code><span class="koboSpan" id="kobo.1682.1"> key. </span><span class="koboSpan" id="kobo.1682.2">Now, why exactly is it that it’s around double? </span><span class="koboSpan" id="kobo.1682.3">This is because, in development mode, Angular runs the change detection mechanism </span><em class="italic"><span class="koboSpan" id="kobo.1683.1">twice</span></em><span class="koboSpan" id="kobo.1684.1"> to ensure there are no </span><em class="italic"><span class="koboSpan" id="kobo.1685.1">side effects</span></em><span class="koboSpan" id="kobo.1686.1">. </span><span class="koboSpan" id="kobo.1686.2">For example, an update to a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1687.1">state</span></code><span class="koboSpan" id="kobo.1688.1"> property initiating a change detection in another (child) component, and so on. </span><span class="koboSpan" id="kobo.1688.2">Therefore, in </span><em class="italic"><span class="koboSpan" id="kobo.1689.1">step 9</span></em><span class="koboSpan" id="kobo.1690.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.1691.1">step 10</span></em><span class="koboSpan" id="kobo.1692.1">, we run the application in production mode, and in </span><em class="italic"><span class="koboSpan" id="kobo.1693.1">Figure 12.19</span></em><span class="koboSpan" id="kobo.1694.1">, we see that the value for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1695.1">watch</span></code><span class="koboSpan" id="kobo.1696.1"> key is just a few cycles greater than the value for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1697.1">milliseconds</span></code><span class="koboSpan" id="kobo.1698.1"> key, which means that the animation does not trigger any change detection for our application anymore.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1699.1">But why does the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1700.1">watchComponentRender</span></code><span class="koboSpan" id="kobo.1701.1"> key have a few more cycles compared to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1702.1">milliseconds</span></code><span class="koboSpan" id="kobo.1703.1"> key? </span><span class="koboSpan" id="kobo.1703.2">That is because the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1704.1">WatchComponent</span></code><span class="koboSpan" id="kobo.1705.1"> is the parent component of the component displaying milliseconds (</span><code class="inlineCode"><span class="koboSpan" id="kobo.1706.1">WatchTimeComponent</span></code><span class="koboSpan" id="kobo.1707.1">). </span><span class="koboSpan" id="kobo.1707.2">There could be a few change detection cycles based on browser</span><a id="_idIndexMarker1023"/><span class="koboSpan" id="kobo.1708.1"> interactions, but if you refresh the app and have no interaction at all with the app, the difference between </span><code class="inlineCode"><span class="koboSpan" id="kobo.1709.1">watchComponentRender</span></code><span class="koboSpan" id="kobo.1710.1"> to the milliseconds count would</span><a id="_idIndexMarker1024"/><span class="koboSpan" id="kobo.1711.1"> be as low as one change detection cycle in production mode.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1712.1">Brilliant, isn’t it? </span><span class="koboSpan" id="kobo.1712.2">If you find this recipe useful, do let me know on my socials.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1713.1">Now that you understand how it works, see the next section for further reading.</span></p>
<h2 class="heading-2" id="_idParaDest-422"><span class="koboSpan" id="kobo.1714.1">See also</span></h2>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1715.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1716.1">NgZone</span></code><span class="koboSpan" id="kobo.1717.1"> official </span><a id="_idIndexMarker1025"/><span class="koboSpan" id="kobo.1718.1">documentation: </span><a href="https://angular.io/api/core/NgZone"><span class="url"><span class="koboSpan" id="kobo.1719.1">https://angular.io/api/core/NgZone</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1720.1">Angular </span><code class="inlineCode"><span class="koboSpan" id="kobo.1721.1">ChangeDetectorRef</span></code><span class="koboSpan" id="kobo.1722.1"> official </span><a id="_idIndexMarker1026"/><span class="koboSpan" id="kobo.1723.1">documentation: </span><a href="https://angular.io/api/core/ChangeDetectorRef"><span class="url"><span class="koboSpan" id="kobo.1724.1">https://angular.io/api/core/ChangeDetectorRef</span></span></a></li>
</ul>
<h1 class="heading-1" id="_idParaDest-423"><span class="koboSpan" id="kobo.1725.1">Using trackBy for lists with *ngFor</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1726.1">Lists are an essential part of most of the apps</span><a id="_idIndexMarker1027"/><span class="koboSpan" id="kobo.1727.1"> we build today. </span><span class="koboSpan" id="kobo.1727.2">If you’re building an Angular</span><a id="_idIndexMarker1028"/><span class="koboSpan" id="kobo.1728.1"> app, there’s a great chance you will use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1729.1">*ngFor</span></code><span class="koboSpan" id="kobo.1730.1"> directive at some point for rendering lists. </span><span class="koboSpan" id="kobo.1730.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1731.1">*ngFor</span></code><span class="koboSpan" id="kobo.1732.1"> directive allows us to loop over arrays or objects generating HTML for each item. </span><span class="koboSpan" id="kobo.1732.2">However, if we are rendering large lists, using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1733.1">*ngFor</span></code><span class="koboSpan" id="kobo.1734.1"> without caution may cause performance issues, especially when the source for </span><code class="inlineCode"><span class="koboSpan" id="kobo.1735.1">*ngFor</span></code><span class="koboSpan" id="kobo.1736.1"> is changed completely (the entire array is replaced). </span><span class="koboSpan" id="kobo.1736.2">In this recipe, we’ll learn how we can improve the performance of lists using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1737.1">*ngFor</span></code><span class="koboSpan" id="kobo.1738.1"> directive</span><a id="_idIndexMarker1029"/><span class="koboSpan" id="kobo.1739.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1740.1">trackBy</span></code><span class="koboSpan" id="kobo.1741.1"> function. </span><span class="koboSpan" id="kobo.1741.2">Let’s get</span><a id="_idIndexMarker1030"/><span class="koboSpan" id="kobo.1742.1"> started.</span></p>
<h2 class="heading-2" id="_idParaDest-424"><span class="koboSpan" id="kobo.1743.1">Getting ready</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1744.1">The app that we are going to work with resides in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1745.1">start/apps/chapter12/ng-for-trackby</span></code><span class="koboSpan" id="kobo.1746.1"> inside the cloned repository:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1747.1">Open the code repository in your code editor.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1748.1">Open the terminal, navigate to the code repository directory, and run the following command to serve the project:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1749.1">npm run serve ng-for-trackby
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1750.1">This should open the app in a new browser tab, and you should see the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1751.1"><img alt="" role="presentation" src="../Images/B18469_12_20.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1752.1">Figure 12.20: The ng-for-trackby app running on http://localhost:4200</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1753.1">Now that we have the app running, let’s see the steps of the recipe in the next section.</span></p>
<h2 class="heading-2" id="_idParaDest-425"><span class="koboSpan" id="kobo.1754.1">How to do it…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1755.1">We have an app that has a list of 10,000 users displayed on the view. </span><span class="koboSpan" id="kobo.1755.2">Since we’re not using a virtual scroll (from </span><code class="inlineCode"><span class="koboSpan" id="kobo.1756.1">@angular/material</span></code><span class="koboSpan" id="kobo.1757.1">, for example), and are using a standard </span><code class="inlineCode"><span class="koboSpan" id="kobo.1758.1">*ngFor</span></code><span class="koboSpan" id="kobo.1759.1"> list, we do face some performance issues now. </span><span class="koboSpan" id="kobo.1759.2">Notice that when you refresh the app, even after the loader is hidden, you see a blank white box for about 2–3 seconds before the list appears. </span><span class="koboSpan" id="kobo.1759.3">If your machine is stuck for too long, you can modify the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1760.1">USERS_LIMIT</span></code><span class="koboSpan" id="kobo.1761.1"> variable in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1762.1">data.service.ts</span></code><span class="koboSpan" id="kobo.1763.1"> file. </span><span class="koboSpan" id="kobo.1763.2">Let us start the recipe to reproduce the performance issues, and we will fix them afterward:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1764.1">First, open the Chrome DevTools</span><a id="_idIndexMarker1031"/><span class="koboSpan" id="kobo.1765.1"> and look at the </span><strong class="screenText"><span class="koboSpan" id="kobo.1766.1">Console</span></strong><span class="koboSpan" id="kobo.1767.1"> tab. </span><span class="koboSpan" id="kobo.1767.2">You should</span><a id="_idIndexMarker1032"/><span class="koboSpan" id="kobo.1768.1"> see the </span><strong class="screenText"><span class="koboSpan" id="kobo.1769.1">User card created</span></strong><span class="koboSpan" id="kobo.1770.1"> message logged 10,000 times. </span><span class="koboSpan" id="kobo.1770.2">This message will be logged any time a user card component (instance of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1771.1">UserCardComponent</span></code><span class="koboSpan" id="kobo.1772.1"> class) is created/initiated.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1773.1">Now, delete the first item by using the </span><em class="italic"><span class="koboSpan" id="kobo.1774.1">delete</span></em><span class="koboSpan" id="kobo.1775.1"> button on the card. </span><span class="koboSpan" id="kobo.1775.2">You should see the same message (</span><strong class="screenText"><span class="koboSpan" id="kobo.1776.1">User card created</span></strong><span class="koboSpan" id="kobo.1777.1">) logged again 9,999 times now, as shown in the following screenshot. </span><span class="koboSpan" id="kobo.1777.2">This means we recreate the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1778.1">list-item</span></code><span class="koboSpan" id="kobo.1779.1"> component for the remaining 9,999 items:
    </span><figure class="mediaobject"><span class="koboSpan" id="kobo.1780.1"><img alt="" role="presentation" src="../Images/B18469_12_21.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1781.1">Figure 12.21: Logs shown again after deleting an item</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.1782.1">Now, click the first item (this updates the first item according to the existing code). </span><span class="koboSpan" id="kobo.1782.2">You should again see the </span><strong class="screenText"><span class="koboSpan" id="kobo.1783.1">User card created</span></strong><span class="koboSpan" id="kobo.1784.1"> logs, as shown in </span><em class="italic"><span class="koboSpan" id="kobo.1785.1">Figure 12.22</span></em><span class="koboSpan" id="kobo.1786.1">. </span><span class="koboSpan" id="kobo.1786.2">This means we recreate all the 9,999 list items when updating any item from the list. </span><span class="koboSpan" id="kobo.1786.3">You will notice that the update to the first item’s name in the </span><strong class="keyWord"><span class="koboSpan" id="kobo.1787.1">User Interface</span></strong><span class="koboSpan" id="kobo.1788.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.1789.1">UI</span></strong><span class="koboSpan" id="kobo.1790.1">) is reflected in about 2–3 seconds:
    </span><figure class="mediaobject"><span class="koboSpan" id="kobo.1791.1"><img alt="" role="presentation" src="../Images/B18469_12_22.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1792.1">Figure 12.22: Logs shown again after updating an item</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.1793.1">Now, let’s fix the performance</span><a id="_idIndexMarker1033"/><span class="koboSpan" id="kobo.1794.1"> issue by using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1795.1">trackBy</span></code><span class="koboSpan" id="kobo.1796.1"> function. </span><span class="koboSpan" id="kobo.1796.2">Open</span><a id="_idIndexMarker1034"/><span class="koboSpan" id="kobo.1797.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1798.1">users-list.component.ts</span></code><span class="koboSpan" id="kobo.1799.1"> file and update it, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1800.1">...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1801.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1802.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1803.1">UsersListComponent</span></span><span class="koboSpan" id="kobo.1804.1"> {
  </span><span class="hljs-meta"><span class="koboSpan" id="kobo.1805.1">@Input</span></span><span class="koboSpan" id="kobo.1806.1">() </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1807.1">listItems</span></span><span class="koboSpan" id="kobo.1808.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.1809.1">AppUserCard</span></span><span class="koboSpan" id="kobo.1810.1">[] = [];
  </span><span class="hljs-meta"><span class="koboSpan" id="kobo.1811.1">@Output</span></span><span class="koboSpan" id="kobo.1812.1">() itemClicked = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1813.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1814.1">EventEmitter</span></span><span class="koboSpan" id="kobo.1815.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1816.1">AppUserCard</span></span><span class="koboSpan" id="kobo.1817.1">&gt;();
  </span><span class="hljs-meta"><span class="koboSpan" id="kobo.1818.1">@Output</span></span><span class="koboSpan" id="kobo.1819.1">() itemDeleted = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1820.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1821.1">EventEmitter</span></span><span class="koboSpan" id="kobo.1822.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1823.1">AppUserCard</span></span><span class="koboSpan" id="kobo.1824.1">&gt;();
  </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1825.1">trackByFn</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1826.1">(</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1827.1">_index</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1828.1">: </span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1829.1">number</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1830.1">, </span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1831.1">item</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1832.1">: </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1833.1">AppUserCard</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1834.1">) {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1835.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1836.1"> item.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1837.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1838.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1839.1">}</span></strong></span><span class="koboSpan" id="kobo.1840.1">
}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1841.1">Now, update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1842.1">users-list.component.html</span></code><span class="koboSpan" id="kobo.1843.1"> file to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1844.1">trackByFn</span></code><span class="koboSpan" id="kobo.1845.1"> method we just created, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.1846.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1847.1">h4</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1848.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1849.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1850.1">"heading"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1851.1">&gt;</span></span><span class="koboSpan" id="kobo.1852.1">Our trusted customers</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1853.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1854.1">h4</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1855.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1856.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1857.1">ul</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1858.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1859.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1860.1">"list list-group p-2"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1861.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1862.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1863.1">li</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1864.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1865.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1866.1">"list__item list-group-item"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1867.1"> *</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1868.1">ngFor</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1869.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1870.1">"let item of</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1871.1">    listItems;</span></span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1872.1"> trackBy: trackByFn</span></strong></span><span class="hljs-string"><span class="koboSpan" id="kobo.1873.1">"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1874.1">&gt;</span></span><span class="koboSpan" id="kobo.1875.1">
    ...
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1876.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1877.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1878.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1879.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1880.1">ul</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1881.1">&gt;</span></span>
</code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1882.1">Now, refresh the app, delete the first item, and then click the (new) first list item to update it. </span><span class="koboSpan" id="kobo.1882.2">You will notice that the item is updated immediately, and we do not log the </span><strong class="screenText"><span class="koboSpan" id="kobo.1883.1">User card created</span></strong><span class="koboSpan" id="kobo.1884.1"> message again anymore, as shown in </span><em class="italic"><span class="koboSpan" id="kobo.1885.1">Figure 12.23</span></em><span class="koboSpan" id="kobo.1886.1">:
    </span><figure class="mediaobject"><span class="koboSpan" id="kobo.1887.1"><img alt="" role="presentation" src="../Images/B18469_12_23.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1888.1">Figure 12.23: No further logs after updating an item using the trackBy function</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1889.1">Great! </span><span class="koboSpan" id="kobo.1889.2">You now know how to use</span><a id="_idIndexMarker1035"/><span class="koboSpan" id="kobo.1890.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1891.1">trackBy</span></code><span class="koboSpan" id="kobo.1892.1"> function with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1893.1">*ngFor</span></code><span class="koboSpan" id="kobo.1894.1"> directive</span><a id="_idIndexMarker1036"/><span class="koboSpan" id="kobo.1895.1"> to optimize the performance of lists in Angular. </span><span class="koboSpan" id="kobo.1895.2">To understand all the magic behind the recipe, see the next section.</span></p>
<h2 class="heading-2" id="_idParaDest-426"><span class="koboSpan" id="kobo.1896.1">How it works…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1897.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1898.1">*ngFor</span></code><span class="koboSpan" id="kobo.1899.1"> directive allows us to loop over </span><strong class="keyWord"><span class="koboSpan" id="kobo.1900.1">iterables</span></strong><span class="koboSpan" id="kobo.1901.1"> and render multiple HTML elements or components. </span><span class="koboSpan" id="kobo.1901.2">When working with an array of primitives (Boolean, string, or number values), Angular tracks each item by its value to identify elements. </span><span class="koboSpan" id="kobo.1901.3">However, when dealing with objects, Angular tracks them by memory location, like how JavaScript handles object equality checks. </span><span class="koboSpan" id="kobo.1901.4">This means that if you just change a property in an object of the array, it will not re-render the template for that object. </span><span class="koboSpan" id="kobo.1901.5">However, if you provide a new object in its place (different reference in memory), the content for the item will be re-rendered. </span><span class="koboSpan" id="kobo.1901.6">This is what we do in this recipe to reproduce the performance issue. </span><span class="koboSpan" id="kobo.1901.7">Since we replace the entire array when we update or delete an item, Angular treats the array as a new resource to iterate over. </span><span class="koboSpan" id="kobo.1901.8">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1902.1">data.service.ts</span></code><span class="koboSpan" id="kobo.1903.1"> file, we have the following code for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1904.1">updateUser</span></code><span class="koboSpan" id="kobo.1905.1"> method inside the service named </span><code class="inlineCode"><span class="koboSpan" id="kobo.1906.1">DataService</span></code><span class="koboSpan" id="kobo.1907.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-title"><span class="koboSpan" id="kobo.1908.1">updateUser</span></span><span class="koboSpan" id="kobo.1909.1">(</span><span class="hljs-attr"><span class="koboSpan" id="kobo.1910.1">updatedUser</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1911.1">: </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.1912.1">AppUserCard</span></span><span class="koboSpan" id="kobo.1913.1">) {
  </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1914.1">this</span></span><span class="koboSpan" id="kobo.1915.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1916.1">users</span></span><span class="koboSpan" id="kobo.1917.1"> = </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1918.1">this</span></span><span class="koboSpan" id="kobo.1919.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1920.1">users</span></span><span class="koboSpan" id="kobo.1921.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1922.1">map</span></span><span class="koboSpan" id="kobo.1923.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.1924.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1925.1">user</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1926.1">) =&gt;</span></span><span class="koboSpan" id="kobo.1927.1"> {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1928.1">if</span></span><span class="koboSpan" id="kobo.1929.1"> (user.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1930.1">id</span></span><span class="koboSpan" id="kobo.1931.1"> === updatedUser.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1932.1">id</span></span><span class="koboSpan" id="kobo.1933.1">) {
      </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1934.1">return</span></span><span class="koboSpan" id="kobo.1935.1"> {
        ...updatedUser,
      };
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1936.1">return</span></span><span class="koboSpan" id="kobo.1937.1"> { ...user };
  });
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1938.1">Notice that we use the object spread operator ( </span><code class="inlineCode"><span class="koboSpan" id="kobo.1939.1">{ … }</span></code><span class="koboSpan" id="kobo.1940.1"> ) to return a new object for each item in the array. </span><span class="koboSpan" id="kobo.1940.2">This ends up telling the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1941.1">*ngFor</span></code><span class="koboSpan" id="kobo.1942.1"> directive to re-render the UI for each item in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1943.1">listItems</span></code><span class="koboSpan" id="kobo.1944.1"> array in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1945.1">UserListComponent</span></code><span class="koboSpan" id="kobo.1946.1"> class. </span><span class="koboSpan" id="kobo.1946.2">Suppose you are already rendering 1,000 users. </span><span class="koboSpan" id="kobo.1946.3">If you search for a term that returns 100 users from the server, ideally, Angular should not re-render those 100 users as they were already rendered in the view. </span><span class="koboSpan" id="kobo.1946.4">Angular, however, would re-render the UI for all the list items because of the following potential reasons (but not limited to these):</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1947.1">The sorting/placement of the users could have changed.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1948.1">The length of the users could have changed.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1949.1">Now, we want to avoid using the object reference as the unique identifier for each list item. </span><span class="koboSpan" id="kobo.1949.2">For our use case, we know that each user’s ID is unique; therefore, we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1950.1">trackBy</span></code><span class="koboSpan" id="kobo.1951.1"> function to tell Angular to use the user’s ID as the unique identifier. </span><span class="koboSpan" id="kobo.1951.2">Now, even if we return a new object for each user after a user update from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1952.1">updateUser</span></code><span class="koboSpan" id="kobo.1953.1"> method (as previously shown), Angular does not re-render </span><a id="_idIndexMarker1037"/><span class="koboSpan" id="kobo.1954.1">all the list items. </span><span class="koboSpan" id="kobo.1954.2">This is because the new objects (users) have the same ID and Angular</span><a id="_idIndexMarker1038"/><span class="koboSpan" id="kobo.1955.1"> uses it to track them. </span><span class="koboSpan" id="kobo.1955.2">Pretty cool, right?</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1956.1">Now that you have learned how the recipe works, see the next section to view a link for further reading.</span></p>
<h2 class="heading-2" id="_idParaDest-427"><span class="koboSpan" id="kobo.1957.1">See also</span></h2>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1958.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1959.1">NgForOf</span></code><span class="koboSpan" id="kobo.1960.1"> official</span><a id="_idIndexMarker1039"/><span class="koboSpan" id="kobo.1961.1"> documentation: </span><a href="https://angular.io/api/common/NgForOf"><span class="url"><span class="koboSpan" id="kobo.1962.1">https://angular.io/api/common/NgForOf</span></span></a></li>
</ul>
<h1 class="heading-1" id="_idParaDest-428"><span class="koboSpan" id="kobo.1963.1">Moving heavy computation to pure pipes</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1964.1">In Angular, we have a particular</span><a id="_idIndexMarker1040"/><span class="koboSpan" id="kobo.1965.1"> way of writing components. </span><span class="koboSpan" id="kobo.1965.2">Since Angular</span><a id="_idIndexMarker1041"/><span class="koboSpan" id="kobo.1966.1"> is heavily opinionated, we already have a lot of guidelines from the community and the Angular team on what to consider when writing components—for example, making HTTP calls directly from a component is considered a </span><em class="italic"><span class="koboSpan" id="kobo.1967.1">not-so-good</span></em><span class="koboSpan" id="kobo.1968.1"> practice. </span><span class="koboSpan" id="kobo.1968.2">Similarly, if we have heavy computation in a component that triggers with each change detection cycle, this is also not considered a good practice. </span><span class="koboSpan" id="kobo.1968.3">Imagine that the view depends upon a transformed version of the data using a computation constantly. </span><span class="koboSpan" id="kobo.1968.4">This would cause a lot of computation and processing for each render cycle. </span><span class="koboSpan" id="kobo.1968.5">One good technique can be to move the heavy computation using Angular (pure) pipes (especially if the computation happens with each change detection cycle).</span></p>
<h2 class="heading-2" id="_idParaDest-429"><span class="koboSpan" id="kobo.1969.1">Getting ready</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1970.1">The app that we are going to work with resides in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1971.1">start/apps/chapter12/ng-pipes-perf</span></code><span class="koboSpan" id="kobo.1972.1"> inside the cloned repository:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1973.1">Open the code repository in your code editor.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1974.1">Open the terminal, navigate to the code repository directory, and run the following command to serve the project:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1975.1">npm run serve ng-pipes-perf
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1976.1">This should open the app in a new browser tab, and you should see the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1977.1"><img alt="" role="presentation" src="../Images/B18469_12_24.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1978.1">Figure 12.24: The ng-pipes-perf app running at http://localhost:4200</span></p> </li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1979.1">Click the button that says </span><strong class="screenText"><span class="koboSpan" id="kobo.1980.1">Click Me</span></strong><span class="koboSpan" id="kobo.1981.1"> Or try to search for some user. </span><span class="koboSpan" id="kobo.1981.2">You’ll see that the app is too slow and gets hung often. </span><span class="koboSpan" id="kobo.1981.3">Now that we have the project served on the browser, let’s see the steps of the recipe in the next section.</span></p>
<h2 class="heading-2" id="_idParaDest-430"><span class="koboSpan" id="kobo.1982.1">How to do it…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1983.1">The app we’re working</span><a id="_idIndexMarker1042"/><span class="koboSpan" id="kobo.1984.1"> with has some performance issues, particularly</span><a id="_idIndexMarker1043"/><span class="koboSpan" id="kobo.1985.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1986.1">UserCardComponent</span></code><span class="koboSpan" id="kobo.1987.1"> class. </span><span class="koboSpan" id="kobo.1987.2">This is because it uses a getter function, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1988.1">randomColor</span></code><span class="koboSpan" id="kobo.1989.1">, to generate a random color for its background. </span><span class="koboSpan" id="kobo.1989.2">Behind the scenes, that function uses a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1990.1">factorial</span></code><span class="koboSpan" id="kobo.1991.1"> function to add more processing time. </span><span class="koboSpan" id="kobo.1991.2">But that is just to demonstrate a component that can cause the UI to hang if there is some complex calculation happening along with multiple change detections being triggered. </span><span class="koboSpan" id="kobo.1991.3">We’re going to add some code to monitor how many times the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1992.1">randomColor</span></code><span class="koboSpan" id="kobo.1993.1"> getter gets called. </span><span class="koboSpan" id="kobo.1993.2">This will show the number of times the change detection in Angular gets triggered by default. </span><span class="koboSpan" id="kobo.1993.3">We will also fix the issue and make it more performant (as much as we can) by detaching the change detector completely from a particular component. </span><span class="koboSpan" id="kobo.1993.4">Let’s get started:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1994.1">First, let’s make sure that the app is just slow enough for your machine that it makes your laptop/PC hang. </span><span class="koboSpan" id="kobo.1994.2">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1995.1">src/app/app.config.ts</span></code><span class="koboSpan" id="kobo.1996.1"> file and adjust the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1997.1">RANDOMIZATION_COUNT</span></code><span class="koboSpan" id="kobo.1998.1"> token from </span><code class="inlineCode"><span class="koboSpan" id="kobo.1999.1">9</span></code><span class="koboSpan" id="kobo.2000.1"> to whatever suits you best.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2001.1">Then, try to search for a user named </span><code class="inlineCode"><span class="koboSpan" id="kobo.2002.1">Irineu</span></code><span class="koboSpan" id="kobo.2003.1"> by entering their name in the search box. </span><span class="koboSpan" id="kobo.2003.2">You’ll notice that the app still hangs and that it takes a few seconds to show the user. </span><span class="koboSpan" id="kobo.2003.3">You’ll also notice that you don’t even see the letters in the search box as you type them. </span><span class="koboSpan" id="kobo.2003.4">That is, there is a delay in rendering.
    </span><p class="normal"><span class="koboSpan" id="kobo.2004.1">Let’s add some logic to the code. </span><span class="koboSpan" id="kobo.2004.2">We’ll check how many times Angular calls the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2005.1">idUsingFactorial</span></code><span class="koboSpan" id="kobo.2006.1"> method when the page loads.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.2007.1">Let’s create a service that we will use to track the number of times a particular user card for a particular person is called. </span><span class="koboSpan" id="kobo.2007.2">Run the following command from the workspace’s root folder to create a service:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2008.1">cd start &amp;&amp; nx g s services/logs --project ng-pipes-perf
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2009.1">Choose </span><code class="inlineCode"><span class="koboSpan" id="kobo.2010.1">@schematics/angular:service</span></code><span class="koboSpan" id="kobo.2011.1"> when asked.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.2012.1">Update the content of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2013.1">src/app/services/logs.service.ts</span></code><span class="koboSpan" id="kobo.2014.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2015.1">import</span></span><span class="koboSpan" id="kobo.2016.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.2017.1">Injectable</span></span><span class="koboSpan" id="kobo.2018.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2019.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2020.1">'@angular/core'</span></span><span class="koboSpan" id="kobo.2021.1">;
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.2022.1">@Injectable</span></span><span class="koboSpan" id="kobo.2023.1">({
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2024.1">providedIn</span></span><span class="koboSpan" id="kobo.2025.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.2026.1">'root'</span></span><span class="koboSpan" id="kobo.2027.1">
})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2028.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2029.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2030.1">LogsService</span></span><span class="koboSpan" id="kobo.2031.1"> {
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2032.1">logs</span></span><span class="koboSpan" id="kobo.2033.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.2034.1">Record</span></span><span class="koboSpan" id="kobo.2035.1">&lt;</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2036.1">string</span></span><span class="koboSpan" id="kobo.2037.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2038.1">number</span></span><span class="koboSpan" id="kobo.2039.1">&gt; = {}
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.2040.1">updateLogEntry</span></span><span class="koboSpan" id="kobo.2041.1">(</span><span class="hljs-attr"><span class="koboSpan" id="kobo.2042.1">email</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2043.1">: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2044.1">string</span></span><span class="koboSpan" id="kobo.2045.1">) {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2046.1">if</span></span><span class="koboSpan" id="kobo.2047.1"> (</span><span class="hljs-variable"><span class="koboSpan" id="kobo.2048.1">this</span></span><span class="koboSpan" id="kobo.2049.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2050.1">logs</span></span><span class="koboSpan" id="kobo.2051.1">[email] === </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2052.1">undefined</span></span><span class="koboSpan" id="kobo.2053.1">) {
      </span><span class="hljs-variable"><span class="koboSpan" id="kobo.2054.1">this</span></span><span class="koboSpan" id="kobo.2055.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2056.1">logs</span></span><span class="koboSpan" id="kobo.2057.1"> = {
        ...</span><span class="hljs-variable"><span class="koboSpan" id="kobo.2058.1">this</span></span><span class="koboSpan" id="kobo.2059.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2060.1">logs</span></span><span class="koboSpan" id="kobo.2061.1">,
        [email]: </span><span class="hljs-number"><span class="koboSpan" id="kobo.2062.1">1</span></span><span class="koboSpan" id="kobo.2063.1">
      }
    } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2064.1">else</span></span><span class="koboSpan" id="kobo.2065.1"> {
      </span><span class="hljs-variable"><span class="koboSpan" id="kobo.2066.1">this</span></span><span class="koboSpan" id="kobo.2067.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2068.1">logs</span></span><span class="koboSpan" id="kobo.2069.1"> = {
        ...</span><span class="hljs-variable"><span class="koboSpan" id="kobo.2070.1">this</span></span><span class="koboSpan" id="kobo.2071.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2072.1">logs</span></span><span class="koboSpan" id="kobo.2073.1">,
        [email]: </span><span class="hljs-variable"><span class="koboSpan" id="kobo.2074.1">this</span></span><span class="koboSpan" id="kobo.2075.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2076.1">logs</span></span><span class="koboSpan" id="kobo.2077.1">[email] + </span><span class="hljs-number"><span class="koboSpan" id="kobo.2078.1">1</span></span><span class="koboSpan" id="kobo.2079.1">
      }
    }
  }
}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.2080.1">Now, inject the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2081.1">LogService</span></code><span class="koboSpan" id="kobo.2082.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2083.1">src/app/component/user-card/user-card.component.ts</span></code><span class="koboSpan" id="kobo.2084.1"> file. </span><span class="koboSpan" id="kobo.2084.2">We will also create</span><a id="_idIndexMarker1044"/><span class="koboSpan" id="kobo.2085.1"> a getter (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2086.1">log</span></code><span class="koboSpan" id="kobo.2087.1">) function</span><a id="_idIndexMarker1045"/><span class="koboSpan" id="kobo.2088.1"> to get the count for the user, and we will update the count whenever the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2089.1">randomColor</span></code><span class="koboSpan" id="kobo.2090.1"> getter is called. </span><span class="koboSpan" id="kobo.2090.2">Update the mentioned file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2091.1">...
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2092.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2093.1"> { </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2094.1">LogsService</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2095.1"> } </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2096.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2097.1">'../../services/logs.service'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2098.1">;</span></strong></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.2099.1">@Component</span></span><span class="koboSpan" id="kobo.2100.1">({...})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2101.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2102.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2103.1">UserCardComponent</span></span><span class="koboSpan" id="kobo.2104.1"> {
  ...
  </span><span class="koboSpan" id="kobo.2104.2">randomizationCount = </span><span class="hljs-title"><span class="koboSpan" id="kobo.2105.1">inject</span></span><span class="koboSpan" id="kobo.2106.1">(</span><span class="hljs-variable"><span class="koboSpan" id="kobo.2107.1">RANDOMIZATION_COUNT</span></span><span class="koboSpan" id="kobo.2108.1">);
  </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2109.1">logsService = </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2110.1">inject</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2111.1">(</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2112.1">LogsService</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2113.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2114.1">get</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2115.1">log</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2116.1">() {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2117.1">return</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2118.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2119.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2120.1">logsService</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2121.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2122.1">logs</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2123.1">[</span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2124.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2125.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2126.1">user</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2127.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2128.1">email</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2129.1">] ?? </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.2130.1">0</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2131.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2132.1">}</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2133.1">get</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2134.1">randomColor</span></span><span class="koboSpan" id="kobo.2135.1">() {
    </span><span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2136.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2137.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2138.1">logsService</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2139.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2140.1">updateLogEntry</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2141.1">(</span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2142.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2143.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2144.1">user</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2145.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2146.1">email</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2147.1">);</span></strong></span><span class="koboSpan" id="kobo.2148.1">
    ...
  </span><span class="koboSpan" id="kobo.2148.2">}
}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.2149.1">Now, we will use the log</span><a id="_idIndexMarker1046"/><span class="koboSpan" id="kobo.2150.1"> in the template of the user card component to show the count. </span><span class="koboSpan" id="kobo.2150.2">Update</span><a id="_idIndexMarker1047"/><span class="koboSpan" id="kobo.2151.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2152.1">src/app/component/user-card/user-card.component.html</span></code><span class="koboSpan" id="kobo.2153.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.2154.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2155.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2156.1"> [</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.2157.1">style.backgroundColor</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2158.1">]=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2159.1">"randomColor"</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.2160.1">...</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2161.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2162.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2163.1">img</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2164.1">...</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2165.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2166.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2167.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2168.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2169.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2170.1">"card-body flex-1"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2171.1">&gt;</span></span><span class="koboSpan" id="kobo.2172.1">...</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2173.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2174.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2175.1">&gt;</span></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2176.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2177.1">div</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2178.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2179.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2180.1">"p-4 bg-slate-900 text-green-300 rounded-md </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2181.1">h-fit"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2182.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2183.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2184.1">div</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2185.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2186.1">Color Generation Count:</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2187.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2188.1">div</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2189.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2190.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2191.1">pre</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2192.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2193.1">{{log}}</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2194.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2195.1">pre</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2196.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2197.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2198.1">div</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2199.1">&gt;</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2200.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2201.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2202.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2203.1">If you look at the application now, you should see the </span><strong class="screenText"><span class="koboSpan" id="kobo.2204.1">Color Generation Count </span></strong><span class="koboSpan" id="kobo.2205.1">as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2206.1"><img alt="" role="presentation" src="../Images/B18469_12_25.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2207.1">Figure 12.25: Color Generation Count being shown on page load</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="7"><span class="koboSpan" id="kobo.2208.1">Now, click the </span><strong class="screenText"><span class="koboSpan" id="kobo.2209.1">Update Irineu’s Name</span></strong><span class="koboSpan" id="kobo.2210.1"> button. </span><span class="koboSpan" id="kobo.2210.2">Then focus (click) the </span><strong class="screenText"><span class="koboSpan" id="kobo.2211.1">Quick Search</span></strong><span class="koboSpan" id="kobo.2212.1"> input and then click outside. </span><span class="koboSpan" id="kobo.2212.2">Repeat this a few times and you should see that the colors are regenerated, even though the cards are not supposed to be re-rendered. </span><em class="italic"><span class="koboSpan" id="kobo.2213.1">Figure 12.26</span></em><span class="koboSpan" id="kobo.2214.1"> shows how it should look:
    </span><figure class="mediaobject"><span class="koboSpan" id="kobo.2215.1"><img alt="" role="presentation" src="../Images/B18469_12_26.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2216.1">Figure 12.26: Logs after interacting with the app without searching for anything</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2217.1">Notice that if you start searching</span><a id="_idIndexMarker1048"/><span class="koboSpan" id="kobo.2218.1"> for something, you’ll get even</span><a id="_idIndexMarker1049"/><span class="koboSpan" id="kobo.2219.1"> more re-renders. </span><span class="koboSpan" id="kobo.2219.2">That’s because each key up and/or key down event will trigger more re-renders.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="8"><span class="koboSpan" id="kobo.2220.1">To fix the issue, we will create an Angular pipe. </span><span class="koboSpan" id="kobo.2220.2">We’ll move the computation to generate the random colors for this user card to this Angular pipe. </span><span class="koboSpan" id="kobo.2220.3">In the project root, run the following command in the terminal:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2221.1">cd start &amp;&amp; nx g pipe random-color --directory apps/chapter12/ng-pipes-perf/src/app/pipes
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2222.1">Use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2223.1">@schematics/angular:pipe</span></code><span class="koboSpan" id="kobo.2224.1"> schematic when asked.</span></p> </li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="9"><span class="koboSpan" id="kobo.2225.1">Now, move the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2226.1">randomColor</span></code><span class="koboSpan" id="kobo.2227.1"> getter function and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2228.1">factorial</span></code><span class="koboSpan" id="kobo.2229.1"> function from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2230.1">user-card.component.ts</span></code><span class="koboSpan" id="kobo.2231.1"> file to the Angular pipe’s file, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2232.1">pipes/random-color.pipe.ts</span></code><span class="koboSpan" id="kobo.2233.1">, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2234.1">import</span></span><span class="koboSpan" id="kobo.2235.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.2236.1">Pipe</span></span><span class="koboSpan" id="kobo.2237.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2238.1">PipeTransform</span></span><span class="koboSpan" id="kobo.2239.1">, inject } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2240.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2241.1">'@angular/core'</span></span><span class="koboSpan" id="kobo.2242.1">;
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2243.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2244.1"> { </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2245.1">LogsService</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2246.1"> } </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2247.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2248.1">'../services/logs.service'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2249.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2250.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2251.1"> { randColor } </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2252.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2253.1">'@ngneat/falso'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2254.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2255.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2256.1"> { </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2257.1">IUser</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2258.1"> } </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2259.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2260.1">'../interfaces/user.interface'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2261.1">;</span></strong></span><span class="koboSpan" id="kobo.2262.1">
...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2263.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2264.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2265.1">RandomColorPipe</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2266.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2267.1">PipeTransform</span></span><span class="koboSpan" id="kobo.2268.1"> {
  </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2269.1">logsService = </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2270.1">inject</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2271.1">(</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2272.1">LogsService</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2273.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2274.1">factorial</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2275.1">(</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2276.1">n</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2277.1">: </span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.2278.1">number</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2279.1">): </span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.2280.1">number</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2281.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2282.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2283.1"> (n == </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.2284.1">0</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2285.1"> || n == </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.2286.1">1</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2287.1">) {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2288.1">return</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.2289.1">1</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2290.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2291.1">} </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2292.1">else</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2293.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2294.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2295.1"> n * </span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2296.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2297.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2298.1">factorial</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2299.1">(n - </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.2300.1">1</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2301.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2302.1">}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2303.1">}</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2304.1">randomColor</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2305.1">(</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2306.1">email</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.2307.1">: </span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.2308.1">string</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.2309.1">, </span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2310.1">randomizationCount</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.2311.1">: </span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.2312.1">number</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2313.1">) {</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2314.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2315.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2316.1">logsService</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2317.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2318.1">updateLogEntry</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2319.1">(email);</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2320.1">let</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2321.1"> color;</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2322.1">for</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2323.1"> (</span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2324.1">let</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2325.1"> i = </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.2326.1">0</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2327.1">; i &lt; </span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2328.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2329.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2330.1">factorial</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2331.1">(randomizationCount); i++) {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2332.1">color = </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2333.1">randColor</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2334.1">();</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2335.1">}</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2336.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2337.1"> color;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2338.1">}</span></strong></span>
<span class="hljs-title"><span class="koboSpan" id="kobo.2339.1">transform</span></span><span class="koboSpan" id="kobo.2340.1">(</span><span class="hljs-attr"><span class="koboSpan" id="kobo.2341.1">r</span></span><span class="code-highlight"><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2342.1">andomizationCount</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2343.1">: </span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.2344.1">number</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2345.1">, </span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2346.1">user</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2347.1">: </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2348.1">IUser</span></strong></span><span class="koboSpan" id="kobo.2349.1">):
    </span><span class="code-highlight"><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.2350.1">string</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2351.1"> | </span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.2352.1">undefined</span></strong></span><span class="koboSpan" id="kobo.2353.1"> {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2354.1">return</span></span> <span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2355.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2356.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2357.1">randomColor</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2358.1">(user.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2359.1">email</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2360.1">, randomizationCount)</span></strong></span><span class="koboSpan" id="kobo.2361.1">;
  }
}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.2362.1">Make sure to delete</span><a id="_idIndexMarker1050"/><span class="koboSpan" id="kobo.2363.1"> those functions (the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2364.1">randomColor</span></code><span class="koboSpan" id="kobo.2365.1"> getter and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2366.1">factorial</span></code><span class="koboSpan" id="kobo.2367.1">) from</span><a id="_idIndexMarker1051"/><span class="koboSpan" id="kobo.2368.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2369.1">src/app/component/user-card/user-card.component.ts</span></code><span class="koboSpan" id="kobo.2370.1"> file. </span><span class="koboSpan" id="kobo.2370.2">Remove any unused imports as well.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2371.1">Now, add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2372.1">randomColor</span></code><span class="koboSpan" id="kobo.2373.1"> pipe to the user card component in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2374.1">user-card.component.ts</span></code><span class="koboSpan" id="kobo.2375.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2376.1">...
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2377.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2378.1"> { </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2379.1">RandomColorPipe</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2380.1"> } </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2381.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2382.1">'../../pipes/random-color.pipe'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2383.1">;</span></strong></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.2384.1">@Component</span></span><span class="koboSpan" id="kobo.2385.1">({
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2386.1">selector</span></span><span class="koboSpan" id="kobo.2387.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.2388.1">'app-user-card'</span></span><span class="koboSpan" id="kobo.2389.1">,
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2390.1">standalone</span></span><span class="koboSpan" id="kobo.2391.1">: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2392.1">true</span></span><span class="koboSpan" id="kobo.2393.1">,
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2394.1">imports</span></span><span class="koboSpan" id="kobo.2395.1">: [</span><span class="hljs-title"><span class="koboSpan" id="kobo.2396.1">CommonModule</span></span><span class="koboSpan" id="kobo.2397.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2398.1">RouterModule</span></span><span class="koboSpan" id="kobo.2399.1">, </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2400.1">RandomColorPipe</span></strong></span><span class="koboSpan" id="kobo.2401.1">],
  ...
</span><span class="koboSpan" id="kobo.2401.2">})
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.2402.1">Now, update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2403.1">user-card.component.html</span></code><span class="koboSpan" id="kobo.2404.1"> file to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2405.1">randomColor</span></code><span class="koboSpan" id="kobo.2406.1"> pipe instead of the getter we were using before. </span><span class="koboSpan" id="kobo.2406.2">The code should look like this:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.2407.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2408.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2409.1"> [</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.2410.1">style.backgroundColor</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2411.1">]=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2412.1">"</span></span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2413.1">randomizationCount | randomColor : user</span></strong></span><span class="hljs-string"><span class="koboSpan" id="kobo.2414.1">"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2415.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2416.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2417.1">"card flex flex-col max-w-sm mx-auto h-full duration-200 cursor-pointer hover:border-purple-500 hover:shadow-md p-4 border border-slate-300 rounded-md text-center"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2418.1"> *</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.2419.1">ngIf</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2420.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2421.1">"user"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2422.1">routerLink</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2423.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2424.1">"/user/{{user.uuid}}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2425.1">&gt;</span></span><span class="koboSpan" id="kobo.2426.1">
  ...
</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2427.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2428.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2429.1">&gt;</span></span>
</code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.2430.1">Now, refresh the app </span><a id="_idIndexMarker1052"/><span class="koboSpan" id="kobo.2431.1">and repeat </span><em class="italic"><span class="koboSpan" id="kobo.2432.1">step 7</span></em><span class="koboSpan" id="kobo.2433.1">. </span><span class="koboSpan" id="kobo.2433.2">You will see that the color</span><a id="_idIndexMarker1053"/><span class="koboSpan" id="kobo.2434.1"> is only generated for the first card and the other cards do not re-render, as shown in </span><em class="italic"><span class="koboSpan" id="kobo.2435.1">Figure 12.27</span></em><span class="koboSpan" id="kobo.2436.1">:
    </span><figure class="mediaobject"><span class="koboSpan" id="kobo.2437.1"><img alt="" role="presentation" src="../Images/B18469_12_27.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2438.1">Figure 12.27: Colors regenerating only for the first card</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2439.1">Boom! </span><span class="koboSpan" id="kobo.2439.2">Now that you know how to optimize performance by moving heavy computation to pure Angular pipes, see the next section to understand how this works.</span></p>
<h2 class="heading-2" id="_idParaDest-431"><span class="koboSpan" id="kobo.2440.1">How it works…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2441.1">As we know, Angular by default runs change detection on each browser event triggered in the app. </span><span class="koboSpan" id="kobo.2441.2">And since we’re using a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2442.1">randomColor</span></code><span class="koboSpan" id="kobo.2443.1"> getter in the component template (UI), this function runs each time Angular runs the change detection cycle. </span><span class="koboSpan" id="kobo.2443.2">This causes more computation and performance issues. </span><span class="koboSpan" id="kobo.2443.3">This would also hold true if we used a function call instead of a getter.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2444.1">We can take a step back from the initial implementation and think about what the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2445.1">randomColor</span></code><span class="koboSpan" id="kobo.2446.1"> getter does. </span><span class="koboSpan" id="kobo.2446.2">It works with a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2447.1">for</span></code><span class="koboSpan" id="kobo.2448.1"> loop based on the factorial of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2449.1">randomizationCount</span></code><span class="koboSpan" id="kobo.2450.1"> property. </span><span class="koboSpan" id="kobo.2450.2">This is just to add a lot of processing time for this example, but you can imagine any heavy computation involved in the change detection cycle causing the performance issue. </span><span class="koboSpan" id="kobo.2450.3">And in these cases, we either use pure functions or perhaps memoization.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2451.1">A pure function is a function that always returns the same output, given the same input. </span><span class="koboSpan" id="kobo.2451.2">Memoization is a technique in which, if the inputs are not changed (that is, the function is called with the same inputs as the previous time), a cached output is returned, and the heavy computation is skipped. </span><span class="koboSpan" id="kobo.2451.3">Luckily, Angular pure pipes are pure functions and memorized, as they are only called when the inputs change. </span><span class="koboSpan" id="kobo.2451.4">If that’s not the case, the pipe’s transform function will not be called, and the component won’t be re-rendered.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2452.1">In the recipe, we move the computation to a newly created Angular pipe. </span><span class="koboSpan" id="kobo.2452.2">The pipe’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.2453.1">transform</span></code><span class="koboSpan" id="kobo.2454.1"> method receives </span><code class="inlineCode"><span class="koboSpan" id="kobo.2455.1">randomizationCount</span></code><span class="koboSpan" id="kobo.2456.1"> as the first value, and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2457.1">user</span></code><span class="koboSpan" id="kobo.2458.1"> (of type </span><code class="inlineCode"><span class="koboSpan" id="kobo.2459.1">IUser</span></code><span class="koboSpan" id="kobo.2460.1">) as the second input. </span><span class="koboSpan" id="kobo.2460.2">The pipe then uses the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2461.1">randomColor</span></code><span class="koboSpan" id="kobo.2462.1"> method and, ultimately, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2463.1">factorial</span></code><span class="koboSpan" id="kobo.2464.1"> method to calculate a random color. </span><span class="koboSpan" id="kobo.2464.2">When we start typing in the search box, the values for the user cards do not change. </span><span class="koboSpan" id="kobo.2464.3">This results in the pipe not being triggered until we get back a new set of users based on the search query. </span><span class="koboSpan" id="kobo.2464.4">Once we get the result, the user cards are re-rendered and hence we get new colors for them. </span><span class="koboSpan" id="kobo.2464.5">As a result, there is no unnecessary computation</span><a id="_idIndexMarker1054"/><span class="koboSpan" id="kobo.2465.1"> running due to browser events, thus optimizing</span><a id="_idIndexMarker1055"/><span class="koboSpan" id="kobo.2466.1"> performance and unblocking the UI thread.</span></p>
<h2 class="heading-2" id="_idParaDest-432"><span class="koboSpan" id="kobo.2467.1">See also</span></h2>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2468.1">Angular pure and impure pipes</span><a id="_idIndexMarker1056"/><span class="koboSpan" id="kobo.2469.1"> official documentation: </span><a href="https://angular.io/guide/pipes#pure-and-impure-pipes"><span class="url"><span class="koboSpan" id="kobo.2470.1">https://angular.io/guide/pipes#pure-and-impure-pipes</span></span></a></li>
</ul>
<h1 class="heading-1" id="_idParaDest-433"><span class="koboSpan" id="kobo.2471.1">Using web workers for heavy computation</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2472.1">If your Angular application</span><a id="_idIndexMarker1057"/><span class="koboSpan" id="kobo.2473.1"> does a lot of computation during an action, there’s a high</span><a id="_idIndexMarker1058"/><span class="koboSpan" id="kobo.2474.1"> chance that it will block the UI thread. </span><span class="koboSpan" id="kobo.2474.2">This will cause a lag in rendering the UI because it blocks the main JavaScript thread. </span><span class="koboSpan" id="kobo.2474.3">Web workers allow us to run heavy computation in the background thread, thus freeing the UI thread as it is not blocked. </span><span class="koboSpan" id="kobo.2474.4">In this recipe, we’re going to use an application that does a heavy computation in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2475.1">UserService</span></code><span class="koboSpan" id="kobo.2476.1"> class. </span><span class="koboSpan" id="kobo.2476.2">It creates a unique ID for each user card and saves it into </span><code class="inlineCode"><span class="koboSpan" id="kobo.2477.1">localStorage</span></code><span class="koboSpan" id="kobo.2478.1">. </span><span class="koboSpan" id="kobo.2478.2">However, it loops a couple of thousand times before doing so, which causes our application to hang for a while. </span><span class="koboSpan" id="kobo.2478.3">In this recipe, we’ll move the heavy computation from the components to a web worker and will also add a fallback in case web workers aren’t available.</span></p>
<h2 class="heading-2" id="_idParaDest-434"><span class="koboSpan" id="kobo.2479.1">Getting ready</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2480.1">The app that we are going</span><a id="_idIndexMarker1059"/><span class="koboSpan" id="kobo.2481.1"> to work with resides</span><a id="_idIndexMarker1060"/><span class="koboSpan" id="kobo.2482.1"> in </span><code class="inlineCode"><span class="koboSpan" id="kobo.2483.1">start/apps/chapter12/ng-ww-perf</span></code><span class="koboSpan" id="kobo.2484.1"> inside the cloned repository:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2485.1">Open the code repository in your code editor.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2486.1">Open the terminal, navigate to the code repository directory, and run the following command to serve the project:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2487.1">npm run serve ng-ww-perf
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2488.1">This should open the app in a new browser tab, and you should see the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2489.1"><img alt="" role="presentation" src="../Images/B18469_12_28.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2490.1">Figure 12.28: The ng-ww-perf app running at http://localhost:4200</span></p> </li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2491.1">Now that we have the app running, let’s see the steps of the recipe in the next section.</span></p>
<h2 class="heading-2" id="_idParaDest-435"><span class="koboSpan" id="kobo.2492.1">How to do it…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2493.1">Once you open the app, you’ll notice</span><a id="_idIndexMarker1061"/><span class="koboSpan" id="kobo.2494.1"> that it takes some time before the user cards</span><a id="_idIndexMarker1062"/><span class="koboSpan" id="kobo.2495.1"> are rendered. </span><span class="koboSpan" id="kobo.2495.2">We can also see the number of times the random color for the user card background is generated. </span><span class="koboSpan" id="kobo.2495.3">If you type something, or click the </span><strong class="screenText"><span class="koboSpan" id="kobo.2496.1">Update Irineu’s Name</span></strong><span class="koboSpan" id="kobo.2497.1"> button, you will see that the UI thread is blocked until we have some computation finished. </span><span class="koboSpan" id="kobo.2497.2">The culprit is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2498.1">randomColor</span></code><span class="koboSpan" id="kobo.2499.1"> getter method in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2500.1">UserCardComponent</span></code><span class="koboSpan" id="kobo.2501.1"> class. </span><span class="koboSpan" id="kobo.2501.2">This ultimately generates a random color after running a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2502.1">for</span></code><span class="koboSpan" id="kobo.2503.1"> loop based on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2504.1">RANDOMIZATION_COUNT</span></code><span class="koboSpan" id="kobo.2505.1"> token’s value before rendering the color. </span><span class="koboSpan" id="kobo.2505.2">This happens inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2506.1">generateRandomColor</span></code><span class="koboSpan" id="kobo.2507.1"> method inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2508.1">src/app/utils.ts</span></code><span class="koboSpan" id="kobo.2509.1"> file. </span><span class="koboSpan" id="kobo.2509.2">Let’s start the recipe to improve the performance of the app. </span><span class="koboSpan" id="kobo.2509.3">We’ll start by implementing a web worker:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2510.1">We’ll first create a web worker. </span><span class="koboSpan" id="kobo.2510.2">Run the following command in the workspace’s root:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2511.1">cd start &amp;&amp; nx generate web-worker workers/randomColor --project ng-ww-perf
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2512.1">Choose </span><code class="inlineCode"><span class="koboSpan" id="kobo.2513.1">@nx/angular:web-worker</span></code><span class="koboSpan" id="kobo.2514.1"> when asked.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="2"><span class="koboSpan" id="kobo.2515.1">Now, update the code inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2516.1">workers/random-color.worker.ts</span></code><span class="koboSpan" id="kobo.2517.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.2518.1">/// &lt;reference lib="webworker" /&gt;</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2519.1">import</span></span><span class="koboSpan" id="kobo.2520.1"> { generateRandomColor } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2521.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2522.1">"../utils"</span></span><span class="koboSpan" id="kobo.2523.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2524.1">type</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2525.1">RandomColorIncomingEvent</span></span><span class="koboSpan" id="kobo.2526.1"> = {
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2527.1">data</span></span><span class="koboSpan" id="kobo.2528.1">: {
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2529.1">randomizationCount</span></span><span class="koboSpan" id="kobo.2530.1">: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2531.1">number</span></span><span class="koboSpan" id="kobo.2532.1">
  }
}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2533.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2534.1">type</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2535.1">RandomColorOutgoingEvent</span></span><span class="koboSpan" id="kobo.2536.1"> = { </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2537.1">data</span></span><span class="koboSpan" id="kobo.2538.1">: { </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2539.1">color</span></span><span class="koboSpan" id="kobo.2540.1">: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2541.1">string</span></span><span class="koboSpan" id="kobo.2542.1"> } };
</span><span class="hljs-title"><span class="koboSpan" id="kobo.2543.1">addEventListener</span></span><span class="koboSpan" id="kobo.2544.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2545.1">'message'</span></span><span class="koboSpan" id="kobo.2546.1">, </span><span class="hljs-function"><span class="koboSpan" id="kobo.2547.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2548.1">{ data }:</span></span>
<span class="hljs-title"> </span><span class="hljs-params"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.2549.1">RandomColorIncomingEvent</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2550.1">) =&gt;</span></span><span class="koboSpan" id="kobo.2551.1"> {
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2552.1">const</span></span><span class="koboSpan" id="kobo.2553.1"> {
    randomizationCount
  } = data;
  </span><span class="hljs-variable"><span class="koboSpan" id="kobo.2554.1">console</span></span><span class="koboSpan" id="kobo.2555.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.2556.1">log</span></span><span class="koboSpan" id="kobo.2557.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2558.1">'inside the worker'</span></span><span class="koboSpan" id="kobo.2559.1">, data)
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2560.1">if</span></span><span class="koboSpan" id="kobo.2561.1"> (!randomizationCount) {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2562.1">return</span></span><span class="koboSpan" id="kobo.2563.1">;
  }
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2564.1">const</span></span><span class="koboSpan" id="kobo.2565.1"> color = </span><span class="hljs-title"><span class="koboSpan" id="kobo.2566.1">generateRandomColor</span></span><span class="koboSpan" id="kobo.2567.1">(randomizationCount);
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.2568.1">postMessage</span></span><span class="koboSpan" id="kobo.2569.1">({
    color
  });
});
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2570.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2571.1">const</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2572.1">getRandomColorWorker</span></span><span class="koboSpan" id="kobo.2573.1"> = () =&gt; {
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2574.1">if</span></span><span class="koboSpan" id="kobo.2575.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2576.1">typeof</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2577.1">Worker</span></span><span class="koboSpan" id="kobo.2578.1"> !== </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2579.1">undefined</span></span><span class="koboSpan" id="kobo.2580.1">) {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2581.1">return</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2582.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2583.1">Worker</span></span><span class="koboSpan" id="kobo.2584.1">(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2585.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2586.1">URL</span></span><span class="koboSpan" id="kobo.2587.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2588.1">'./random-color.worker'</span></span><span class="koboSpan" id="kobo.2589.1">, </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2590.1">import</span></span><span class="koboSpan" id="kobo.2591.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2592.1">meta</span></span><span class="koboSpan" id="kobo.2593.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2594.1">url</span></span><span class="koboSpan" id="kobo.2595.1">), {
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2596.1">type</span></span><span class="koboSpan" id="kobo.2597.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.2598.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2599.1">module'</span></span><span class="koboSpan" id="kobo.2600.1">
    })
  }
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2601.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.2602.1">null</span></span><span class="koboSpan" id="kobo.2603.1">;
}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.2604.1">Let’s replace the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2605.1">randomColor</span></code><span class="koboSpan" id="kobo.2606.1"> getter</span><a id="_idIndexMarker1063"/><span class="koboSpan" id="kobo.2607.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2608.1">UserCardComponent</span></code><span class="koboSpan" id="kobo.2609.1"> class with a regular property. </span><span class="koboSpan" id="kobo.2609.2">Update</span><a id="_idIndexMarker1064"/><span class="koboSpan" id="kobo.2610.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2611.1">user-card.component.ts</span></code><span class="koboSpan" id="kobo.2612.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2613.1">...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2614.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2615.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2616.1">UserCardComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2617.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2618.1">OnInit</span></span><span class="koboSpan" id="kobo.2619.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2620.1">OnChanges</span></span><span class="koboSpan" id="kobo.2621.1"> {
  ...
  </span><span class="koboSpan" id="kobo.2621.2">randomizationCount = </span><span class="hljs-title"><span class="koboSpan" id="kobo.2622.1">inject</span></span><span class="koboSpan" id="kobo.2623.1">(</span><span class="hljs-variable"><span class="koboSpan" id="kobo.2624.1">RANDOMIZATION_COUNT</span></span><span class="koboSpan" id="kobo.2625.1">);
  </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2626.1">randomColor = </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2627.1">''</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2628.1">;</span></strong></span><span class="koboSpan" id="kobo.2629.1">
  ...
</span><span class="koboSpan" id="kobo.2629.2">}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2630.1">Make sure to remove the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2631.1">randomColor</span></code><span class="koboSpan" id="kobo.2632.1"> getter function. </span><span class="koboSpan" id="kobo.2632.2">Otherwise, TypeScript will throw errors since we can’t have a property and a getter method having the same name.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.2633.1">Now, we’ll use the worker in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2634.1">user-card.component.ts</span></code><span class="koboSpan" id="kobo.2635.1"> file. </span><span class="koboSpan" id="kobo.2635.2">Update it, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2636.1">import</span></span><span class="koboSpan" id="kobo.2637.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.2638.1">Component</span></span><span class="koboSpan" id="kobo.2639.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2640.1">Input</span></span><span class="koboSpan" id="kobo.2641.1">, </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2642.1">OnInit</span></strong></span><span class="koboSpan" id="kobo.2643.1">, inject } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2644.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2645.1">'@angular/core'</span></span><span class="koboSpan" id="kobo.2646.1">;
...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2647.1">import</span></span><span class="koboSpan" id="kobo.2648.1"> { </span><span class="hljs-variable"><span class="koboSpan" id="kobo.2649.1">RANDOMIZATION_COUNT</span></span><span class="koboSpan" id="kobo.2650.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2651.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2652.1">'../../tokens'</span></span><span class="koboSpan" id="kobo.2653.1">;
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2654.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2655.1"> { </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2656.1">RandomColorOutgoingEvent</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2657.1"> , getRandomColorWorker } </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2658.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2659.1">'../../workers/random-color.worker'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2660.1">;</span></strong></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.2661.1">@Component</span></span><span class="koboSpan" id="kobo.2662.1">({...})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2663.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2664.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2665.1">UserCardComponent</span></span> <span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2666.1">implements</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2667.1">OnInit</span></strong></span><span class="koboSpan" id="kobo.2668.1"> {
  </span><span class="hljs-meta"><span class="koboSpan" id="kobo.2669.1">@Input</span></span><span class="koboSpan" id="kobo.2670.1">() user!: </span><span class="hljs-title"><span class="koboSpan" id="kobo.2671.1">IUser</span></span><span class="koboSpan" id="kobo.2672.1">;
  </span><span class="hljs-meta"><span class="koboSpan" id="kobo.2673.1">@Input</span></span><span class="koboSpan" id="kobo.2674.1">() index = </span><span class="hljs-number"><span class="koboSpan" id="kobo.2675.1">0</span></span><span class="koboSpan" id="kobo.2676.1">;
  logsService = </span><span class="hljs-title"><span class="koboSpan" id="kobo.2677.1">inject</span></span><span class="koboSpan" id="kobo.2678.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2679.1">LogsService</span></span><span class="koboSpan" id="kobo.2680.1">);
  randomizationCount = </span><span class="hljs-title"><span class="koboSpan" id="kobo.2681.1">inject</span></span><span class="koboSpan" id="kobo.2682.1">(</span><span class="hljs-variable"><span class="koboSpan" id="kobo.2683.1">RANDOMIZATION_COUNT</span></span><span class="koboSpan" id="kobo.2684.1">);
  randomColor = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2685.1">''</span></span><span class="koboSpan" id="kobo.2686.1">;
  </span><span class="code-highlight"><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2687.1">worker</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2688.1">: </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2689.1">Worker</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2690.1"> | </span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.2691.1">null</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2692.1"> = </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2693.1">getRandomColorWorker</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2694.1">();</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2695.1">ngOnInit</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2696.1">(): </span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.2697.1">void</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2698.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2699.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2700.1"> (!</span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2701.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2702.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2703.1">worker</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2704.1">) {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2705.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2706.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2707.1">}</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2708.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2709.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2710.1">worker</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2711.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2712.1">onmessage</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2713.1"> = </span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.2714.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.2715.1">{ data: { color } }:</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2716.1">RandomColorOutgoingEvent</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.2717.1">) =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2718.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2719.1">console</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2720.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2721.1">log</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2722.1">(</span></strong></span>
<span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2723.1">`received color </span></strong><strong class="hljs-subst-slc"><span class="koboSpan" id="kobo.2724.1">${color}</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2725.1"> from worker for user </span></strong><strong class="hljs-subst-slc"><span class="koboSpan" id="kobo.2726.1">${</span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2727.1">this</span></strong><strong class="hljs-subst-slc"><span class="koboSpan" id="kobo.2728.1">.user.email}</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2729.1">`</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2730.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2731.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2732.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2733.1">logsService</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2734.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2735.1">updateLogEntry</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2736.1">(</span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2737.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2738.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2739.1">user</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2740.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2741.1">email</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2742.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2743.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2744.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2745.1">randomColor</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2746.1"> = color;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2747.1">};</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2748.1">}</span></strong></span><span class="koboSpan" id="kobo.2749.1">
 ...
</span><span class="koboSpan" id="kobo.2749.2">}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.2750.1">So far, we have just added a listener</span><a id="_idIndexMarker1065"/><span class="koboSpan" id="kobo.2751.1"> for when we’ll receive</span><a id="_idIndexMarker1066"/><span class="koboSpan" id="kobo.2752.1"> the generated color from the worker. </span><span class="koboSpan" id="kobo.2752.2">But first, we must send a message from the component to the worker, so it generates a random color. </span><span class="koboSpan" id="kobo.2752.3">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2753.1">user-card.component.ts</span></code><span class="koboSpan" id="kobo.2754.1"> file to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2755.1">OnChanges</span></code><span class="koboSpan" id="kobo.2756.1"> life cycle hook. </span><span class="koboSpan" id="kobo.2756.2">We’ll use it to send a message to the worker:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2757.1">import</span></span><span class="koboSpan" id="kobo.2758.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.2759.1">Component</span></span><span class="koboSpan" id="kobo.2760.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2761.1">Input</span></span><span class="koboSpan" id="kobo.2762.1">, </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2763.1">OnChanges</span></strong></span><span class="koboSpan" id="kobo.2764.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2765.1">OnInit</span></span><span class="koboSpan" id="kobo.2766.1">, </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2767.1">SimpleChanges</span></strong></span><span class="koboSpan" id="kobo.2768.1">, inject } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2769.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2770.1">'@angular/core'</span></span><span class="koboSpan" id="kobo.2771.1">;
...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2772.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2773.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2774.1">UserCardComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2775.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2776.1">OnInit</span></span><span class="koboSpan" id="kobo.2777.1">, </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2778.1">OnChanges</span></strong><strong class="hljs-slc"> </strong></span><span class="koboSpan" id="kobo.2779.1">{
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.2780.1">ngOnInit</span></span><span class="koboSpan" id="kobo.2781.1">(): </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2782.1">void</span></span><span class="koboSpan" id="kobo.2783.1"> {...}
 
  </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2784.1">ngOnChanges</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2785.1">(</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2786.1">changes</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.2787.1">: </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2788.1">SimpleChanges</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2789.1">) {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2790.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2791.1"> (changes[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2792.1">'user'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2793.1">].</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2794.1">currentValue</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2795.1"> !==</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2796.1">changes[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2797.1">'user'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2798.1">].</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2799.1">previousValue</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2800.1">) {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2801.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2802.1"> (!</span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2803.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2804.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2805.1">worker</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2806.1">) {</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2807.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2808.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2809.1">randomColor</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2810.1"> = </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2811.1">generateRandomColor</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2812.1">(</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2813.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2814.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2815.1">randomizationCount</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2816.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2817.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2818.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2819.1">}</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2820.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2821.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2822.1">worker</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2823.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2824.1">postMessage</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2825.1">({ </span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2826.1">randomizationCount</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2827.1">:</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2828.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2829.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2830.1">randomizationCount</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2831.1"> });</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2832.1">}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2833.1">}</span></strong></span><span class="koboSpan" id="kobo.2834.1">
  ...
</span><span class="koboSpan" id="kobo.2834.2">}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.2835.1">Finally, let’s ensure</span><a id="_idIndexMarker1067"/><span class="koboSpan" id="kobo.2836.1"> that the worker is destroyed (terminated) when the respective user card</span><a id="_idIndexMarker1068"/><span class="koboSpan" id="kobo.2837.1"> is destroyed. </span><span class="koboSpan" id="kobo.2837.2">Update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2838.1">user-card.component.ts</span></code><span class="koboSpan" id="kobo.2839.1"> file as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2840.1">...
</span><span class="koboSpan" id="kobo.2840.2">@ </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2841.1">import</span></span><span class="koboSpan" id="kobo.2842.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.2843.1">Component</span></span><span class="koboSpan" id="kobo.2844.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2845.1">Input</span></span><span class="koboSpan" id="kobo.2846.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2847.1">OnChanges</span></span><span class="koboSpan" id="kobo.2848.1">, </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2849.1">OnDestroy</span></strong></span><span class="koboSpan" id="kobo.2850.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2851.1">OnInit</span></span><span class="koboSpan" id="kobo.2852.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2853.1">SimpleChanges</span></span><span class="koboSpan" id="kobo.2854.1">, inject } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2855.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2856.1">'@angular/core'</span></span><span class="koboSpan" id="kobo.2857.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2858.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2859.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2860.1">UserCardComponent</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2861.1">implements</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2862.1">OnInit</span></span><span class="koboSpan" id="kobo.2863.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2864.1">OnChanges</span></span><span class="koboSpan" id="kobo.2865.1">,
</span><span class="hljs-keyword"> </span> <span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2866.1">OnDestroy</span></strong><strong class="hljs-slc"> </strong></span><span class="koboSpan" id="kobo.2867.1">{
  ...
  </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2868.1">ngOnDestroy</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2869.1">(): </span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.2870.1">void</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2871.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2872.1">this</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2873.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.2874.1">worker</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2875.1">?.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2876.1">terminate</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2877.1">();</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2878.1">}</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2879.1">get</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2880.1">log</span></span><span class="koboSpan" id="kobo.2881.1">() {...}
}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.2882.1">Refresh the app and notice how long it takes for the user cards to render. </span><span class="koboSpan" id="kobo.2882.2">They should appear much faster than before. </span><span class="koboSpan" id="kobo.2882.3">Also, you should be able to see the following logs reflecting the communication from the app to the web worker, and vice versa:
    </span><figure class="mediaobject"><span class="koboSpan" id="kobo.2883.1"><img alt="" role="presentation" src="../Images/B18469_12_29.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2884.1">Figure 12.29: Logs showing messages to and from the app to web workers</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2885.1">Woohoo! </span><span class="koboSpan" id="kobo.2885.2">The power of web workers! </span><span class="koboSpan" id="kobo.2885.3">And now you know how to use web workers in an Angular app to move heavy computation to them. </span><span class="koboSpan" id="kobo.2885.4">Since you’ve finished the recipe, see the next section on how this works.</span></p>
<h2 class="heading-2" id="_idParaDest-436"><span class="koboSpan" id="kobo.2886.1">How it works…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2887.1">As we discussed in the recipe’s description, web workers</span><a id="_idIndexMarker1069"/><span class="koboSpan" id="kobo.2888.1"> allow us to run and execute code</span><a id="_idIndexMarker1070"/><span class="koboSpan" id="kobo.2889.1"> in a separate thread from the main JavaScript (or UI thread). </span><span class="koboSpan" id="kobo.2889.2">At the beginning of the recipe, whenever we refresh the app or search for a user, it blocks the UI thread. </span><span class="koboSpan" id="kobo.2889.3">We sometimes see the loader being hung, or a white screen. </span><span class="koboSpan" id="kobo.2889.4">This is until a random color is generated for each card. </span><span class="koboSpan" id="kobo.2889.5">We begin</span><a id="_idIndexMarker1071"/><span class="koboSpan" id="kobo.2890.1"> the recipe by creating a web worker using the NX </span><strong class="keyWord"><span class="koboSpan" id="kobo.2891.1">Command-line Interface</span></strong><span class="koboSpan" id="kobo.2892.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.2893.1">CLI</span></strong><span class="koboSpan" id="kobo.2894.1">). </span><span class="koboSpan" id="kobo.2894.2">This creates a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2895.1">random-color.worker.ts</span></code><span class="koboSpan" id="kobo.2896.1"> file, which contains some boilerplate code to receive messages from the UI thread and send a message back to it as a response. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.2897.1">The CLI command also updates the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2898.1">project.json</span></code><span class="koboSpan" id="kobo.2899.1"> file by adding a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2900.1">webWorkerTsConfig</span></code><span class="koboSpan" id="kobo.2901.1"> property. </span><span class="koboSpan" id="kobo.2901.2">The value against the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2902.1">webWorkerTsConfig</span></code><span class="koboSpan" id="kobo.2903.1"> property is the path to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2904.1">tsconfig.worker.json</span></code><span class="koboSpan" id="kobo.2905.1"> file, and the CLI command also creates this </span><code class="inlineCode"><span class="koboSpan" id="kobo.2906.1">tsconfig.worker.json</span></code><span class="koboSpan" id="kobo.2907.1"> file. </span><span class="koboSpan" id="kobo.2907.2">If you open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2908.1">tsconfig.worker.json</span></code><span class="koboSpan" id="kobo.2909.1"> file, you should see the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.2910.1">/* To learn more about this file see: https://angular.io/config/tsconfig. </span><span class="koboSpan" id="kobo.2910.2">*/</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.2911.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2912.1">"extends"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.2913.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2914.1">"../../../tsconfig.json"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.2915.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2916.1">"compilerOptions"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.2917.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.2918.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2919.1">"outDir"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.2920.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2921.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2922.1">../../../out-tsc/worker"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.2923.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2924.1">"lib"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.2925.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.2926.1">[</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.2927.1">"es2018"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.2928.1">,</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.2929.1">"webworker"</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.2930.1">],</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2931.1">"types"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.2932.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.2933.1">[]</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.2934.1">},</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2935.1">"include"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.2936.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.2937.1">[</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.2938.1">"src/**/*.worker.ts"</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.2939.1">]</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.2940.1">}</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2941.1">However, in our NX workspace, we have a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2942.1">tsconfig.base.json</span></code><span class="koboSpan" id="kobo.2943.1"> file instead of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2944.1">tsconfig.json</span></code><span class="koboSpan" id="kobo.2945.1">. </span><span class="koboSpan" id="kobo.2945.2">So, we fixed it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2946.1">In the web worker file, we have</span><a id="_idIndexMarker1072"/><span class="koboSpan" id="kobo.2947.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2948.1">addEventListener</span></code><span class="koboSpan" id="kobo.2949.1"> method call, which receives messages from the UI thread</span><a id="_idIndexMarker1073"/><span class="koboSpan" id="kobo.2950.1"> to the worker. </span><span class="koboSpan" id="kobo.2950.2">Notice that we expect to receive the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2951.1">randomizationCount</span></code><span class="koboSpan" id="kobo.2952.1"> property from the UI thread so we can use it in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2953.1">generateRandomColor</span></code><span class="koboSpan" id="kobo.2954.1"> method from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2955.1">utils.ts</span></code><span class="koboSpan" id="kobo.2956.1"> file.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2957.1">The worker file also has a method named </span><code class="inlineCode"><span class="koboSpan" id="kobo.2958.1">getRandomColorWorker</span></code><span class="koboSpan" id="kobo.2959.1">. </span><span class="koboSpan" id="kobo.2959.2">This returns a new instance of the worker every time it is called. </span><span class="koboSpan" id="kobo.2959.3">Since we call it from our user card components, each card gets a new instance of the worker.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2960.1">Then, in our </span><code class="inlineCode"><span class="koboSpan" id="kobo.2961.1">UserCardComponent</span></code><span class="koboSpan" id="kobo.2962.1"> class, we get a new instance of the worker for each component and use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2963.1">ngOnInit</span></code><span class="koboSpan" id="kobo.2964.1"> life cycle hook to add an event listener to the worker. </span><span class="koboSpan" id="kobo.2964.2">This way, whenever the worker sends a message, the user card component can read it—that is, it will get the generated color and assign it to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2965.1">randomColor</span></code><span class="koboSpan" id="kobo.2966.1"> property. </span><span class="koboSpan" id="kobo.2966.2">This, in turn, will set the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2967.1">backgroundColor</span></code><span class="koboSpan" id="kobo.2968.1"> of the user card. </span><span class="koboSpan" id="kobo.2968.2">Notice that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2969.1">ngOnInit</span></code><span class="koboSpan" id="kobo.2970.1"> life cycle hook only registers a listener for the messages sent by the worker. </span><span class="koboSpan" id="kobo.2970.2">But first, we have to tell the worker to generate random colors. </span><span class="koboSpan" id="kobo.2970.3">For this, we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2971.1">ngOnChanges</span></code><span class="koboSpan" id="kobo.2972.1"> life cycle hook. </span><span class="koboSpan" id="kobo.2972.2">In the hook, we observe the value of the user input. </span><span class="koboSpan" id="kobo.2972.3">If it changes, we send a message to the worker to generate a random color for the specific user card. </span><span class="koboSpan" id="kobo.2972.4">If you click on the </span><strong class="screenText"><span class="koboSpan" id="kobo.2973.1">Update Irineu’s Name</span></strong><span class="koboSpan" id="kobo.2974.1"> button, you will see consecutive logs from and to the user card. </span><span class="koboSpan" id="kobo.2974.2">Note that moving the color generation to the worker in this way also results in other components not being re-rendered again when we have any of the browser events (click, key up, etc.) triggering. </span><span class="koboSpan" id="kobo.2974.3">Finally, we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2975.1">ngOnDestroy</span></code><span class="koboSpan" id="kobo.2976.1"> life cycle hook to terminate the worker to avoid memory leaks.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2977.1">Note that in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2978.1">ngOnChanges</span></code><span class="koboSpan" id="kobo.2979.1"> hook, we are also falling back to the regular</span><a id="_idIndexMarker1074"/><span class="koboSpan" id="kobo.2980.1"> usage of the methods in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2981.1">utils.ts</span></code><span class="koboSpan" id="kobo.2982.1"> file if the browser</span><a id="_idIndexMarker1075"/><span class="koboSpan" id="kobo.2983.1"> does not support workers.</span></p>
<h2 class="heading-2" id="_idParaDest-437"><span class="koboSpan" id="kobo.2984.1">See also</span></h2>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2985.1">Angular official documentation</span><a id="_idIndexMarker1076"/><span class="koboSpan" id="kobo.2986.1"> on web workers: </span><a href="https://angular.io/guide/web-worker"><span class="url"><span class="koboSpan" id="kobo.2987.1">https://angular.io/guide/web-worker</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2988.1">MDN web worker</span><a id="_idIndexMarker1077"/><span class="koboSpan" id="kobo.2989.1"> documentation: </span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Worker"><span class="url"><span class="koboSpan" id="kobo.2990.1">https://developer.mozilla.org/en-US/docs/Web/API/Worker</span></span></a></li>
</ul>
<h1 class="heading-1" id="_idParaDest-438"><span class="koboSpan" id="kobo.2991.1">Using performance budgets for auditing</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2992.1">In today’s world, most of the population</span><a id="_idIndexMarker1078"/><span class="koboSpan" id="kobo.2993.1"> has a good internet connection to use everyday</span><a id="_idIndexMarker1079"/><span class="koboSpan" id="kobo.2994.1"> applications, be it a mobile app or a web app, and it is fascinating how much data we ship to our end users as a business. </span><span class="koboSpan" id="kobo.2994.2">The amount of JavaScript shipped to users has an ever-increasing trend now, and if you’re working on a web app, you might want to use performance budgets to make sure the bundle size doesn’t exceed a certain limit. </span><span class="koboSpan" id="kobo.2994.3">With Angular apps, setting the budget sizes is a breeze. </span><span class="koboSpan" id="kobo.2994.4">In this recipe, you’re going to learn how to use the performance budgets to ensure small bundle sizes for our Angular apps.</span></p>
<h2 class="heading-2" id="_idParaDest-439"><span class="koboSpan" id="kobo.2995.1">Getting ready</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2996.1">The app that we are going to work with resides in </span><code class="inlineCode"><span class="koboSpan" id="kobo.2997.1">start/apps/chapter12/ng-perf-budgets</span></code><span class="koboSpan" id="kobo.2998.1"> inside the cloned repository:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2999.1">Open the code repository in your code editor.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.3000.1">Open the terminal, navigate to the code repository directory, and run the following command to build the project:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3001.1">npm run build ng-perf-budgets
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3002.1">This should build the app, and you should see the following in the terminal:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3003.1"><img alt="" role="presentation" src="../Images/B18469_12_30.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3004.1">Figure 12.30: Build output for production mode, without performance budgets</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.3005.1">Notice that the bundle size for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3006.1">main.*.js</span></code><span class="koboSpan" id="kobo.3007.1"> file is about 294 </span><strong class="keyWord"><span class="koboSpan" id="kobo.3008.1">Kilobytes</span></strong><span class="koboSpan" id="kobo.3009.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.3010.1">KB</span></strong><span class="koboSpan" id="kobo.3011.1">) now. </span><span class="koboSpan" id="kobo.3011.2">And now that we have built</span><a id="_idIndexMarker1080"/><span class="koboSpan" id="kobo.3012.1"> the app, let’s see the steps of the recipe</span><a id="_idIndexMarker1081"/><span class="koboSpan" id="kobo.3013.1"> in the next section.</span></p>
<h2 class="heading-2" id="_idParaDest-440"><span class="koboSpan" id="kobo.3014.1">How to do it…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.3015.1">We have an app that is small in terms of bundle size at the moment. </span><span class="koboSpan" id="kobo.3015.2">However, this could grow into a huge app with upcoming business requirements. </span><span class="koboSpan" id="kobo.3015.3">For the sake of this recipe, we’ll increase the bundle size deliberately and will then use performance budgets to stop the Angular build from being generated for production if the bundle size exceeds the budget. </span><span class="koboSpan" id="kobo.3015.4">Let’s begin the recipe:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.3016.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3017.1">app.component.ts</span></code><span class="koboSpan" id="kobo.3018.1"> file and update it, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3019.1">...
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3020.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3021.1"> * </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3022.1">as</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3023.1"> moment </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3024.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3025.1">'../lib/moment'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3026.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3027.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3028.1"> * </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3029.1">as</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.3030.1">THREE</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3031.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3032.1">'three'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3033.1">;</span></strong></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.3034.1">@Component</span></span><span class="koboSpan" id="kobo.3035.1">({...})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3036.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3037.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3038.1">AppComponent</span></span><span class="koboSpan" id="kobo.3039.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.3040.1">constructor</span></span><span class="koboSpan" id="kobo.3041.1">() {
   </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3042.1">const</span></span><span class="koboSpan" id="kobo.3043.1"> scene = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3044.1">new</span></span> <span class="hljs-variable"><span class="koboSpan" id="kobo.3045.1">THREE</span></span><span class="koboSpan" id="kobo.3046.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3047.1">Scene</span></span><span class="koboSpan" id="kobo.3048.1">(); 
   </span><span class="hljs-variable"><span class="koboSpan" id="kobo.3049.1">console</span></span><span class="koboSpan" id="kobo.3050.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3051.1">log</span></span><span class="koboSpan" id="kobo.3052.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3053.1">moment</span></span><span class="koboSpan" id="kobo.3054.1">().</span><span class="hljs-title"><span class="koboSpan" id="kobo.3055.1">format</span></span><span class="koboSpan" id="kobo.3056.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.3057.1">'MMM Do YYYY'</span></span><span class="koboSpan" id="kobo.3058.1">));
   </span><span class="hljs-variable"><span class="koboSpan" id="kobo.3059.1">console</span></span><span class="koboSpan" id="kobo.3060.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3061.1">log</span></span><span class="koboSpan" id="kobo.3062.1">(scene);
 }
  ...
</span><span class="koboSpan" id="kobo.3062.2">}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.3063.1">Now, build the app again by running the following command from the workspace’s root folder:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3064.1">npm run build ng-perf-budgets
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3065.1">You should see that the bundle size for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3066.1">main.*.js</span></code><span class="koboSpan" id="kobo.3067.1"> file is now somewhat around 1.10 </span><strong class="keyWord"><span class="koboSpan" id="kobo.3068.1">megabytes</span></strong><span class="koboSpan" id="kobo.3069.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.3070.1">MB</span></strong><span class="koboSpan" id="kobo.3071.1">). </span><span class="koboSpan" id="kobo.3071.2">This is a huge increase in size compared to the original ~294 KB, as you can see in the following screenshot:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3072.1"><img alt="" role="presentation" src="../Images/B18469_12_31.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3073.1">Figure 12.31: The bundle size for main.*.js increased to 1.10 MB</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3074.1">Since we’re using NX</span><a id="_idIndexMarker1082"/><span class="koboSpan" id="kobo.3075.1"> for our recipes, we already have the budgets</span><a id="_idIndexMarker1083"/><span class="koboSpan" id="kobo.3076.1"> set by NX. </span><span class="koboSpan" id="kobo.3076.2">However, if you had a regular Angular application (without NX), you would update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3077.1">angular.json</span></code><span class="koboSpan" id="kobo.3078.1"> file to add the budgets.</span></p> </li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.3079.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3080.1">project.json</span></code><span class="koboSpan" id="kobo.3081.1"> file within the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3082.1">start/apps/chapter12/ng-perf-budgets</span></code><span class="koboSpan" id="kobo.3083.1"> folder and update it. </span><span class="koboSpan" id="kobo.3083.2">The property that we’re targeting is </span><code class="inlineCode"><span class="koboSpan" id="kobo.3084.1">targets.build.configurations.production.budgets</span></code><span class="koboSpan" id="kobo.3085.1">. </span><span class="koboSpan" id="kobo.3085.2">The updated code should look like this:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3086.1">...
</span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.3087.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.3088.1">"budgets"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.3089.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.3090.1">[</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.3091.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.3092.1">"type"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.3093.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.3094.1">"initial"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.3095.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.3096.1">"maximumWarning"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.3097.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.3098.1">"</span></span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3099.1">800kb</span></strong></span><span class="hljs-string"><span class="koboSpan" id="kobo.3100.1">"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.3101.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.3102.1">"maximumError"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.3103.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.3104.1">"</span></span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3105.1">1mb</span></strong></span><span class="hljs-string"><span class="koboSpan" id="kobo.3106.1">"</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.3107.1">},</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.3108.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.3109.1">"type"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.3110.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.3111.1">"anyComponentStyle"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.3112.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.3113.1">"maximumWarning"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.3114.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.3115.1">"2kb"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.3116.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.3117.1">"maximumError"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.3118.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.3119.1">"4kb"</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.3120.1">}</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.3121.1">]</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.3122.1">}</span></span><span class="koboSpan" id="kobo.3123.1">
...
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3124.1">Note that we have only changed </span><code class="inlineCode"><span class="koboSpan" id="kobo.3125.1">maximumWarning</span></code><span class="koboSpan" id="kobo.3126.1"> from </span><code class="inlineCode"><span class="koboSpan" id="kobo.3127.1">500kb</span></code><span class="koboSpan" id="kobo.3128.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.3129.1">800kb</span></code><span class="koboSpan" id="kobo.3130.1"> for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3131.1">initial</span></code><span class="koboSpan" id="kobo.3132.1"> bundle.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.3133.1">Let’s improve our application</span><a id="_idIndexMarker1084"/><span class="koboSpan" id="kobo.3134.1"> by not importing the entire libraries</span><a id="_idIndexMarker1085"/><span class="koboSpan" id="kobo.3135.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3136.1">app.component.ts</span></code><span class="koboSpan" id="kobo.3137.1"> file, and by using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3138.1">date-fns</span></code><span class="koboSpan" id="kobo.3139.1"> package instead of </span><code class="inlineCode"><span class="koboSpan" id="kobo.3140.1">moment.js</span></code><span class="koboSpan" id="kobo.3141.1">. </span><span class="koboSpan" id="kobo.3141.2">Run the following command from the workspace’s root folder to install the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3142.1">date-fns</span></code><span class="koboSpan" id="kobo.3143.1"> package:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3144.1">cd start &amp;&amp; npm install --save date-fns
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.3145.1">Now, update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3146.1">app.component.ts</span></code><span class="koboSpan" id="kobo.3147.1"> file, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3148.1">import</span></span><span class="koboSpan" id="kobo.3149.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.3150.1">Component</span></span><span class="koboSpan" id="kobo.3151.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3152.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.3153.1">'@angular/core'</span></span><span class="koboSpan" id="kobo.3154.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3155.1">import</span></span><span class="koboSpan" id="kobo.3156.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.3157.1">Router</span></span><span class="koboSpan" id="kobo.3158.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3159.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.3160.1">'@angular/router'</span></span><span class="koboSpan" id="kobo.3161.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3162.1">import</span></span><span class="koboSpan" id="kobo.3163.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.3164.1">AuthService</span></span><span class="koboSpan" id="kobo.3165.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3166.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.3167.1">'./services/auth.service'</span></span><span class="koboSpan" id="kobo.3168.1">;
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3169.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3170.1"> { format } </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3171.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3172.1">'date-fns'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3173.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3174.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3175.1"> { </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3176.1">Scene</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3177.1"> } </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3178.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3179.1">'three'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3180.1">;</span></strong></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.3181.1">@Component</span></span><span class="koboSpan" id="kobo.3182.1">({...})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3183.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3184.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3185.1">AppComponent</span></span><span class="koboSpan" id="kobo.3186.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.3187.1">constructor</span></span><span class="koboSpan" id="kobo.3188.1">() {
    </span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3189.1">const</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3190.1"> scene = </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3191.1">new</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3192.1">Scene</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3193.1">();</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.3194.1">console</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3195.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3196.1">log</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3197.1">(</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3198.1">format</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3199.1">(</span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3200.1">new</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3201.1">Date</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3202.1">(), </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3203.1">'LLL do yyyy'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3204.1">)); </span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.3205.1">console</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3206.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3207.1">log</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3208.1">(scene);</span></strong></span><span class="koboSpan" id="kobo.3209.1">
  }
  ...
</span><span class="koboSpan" id="kobo.3209.2">}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.3210.1">Run the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3211.1">npm run build ng-perf-budgets </span></code><span class="koboSpan" id="kobo.3212.1">command again. </span><span class="koboSpan" id="kobo.3212.2">You should see a decreased bundle size and the build being generated successfully, as follows:
    </span><figure class="mediaobject"><span class="koboSpan" id="kobo.3213.1"><img alt="" role="presentation" src="../Images/B18469_12_32.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3214.1">Figure 12.32: Reduced bundle size after using date-fns and optimized imports</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.3215.1">Boom! </span><span class="koboSpan" id="kobo.3215.2">You just learned how to use performance budgets</span><a id="_idIndexMarker1086"/><span class="koboSpan" id="kobo.3216.1"> in Angular. </span><span class="koboSpan" id="kobo.3216.2">These budgets</span><a id="_idIndexMarker1087"/><span class="koboSpan" id="kobo.3217.1"> can be used to throw warnings and errors based on your configuration. </span><span class="koboSpan" id="kobo.3217.2">Note that the budgets can be modified based on changing business requirements. </span><span class="koboSpan" id="kobo.3217.3">However, as engineers, we have to be cautious about what we set as performance budgets to not ship JavaScript over a certain limit to the end users.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3218.1">Since you’ve finished the recipe, see the next section on how this works.</span></p>
<h2 class="heading-2" id="_idParaDest-441"><span class="koboSpan" id="kobo.3219.1">How it works…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.3220.1">Angular performance budgets are guidelines set for the acceptable limits of various performance metrics in Angular applications. </span><span class="koboSpan" id="kobo.3220.2">These budgets help ensure that the application’s performance remains within acceptable bounds and does not degrade significantly as the code base grows or changes. </span><span class="koboSpan" id="kobo.3220.3">The most critical performance metric you can work with is the initial bundle size. </span><span class="koboSpan" id="kobo.3220.4">This is what the user’s device will load first as the main set of JavaScript files, and they are eagerly loaded. </span><span class="koboSpan" id="kobo.3220.5">In this recipe, we have two issues. </span><span class="koboSpan" id="kobo.3220.6">First, we use </span><code class="inlineCode"><span class="koboSpan" id="kobo.3221.1">moment.js</span></code><span class="koboSpan" id="kobo.3222.1">, which is a library that is not </span><em class="italic"><span class="koboSpan" id="kobo.3223.1">tree-shakable</span></em><span class="koboSpan" id="kobo.3224.1">. </span><span class="koboSpan" id="kobo.3224.2">This means if we import the library, the whole library is included in the final bundle, whereas tree-shakable libraries have </span><em class="italic"><span class="koboSpan" id="kobo.3225.1">the code not being used </span></em><span class="koboSpan" id="kobo.3226.1">in the application removed by the build tools when you build them. </span><span class="koboSpan" id="kobo.3226.2">The second problem we introduced is that we included the entire library, </span><code class="inlineCode"><span class="koboSpan" id="kobo.3227.1">three</span></code><span class="koboSpan" id="kobo.3228.1">, in our component, which is tree-shakable, but our import is inaccurate. </span><span class="koboSpan" id="kobo.3228.2">We introduced these problems to see the bundle size increase. </span><span class="koboSpan" id="kobo.3228.3">But as we saw, in NX, we can use any Angular app’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.3229.1">project.json</span></code><span class="koboSpan" id="kobo.3230.1"> file to manage the performance budgets. </span><span class="koboSpan" id="kobo.3230.2">If you were working on an Angular CLI-based application, you would do the same in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3231.1">angular.json</span></code><span class="koboSpan" id="kobo.3232.1"> file. </span><span class="koboSpan" id="kobo.3232.2">In practice, you will be using a warning threshold and an error threshold, which ensures</span><a id="_idIndexMarker1088"/><span class="koboSpan" id="kobo.3233.1"> you’re not shipping huge JavaScript bundles</span><a id="_idIndexMarker1089"/><span class="koboSpan" id="kobo.3234.1"> to the end users.</span></p>
<h2 class="heading-2" id="_idParaDest-442"><span class="koboSpan" id="kobo.3235.1">See also</span></h2>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.3236.1">Performance budgets</span><a id="_idIndexMarker1090"/><span class="koboSpan" id="kobo.3237.1"> with the Angular CLI official documentation: </span><a href="https://web.dev/performance-budgets-with-the-angular-cli/"><span class="url"><span class="koboSpan" id="kobo.3238.1">https://web.dev/performance-budgets-with-the-angular-cli/</span></span></a></li>
<li class="bulletList"><em class="italic"><span class="koboSpan" id="kobo.3239.1">Boosting Angular App Performance</span></em><em class="italic"><a id="_idIndexMarker1091"/></em><em class="italic"><span class="koboSpan" id="kobo.3240.1"> with Performance Budgets</span></em><span class="koboSpan" id="kobo.3241.1">: </span><a href="https://www.codewithahsan.dev/blog/angular-performance-budgets"><span class="url"><span class="koboSpan" id="kobo.3242.1">https://www.codewithahsan.dev/blog/angular-performance-budgets</span></span></a></li>
</ul>
<h1 class="heading-1" id="_idParaDest-443"><span class="koboSpan" id="kobo.3243.1">Analyzing bundles with webpack-bundle-analyzer</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3244.1">In the previous recipe, we looked</span><a id="_idIndexMarker1092"/><span class="koboSpan" id="kobo.3245.1"> at configuring budgets for our Angular</span><a id="_idIndexMarker1093"/><span class="koboSpan" id="kobo.3246.1"> app, and this is useful because you get to know when the overall bundle size exceeds a certain threshold, although you don’t get to know how much each part of the code contributes to the final bundles. </span><span class="koboSpan" id="kobo.3246.2">This is what we call </span><em class="italic"><span class="koboSpan" id="kobo.3247.1">analyzing</span></em><span class="koboSpan" id="kobo.3248.1"> the bundles, and in this recipe, you will learn how to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.3249.1">webpack-bundle-analyzer</span></code><span class="koboSpan" id="kobo.3250.1"> to audit the bundle sizes and the factors contributing to them.</span></p>
<h2 class="heading-2" id="_idParaDest-444"><span class="koboSpan" id="kobo.3251.1">Getting ready</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.3252.1">The app that we are going to work with resides in </span><code class="inlineCode"><span class="koboSpan" id="kobo.3253.1">start/apps/chapter12/ng-perf-wba</span></code><span class="koboSpan" id="kobo.3254.1"> inside the cloned repository:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.3255.1">Open the code repository in your code editor.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.3256.1">Open the terminal, navigate to the code repository directory, and run the following command to build the project:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3257.1">npm run build ng-perf-wba
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3258.1">This should build the app, and you should see the following in the terminal:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3259.1"><img alt="" role="presentation" src="../Images/B18469_12_33.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3260.1">Figure 12.33: The ng-perf-wba app running at http://localhost:4200</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.3261.1">Now that we have built the app, let’s see the steps of the recipe in the next section.</span></p>
<h2 class="heading-2" id="_idParaDest-445"><span class="koboSpan" id="kobo.3262.1">How to do it…</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.3263.1">We have an app that is small</span><a id="_idIndexMarker1094"/><span class="koboSpan" id="kobo.3264.1"> in terms of bundle size</span><a id="_idIndexMarker1095"/><span class="koboSpan" id="kobo.3265.1"> at the moment. </span><span class="koboSpan" id="kobo.3265.2">However, this could grow into a huge app with upcoming business requirements. </span><span class="koboSpan" id="kobo.3265.3">For the sake of this recipe, we’ll increase the bundle size deliberately and will then use </span><code class="inlineCode"><span class="koboSpan" id="kobo.3266.1">webpack-bundle-analyzer</span></code><span class="koboSpan" id="kobo.3267.1"> to observe the packages contributing to the large bundle sizes. </span><span class="koboSpan" id="kobo.3267.2">Let’s begin the recipe:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.3268.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3269.1">app.component.ts</span></code><span class="koboSpan" id="kobo.3270.1"> file and update it, as follows:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3271.1">...
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3272.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3273.1"> * </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3274.1">as</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3275.1"> moment </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3276.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3277.1">'../lib/moment'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3278.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3279.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3280.1"> * </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3281.1">as</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.3282.1">THREE</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3283.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3284.1">'three'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3285.1">;</span></strong></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.3286.1">@Component</span></span><span class="koboSpan" id="kobo.3287.1">({...})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3288.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3289.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3290.1">AppComponent</span></span><span class="koboSpan" id="kobo.3291.1"> {
  ...
  </span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3292.1">constructor</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3293.1">() {</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3294.1">const</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3295.1"> scene = </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3296.1">new</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.3297.1">THREE</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3298.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3299.1">Scene</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3300.1">(); </span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.3301.1">console</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3302.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3303.1">log</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3304.1">(</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3305.1">moment</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3306.1">().</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3307.1">format</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3308.1">(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3309.1">'MMM Do YYYY'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3310.1">));</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.3311.1">console</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3312.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3313.1">log</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3314.1">(scene);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3315.1">}</span></strong></span><span class="koboSpan" id="kobo.3316.1">
  ...
</span><span class="koboSpan" id="kobo.3316.2">}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.3317.1">Now, build the app again by running the following command from the workspace root:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3318.1">npm run build ng-perf-wba
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3319.1">You should see that the bundle </span><a id="_idIndexMarker1096"/><span class="koboSpan" id="kobo.3320.1">size for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3321.1">main.*.js</span></code><span class="koboSpan" id="kobo.3322.1"> file is now </span><a id="_idIndexMarker1097"/><span class="koboSpan" id="kobo.3323.1">somewhat around 1.10 MB. </span><span class="koboSpan" id="kobo.3323.2">This is a huge increase in size compared to the original ~294 KB. </span><span class="koboSpan" id="kobo.3323.3">As a result, the </span><strong class="screenText"><span class="koboSpan" id="kobo.3324.1">Initial Total</span></strong><span class="koboSpan" id="kobo.3325.1"> size became 1.15 MB and the build failed, as you can see in the following screenshot:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3326.1"><img alt="" role="presentation" src="../Images/B18469_12_34.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3327.1">Figure 12.34: The build failing due to an increased bundle size</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.3328.1">We’ll first create a build with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3329.1">stats.json</span></code><span class="koboSpan" id="kobo.3330.1"> file, which contains the bundle information in the JSON format. </span><span class="koboSpan" id="kobo.3330.2">To do that, run the following command from the workspace root:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3331.1">npm run build ng-perf-wba with-stats
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.3332.1">Now, run the following command from the workspace root to have the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3333.1">stats.json</span></code><span class="koboSpan" id="kobo.3334.1"> file read by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3335.1">webpack-bundle-analyzer</span></code><span class="koboSpan" id="kobo.3336.1">, as follows:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3337.1">npx webpack-bundle-analyzer ./start/dist/apps/chapter12/ng-perf-wba/stats.json
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3338.1">This will spin up a server with the bundle analysis. </span><span class="koboSpan" id="kobo.3338.2">You should see a new tab opened in your default browser, and it should look like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3339.1"><img alt="" role="presentation" src="../Images/B18469_12_35.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3340.1">Figure 12.35: Bundle analysis using webpack-bundle-analyzer</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="5"><span class="koboSpan" id="kobo.3341.1">Notice that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3342.1">lib</span></code><span class="koboSpan" id="kobo.3343.1"> folder</span><a id="_idIndexMarker1098"/><span class="koboSpan" id="kobo.3344.1"> takes a huge portion</span><a id="_idIndexMarker1099"/><span class="koboSpan" id="kobo.3345.1"> of the bundle size— around 562 KB, which you can check by just doing a mouseover on the </span><strong class="screenText"><span class="koboSpan" id="kobo.3346.1">lib</span></strong><span class="koboSpan" id="kobo.3347.1"> box. </span><span class="koboSpan" id="kobo.3347.2">The overall bundle size is 1.16 MB. </span><span class="koboSpan" id="kobo.3347.3">Let’s try to optimize the bundle size. </span><span class="koboSpan" id="kobo.3347.4">Let’s install the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3348.1">date-fns</span></code><span class="koboSpan" id="kobo.3349.1"> package so that we can use it instead of </span><code class="inlineCode"><span class="koboSpan" id="kobo.3350.1">moment.js</span></code><span class="koboSpan" id="kobo.3351.1">. </span><span class="koboSpan" id="kobo.3351.2">Run the following command from your project root:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3352.1">cd start &amp;&amp; npm install --save date-fns
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.3353.1">Now, update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3354.1">app.component.ts</span></code><span class="koboSpan" id="kobo.3355.1"> file to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3356.1">date-fns</span></code><span class="koboSpan" id="kobo.3357.1"> package’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.3358.1">format</span></code><span class="koboSpan" id="kobo.3359.1"> method instead of using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3360.1">moment().format</span></code><span class="koboSpan" id="kobo.3361.1"> method. </span><span class="koboSpan" id="kobo.3361.2">We’ll also just import the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3362.1">Scene</span></code><span class="koboSpan" id="kobo.3363.1"> class from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3364.1">Three.js</span></code><span class="koboSpan" id="kobo.3365.1"> package instead of importing the whole library. </span><span class="koboSpan" id="kobo.3365.2">The code should look like this:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3366.1">...
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3367.1">import</span></span><span class="koboSpan" id="kobo.3368.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.3369.1">AuthService</span></span><span class="koboSpan" id="kobo.3370.1"> } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3371.1">from</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.3372.1">'./services/auth.service'</span></span><span class="koboSpan" id="kobo.3373.1">;
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3374.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3375.1"> { format } </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3376.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3377.1">'date-fns'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3378.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3379.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3380.1"> { </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3381.1">Scene</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3382.1"> } </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3383.1">from</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3384.1">'three'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3385.1">;</span></strong></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.3386.1">@Component</span></span><span class="koboSpan" id="kobo.3387.1">({...})
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3388.1">export</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3389.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3390.1">AppComponent</span></span><span class="koboSpan" id="kobo.3391.1"> {
  ...
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.3392.1">constructor</span></span><span class="koboSpan" id="kobo.3393.1">() {
    </span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3394.1">const</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3395.1"> scene = </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3396.1">new</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3397.1">Scene</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3398.1">();</span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.3399.1">console</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3400.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3401.1">log</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3402.1">(</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3403.1">format</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3404.1">(</span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3405.1">new</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3406.1">Date</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3407.1">(), </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3408.1">'LLL do yyyy'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3409.1">)); </span></strong></span>
<span class="code-highlight"><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.3410.1">console</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3411.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.3412.1">log</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3413.1">(scene);</span></strong></span><span class="koboSpan" id="kobo.3414.1">
  }
  ...
</span><span class="koboSpan" id="kobo.3414.2">}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.3415.1">Repeat </span><em class="italic"><span class="koboSpan" id="kobo.3416.1">step 3</span></em><span class="koboSpan" id="kobo.3417.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.3418.1">step 4</span></em><span class="koboSpan" id="kobo.3419.1"> to build the app again and to analyze via </span><code class="inlineCode"><span class="koboSpan" id="kobo.3420.1">webpack-bundle-analyzer</span></code><span class="koboSpan" id="kobo.3421.1">.
    </span><p class="normal"><span class="koboSpan" id="kobo.3422.1">Once </span><code class="inlineCode"><span class="koboSpan" id="kobo.3423.1">webpack-bundle-analyzer</span></code><span class="koboSpan" id="kobo.3424.1"> runs, you should see the analysis, as shown in the following screenshot. </span><span class="koboSpan" id="kobo.3424.2">Notice that we don’t have the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3425.1">moment.js</span></code><span class="koboSpan" id="kobo.3426.1"> file or the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3427.1">lib</span></code><span class="koboSpan" id="kobo.3428.1"> block anymore, and the overall bundle size has reduced from 1.16 MB to about 835 KB:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3429.1"><img alt="" role="presentation" src="../Images/B18469_12_36.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3430.1">Figure 12.36: Bundle analysis after optimization</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.3431.1">Woohoo! </span><span class="koboSpan" id="kobo.3431.2">You now know how to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3432.1">webpack-bundle-analyzer</span></code><span class="koboSpan" id="kobo.3433.1"> package to audit bundle sizes in Angular applications. </span><span class="koboSpan" id="kobo.3433.2">This is a great way of improving overall performance because you can identify the chunks causing the increase in the bundle size and then optimize the bundles. </span><span class="koboSpan" id="kobo.3433.3">If you run </span><code class="inlineCode"><span class="koboSpan" id="kobo.3434.1">npm run serve ng-perf-wba</span></code><span class="koboSpan" id="kobo.3435.1"> from the workspace root before</span><a id="_idIndexMarker1100"/><span class="koboSpan" id="kobo.3436.1"> and after the optimization, you will see the same console logs, which show that we kept the existing</span><a id="_idIndexMarker1101"/><span class="koboSpan" id="kobo.3437.1"> functionality and optimized the bundles anyway.</span></p>
<h2 class="heading-2" id="_idParaDest-446"><span class="koboSpan" id="kobo.3438.1">See also</span></h2>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.3439.1">Getting started</span><a id="_idIndexMarker1102"/><span class="koboSpan" id="kobo.3440.1"> with webpack: </span><a href="https://webpack.js.org/guides/getting-started/"><span class="url"><span class="koboSpan" id="kobo.3441.1">https://webpack.js.org/guides/getting-started/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3442.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3443.1">webpack-bundle-analyzer</span></code><span class="koboSpan" id="kobo.3444.1"> GitHub repository: </span><a href="https://github.com/webpack-contrib/webpack-bundle-analyzer"><span class="url"><span class="koboSpan" id="kobo.3445.1">https://github.com/webpack-contrib/webpack-bundle-analyzer</span></span></a></li>
</ul>
<h1 class="heading-1"><span class="koboSpan" id="kobo.3446.1">Learn more on Discord</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3447.1">To join the Discord community for this book – where you can share feedback, ask questions to the author, and learn about new releases – follow the QR code below:</span></p>
<p class="normal"><a href="Chapter_12.xhtml"><span class="url"><span class="koboSpan" id="kobo.3448.1">https://packt.link/AngularCookbook2e</span></span></a></p>
<p class="normal"><span class="koboSpan" id="kobo.3449.1"><img alt="" role="presentation" src="../Images/QR_Code1388317275422265.png"/></span></p>
</div>
</body></html>