<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Unit Testing Our Application</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we will cover Angular testing in detail. We will start with a basic introduction to Angular testing and learn about tools and technologies used for unit testing. We will write unit tests for our login component using Angular testing framework and configure a dependent module. We will also unit test our user service. As part of our testing, we will create stubs for dependent services or components so that we can focus only on the class unit under test. We will unit test our component and service using Angular framework so that dependent modules are initialized. We will test an Angular pipe in isolation so that the pipe is initialized directly using a <kbd class="calibre11">new</kbd> keyword. Finally, we will take a look at the code coverage for our code.</p>
<p class="calibre2">In this chapter, <span>we will cover </span>the following topics:</p>
<ul class="calibre7">
<li class="calibre8">Introduction to Angular testing</li>
<li class="calibre8">Unit testing an Angular component</li>
<li class="calibre8">Unit testing Angular services</li>
<li class="calibre8">Unit testing Angular pipe</li>
<li class="calibre8">Introduction to code coverage</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Introduction to Angular testing</h1>
                
            
            <article>
                
<p class="calibre2">Unit testing is an important part of a software development life cycle. The benefits of unit testing are as follows:</p>
<ul class="calibre7">
<li class="calibre8">It helps to align our implementation with the design</li>
<li class="calibre8">It helps in protecting our application from regression</li>
<li class="calibre8">Refactoring becomes easier if we have good test cases</li>
</ul>
<p class="calibre2">Angular provides various tools and technologies to test our application. As a part of our unit testing, we will use the following technologies:</p>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Jasmine</strong>: This provides the basic skeleton to write our unit test. It comes with a HTML test runner and runs on a browser.</li>
<li class="calibre8"><strong class="calibre1">Angular testing framework:</strong> This comes along with Angular framework and helps to create a test environment for Angular code under test. It also gives us access to DOM elements.</li>
<li class="calibre8"><strong class="calibre1">Karma</strong>: We use the Karma tool to run our application. We run our unit tests using the following command:</li>
</ul>
<pre class="calibre19"><strong class="calibre1">$ng test</strong></pre>
<p class="calibre2">We can write two types of Angular test:</p>
<ul class="calibre7">
<li class="calibre8"><strong class="calibre1">Unit testing with Angular test framework</strong>: We will use Angular test framework to write unit tests for our component and services. This will create a test environment and provide us access to various elements of the Angular framework.</li>
<li class="calibre8"><strong class="calibre1">Isolated unit test</strong>: We can write independent unit tests without Angular dependency. This kind of unit test is really useful for testing services and pipes. In this chapter, we will test our date pipe this way.</li>
</ul>
<div class="packt_infobox"><span class="calibre20">It is good to note that it is always better to stick to isolated unit tests when you can, and to try to write as few integrated and end-to-end tests whenever possible, because isolated unit tests are the easiest to maintain.</span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Unit testing an Angular component</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we will write our first Angular test for the login component. The steps involved in writing test cases are as follows:</p>
<ol class="calibre13">
<li value="1" class="calibre8"><strong class="calibre1">Identifying the class under test</strong>: The first step in writing unit test cases is to identify the dependencies. The login component <kbd class="calibre11">constructor</kbd> shows all the dependencies and is dependent on <kbd class="calibre11">UserService</kbd>, <kbd class="calibre11">Router</kbd>, <kbd class="calibre11">AuthenticationService</kbd>, and <kbd class="calibre11">AngularFireAuth</kbd>:</li>
</ol>
<pre class="calibre18"><span>constructor</span>(<span>private </span>userService: UserService,<br class="title-page-name"/>         <span>private </span>router: Router,<br class="title-page-name"/>         <span>private </span>authService: AuthenticationService,<br class="title-page-name"/>         <span>private </span>angularFireAuth: AngularFireAuth)</pre>
<ol start="2" class="calibre13">
<li value="2" class="calibre8"><strong class="calibre1">Creating all the mock or stubs classes</strong>: Once we identify all the dependencies, we need to eliminate these external dependencies and concentrate only on the component class under test. So we create mock or stub classes to eliminate these dependencies.</li>
</ol>
<p class="mce-root">In the login component, we use user service to retrieve user information using the <kbd class="calibre11">getUser()</kbd> method so we create <kbd class="calibre11">UserServiceStub</kbd> with the <kbd class="calibre11">getUser()</kbd> method, which returns mock user <span>encapsulates in an <kbd class="calibre11">Observable</kbd> object</span>; we create a test data class for the mock user, that contains user details, as follows:</p>
<pre class="calibre18"><span>class </span>UserServiceStub {<br class="title-page-name"/><br class="title-page-name"/>   <span>getUser</span>(): Observable&lt;User&gt; {<br class="title-page-name"/>      <span>return </span>Observable.<span>of</span>(<span>mockUserJSON</span>);<br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>}</pre>
<p class="mce-root"><span>Here's a sample <kbd class="calibre11">user-test-data.ts</kbd></span> file:</p>
<pre class="calibre18"><span>export const </span><span>mockUserJSON </span>= {<br class="title-page-name"/>   <span>email</span>: <span>'user@gmail.com'</span>,<br class="title-page-name"/>   <span>friendcount</span>: <span>0</span>,<br class="title-page-name"/>   <span>image</span>: <span>''</span>,<br class="title-page-name"/>   <span>mobile</span>: <span>'9999999999'</span>,<br class="title-page-name"/>   <span>name</span>: <span>'User'</span>,<br class="title-page-name"/>   <span>uid</span>: <span>'XXXX'<br class="title-page-name"/></span>};</pre>
<p class="mce-root">We use an authentication service in the login component to log in and reset the password so we create an <span><kbd class="calibre11">AuthenticationServiceStub</kbd> class with an empty <kbd class="calibre11">login()</kbd> and <kbd class="calibre11">resetPassword()</kbd> methods:</span></p>
<pre class="calibre18"><span>class </span>AuthenticationServiceStub {<br class="title-page-name"/><br class="title-page-name"/>   <span>login</span>(email: <span>string</span>, password: <span>string</span>) {}<br class="title-page-name"/><br class="title-page-name"/>   <span>resetPassword</span>(email: <span>string</span>) {}<br class="title-page-name"/>}</pre>
<p class="mce-root">The <kbd class="calibre11">AngularFireAuth</kbd> class is part of Angular's Fire library. This class is responsible for authentication in our application and contains an <kbd class="calibre11">auth</kbd> object, so we create a stub for the <kbd class="calibre11">auth</kbd> class, too:</p>
<pre class="calibre18"><span>class </span>AngularFireAuthStub {<br class="title-page-name"/>   <span>readonly </span><span>auth</span>: AuthStub = <span>new </span>AuthStub();,<br class="title-page-name"/>}</pre>
<p class="mce-root"><span>Here's the <kbd class="calibre11">AuthStub</kbd> class</span><span>:</span></p>
<pre class="calibre18"><span>class </span>AuthStub {<br class="title-page-name"/><br class="title-page-name"/>   <span>onAuthStateChanged</span>() {<br class="title-page-name"/>      <span>return </span>Observable.<span>of</span>({<span>uid</span>: <span>'1234'</span>});<br class="title-page-name"/>   }<br class="title-page-name"/>}</pre>
<p class="mce-root">Finally, we use a router to navigate to pages in our application. This provider is part of Angular framework. We create a stub for this class as well:</p>
<pre class="calibre18"><span>class </span>RouterStub {<br class="title-page-name"/>   <span>navigateByUrl</span>(url: <span>string</span>) {<br class="title-page-name"/>      <span>return </span>url;<br class="title-page-name"/>   }<br class="title-page-name"/>}</pre>
<ol start="3" class="calibre13">
<li value="3" class="calibre8"><strong class="calibre1">Creating the test suites</strong>: Once we eliminate the external dependencies, we can create test suites within the <kbd class="calibre11">describe()</kbd> method in Jasmine framework. This method accepts <kbd class="calibre11">description</kbd> for test suites and the <kbd class="calibre11">specDefinitions</kbd> function for Jasmine framework to invoke inner suites of specs: </li>
</ol>
<pre class="calibre18"><span>describe</span>(description: <span>string</span>, specDefinitions: () =&gt; <span>void</span>)</pre>
<ol start="4" class="calibre13">
<li value="4" class="calibre8"><strong class="calibre1">Creating the test environment</strong>: We create the Angular test environment for components under test. Angular provides a <kbd class="calibre11">TestBed</kbd> class to create the test environment; it initializes the dependent modules, providers, services, and components. We call a <kbd class="calibre11">TestBed.configureTestingModule()</kbd> method within <kbd class="calibre11">beforeEach()</kbd> so that this configures modules before each test case execution:</li>
</ol>
<pre class="calibre18"><span>beforeEach</span>(<span>async</span>(() =&gt; {<br class="title-page-name"/><br class="title-page-name"/>  TestBed.<span>configureTestingModule</span>({<br class="title-page-name"/>    <span>declarations</span>: [<br class="title-page-name"/>      LoginComponent,<br class="title-page-name"/>      ErrorAlertComponent<br class="title-page-name"/>    ],<br class="title-page-name"/>    <span>imports</span>: [<br class="title-page-name"/>      CommonModule,<br class="title-page-name"/>      BrowserModule,<br class="title-page-name"/>      FormsModule<br class="title-page-name"/>    ],<br class="title-page-name"/>    <span>providers</span>: [<br class="title-page-name"/>      {<span>provide</span>: UserService, <span>useClass</span>: UserServiceStub},<br class="title-page-name"/>      {<span>provide</span>: Router, <span>useClass</span>: RouterStub},<br class="title-page-name"/>      {<span>provide</span>: AuthenticationService, <span>useValue</span>: <span>mockAuthService</span>},<br class="title-page-name"/>      {<span>provide</span>: AngularFireAuth, <span>useClass</span>: AngularFireAuthStub}<br class="title-page-name"/>    ]<br class="title-page-name"/>  }).<span>compileComponents</span>();<br class="title-page-name"/>}));</pre>
<ol start="5" class="calibre13">
<li class="calibre8" value="5"><strong class="calibre1">Initializing the testing objects</strong>: Once we configure modules, we can create a login component fixture using <kbd class="calibre11">TestBed.createComponent()</kbd> and initialize the login component and debug element:</li>
</ol>
<pre class="calibre18"><span>beforeEach</span>(() =&gt; {<br class="title-page-name"/>   <span>fixture </span>= TestBed.<span>createComponent</span>(LoginComponent);<br class="title-page-name"/>   <span>component </span>= <span>fixture</span>.<span>componentInstance</span>;<br class="title-page-name"/>   <span>de </span>= <span>fixture</span>.<span>debugElement</span>;<br class="title-page-name"/>   <span>fixture</span>.<span>detectChanges</span>();<br class="title-page-name"/>});</pre>
<ol start="6" class="calibre13">
<li value="6" class="calibre8"><strong class="calibre1">Writing our first test</strong>: The final step is to write the test cases. Our first test case is to check whether the login component is instantiated or not. We will the write test case within the <kbd class="calibre11">it()</kbd> method and use <kbd class="calibre11">expect()</kbd> to validate the instance:</li>
</ol>
<pre class="calibre18"><span>it</span>(<span>'Should instantiate LoginComponent'</span>, <span>async</span>(() =&gt; {<br class="title-page-name"/>   <span>expect</span>(<span>component </span><span>instanceof </span>LoginComponent).<span>toBe</span>(<span>true</span>,<br class="title-page-name"/>      <span>'LoginComponent not created'</span>);<br class="title-page-name"/>}));</pre>
<ol start="7" class="calibre13">
<li value="7" class="calibre8"><strong class="calibre1">Destroying the created instance:</strong> After each test case, we clear the instance in the <kbd class="calibre11">afterEach()</kbd> method, as follows:</li>
</ol>
<pre class="calibre18"><span>afterEach</span>(<span>async</span>(() =&gt; {<br class="title-page-name"/>   <span>fixture</span>.<span>detectChanges</span>();<br class="title-page-name"/>   <span>fixture</span>.<span>whenStable</span>().<span>then</span>(() =&gt; <span>fixture</span>.<span>destroy</span>());<br class="title-page-name"/>}));</pre>
<ol start="8" class="calibre13">
<li value="8" class="calibre8"><strong class="calibre1">Running the test</strong>: Finally, we run our first test case using the following command:</li>
</ol>
<pre class="calibre18"><strong class="calibre1">$ng test</strong></pre>
<p class="mce-root">After its successful run, this opens in a browser and shows the status as 1 spec successful with 0 failures:</p>
<div class="cdpaligncenter"><img src="../images/00033.jpeg" class="calibre57"/></div>
<ol start="9" class="calibre13">
<li value="9" class="calibre8"><strong class="calibre1">Adding more unit tests</strong>:I<span>n the next test case, we check whether the <kbd class="calibre11">login</kbd> method of our service is called when a user enters their email and password and clicks on the</span> <span>LOGIN</span> <span>button</span>. First, we initialize the DOM elements, such as email input text, password input text, and login button. Next, we initialize the default values for email and password and <kbd class="calibre11">spyOn</kbd> the service login method so that this mock method is called when the user clicks on the <span>LOGIN</span> button. After the <span>LOGIN</span> button is clicked, we then call <kbd class="calibre11">detectChanges()</kbd> to notify the DOM to refresh the elements. Finally, we validate that the <kbd class="calibre11">login()</kbd> method should be called: </li>
</ol>
<pre class="calibre18"><span>it</span>(<span>'Should call login'</span>, <span>async</span>(() =&gt; {<br class="title-page-name"/>   <span>const </span><span>loginButton </span>= <span>de</span>.<span>query</span>(By.<span>css</span>(<span>'#login-btn'</span>));<br class="title-page-name"/>   <span>expect</span>(<span>loginButton</span>).<span>not</span>.<span>toBeNull</span>(<span>'Login button not found'</span>);<br class="title-page-name"/><br class="title-page-name"/>   <span>spyOn</span>(<span>mockAuthService</span>, <span>'login'</span>).<span>and</span>.<span>callThrough</span>();<br class="title-page-name"/>   <span>de</span>.<span>query</span>(By.<span>css</span>(<span>'#email'</span>)).<span>nativeElement</span>.<span>value </span>= <br class="title-page-name"/><span>   'user@gmail.com'</span>;<br class="title-page-name"/>   <span>de</span>.<span>query</span>(By.<span>css</span>(<span>'#password'</span>)).<span>nativeElement</span>.<span>value </span>= <span>'password'</span>;<br class="title-page-name"/>   <span>fixture</span>.<span>detectChanges</span>();<br class="title-page-name"/><br class="title-page-name"/>   <span>// Click on Login button </span><br class="title-page-name"/>   <span>loginButton</span>.<span>nativeElement</span>.<span>click</span>();<br class="title-page-name"/>   <span>fixture</span>.<span>detectChanges</span>();<br class="title-page-name"/>   <span>expect</span>(<span>mockAuthService</span>.<span>login</span>).<span>toHaveBeenCalled</span>();<br class="title-page-name"/>}));</pre>
<p class="calibre2"><span>Here's the <kbd class="calibre11">login.component.spec.ts</kbd> file </span><span>as of now:</span></p>
<pre class="calibre17"><span>import </span>{<span>async</span>, ComponentFixture, TestBed} <span>from </span><span>'@angular/core/testing'</span>;<br class="title-page-name"/><span>import </span>{LoginComponent} <span>from </span><span>'./login.component'</span>;<br class="title-page-name"/><span>import </span>{Router} <span>from </span><span>'@angular/router'</span>;<br class="title-page-name"/><span>import </span>{UserService} <span>from </span><span>'../../services/user.service'</span>;<br class="title-page-name"/><span>import </span>{Observable} <span>from </span><span>'rxjs/Observable'</span>;<br class="title-page-name"/><span>import </span>{User} <span>from </span><span>'../../services/user'</span>;<br class="title-page-name"/><span>import </span>{<span>mockUserJSON</span>} <span>from </span><span>'../../test-data/user-test-data'</span>;<br class="title-page-name"/><span>import </span>{AuthenticationService} <span>from </span><span>'../../services/authentication.service'</span>;<br class="title-page-name"/><span>import </span>{AngularFireAuth} <span>from </span><span>'angularfire2/auth'</span>;<br class="title-page-name"/><span>import </span>{CommonModule} <span>from </span><span>'@angular/common'</span>;<br class="title-page-name"/><span>import </span>{BrowserModule, By} <span>from </span><span>'@angular/platform-browser'</span>;<br class="title-page-name"/><span>import </span>{FormsModule} <span>from </span><span>'@angular/forms'</span>;<br class="title-page-name"/><span>import </span>{DebugElement} <span>from </span><span>'@angular/core'</span>;<br class="title-page-name"/><span>import </span>{ErrorAlertComponent} <span>from </span><span>'../../shared/error-alert/error-alert.component'</span>;<br class="title-page-name"/><br class="title-page-name"/><span>class </span>RouterStub {<br class="title-page-name"/>  <span>navigateByUrl</span>(url: <span>string</span>) {<br class="title-page-name"/>    <span>return </span>url;<br class="title-page-name"/>  }<br class="title-page-name"/>}<br class="title-page-name"/><br class="title-page-name"/><span>class </span>UserServiceStub {<br class="title-page-name"/><br class="title-page-name"/>  <span>getUser</span>(): Observable&lt;User&gt; {<br class="title-page-name"/>    <span>return </span>Observable.<span>of</span>(<span>mockUserJSON</span>);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>}<br class="title-page-name"/><br class="title-page-name"/><span>class </span>AuthenticationServiceStub {<br class="title-page-name"/><br class="title-page-name"/>  <span>login</span>(email: <span>string</span>, password: <span>string</span>) {<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  <span>resetPassword</span>(email: <span>string</span>) {<br class="title-page-name"/>  }<br class="title-page-name"/>}<br class="title-page-name"/><br class="title-page-name"/><span>class </span>AngularFireAuthStub {<br class="title-page-name"/>  <span>readonly </span><span>auth</span>: AuthStub = <span>new </span>AuthStub();<br class="title-page-name"/>}<br class="title-page-name"/><br class="title-page-name"/><span>class </span>AuthStub {<br class="title-page-name"/><br class="title-page-name"/>  <span>onAuthStateChanged</span>() {<br class="title-page-name"/>    <span>return </span>Observable.<span>of</span>({<span>uid</span>: <span>'1234'</span>});<br class="title-page-name"/>  }<br class="title-page-name"/>}<br class="title-page-name"/><br class="title-page-name"/><br class="title-page-name"/><span>describe</span>(<span>'LoginComponent with tests'</span>, () =&gt; {<br class="title-page-name"/><br class="title-page-name"/>  <span>let </span><span>fixture</span>: ComponentFixture&lt;LoginComponent&gt;;<br class="title-page-name"/>  <span>let </span><span>component</span>: LoginComponent;<br class="title-page-name"/>  <span>let </span><span>de</span>: DebugElement;<br class="title-page-name"/>  <span>const </span><span>mockAuthService</span>: AuthenticationServiceStub = <span>new <br class="title-page-name"/></span>  AuthenticationServiceStub();<br class="title-page-name"/><br class="title-page-name"/>  <span>beforeEach</span>(<span>async</span>(() =&gt; {<br class="title-page-name"/><br class="title-page-name"/>    TestBed.<span>configureTestingModule</span>({<br class="title-page-name"/>      <span>declarations</span>: [<br class="title-page-name"/>        LoginComponent,<br class="title-page-name"/>        ErrorAlertComponent<br class="title-page-name"/>      ],<br class="title-page-name"/>      <span>imports</span>: [<br class="title-page-name"/>        CommonModule,<br class="title-page-name"/>        BrowserModule,<br class="title-page-name"/>        FormsModule<br class="title-page-name"/>      ],<br class="title-page-name"/>      <span>providers</span>: [<br class="title-page-name"/>        {<span>provide</span>: UserService, <span>useClass</span>: UserServiceStub},<br class="title-page-name"/>        {<span>provide</span>: Router, <span>useClass</span>: RouterStub},<br class="title-page-name"/>        {<span>provide</span>: AuthenticationService, <span>useValue</span>: <span>mockAuthService</span>},<br class="title-page-name"/>        {<span>provide</span>: AngularFireAuth, <span>useClass</span>: AngularFireAuthStub}<br class="title-page-name"/>      ]<br class="title-page-name"/>    }).<span>compileComponents</span>();<br class="title-page-name"/>  }));<br class="title-page-name"/><br class="title-page-name"/>  <span>beforeEach</span>(() =&gt; {<br class="title-page-name"/>    <span>fixture </span>= TestBed.<span>createComponent</span>(LoginComponent);<br class="title-page-name"/>    <span>component </span>= <span>fixture</span>.<span>componentInstance</span>;<br class="title-page-name"/>    <span>de </span>= <span>fixture</span>.<span>debugElement</span>;<br class="title-page-name"/>    <span>fixture</span>.<span>detectChanges</span>();<br class="title-page-name"/>  });<br class="title-page-name"/><br class="title-page-name"/>  <span>afterEach</span>(<span>async</span>(() =&gt; {<br class="title-page-name"/>    <span>fixture</span>.<span>detectChanges</span>();<br class="title-page-name"/>    <span>fixture</span>.<span>whenStable</span>().<span>then</span>(() =&gt; <span>fixture</span>.<span>destroy</span>());<br class="title-page-name"/>  }));<br class="title-page-name"/><br class="title-page-name"/>  <span>it</span>(<span>'Should instantiate LoginComponent'</span>, <span>async</span>(() =&gt; {<br class="title-page-name"/>    <span>expect</span>(<span>component </span><span>instanceof </span>LoginComponent).<span>toBe</span>(<span>true</span>,<br class="title-page-name"/>      <span>'LoginComponent not created'</span>);<br class="title-page-name"/>  }));<br class="title-page-name"/><br class="title-page-name"/>  <span>it</span>(<span>'Should call login'</span>, <span>async</span>(() =&gt; {<br class="title-page-name"/>    <span>const </span><span>loginButton </span>= <span>de</span>.<span>query</span>(By.<span>css</span>(<span>'#login-btn'</span>));<br class="title-page-name"/>    <span>expect</span>(<span>loginButton</span>).<span>not</span>.<span>toBeNull</span>(<span>'Login button not found'</span>);<br class="title-page-name"/><br class="title-page-name"/>    <span>spyOn</span>(<span>mockAuthService</span>, <span>'login'</span>).<span>and</span>.<span>callThrough</span>();<br class="title-page-name"/>    <span>de</span>.<span>query</span>(By.<span>css</span>(<span>'#email'</span>)).<span>nativeElement</span>.<span>value </span>= <span>'user@gmail.com'</span>;<br class="title-page-name"/>    <span>de</span>.<span>query</span>(By.<span>css</span>(<span>'#password'</span>)).<span>nativeElement</span>.<span>value </span>= <span>'password'</span>;<br class="title-page-name"/>    <span>fixture</span>.<span>detectChanges</span>();<br class="title-page-name"/><br class="title-page-name"/>    <span>// Login button is enabled<br class="title-page-name"/></span><span>    </span><span>expect</span>(<span>loginButton</span>.<span>nativeElement</span>.<span>disabled</span>).<span>toBe</span>(<span>false</span>);<br class="title-page-name"/>    <span>loginButton</span>.<span>nativeElement</span>.<span>click</span>();<br class="title-page-name"/>    <span>fixture</span>.<span>detectChanges</span>();<br class="title-page-name"/>    <span>expect</span>(<span>mockAuthService</span>.<span>login</span>).<span>toHaveBeenCalled</span>();<br class="title-page-name"/>  }));<br class="title-page-name"/><br class="title-page-name"/>});</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Unit testing an Angular service</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we unit test an Angular service and we write test cases for our user service. The steps for unit testing a service are the same as for our component. </p>
<p class="calibre2">The first step in writing unit test cases is to analyze the dependent components, as we see user service is dependent on <kbd class="calibre11">AngularFireDatabase</kbd> and initializes the Firebase storage object:</p>
<pre class="calibre17"><span>constructor</span>(<span>private </span>fireDb: AngularFireDatabase)</pre>
<p class="calibre2"><span>So we create a stub for this dependent object such as <kbd class="calibre11">AngularFireDatabaseStub</kbd></span>,<span> which contains other dependent stubs such as <kbd class="calibre11">AngularFireAppStub</kbd> and <kbd class="calibre11">AngularFireObjectStub</kbd> object references and the <kbd class="calibre11">object()</kbd> method:</span></p>
<pre class="calibre17"><span>class </span>AngularFireDatabaseStub {<br class="title-page-name"/><br class="title-page-name"/>   <span>app</span>: AngularFireAppStub = <span>new </span>AngularFireAppStub;<br class="title-page-name"/><br class="title-page-name"/>   <span>angularFireObject</span>: AngularFireObjectStub;<br class="title-page-name"/><br class="title-page-name"/>   <span>constructor</span>(angularFireObject: AngularFireObjectStub) {<br class="title-page-name"/>      <span>this</span>.<span>angularFireObject </span>= angularFireObject;<br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>   <span>object</span>(pathOrRef: PathReference): AngularFireObjectStub {<br class="title-page-name"/>      <span>return this</span>.<span>angularFireObject</span>;<br class="title-page-name"/>   }<br class="title-page-name"/>}</pre>
<p class="calibre2">The following is the <span><kbd class="calibre11">AngularFireAppStub</kbd> stub class with an empty mock method</span><span>:</span></p>
<pre class="calibre17"><span>class </span>AngularFireAppStub {<br class="title-page-name"/><br class="title-page-name"/>   <span>storage</span>() {}<br class="title-page-name"/>}</pre>
<p class="calibre2">The following is the <span><kbd class="calibre11">AngularFireObjectStub</kbd> stub class with empty mock methods</span><span>:</span></p>
<pre class="calibre17"><span>class </span>AngularFireObjectStub {<br class="title-page-name"/><br class="title-page-name"/>   <span>set</span>() {}<br class="title-page-name"/><br class="title-page-name"/>   <span>valueChanges</span>() {}<br class="title-page-name"/><br class="title-page-name"/>   <span>update</span>() {}<br class="title-page-name"/><br class="title-page-name"/>}</pre>
<p class="calibre2">The next step is to initialize the test environment using <kbd class="calibre11">TestBed</kbd> and retrieve the user service object using <kbd class="calibre11">TestBed.get()</kbd>:</p>
<pre class="calibre17"><span>const </span><span>angularFireObject</span>: AngularFireObjectStub = <span>new </span>AngularFireObjectStub();<br class="title-page-name"/><span>const </span><span>mockAngularFireDatabase</span>: AngularFireDatabaseStub = <span>new </span>AngularFireDatabaseStub(<span>angularFireObject</span>);<br class="title-page-name"/><span>let </span><span>userService</span>: UserService;<br class="title-page-name"/><br class="title-page-name"/><span>beforeEach</span>(() =&gt; {<br class="title-page-name"/>   TestBed.<span>configureTestingModule</span>({<br class="title-page-name"/>      <span>providers</span>: [<br class="title-page-name"/>         {<span>provide</span>: AngularFireDatabase, <span>useValue</span>: <br class="title-page-name"/><span>          mockAngularFireDatabase</span>},<br class="title-page-name"/>         {<span>provide</span>: UserService, <span>useClass</span>: UserService}<br class="title-page-name"/>      ]<br class="title-page-name"/>   });<br class="title-page-name"/>   <span>userService </span>= TestBed.<span>get</span>(UserService);<br class="title-page-name"/>});</pre>
<p class="calibre2">Now, we will start writing the test cases for our user service. We will cover the following test cases for the user service:</p>
<ul class="calibre7">
<li class="calibre8">The first test case is to add a user to Firebase database. We will add <kbd class="calibre11">spyOn</kbd> to the <kbd class="calibre11">set</kbd> method of Angular's fire object and call the add user method using mock user; then we expect the <kbd class="calibre11">set</kbd> method of Angular fire object to be called: </li>
</ul>
<pre class="calibre18"><span>it</span>(<span>'Add user'</span>, () =&gt; {<br class="title-page-name"/>   <span>spyOn</span>(<span>angularFireObject</span>, <span>'set'</span>);<br class="title-page-name"/>   <span>userService</span>.<span>addUser</span>(<span>mockUserJSON</span>);<br class="title-page-name"/>   <span>expect</span>(<span>angularFireObject</span>.<span>set</span>).<span>toHaveBeenCalled</span>();<br class="title-page-name"/>});</pre>
<p class="calibre2"><span>The next test case is to receive our user from the Firebase database. We add <kbd class="calibre11">spyOn</kbd></span>, <span>the value change method of Angular's fire object, which returns a mock user. We then call a <kbd class="calibre11">getUser</kbd> method, subscribe to the <kbd class="calibre11">Observable</kbd> object, and then we validate the method call and also test the content of our mock user with the expected values:</span></p>
<pre class="calibre18"><span>it</span>(<span>'getUser return valid user'</span>, () =&gt; {<br class="title-page-name"/>   <span>spyOn</span>(<span>angularFireObject</span>, <br class="title-page-name"/><span>   'valueChanges'</span>).<span>and</span>.<span>returnValue</span>(Observable.<span>of</span>(<span>mockUserJSON</span>));<br class="title-page-name"/>   <span>userService</span>.<span>getUser</span>(<span>mockUserJSON</span>.<span>uid</span>).<span>subscribe</span>((user) =&gt; {<br class="title-page-name"/>      <span>expect</span>(<span>angularFireObject</span>.<span>valueChanges</span>).<span>toHaveBeenCalled</span>();<br class="title-page-name"/>      <span>expect</span>(user.<span>uid</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>uid</span>);<br class="title-page-name"/>      <span>expect</span>(user.<span>name</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>name</span>);<br class="title-page-name"/>      <span>expect</span>(user.<span>mobile</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>mobile</span>);<br class="title-page-name"/>      <span>expect</span>(user.<span>email</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>email</span>);<br class="title-page-name"/>   });<br class="title-page-name"/><br class="title-page-name"/>});</pre>
<ol start="3" class="calibre13">
<li value="3" class="calibre8"><span>The next test case is to save the user in <kbd class="calibre11">member</kbd> variables. In this test case, we will save a mock user in an <kbd class="calibre11">Observable</kbd></span>, <span>t</span><span>hen retrieve the user using a <kbd class="calibre11">get</kbd> method, and validate all properties of the mock user:</span></li>
</ol>
<pre class="calibre18"><span>it</span>(<span>'saveUser saves user in Subject'</span>, () =&gt; {<br class="title-page-name"/>   <span>userService</span>.<span>saveUser</span>(<span>mockUserJSON</span>);<br class="title-page-name"/>   <span>userService</span>.<span>getSavedUser</span>().<span>subscribe</span>((user) =&gt; {<br class="title-page-name"/>      <span>expect</span>(user.<span>uid</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>uid</span>);<br class="title-page-name"/>      <span>expect</span>(user.<span>name</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>name</span>);<br class="title-page-name"/>      <span>expect</span>(user.<span>mobile</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>mobile</span>);<br class="title-page-name"/>      <span>expect</span>(user.<span>email</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>email</span>);<br class="title-page-name"/>   });<br class="title-page-name"/><br class="title-page-name"/>});</pre>
<ol start="4" class="calibre13">
<li value="4" class="calibre8"><span>The next test case is to update the email in the Firebase database and also update the cache user object in the user service class; we spy on the <kbd class="calibre11">update</kbd> method of Angular's fire object, pass a new email to update the <kbd class="calibre11">email</kbd> method, which updates the Firebase database and the cache user object,</span><span> test the Firebase database call, retrieve the user from the <kbd class="calibre11">get</kbd> method, and validate all the properties of the mock user:</span></li>
</ol>
<pre class="calibre18"><span>it</span>(<span>'updateEmail update the email'</span>, () =&gt; {<br class="title-page-name"/>   <span>spyOn</span>(<span>angularFireObject</span>, <span>'update'</span>);<br class="title-page-name"/>   <span>userService</span>.<span>saveUser</span>(<span>mockUserJSON</span>);<br class="title-page-name"/>   <span>mockUserJSON</span>.<span>email </span>= <span>'user1@gmail.com'</span>;<br class="title-page-name"/>   <span>userService</span>.<span>updateEmail</span>(<span>mockUserJSON </span>, <span>mockUserJSON</span>.<span>email</span>);<br class="title-page-name"/>   <span>userService</span>.<span>getSavedUser</span>().<span>subscribe</span>((user) =&gt; {<br class="title-page-name"/>      <span>expect</span>(<span>angularFireObject</span>.<span>update</span>).<span>toHaveBeenCalled</span>();<br class="title-page-name"/>      <span>expect</span>(user.<span>email</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>email</span>);<br class="title-page-name"/>   });<br class="title-page-name"/><br class="title-page-name"/>});</pre>
<p class="calibre2"><span>Here's the <kbd class="calibre11">user.service.spec.ts</kbd> file </span><span>as of now:</span></p>
<pre class="calibre17"><span>import </span>{UserService} <span>from </span><span>'./user.service'</span>;<br class="title-page-name"/><span>import </span>{AngularFireDatabase, PathReference} <span>from </span><span>'angularfire2/database'</span>;<br class="title-page-name"/><span>import </span>{FirebaseApp} <span>from </span><span>'angularfire2'</span>;<br class="title-page-name"/><span>import </span>{<span>mockUserJSON</span>} <span>from </span><span>'../test-data/user-test-data'</span>;<br class="title-page-name"/><span>import </span>{AngularFireAuth} <span>from </span><span>'angularfire2/auth'</span>;<br class="title-page-name"/><span>import </span>{TestBed} <span>from </span><span>'@angular/core/testing'</span>;<br class="title-page-name"/><span>import </span>{Observable} <span>from </span><span>'rxjs/Observable'</span>;<br class="title-page-name"/><span>import </span>{User} <span>from </span><span>'./user'</span>;<br class="title-page-name"/><br class="title-page-name"/><span>class </span>AngularFireDatabaseStub {<br class="title-page-name"/><br class="title-page-name"/>   <span>app</span>: AngularFireAppStub = <span>new </span>AngularFireAppStub;<br class="title-page-name"/><br class="title-page-name"/>   <span>angularFireObject</span>: AngularFireObjectStub;<br class="title-page-name"/><br class="title-page-name"/>   <span>constructor</span>(angularFireObject: AngularFireObjectStub) {<br class="title-page-name"/>      <span>this</span>.<span>angularFireObject </span>= angularFireObject;<br class="title-page-name"/>   }<br class="title-page-name"/><br class="title-page-name"/>   <span>object</span>(pathOrRef: PathReference): AngularFireObjectStub {<br class="title-page-name"/>      <span>return this</span>.<span>angularFireObject</span>;<br class="title-page-name"/>   }<br class="title-page-name"/>}<br class="title-page-name"/><br class="title-page-name"/><span>class </span>AngularFireAppStub {<br class="title-page-name"/><br class="title-page-name"/>   <span>storage</span>() {}<br class="title-page-name"/>}<br class="title-page-name"/><br class="title-page-name"/><span>class </span>AngularFireObjectStub {<br class="title-page-name"/><br class="title-page-name"/>   <span>set</span>() {}<br class="title-page-name"/><br class="title-page-name"/>   <span>valueChanges</span>() {}<br class="title-page-name"/><br class="title-page-name"/>   <span>update</span>() {}<br class="title-page-name"/><br class="title-page-name"/>}<br class="title-page-name"/><br class="title-page-name"/><span>describe</span>(<span>'User service test suites'</span>, () =&gt; {<br class="title-page-name"/><br class="title-page-name"/>   <span>const </span><span>angularFireObject</span>: AngularFireObjectStub = <span>new <br class="title-page-name"/></span>   AngularFireObjectStub();<br class="title-page-name"/>   <span>const </span><span>mockAngularFireDatabase</span>: AngularFireDatabaseStub = <span>new <br class="title-page-name"/></span>   AngularFireDatabaseStub(<span>angularFireObject</span>);<br class="title-page-name"/>   <span>let </span><span>userService</span>: UserService;<br class="title-page-name"/><br class="title-page-name"/>   <span>beforeEach</span>(() =&gt; {<br class="title-page-name"/>      TestBed.<span>configureTestingModule</span>({<br class="title-page-name"/>         <span>providers</span>: [<br class="title-page-name"/>            {<span>provide</span>: AngularFireDatabase, <span>useValue</span>: <br class="title-page-name"/><span>             mockAngularFireDatabase</span>},<br class="title-page-name"/>            {<span>provide</span>: UserService, <span>useClass</span>: UserService}<br class="title-page-name"/>         ]<br class="title-page-name"/>      });<br class="title-page-name"/>      <span>userService </span>= TestBed.<span>get</span>(UserService);<br class="title-page-name"/>   });<br class="title-page-name"/><br class="title-page-name"/>   <span>it</span>(<span>'Add user'</span>, () =&gt; {<br class="title-page-name"/>      <span>spyOn</span>(<span>angularFireObject</span>, <span>'set'</span>);<br class="title-page-name"/>      <span>userService</span>.<span>addUser</span>(<span>mockUserJSON</span>);<br class="title-page-name"/>      <span>expect</span>(<span>angularFireObject</span>.<span>set</span>).<span>toHaveBeenCalled</span>();<br class="title-page-name"/>   });<br class="title-page-name"/><br class="title-page-name"/>   <span>it</span>(<span>'getUser return valid user'</span>, () =&gt; {<br class="title-page-name"/>      <span>spyOn</span>(<span>angularFireObject</span>, <br class="title-page-name"/><span>      'valueChanges'</span>).<span>and</span>.<span>returnValue</span>(Observable.<span>of</span>(<span>mockUserJSON</span>));<br class="title-page-name"/>      <span>userService</span>.<span>getUser</span>(<span>mockUserJSON</span>.<span>uid</span>).<span>subscribe</span>((user) =&gt; {<br class="title-page-name"/>         <span>expect</span>(<span>angularFireObject</span>.<span>valueChanges</span>).<span>toHaveBeenCalled</span>();<br class="title-page-name"/>         <span>expect</span>(user.<span>uid</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>uid</span>);<br class="title-page-name"/>         <span>expect</span>(user.<span>name</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>name</span>);<br class="title-page-name"/>         <span>expect</span>(user.<span>mobile</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>mobile</span>);<br class="title-page-name"/>         <span>expect</span>(user.<span>email</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>email</span>);<br class="title-page-name"/>      });<br class="title-page-name"/><br class="title-page-name"/>   });<br class="title-page-name"/><br class="title-page-name"/>   <span>it</span>(<span>'saveUser saves user in Subject'</span>, () =&gt; {<br class="title-page-name"/>      <span>userService</span>.<span>saveUser</span>(<span>mockUserJSON</span>);<br class="title-page-name"/>      <span>userService</span>.<span>getSavedUser</span>().<span>subscribe</span>((user) =&gt; {<br class="title-page-name"/>         <span>expect</span>(user.<span>uid</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>uid</span>);<br class="title-page-name"/>         <span>expect</span>(user.<span>name</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>name</span>);<br class="title-page-name"/>         <span>expect</span>(user.<span>mobile</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>mobile</span>);<br class="title-page-name"/>         <span>expect</span>(user.<span>email</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>email</span>);<br class="title-page-name"/>      });<br class="title-page-name"/><br class="title-page-name"/>   });<br class="title-page-name"/><br class="title-page-name"/>   <span>it</span>(<span>'updateEmail update the email'</span>, () =&gt; {<br class="title-page-name"/>      <span>spyOn</span>(<span>angularFireObject</span>, <span>'update'</span>);<br class="title-page-name"/>      <span>userService</span>.<span>saveUser</span>(<span>mockUserJSON</span>);<br class="title-page-name"/>      <span>mockUserJSON</span>.<span>email </span>= <span>'user1@gmail.com'</span>;<br class="title-page-name"/>      <span>userService</span>.<span>updateEmail</span>(<span>mockUserJSON </span>, <span>mockUserJSON</span>.<span>email</span>);<br class="title-page-name"/>      <span>userService</span>.<span>getSavedUser</span>().<span>subscribe</span>((user) =&gt; {<br class="title-page-name"/>         <span>expect</span>(<span>angularFireObject</span>.<span>update</span>).<span>toHaveBeenCalled</span>();<br class="title-page-name"/>         <span>expect</span>(user.<span>email</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>email</span>);<br class="title-page-name"/>      });<br class="title-page-name"/><br class="title-page-name"/>   });<br class="title-page-name"/><br class="title-page-name"/>   <span>it</span>(<span>'updateMobile update the mobile'</span>, () =&gt; {<br class="title-page-name"/>      <span>spyOn</span>(<span>angularFireObject</span>, <span>'update'</span>);<br class="title-page-name"/>      <span>userService</span>.<span>saveUser</span>(<span>mockUserJSON</span>);<br class="title-page-name"/>      <span>mockUserJSON</span>.<span>mobile </span>= <span>'88888888'</span>;<br class="title-page-name"/>      <span>userService</span>.<span>updateEmail</span>(<span>mockUserJSON </span>, <span>mockUserJSON</span>.<span>mobile</span>);<br class="title-page-name"/>      <span>userService</span>.<span>getSavedUser</span>().<span>subscribe</span>((user) =&gt; {<br class="title-page-name"/>         <span>expect</span>(<span>angularFireObject</span>.<span>update</span>).<span>toHaveBeenCalled</span>();<br class="title-page-name"/>         <span>expect</span>(user.<span>mobile</span>).<span>toBe</span>(<span>mockUserJSON</span>.<span>mobile</span>);<br class="title-page-name"/>      });<br class="title-page-name"/>   });<br class="title-page-name"/>});</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Unit testing Angular pipe</h1>
                
            
            <article>
                
<p class="calibre2">Angular pipe unit testing is an example of testing a class independently of the Angular test environment. In this example, we test our friend's date pipe class and create the object in the test class:</p>
<pre class="calibre17"><span>const </span><span>pipe </span>= <span>new </span>FriendsDatePipe();</pre>
<p class="calibre2">On this object, we will write the following two test cases:</p>
<ol class="calibre13">
<li value="1" class="calibre8">First, test the green field scenario, where we pass a valid date in milliseconds and test the transformed human-readable date format</li>
<li value="2" class="calibre8">Second, test the edge-case scenario where we pass an invalid date as <kbd class="calibre11">-1</kbd>, and we expect a string return value as <kbd class="calibre11">"Invalid Date"</kbd></li>
</ol>
<pre class="calibre17"><span>import </span>{FriendsDatePipe} <span>from </span><span>'./friendsdate.pipe'</span>;<br class="title-page-name"/><br class="title-page-name"/><span>describe</span>(<span>'friendsdatepipe'</span>, () =&gt; {<br class="title-page-name"/><br class="title-page-name"/>   <span>const </span><span>pipe </span>= <span>new </span>FriendsDatePipe();<br class="title-page-name"/><br class="title-page-name"/>   <span>it</span>(<span>'Transform dateInMillis to MM/DD/YY'</span>, () =&gt; {<br class="title-page-name"/>      <span>expect</span>(<span>pipe</span>.<span>transform</span>(<span>'1506854340801'</span>)).<span>toBe</span>(<span>'10/01/17'</span>);<br class="title-page-name"/>   });<br class="title-page-name"/><br class="title-page-name"/>   <span>it</span>(<span>'Transform invalid date'</span>, () =&gt; {<br class="title-page-name"/>      <span>expect</span>(<span>pipe</span>.<span>transform</span>(<span>'-1'</span>)).<span>toBe</span>(<span>'Invalid Date'</span>);<br class="title-page-name"/>   });<br class="title-page-name"/><br class="title-page-name"/>});</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Code coverage</h1>
                
            
            <article>
                
<p class="calibre2">Code coverage of the application reflects the overall coverage of our code. This gives an overview of the line and function coverage of the code so that we can write more test cases to cover other parts of the code.</p>
<p class="calibre2">We can enable code coverage in <kbd class="calibre11">package.json</kbd>, as follows:</p>
<pre class="calibre17"><span>"scripts"</span>: {<br class="title-page-name"/>  <span>"ng"</span>: <span>"ng"</span>,<br class="title-page-name"/>  <span>"start"</span>: <span>"ng serve"</span>,<br class="title-page-name"/>  <span>"build"</span>: <span>"ng build"</span>,<br class="title-page-name"/>  <span>"test"</span>: <span>"ng test --sourcemaps false"</span>,<br class="title-page-name"/>  <span>"coverage"</span>: <span>"ng test --sourcemaps false --watch=false <br class="title-page-name"/>   --code-coverage"</span>,<br class="title-page-name"/>  <span>"lint"</span>: <span>"ng lint"</span>,<br class="title-page-name"/>  <span>"e2e"</span>: <span>"ng e2e"<br class="title-page-name"/></span>}</pre>
<p class="calibre2">We will execute the following command, which runs the test cases, and creates a <kbd class="calibre11">coverage</kbd> folder, which has <kbd class="calibre11">index.html</kbd> to show coverage statistics:</p>
<pre class="calibre17"><strong class="calibre1">$ng test --codeCoverage</strong></pre>
<p class="calibre2">When we open <kbd class="calibre11">index.html</kbd>, it shows a beautiful table with an overview of the coverage:</p>
<div class="cdpaligncenter"><img src="../images/00034.jpeg" class="calibre49"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we covered unit testing and discussed various terms and terminologies in Angular unit testing. We implemented unit test for our login component, covered <kbd class="calibre11">TestBed</kbd>, and configured our modules. We wrote a unit test for our service, created stubs for external dependent classes, and injected these stubbed classes in our module. We also wrote isolated test cases for Angular pipe. Finally, we discussed code coverage and ran code coverage for our specs.</p>
<p class="calibre2">In the next chapter, we will discuss debugging techniques. This will help us to solve and debug our issues faster.</p>


            </article>

            
        </section>
    </body></html>