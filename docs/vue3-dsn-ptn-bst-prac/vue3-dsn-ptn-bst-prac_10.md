

# 第十章：部署您的应用程序

如果我们不能发布最终产品，那么我们在开发和我们的应用程序上的工作将走向一个悲伤的结局。虽然相当直接，但在互联网上展示我们的应用程序确实需要关注一些细节，并熟悉一些术语和托管可能性。

在本章中，我们将学习以下内容：

+   在互联网上发布网络应用程序涉及哪些内容

+   为部署构建我们的应用程序的考虑因素

+   熟悉注册域名的术语和流程

+   配置网络服务器以托管我们的**单页应用程序**（**SPA**）或**渐进式网络应用程序**（**PWA**）

+   使用 Let’s Encrypt 保护我们的网络应用程序服务器

本章的主要目的是为您提供工具，以了解发布和保障网站所需的步骤，以及由此延伸出的我们的 SPA 或 PWA。

# 技术要求

本章主要是信息性的，但已将一些配置文件上传到本书的存储库作为示例，可以在以下位置找到：[`github.com/PacktPublishing/Vue.js-3-Design-Patterns-and-Best-Practices/tree/main/Chapter10`](https://github.com/PacktPublishing/Vue.js-3-Design-Patterns-and-Best-Practices/tree/main/Chapter10)。

# 发布一个网络应用程序涉及哪些内容？

发布 Vue 3 网络应用程序与发布任何其他网站并没有太大的不同，除了几个关键差异。在本章中，我们将考虑一个干净的安装，这意味着我们将自行获取所有涉及的元素。在最基本的情况下，我们需要考虑以下内容：

+   我们网站/应用程序的域名

+   我们应用程序的目标路径

+   托管服务或类型

+   网络服务器软件

+   获取安全证书

前述项目也为我们准备提供了一个简单的公式。让我们逐一解释，在前进的过程中解释每个必要的术语和关注点。

## 域名、域名服务器（DNS）和 DNS 记录

连接到网络的每台计算机都会收到一个独特的标识地址，以区分同一网络上的其他计算机。这些被称为**互联网协议**（**IP**）地址，如今，有两种在运行——IP 版本 4 和 6。

+   `127.0.0.1`，代表回环到我们自己的计算机。这些地址也可以有一个掩码，用于定义网络中的子段。很可能是您的家庭网络内部使用此协议。

+   IPv6 中的`127.0.0.1`是`0000:0000:0000:0000:0000:0000:0000:0001`，然后可以缩写为`0:0:0:0:0:0:0:1`或简称为`::1`。

关于网络地址还有很多内容，但仅通过这个简要介绍，我们已经可以看到这里存在一个可用性问题。这些地址对计算机来说工作得很好，但与“*人类记忆*”不太友好。在庞大的互联网上，有成百万的连接计算机，仅使用 IP 地址进行导航是不可能的。这就是为什么在网络的架构中有特殊的服务器，它们可以将“*人类友好的名称*”转换为正确的 IP 地址。这些友好的名称被称为**域名**，提供转换的服务器被称为**域名系统**（**DNS**）。所有这些都由**互联网名称与数字地址分配机构**（**ICANN**）组织进行监管。

域名是我们每天用来访问互联网上任何网站或应用程序的工具。这些域名是从有权销售它们的实体那里购买的，称为**注册商**。一旦期限到期，可以在有限的时间内进行续费，否则可以被其他人获得。通常，域名按年出售，价格从几美分到几千美元不等。域名也按组组织，从右到左由点分隔，如下所示：

![图 10.1 – 构成完整域名各部分](img/Figure_10.01_B18602.jpg)

图 10.1 – 构成完整域名各部分

最高级域名由 ICANN 管理，虽然`.com`商业网站是最著名的，但还有许多其他选择，如下所示：

+   `.org`: 用于组织

+   `.net`: 用于企业内部网或组织门户

+   `.mil`: 用于军事用途

+   `.gov`: 用于官方政府网站

新的顶级域名经常被创建。您可以在以下位置找到它们的增长列表：[`en.wikipedia.org/wiki/List_of_Internet_top-level_domains`](https://en.wikipedia.org/wiki/List_of_Internet_top-level_domains)。

当我们购买一个域名（如前图中的**mydomain**）时，它会附加到我们选择的顶级域名。**注册商**为我们提供了选择域名并检查它们是否可供购买的选择。为了发挥作用，域名需要在 DNS 上进行注册，以便指向一个 IP 地址。这样做的方式是创建**DNS 记录**，这通常是通过出售域名的同一注册商完成的，或者我们可以在注册商处记录将具有目标 IP 的 DNS。关于这一点，我们稍后会详细介绍，但现在是，请记住这个概念。域名最常见的 DNS 记录如下：

| **记录** **类型（名称）** | **值和描述** |
| --- | --- |
| `A` | 一个 IPv4 地址。这是指向您的服务器公共 IP 的主要记录。 |
| `AAAA` | 一个 IPv6 地址。指向您的服务器公共 IPv6 地址。 |
| `CNAME` | 创建一个指向域的别名，因此您可以将多个域名指向同一目的地，而无需创建多个 A/AAAA 记录。这可以用于创建子域名。 |
| `TXT` | 一种纯文本记录，通常与某种形式的域所有权验证一起使用。 |

表 10.1 – DNS 记录类型

根据注册商和聘请的服务，您可能永远看不到或必须处理这些记录，因为一些注册商/网络托管商会自动为您管理它们。

子域名不需要从注册商那里购买，只需配置即可。您可以为您的域名创建尽可能多的子域名。以下是一些常见的子域名：

+   `www`：用于**万维网**，或一个网页。如今，这个子域名通常被用作域的同义词。

+   `app`：用于应用程序。

+   `admin`：用于管理访问。

+   `mail`：用于电子邮件服务。

使用子域名，您可以在同一域名/主机上托管多个网站。我们将在稍后看到如何为我们的应用程序在 Web 服务器上配置一个。在此阶段，我们需要记住的是，域名或子域名将指向您的服务器作为最终目的地。

关于回环地址的说明

按照前面的示例，为回环（本地）地址保留的“域名”是 `localhost`。

我们应用程序将要托管的主机域是我们在互联网上拥有存在感的第一步。有了它，我们就位，可以转向下一个考虑因素——它将在该域中的位置。

# 构建我们的应用程序以进行部署的注意事项

一旦我们有了我们的域名/子域名，我们需要决定（或知道）应用程序将位于哪个路径上。路径是跟随域的部分，由正斜杠(`/`)分隔的段——例如，`mydomain.com/store/product.html`。这些部分被称为“路径”，因为它们遵循与本地存储中镜像相同的目录结构。我们的应用程序将通过一个 `folder/subfolder/file...`）来提供服务。内部，我们的服务器将匹配域名请求到本地目录中的文件。这就是我们需要知道 Vue 应用程序是否将放置在根目录，还是在一个路径（目录）上，因为如果我们使用 Vue Router 在 Web 历史模式下，我们需要为此指示构建过程（如果您需要复习此主题，请参阅*第五章*，“单页应用程序”）。在这种情况下，我们需要进行两项修改：

+   在我们的路由器配置中指明应用程序的*根*路径

+   配置网络服务器以更改目录/文件服务并将所有请求路由到 `index.html` 文件

如果我们的应用程序使用网络历史模式放置在 `mydomain.com`**/app**，那么我们需要通过将“基本路径”传递给创建函数来修改我们的路由定义。因此，如果我们查看我们的 SPA 示例应用程序中的路由，即*第五章*，“单页应用程序”，我们可以按以下方式修改它：

/chapter 5/to-do SPA/src/router/index.js

```js
import { createWebHistory } from "vue-router"
// ...
router = createRouter({
history: createWebHistory('/app'),
routes,
// ...
}
})
```

注意到的小变化，我们将基本路径传递给`createWebHistory`构造函数，而不是使用`createWebHashHistory()`。当然，如果应用程序使用哈希模式，它放置在我们的路径中的位置无关紧要。这是因为在这种模式下，所有路由导航都将传递给哈希，并指向我们的`index.html`文件。例如，如果我们的路由器有一个名为`/description`的路由，使用哈希模式将使地址变为`mydomain.com/app/description`（Web 历史模式）。

网址中的哈希值

地址中的哈希表示指向页面/文件的某个部分的链接，根据 HTML 标准，Vue 在哈希模式下管理定义的路由时使用它。

在为我们的应用程序指定目的地后，我们现在可以通过在终端上运行以下命令通过 Vite 构建生产代码：

```js
 $ npm run build
```

默认情况下，我们整个应用程序的最终生产就绪文件将放置在`/dist`文件夹中（与我们的`/src`文件夹处于同一级别）。现在，有了我们的构建分发文件，一旦我们设置了适当的配置，我们就可以将它们上传到服务器。

# Web 服务器选项和配置

当我们准备将应用程序上传到服务器时，我们会面临许多选项，这些选项基于提供的服务类型和 Web 服务器应用程序。这些项目的组合通常被称为“托管”服务器，包括操作系统、机器配置、架构类型，特别是 Web 服务器软件。以下是每个类别的一些最常见选项列表：

| **操作系统** | **Linux** **或 Windows** | **对于我们 Vue 3 应用来说，这个选择** **无关紧要** |
| --- | --- | --- |
| **托管类型** | **共享** | 我们的应用程序将驻留在存储的私有区域的服务器上，但将与其他应用程序共享所有资源。通常通过网页控制面板进行配置访问 |
| **虚拟专用服务器 (VPS)** | 我们获得了一个具有完全访问整个配置和资源的虚拟机，通常通过远程终端的直接连接 |
| **托管 VPS** | 与 VPS 类似，但我们提供网页控制面板或其他服务来管理该机器 |
| **私有服务器** | 在这里，我们从托管提供商那里租用真实硬件，并拥有所有资源的完全自由 |
| **自托管** | 我们用自己的方式将服务器直接连接到互联网，并拥有互联网连接 |
| **托管** | 我们向服务器农场提供服务器，他们负责物理需求。我们通过远程管理服务器，拥有软件和硬件的完全控制权 |
| **Web 服务器** | **Apache HTTP** | 该服务器在 Linux 和共享托管中稳定且使用广泛 |
| **Nginx** | 一个较小且快速的 Web 服务器，以其高效管理大量并发连接而闻名，资源使用效率高。非常易于管理，在 VPS 托管中非常受欢迎 |

表 10.2 - 每个类别的常见托管选项

在 Vue 3 应用程序的情况下，我们的目标是拥有一个快速且可靠的 Web 服务器，能够通过提供静态文件来同时处理多个请求。由于我们不在服务器上运行代码，因此我们不需要太多的 CPU 处理能力，所以我们对硬件和软件的要求非常低，以至于实际上任何“静态文件服务器”都可以。很可能会是我们的应用程序成为更大基础设施的一部分，具有其他要求，但专门用于为我们自己的 Vue 3 应用程序提供服务的要求是较低的。

这里的关键考虑因素是，再次强调，我们是否在我们的路由器中使用 Web 历史模式。在这种情况下，我们需要向 Web 服务器软件添加配置，以便在请求不匹配标准（文件夹目录中的文件）时将所有请求定向到我们的 Vue 应用程序的入口点（我们的`index.html`）。这可能听起来很复杂，但实际上相当简单。直接从官方 Vue Router 文档中，以下是两个 Web 服务器的示例。

## Apache HTTP 服务器配置

Apache HTTP 服务器在共享主机提供商中被广泛使用，并允许我们通过在 Web 应用程序的根目录中放置单个文件来更改请求的配置。这非常方便且简单，但确实需要主机提供商已启用（或通过管理面板允许用户启用）一个特殊模块，允许我们重写传入的请求。官方文档([`router.vuejs.org/guide/essentials/history-mode.html#apache`](https://router.vuejs.org/guide/essentials/history-mode.html))展示了此示例：

/.htaccess

```js
<IfModule mod_negotiation.c>
  Options -MultiViews
</IfModule>
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /                                //1
  RewriteRule ^index\.html$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule . /index.html [L]
</IfModule>
```

前面的文件应该放置在我们的`index.html`文件旁边。然后，每个进入的请求都将被路由到它，并由 Vue Router 在 Web 历史模式下捕获。注意，在行`//1`中，有`RewriteBase`规则。这就是我们更改应用程序路径的地方，如果不在域根目录下。

## Nginx 服务器配置

在 VPS 和私有服务器的情况下，NGINX 服务器因其灵活性和性能而非常受欢迎。它可以作为反向代理、负载均衡器等等。在 Linux/Windows 的 VPS 上安装此服务器相当简单，但这里不会涉及。您可以在每个系统的文档中查看[`www.nginx.com/resources/wiki/start/topics/tutorials/install/`](https://www.nginx.com/resources/wiki/start/topics/tutorials/install/)。

与使用 `.htaccess` 文件的 Apache 不同，我们需要修改我们网站的服务器配置文件。在 Linux 中，这通常位于 /etc/nginx/sites-available。文件遵循一个简单的模式，其中，对于每个虚拟服务器，我们声明位置路径（如域名路径）和本地存储的位置（目录或文件夹）。以下是一个来自 Linux 服务器的示例文件：

/etc/nginx/sites-available/default

```js
server {
    listen 80;
    index index.html;
    root /home/user/www;                              //1
    server_name www.mydomain.com mydomain.com;        //2
    location / {                                      //3
        try_files $uri $uri/ /index.html;             //4
    }
}
```

让我们看看前面的代码：

+   在第 *//1* 行，我们放置本地存储的绝对路径到我们的应用程序。

+   在第 *//2* 行，我们声明将与该服务器块关联的域名和子域名。

+   在第 *//3* 行，我们声明要处理的位置路径。在这个例子中，我们将应用程序放置在根目录（`/`）。如果放置在 `mydomain.com/app`，我们将写 `location /app`。

+   最后，在第 *//4* 行，我们告诉 NGINX 尝试找到一个有效的目录/文件，如果没有，则将其传递到我们的 `index.html` 文件。

与之前一样，如果我们使用的是 Web 哈希模式，那么我们不需要进行这些更改。我们可以直接使用默认配置从磁盘提供文件。

## 其他服务器

在这里无法涵盖许多其他正在使用和可能的配置服务器。然而，官方 Vue Router 文档为其他服务器提供了非常好的示例，并为未涵盖的内容提供了指南。您可以通过此链接找到参考：[`router.vuejs.org/guide/essentials/history-mode.html#example-server-configurations`](https://router.vuejs.org/guide/essentials/history-mode.html#example-server-configurations)。

让我们看看现在如何将我们的文件移动到我们的在线服务器上。

# 将您的文件传输到服务器

现在我们已经有了指向我们服务器的域名和配置就绪，现在是时候上传我们的发行文件了。根据您选择的托管方式，这可以通过 Web 界面、**文件传输协议**（**FTP**）应用程序或通过**安全外壳协议**（**SSH**）进行安全传输来完成。对于后两种选项，建议使用一个负责繁重工作的应用程序。一个很好的选择是使用 FileZilla ([`filezilla-project.org/`](https://filezilla-project.org/))，它处理上述协议。它适用于 Linux、Windows 和 macOS。

正如我们在*第九章*“测试和源代码控制”中提到的，你也可以配置你的 VPS/服务器，使用本地仓库中的`/dist`文件夹从远程仓库拉取源代码。例如，我们可以打开到服务器的远程终端，触发同步（拉取），然后在服务器本身打包应用程序，拉取已经打包应用程序的分支，直接将我们的提交推送到服务器，等等。使用 Git 时有很多选项，使用像`GitHub`或`GitLab`这样的服务时还有更多选项，这些服务提供了强大的**持续集成和交付**工具。如果你不想使用 S/FTP 应用程序或想自动化这个过程，这是一个值得探索的话题。每种实现都是特定的，超出了本书的范围，所以我们将继续下一个主题，假设我们的文件现在已经在服务器上了。

# 使用 Let’s Encrypt 保护你的网络应用程序

互联网地址包含在使用协议的最开始部分。默认情况下，所有网页导航都使用**超文本传输协议**（**HTTP**），虽然它是基础性的，但并不被认为是安全的。当在客户端和服务器之间提供加密层时，通信将通过**HTTPS**（其中的**S**代表**安全**）进行。这个加密层由认证机构提供和验证，因此证书必须从这样的机构购买。托管提供商通常有在他们的服务器上购买和安装一个证书的选项，但**Let’s Encrypt**基金会也提供了一个免费且可靠的替代方案（[`letsencrypt.org/`](https://letsencrypt.org/)）。

要安装*Let’s Encrypt*证书，你需要对服务器有 shell 访问权限。如果没有，那么你必须依赖托管商提供的服务。兼容的认证托管提供商列表在这里：[`certbot.eff.org/hosting_providers`](https://certbot.eff.org/hosting_providers)。

如果我们通过远程 shell 访问服务器，过程也是直接的。Let’s Encrypt 基金会和**电子前沿基金会**（**EFF**）提供了一个名为**certbot**（认证机器人）的应用程序，该程序自动化了安全证书的安装，并配置了本地网络服务器文件以使用 HTTPS。在这种情况下，我们有两种选择：

+   为每个域名和每个子域名安装证书

+   安装一个*通配符证书*，它覆盖每个域名及其所有可能的子域名

安装*certbot*并运行过程的说明因操作系统、网络服务器和证书类型的不同而不同。因此，电子前沿基金会（EFF）提供了一个网页，其中包含针对每种可能变体的可配置选项和易于遵循的步骤。向导可以在[`certbot.eff.org/`](https://certbot.eff.org/)找到。

![图 10.2 – Certbot 为 NGINX 和 Ubuntu 20 的说明](img/Figure_10.02_B18602.jpg)

图 10.2 – Certbot 为 NGINX 和 Ubuntu 20 的说明

通常，说明遵循以下步骤：

1.  安装 **certbot**。

1.  运行 **certbot**。这将显示一系列选项，包括在给定的 Web 服务器上找到的所有域名。

1.  选择要安装的证书类型。

1.  如果启用，选择证书的自动续订。拒绝此选项将需要手动续订。

免费证书的有效期仅为 3 个月，而商业证书可以购买更长时间。3 个月后，必须手动续订。幸运的是，*certbot* 包含一个在到期期限之前执行自动更新的功能。

即使对于简单的测试应用程序，始终使用安全证书保护网站也是重要且值得推荐的。让我们也记住，拥有安全证书并通过 HTTPS 提供应用程序是 PWAs 的硬性要求。

# 摘要

在本章中，我们介绍了在互联网上我们自己的公共空间发布 Vue 应用程序的基本知识。我们还学习了在购买和预订域名时理解指令的重要概念，以及如果需要设置 DNS 记录。我们还学习了如何在 Vue Router 中的 HTML5 历史模式下调整我们的包配置，我们可以租用的不同类型的在线托管，将我们的分发文件复制到生产服务器的选项，以及使用免费的 Let’s Encrypt 证书来保护我们的网站，以通过 HTTPS 提供应用程序的指南。所有这些技能都很重要，并且你将受益于至少执行这些技能一次的经验。

随着我们应用程序的部署，本书中涵盖了构建 Vue 3 应用程序的主要步骤和主题，从框架的介绍到测试我们的单个组件，再到在 Web 服务器上安装我们的生产就绪文件。在某些情况下，我们已经超越了基础知识，探讨了高级主题，这些主题对于专业开发者来说是一个重要的补充。如果你已经跟随了这些概念和代码示例，你已经获得了帮助你在职业发展中取得重要技能。但这本书还没有结束，因为你可以找到额外的额外内容。

我衷心感谢您，亲爱的读者，您对 Vue 3 的兴趣以及购买这本书，这本书总结了多年开发应用程序的经验。我希望它成为您继续学习的参考资料和鼓励，并祝您在个人和职业生涯中取得最佳成功。

诚挚地，

**Pablo** **D. Garaguso**

# 复习问题

+   什么是顶级域名，它与域有什么不同？

+   我们可以为我们的域名创建多少个子域名？为什么？

+   DNS 是什么？DNS 记录是什么？

+   目前有哪些选项可以用于在互联网上发布您的 Web 应用程序？

+   当使用 Vue Router 在 Web 历史模式下时，我们在代码和 Web 服务器方面需要考虑哪些因素？

+   在共享主机和 VPS 中常见的 Web 服务器有哪些？

+   Certbot 是什么？它有什么作用？
