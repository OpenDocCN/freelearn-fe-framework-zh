<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Service Workers"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Service Workers</h1></div></div></div><p>In the previous lesson, we learned how to add server-side rendering to our application. In the next lesson, we'll configure service workers for our application. </p><div class="section" title="Lesson Objectives"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl4sec04"/>Lesson Objectives</h1></div></div></div><p>In this lesson, you will:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Explore service workers and PWAs</li><li class="listitem" style="list-style-type: disc">Add a service worker to the application that we built in the previous lessons</li><li class="listitem" style="list-style-type: disc">Configure the service worker to convert the app to a progressive web app</li><li class="listitem" style="list-style-type: disc">Explore how to debug a service worker</li></ul></div><p>Let's first understand what a service worker and a progressive web app is.</p></div></div>
<div class="section" title="What Is a Service Worker?"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec28"/>What Is a Service Worker?</h1></div></div></div><p>A service worker <a class="indexterm" id="id142"/>is a script that the browser runs in the background which acts as a network proxy to manage network requests programmatically. It sits between the network and the device and caches content, enabling an offline experience for the user.</p><p>In addition to caching data, it can also synchronize API data in the background and add things like push notifications.</p></div>
<div class="section" title="What Is a Progressive Web App?"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec29"/>What Is a Progressive Web App?</h1></div></div></div><p>
<span class="strong"><strong>Progressive Web App</strong></span> (<span class="strong"><strong>PWA</strong></span>) is a term that is used for web applications that behave<a class="indexterm" id="id143"/> in a way similar to native mobile applications.</p><p>Like native apps, they allow an application to be started when the user is offline, caching the UI elements and API calls to display an initial page. That way, a user can interact with the application on a basic level until the connection gets established.</p><p>Once the connection is established, the PWA will retrieve the updated data from the server and refresh the application, so the user can work with the latest data.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note09"/>Note</h3><p>The official <a class="indexterm" id="id144"/>Angular documentation has a great section on service workers: <a class="ulink" href="https://angular.io/guide/service-worker-intro">https://angular.io/guide/service-worker-intro</a>
</p></div></div></div>
<div class="section" title="Installing Dependencies"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec30"/>Installing Dependencies</h1></div></div></div><p>Angular comes with support for <a class="indexterm" id="id145"/>service workers. In order to use it, we first need to install the dependencies.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the terminal in the project directory.</li><li class="listitem">Install the dependencies needed using the <code class="literal">npm</code> command:<div class="informalexample"><pre class="programlisting">npm install @angular/service-worker</pre></div></li><li class="listitem">When the installation is successful, we should see the new package added to the <code class="literal">dependencies</code> object in our project's <code class="literal">package.json</code> file:<div class="mediaobject"><img alt="Installing Dependencies" src="graphics/3.1.jpg"/></div></li></ol></div><p>In this section, we have installed the dependencies for our service worker, which is the first step in implementing service workers in our app. Let's move on to the next section, where we will enable the service worker in our application.</p></div>
<div class="section" title="Enabling the Service Worker"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec31"/>Enabling the Service Worker</h1></div></div></div><p>Now that the <a class="indexterm" id="id146"/>dependency is installed, it's time to enable the service worker.</p><p>This involves three steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Enabling the service worker in our browser app in <code class="literal">.angular-cli.json</code>.</li><li class="listitem">Importing and registering the <code class="literal">ServiceWorkerModule</code> in our <code class="literal">AppModule</code>.</li><li class="listitem">Creating the service worker configuration file <code class="literal">src/ngsw-config.json</code>.</li></ol></div><p>We will use the <code class="literal">ng set</code> command to enable support for the service worker in our browser app in <code class="literal">.angular-cli.json:</code>
</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the terminal in the project directory.</li><li class="listitem">Run the following command to adjust <code class="literal">.angular-cli.json</code>:<div class="informalexample"><pre class="programlisting">ng set apps.0.serviceWorker=true</pre></div></li><li class="listitem">Confirm <a class="indexterm" id="id147"/>that the property <code class="literal">serviceWorker</code> is set to <code class="literal">true</code> in the first app in the <code class="literal">apps</code> array in <code class="literal">.angular-cli.json</code>:<div class="mediaobject"><img alt="Enabling the Service Worker" src="graphics/3.2.jpg"/></div></li></ol></div><div class="section" title="Importing the ServiceWorkerModule"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec53"/>Importing the ServiceWorkerModule</h2></div></div></div><p>We will import the <code class="literal">ServiceWorkerModule</code> in our <code class="literal">AppModule</code> and register it.</p><p>We will invoke the <code class="literal">register</code> method on the <code class="literal">ServiceWorkerModule</code>. This method takes two parameters. The first parameter defines what the location of the Angular service worker is. The value '<code class="literal">/ngsw-worker.js'</code> is what should be used in our case.</p><p>The second parameter is an object named <code class="literal">environment</code>, and with this object, we can control if we want to enable the service worker. We use the <code class="literal">environment</code> object to determine if the service worker should be enabled, as we only want to enable it on production builds:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">src/app/app.module.ts</code> file in your editor.</li><li class="listitem">Add the following <code class="literal">import</code> statements at the top of the file:<div class="informalexample"><pre class="programlisting">import { ServiceWorkerModule } from '@angular/service-worker'
import { environment } from '../environments/environment'</pre></div><p>Add the <code class="literal">ServiceWorkerModule</code> to the <code class="literal">imports</code> array and invoke the <code class="literal">register</code> method with these parameters:</p><div class="informalexample"><pre class="programlisting">ServiceWorkerModule.register('/ngsw-worker.js', {enabled: environment.production}),</pre></div></li></ol></div></div><div class="section" title="Creating the Service Worker Configuration"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec54"/>Creating the <a class="indexterm" id="id148"/>Service Worker Configuration
</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">src/ngsw-config.json</code> file and open it in your editor.</li><li class="listitem">Add the following content to the file:<div class="informalexample"><pre class="programlisting">{
 "index": "/index.html",
 "assetGroups": [
   {
     "name": "app",
     "installMode": "prefetch",
     "resources": {
       "files": [
         "/favicon.ico",
         "/index.html"
       ],
       "versionedFiles": [
         "/*.bundle.css",
         "/*.bundle.js",
         "/*.chunk.js"
       ]
     }
   },
   {
     "name": "assets",
     "installMode": "lazy",
     "updateMode": "prefetch",
     "resources": {
       "files": [
         "/assets/**"
       ]
     }
   }
 ]
}</pre></div><p>Here, we add the initial default content to the <code class="literal">ngsw-config.json</code> file. This is the default configuration provided by the Angular team, and can be found here: <a class="ulink" href="https://angular.io/guide/service-worker-getting-started#step-4-create-the-configuration-file-ngsw-configjson">https://angular.io/guide/service-worker-getting-started#step-4-create-the-configuration-file-ngsw-configjson</a>
</p></li></ol></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the Terminal in the project directory.</li><li class="listitem">Run <code class="literal">npm run build:browser</code> to create a production build.</li><li class="listitem">Verify that the <a class="indexterm" id="id149"/>build ran successfully and that the files <code class="literal">ngsw-worker.js</code> and <code class="literal">ngsw.json</code> got generated in the <code class="literal">dist/browser</code> directory.<div class="mediaobject"><img alt="Creating the service workerenablingService Worker Configuration" src="graphics/3.3.jpg"/></div></li></ol></div><p>In this section, we enabled the service worker in our application and used the default configuration. We have verified that a production build generates the service worker configuration.</p><p>Let's add some custom configuration options next.</p></div></div>
<div class="section" title="Configuring the Service Worker"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec32"/>Configuring the Service Worker</h1></div></div></div><p>In the<a class="indexterm" id="id150"/> previous section, we added the service worker configuration file <code class="literal">src/ngsw-config.json</code> to our project, but we have not configured anything yet.</p><p>In this section, we will add two types of configurations: asset groups and data groups.</p><div class="section" title="Asset and Data Groups"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec55"/>Asset and Data Groups</h2></div></div></div><p>In the <a class="indexterm" id="id151"/>asset groups configuration, we specify how we want our service worker to handle the assets <a class="indexterm" id="id152"/>of our application. When we talk about assets, we should think of style sheets, images, external JS files, and so on.</p><p>Asset groups are defined using the following TypeScript interface:</p><div class="informalexample"><pre class="programlisting">interface AssetGroup {
  name: string;
  installMode?: 'prefetch' | 'lazy';
  updateMode?: 'prefetch' | 'lazy';
  resources: {
    files?: string[];
    versionedFiles?: string[];
    urls?: string[];
  };
}</pre></div><p>Here's what the parameters mean:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">name</code> uniquely identifies the group of assets</li><li class="listitem" style="list-style-type: disc"><code class="literal">installMode</code> defines how new resources are initially cached</li><li class="listitem" style="list-style-type: disc"><code class="literal">updateMode</code> defines the caching behavior of existing resources</li><li class="listitem" style="list-style-type: disc">The <code class="literal">resources</code> object describes the actual resource to cache</li></ul></div><p>A complete reference for<a class="indexterm" id="id153"/> this can be found at: <a class="ulink" href="https://angular.io/guide/service-worker-config#assetgroups">https://angular.io/guide/service-worker-config#assetgroups</a>.</p><p>In the <a class="indexterm" id="id154"/>data groups configuration, we specify how we want our service worker to cache the data of the APIs we are requesting the data from.</p><p>Data groups <a class="indexterm" id="id155"/>are defined using the following TypeScript interface:</p><div class="informalexample"><pre class="programlisting">export interface DataGroup {
  name: string;
  urls: string[];
  version?: number;
  cacheConfig: {
    maxSize: number;
    maxAge: string;
    timeout?: string;
    strategy?: 'freshness' | 'performance';
  };
};</pre></div><p>Here's what the parameters mean:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">name</code> uniquely identifies the group</li><li class="listitem" style="list-style-type: disc"><code class="literal">urls</code> is an array of URL patterns</li><li class="listitem" style="list-style-type: disc"><code class="literal">version</code> provides a mechanism to force reloading of cached items</li><li class="listitem" style="list-style-type: disc"><code class="literal">cacheConfig</code> defines the policy that is used to cache this group</li></ul></div><p>A complete <a class="indexterm" id="id156"/>reference for this can be found at: <a class="ulink" href="https://angular.io/guide/service-worker-config#datagroups">https://angular.io/guide/service-worker-config#datagroups</a>.</p></div><div class="section" title="Configuring the Asset and Data Groups"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec56"/>Configuring the Asset and Data Groups</h2></div></div></div><p>We will append two items to the asset groups configuration.</p><p>The first<a class="indexterm" id="id157"/> asset group caches the data that comes from the domains that we use to fetch our CSS and the fonts included in that CSS.</p><p>The second asset group caches the static data from the API we work with; in this case, the user avatars:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">src/ngsw-config.json</code> file in your editor.</li><li class="listitem">Locate the <code class="literal">assetGroups</code> array.</li><li class="listitem">Add the following two objects to this array:<div class="informalexample"><pre class="programlisting">{
   "name": "externals",
   "installMode": "prefetch",
   "updateMode": "prefetch",
   "resources": {
     "urls": [
       "https://ajax.googleapis.com/**",
       "https://fonts.googleapis.com/**",
       "https://fonts.gstatic.com/**",
       "https://maxcdn.bootstrapcdn.com/**"
     ]
   }
 },
 {
   "name": "avatars",
   "installMode": "prefetch",
   "updateMode": "prefetch",
   "resources": {
     "urls": [
       "http://localhost:3000/avatars/**",
       "https://packt-angular-social.now.sh/avatars/**"
     ]
   }
}</pre></div><p>Make sure to correctly format the JSON; use <a class="ulink" href="https://jsonlint.com/">https://jsonlint.com/</a> to be sure.</p></li></ol></div><p>We will create the data groups configuration. We will define one data group that caches the requests from our API:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">src/ngsw-config.json</code> file in your editor.</li><li class="listitem">Create a top-level array with the key <code class="literal">dataGroups</code>.</li><li class="listitem">Add the following object to this array:<div class="informalexample"><pre class="programlisting">{
   "name": "rest-api",
   "urls": [
     "http://localhost:3000/api/**",
     "https://packt-angular-social.now.sh/api/**"
   ],
   "cacheConfig": {
     "strategy": "freshness",
     "maxSize": 100,
     "maxAge": "1h",
     "timeout": "5s"
   }
}</pre></div></li></ol></div><p>In this section, we configured the asset groups and data groups of our application in our service worker.</p><p>With this configuration and our service worker running, we should be able to retrieve a fully<a class="indexterm" id="id158"/> styled application that displays the latest API data.</p></div></div>
<div class="section" title="Testing the Service Worker"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec33"/>Testing the Service Worker</h1></div></div></div><p>In order to test if our<a class="indexterm" id="id159"/> service worker works, we will have to load our application, and then disconnect our browser from the internet.</p><div class="section" title="Checking Where the Data Comes from"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec57"/>Checking Where the Data Comes from</h2></div></div></div><p>Using Chrome Developer Tools, it's easy to see where a particular resource is being retrieved from.</p><p>Using the <span class="strong"><strong>Network</strong></span> tab in Chrome Developer Tools, you can see what files are being retrieved, where the data comes from, and how long it took the browser to fetch those resources.</p><p>The following<a class="indexterm" id="id160"/> screenshot shows a normal page request, where each file is downloaded from the web server:</p><div class="mediaobject"><img alt="Checking Where the Data Comes from" src="graphics/3.4.jpg"/></div><p>In the following screenshot, in the <span class="strong"><strong>Size</strong></span> column, you can see that the data is being retrieved from the service worker. This means it did not make a request to the network to fetch those items; rather, it got them from the browser cache:</p><div class="mediaobject"><img alt="Checking Where the Data Comes from" src="graphics/3.5.jpg"/></div></div><div class="section" title="Enabling Offline Mode"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec58"/>Enabling Offline Mode</h2></div></div></div><p>It's the <a class="indexterm" id="id161"/>nature of a web browser to be online, but in reality, we've all found ourselves in situations where our device is offline due to a lack of network connectivity.</p><p>In order to develop apps that can handle these situations, Chrome offers a so-called <span class="strong"><strong>Offline mode</strong></span>. It will stop the browser from connecting to the network. That way, we can make sure our applications behave as expected.</p><p>In the <span class="strong"><strong>Network</strong></span> tab in Chrome Developer Tools, you can find a checkbox named <span class="strong"><strong>Offline</strong></span>, which triggers this behavior:</p><div class="mediaobject"><img alt="Enabling Offline Mode" src="graphics/3.6.jpg"/></div><p>After checking this box, you will see a yellow indicator next to the tab name, which indicates that there is something unusual going on with the <span class="strong"><strong>Network</strong></span> tab:</p><div class="mediaobject"><img alt="Enabling Offline Mode" src="graphics/3.7.jpg"/></div><div class="section" title="Running a Local Build of the Browser App"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec13"/>Running a Local Build of the Browser App</h3></div></div></div><p>We will build a production version of our app that enables the service worker. Once the build is made, we will host the build using a simple web server called <code class="literal">http-server</code> and open it in our browser:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Build the browser app using the following command:<div class="informalexample"><pre class="programlisting">npm run build:browser</pre></div></li><li class="listitem">Serve the app using the following command:<div class="informalexample"><pre class="programlisting">npx http-server ./dist/browser</pre></div><p>The application will now be served on: <code class="literal">http://localhost:8080</code>
</p></li><li class="listitem">Open the page in the browser. You should see the list of posts.</li><li class="listitem">Open the <span class="strong"><strong>Console</strong></span> tab in Chrome Developer Tools and verify that there are no errors.</li></ol></div></div><div class="section" title="Inspecting the Behavior"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec14"/>Inspecting the Behavior</h3></div></div></div><p>We will see how our app behaves with the service worker enabled:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the page from the last exercise in the browser.</li><li class="listitem">Open the <span class="strong"><strong>Network</strong></span> tab in Chrome Developer Tools.</li><li class="listitem">With this <span class="strong"><strong>Network</strong></span> tab open, reload <code class="literal">http://localhost:8080</code> to see where the data comes from.</li></ol></div><p>You should <a class="indexterm" id="id162"/>see that the data gets loaded from the service worker.</p></div><div class="section" title="Setting Our Application to Offline Mode"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec15"/>Setting Our Application to Offline Mode</h3></div></div></div><p>We will set our application to <span class="strong"><strong>Offline</strong></span> mode and verify that the service worker displays a complete and cached version of our app:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the page from the last exercise in the browser.</li><li class="listitem">Open the <span class="strong"><strong>Network</strong></span> tab in Chrome Developer Tools.</li><li class="listitem">Enable the <span class="strong"><strong>Offline</strong></span> mode by enabling the checkbox.</li><li class="listitem">While in <span class="strong"><strong>Offline</strong></span> mode, navigate to: <code class="literal">http://localhost:8080</code>.</li></ol></div><p>You should see that our application still gets loaded and displays the cached data.</p><p>In this section, we ran a local build of our app and then tested its behavior in offline mode. Our app runs well even in offline mode. We can now explore how to debug our service workers.</p></div></div></div>
<div class="section" title="Debugging the Service Worker"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec34"/>Debugging the Service Worker</h1></div></div></div><p>There is a <a class="indexterm" id="id163"/>famous saying in computer science:</p><div class="blockquote"><blockquote class="blockquote"><p>"There are 2 hard problems in computer science: cache invalidation, naming things."</p><p>-Phil Karlton</p></blockquote></div><p>The first one applies to debugging service workers.</p><p>As discussed earlier, a service worker adds a caching layer between the network and the device. This inherently makes it hard to debug, because when you update your service worker definition or the configuration of your website, your changes might very well be cached, and thus not visible.</p><p>It is a quite well-known challenge while developing applications with service worker support, so it's good to understand how to debug the service worker.</p><div class="mediaobject"><img alt="Debugging the Service Worker" src="graphics/3.8.jpg"/></div><div class="section" title="Chrome Developer Tools to the Rescue"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec59"/>Chrome Developer Tools to the Rescue</h2></div></div></div><p>Chrome Developer Tools is <a class="indexterm" id="id164"/>an advanced tool for inspecting and debugging the technology behind websites, and luckily, it has great support for service workers.</p><p>In the <span class="strong"><strong>Application</strong></span> tab, we can see which service workers are installed, what their status is, and unregister them to make sure we download the latest version.</p><div class="section" title="Locating the Running Service Worker"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec16"/>Locating the Running Service Worker</h3></div></div></div><p>We will locate where we can find the running service worker:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the page from the last exercise in the browser.</li><li class="listitem">Open the <span class="strong"><strong>Application</strong></span> tab in Chrome Developer Tools.</li><li class="listitem">In the sidebar of the <span class="strong"><strong>Application</strong></span> tab, click on the <span class="strong"><strong>Service Workers</strong></span> link.</li><li class="listitem">Verify that there is an entry in the list of service workers.</li></ol></div></div><div class="section" title="Unregistering the Registered Service Worker"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec17"/>Unregistering the Registered Service Worker</h3></div></div></div><p>We will unregister our service worker:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the page from the last exercise in the browser.</li><li class="listitem">Open the <span class="strong"><strong>Application</strong></span> tab in Chrome Developer Tools and click on the <span class="strong"><strong>Service Workers</strong></span> link in the sidebar.</li><li class="listitem">Locate the entry of the service worker that has the <span class="strong"><strong>Status</strong></span> set to <span class="strong"><strong>activated</strong></span>.</li><li class="listitem">Click on the <span class="strong"><strong>Unregister</strong></span> link next to the <span class="strong"><strong>Update</strong></span> link.</li><li class="listitem">When you now refresh the page, a new service worker should be loaded.</li></ol></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note10"/>Note</h3><p>If you just refresh the page, it will load the same service worker from our build.</p></div></div><p>The development cycle for building a service worker looks something like this:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Make a change in the Angular application.</li><li class="listitem">Create a production build using the <code class="literal">npm run build:browser</code> command.</li><li class="listitem">Serve the new build using the <code class="literal">npx http-server ./dist/browser</code> command.</li><li class="listitem">Unregister the currently active service worker.</li><li class="listitem">Browse to the new version and verify the changes you made are applied.</li></ol></div><p>In this section, we saw where to locate the service worker in our browser. We then debugged it by unregistering it.</p></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec35"/>Summary</h1></div></div></div><p>In this lesson, we worked entirely with service workers. We started by installing the required dependencies. We then moved on to enabling the service worker, configuring it, testing it, and finally, debugging it.</p></div></body></html>