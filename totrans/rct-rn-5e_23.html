<html><head></head><body>
  <div id="_idContainer184" class="Basic-Text-Frame">
    <h1 class="chapterNumber">21</h1>
    <h1 id="_idParaDest-261" class="chapterTitle">Geolocation and Maps</h1>
    <p class="normal">In this chapter, you’ll learn about the geolocation and mapping capabilities of React Native. You’ll start the learning<a id="_idIndexMarker783"/> process with how to use the <strong class="keyWord">Geolocation API</strong>, and then you’ll move on to using the <code class="inlineCode">MapView</code> component to plot points of interest and regions. To do this, we’ll use the <code class="inlineCode">react-native-maps</code> package to implement maps. </p>
    <p class="normal">The goal of this chapter is to go over what’s available in React Native for geolocation and in <code class="inlineCode">react-native-maps</code> for maps. </p>
    <p class="normal">Here’s a list of the topics that we’ll cover in this chapter:</p>
    <ul>
      <li class="bulletList">Using the Geolocation API </li>
      <li class="bulletList">Rendering the map</li>
      <li class="bulletList">Annotating points of interest</li>
    </ul>
    <h1 id="_idParaDest-262" class="heading-1">Technical requirements</h1>
    <p class="normal">You can find the code file for this chapter on GitHub at <a href="https://github.com/PacktPublishing/React-and-React-Native-5E/tree/main/Chapter22"><span class="url">https://github.com/PacktPublishing/React-and-React-Native-5E/tree/main/Chapter2</span></a><span class="url">1</span>.</p>
    <h1 id="_idParaDest-263" class="heading-1">Using the Geolocation API</h1>
    <p class="normal">The Geolocation API that web applications<a id="_idIndexMarker784"/> use to figure out where the user is located can also be used by React Native applications because the same API has been polyfilled. Other than maps, this API is useful for getting precise coordinates from the GPS on mobile devices. You can then use this information to display meaningful location data to the user.</p>
    <p class="normal">Unfortunately, the data returned by the Geolocation API is of little use on its own. Your code must do the legwork to transform it into something useful. For example, latitude and longitude don’t mean anything to the user, but you can use this data to look up something that is of use to the user. This might be as simple as displaying where the user is currently located.</p>
    <p class="normal">Let’s implement an example that uses the <strong class="keyWord">Geolocation API</strong> of React Native to look up coordinates and then use those coordinates to look up human-readable location information from the Google Maps API.</p>
    <p class="normal">Before we start coding, let’s create a project using <code class="inlineCode">npx create-expo-app</code> and then add the location module:</p>
    <pre class="programlisting con"><code class="hljs-con">npx expo install expo-location
</code></pre>
    <p class="normal">Next, we need to configure location<a id="_idIndexMarker785"/> permissions in the app. Accessing a user’s location in a mobile app requires explicit permission from the user. Later in this example, we will do that by calling the <code class="inlineCode">Location.requestForegroundPermissionsAsync()</code> method. This will display a permission dialog to the user asking them to allow or deny location access. It’s important to check the status returned to see if permission was granted before proceeding to use location methods. If permission is denied, you should gracefully handle it in your code and potentially prompt the user to grant permission in app settings if needed.</p>
    <p class="normal">In real apps, before we can request permissions, we should first set those permissions up in the app configuration. We can do this by adding a plugin to the <code class="inlineCode">app.json</code> file:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"expo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"expo-location"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"locationAlwaysAndWhenInUsePermission"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Allow $(PRODUCT_NAME) to use your location."</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
}
</code></pre>
    <p class="normal">You should request location permission as early as possible, such as when your app first starts up or when the user first navigates to a screen that requires location. By requesting permission up-front and properly handling the user’s choice, you can ensure your app works as expected while respecting the user’s privacy preferences.</p>
    <p class="normal">When you have a prepared project, let’s have a look at the <code class="inlineCode">App</code> component, which you can find here: <a href="https://github.com/PacktPublishing/React-and-React-Native-5E/tree/main/Chapter22/where-am-i/App.tsx"><span class="url">https://github.com/PacktPublishing/React-and-React-Native-5E/tree/main/Chapter22/where-am-i/App.tsx</span></a>. The goal of this component is to render the properties returned by the Geolocation API on the screen, as well as looking up the user’s specific location and displaying it.</p>
    <p class="normal">To fetch a location from the app, we need to grant permissions. In <code class="inlineCode">App.tsx</code>, we have called <code class="inlineCode">Location.requestForegroundPermissionsAsync()</code> for that.</p>
    <p class="normal">The <code class="inlineCode">setPosition()</code> function is used as a callback in a couple of places, with its job being to set the state of your component. Firstly, <code class="inlineCode">setPosition()</code> sets the latitude-longitude coordinates. Normally, you wouldn’t display this data directly, but this is an example that shows the data that’s available as part of the Geolocation API. And, secondly, it uses the <code class="inlineCode">latitude</code> and <code class="inlineCode">longitude</code> values to look up the name of where the user currently is, using the Google Maps API. </p>
    <p class="normal">In the example, the <code class="inlineCode">API_KEY</code> value<a id="_idIndexMarker786"/> is empty, and you can get it here: <a href="https://developers.google.com/maps/documentation/geocoding/start"><span class="url">https://developers.google.com/maps/documentation/geocoding/start</span></a>.</p>
    <p class="normal">The <code class="inlineCode">setPosition()</code> callback<a id="_idIndexMarker787"/> is used with <code class="inlineCode">getCurrentPosition()</code>, which is only called once when the component is mounted. You’re also using <code class="inlineCode">setPosition()</code> with <code class="inlineCode">watchPosition()</code>, which calls the callback any time the user’s position changes.</p>
    <div class="note">
      <p class="normal">The iOS emulator and Android Studio let you change locations via menu options. You don’t have to install your app on a physical device every time you want to test changing locations.</p>
    </div>
    <p class="normal">Let’s see what this screen looks like once the location data has loaded:</p>
    <figure class="mediaobject"> <img src="../Images/B19636_21_01.png" alt="Picture 1"/></figure>
    <p class="packt_figref">Figure 21.1: Location data</p>
    <p class="normal">The address information<a id="_idIndexMarker788"/> that was fetched is probably more useful in an application than latitude and longitude data. It works well for apps that need to find buildings around you or companies. Even better than physical address text is visualizing the user’s physical location on a map; you’ll learn how to do this in the next section.</p>
    <h1 id="_idParaDest-264" class="heading-1">Rendering the map</h1>
    <p class="normal">The <code class="inlineCode">MapView</code> component from <code class="inlineCode">react-native-maps</code> is the main<a id="_idIndexMarker789"/> tool you’ll use to render maps in your React Native applications. It offers a wide range of tools for rendering maps, markers, polygons, heatmaps, and the like.</p>
    <div class="note">
      <p class="normal">You can find more information about <code class="inlineCode">react-native-maps</code> on the website: <a href="https://github.com/react-native-maps/react-native-maps"><span class="url">https://github.com/react-native-maps/react-native-maps</span></a>.</p>
    </div>
    <p class="normal">Let’s now implement a basic <code class="inlineCode">MapView</code> component to see what you get out of the box:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> { <span class="hljs-title">View</span>, <span class="hljs-title">StatusBar</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-native"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title">MapView</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react-native-maps"</span>;
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">"./styles"</span>;
<span class="hljs-title">StatusBar</span>.<span class="hljs-title">setBarStyle</span>(<span class="hljs-string">"dark-content"</span>);
<span class="hljs-keyword">export</span> <span class="hljs-title">default</span> () =&gt; (
  <span class="hljs-tag">&lt;</span><span class="hljs-name">View</span><span class="hljs-tag"> </span><span class="hljs-attr">style</span><span class="hljs-tag">=</span><span class="hljs-string">{styles.container}</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">MapView</span><span class="hljs-tag"> </span><span class="hljs-attr">style</span><span class="hljs-tag">=</span><span class="hljs-string">{styles.mapView}</span><span class="hljs-tag"> </span><span class="hljs-attr">showsUserLocation</span><span class="hljs-tag"> </span><span class="hljs-attr">followsUserLocation</span><span class="hljs-tag"> /&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">View</span><span class="hljs-tag">&gt;</span>
);
</code></pre>
    <p class="normal">The two Boolean properties that you’ve passed to <code class="inlineCode">MapView</code> do a lot of work for you. The <code class="inlineCode">showsUserLocation</code> property will activate the marker on the map, which denotes the physical location of the device running this application. The <code class="inlineCode">followsUserLocation</code> property tells the map to update the location marker as the device moves around. </p>
    <p class="normal">Here is the resulting map:</p>
    <figure class="mediaobject"> <img src="../Images/B19636_21_02.png" alt="Picture 2"/></figure>
    <p class="packt_figref">Figure 21.2: Current location</p>
    <p class="normal">The current location of the device is clearly marked on the map. By default, points of interest are also rendered on the map. These are things close to the user so that they can see what’s around them.</p>
    <p class="normal">It’s generally a good idea to use the <code class="inlineCode">followsUserLocation</code> property whenever using <code class="inlineCode">showsUserLocation</code>. This makes<a id="_idIndexMarker790"/> the map zoom to the region where the user is located. </p>
    <p class="normal">In the following section, you’ll learn how to annotate points of interest on your maps.</p>
    <h1 id="_idParaDest-265" class="heading-1">Annotating points of interest</h1>
    <p class="normal"><strong class="keyWord">Annotations</strong> are exactly what they<a id="_idIndexMarker791"/> sound like: additional information rendered<a id="_idIndexMarker792"/> on top of the basic map geography. You get annotations by default when you render <code class="inlineCode">MapView</code> components. The <code class="inlineCode">MapView</code> component can render the user’s current location and points of interest around the user. The challenge here is that you probably want to show the points of interest relevant to your application instead of those rendered by default.</p>
    <p class="normal">In this section, you’ll learn how to render markers for specific locations on the map, as well as rendering regions on the map.</p>
    <h2 id="_idParaDest-266" class="heading-2">Plotting points</h2>
    <p class="normal">Let’s plot some local<a id="_idIndexMarker793"/> breweries! Here’s how you pass annotations to the <code class="inlineCode">MapView</code> component:</p>
    <pre class="programlisting code"><code class="hljs-code">&lt;<span class="hljs-title">MapView</span>
  style={styles.<span class="hljs-property">mapView</span>}
  showsPointsOfInterest={<span class="hljs-literal">false</span>}
  showsUserLocation
  followsUserLocation
&gt;
  <span class="hljs-tag">&lt;</span><span class="hljs-name">Marker</span>
<span class="hljs-tag">    </span><span class="hljs-attr">title</span><span class="hljs-tag">=</span><span class="hljs-string">"Duff Brewery"</span>
<span class="hljs-tag">    </span><span class="hljs-attr">description</span><span class="hljs-tag">=</span><span class="hljs-string">"Duff beer for me, Duff beer for you"</span>
<span class="hljs-tag">    </span><span class="hljs-attr">coordinate</span><span class="hljs-tag">=</span><span class="hljs-string">{{</span>
<span class="hljs-tag">      </span><span class="hljs-attr">latitude:</span><span class="hljs-tag"> </span><span class="hljs-attr">43.8418728</span><span class="hljs-tag">,</span>
<span class="hljs-tag">      </span><span class="hljs-attr">longitude:</span><span class="hljs-tag"> </span><span class="hljs-attr">-79.086082</span><span class="hljs-tag">,</span>
<span class="hljs-tag">    }}</span>
<span class="hljs-tag">  /&gt;</span>
  {...}
&lt;/<span class="hljs-title">MapView</span>&gt;
</code></pre>
    <p class="normal">In this example, we’ve opted out of this capability by setting the <code class="inlineCode">showsPointsOfInterest</code> property to <code class="inlineCode">false</code>. Let’s see where these breweries are located:</p>
    <figure class="mediaobject"> <img src="../Images/B19636_21_03.png" alt="Picture 3"/></figure>
    <p class="packt_figref">Figure 21.3: Plotting points</p>
    <p class="normal">The callout is displayed when you press the marker that shows the location of the brewery on the map. The <code class="inlineCode">title</code> and <code class="inlineCode">description</code> property values that you give to <code class="inlineCode">&lt;Marker&gt;</code> are used to render<a id="_idIndexMarker794"/> this text.</p>
    <h2 id="_idParaDest-267" class="heading-2">Plotting overlays</h2>
    <p class="normal">In this last section<a id="_idIndexMarker795"/> of this chapter, you’ll learn how to render region overlays. Think of a region as a connect-the-dots drawing of several points, and a point is a single <code class="inlineCode">latitude/longitude</code> coordinate. </p>
    <p class="normal">Regions can serve many purposes. In our example, we’ll create a region that shows where we’re more likely to find IPA drinkers versus stout drinkers. You can follow this link to see what the full code looks like: <a href="https://github.com/PacktPublishing/React-and-React-Native-5E/tree/main/Chapter22/plotting-overlays/App.tsx"><span class="url">https://github.com/PacktPublishing/React-and-React-Native-5E/tree/main/Chapter22/plotting-overlays/App.tsx</span></a>. Here is what the JSX part of the code looks like:</p>
    <pre class="programlisting code"><code class="hljs-code">    &lt;<span class="hljs-title">View</span> style={styles.<span class="hljs-property">container</span>}&gt;
      <span class="hljs-tag">&lt;</span><span class="hljs-name">View</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">Text</span><span class="hljs-tag"> </span><span class="hljs-attr">style</span><span class="hljs-tag">=</span><span class="hljs-string">{ipaStyles}</span><span class="hljs-tag"> </span><span class="hljs-attr">onPress</span><span class="hljs-tag">=</span><span class="hljs-string">{onClickIpa}</span><span class="hljs-tag">&gt;</span>
          IPA Fans
        <span class="hljs-tag">&lt;/</span><span class="hljs-name">Text</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">Text</span><span class="hljs-tag"> </span><span class="hljs-attr">style</span><span class="hljs-tag">=</span><span class="hljs-string">{stoutStyles}</span><span class="hljs-tag"> </span><span class="hljs-attr">onPress</span><span class="hljs-tag">=</span><span class="hljs-string">{onClickStout}</span><span class="hljs-tag">&gt;</span>
          Stout Fans
        <span class="hljs-tag">&lt;/</span><span class="hljs-name">Text</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">View</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">MapView</span>
<span class="hljs-tag">        </span><span class="hljs-attr">style</span><span class="hljs-tag">=</span><span class="hljs-string">{styles.mapView}</span>
<span class="hljs-tag">        </span><span class="hljs-attr">showsPointsOfInterest</span><span class="hljs-tag">=</span><span class="hljs-string">{false}</span>
<span class="hljs-tag">        </span><span class="hljs-attr">initialRegion</span><span class="hljs-tag">=</span><span class="hljs-string">{{</span>
<span class="hljs-tag">          </span><span class="hljs-attr">latitude:</span><span class="hljs-tag"> </span><span class="hljs-attr">43.8486744</span><span class="hljs-tag">,</span>
<span class="hljs-tag">          </span><span class="hljs-attr">longitude:</span><span class="hljs-tag"> </span><span class="hljs-attr">-79.0695283</span><span class="hljs-tag">,</span>
<span class="hljs-tag">          </span><span class="hljs-attr">latitudeDelta:</span><span class="hljs-tag"> </span><span class="hljs-attr">0.002</span><span class="hljs-tag">,</span>
<span class="hljs-tag">          </span><span class="hljs-attr">longitudeDelta:</span><span class="hljs-tag"> </span><span class="hljs-attr">0.04</span><span class="hljs-tag">,</span>
<span class="hljs-tag">        }}</span>
<span class="hljs-tag">      &gt;</span>
        {overlays.map((v, i) =&gt; (
          <span class="hljs-tag">&lt;</span><span class="hljs-name">Polygon</span>
<span class="hljs-tag">            </span><span class="hljs-attr">key</span><span class="hljs-tag">=</span><span class="hljs-string">{i}</span>
<span class="hljs-tag">            </span><span class="hljs-attr">coordinates</span><span class="hljs-tag">=</span><span class="hljs-string">{v.coordinates}</span>
<span class="hljs-tag">            </span><span class="hljs-attr">strokeColor</span><span class="hljs-tag">=</span><span class="hljs-string">{v.strokeColor}</span>
<span class="hljs-tag">            </span><span class="hljs-attr">strokeWidth</span><span class="hljs-tag">=</span><span class="hljs-string">{v.strokeWidth}</span>
<span class="hljs-tag">          /&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">MapView</span><span class="hljs-tag">&gt;</span>
    &lt;/<span class="hljs-title">View</span>&gt;
</code></pre>
    <p class="normal">The region data consists of several <code class="inlineCode">latitude/longitude</code> coordinates that define the shape and location of the region. Regions are placed in the <code class="inlineCode">overlays</code> state variable, which we map into <code class="inlineCode">Polygon</code> components. The rest of this code is mostly about the handling state when the two text<a id="_idIndexMarker796"/> links are pressed. </p>
    <p class="normal">By default, the IPA region is rendered as follows:</p>
    <figure class="mediaobject"> <img src="../Images/B19636_21_04.png" alt="Picture 4"/></figure>
    <p class="packt_figref">Figure 21.4: IPA Fans</p>
    <p class="normal">When the <strong class="screenText">Stout Fans</strong> button <a id="_idIndexMarker797"/>is pressed, the IPA overlay is removed from the map and the stout region is added:</p>
    <figure class="mediaobject"> <img src="../Images/B19636_21_05.png" alt="Picture 5"/></figure>
    <p class="packt_figref">Figure 21.5: Stout Fans</p>
    <p class="normal">Overlays are useful when you need<a id="_idIndexMarker798"/> to highlight an area instead of a <code class="inlineCode">latitude/longitude</code> point or an address. As an example, it might be an app for finding apartments for rent in the area or neighborhood you select.</p>
    <h1 id="_idParaDest-268" class="heading-1">Summary</h1>
    <p class="normal">In this chapter, you learned about geolocation and mapping in React Native. The Geolocation API works the same as its web counterpart. The only reliable way to use maps in React Native applications is to install the third-party <code class="inlineCode">react-native-maps</code> package.</p>
    <p class="normal">You saw the basic configuration <code class="inlineCode">MapView</code> components and how they can track the user’s location and show relevant points of interest. Then, you saw how to plot your own points of interest and regions of interest.</p>
    <p class="normal">In the next chapter, you’ll learn how to collect user input using React Native components that resemble HTML form controls.</p>
  </div>
</body></html>