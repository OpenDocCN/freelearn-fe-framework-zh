<html><head></head><body>
  <div id="_idContainer474" class="Basic-Text-Frame">
    <h1 class="chapterNumber">9</h1>
    <h1 id="_idParaDest-269" class="chapterTitle">Recipes – Master/Detail, Data Tables, and NgRx</h1>
    <p class="normal">In this chapter, we complete the router-first architecture implementation on LemonMart by implementing the top three most used features in business applications: master/detail views, data tables, and state management. I will demonstrate data tables with server-side pagination, highlighting the integration between the frontend and backend using LemonMart and LemonMart Server.</p>
    <p class="normal">We will leverage the router orchestration concept to orchestrate how our components load data or render. We will then use resolve guards to reduce boilerplate code when loading data before navigating to a component. We will use auxiliary routes to lay out components through the router configuration and reuse the same component in multiple contexts.</p>
    <p class="normal">We will then dive into NgRx using the LocalCast Weather app and explore NgRx Signal Store with LemonMart, so you can become familiar with more advanced application architecture concepts in Angular. By the end of this chapter, we will have touched upon the major functionality that Angular and Angular Material offer – only the good parts, if you will.</p>
    <p class="normal">This chapter covers a lot of ground. It is organized in a recipe format, so you can quickly refer to a particular implementation when working on your projects. I cover the architecture, design, and major components of the implementation and highlight important pieces of code to explain how the solution comes together. Leveraging what you’ve learned, I expect the reader to fill in routine implementation and configuration details. However, you can always refer to the GitHub repo if you get stuck.</p>
    <p class="normal">In this chapter, you will learn about the following topics:</p>
    <ul>
      <li class="bulletList">Loading data with resolve guard</li>
      <li class="bulletList">Reusing components with binding and route data</li>
      <li class="bulletList">Master/detail view using auxiliary routes</li>
      <li class="bulletList">Data tables with pagination</li>
      <li class="bulletList">NgRx store and effects</li>
      <li class="bulletList">NgRx ecosystem</li>
      <li class="bulletList">Implementing a global spinner</li>
      <li class="bulletList">Configuring server proxies with the Angular CLI</li>
    </ul>
    <h1 id="_idParaDest-270" class="heading-1">Technical requirements</h1>
    <p class="normal">The most up-to-date versions of the sample code for the book are on GitHub at the repository linked in the following list. The repository contains the final and completed state of the code. You can verify your progress at the end of this chapter by looking for the end-of-chapter snapshot of code under the <code class="inlineCode">projects</code> folder.</p>
    <p class="normal">For <em class="italic">Chapter 9</em>:</p>
    <div class="note">
      <p class="normal">Be sure that <strong class="keyWord">lemon-mart-server</strong> is up and running. Refer to <em class="chapterRef">Chapter 7</em>, <em class="italic">Working with REST and GraphQL APIs</em>.</p>
    </div>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Clone the repositories at <a href="https://github.com/duluca/local-weather-app"><span class="url">https://github.com/duluca/local-weather-app</span></a> and <a href="https://github.com/duluca/lemon-mart"><span class="url">https://github.com/duluca/lemon-mart</span></a>.</li>
      <li class="numberedList">Execute <code class="inlineCode">npm install</code> on the root folder to install dependencies.</li>
      <li class="numberedList">The beginning state of the project is reflected at:
        <pre class="programlisting con"><code class="hljs-con">projects/stage11
</code></pre>
      </li>
      <li class="numberedList">The end state of the project is reflected at:
        <pre class="programlisting con"><code class="hljs-con">projects/stage12
</code></pre>
      </li>
      <li class="numberedList">Add the stage name to any <code class="inlineCode">ng</code> command to act only on that stage:
        <pre class="programlisting con"><code class="hljs-con">npx ng build stage12
</code></pre>
      </li>
    </ol>
    <div class="packt_tip">
      <p class="normal">Note that the <code class="inlineCode">dist/stage12</code> folder at the root of the repository will contain the compiled result.</p>
    </div>
    <p class="normal">In <em class="chapterRef">Chapter 8,</em> <em class="italic">Recipes – Reusability, Forms, and Caching</em>, we created a <code class="inlineCode">ViewUserComponent</code> with an <code class="inlineCode">editUser</code> function. We need this functionality later in the chapter when implementing a master/detail view in the system, where a manager can see all users in the system and edit them. Before enabling the <code class="inlineCode">editUser</code> functionality, we need to ensure that the <code class="inlineCode">ViewUserComponent</code> component alongside the <code class="inlineCode">ProfileComponent</code> can load any user given their ID.</p>
    <p class="normal">In the next couple of sections, we will learn about resolve guards to simplify our code and reduce the amount of boilerplate. Let’s start by implementing a resolve guard we can use for both components.</p>
    <h1 id="_idParaDest-271" class="heading-1">Loading data with resolve guard</h1>
    <p class="normal">A resolve guard is a different kind<a id="_idIndexMarker894"/> of router guard, as mentioned in <em class="chapterRef">Chapter 6</em>, <em class="italic">Implementing Role-Based Navigation</em>. A resolve guard can load<a id="_idIndexMarker895"/> necessary data for a component by reading record IDs from <code class="inlineCode">route</code> parameters, asynchronously loading the data, and having it ready when the component activates and initializes.</p>
    <p class="normal">The major advantages of a resolve guard include reusability of the loading logic, a reduction of boilerplate code, and the shedding of dependencies because the component can receive the data it needs without having to import any service:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Create a new <code class="inlineCode">user.resolve.ts</code> class under <code class="inlineCode">user/user</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/user/user.</strong><strong class="hljs-property-slc">resolve</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { inject } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">ActivatedRouteSnapshot</span>, <span class="hljs-title">ResolveFn</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>
<span class="hljs-keyword">import</span> { catchError, map } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>
<span class="hljs-keyword">import</span> { transformError } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../common/common'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">UserService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.service'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">userResolver</span>: <span class="hljs-title">ResolveFn</span>&lt;<span class="hljs-title">User</span>&gt; = <span class="hljs-function">(</span><span class="hljs-attr">route</span><span class="hljs-params">: </span><span class="hljs-title">ActivatedRouteSnapshot</span><span class="hljs-function">) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title">inject</span>(<span class="hljs-title">UserService</span>)
    .<span class="hljs-title">getUser</span>(route.<span class="hljs-property">paramMap</span>.<span class="hljs-title">get</span>(<span class="hljs-string">'userId'</span>))
    .<span class="hljs-title">pipe</span>(<span class="hljs-title">map</span>(<span class="hljs-title">User</span>.<span class="hljs-property">Build</span>), <span class="hljs-title">catchError</span>(transformError))
}
</code></pre>
     
    <div class="packt_tip">
      <p class="normal">Similar to the <code class="inlineCode">updateUser</code> method in <code class="inlineCode">UserService</code>, we use <code class="inlineCode">map(User.Build)</code> to hydrate the <code class="inlineCode">user</code> object, so it is ready to be used when a component loads data from the <code class="inlineCode">route</code> snapshot, as we’ll see next.</p>
    </div> </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">Modify <code class="inlineCode">user-routing.module.ts</code> to add<a id="_idIndexMarker896"/> a new path, <code class="inlineCode">profile/:userId</code>, with a route resolver<a id="_idIndexMarker897"/> and the <code class="inlineCode">canActivate authGuard</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/user-routing.</strong><strong class="hljs-property-slc">module</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
{
    <span class="hljs-attr">path</span>: <span class="hljs-string">'profile/:userId'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-title">ProfileComponent</span>,
    <span class="hljs-attr">resolve</span>: {
      <span class="hljs-attr">user</span>: userResolver,
    },
    <span class="hljs-attr">canActivate</span>: [authGuard],
  },
  ...
</code></pre>
     
    <div class="packt_tip">
      <p class="normal">When combined with an auth guard, the <code class="inlineCode">resolve</code> function won’t be executed until the guard succeeds.</p>
    </div> </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Update the <code class="inlineCode">profile</code> component to load the data from the <code class="inlineCode">route</code> if it exists:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/profile/profile.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
  <span class="hljs-title">constructor</span>(
<span class="hljs-params">    ...</span>
<span class="hljs-params">    </span><span class="code-highlight"><strong class="hljs-keyword-slc">private</strong><strong class="hljs-params-slc"> </strong><strong class="hljs-attr-slc">route</strong><strong class="hljs-params-slc">: </strong><strong class="hljs-title-slc">ActivatedRoute</strong></span>
<span class="hljs-params">  </span>) {
    <span class="hljs-variable">super</span>()
  }
  <span class="code-highlight"><strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">readonly</strong><strong class="hljs-slc"> destroyRef = </strong><strong class="hljs-title-slc">inject</strong><strong class="hljs-slc">(</strong><strong class="hljs-title-slc">DestroyRef</strong><strong class="hljs-slc">)</strong></span>
  
  <span class="hljs-title">ngOnInit</span>() {
    <span class="hljs-variable">this</span>.<span class="hljs-property">formGroup</span> = <span class="hljs-variable">this</span>.<span class="hljs-title">buildForm</span>()
    <span class="hljs-keyword">if</span> (<span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">route</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">snapshot</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">data</strong><strong class="hljs-slc">[</strong></span><span class="hljs-string">'</span><span class="code-highlight"><strong class="hljs-string-slc">user</strong></span><span class="hljs-string">'</span><span class="code-highlight"><strong class="hljs-slc">]</strong></span>) {
      <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-title-slc">patchUser</strong><strong class="hljs-slc">(</strong><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">route</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">snapshot</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">data</strong><strong class="hljs-slc">[</strong></span><span class="hljs-string">'</span><span class="code-highlight"><strong class="hljs-string-slc">user</strong></span><span class="hljs-string">'</span><span class="code-highlight"><strong class="hljs-slc">]</strong></span>)
    } <span class="hljs-keyword">else</span> {
       <span class="hljs-title">combineLatest</span>(
        [<span class="hljs-variable">this</span>.<span class="hljs-title">loadFromCache</span>(), 
         <span class="hljs-variable">this</span>.<span class="hljs-property">authService</span>.<span class="hljs-property">currentUser$</span>]
       )
      .<span class="hljs-title">pipe</span>(
        <span class="hljs-title">takeUntilDestroyed</span>(<span class="hljs-variable">this</span>.<span class="hljs-property">destroyRef</span>),
        <span class="hljs-title">filter</span>(
          <span class="hljs-function">(</span><span class="hljs-params">[cachedUser, me]</span><span class="hljs-function">) =&gt;</span> 
            cachedUser != <span class="hljs-literal">null</span> || me != <span class="hljs-literal">null</span>
        ),
        <span class="hljs-title">tap</span>(
          <span class="hljs-function">(</span><span class="hljs-params">[cachedUser, me]</span><span class="hljs-function">) =&gt;</span> 
           <span class="hljs-variable">this</span>.<span class="hljs-title">patchUser</span>(cachedUser || me)
        )
      )
      .<span class="hljs-title">subscribe</span>()
    }
  }
</code></pre>
      </li>
    </ol>
    <p class="normal">We first check whether a user is present in the <code class="inlineCode">route</code> snapshot. If so, we call <code class="inlineCode">patchUser</code> to load this user. Otherwise, we fall back to our conditional cache-loading logic.</p>
    <p class="normal">Note that the <code class="inlineCode">patchUser</code> method also sets the <code class="inlineCode">currentUserId</code> and <code class="inlineCode">nameInitialDate$</code> Observables and calls the <code class="inlineCode">patchUpdateData</code> base to update the form data.</p>
    <p class="normal">You can verify that the resolver is working<a id="_idIndexMarker898"/> by navigating to the profile with your user ID. Using the out-of-the-box<a id="_idIndexMarker899"/> settings, this URL will look something like <code class="inlineCode">http://localhost:4200/user/profile/5da01751da27cc462d265913</code>.</p>
    <h1 id="_idParaDest-272" class="heading-1">Reusing components with binding and route data</h1>
    <p class="normal">Now, let’s refactor the <code class="inlineCode">viewUser</code> component<a id="_idIndexMarker900"/> so that we can reuse it in multiple<a id="_idIndexMarker901"/> contexts. User information<a id="_idIndexMarker902"/> is displayed in two places<a id="_idIndexMarker903"/> in the app per the mock-ups created.</p>
    <p class="normal">The first place is the <strong class="keyWord">Review</strong> step of the user profile that we implemented in the previous chapter. The second place is on the user management screen on the <code class="inlineCode">/manager/users</code> route, as follows:</p>
    <figure class="mediaobject"><img src="../Images/B20960_09_01.png" alt="A screenshot of a computer  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 9.1: Manager user management mock-up</p>
    <p class="normal">To maximize code reuse, we must ensure that our shared <code class="inlineCode">ViewUser</code> component can be used in both contexts.</p>
    <p class="normal">In the first use<a id="_idIndexMarker904"/> case, we bind<a id="_idIndexMarker905"/> the current user<a id="_idIndexMarker906"/> to the <strong class="keyWord">Review</strong> step of the<a id="_idIndexMarker907"/> multi-step input form. In the second use case, the component will need to load its data using a resolve guard, so we don’t need to implement additional logic to achieve our goal:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Update the <code class="inlineCode">viewUser</code> component to inject the <code class="inlineCode">Router</code> and <code class="inlineCode">ActivatedRoute</code>. In <code class="inlineCode">ngOnInit</code> we need to set <code class="inlineCode">currentUser</code> from the route in and subscribe to future route change events to apply updates<a id="_idIndexMarker908"/> to the user using<a id="_idIndexMarker909"/> a helper<a id="_idIndexMarker910"/> function <code class="inlineCode">assignUserFromRoute</code> and unsubscribe<a id="_idIndexMarker911"/> from the event in <code class="inlineCode">ngOnDestroy</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/view-user/view-user.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ViewUserComponent</span> 
  <span class="hljs-keyword">implements</span> <span class="hljs-title">OnInit</span>, <span class="hljs-title">OnChanges</span>, <span class="hljs-title">OnDestroy</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> route = <span class="hljs-title">inject</span>(<span class="hljs-title">ActivatedRoute</span>)
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> router = <span class="hljs-title">inject</span>(<span class="hljs-title">Router</span>)
  <span class="hljs-keyword">private</span> routerEventsSubscription?: <span class="hljs-title">Subscription</span>
  ...
  <span class="hljs-title">ngOnInit</span>() {
    <span class="hljs-comment">// assignment on initial render</span>
    <span class="hljs-variable">this</span>.<span class="hljs-title">assignUserFromRoute</span>()
    <span class="hljs-variable">this</span>.<span class="hljs-property">routerEventsSubscription</span> = 
      <span class="hljs-variable">this</span>.<span class="hljs-property">router</span>.<span class="hljs-property">events</span>.<span class="hljs-title">subscribe</span>(<span class="hljs-function">(</span><span class="hljs-params">event</span><span class="hljs-function">) =&gt;</span> {
      <span class="hljs-comment">// assignment on subsequent renders</span>
      <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> <span class="hljs-title">NavigationEnd</span>) {
        <span class="hljs-variable">this</span>.<span class="hljs-title">assignUserFromRoute</span>()
      }
    })
  }
  <span class="hljs-keyword">private</span> <span class="hljs-title">assignUserFromRoute</span>() {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">this</span>.<span class="hljs-property">route</span>.<span class="hljs-property">snapshot</span>.<span class="hljs-property">data</span>[<span class="hljs-string">'user'</span>]) {
      <span class="hljs-variable">this</span>.<span class="hljs-property">currentUser</span> = <span class="hljs-variable">this</span>.<span class="hljs-property">route</span>.<span class="hljs-property">snapshot</span>.<span class="hljs-property">data</span>[<span class="hljs-string">'</span><span class="hljs-string">user'</span>]
    }
  }
  <span class="hljs-title">ngOnDestroy</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable">this</span>.<span class="hljs-property">routerEventsSubscription</span>?.<span class="hljs-title">unsubscribe</span>()
  }
  ...
}}
</code></pre>
      </li>
    </ol>
    <p class="normal"><code class="inlineCode">ngOnInit</code> will only fire once when the component is initialized within another component or loaded within the router context. If any data for the route has been resolved, we update <code class="inlineCode">currentUser</code>. When the user wants to view another user, a new navigation event will occur with a different user ID. Since Angular will reuse the component, we must subscribe to router events to react to subsequent user changes. In this case, in case of a <code class="inlineCode">NavigationEnd</code> event, if the route has resolved user data, we again update <code class="inlineCode">currentUser</code>.</p>
    <p class="normal">We now have three independent events to update and handle data. Within the parent component context, <code class="inlineCode">ngOnChanges</code> handles updates to the <code class="inlineCode">@Input</code> value and updates <code class="inlineCode">currentUser</code> if <code class="inlineCode">this.user</code> has been bound to. The code we added above handles the remaining two cases with router context on the first navigation and subsequent navigation events.</p>
    <p class="normal">Since LemonMart is bootstrapped as a standalone application and <code class="inlineCode">viewUser</code> is a standalone component, we can use<a id="_idIndexMarker912"/> this component across<a id="_idIndexMarker913"/> multiple lazy-loaded<a id="_idIndexMarker914"/> modules without<a id="_idIndexMarker915"/> additional orchestration.</p>
    <div class="packt_tip">
      <p class="normal">If you’re not using standalone components, you must wrap this component inside a <code class="inlineCode">SharedComponentsModule</code> and import that module in your lazy-loaded modules. You can find an example implementation in the GitHub history of the project.</p>
    </div>
    <p class="normal">With the key pieces in place, let’s begin implementing the master/detail view.</p>
    <h1 id="_idParaDest-273" class="heading-1">Master/detail view using auxiliary routes</h1>
    <p class="normal">The true power of router-first architecture<a id="_idIndexMarker916"/> comes to fruition with auxiliary<a id="_idIndexMarker917"/> routes, where we can influence the layout of components solely through router configuration, allowing for rich scenarios where we can remix the existing components into different layouts. Auxiliary routes are routes that are independent of each other where they can render content in named outlets that have been defined in the markup, such as <code class="inlineCode">&lt;router-outlet name="master"&gt;</code> or <code class="inlineCode">&lt;router-outlet name="detail"&gt;</code>. Furthermore, auxiliary routes can have their parameters, browser history, children, and nested auxiliaries.</p>
    <p class="normal">In the following example, we will implement a basic master/detail view using auxiliary routes:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Implement a simple <a id="_idIndexMarker918"/>component with two named<a id="_idIndexMarker919"/> outlets defined:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/manager/user-management/user-management.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
  <span class="hljs-attr">template</span>: <span class="hljs-string">`</span>
<span class="hljs-string">    &lt;div class="h-pad"&gt;</span>
<span class="hljs-string">      &lt;router-outlet name="master"&gt;&lt;/router-outlet&gt;</span>
<span class="hljs-string">      &lt;div style="min-height: 10px"&gt;&lt;/div&gt;</span>
<span class="hljs-string">      &lt;router-outlet name="detail"&gt;&lt;/router-outlet&gt;</span>
<span class="hljs-string">    &lt;/div&gt;</span>
<span class="hljs-string">  `</span>
</code></pre>
      </li>
      <li class="numberedList">Add a new <code class="inlineCode">userTable</code> component under <code class="inlineCode">manager</code>.</li>
      <li class="numberedList">Update <code class="inlineCode">manager-routing.module.ts</code> to define the auxiliary routes:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/manager/manager-routing.</strong><strong class="hljs-property-slc">module</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
  ...
    {
      <span class="hljs-attr">path</span>: <span class="hljs-string">'users'</span>,
      <span class="hljs-attr">component</span>: <span class="hljs-title">UserManagementComponent</span>,
      <span class="hljs-attr">children</span>: [
        { 
          <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">component</span>: <span class="hljs-title">UserTableComponent</span>, 
           <span class="hljs-attr">outlet</span>: <span class="hljs-string">'master'</span> 
        },
        {
          <span class="hljs-attr">path</span>: <span class="hljs-string">'user'</span>,
          <span class="hljs-attr">component</span>: <span class="hljs-title">ViewUserComponent</span>,
          <span class="hljs-attr">outlet</span>: <span class="hljs-string">'detail'</span>,
          <span class="hljs-attr">resolve</span>: {
            <span class="hljs-attr">user</span>: userResolver,
          },
        },
      ],
      <span class="hljs-attr">canActivate</span>: [authGuard],
      <span class="hljs-attr">canActivateChild</span>: [authGuard],
      <span class="hljs-attr">data</span>: {
        <span class="hljs-attr">expectedRole</span>: <span class="hljs-title">Role</span>.<span class="hljs-property">Manager</span>,
      },
    },
...
</code></pre>
      
    <p class="normal">This means that when a user navigates to <code class="inlineCode">/manager/users</code>, they’ll see the <code class="inlineCode">UserTableComponent</code>, because it is implemented with the default path.</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Provide <code class="inlineCode">UserResolve</code> in <code class="inlineCode">manager.module.ts</code> since <code class="inlineCode">viewUser</code> depends on it.</li>
      <li class="numberedList">Implement a temporary button in <code class="inlineCode">userTable</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/manager/user-table/user-table.component.html</strong></span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">button</span>
<span class="hljs-tag">  </span><span class="hljs-attr">mat-icon-button</span>
<span class="hljs-tag">  [</span><span class="hljs-attr">routerLink</span><span class="hljs-tag">]=</span><span class="hljs-string">"[</span>
<span class="hljs-string">    '../users',</span>
<span class="hljs-string">    { outlets: { detail: ['user', { userId: row._id }] } }</span>
<span class="hljs-string">  ]"</span>
<span class="hljs-tag">  [</span><span class="hljs-attr">skipLocationChange</span><span class="hljs-tag">]=</span><span class="hljs-string">"</span><span class="hljs-string">true"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-icon</span><span class="hljs-tag">&gt;</span>visibility<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-icon</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">button</span><span class="hljs-tag">&gt;</span>
</code></pre>
      
    <div class="packt_tip">
      <p class="normal">The <code class="inlineCode">skipLocationChange</code> directive navigates without pushing a new record into history. So, if the user views multiple records and hits the <strong class="screenText">Back</strong> button, they will be taken back to the previous screen instead of having to scroll through the records they viewed first.</p>
    </div>
    <p class="normal">Imagine that a user clicks<a id="_idIndexMarker920"/> on a <strong class="screenText">View detail</strong> button like the one defined<a id="_idIndexMarker921"/> previously – then, <code class="inlineCode">ViewUserComponent</code> will be rendered for the user with the given <code class="inlineCode">userId</code>. In the next screenshot, you can see what the <strong class="screenText">View Details</strong> button will look like after we implement the data table in the next section:</p>
    <figure class="mediaobject"><img src="../Images/B20960_09_02.png" alt="A screenshot of a phone  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 9.2: View Details button</p>
    <div class="packt_tip">
      <p class="normal">You can have as many combinations as possible and alternative components defined for the master and detail, allowing for the infinite possibilities of dynamic layouts. However, setting up the <code class="inlineCode">routerLink</code> can be a frustrating experience. Depending on the exact condition, you must either supply or not supply all or some outlets in the link.</p>
      <p class="normal">For example, in the preceding scenario, consider this alternative implementation, where the master outlet is explicitly defined:</p>
      <pre class="programlisting code"><code class="hljs-code">['../users', { 
   outlets: { 
     master: [''], detail: ['user', {userId: row.id}] 
   } 
}], 
</code></pre>
      <p class="normal">The router will not correctly parse this route and silently fail to load. If it is <code class="inlineCode">master: []</code> it will work. This comes down to how pattern matching happens on empty routes; while this makes logical sense in the framework code, it doesn’t make intuitive sense for developers using the APIs.</p>
    </div>
    <p class="normal">Now that we’ve completed<a id="_idIndexMarker922"/> the implementation of the resolve<a id="_idIndexMarker923"/> guard for <code class="inlineCode">ViewUserComponent</code>, you can use Chrome DevTools to see the data being loaded correctly.</p>
    <div class="note">
      <p class="normal">Before debugging, ensure that the <strong class="keyWord">lemon-mart-server</strong> we created in <em class="chapterRef">Chapter 7</em>, <em class="italic">Working with REST and GraphQL APIs</em>, is running.</p>
    </div></li>
    </ol>








    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">In <strong class="screenText">Chrome DevTools</strong>, set a breakpoint right after <code class="inlineCode">this.currentUser</code> is assigned, as shown:
    <figure class="mediaobject"><img src="../Images/B20960_09_03.png" alt="A screenshot of a computer  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 9.3: Dev Tools debugging ViewUserComponent</p></li>
    </ol>
    <p class="normal">You will observe that <code class="inlineCode">this.currentUser</code> is correctly set without any boilerplate code for loading data inside the <code class="inlineCode">ngOnInit</code> function, showing the true<a id="_idIndexMarker924"/> benefit of a resolve guard. <code class="inlineCode">ViewUserComponent</code> is the detail<a id="_idIndexMarker925"/> view; now, let’s implement the master view as a data table with pagination.</p>
    <h1 id="_idParaDest-274" class="heading-1">Data tables with pagination</h1>
    <p class="normal">We have created the scaffolding<a id="_idIndexMarker926"/> to lay out our master/detail view. In the master <a id="_idIndexMarker927"/>outlet, we will have a paginated data table of users, so let’s implement <code class="inlineCode">UserTableComponent</code>, which will contain a <code class="inlineCode">MatTableDataSource</code> property named <code class="inlineCode">dataSource</code>. We will need to be able to fetch user data in bulk using standard pagination controls such as <code class="inlineCode">pageSize</code> and <code class="inlineCode">pagesToSkip</code> and narrow down the selection further with user-provided search text.</p>
    <p class="normal">Let’s start by adding the necessary functionality to <code class="inlineCode">UserService</code>:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Implement a new <code class="inlineCode">IUsers</code> interface to describe the data structure of the paginated data:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/user/user.</strong><strong class="hljs-property-slc">service</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IUsers</span> {
  <span class="hljs-attr">data</span>: <span class="hljs-title">IUser</span>[]
  <span class="hljs-attr">total</span>: <span class="hljs-built_in">number</span>
}
</code></pre>
      </li>
      <li class="numberedList">Update the interface<a id="_idIndexMarker928"/> for <code class="inlineCode">UserService</code> with<a id="_idIndexMarker929"/> a <code class="inlineCode">getUsers</code> function:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/user/user.</strong><strong class="hljs-property-slc">service</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IUserService</span> {
  <span class="hljs-title">getUser</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">IUser</span>&gt;
  <span class="hljs-title">updateUser</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">user</span>: <span class="hljs-title">IUser</span>): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">IUser</span>&gt;
  <span class="code-highlight"><strong class="hljs-title-slc">getUsers</strong><strong class="hljs-slc">(</strong><strong class="hljs-attr-slc">pageSize</strong><strong class="hljs-slc">: </strong><strong class="hljs-built_in-slc">number</strong><strong class="hljs-slc">, </strong><strong class="hljs-attr-slc">searchText</strong><strong class="hljs-slc">: </strong><strong class="hljs-built_in-slc">string</strong><strong class="hljs-slc">, </strong></span>
    <span class="code-highlight"><strong class="hljs-attr-slc">pagesToSkip</strong><strong class="hljs-slc">: </strong><strong class="hljs-built_in-slc">number</strong><strong class="hljs-slc">): </strong><strong class="hljs-title-slc">Observable</strong><strong class="hljs-slc">&lt;</strong><strong class="hljs-title-slc">IUsers</strong><strong class="hljs-slc">&gt;</strong></span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IUserService</span> {
...
</code></pre>
      </li>
      <li class="numberedList">Add <code class="inlineCode">getUsers</code> to <code class="inlineCode">UserService</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/user/user/user.</strong><strong class="hljs-property-slc">service</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
<span class="hljs-title">getUsers</span>(
    <span class="hljs-attr">pageSize</span>: <span class="hljs-built_in">number</span>,
    searchText = <span class="hljs-string">''</span>,
    pagesToSkip = <span class="hljs-number">0</span>,
    sortColumn = <span class="hljs-string">''</span>,
    <span class="hljs-attr">sortDirection</span>: <span class="hljs-string">''</span> | <span class="hljs-string">'asc'</span> | <span class="hljs-string">'desc'</span> = <span class="hljs-string">'asc'</span>
  ): <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">IUsers</span>&gt; {
    <span class="hljs-keyword">const</span> recordsToSkip = pageSize * pagesToSkip
    <span class="hljs-keyword">if</span> (sortColumn) {
      sortColumn =
        sortDirection === <span class="hljs-string">'desc'</span> ? <span class="hljs-string">`-</span><span class="hljs-subst">${sortColumn}</span><span class="hljs-string">`</span> : sortColumn
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-property">httpClient</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title">IUsers</span>&gt;(
      <span class="hljs-string">`</span><span class="hljs-subst">${environment.baseUrl}</span><span class="hljs-string">/v2/users`</span>, { 
        <span class="hljs-attr">params</span>: {
          <span class="hljs-attr">filter</span>: searchText,
          <span class="hljs-attr">skip</span>: recordsToSkip.<span class="hljs-title">toString</span>(),
          <span class="hljs-attr">limit</span>: pageSize.<span class="hljs-title">toString</span>(),
          <span class="hljs-attr">sortKey</span>: sortColumn,
        },
      })
    }
...
</code></pre>
     
    <div class="packt_tip">
      <p class="normal">Note that the <code class="inlineCode">sort</code> direction is indicated by the keywords <code class="inlineCode">asc</code> for ascending and <code class="inlineCode">desc</code> for descending. When sorting a column in ascending order, we pass the column name as a parameter to the server. We prepend the column name with a minus sign to sort a column in descending order.</p>
    </div> </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Set up <code class="inlineCode">UserTable</code> with <a id="_idIndexMarker930"/>pagination, sorting, and<a id="_idIndexMarker931"/> filtering:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/manager/user-table/user-table.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
...
<span class="hljs-meta">@Component</span>({
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-user-table'</span>,
  <span class="hljs-attr">templateUrl</span>: <span class="hljs-string">'./user-table.component.html'</span>,
  <span class="hljs-attr">styleUrls</span>: [<span class="hljs-string">'./user-table.component.css'</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UserTableComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AfterViewInit</span> {
  <span class="hljs-meta">@ViewChild</span>(<span class="hljs-title">MatPaginator</span>) paginator!: <span class="hljs-title">MatPaginator</span>
  <span class="hljs-meta">@ViewChild</span>(<span class="hljs-title">MatSort</span>) sort!: <span class="hljs-title">MatSort</span>
  <span class="hljs-keyword">private</span> skipLoading = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> userService = <span class="hljs-title">inject</span>(<span class="hljs-title">UserService</span>)
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> router = <span class="hljs-title">inject</span>(<span class="hljs-title">Router</span>)
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> activatedRoute = <span class="hljs-title">inject</span>(<span class="hljs-title">ActivatedRoute</span>)
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> destroyRef = <span class="hljs-title">inject</span>(<span class="hljs-title">DestroyRef</span>)
  <span class="hljs-keyword">readonly</span> refresh$ = <span class="hljs-keyword">new</span> <span class="hljs-title">Subject</span>&lt;<span class="hljs-built_in">void</span>&gt;()
  <span class="hljs-keyword">readonly</span> demoViewDetailsColumn = <span class="hljs-title">signal</span>(<span class="hljs-literal">false</span>)
  items$!: <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">Iuser</span>[]&gt;
  displayedColumns = <span class="hljs-title">computed</span>(<span class="hljs-function">() =&gt;</span> [
    <span class="hljs-string">'name'</span>,
    <span class="hljs-string">'email'</span>,
    <span class="hljs-string">'role'</span>,
    ...(<span class="hljs-variable">this</span>.<span class="hljs-title">demoViewDetailsColumn</span>() ? [<span class="hljs-string">'_id'</span>] : []),
  ])
  isLoading = <span class="hljs-literal">true</span>
  resultsLength = <span class="hljs-number">0</span>
  hasError = <span class="hljs-literal">false</span>
  errorText = <span class="hljs-string">''</span>
  selectedRow?: <span class="hljs-title">Iuser</span>
  search = <span class="hljs-keyword">new</span> <span class="hljs-title">FormControl</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">''</span>, <span class="hljs-title">OptionalTextValidation</span>)
  <span class="hljs-title">resetPage</span>(<span class="hljs-params">stayOnPage = </span><span class="hljs-literal">false</span>) {
    <span class="hljs-keyword">if</span> (!stayOnPage) {
      <span class="hljs-variable">this</span>.<span class="hljs-property">paginator</span>.<span class="hljs-title">firstPage</span>()
    }
    <span class="code-highlight"><strong class="hljs-comment-slc">// this.outletCloser.closeOutlet('detail')</strong></span>
    <span class="hljs-variable">this</span>.<span class="hljs-property">router</span>.<span class="hljs-title">navigate</span>([
      <span class="hljs-string">'../users'</span>,
      { <span class="hljs-attr">outlets</span>: { <span class="hljs-attr">detail</span>: <span class="hljs-literal">null</span> } }
    ], {
      <span class="hljs-attr">skipLocationChange</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">relativeTo</span>: <span class="hljs-variable">this</span>.<span class="hljs-property">activatedRoute</span>,
    })
    <span class="hljs-variable">this</span>.<span class="hljs-property">selectedRow</span> = <span class="hljs-literal">undefined</span>
  }
  <span class="hljs-title">showDetail</span>(<span class="hljs-attr">userId</span><span class="hljs-params">: </span><span class="hljs-built_in">string</span>) {
    <span class="hljs-variable">this</span>.<span class="hljs-property">router</span>.<span class="hljs-title">navigate</span>([
      <span class="hljs-string">'../users'</span>,
      { <span class="hljs-attr">outlets</span>: { <span class="hljs-attr">detail</span>: [<span class="hljs-string">'user'</span>, { <span class="hljs-attr">userId</span>: userId }] }
    }],
      {
        <span class="hljs-attr">skipLocationChange</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">relativeTo</span>: <span class="hljs-variable">this</span>.<span class="hljs-property">activatedRoute</span>,
      }
    )
  }  
  <span class="hljs-title">ngAfterViewInit</span>() {
    <span class="hljs-variable">this</span>.<span class="hljs-property">sort</span>.<span class="hljs-property">sortChange</span>
      .<span class="hljs-title">pipe</span>(
        <span class="hljs-title">tap</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable">this</span>.<span class="hljs-title">resetPage</span>()),
        <span class="hljs-title">takeUntilDestroyed</span>(<span class="hljs-variable">this</span>.<span class="hljs-property">destroyRef</span>)
      )
      .<span class="hljs-title">subscribe</span>()
    <span class="hljs-variable">this</span>.<span class="hljs-property">paginator</span>.<span class="hljs-property">page</span>
      .<span class="hljs-title">pipe</span>(
        <span class="hljs-title">tap</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable">this</span>.<span class="hljs-title">resetPage</span>(<span class="hljs-literal">true</span>)),
        <span class="hljs-title">takeUntilDestroyed</span>(<span class="hljs-variable">this</span>.<span class="hljs-property">destroyRef</span>)
      )
      .<span class="hljs-title">subscribe</span>()
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">this</span>.<span class="hljs-property">skipLoading</span>) {
      <span class="hljs-keyword">return</span>
    }     
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">items$</strong><strong class="hljs-slc"> = </strong><strong class="hljs-title-slc">merge</strong><strong class="hljs-slc">(</strong></span>
        <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">refresh$</strong><strong class="hljs-slc">,</strong></span>
        <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">sort</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">sortChange</strong><strong class="hljs-slc">,</strong></span>
        <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">paginator</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">page</strong><strong class="hljs-slc">,</strong></span>
        <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">search</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">valueChanges</strong><strong class="hljs-slc">.</strong><strong class="hljs-title-slc">pipe</strong><strong class="hljs-slc">(</strong></span>
          <span class="code-highlight"><strong class="hljs-title-slc">debounceTime</strong><strong class="hljs-slc">(</strong><strong class="hljs-number-slc">1000</strong><strong class="hljs-slc">),</strong></span>
          <span class="code-highlight"><strong class="hljs-title-slc">tap</strong><strong class="hljs-slc">(</strong><strong class="hljs-function-slc">() =&gt;</strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-title-slc">resetPage</strong><strong class="hljs-slc">())</strong></span>
        <span class="code-highlight"><strong class="hljs-slc">)</strong></span>
      <span class="code-highlight"><strong class="hljs-slc">).</strong><strong class="hljs-title-slc">pipe</strong><strong class="hljs-slc">(</strong></span>
        <span class="code-highlight"><strong class="hljs-title-slc">startWith</strong><strong class="hljs-slc">({}),</strong></span>
        <span class="code-highlight"><strong class="hljs-title-slc">switchMap</strong><strong class="hljs-slc">(</strong><strong class="hljs-function-slc">() =&gt;</strong><strong class="hljs-slc"> {</strong></span>
          <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">isLoading</strong><strong class="hljs-slc"> = </strong><strong class="hljs-literal-slc">true</strong></span>
          <span class="code-highlight"><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">userService</strong><strong class="hljs-slc">.</strong><strong class="hljs-title-slc">getUsers</strong><strong class="hljs-slc">(</strong></span>
            <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">paginator</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">pageSize</strong><strong class="hljs-slc">,</strong></span>
            <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">search</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">value</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">as</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">string</strong><strong class="hljs-slc">,</strong></span>
            <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">paginator</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">pageIndex</strong><strong class="hljs-slc">,</strong></span>
            <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">sort</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">active</strong><strong class="hljs-slc">,</strong></span>
            <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">sort</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">direction</strong></span>
          <span class="code-highlight"><strong class="hljs-slc">)</strong></span>
        <span class="code-highlight"><strong class="hljs-slc">}),</strong></span>
        <span class="code-highlight"><strong class="hljs-title-slc">map</strong><strong class="hljs-slc">(</strong><strong class="hljs-function-slc">(</strong><strong class="hljs-attr-slc">results</strong><strong class="hljs-params-slc">: { total: </strong><strong class="hljs-built_in-slc">number</strong><strong class="hljs-params-slc">; data: IUser[] }</strong><strong class="hljs-function-slc">) =&gt;</strong><strong class="hljs-slc"> {</strong></span>
          <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">isLoading</strong><strong class="hljs-slc"> = </strong><strong class="hljs-literal-slc">false</strong></span>
          <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">hasError</strong><strong class="hljs-slc"> = </strong><strong class="hljs-literal-slc">false</strong></span>
          <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">resultsLength</strong><strong class="hljs-slc"> = results.</strong><strong class="hljs-property-slc">total</strong></span>
          <span class="code-highlight"><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> results.</strong><strong class="hljs-property-slc">data</strong></span>
        <span class="code-highlight"><strong class="hljs-slc">}),</strong></span>
        <span class="code-highlight"><strong class="hljs-title-slc">catchError</strong><strong class="hljs-slc">(</strong><strong class="hljs-function-slc">(</strong><strong class="hljs-params-slc">err</strong><strong class="hljs-function-slc">) =&gt;</strong><strong class="hljs-slc"> {</strong></span>
          <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">isLoading</strong><strong class="hljs-slc"> = </strong><strong class="hljs-literal-slc">false</strong></span>
          <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">hasError</strong><strong class="hljs-slc"> = </strong><strong class="hljs-literal-slc">true</strong></span>
          <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">errorText</strong><strong class="hljs-slc"> = err</strong></span>
          <span class="code-highlight"><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">of</strong><strong class="hljs-slc">([])</strong></span>
        <span class="code-highlight"><strong class="hljs-slc">}),</strong></span>
        <span class="code-highlight"><strong class="hljs-title-slc">takeUntilDestroyed</strong><strong class="hljs-slc">(</strong><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">destroyRef</strong><strong class="hljs-slc">),</strong></span>
      <span class="code-highlight"><strong class="hljs-slc">)</strong></span>
    <span class="code-highlight"><strong class="hljs-slc">})</strong></span>
  }
}
</code></pre>
     
    <p class="normal">We define and initialize various properties to support loading paginated data. <code class="inlineCode">items$</code> stores the observable stream that defines what data is displayed on the data table. <code class="inlineCode">displayedColumns</code>, a computed signal, defines the columns for the table. To dynamically show or hide columns we can defined a toggle using a signal, such as <code class="inlineCode">demoViewDetailsColumn</code>. Since this signal is referenced within the computed signal, when it updates the computed signal will also be updated., which will then be reflected on the table. <code class="inlineCode">paginator</code> and <code class="inlineCode">sort</code> provide pagination and sorting preferences <code class="inlineCode">.search</code> provides the text we need to filter our results by.</p>
    <p class="normal"><code class="inlineCode">resetPage</code> helps rewind the pagination<a id="_idIndexMarker932"/> to the first page and hide<a id="_idIndexMarker933"/> the detail view. This is useful after a search, pagination, or sort event, otherwise the detail view of a random record will be displayed.</p>
    <p class="normal"><code class="inlineCode">showDetail</code> uses the router to display the detail view of a selected record in the named outlet <code class="inlineCode">detail</code>. Later in this section, we will go over a version of the same link implemented in the template. I purposefully included both options, so you can see how both are implemented.</p>
    <div class="packt_tip">
      <p class="normal">I purposefully left the following code commented out in the code base:</p>
      <pre class="programlisting code"><code class="hljs-code">// this.outletCloser.closeOutlet('detail')
</code></pre>
      <p class="normal">I found in certain instances the router may not be able to gracefully close an outlet. <code class="inlineCode">OutletCloserService</code>, found in the <code class="inlineCode">common</code> folder, can close any outlet from any context without fuss.</p>
      <p class="normal">The reference to the original version by Andrew Scott is at <a href="https://stackblitz.com/edit/close-outlet-from-anywhere"><span class="url">https://stackblitz.com/edit/close-outlet-from-anywhere</span></a>.</p>
    </div>
    <p class="normal">The magic happens in <code class="inlineCode">ngAfterViewInit</code>. We first subscribe to <code class="inlineCode">sort</code> and <code class="inlineCode">paginator</code> change events, so we can properly reset the table. Next, we use the <code class="inlineCode">merge</code> method within a <code class="inlineCode">setTimeout</code> call, as highlighted in the preceding snippet, to listen for changes in pagination, sorting, and filter properties that impact what data needs to be displayed. If one property changes, the whole pipeline is triggered.</p>
    <div class="note">
      <p class="normal">Why is the <code class="inlineCode">setTimeout</code> necessary? Since we use references to paginator and sort extracted from the template, we must use the <code class="inlineCode">ngAfterViewInit</code> lifecycle hook. However, at this point, Angular has already set the <code class="inlineCode">dataSource</code> property for the Material data table component. If we re-assign it with the <code class="inlineCode">merge</code> operator, we’ll get NG0100 <code class="inlineCode">ExpressionChangedAfterItHasBeenCheckedError</code>. Using <code class="inlineCode">setTimeout</code> pushes the reassignment into the next change detection cycle, avoiding the error.</p>
    </div>
    <p class="normal">This is similar to how we implemented the login routine in <code class="inlineCode">AuthService</code>. The pipeline contains a call to <code class="inlineCode">this.userService.getUsers</code>, which will retrieve users based on the pagination, sorting, and filter preferences passed in. Results are then piped into the <code class="inlineCode">this.items$</code> Observable, which the data table subscribes to with an <code class="inlineCode">async</code> pipe to display the data.</p>
    <div class="packt_tip">
      <p class="normal">There’s no need to subscribe to <code class="inlineCode">this.items$</code>, because the Material data table already subscribes to it internally. If you subscribe, every call to the server will be made twice.</p>
      <p class="normal">However, you must take care<a id="_idIndexMarker934"/> to place the <code class="inlineCode">takeUntilDestroyed</code> call as the last element<a id="_idIndexMarker935"/> in the pipe. Otherwise, you could leak subscriptions merged after the call.</p>
      <p class="normal">Read more <a id="_idIndexMarker936"/>about it at <a href="https://cartant.medium.com/rxjs-avoiding-takeuntil-leaks-fb5182d047ef"><span class="url">https://cartant.medium.com/rxjs-avoiding-takeuntil-leaks-fb5182d047ef</span></a>.</p>
    </div> </li>
    </ol>







    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Import the following modules:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/manager/user-table/user-table.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-attr">imports</span>: [
  <span class="hljs-title">AsyncPipe</span>,
  <span class="hljs-title">FlexModule</span>,
  <span class="hljs-title">FormsModule</span>,
  <span class="hljs-title">MatButtonModule</span>,
  <span class="hljs-title">MatFormFieldModule</span>,
  <span class="hljs-title">MatIconModule</span>,
  <span class="hljs-title">MatInputModule</span>,
  <span class="hljs-title">MatPaginatorModule</span>,
  <span class="hljs-title">MatProgressSpinnerModule</span>,
  <span class="hljs-title">MatSlideToggleModule</span>,
  <span class="hljs-title">MatSortModule</span>,
  <span class="hljs-title">MatTableModule</span>,
  <span class="hljs-title">MatToolbarModule</span>,
  <span class="hljs-title">ReactiveFormsModule</span>,
  <span class="hljs-title">RouterLink</span>,
],
</code></pre>
      </li>
      <li class="numberedList">Implement<a id="_idIndexMarker937"/> the CSS<a id="_idIndexMarker938"/> for <code class="inlineCode">userTable</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-attribute-slc">src</strong><strong class="hljs-slc">/app/manager/user-</strong><strong class="hljs-selector-tag-slc">table</strong><strong class="hljs-slc">/user-</strong><strong class="hljs-selector-tag-slc">table</strong><strong class="hljs-selector-class-slc">.component.scss</strong></span>
<span class="hljs-selector-class">.loading-shade</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">56px</span>;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.15</span>);
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">justify-content</span>: center;
}
<span class="hljs-selector-class">.filter-row</span> {
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">64px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">24px</span> <span class="hljs-number">0</span>;
}
<span class="hljs-selector-class">.full-width</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
}
<span class="hljs-selector-class">.mat-mdc-paginator</span> {
  <span class="hljs-attribute">background</span>: transparent;
}
<span class="hljs-comment">/* row selection styles */</span>
<span class="hljs-selector-class">.mat-mdc-row</span> <span class="hljs-selector-class">.mat-mdc-cell</span> {
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid transparent;
  <span class="hljs-attribute">border-top</span>: <span class="hljs-number">1px</span> solid transparent;
  <span class="hljs-attribute">cursor</span>: pointer;
}
<span class="hljs-selector-class">.mat-mdc-row</span><span class="hljs-selector-pseudo">:hover</span> <span class="hljs-selector-class">.mat-mdc-cell</span> {
  <span class="hljs-attribute">border-color</span>: currentColor;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#efefef</span>;
}
<span class="hljs-selector-class">.selected</span> {
  <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">500</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#efefef</span>;
}
</code></pre>
      
    <div class="packt_tip">
      <p class="normal">The styles below the comment <code class="inlineCode">/* row selection styles */</code> assist in the material ripple effect when individual rows are clicked.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">Finally, implement<a id="_idIndexMarker939"/> the<a id="_idIndexMarker940"/> <code class="inlineCode">userTable</code> template:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/manager/user-table/user-table.component.html</strong></span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayout</span><span class="hljs-tag">=</span><span class="hljs-string">"row"</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayoutAlign</span><span class="hljs-tag">=</span><span class="hljs-string">"end"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-slide-toggle</span>
<span class="hljs-tag">    [</span><span class="hljs-attr">checked</span><span class="hljs-tag">]=</span><span class="hljs-string">"demoViewDetailsColumn()"</span>
<span class="hljs-tag">    (</span><span class="hljs-attr">change</span><span class="hljs-tag">)=</span><span class="hljs-string">"demoViewDetailsColumn.set($event.checked)"</span><span class="hljs-tag">&gt;</span>
    Demo 'View Details' Column
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-slide-toggle</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"filter-row"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">form</span><span class="hljs-tag"> </span><span class="hljs-attr">style</span><span class="hljs-tag">=</span><span class="hljs-string">"margin-bottom: 32px"</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">fxLayout</span><span class="hljs-tag">=</span><span class="hljs-string">"row"</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"full-width"</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-icon</span><span class="hljs-tag"> </span><span class="hljs-attr">matPrefix</span><span class="hljs-tag">&gt;</span>search<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-icon</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span><span class="hljs-attr">matInput</span><span class="hljs-tag"> </span><span class="hljs-attr">placeholder</span><span class="hljs-tag">=</span><span class="hljs-string">"Search"</span><span class="hljs-tag"> </span>
<span class="hljs-tag">               </span><span class="hljs-attr">aria-label</span><span class="hljs-tag">=</span><span class="hljs-string">"Search"</span><span class="hljs-tag"> [</span><span class="hljs-attr">formControl</span><span class="hljs-tag">]=</span><span class="hljs-string">"search"</span><span class="hljs-tag"> /&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-hint</span><span class="hljs-tag">&gt;</span>Search by e-mail or name<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-hint</span><span class="hljs-tag">&gt;</span>
        @if (search.invalid) {
          <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>
            Type more than one character to search
          <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-error</span><span class="hljs-tag">&gt;</span>
        }
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-form-field</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">form</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"mat-elevation-z8"</span><span class="hljs-tag">&gt;</span>
  <span class="code-highlight"><strong class="hljs-slc">@if (isLoading) {</strong></span>
    <span class="code-highlight"><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"loading-shade"</strong><strong class="hljs-tag-slc">&gt;</strong></span>
      <span class="code-highlight"><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">mat-spinner</strong><strong class="hljs-tag-slc">&gt;&lt;/</strong><strong class="hljs-name-slc">mat-spinner</strong><strong class="hljs-tag-slc">&gt;</strong></span>
    <span class="code-highlight"><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc">&gt;</strong></span>
  <span class="code-highlight"><strong class="hljs-slc">}</strong></span>
  @if (hasError) {
    <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"error"</span><span class="hljs-tag">&gt;</span>
      {{ errorText }}
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
  }
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-table</span>
<span class="hljs-tag">    </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"full-width"</span>
<span class="hljs-tag">    </span><span class="code-highlight"><strong class="hljs-tag-slc">[</strong><strong class="hljs-attr-slc">dataSource</strong><strong class="hljs-tag-slc">]=</strong><strong class="hljs-string-slc">"items$"</strong></span>
<span class="hljs-tag">    </span><span class="hljs-attr">matSort</span>
<span class="hljs-tag">    </span><span class="hljs-attr">matSortActive</span><span class="hljs-tag">=</span><span class="hljs-string">"name"</span>
<span class="hljs-tag">    </span><span class="hljs-attr">matSortDirection</span><span class="hljs-tag">=</span><span class="hljs-string">"asc"</span>
<span class="hljs-tag">    </span><span class="hljs-attr">matSortDisableClear</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">ng-container</span><span class="hljs-tag"> </span><span class="hljs-attr">matColumnDef</span><span class="hljs-tag">=</span><span class="hljs-string">"name"</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-header-cell</span><span class="hljs-tag"> *</span><span class="hljs-attr">matHeaderCellDef</span><span class="hljs-tag"> </span><span class="hljs-attr">mat-sort-header</span><span class="hljs-tag">&gt;</span>
        Name
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-header-cell</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-cell</span><span class="hljs-tag"> *</span><span class="hljs-attr">matCellDef</span><span class="hljs-tag">=</span><span class="hljs-string">"let row"</span><span class="hljs-tag">&gt;</span>
        {{ row.fullName }}
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-cell</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">ng-container</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">ng-container</span><span class="hljs-tag"> </span><span class="hljs-attr">matColumnDef</span><span class="hljs-tag">=</span><span class="hljs-string">"email"</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-header-cell</span><span class="hljs-tag"> *</span><span class="hljs-attr">matHeaderCellDef</span><span class="hljs-tag"> </span><span class="hljs-attr">mat-sort-header</span><span class="hljs-tag">&gt;</span>
        E-mail
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-header-cell</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-cell</span><span class="hljs-tag"> *</span><span class="hljs-attr">matCellDef</span><span class="hljs-tag">=</span><span class="hljs-string">"let row"</span><span class="hljs-tag">&gt;</span>
        {{ row.email }}
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-cell</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">ng-container</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">ng-container</span><span class="hljs-tag"> </span><span class="hljs-attr">matColumnDef</span><span class="hljs-tag">=</span><span class="hljs-string">"role"</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-header-cell</span><span class="hljs-tag"> *</span><span class="hljs-attr">matHeaderCellDef</span><span class="hljs-tag"> </span><span class="hljs-attr">mat-sort-header</span><span class="hljs-tag">&gt;</span>
        Role
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-header-cell</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-cell</span><span class="hljs-tag"> *</span><span class="hljs-attr">matCellDef</span><span class="hljs-tag">=</span><span class="hljs-string">"let row"</span><span class="hljs-tag">&gt;</span>
        {{ row.role }}
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-cell</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">ng-container</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">ng-container</span><span class="hljs-tag"> </span><span class="hljs-attr">matColumnDef</span><span class="hljs-tag">=</span><span class="hljs-string">"_id"</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-header-cell</span><span class="hljs-tag"> *</span><span class="hljs-attr">matHeaderCellDef</span><span class="hljs-tag">&gt;</span>
        View Details
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-header-cell</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-cell</span><span class="hljs-tag"> *</span><span class="hljs-attr">matCellDef</span><span class="hljs-tag">=</span><span class="hljs-string">"let row"</span><span class="hljs-tag"> </span>
<span class="hljs-tag">                </span><span class="hljs-attr">style</span><span class="hljs-tag">=</span><span class="hljs-string">"margin-right: 8px"</span><span class="hljs-tag">&gt;</span>
        <span class="code-highlight"><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">button</strong></span>
          <span class="code-highlight"><strong class="hljs-attr-slc">mat-icon-button</strong></span>
          <span class="code-highlight"><strong class="hljs-tag-slc">[</strong><strong class="hljs-attr-slc">routerLink</strong><strong class="hljs-tag-slc">]=</strong><strong class="hljs-string-slc">"[</strong></span>
            <span class="code-highlight"><strong class="hljs-string-slc">'../users',</strong></span>
            <span class="code-highlight"><strong class="hljs-string-slc">{ </strong></span>
              <span class="code-highlight"><strong class="hljs-string-slc">outlets: { detail: ['user', { userId: row._id }] </strong></span>
            <span class="code-highlight"><strong class="hljs-string-slc">} </strong></span>
          <span class="code-highlight"><strong class="hljs-string-slc">}]"</strong></span>
          <span class="code-highlight"><strong class="hljs-tag-slc">[</strong><strong class="hljs-attr-slc">skipLocationChange</strong><strong class="hljs-tag-slc">]=</strong><strong class="hljs-string-slc">"true"</strong><strong class="hljs-tag-slc">&gt;</strong></span>
          <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-icon</span><span class="hljs-tag">&gt;</span>visibility<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-icon</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;/</span><span class="hljs-name">button</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-cell</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">ng-container</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-header-row</span><span class="hljs-tag"> *</span><span class="hljs-attr">matHeaderRowDef</span><span class="hljs-tag">=</span><span class="hljs-string">"displayedColumns()"</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-header-row</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-row</span>
<span class="hljs-tag">      </span><span class="code-highlight"><strong class="hljs-attr-slc">matRipple</strong></span>
      <span class="code-highlight"><strong class="hljs-tag-slc">(</strong><strong class="hljs-attr-slc">click</strong><strong class="hljs-tag-slc">)=</strong><strong class="hljs-string-slc">"selectedRow = row; </strong></span>
        <span class="code-highlight"><strong class="hljs-string-slc">demoViewDetailsColumn() ? 'noop' : showDetail(row._id)"</strong></span>
<span class="hljs-tag">      [</span><span class="hljs-attr">class.selected</span><span class="hljs-tag">]=</span><span class="hljs-string">"selectedRow === row"</span>
<span class="hljs-tag">      *</span><span class="hljs-attr">matRowDef</span><span class="hljs-tag">=</span><span class="hljs-string">"let row; columns: displayedColumns()"</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-row</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-table</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-toolbar</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-toolbar-row</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">button</span><span class="hljs-tag"> </span><span class="hljs-attr">mat-icon-button</span><span class="hljs-tag"> </span><span class="code-highlight"><strong class="hljs-tag-slc">(</strong><strong class="hljs-attr-slc">click</strong><strong class="hljs-tag-slc">)=</strong><strong class="hljs-string-slc">"refresh$.next()</strong></span><span class="hljs-string">"</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-icon</span><span class="hljs-tag"> </span><span class="hljs-attr">title</span><span class="hljs-tag">=</span><span class="hljs-string">"Refresh"</span><span class="hljs-tag">&gt;</span>refresh<span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-icon</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">button</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">span</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"flex-spacer"</span><span class="hljs-tag">&gt;&lt;/</span><span class="hljs-name">span</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">mat-paginator</span><span class="hljs-tag"> [</span><span class="hljs-attr">pageSizeOptions</span><span class="hljs-tag">]=</span><span class="hljs-string">"[5, 10, 25, 100]"</span><span class="hljs-tag"> </span>
<span class="hljs-tag">                     [</span><span class="hljs-attr">length</span><span class="hljs-tag">]=</span><span class="hljs-string">"resultsLength"</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-paginator</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-toolbar-row</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">mat-toolbar</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span> 
</code></pre>
     
    <div class="note">
      <p class="normal">Note the implementation of the <code class="inlineCode">loading-shade</code> style, which places a spinner over the table while loading data. This is an example of a localized spinner. Later in the <em class="italic">Implementing a global spinner with NgRx/SignalState section</em>, I cover how we can implement a global version. Most very large applications will require a localized spinner to avoid excessive full-screen interruptions caused by a global spinner.</p>
    </div>
    <p class="normal">We bind <code class="inlineCode">items$</code> to <code class="inlineCode">dataSource</code> to activate<a id="_idIndexMarker941"/> the Observable. Below, the <code class="inlineCode">mat-icon-button</code> with <code class="inlineCode">[routerLink]="['../users', { outlets: { detail: ['user', { userId: row._id }] } }]"</code> uses the context<a id="_idIndexMarker942"/> row variable to assign a URL that will display <code class="inlineCode">ViewUserComponent</code> in the <code class="inlineCode">detail</code> outlet. <code class="inlineCode">skipLocationChange</code> ensures that the URL in the browser won’t be updated with the outlet information.</p>
    <div class="note">
      <p class="normal">Note that using the relative URL <code class="inlineCode">'../users'</code> in the <code class="inlineCode">routerLink</code>, as shown above, allows the <code class="inlineCode">UserTableComponent</code> to be decoupled from the context of the manager feature module. This way, the component could be reused under other contexts like <code class="inlineCode">/owner/users</code> or <code class="inlineCode">/ceo/users</code> instead of being hard coded to <code class="inlineCode">/manager/users</code>.</p>
    </div>
    <div class="packt_tip">
      <p class="normal">Setting up the router within lazy-loaded modules and named outlets could be error-prone.</p>
      <p class="normal">You can enable the router’s debug mode by modifying the root provider in <code class="inlineCode">app.config.ts</code> by adding the <code class="inlineCode">withDebugTracing</code> function as shown:</p>
      <pre class="programlisting code"><code class="hljs-code">provideRouter(routes, withDebugTracing()),
</code></pre>
    </div>
    <p class="normal">Further on, the <code class="inlineCode">matRipple</code> directive enables a Material Design ripple when a row is clicked. Right after this, we implement the click handlers. By default, clicking on a row will display the detail view using the <code class="inlineCode">showDetail</code> function; otherwise, users will click on a view button on the rightmost column.</p>
    <p class="normal">Finally, observe the click on the refresh button, which causes an update in the <code class="inlineCode">refresh$</code> Observable. This will be picked up by the merge pipeline we implemented in the component.</p>
    <p class="normal">With just the master view in place, the table<a id="_idIndexMarker943"/> is as shown in the following<a id="_idIndexMarker944"/> screenshot (make sure you’ve updated to the latest version of Angular):</p>
    <figure class="mediaobject"><img src="../Images/B20960_09_04.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 9.4: User table</p>
    <p class="normal">If you click on a row, <code class="inlineCode">ViewUserComponent</code> will get rendered in the detail outlet using the <code class="inlineCode">showDetails</code> function, as shown:</p>
    <figure class="mediaobject"><img src="../Images/B20960_09_05.png" alt="A screenshot of a computer  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 9.5: Master/detail view with row click</p>
    <p class="normal">Note how the row is highlighted<a id="_idIndexMarker945"/> to indicate selection. If you flip<a id="_idIndexMarker946"/> the <strong class="screenText">Demo ‘View Details’ Column</strong> option on the top right, you will unhide the <strong class="screenText">View Details</strong> column.</p>
    <p class="normal">If you click on the <strong class="screenText">View</strong> icon, <code class="inlineCode">ViewUserComponent</code> will get rendered in the detail outlet using <code class="inlineCode">routerLink</code> in the template, as shown:</p>
    <figure class="mediaobject"><img src="../Images/B20960_09_06.png" alt="" role="presentation"/></figure>
    <p class="packt_figref">Figure 9.6: Master/detail view icon click</p>
    <p class="normal">In the previous chapter, we implemented the <strong class="screenText">Edit</strong> button, represented by the pencil icon in the top right, passing the <code class="inlineCode">userId</code> to the <code class="inlineCode">UserProfile</code> to edit and update the data.</p> </li>
    </ol>







    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="8">Click on the <strong class="screenText">Edit</strong> button to be taken to the <code class="inlineCode">ProfileComponent</code>, edit the user record, and verify that you can update another user’s record.</li>
      <li class="numberedList">Confirm that you can view the updated user record in the data table.</li>
    </ol>
    <p class="normal">This demonstration of data tables<a id="_idIndexMarker947"/> with pagination completes the major functionality <a id="_idIndexMarker948"/>of LemonMart for this book. Before moving on, make sure all the tests have passed.</p>
    <div class="packt_tip">
      <p class="normal">For the unit tests, I import concrete implementations of <code class="inlineCode">NameInputComponent</code> or <code class="inlineCode">ViewUserComponent</code> instead of using the <code class="inlineCode">createComponentMock</code> function from <code class="inlineCode">angular-unit-test-helper</code>. This is because <code class="inlineCode">createComponentMock</code> is not sophisticated enough to bind data to child components. In the <em class="italic">Further reading</em> section, I’ve included a blog post by Aiko Klostermann that covers testing Angular components with <code class="inlineCode">@Input()</code> properties.</p>
    </div>
    <p class="normal">With the heavy lifting<a id="_idIndexMarker949"/> of the implementation<a id="_idIndexMarker950"/> completed, we can now explore alternative architectures, tools, and libraries to better understand the best ways to architect Angular apps for various needs. Next, let’s explore NgRx.</p>
    <h1 id="_idParaDest-275" class="heading-1">NgRx store and effects</h1>
    <p class="normal">As covered in <em class="chapterRef">Chapter 1</em>, <em class="italic">Angular’s Architecture and Concepts</em>, the NgRx library brings reactive<a id="_idIndexMarker951"/> state management to Angular based on RxJS. State management with NgRx allows developers to write atomic, self-contained, and composable pieces of code, creating actions, reducers, and selectors. This kind of reactive programming isolates side effects in state<a id="_idIndexMarker952"/> changes. NgRx is an abstraction<a id="_idIndexMarker953"/> layer over RxJS to fit the <strong class="keyWord">Flux pattern</strong>.</p>
    <p class="normal">There are four major elements of NgRx:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Store</strong>: The central location where state <a id="_idIndexMarker954"/>information is persisted. You implement a reducer to store a state transition in the store and a selector to read data out of the store. These are atomic and composable pieces of code.
    <div class="note">
      <p class="normal">A view (or user interface) displays data from the store by using a selector.</p>
    </div></li>
    </ul>
    <ul>
      <li class="bulletList"><strong class="keyWord">Action</strong>: Unique events that happen<a id="_idIndexMarker955"/> throughout your app.
    <div class="note">
      <p class="normal">Actions are triggered from a view with the purpose of dispatching them to the store.</p>
    </div></li>
    </ul>
    <ul>
      <li class="bulletList"><strong class="keyWord">Dispatcher</strong>: This is a method<a id="_idIndexMarker956"/> to send actions to the store.
    <div class="note">
      <p class="normal">Reducers in the store listen for dispatched actions.</p>
    </div></li>
    </ul>
    <ul>
      <li class="bulletList"><strong class="keyWord">Effect</strong>: This is a combination of an action<a id="_idIndexMarker957"/> and a dispatcher. Effects are usually used for actions that are not triggered from a view.</li>
    </ul>
    <p class="normal">Let’s revisit the following Flux pattern<a id="_idIndexMarker958"/> diagram, which now highlights an <strong class="keyWord">Effect</strong>:</p>
    <figure class="mediaobject"><img src="../Images/B20960_09_07.png" alt="A diagram of a system  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 9.7: Flux pattern diagram</p>
    <p class="normal">Let’s demonstrate how NgRx works by going over a concrete example. To keep it simple, we will leverage the LocalCast Weather app.</p>
    <h2 id="_idParaDest-276" class="heading-2">Implementing NgRx for LocalCast Weather</h2>
    <p class="normal">We will implement NgRx<a id="_idIndexMarker959"/> to execute the search functionality in the LocalCast Weather<a id="_idIndexMarker960"/> app. Consider the following architecture diagram:</p>
    <figure class="mediaobject"><img src="../Images/B20960_09_08.png" alt="A diagram of a weather forecast  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 9.8: LocalCast Weather architecture</p>
    <p class="normal">We will use the NgRx store <a id="_idIndexMarker961"/>and effects libraries to achieve <a id="_idIndexMarker962"/>our implementation. NgRx store actions are reflected in the diagram in light gray with a <code class="inlineCode">WeatherLoaded</code> reducer and the app state. At the top, actions are represented as a stream of various data objects, either dispatching<a id="_idIndexMarker963"/> actions or acting on dispatched actions, enabling us to implement the <strong class="keyWord">Flux pattern</strong> introduced in <em class="chapterRef">Chapter 1</em>, <em class="italic">Angular’s Architecture and Concepts</em>. The NgRx effects library extends the Flux pattern by isolating side effects in its model without littering the store with temporary data.</p>
    <p class="normal">The effects workflow, represented in dark gray in <em class="italic">Figure 9.8</em>, begins with <em class="italic">step 1</em>:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1"><code class="inlineCode">CitySearchComponent</code> dispatches the <code class="inlineCode">search</code> action.</li>
      <li class="numberedList">The <code class="inlineCode">search</code> action appears on the Observable <code class="inlineCode">@ngrx/action</code> stream (or data stream).</li>
      <li class="numberedList"><code class="inlineCode">CurrentWeatherEffects</code> acts on the <code class="inlineCode">search</code> action to perform a search.</li>
      <li class="numberedList"><code class="inlineCode">WeatherService</code> performs the search to retrieve<a id="_idIndexMarker964"/> current weather information from the <strong class="keyWord">OpenWeather API</strong>.</li>
    </ol>
    <p class="normal">Store actions, represented in light gray, begin with <em class="italic">step A</em> (uppercase A):</p>
    <ol class="alphabeticList" style="list-style-type: lower-alpha;">
      <li class="alphabeticList" value="1"><code class="inlineCode">CurrentWeatherEffects</code> dispatches the <code class="inlineCode">weatherLoaded</code> action.</li>
      <li class="alphabeticList">The <code class="inlineCode">weatherLoaded</code> action appears on the Observable data stream, labeled <code class="inlineCode">@ngrx/action</code> stream.</li>
      <li class="alphabeticList">The <code class="inlineCode">weatherLoaded</code> reducer acts on the <code class="inlineCode">weatherLoaded</code> action.</li>
      <li class="alphabeticList">The <code class="inlineCode">weatherLoaded</code> reducer transforms the weather information to be stored as the new state.</li>
      <li class="alphabeticList">The new state is a persisted <code class="inlineCode">search</code> state, part of the <code class="inlineCode">appStore</code> state.</li>
    </ol>
    <div class="packt_tip">
      <p class="normal">Note that there’s a parent-level <code class="inlineCode">appStore</code> state containing a child <code class="inlineCode">search</code> state. I intentionally retained this setup to demonstrate how the parent-level state scales as you add different kinds of data elements to the store.</p>
    </div>
    <p class="normal">Finally, a view (an Angular component) reads from the store, beginning with <em class="italic">step a</em> (lowercase a):</p>
    <ol class="alphabeticList" style="list-style-type: lower-alpha;">
      <li class="alphabeticList" value="1">The <code class="inlineCode">CurrentWeather</code> component subscribes to the <code class="inlineCode">selectCurrentWeather</code> selector using the <code class="inlineCode">async</code> pipe.</li>
      <li class="alphabeticList">The <code class="inlineCode">selectCurrentWeather</code> selector listens for changes to the <code class="inlineCode">store.search.current</code> property in the <code class="inlineCode">appStore</code> state.</li>
      <li class="alphabeticList">The <code class="inlineCode">appStore</code> state retrieves the persisted data.</li>
    </ol>
    <div class="note">
      <p class="normal"> Using an NgRx selector is like writing a query to read data stored in a database. The database, in this case, is the store.</p>
    </div>
    <p class="normal">Using NgRx, when a user <a id="_idIndexMarker965"/>searches for a city, the actions<a id="_idIndexMarker966"/> to retrieve, persist, and display that information on <code class="inlineCode">CurrentWeatherComponent</code> happen automatically via individual composable and immutable elements.</p>
    <h2 id="_idParaDest-277" class="heading-2">Comparing BehaviorSubject and NgRx</h2>
    <p class="normal">We will implement NgRx<a id="_idIndexMarker967"/> alongside <code class="inlineCode">BehaviorSubject</code> so you can<a id="_idIndexMarker968"/> see the differences in implementing the same feature. To do this, we will need a slide toggle to switch between the two strategies:</p>
    <div class="note">
      <p class="normal">This section uses the <strong class="keyWord">local-weather-app</strong> repo. You can find<a id="_idIndexMarker969"/> the code samples for this chapter under the <code class="inlineCode">projects/stage12</code> folder.</p>
      <p class="normal">Note that the main app under the <code class="inlineCode">src</code> folder uses a button toggle to switch between <code class="inlineCode">Signals</code>, <code class="inlineCode">BehaviorSubject</code>, and <code class="inlineCode">NgRx</code>.</p>
    </div>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Start by implementing a <code class="inlineCode">&lt;mat-slide-toggle&gt;</code> element on <code class="inlineCode">CitySearchComponent</code>, as shown in the following screenshot:
    <figure class="mediaobject"><img src="../Images/B20960_09_09.png" alt="A screenshot of a weather forecast  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 9.9: LocalCast Weather slide toggle</p>
    <p class="normal">Ensure the field is backed by a property on your component named <code class="inlineCode">useNgRx</code>.</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">Refactor the <code class="inlineCode">doSearch</code> method to extract the <code class="inlineCode">BehaviorSubject</code> code into its own function named <code class="inlineCode">behaviorSubjectBasedSearch</code>.</li>
      <li class="numberedList">Stub out a function called <code class="inlineCode">ngRxBasedSearch</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/city-search/city-search.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-title">doSearch</span>(<span class="hljs-attr">searchValue</span><span class="hljs-params">: </span><span class="hljs-built_in">string</span>) {
  <span class="hljs-keyword">const</span> userInput = searchValue.<span class="hljs-title">split</span>(<span class="hljs-string">','</span>).<span class="hljs-title">map</span>(<span class="hljs-function">(</span><span class="hljs-params">s</span><span class="hljs-function">) =&gt;</span> s.<span class="hljs-title">trim</span>())
  <span class="hljs-keyword">const</span> searchText = userInput[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">const</span> country = userInput.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span> ? userInput[<span class="hljs-number">1</span>] : <span class="hljs-literal">undefined</span>
  <span class="code-highlight"><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (</strong><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">useNgRx</strong><strong class="hljs-slc">) {</strong></span>
    <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-title-slc">ngRxBasedSearch</strong><strong class="hljs-slc">(searchText, country)</strong></span>
  <span class="code-highlight"><strong class="hljs-slc">} </strong><strong class="hljs-keyword-slc">else</strong><strong class="hljs-slc"> {</strong></span>
    <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-title-slc">behaviorSubjectBasedSearch</strong><strong class="hljs-slc">(searchText, country)</strong></span>
  <span class="code-highlight"><strong class="hljs-slc">}</strong></span>
}
</code></pre>
      </li>
    </ol>
    <p class="normal">We will be dispatching<a id="_idIndexMarker970"/> an action from the <code class="inlineCode">ngRxBasedSearch</code> function<a id="_idIndexMarker971"/> that you just created.</p>
    <h2 id="_idParaDest-278" class="heading-2">Setting up NgRx</h2>
    <p class="normal">You can add the NgRx Store<a id="_idIndexMarker972"/> package with the following command:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npx ng add @ngrx/store
</code></pre>
    <p class="normal">This will create a <code class="inlineCode">reducers</code> folder with an <code class="inlineCode">index.ts</code> file in it. Now add the NgRx <code class="inlineCode">effects</code> package:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npx ng add @ngrx/effects --minimal
</code></pre>
    <div class="packt_tip">
      <p class="normal">We use the <code class="inlineCode">--minimal</code> option here to avoid creating unnecessary boilerplate.</p>
    </div>
    <p class="normal">Next, install the NgRx schematics library so you can take advantage of generators to create the boilerplate code for you:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npm i -D @ngrx/schematics
</code></pre>
    <p class="normal">Implementing NgRx can be confusing due to its highly decoupled nature, which may necessitate some insight into the library’s inner workings.</p>
    <div class="packt_tip">
      <p class="normal">The sample project under <code class="inlineCode">projects/stage12</code> configures <code class="inlineCode">@ngrx/store-devtools</code> for debugging.</p>
    </div>
    <p class="normal">If you would like to be able to <code class="inlineCode">console.log</code> NgRx actions for debugging or instrumentation<a id="_idIndexMarker973"/> during runtime, you can use a MetaReducer<a id="_idIndexMarker974"/> as described in the NgRx documentation, <a href="https://ngrx.io/guide/store/metareducers"><span class="url">https://ngrx.io/guide/store/metareducers</span></a>.</p>
    <h2 id="_idParaDest-279" class="heading-2">Defining NgRx actions</h2>
    <p class="normal">Before we can implement effects<a id="_idIndexMarker975"/> or reducers, we first need to define the actions our app will be able to execute. For LocalCast Weather, there are two types of actions:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">search</code>: Fetches the current weather for the city or zip code that’s being searched</li>
      <li class="bulletList"><code class="inlineCode">weatherLoaded</code>: Indicates that new current weather information has been fetched</li>
    </ul>
    <p class="normal">Create an action named <code class="inlineCode">search</code> by running the following command:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npx ng generate @ngrx/schematics:action search --group --creators
</code></pre>
    <div class="packt_tip">
      <p class="normal">Take the default options when prompted.</p>
    </div>
    <div class="note">
      <p class="normal">The <code class="inlineCode">--group</code> option groups actions under a folder named <code class="inlineCode">action</code>. The <code class="inlineCode">--creators</code> option uses creator functions to implement actions and reducers, which is a more familiar and straightforward way to implement these components.</p>
    </div>
    <p class="normal">Now, let’s implement the two actions using the <code class="inlineCode">createAction</code> function, providing a name and an expected list of input parameters:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/action/search.</strong><strong class="hljs-property-slc">actions</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { createAction, props, union } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ngrx/store'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">ICurrentWeather</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../interfaces'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title">SearchActions</span> = {
  <span class="hljs-attr">search</span>: <span class="hljs-title">createAction</span>(
    <span class="hljs-string">'[Search] Search'</span>,
    props&lt;{ <span class="hljs-attr">searchText</span>: <span class="hljs-built_in">string</span>; country?: <span class="hljs-built_in">string</span> }&gt;()
  ),
  <span class="hljs-attr">weatherLoaded</span>: <span class="hljs-title">createAction</span>( 
    <span class="hljs-string">'[Search] CurrentWeather loaded'</span>,
    props&lt;{ <span class="hljs-attr">current</span>: <span class="hljs-title">ICurrentWeather</span> }&gt;()
  ),
}
<span class="hljs-keyword">const</span> all = <span class="hljs-title">union</span>(<span class="hljs-title">SearchActions</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title">SearchActions</span> = <span class="hljs-keyword">typeof</span> all
</code></pre>
    <p class="normal">The search action has the name <code class="inlineCode">'[Search] Search'</code> and has <code class="inlineCode">searchText</code> and an optional <code class="inlineCode">country</code> parameter as inputs. The <code class="inlineCode">weatherLoaded</code> action follows a similar pattern. At the end of the file, we create a union type of actions, so we can group them under one parent type to use in the rest of the application.</p>
    <p class="normal">Notice that action names are prepended by <code class="inlineCode">[Search]</code>. This convention helps developers visually group related actions together during debugging.</p>
    <div class="packt_tip">
      <p class="normal">Now that our actions are deﬁned, we can implement the effect to handle the search action and dispatch a <code class="inlineCode">weatherLoaded</code> action.</p>
    </div>
    <h2 id="_idParaDest-280" class="heading-2">Implementing NgRx effects</h2>
    <p class="normal">As mentioned earlier, effects let us change<a id="_idIndexMarker976"/> the stored state without necessarily storing the event data causing the change. For example, we want our state only to have weather data, not the search text itself. Effects allow us to do this in one step, rather than forcing us to use an intermediate store for the <code class="inlineCode">searchText</code> and a far more complicated chain of events to turn that into weather data.</p>
    <p class="normal">Otherwise, we would have to implement a reducer in between. We first need to store this value in the NgRx store, then retrieve it from a service, and finally dispatch a <code class="inlineCode">weatherLoaded</code> action. The effect will make it simpler to retrieve data from the service.</p>
    <p class="normal">Now let’s add <code class="inlineCode">CurrentWeatherEffects</code> to our app:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npx ng generate @ngrx/schematics:effect currentWeather --module=app.module.ts --root --group --creators
</code></pre>
    <div class="packt_tip">
      <p class="normal">Take the default options when prompted.</p>
    </div>
    <p class="normal">You will have a new <code class="inlineCode">current-weather.effects.ts</code> file under the <code class="inlineCode">effects</code> folder.</p>
    <div class="packt_tip">
      <p class="normal">Once again, <code class="inlineCode">--group</code> is used to group effects under a folder of the same name. <code class="inlineCode">--root</code> registers the effect in <code class="inlineCode">app.module.ts</code> and we use creator functions with the <code class="inlineCode">--creators</code> option.</p>
    </div>
    <p class="normal">In the <code class="inlineCode">CurrentWeatherEffects</code> ﬁle, start by implementing<a id="_idIndexMarker977"/> a private <code class="inlineCode">doSearch</code> method:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/effects/current-weather.</strong><strong class="hljs-property-slc">effects</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">private</span> <span class="hljs-title">doSearch</span>(<span class="hljs-attr">action</span><span class="hljs-params">: { searchText: </span><span class="hljs-built_in">string</span><span class="hljs-params">; country?: </span><span class="hljs-built_in">string</span><span class="hljs-params"> }</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-property">weatherService</span>.<span class="hljs-title">getCurrentWeather</span>(
    action.<span class="hljs-property">searchText</span>,
    action.<span class="hljs-property">country</span>
  ).<span class="hljs-title">pipe</span>(
    <span class="hljs-title">map</span>(<span class="hljs-function">(</span><span class="hljs-params">weather</span><span class="hljs-function">) =&gt;</span>
      <span class="hljs-title">SearchActions</span>.<span class="hljs-title">weatherLoaded</span>({ <span class="hljs-attr">current</span>: weather })
    ),
    <span class="hljs-title">catchError</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable">EMPTY</span>)
  )
}
</code></pre>
    <div class="packt_tip">
      <p class="normal">Note that we’re choosing to ignore errors thrown with the <code class="inlineCode">EMPTY</code> function. You can surface these errors to the user with a <code class="inlineCode">UiService</code> like the one you’ve implemented for LemonMart.</p>
    </div>
    <p class="normal">This function takes an action with search parameters, calls <code class="inlineCode">getCurrentWeather</code>, and upon receiving a response, dispatches the <code class="inlineCode">weatherLoaded</code> action, passing in the current weather property.</p>
    <p class="normal">Now let’s create the effect itself, so we can trigger the <code class="inlineCode">doSearch</code> function:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/effects/current-weather.</strong><strong class="hljs-property-slc">effects</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
getCurrentWeather$ = <span class="hljs-title">createEffect</span>(<span class="hljs-function">() =&gt;</span>
  <span class="hljs-variable">this</span>.<span class="hljs-property">actions$</span>.<span class="hljs-title">pipe</span>(
    <span class="hljs-title">ofType</span>(<span class="hljs-title">SearchActions</span>.<span class="hljs-property">search</span>), 
    <span class="hljs-title">exhaustMap</span>(<span class="hljs-function">(</span><span class="hljs-params">action</span><span class="hljs-function">) =&gt;</span> <span class="hljs-variable">this</span>.<span class="hljs-title">doSearch</span>(action))
  )
)
</code></pre>
    <p class="normal">This is where we tap into the Observable action stream, <code class="inlineCode">this.actions$</code>, and listen to actions of the <code class="inlineCode">SearchAction.search</code> type. We then use the <code class="inlineCode">exhaustMap</code> operator to register for the emitted event. </p>
    <p class="normal">Due to its unique nature, <code class="inlineCode">exhaustMap</code> won’t allow another search action to be processed<a id="_idIndexMarker978"/> until the <code class="inlineCode">doSearch</code> function completes dispatching its <code class="inlineCode">weatherLoaded</code> action.</p>
    <h2 id="_idParaDest-281" class="heading-2">Impact of RxJS operators on actions</h2>
    <p class="normal">In the preceding example, I used the <code class="inlineCode">exhaustMap</code> operator. This is not necessarily the correct RxJS operator for this use case, <code class="inlineCode">switchMap</code> is. I selected <code class="inlineCode">exhaustMap</code> with the express purpose of limiting the number of API calls generated toward a free resource, which can aggressively rate limit requests.</p>
    <p class="normal">Let’s explore four RxJS operators<a id="_idIndexMarker979"/> we can choose from:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1"><code class="inlineCode">mergeMap</code>: Allows for handling multiple actions in parallel, ideal for scenarios where each action’s effect is independent and doesn’t need to be synchronized.</li>
      <li class="numberedList"><code class="inlineCode">concatMap</code>: Processes actions in sequence, starting the next one only after the previous action is complete, ensuring actions are handled in the order they were dispatched, which is useful for maintaining consistency in state updates.</li>
      <li class="numberedList"><code class="inlineCode">switchMap</code>: On receiving a new action, it cancels the previous one and switches to the new one, which is suitable for use cases like search bar inputs where only the latest action (e.g., user input) is relevant.</li>
      <li class="numberedList"><code class="inlineCode">exhaustMap</code>: Ignores new actions if one is already being processed, making it useful for avoiding duplicate or conflicting requests, such as multiple submissions of the same form.</li>
    </ol>
    <p class="normal">With <code class="inlineCode">exhaustMap</code>, if actions are created rapidly before the <code class="inlineCode">doSearch</code> function completes, the actions that haven’t been processed will be dropped. So, if actions <em class="italic">a</em>, <em class="italic">b</em>, <em class="italic">c</em>, <em class="italic">d</em>, and <em class="italic">e</em> are created, but <code class="inlineCode">doSearch</code> completes between when <em class="italic">c</em> and <em class="italic">d</em> were created, then actions <em class="italic">b</em>, <em class="italic">c</em>, and <em class="italic">e</em> are never processed, but action <em class="italic">d</em> will be. API calls for <em class="italic">b</em>, <em class="italic">c</em>, and <em class="italic">e</em> are never made. Only a <code class="inlineCode">weatherLoaded</code> action for <em class="italic">d</em> is dispatched. While we avoid making unnecessary API calls for results users will never see, the end state will confuse the user.</p>
    <p class="normal">Using <code class="inlineCode">mergeMap</code>, all search actions are processed in parallel, API calls made, and <code class="inlineCode">weatherLoaded</code> actions dispatched. So, if actions <em class="italic">a</em>, <em class="italic">b</em>, <em class="italic">c</em>, <em class="italic">d</em>, and <em class="italic">e</em> are created rapidly. The user may see flashes of results from all actions, but the last one displayed will be <em class="italic">e</em>.</p>
    <p class="normal">With <code class="inlineCode">concatMap</code>, actions are processed sequentially. Considering actions <em class="italic">a</em>, <em class="italic">b</em>, <em class="italic">c</em>, <em class="italic">d</em>, and <em class="italic">e</em>, the API call for <em class="italic">b</em> isn’t made until after the <code class="inlineCode">weatherLoaded</code> action is dispatched for <em class="italic">a</em> and the result is rendered. This will happen for each action until the weather for <em class="italic">e</em> is displayed.</p>
    <p class="normal">With <code class="inlineCode">switchMap</code>, API calls will be made with each action. However, only the last action will be dispatched, so the user will only see the last action displayed.</p>
    <p class="normal">So, from a UX perspective, <code class="inlineCode">switchMap</code> is functionally the correct implementation. You could also implement a loading spinner or disable user input while data is processed to prevent expensive API calls.</p>
    <p class="normal">Ultimately, depending on your use case<a id="_idIndexMarker980"/> and UX needs, consider a different RxJS operator. Not all dispatched actions result in a screen that needs to be rendered. If you wanted to retain all data input, you could process actions in a service worker background thread and update a notification panel or a badge with a counter in your app.</p>
    <h2 id="_idParaDest-282" class="heading-2">Implementing reducers</h2>
    <p class="normal">With the <code class="inlineCode">weatherLoaded</code> action<a id="_idIndexMarker981"/> triggered, we need a way to ingest the current weather information and store it in our <code class="inlineCode">appStore</code> state. Reducers will help us handle specific actions, creating an isolated and immutable pipeline to store our data predictably.</p>
    <p class="normal">Let’s create a <code class="inlineCode">search</code> reducer:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npx ng generate @ngrx/schematics:reducer search 
    --reducers=reducers/index.ts --group --creators
</code></pre>
    <div class="packt_tip">
      <p class="normal">Take the default options. Here, we use <code class="inlineCode">--group</code> to keep files organized under the <code class="inlineCode">reducers</code> folder and <code class="inlineCode">--creators</code> to leverage the creator style of creating NgRx code. We also specify the location of our parent <code class="inlineCode">appStore</code> state at <code class="inlineCode">reducers/index.ts</code> with <code class="inlineCode">--reducers</code>, so our new reducer can be registered with it.</p>
    </div>
    <p class="normal">You may observe that <code class="inlineCode">reducers.index.ts</code> has been updated to register the new <code class="inlineCode">search.reducer.ts</code>. Let’s implement it step by step.</p>
    <p class="normal">In the <code class="inlineCode">search</code> state, we will be storing the current weather, so implement the interface to reﬂect this:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/reducers/search.</strong><strong class="hljs-property-slc">reducer</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">State</span> {
  <span class="hljs-attr">current</span>: <span class="hljs-title">ICurrentWeather</span>
}
</code></pre>
    <p class="normal">Now let’s specify the <code class="inlineCode">initialState</code>. This is similar to how we need to define a default value of a <code class="inlineCode">signal</code> or <code class="inlineCode">BehaviorSubject</code>. Refactor the <code class="inlineCode">WeatherService</code> to export a <code class="inlineCode">const defaultWeather: ICurrentWeather</code> object that you can use to initialize <code class="inlineCode">BehaviorSubject</code> and <code class="inlineCode">initialState</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/reducers/search.</strong><strong class="hljs-property-slc">reducer</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">initialState</span>: 
  <span class="hljs-title">State</span> = { 
      <span class="hljs-attr">current</span>: defaultWeather,
  }
</code></pre>
    <p class="normal">Finally, implement <code class="inlineCode">searchReducer</code> to handle the <code class="inlineCode">weatherLoaded</code> action using the <code class="inlineCode">on</code> operator:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/reducers/search.</strong><strong class="hljs-property-slc">reducer</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">const</span> searchReducer = <span class="hljs-title">createReducer</span>(
  initialState,
  <span class="hljs-title">on</span>(<span class="hljs-title">SearchActions</span>.<span class="hljs-property">weatherLoaded</span>, <span class="hljs-function">(</span><span class="hljs-params">state, action</span><span class="hljs-function">) =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      ...state,
      <span class="hljs-attr">current</span>: action.<span class="hljs-property">current</span>,
    }
  })
)
</code></pre>
    <p class="normal">We register for the <code class="inlineCode">weatherLoaded</code> action, unwrap the stored data, and pass it into the <code class="inlineCode">search</code> state.</p>
    <p class="normal">This is, of course, a very simplistic case. However, it is easy to imagine a more complicated scenario where we may need to flatten or process a piece of data received and store it in an easy-to-consume<a id="_idIndexMarker982"/> manner. Isolating such logic in an immutable way is the key value proposition of utilizing a library like NgRx.</p>
    <h2 id="_idParaDest-283" class="heading-2">Registering with Store using selector</h2>
    <p class="normal">We need <code class="inlineCode">CurrentWeatherComponent</code> to register<a id="_idIndexMarker983"/> with the <code class="inlineCode">appStore</code> state for updated current weather data.</p>
    <p class="normal">Start by dependency injecting the <code class="inlineCode">appStore</code> state and registering the selector to pluck current weather from the <code class="inlineCode">State</code> object:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/current-weather/current-weather.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> * </strong><strong class="hljs-keyword-slc">as</strong><strong class="hljs-slc"> appStore </strong><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'../reducers'</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CurrentWeatherComponent</span> {
  <span class="hljs-attr">current$</span>: <span class="hljs-title">Observable</span>&lt;<span class="hljs-title">ICurrentWeather</span>&gt;
  <span class="hljs-title">constructor</span>(<span class="code-highlight"><strong class="hljs-keyword-slc">private</strong><strong class="hljs-params-slc"> </strong><strong class="hljs-attr-slc">store</strong><strong class="hljs-params-slc">: </strong><strong class="hljs-title-slc">Store</strong><strong class="hljs-params-slc">&lt;appStore.</strong><strong class="hljs-title-slc">State</strong><strong class="hljs-params-slc">&gt;</strong></span>) {
    <span class="hljs-variable">this</span>.<span class="hljs-property">current$</span> =
      <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">store</strong><strong class="hljs-slc">.</strong><strong class="hljs-title-slc">pipe</strong><strong class="hljs-slc">(</strong><strong class="hljs-title-slc">select</strong><strong class="hljs-slc">(</strong><strong class="hljs-function-slc">(</strong><strong class="hljs-attr-slc">state</strong><strong class="hljs-params-slc">: </strong><strong class="hljs-title-slc">State</strong><strong class="hljs-function-slc">) =&gt;</strong><strong class="hljs-slc"> state.</strong><strong class="hljs-property-slc">search</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">current</strong><strong class="hljs-slc">))</strong></span>
  } 
  ...
}
</code></pre>
    <p class="normal">We listen to state change<a id="_idIndexMarker984"/> events that flow through the store. Using the <code class="inlineCode">select</code> function, we can implement an inline select to get the data we need.</p>
    <p class="normal">We can refactor this a bit and make our selector reusable by using a <code class="inlineCode">createSelector</code> to create a <code class="inlineCode">selectCurrentWeather</code> property on <code class="inlineCode">reducers/index.ts</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/reducers/index.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> selectCurrentWeather = <span class="hljs-title">createSelector</span>(
  <span class="hljs-function">(</span><span class="hljs-attr">state</span><span class="hljs-params">: </span><span class="hljs-title">State</span><span class="hljs-function">) =&gt;</span> state.<span class="hljs-property">search</span>.<span class="hljs-property">current</span>,
  <span class="hljs-params">current</span><span class="hljs-function"> =&gt;</span> current
)
</code></pre>
    <div class="packt_tip">
      <p class="normal">As the number of TypeScript interfaces and NgRx selectors increases, you should break them into separate files and organize your code better.</p>
    </div>
    <p class="normal">In addition, since we want to maintain the continued operation of <code class="inlineCode">BehaviorSubject</code>, we can implement a <code class="inlineCode">merge</code> operator in <code class="inlineCode">CurrentWeatherComponent</code> to listen to both <code class="inlineCode">WeatherService</code> updates and <code class="inlineCode">appStore</code> state updates:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/current-weather/current-weather.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> appStore <span class="hljs-keyword">from</span> <span class="hljs-string">'../reducers'</span>
  <span class="hljs-title">constructor</span>(
<span class="hljs-params">    </span><span class="hljs-keyword">private</span><span class="hljs-params"> </span><span class="hljs-attr">weatherService</span><span class="hljs-params">: </span><span class="hljs-title">WeatherService</span><span class="hljs-params">,</span>
<span class="hljs-params">    </span><span class="hljs-keyword">private</span><span class="hljs-params"> </span><span class="hljs-attr">store</span><span class="hljs-params">: </span><span class="hljs-title">Store</span><span class="hljs-params">&lt;appStore.</span><span class="hljs-title">State</span><span class="hljs-params">&gt;</span>
<span class="hljs-params">  </span>) {
    <span class="hljs-variable">this</span>.<span class="hljs-property">current$</span> = <span class="hljs-title">merge</span>(
      <span class="code-highlight"><strong class="hljs-variable-slc">this</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">store</strong><strong class="hljs-slc">.</strong><strong class="hljs-title-slc">pipe</strong><strong class="hljs-slc">(</strong><strong class="hljs-title-slc">select</strong><strong class="hljs-slc">(appStore.</strong><strong class="hljs-property-slc">selectCurrentWeather</strong><strong class="hljs-slc">)),</strong></span>
      <span class="hljs-variable">this</span>.<span class="hljs-property">weatherService</span>.<span class="hljs-property">currentWeather$</span>
    )
  }
</code></pre>
    <p class="normal">Now that we can listen<a id="_idIndexMarker985"/> to store updates, let’s implement the final puzzle piece: dispatching the search action.</p>
    <h2 id="_idParaDest-284" class="heading-2">Dispatching store actions</h2>
    <p class="normal">We need to dispatch the search action<a id="_idIndexMarker986"/> so that our search effect can fetch the current weather data and update the store. Earlier in this chapter, you implemented a stubbed function called <code class="inlineCode">ngRxBasedSearch</code> in the <code class="inlineCode">CitySearchComponent</code>.</p>
    <p class="normal">Let’s implement <code class="inlineCode">ngRxBasedSearch</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/city-search/city-search.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-title">ngRxBasedSearch</span>(<span class="hljs-attr">searchText</span><span class="hljs-params">: </span><span class="hljs-built_in">string</span><span class="hljs-params">, country?: </span><span class="hljs-built_in">string</span>) {
  <span class="hljs-variable">this</span>.<span class="hljs-property">store</span>.<span class="hljs-title">dispatch</span>(<span class="hljs-title">SearchActions</span>.<span class="hljs-title">search</span>({ searchText, country }))
}
</code></pre>
    <div class="packt_tip">
      <p class="normal">Don’t forget to inject the <code class="inlineCode">appState</code> store into the component!</p>
    </div>
    <p class="normal">And that’s it! Now you should be able to run your code and test to see whether it all works.</p>
    <p class="normal">As you can see, NgRx brings a lot of sophisticated techniques to the table to create ways to make data transformations immutable, well deﬁned, and predictable. However, this comes with considerable implementation overhead.</p>
    <p class="normal">Use your best judgment to determine whether you need the Flux pattern in your Angular app. The frontend application code can often be made much simpler by implementing RESTful APIs that return ﬂat data objects, with complicated data manipulations handled server side, reducing, if not eliminating, the need for tools like NgRx.</p>
    <h2 id="_idParaDest-285" class="heading-2">Unit testing reducers and selectors</h2>
    <p class="normal">You can implement<a id="_idIndexMarker987"/> unit tests<a id="_idIndexMarker988"/> for the <code class="inlineCode">weatherLoaded</code> reducer<a id="_idIndexMarker989"/> and the <code class="inlineCode">selectCurrentWeather</code> selector<a id="_idIndexMarker990"/> in <code class="inlineCode">search.reducer.spec.ts</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/reducers/search.</strong><strong class="hljs-property-slc">reducer</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">spec</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">SearchActions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../actions/search.actions'</span>
<span class="hljs-keyword">import</span> { defaultWeather } <span class="hljs-keyword">from</span> <span class="hljs-string">'../weather/weather.service'</span>
<span class="hljs-keyword">import</span> { fakeWeather } <span class="hljs-keyword">from</span> <span class="hljs-string">'</span><span class="hljs-string">../weather/weather.service.fake'</span>
<span class="hljs-keyword">import</span> { selectCurrentWeather } <span class="hljs-keyword">from</span> <span class="hljs-string">'./index'</span>
<span class="hljs-keyword">import</span> { initialState, reducer } <span class="hljs-keyword">from</span> <span class="hljs-string">'./search.reducer'</span>
<span class="hljs-title">describe</span>(<span class="hljs-string">'Search Reducer'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title">describe</span>(<span class="hljs-string">'weatherLoaded'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title">it</span>(<span class="hljs-string">'should return current weather'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> action = <span class="hljs-title">SearchActions</span>.<span class="hljs-title">weatherLoaded</span>({ <span class="hljs-attr">current</span>: fakeWeather })
      <span class="hljs-keyword">const</span> result = <span class="hljs-title">reducer</span>(initialState, action)
      <span class="hljs-title">expect</span>(result).<span class="hljs-title">toEqual</span>({ <span class="hljs-attr">current</span>: fakeWeather })
    })
  })
})
<span class="hljs-title">describe</span>(<span class="hljs-string">'Search Selectors'</span>, <span class="hljs-function">() =&gt;</span> { 
  <span class="hljs-title">it</span>(<span class="hljs-string">'should selectCurrentWeather'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> expectedWeather = defaultWeather
    <span class="hljs-title">expect</span>(<span class="hljs-title">selectCurrentWeather</span>({
      <span class="hljs-attr">search</span>: { <span class="hljs-attr">current</span>: defaultWeather }
    })).<span class="hljs-title">toEqual</span>(
      expectedWeather
    )
  })
})
</code></pre>
    <p class="normal">These unit tests are straightforward and will ensure that no unintentional changes to the data structure can happen within the store.</p>
    <h2 id="_idParaDest-286" class="heading-2">Unit testing components with MockStore</h2>
    <p class="normal">You need to update the tests<a id="_idIndexMarker991"/> for <code class="inlineCode">CurrentWeatherComponent</code> so that we can<a id="_idIndexMarker992"/> inject a mock <code class="inlineCode">Store</code> into the component to test the value of the <code class="inlineCode">current$</code> property.</p>
    <p class="normal">Let’s look at the delta of what needs to be added to the <code class="inlineCode">spec</code> file to configure the mock store:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/current-weather/current-weather.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">spec</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">import</span> { <span class="hljs-title">MockStore</span>, provideMockStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ngrx/store/testing'</span>
<span class="hljs-title">describe</span>(<span class="hljs-string">'</span><span class="hljs-string">CurrentWeatherComponent'</span>, <span class="hljs-function">() =&gt;</span> {
  ...
  <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: <span class="hljs-title">MockStore</span>&lt;{ <span class="hljs-attr">search</span>: { <span class="hljs-attr">current</span>: <span class="hljs-title">ICurrentWeather</span> } }&gt;
  <span class="hljs-keyword">const</span> initialState = { <span class="hljs-attr">search</span>: { <span class="hljs-attr">current</span>: defaultWeather } }
  <span class="hljs-title">beforeEach</span>(<span class="hljs-title">async</span>(<span class="hljs-function">() =&gt;</span> {
    ...
    <span class="hljs-title">TestBed</span>.<span class="hljs-title">configureTestingModule</span>({
      <span class="hljs-attr">imports</span>: [<span class="hljs-title">AppMaterialModule</span>],
      <span class="hljs-attr">providers</span>: [
        ...
        <span class="code-highlight"><strong class="hljs-title-slc">provideMockStore</strong><strong class="hljs-slc">({ initialState }),</strong></span>
      ],
    }).<span class="hljs-title">compileComponents</span>()
    ...
    <span class="code-highlight"><strong class="hljs-slc">store = </strong><strong class="hljs-title-slc">TestBed</strong><strong class="hljs-slc">.</strong><strong class="hljs-title-slc">inject</strong><strong class="hljs-slc">(</strong><strong class="hljs-title-slc">Store</strong><strong class="hljs-slc">) </strong><strong class="hljs-keyword-slc">as</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">any</strong></span>
  }))
...
})
</code></pre>
    <p class="normal">We can now update<a id="_idIndexMarker993"/> the <code class="inlineCode">'should get currentWeather from weatherService'</code> test to see whether <code class="inlineCode">CurrentWeatherComponent</code> works with a mock<a id="_idIndexMarker994"/> store:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/current-weather/current-weather.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">spec</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-title">it</span>(<span class="hljs-string">'should get currentWeather from weatherService'</span>, <span class="hljs-function">(</span><span class="hljs-params">done</span><span class="hljs-function">) =&gt;</span> {
  <span class="hljs-comment">// Arrange</span>
  store.<span class="hljs-title">setState</span>({ <span class="hljs-attr">search</span>: { <span class="hljs-attr">current</span>: fakeWeather } })
  weatherServiceMock.<span class="hljs-property">currentWeather$</span>.<span class="hljs-title">next</span>(fakeWeather)
  <span class="hljs-comment">// Act</span>
  fixture.<span class="hljs-title">detectChanges</span>() <span class="hljs-comment">// triggers ngOnInit()</span>
  <span class="hljs-comment">// Assert</span>
  <span class="hljs-title">expect</span>(component.<span class="hljs-property">current$</span>).<span class="hljs-title">toBeDefined</span>()
  component.<span class="hljs-property">current$</span>.<span class="hljs-title">subscribe</span>(<span class="hljs-params">current</span><span class="hljs-function"> =&gt;</span> { 
    <span class="hljs-title">expect</span>(current.<span class="hljs-property">city</span>).<span class="hljs-title">toEqual</span>(<span class="hljs-string">'Bethesda'</span>)
    <span class="hljs-title">expect</span>(current.<span class="hljs-property">temperature</span>).<span class="hljs-title">toEqual</span>(<span class="hljs-number">280.32</span>)
    <span class="hljs-comment">// Assert on DOM</span>
    <span class="hljs-keyword">const</span> debugEl = fixture.<span class="hljs-property">debugElement</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">titleEl</span>: <span class="hljs-title">HTMLElement</span> =
      debugEl.<span class="hljs-title">query</span>(<span class="hljs-title">By</span>.<span class="hljs-title">css</span>(<span class="hljs-string">'.mat-title'</span>)).<span class="hljs-property">nativeElement</span>
    <span class="hljs-title">expect</span>(titleEl.<span class="hljs-property">textContent</span>).<span class="hljs-title">toContain</span>(<span class="hljs-string">'Bethesda'</span>)
    <span class="hljs-title">done</span>()
  })
})
</code></pre>
    <p class="normal">The mock store allows us to set the store’s current state, which in turn allows the selector to call in the constructor <a id="_idIndexMarker995"/>to fire and grab the provided fake weather<a id="_idIndexMarker996"/> data.</p>
    <div class="packt_tip">
      <p class="normal"><code class="inlineCode">TestBed </code>is not a hard requirement<a id="_idIndexMarker997"/> for writing unit tests<a id="_idIndexMarker998"/> in Angular, a topic covered well at <a href="https://angular.dev/guide/testing"><span class="url">https://angular.dev/guide/testing</span></a>. My colleague and reviewer of the 2<sup class="superscript">nd</sup> edition, Brendon Caulkins, contributed a bedless <code class="inlineCode">spec</code> file for this chapter, named <code class="inlineCode">current-weather.component.nobed.spec.ts</code>. He cites significant performance increases when running the tests, with fewer imports and less maintenance, but a higher level of care and expertise required to implement the tests. If you’re on a large project, consider skipping <code class="inlineCode">TestBed</code>.</p>
      <p class="normal">The sample code on GitHub is under the <code class="inlineCode">projects/stage12</code> folder.</p>
    </div>
    <p class="normal">Go ahead and update the remainder of your tests, and do not move on until they all start passing.</p>
    <h1 id="_idParaDest-287" class="heading-1">NgRx ecosystem</h1>
    <p class="normal">Now that you understand NgRx better beyond just theory, let’s examine the different available options within the ecosystem.</p>
    <p class="normal">Here are some popular options<a id="_idIndexMarker999"/> from the community, including sibling packages from NgRx:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">NgRx/Data</strong>, a gentle introduction to NgRx<a id="_idIndexMarker1000"/> with simplified entity management</li>
      <li class="bulletList"><strong class="keyWord">NgRx/ComponentStore</strong>, a component-scoped version<a id="_idIndexMarker1001"/> of NgRx/Store with less boilerplate</li>
      <li class="bulletList"><strong class="keyWord">NgRx/SignalStore</strong>, the next generation of state<a id="_idIndexMarker1002"/> management in Angular</li>
      <li class="bulletList"><strong class="keyWord">Akita</strong>, a reactive state management<a id="_idIndexMarker1003"/> offering tailor-made for JS applications</li>
      <li class="bulletList"><strong class="keyWord">Elf</strong>, a reactive store<a id="_idIndexMarker1004"/> with magical powers</li>
    </ul>
    <p class="normal">Let’s explore these options.</p>
    <h2 id="_idParaDest-288" class="heading-2">NgRx/Data</h2>
    <p class="normal">If NgRx is a configuration-based<a id="_idIndexMarker1005"/> framework, NgRx Data is a convention-based sibling of NgRx. NgRx Data automates the creation of stores, effects, actions, reducers, dispatches, and selectors. If most<a id="_idIndexMarker1006"/> of your application actions are <strong class="keyWord">CRUD</strong> (<strong class="keyWord">Create</strong>, <strong class="keyWord">Retrieve</strong>, <strong class="keyWord">Update</strong>, and <strong class="keyWord">Delete</strong>) operations, then NgRx Data can achieve the same result as NgRx with much less code needing to be written.</p>
    <div class="packt_tip">
      <p class="normal"><code class="inlineCode">@ngrx/data</code> works in tandem with the <code class="inlineCode">@ngrx/entity</code> library. Together they offer a rich feature set, including transactional data management.</p>
    </div>
    <p class="normal">NgRx Data may be a much better introduction to the Flux pattern for you and your team, allowing an easy ramp-up for the full NgRx framework. Unfortunately, NgRx Data is no longer recommended for new projects.</p>
    <div class="note">
      <p class="normal">As of version 17, NgRx Data is officially in maintenance mode, and it’s not recommended for new projects or adding to existing projects.</p>
      <p class="normal">You can read<a id="_idIndexMarker1007"/> more about it at <a href="https://ngrx.io/guide/data"><span class="url">https://ngrx.io/guide/data</span></a>.</p>
    </div>
    <p class="normal">You can add NgRx Data to your project by executing the following commands:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npx ng add @ngrx/store –minimal
<span class="hljs-con-meta">$</span> npx ng add @ngrx/effects –minimal
<span class="hljs-con-meta">$</span> npx ng add @ngrx/entity
<span class="hljs-con-meta">$</span> npx ng add @ngrx/data
</code></pre>
    <p class="normal">So, should you implement NgRx Data in your next app? It depends, but probably not, given its maintenance mode status. Since the library is an abstraction layer on top of NgRx, you may find yourself lost and restricted if you don’t have a good understanding of the internals of NgRx. However, the library holds much promise for reducing boilerplate code regarding entity data management and CRUD operations.</p>
    <p class="normal">If you’re doing lots of CRUD operations in your app, you may save time, but be careful to limit the scope of your implementation to the areas that need it. As the NgRx documentation highlights, NgRx Data lacks many capabilities of a full-featured entity management system, like deep entity cloning, server-side querying, relationships, key generation, and non-normalized server responses.</p>
    <div class="packt_tip">
      <p class="normal">For a full-featured entity<a id="_idIndexMarker1008"/> management library, consider BreezeJS <a href="https://www.getbreezenow.com/breezejs"><span class="url">https://www.getbreezenow.com/breezejs</span></a>. However, beware that Breeze doesn’t adhere to reactive, immutable, and redux principles as NgRx does.</p>
    </div>
    <p class="normal">Next, let’s investigate ComponentStore<a id="_idIndexMarker1009"/> for a less demanding and more focused application of the Flux pattern.</p>
    <h2 id="_idParaDest-289" class="heading-2">NgRx/ComponentStore</h2>
    <p class="normal">NgRx ComponentStore offers a lightweight, reactive<a id="_idIndexMarker1010"/> state management solution ideal for local state within components or modules. </p>
    <p class="normal">It’s designed to manage local state without needing a global store, maintaining a clean separation of concerns, and making components simple and maintainable. This approach is particularly useful for complex components with many local states and interactions, as it allows for push-based services that manage this state with the component’s lifecycle, supporting reusability and independent instances.</p>
    <div class="packt_tip">
      <p class="normal">You can implement the data source of your paginated data table using <code class="inlineCode">ComponentStore</code>, similar to how this is done with Elf. Check out this excellent two-part blog post by Pierre Bouillon: <a href="https://dev.to/this-is-angular/handling-pagination-with-ngrx-component-stores-1j1p"><span class="url">https://dev.to/this-is-angular/handling-pagination-with-ngrx-component-stores-1j1p</span></a>.</p>
    </div>
    <p class="normal">In contrast, NgRx Store manages a global shared state and is beneficial for larger applications requiring scalability, multiple effects, and DevTools integration. ComponentStore, while less scalable and with many updaters and effects, ensures type safety, performance, and ease of testing, allowing for a more encapsulated and component-specific state management.</p>
    <p class="normal">The choice between <code class="inlineCode">ComponentStore</code> and <code class="inlineCode">Store</code> hinges on the application’s size, component dependencies, state longevity, and business requirements, among other factors.</p>
    <div class="note">
      <p class="normal">Read more about<a id="_idIndexMarker1011"/> ComponentStore at <a href="https://ngrx.io/guide/component-store"><span class="url">https://ngrx.io/guide/component-store</span></a>.</p>
    </div>
    <p class="normal">You can add ComponentStore to your project by executing the following:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npx ng add @ngrx/component-store
</code></pre>
    <p class="normal">In short, <code class="inlineCode">ComponentStore</code><a id="_idIndexMarker1012"/> is an alternative to the “Service with a Subject” approach we’ve covered in the book. However, with Angular’s architecture shifting toward Signals, you may want to skip the <code class="inlineCode">ComponentStore</code> and implement <code class="inlineCode">SignalStore</code> instead.</p>
    <h2 id="_idParaDest-290" class="heading-2">NgRx/Signals</h2>
    <p class="normal">I introduced you to signals<a id="_idIndexMarker1013"/> in the <em class="italic">Using Angular signals</em> section of <em class="chapterRef">Chapter 2</em>, <em class="italic">Forms, Observables, Signals, and Subjects</em>. NgRx/Signals is a self-contained library offering a reactive state management solution alongside a suite of utilities for working with Angular Signals. It’s architected for simplicity, presenting an intuitive API for developers. Its lightweight nature ensures minimal load on applications while maintaining high performance. </p>
    <p class="normal">The library champions declarative programming, fostering clean and concise code. It facilitates the crafting of autonomous components that are easily integrated, promoting scalable and flexible applications. Additionally, it enforces type safety, mitigating errors early in the development cycle.</p>
    <p class="normal">The library includes the following:</p>
    <ul>
      <li class="bulletList">SignalStore is a robust state management system bringing the best of both worlds from NgRx/Store and NgRx/ComponentStore.</li>
      <li class="bulletList">SignalState is a streamlined utility for managing state within Angular components and services overtaking any need for self-managed signal properties in service.</li>
      <li class="bulletList"><code class="inlineCode">rxMethod</code> provides opt-in usage to interact with Observables. Useful for interacting with existing code.</li>
      <li class="bulletList"><code class="inlineCode">withEntities</code> is an entity management plugin offering an efficient approach to facilitate CRUD operations for managing entities.</li>
    </ul>
    <p class="normal">We will investigate SignalState and SignalStore in depth in the upcoming sections.</p>
    <div class="note">
      <p class="normal">Read more about<a id="_idIndexMarker1014"/> NgRx Signals at <a href="https://ngrx.io/guide/signals"><span class="url">https://ngrx.io/guide/signals</span></a>. </p>
    </div>
    <p class="normal">You can add SignalStore <a id="_idIndexMarker1015"/>to your project by executing:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> npx ng add @ngrx/signals
</code></pre>
    <p class="normal">Let’s round up our state management ecosystem tour with some popular non-NgRx options, Akita and Elf.</p>
    <h2 id="_idParaDest-291" class="heading-2">Akita</h2>
    <p class="normal">Akita is a state management <a id="_idIndexMarker1016"/>solution combining Flux, Redux, and RxJS concepts into the Observable Data Store model, favoring immutability and streaming data. It emphasizes simplicity, reduces boilerplate code, and is accessible to developers at all levels due to its moderate learning curve. Akita adopts object-oriented principles, making it intuitive for those familiar with OOP, and enforces a consistent structure to guide and standardize team development practices.</p>
    <p class="normal">Akita is built around RxJS/<code class="inlineCode">BehaviorSubject</code> and provides specialized classes for state management, such as <code class="inlineCode">Store</code>, <code class="inlineCode">Query</code>, and <code class="inlineCode">EntityStore</code>. Like NgRx, Akita exposes state changes as RxJS Observables and utilizes the update method for state mutations, enabling an OOP style for state management.</p>
    <p class="normal">It’s worthwhile to experiment with Akita if you’re looking for a simpler solution with built-in entity management, plugins for state history, server-side pagination, more OOP versus functional, and, overall, less boilerplate code.</p>
    <p class="normal">You can learn more about<a id="_idIndexMarker1017"/> Akita at <a href="https://opensource.salesforce.com/akita/"><span class="url">https://opensource.salesforce.com/akita/</span></a>.</p>
    <h2 id="_idParaDest-292" class="heading-2">Elf</h2>
    <p class="normal">Elf is the most magical option<a id="_idIndexMarker1018"/> of the bunch. It’s a newer state management library for Angular that aims to simplify reactivity and state mutations with a minimalistic API, focusing on ergonomics and ease of use. It uses modern RxJS patterns for state management, enabling fine-grained control over state changes and reactivity. Elf is designed to be lightweight and straightforward, offering a simpler alternative to the more comprehensive NgRx suite.</p>
    <p class="normal">Elf is modular, fully tree-shakable, and provides first-class support for the following:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Request cache</strong> to prevent redundant API calls.</li>
      <li class="bulletList"><strong class="keyWord">Entities</strong> such as NgRx/Data or Akita.</li>
      <li class="bulletList"><strong class="keyWord">State persistence</strong> for offline-first applications.</li>
      <li class="bulletList"><strong class="keyWord">State history</strong> for easy undo/redo functionality.</li>
      <li class="bulletList"><strong class="keyWord">Advanced pagination</strong> to optimize fetching and caching of paginated data</li>
      <li class="bulletList">Elf integrates features and best practices for building reactive web apps with statement management and makes them easy. While features like pagination support can be implemented using NgRx/ComponentStore, the built-in pagination caching support is impressive. In addition, Elf has a plugin to sync state across browser tabs, enabling truly advanced state management.</li>
      <li class="bulletList">Given the number of built-in and high-quality features that ship with Elf, it is a standout solution that may be the right option for your next project. You can learn more<a id="_idIndexMarker1019"/> about Elf at <a href="https://ngneat.github.io/elf/"><span class="url">https://ngneat.github.io/elf/</span></a>.</li>
    </ul>
    <p class="normal">We’ve covered the nuances of the NgRx<a id="_idIndexMarker1020"/> ecosystem. Let’s learn how you can configure proxies with Angular to deal with convention-based state management libraries that expect a certain way to access server-side data.</p>
    <h1 id="_idParaDest-293" class="heading-1">Configuring server proxies with the Angular CLI</h1>
    <p class="normal">Some state management libraries, especially<a id="_idIndexMarker1021"/> convention-based entity stores<a id="_idIndexMarker1022"/> like NgRx Data, make assumptions about accessing server-side data. In the case of NgRx Data, the library wants to access the REST API via the <code class="inlineCode">/api</code> path hosted on the same port as your Angular app. We must leverage the Angular CLI’s proxy feature to accomplish this during development.</p>
    <p class="normal">Normally, HTTP requests are sent to our web server, and our API server should have the same URL. However, during development, we usually host both applications on two different ports of <code class="inlineCode">http://localhost</code>. Certain libraries, including NgRx Data, require that HTTP calls be on the same port. This creates a challenge for creating a frictionless development experience. For this reason, the Angular CLI ships with a proxy feature with which you can direct the <code class="inlineCode">/api</code> path to a different endpoint on your localhost. This way, you can use one port to serve your web app and your API requests:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Create a <code class="inlineCode">proxy.conf.json</code> file under <code class="inlineCode">src</code>, as shown:</li>
    </ol>
    <div class="packt_tip">
      <p class="normal">If you’re working in the <strong class="keyWord">lemon-mart-server</strong> monorepo, this will be <code class="inlineCode">web-app/src</code>.</p>
    </div>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">proxy.conf.json</strong></span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"/api"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:3000"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"secure"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"pathRewrite"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
       <span class="hljs-attr">"^/api"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">Register the proxy with <code class="inlineCode">angular.json</code>:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">angular.json</strong></span>
...
<span class="hljs-attr">"serve"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"builder"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@angular-devkit/build-angular:dev-server"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"browserTarget"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lemon-mart:build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"proxyConfig"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"proxy.conf.json"</span>
  <span class="hljs-punctuation">},</span>
  ...
<span class="hljs-punctuation">}</span>
</code></pre>
      </li>
    </ol>
    <p class="normal">Now the server<a id="_idIndexMarker1023"/> that is started when you run <code class="inlineCode">npm start</code> or <code class="inlineCode">ng serve</code> can rewrite<a id="_idIndexMarker1024"/> the URLs of any call made<a id="_idIndexMarker1025"/> to the <code class="inlineCode">/api</code> route with <code class="inlineCode">http://localhost:3000</code>. This is the port that <strong class="keyWord">lemon-mart-server</strong> runs by default.</p>
    <div class="packt_tip">
      <p class="normal">Use the correct port number and child route if your API is running on a different port.</p>
    </div>
    <h1 id="_idParaDest-294" class="heading-1">Implementing a global spinner with NgRx/SignalState</h1>
    <p class="normal">In the <em class="italic">Multi-step responsive forms</em> section<a id="_idIndexMarker1026"/> of <em class="chapterRef">Chapter 8</em>, <em class="italic">Recipes – Reusability, Forms, and Caching</em>, and the <em class="italic">Data tables with pagination</em> section<a id="_idIndexMarker1027"/> earlier in this chapter, I discussed the differences between localized spinners and global ones. A global spinner is the ultimate 80-20 solution to paper over UX issues stemming from UI elements not being ready for interaction while data loads. However, this will cause excessive full-screen interruptions in large applications with multiple on-screen components or background service workers loading data. In that case, most components will require local spinners instead.</p>
    <p class="normal">With that in mind, let’s go after the 80-20 solution. We can use an <code class="inlineCode">HttpInterceptor</code> to detect when an API call is made within the application. This allows us to show or hide a global spinner. However, if multiple calls are made concurrently, we must keep track of this, otherwise the global spinner may behave erratically. With NgRx/SignalState, we can keep track of the number<a id="_idIndexMarker1028"/> of calls without introducing<a id="_idIndexMarker1029"/> the local state in a service.</p>
    <h2 id="_idParaDest-295" class="heading-2">NgRx/SignalState</h2>
    <p class="normal">SignalState is a lightweight<a id="_idIndexMarker1030"/> utility provided by <code class="inlineCode">@ngrx/signals </code>for managing signal-based state in Angular components and services in a concise and minimalistic manner. It is used to create and operate on small slices of state directly in your component class, service, or a standalone function. You can provide a deeply nested signal of the object properties.</p>
    <p class="normal">SignalState should be used within a component or service to manage simple state. The library offers the following functions:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">signalState</code> is a utility function that takes the initial state of the store and defines the shape of the state.</li>
      <li class="bulletList"><code class="inlineCode">patchState</code> updates the stored value.</li>
    </ul>
    <div class="note">
      <p class="normal">Read more about<a id="_idIndexMarker1031"/> NgRx SignalState at <a href="https://ngrx.io/guide/signals/signal-state"><span class="url">https://ngrx.io/guide/signals/signal-state</span></a>.</p>
    </div>
    <p class="normal">We start by adding <code class="inlineCode">signalState</code>, <code class="inlineCode">computed</code> <code class="inlineCode">signal</code>, <code class="inlineCode">showLoader</code>, and <code class="inlineCode">hideLoader</code> functions to <code class="inlineCode">UiService</code>:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Modify UiService as shown:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/common/ui.</strong><strong class="hljs-property-slc">service</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-meta">@Injectable</span>({ <span class="hljs-attr">providedIn</span>: <span class="hljs-string">'root'</span> })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UiService</span> {
  ...
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> loadState = <span class="code-highlight"><strong class="hljs-title-slc">signalState</strong></span>({ 
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>, 
    <span class="hljs-attr">isLoading</span>: <span class="hljs-literal">false</span> 
  })
  isLoading = <span class="code-highlight"><strong class="hljs-title-slc">computed</strong></span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable">this</span>.<span class="hljs-property">loadState</span>.<span class="hljs-title">isLoading</span>())
  <span class="hljs-title">showLoader</span>() {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">this</span>.<span class="hljs-property">loadState</span>.<span class="hljs-title">count</span>() === <span class="hljs-number">0</span>) {
      <span class="code-highlight"><strong class="hljs-title-slc">patchState</strong></span>(<span class="hljs-variable">this</span>.<span class="hljs-property">loadState</span>, <span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">isLoading</span>: <span class="hljs-literal">true</span> }))
    }
    <span class="code-highlight"><strong class="hljs-title-slc">patchState</strong></span>(<span class="hljs-variable">this</span>.<span class="hljs-property">loadState</span>, <span class="hljs-function">(</span><span class="hljs-params">state</span><span class="hljs-function">) =&gt;</span> ({ 
      <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span>++ 
    }))}
  <span class="hljs-title">hideLoader</span>() {
    <span class="code-highlight"><strong class="hljs-title-slc">patchState</strong></span>(<span class="hljs-variable">this</span>.<span class="hljs-property">loadState</span>, <span class="hljs-function">(</span><span class="hljs-params">state</span><span class="hljs-function">) =&gt;</span> ({ 
      <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span>—
    }))
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">this</span>.<span class="hljs-property">loadState</span>.<span class="hljs-title">count</span>() === <span class="hljs-number">0</span>) {
      <span class="code-highlight"><strong class="hljs-title-slc">patchState</strong></span>(<span class="hljs-variable">this</span>.<span class="hljs-property">loadState</span>, <span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">isLoading</span>: <span class="hljs-literal">false</span> }))
    }
  }  
  ...
}
</code></pre>
      
    <p class="normal">We start by defining a private <code class="inlineCode">signalState</code> and initializing<a id="_idIndexMarker1032"/> the <code class="inlineCode">count</code> and <code class="inlineCode">isLoading</code> properties. The state should always be encapsulated within the boundaries it’s being used to avoid uncontrolled side effects. As we cover in the next section, SignalStore is a more robust solution to manage side effects. However, we want <code class="inlineCode">isLoading</code> to be publicly available, so a UI component can bind it to hide or display the spinner. So, we implement a <code class="inlineCode">computed</code> signal, which acts as a selector to return the current value of <code class="inlineCode">isLoading</code> in a read-only manner.</p>
    <p class="normal"><code class="inlineCode">patchState</code> is a utility function that provides a type-safe way to perform immutable updates on pieces of state. We use it to update the values of <code class="inlineCode">count</code> and <code class="inlineCode">isLoading</code>, whenever <code class="inlineCode">show</code> or <code class="inlineCode">hide</code> functions are called.</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">Next, implement <code class="inlineCode">LoadingHttpInterceptor</code> under <code class="inlineCode">src/common</code> to call the <code class="inlineCode">show</code> and <code class="inlineCode">hide</code> methods:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/common/loading.</strong><strong class="hljs-property-slc">http</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">interceptor</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title">LoadingHttpInterceptor</span>(
<span class="hljs-params">  </span><span class="hljs-attr">req</span><span class="hljs-params">: </span><span class="hljs-title">HttpRequest</span><span class="hljs-params">&lt;</span><span class="hljs-built_in">unknown</span><span class="hljs-params">&gt;, </span><span class="hljs-attr">next</span><span class="hljs-params">: </span><span class="hljs-title">HttpHandlerFn</span>) {
  <span class="hljs-keyword">const</span> uiService = <span class="hljs-title">inject</span>(<span class="hljs-title">UiService</span>)
  uiService.<span class="hljs-title">showLoader</span>()
  <span class="hljs-keyword">return</span> <span class="hljs-title">next</span>(req).<span class="hljs-title">pipe</span>(<span class="hljs-title">finalize</span>(<span class="hljs-function">() =&gt;</span> 
                        uiService.<span class="hljs-title">hideLoader</span>()))
}
</code></pre>
      
    <p class="normal">We inject <code class="inlineCode">UiService</code> and call <code class="inlineCode">showLoader</code> to increment<a id="_idIndexMarker1033"/> the count by one. We then set up the finalize operator, so when the API call is finished <code class="inlineCode">hideLoader</code> is called to decrement the count by one. So, whenever a loader function is called and the count is equal to zero, we know we either need to show or hide the spinner.</p>
    <div class="packt_tip">
      <p class="normal">Don’t forget to provide the new interceptor in <code class="inlineCode">app.config.ts</code>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Now, create a <code class="inlineCode">LoadingOverlayComponent</code> under common and use <code class="inlineCode">isLoading </code>to show or hide a spinner:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/common/loading-overlay.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-meta">@Component</span>({
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-loading-overlay'</span>,
  <span class="hljs-attr">template</span>: <span class="hljs-string">`</span>
<span class="hljs-string">    </span><span class="code-highlight"><strong class="hljs-string-slc">@if (uiService.isLoading()) {</strong></span>
<span class="hljs-string">      &lt;div class="overlay"&gt;</span>
<span class="hljs-string">        &lt;div class="center"&gt;</span>
<span class="hljs-string">          &lt;img alt="loading" class="spinner"</span>
<span class="hljs-string">                    src="assets/img/icons/lemon.svg" /&gt;</span>
<span class="hljs-string">        &lt;/div&gt;</span>
<span class="hljs-string">      &lt;/div&gt;</span>
<span class="hljs-string">    </span><span class="code-highlight"><strong class="hljs-string-slc">}</strong></span>
<span class="hljs-string">  `</span>,
  <span class="hljs-attr">styles</span>: <span class="hljs-string">`</span>
<span class="hljs-string">    .overlay {</span>
<span class="hljs-string">      position: fixed;</span>
<span class="hljs-string">      width: 100%;</span>
<span class="hljs-string">      height: 100%;</span>
<span class="hljs-string">      left: 0;</span>
<span class="hljs-string">      top: 0;</span>
<span class="hljs-string">      background-color: rgba(255, 255, 255, 0.65);</span>
<span class="hljs-string">      z-index: 9999;</span>
<span class="hljs-string">    }</span>
<span class="hljs-string">    .spinner {</span>
<span class="hljs-string">      display: block;</span>
<span class="hljs-string">      width: 48px;</span>
<span class="hljs-string">      height: 48px;</span>
<span class="hljs-string">      animation-name: spin;</span>
<span class="hljs-string">      animation-duration: 1.00s;</span>
<span class="hljs-string">      animation-iteration-count: infinite;</span>
<span class="hljs-string">      animation-timing-function: ease-in-out;</span>
<span class="hljs-string">    }</span>
<span class="hljs-string">    @keyframes spin {</span>
<span class="hljs-string">      0% { transform: rotate(0deg); }</span>
<span class="hljs-string">      100% { transform: rotate(360deg); }</span>
<span class="hljs-string">    }</span>
<span class="hljs-string">    .center {</span>
<span class="hljs-string">        position: absolute;</span>
<span class="hljs-string">        top: 50%;</span>
<span class="hljs-string">        left: 50%;</span>
<span class="hljs-string">        transform: translate(-50%, -50%);</span>
<span class="hljs-string">      }</span>
<span class="hljs-string">  `</span>,
  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,
  <span class="code-highlight"><strong class="hljs-attr-slc">encapsulation</strong><strong class="hljs-slc">: </strong><strong class="hljs-title-slc">ViewEncapsulation</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ShadowDom</strong></span>,
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LoadingOverlayComponent</span> {
  <span class="hljs-keyword">readonly</span> uiService = <span class="hljs-title">inject</span>(<span class="hljs-title">UiService</span>)
}
</code></pre>
     
    <p class="normal">We inject and use<a id="_idIndexMarker1034"/> the computed <code class="inlineCode">isLoading</code> signal from <code class="inlineCode">UiService</code>. With the <code class="inlineCode">@if</code> flow control, the spinner will be shown or hidden depending on whether <code class="inlineCode">isLoading</code> is set to true or false.</p>
    <div class="note">
      <p class="normal">The use of <code class="inlineCode">ViewEncapsulation.ShadowDom</code> in Angular allows component styles to be encapsulated within a Shadow DOM. By default, Angular uses an emulated mode to scope styles to components. However, the Shadow DOM encapsulation provides more robust support for dynamic CSS features.</p>
    </div> </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Finally, update <code class="inlineCode">app.component.ts</code> to import and place the new component at the top of the template:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/app/app.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-attr">template</span>: <span class="hljs-string">`</span>
<span class="hljs-string">    </span><span class="code-highlight"><strong class="hljs-string-slc">&lt;app-loading-overlay&gt;&lt;/app-loading-overlay&gt;</strong></span>
<span class="hljs-string">    &lt;div class="app-container"&gt;</span>
<span class="hljs-string">    ...</span>
</code></pre>
      </li>
      <li class="numberedList">Give it a try. A glorious lemon spinner<a id="_idIndexMarker1035"/> will take over the screen whenever an API call is made.
    <figure class="mediaobject"><img src="../Images/B20960_09_10.png" alt="A screenshot of a lemon login  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 9.10: LemonMart’s lemon spinner</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">This resolves the data pop-in issues in the user profile form mentioned in <em class="chapterRef">Chapter 8</em>, <em class="italic">Recipes – Reusability, Forms, and Caching</em>.<div class="packt_tip">
          <p class="normal">Are your API calls happening too quickly to appreciate the spinner?</p>
          <p class="normal">In <strong class="keyWord">lemon-mart-server</strong>, you can add <a id="_idIndexMarker1036"/>a two-second delay:</p>
          <pre class="programlisting code"><code class="hljs-code"><code style="font-weight: bold;" class="codeHighlighted">server/src/v1/routes/authRouter.ts</code>
router.get('/me', authenticate(), async (_req, res) =&gt; {
  <code style="font-weight: bold;" class="codeHighlighted">await setTimeout(2000)</code>
...
</code></pre>
          <p class="normal">Or you can slow things down in your browser’s DevTools <strong class="keyWord">Network</strong> tab by changing the <strong class="keyWord">No Throttling</strong> dropdown to <strong class="keyWord">Fast 3G</strong> or <strong class="keyWord">Slow 3G</strong>.</p>
        </div>
      </li>
    </ol>
    <h2 id="_idParaDest-296" class="heading-2">Pre-loading screens with HTML and CSS</h2>
    <p class="normal">If you follow the tip<a id="_idIndexMarker1037"/> from the previous section<a id="_idIndexMarker1038"/> and slow down<a id="_idIndexMarker1039"/> the network speed<a id="_idIndexMarker1040"/> of your browser to <strong class="keyWord">Slow 3G</strong> and <strong class="keyWord">Disable caching</strong>, you’ll notice that it takes forever and a half for anything to be shown on screen. In <em class="chapterRef">Chapter 3</em>, <em class="italic">Architecting an Enterprise App</em>, I covered how to implement <strong class="keyWord">Server-side Rendering</strong> (<strong class="keyWord">SSR</strong>) to overcome such issues. However, that<a id="_idIndexMarker1041"/> may not always be an option or may be overkill. Using simple HTML and CSS we can implement an easy solution to present an attractive and dynamic loading screen to entertain bored users staring at your app on a slow network.</p>
    <p class="normal">Let’s start by adding the CSS in LemonMart:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Create <code class="inlineCode">spinner.css</code> under <code class="inlineCode">src/assets/styles</code>. Copy the contents from LemonMart’s GitHub repo at <a href="https://github.com/duluca/lemon-mart/blob/main/src/assets/styles/spinner.css"><span class="url">https://github.com/duluca/lemon-mart/blob/main/src/assets/styles/spinner.css</span></a>.</li>
      <li class="numberedList">Update <code class="inlineCode">index.html</code> to import the stylesheet and place the necessary HTML inside the <code class="inlineCode">&lt;app-root&gt;</code> element:
        <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">src/index.html  </strong></span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">head</span><span class="hljs-tag">&gt;</span>
  ...
  <span class="code-highlight"><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">link</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"assets/styles/spinner.css"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">rel</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"stylesheet"</strong><strong class="hljs-tag-slc"> /&gt;</strong></span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">head</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">body</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"mat-typography mat-app-background"</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">app-root</span><span class="hljs-tag">&gt;</span>
      <span class="code-highlight"><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"spinner-background"</strong><strong class="hljs-tag-slc">&gt;</strong></span>
        <span class="code-highlight"><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"spinner-container"</strong><strong class="hljs-tag-slc">&gt;</strong></span>
          <span class="code-highlight"><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">svg</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"spinner"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">width</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"</strong><strong class="hljs-string-slc">65px"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">height</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"65px"</strong></span>
            <span class="code-highlight"><strong class="hljs-attr-slc">viewBox</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"0 0 66 66"</strong><strong class="hljs-tag-slc">&gt;</strong></span>
            <span class="code-highlight"><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">circle</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"path"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">fill</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"none"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">stroke-width</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"6"</strong></span>
              <span class="code-highlight"><strong class="hljs-attr-slc">stroke-linecap</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"round"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">cx</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"33"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">cy</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"33"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">r</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"30"</strong><strong class="hljs-tag-slc">&gt;</strong></span>
            <span class="code-highlight"><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">circle</strong><strong class="hljs-tag-slc">&gt;</strong></span>
          <span class="code-highlight"><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">svg</strong><strong class="hljs-tag-slc">&gt;</strong></span>
          <span class="code-highlight"><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">h2</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"animate-text"</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">Loading</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">h2</strong><strong class="hljs-tag-slc">&gt;</strong></span>
        <span class="code-highlight"><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc">&gt;</strong></span>
      <span class="code-highlight"><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc">&gt;</strong></span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">app-root</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">body</span><span class="hljs-tag">&gt;</span>
</code></pre>
      
    <p class="normal">When Angular<a id="_idIndexMarker1042"/> launches, the<a id="_idIndexMarker1043"/> contents of <code class="inlineCode">&lt;app-root&gt;</code> will be replaced<a id="_idIndexMarker1044"/> by your <a id="_idIndexMarker1045"/>application.</p>
    <div class="packt_tip">
      <p class="normal">Note that this pre-loading screen is designed to be minimal and should come up instantly on screen. However, you will notice it still can take up to 6 seconds to display. This is because Angular prioritizes the global <code class="inlineCode">styles.scss</code> file for loading first. If you’re using Angular Material, this adds 165 KB of content, which takes almost 6 seconds to load in <strong class="screenText">Slow 3G</strong>. However, this is still much better in the context of a 50-second total loading time.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Restart your Angular app and you should see the pre-loading screen:</li>
    </ol>
    <figure class="mediaobject"><img src="../Images/B20960_09_11.png" alt="A screenshot of a computer  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 9.11: Preloading screen on slow networks</p>
    <p class="normal">Now that you understand how to work with a state slice<a id="_idIndexMarker1046"/> using NgRx/SignalState, let’s dive into<a id="_idIndexMarker1047"/> the excellent NgRx/SignalStore<a id="_idIndexMarker1048"/> library next. In fact, it’s so good<a id="_idIndexMarker1049"/> that it inspired me to rewrite the LocalCast Weather app to be nearly Observable and RxJS operator-free with zero subscribe calls or async pipes.</p>
    <h1 id="_idParaDest-297" class="heading-1">Rewriting Angular apps with NgRx/SignalStore</h1>
    <p class="normal">With Observables, the best subscription<a id="_idIndexMarker1050"/> is the one you don’t have<a id="_idIndexMarker1051"/> to make. Throughout this book, we used the <code class="inlineCode">async pipe</code>, <code class="inlineCode">take(1)</code>, <code class="inlineCode">takeUntilDestroyed</code>, and <code class="inlineCode">unsubscribe</code> in <code class="inlineCode">ngOnDestroy</code> to try and manage them. The sample code for this book has been through many reviews by various practitioners and experts over a period of six years. Every review highlighted some oversight or bug with the RxJS code. </p>
    <p class="normal">The 3<sup class="superscript">rd</sup> edition of the book provides a 99% bug-free implementation. I could never claim 100% due to the insane complexity of the RxJS ecosystem.</p>
    <p class="normal">I take pride in not taking the easy way out. I do my best to provide realistic and complete examples for you, not just counters and to-do lists. However, these are still highly controlled and small-sized projects compared to what happens in real life. You rarely have time to go back and reevaluate your entire project. Mistakes get compounded over time. This is a sad reality of working with RxJS. It’s wonderful for what it does, but 95+ percent of code written doesn’t require the flexibility and reactivity the tool brings. Most code is about retrieving some data from an API once and displaying it. Signals with async/await-driven<a id="_idIndexMarker1052"/> promises make this kind <a id="_idIndexMarker1053"/>of code straightforward to write.</p>
    <h2 id="_idParaDest-298" class="heading-2">RxJS and signal helpers</h2>
    <p class="normal">Several important functions will help you transition away from Observables and RxJS:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">JavaScript promises</strong> are a construct that allows<a id="_idIndexMarker1054"/> for asynchronous operations, providing a way to handle the eventual success value or failure reason.</li>
      <li class="bulletList"><strong class="keyWord">JavaScript async/await</strong> is syntactic sugar in JavaScript<a id="_idIndexMarker1055"/> that allows you to write asynchronous code in a synchronous fashion, built on top of promises.</li>
      <li class="bulletList"><strong class="keyWord">RxJS Interop</strong> <code class="inlineCode">toSignal</code> creates a signal<a id="_idIndexMarker1056"/> that tracks the value of an Observable, like the async pipe in templates but more flexible. Similar to async pipe, <code class="inlineCode">toSignal</code> manages the subscription for us, so there’s no need to use subscribe, <code class="inlineCode">takeUntil</code>, or unsubscribe. There’s also <code class="inlineCode">toObservable</code>, which is a useful bridge during the transition.</li>
      <li class="bulletList"><code class="inlineCode">ChangeDetectionStrategy.OnPush</code> is a strategy that tells Angular to run change detection on a component only when its input properties change, improving performance by reducing the number of checks. You will need to set the <code class="inlineCode">changeDetection</code> property of your components to this until Signal-based components arrive.</li>
      <li class="bulletList"><code class="inlineCode">lastValueFrom</code> is a utility function that converts an Observable to a promise that resolves with the last value emitted by the Observable. This operator also manages the subscription for us. There’s also <code class="inlineCode">firstValueFrom</code>, but you probably won’t need that one. This conversation will be necessary until Angular implements promise-based APIs to modules such as <code class="inlineCode">HttpClient</code>, <code class="inlineCode">Router</code>, <code class="inlineCode">FormControl</code>, etc.<div class="note">
          <p class="normal">RxJS Interop is in developer preview.</p>
          <p class="normal">You can read<a id="_idIndexMarker1057"/> more about it at <a href="https://angular.dev/guide/signals/rxjs-interop"><span class="url">https://angular.dev/guide/signals/rxjs-interop</span></a>.</p>
        </div>
      </li>
    </ul>
    <p class="normal">State management remains key to managing the complexity of large applications. Let’s see how NgRx SignalStore can help with the transition.</p>
    <h2 id="_idParaDest-299" class="heading-2">NgRx/SignalStore</h2>
    <p class="normal">SignalStore is a fully featured state management<a id="_idIndexMarker1058"/> solution built around declarative programming, ensuring clean and concise code. SignalStore is for managing larger stores with complex state as opposed to SignalState, which is designed to contain simple state within a single component or service.</p>
    <div class="note">
      <p class="normal">Read more about NgRx SignalStore<a id="_idIndexMarker1059"/> at <a href="https://ngrx.io/guide/signals/signal-store"><span class="url">https://ngrx.io/guide/signals/signal-store</span></a>.</p>
    </div>
    <p class="normal">SignalStore can provided at the root level or component level. The library offers the following<a id="_idIndexMarker1060"/> functions:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">signalStore</code> is a utility function for managing larger and more complex pieces of state in an application.</li>
      <li class="bulletList"><code class="inlineCode">withState</code> takes the initial state of the store and defines the shape of the state.</li>
      <li class="bulletList"><code class="inlineCode">withComputed</code> derives computed properties from existing pieces of state in the store.</li>
      <li class="bulletList"><code class="inlineCode">withMethods</code> contains custom functions (store methods) that are exposed publicly to operate on the store with a well-defined API. <code class="inlineCode">withMethods</code> can use <code class="inlineCode">patchState</code> and injected services to update the store.</li>
      <li class="bulletList"><code class="inlineCode">withHooks</code> are called when the store is created or destroyed, allowing for fetching data to initialize the store or updating state.</li>
      <li class="bulletList"><code class="inlineCode">withEntities</code> is an extension to facilitate CRUD operations for managing entities. It is like <code class="inlineCode">@ngrx/entity</code> but not the same.<div class="note">
          <p class="normal">Read more about NgRx SignalStore<a id="_idIndexMarker1061"/> entities at <a href="https://ngrx.io/guide/signals/signal-store/entity-management"><span class="url">https://ngrx.io/guide/signals/signal-store/entity-management</span></a>.</p>
          <p class="normal">Also, see advanced use cases<a id="_idIndexMarker1062"/> with custom store features at <a href="https://ngrx.io/guide/signals/signal-store/custom-store-features"><span class="url">https://ngrx.io/guide/signals/signal-store/custom-store-features</span></a>.</p>
        </div>
      </li>
    </ul>
    <p class="normal">Let’s see how we can apply SignalStore<a id="_idIndexMarker1063"/> to LocalCast Weather. The diagram below is a recreation of the one from the <em class="italic">Implementing NgRx for LocalCast Weather </em>section earlier in this chapter.</p>
    <figure class="mediaobject"><img src="../Images/B20960_09_12.png" alt="A diagram of a diagram  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 9.12: LocalCast Weather architecture</p>
    <p class="normal">Upon initial inspection, SignalStore<a id="_idIndexMarker1064"/> appears simpler than the NgRx store implementation. That’s because the inherent reactivity of signals is baked into Angular. You must remember this invisible thread that makes the magic work beneath the surface of this implementation.</p>
    <p class="normal">The workflow, represented in dark gray in <em class="italic">Figure 9.12</em>, begins with <em class="italic">step 1</em>:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1"><code class="inlineCode">CitySearchComponent</code> triggers the <code class="inlineCode">doSearch</code> method, which in turn calls <code class="inlineCode">store.updateWeather</code>.</li>
      <li class="numberedList"><code class="inlineCode">withMethods</code> activates the <code class="inlineCode">updateWeather</code> function, which has an injected reference to <code class="inlineCode">WeatherService</code> and calls <code class="inlineCode">getCurrentWeather</code> from it.</li>
      <li class="numberedList"><code class="inlineCode">updateWeather</code> awaits the result from <code class="inlineCode">getCurrentWeather</code>, which retrieves the current weather<a id="_idIndexMarker1065"/> information from <strong class="keyWord">OpenWeather</strong>, and uses <code class="inlineCode">patchState</code> to update <code class="inlineCode">store.current</code>.</li>
      <li class="numberedList"><code class="inlineCode">CurrentWeatherComponent</code> is bound to <code class="inlineCode">store.current</code>, so when the value updates, the template is automatically updated.</li>
    </ol>
    <p class="normal">Now that we understand how SignalStore<a id="_idIndexMarker1066"/> operates conceptually, let’s take a tour of the new code base.</p>
    <h2 id="_idParaDest-300" class="heading-2">Refactoring RxJS and NgRx code</h2>
    <p class="normal">We will review the refactored<a id="_idIndexMarker1067"/> LocalCast Weather <a id="_idIndexMarker1068"/>app to examine how the code was rewritten to be simpler and more concise using signals and SignalStore.</p>
    <div class="note">
      <p class="normal">The source code for this section is under <code class="inlineCode">projects/signal-store</code> on the <code class="inlineCode">local-weather-app</code> repository at <a href="https://github.com/duluca/local-weather-app/tree/main/projects/signal-store"><span class="url">https://github.com/duluca/local-weather-app/tree/main/projects/signal-store</span></a>.</p>
      <p class="normal">You can run the project by executing:</p>
      <pre class="programlisting con"><code class="hljs-con">$ npx ng serve --project signal-store
</code></pre>
      <p class="normal">Run Cypress tests with:</p>
      <pre class="programlisting con"><code class="hljs-con">$ npx ng run signal-store:cypress-run --spec "cypress/e2e/app.cy.ts,cypress/e2e/simple-search.cy.ts"
</code></pre>
    </div>
    <h3 id="_idParaDest-301" class="heading-3">NgRx Store to SignalStore</h3>
    <p class="normal">Let’s start with the Store<a id="_idIndexMarker1069"/> implementation<a id="_idIndexMarker1070"/> under <code class="inlineCode">projects/signal-store/src/app/store</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">projects/signal-store/src/app/store/weather.</strong><strong class="hljs-property-slc">store</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title">WeatherStore</span> = <span class="hljs-title">signalStore</span>(
  {
    <span class="hljs-attr">providedIn</span>: <span class="hljs-string">'root'</span>,
  },
  <span class="hljs-title">withState</span>({
    <span class="hljs-attr">current</span>: defaultWeather,
  }),
  <span class="hljs-title">withMethods</span>(<span class="hljs-function">(</span><span class="hljs-params">store, weatherService = inject(WeatherService)</span><span class="hljs-function">) =&gt;</span> ({
    <span class="hljs-keyword">async</span> <span class="hljs-title">updateWeather</span>(<span class="hljs-attr">searchText</span><span class="hljs-params">: </span><span class="hljs-built_in">string</span><span class="hljs-params">, country?: </span><span class="hljs-built_in">string</span>) {
      <span class="hljs-title">patchState</span>(store, {
        <span class="hljs-attr">current</span>: <span class="hljs-keyword">await</span> weatherService.<span class="hljs-title">getCurrentWeather</span>(
          searchText,
          country
        ),
      })
    },
  }))
)
</code></pre>
    <p class="normal"><code class="inlineCode">withState</code> defines and initializes the store. <code class="inlineCode">withMethods</code> implements the <code class="inlineCode">updateWeather</code> function, which encapsulates the behavior for updating the current weather. This function used to be in <code class="inlineCode">WeatherService</code> but has now been moved into the store. Arguably, this should have been<a id="_idIndexMarker1071"/> the case for the NgRx Store<a id="_idIndexMarker1072"/> implementation; however, with an overall simpler architecture, it is easier to see that any potential side effect is best implemented in the store.</p>
    <h3 id="_idParaDest-302" class="heading-3">Services from Observables to Signals</h3>
    <p class="normal">We must update API calls to return a Promise<a id="_idIndexMarker1073"/> instead of an Observable. I first updated <code class="inlineCode">PostalCodeService</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">projects/signal-store/src/app/postal-code/postal-code.</strong><strong class="hljs-property-slc">service</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PostalCodeService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IPostalCodeService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> httpClient = <span class="hljs-title">inject</span>(<span class="hljs-title">HttpClient</span>)
  <span class="hljs-title">resolvePostalCode</span>(<span class="hljs-attr">postalCode</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">IPostalCode</span>&gt; {
    <span class="hljs-keyword">const</span> uriParams = <span class="hljs-keyword">new</span> <span class="hljs-title">HttpParams</span>()
      .<span class="hljs-title">set</span>(<span class="hljs-string">'maxRows'</span>, <span class="hljs-string">'1'</span>)
      .<span class="hljs-title">set</span>(<span class="hljs-string">'username'</span>, environment.<span class="hljs-property">username</span>)
      .<span class="hljs-title">set</span>(<span class="hljs-string">'postalcode'</span>, postalCode)
    <span class="hljs-keyword">const</span> httpCall$ = <span class="hljs-variable">this</span>.<span class="hljs-property">httpClient</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title">IPostalCodeData</span>&gt;(
      <span class="hljs-string">`</span><span class="hljs-subst">${environment.baseUrl}${environment.geonamesApi}</span><span class="hljs-string">.geonames.org/postalCodeSearchJSON`</span>,
      { <span class="hljs-attr">params</span>: uriParams }
    )
    <span class="hljs-keyword">return</span> <span class="hljs-title">lastValueFrom</span>(httpCall$).<span class="hljs-title">then</span>(<span class="hljs-function">(</span><span class="hljs-params">data</span><span class="hljs-function">) =&gt;</span>
      data.<span class="hljs-property">postalCodes</span>?.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> ? 
        data.<span class="hljs-property">postalCodes</span>[<span class="hljs-number">0</span>] : defaultPostalCode
    )
  }
}
</code></pre>
    <p class="normal"><code class="inlineCode">resolvePostalCode</code> now returns <code class="inlineCode">Promise&lt;IPostalCode&gt;</code>. We store the Observable from <code class="inlineCode">httpClient.get</code> as a local <code class="inlineCode">httpCall$</code> variable, which is then wrapped by <code class="inlineCode">lastValueFrom</code>. In the process, we also removed the pipe, which implemented <code class="inlineCode">mergeMap</code> and <code class="inlineCode">defaultIfEmpty</code> to clean up the received data. We must implement a similar functionality in the <code class="inlineCode">then</code> function. As shown previously, <code class="inlineCode">then</code> behaves similarly to a <code class="inlineCode">tap</code> function.</p>
    <p class="normal">Next, let’s look<a id="_idIndexMarker1074"/> at <code class="inlineCode">WeatherService</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">projects/signal-store/src/app/weather/weather.</strong><strong class="hljs-property-slc">service</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WeatherService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IWeatherService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> httpClient = <span class="hljs-title">inject</span>(<span class="hljs-title">HttpClient</span>)
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> postalCodeService = <span class="hljs-title">inject</span>(<span class="hljs-title">PostalCodeService</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title">getCurrentWeather</span>(
    <span class="hljs-attr">searchText</span>: <span class="hljs-built_in">string</span>, country?: <span class="hljs-built_in">string</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">ICurrentWeather</span>&gt; {
    <span class="hljs-keyword">const</span> postalCode = <span class="hljs-keyword">await</span>   
       <span class="hljs-variable">this</span>.<span class="hljs-property">postalCodeService</span>.<span class="hljs-title">resolvePostalCode</span>(searchText)
    <span class="hljs-keyword">if</span> (postalCode &amp;&amp; postalCode !== defaultPostalCode) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-title">getCurrentWeatherByCoords</span>({
        <span class="hljs-attr">latitude</span>: postalCode.<span class="hljs-property">lat</span>,
        <span class="hljs-attr">longitude</span>: postalCode.<span class="hljs-property">lng</span>,
      })
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">const</span> uriParams = <span class="hljs-keyword">new</span> <span class="hljs-title">HttpParams</span>().<span class="hljs-title">set</span>(
        <span class="hljs-string">'q'</span>,
        country ? <span class="hljs-string">`</span><span class="hljs-subst">${searchText}</span><span class="hljs-string">,</span><span class="hljs-subst">${country}</span><span class="hljs-string">`</span> : searchText
      )
      <span class="hljs-keyword">return</span> <span class="hljs-variable">this</span>.<span class="hljs-title">getCurrentWeatherHelper</span>(uriParams)
    }
  }
  <span class="hljs-keyword">private</span> <span class="hljs-title">getCurrentWeatherHelper</span>(
    <span class="hljs-attr">uriParams</span>: <span class="hljs-title">HttpParams</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">ICurrentWeather</span>&gt; {
    uriParams = uriParams.<span class="hljs-title">set</span>(<span class="hljs-string">'appid'</span>, environment.<span class="hljs-property">appId</span>)
    <span class="hljs-keyword">const</span> httpCall$ = <span class="hljs-variable">this</span>.<span class="hljs-property">httpClient</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title">ICurrentWeatherData</span>&gt;(
      <span class="hljs-string">`</span><span class="hljs-subst">${environment.baseUrl}</span><span class="hljs-string">api.openweathermap.org/data/2.5/weather`</span>,
      { <span class="hljs-attr">params</span>: uriParams }
    )
    <span class="hljs-keyword">return</span> <span class="hljs-title">lastValueFrom</span>(httpCall$).<span class="hljs-title">then</span>(
           <span class="hljs-function">(</span><span class="hljs-params">data</span><span class="hljs-function">) =&gt;</span> <span class="hljs-variable">this</span>.<span class="hljs-title">transformToICurrentWeather</span>(data))
  }
</code></pre>
    <p class="normal"><code class="inlineCode">getCurrentWeather</code> is now an async function to await the result of <code class="inlineCode">postalCodeService.resolvePostalCode</code>. The logic inside the <code class="inlineCode">switchMap</code> to handle the response from <code class="inlineCode">resolvePostalCode</code> is now a simple if-else statement with less nesting. <code class="inlineCode">getCurrentWeatherHelper</code> has been refactored similar to how we refactored <code class="inlineCode">resolvePostalCode</code>.</p>
    <p class="normal">Most importantly, there’s no longer<a id="_idIndexMarker1075"/> a <code class="inlineCode">BehaviorSubject</code>, a <code class="inlineCode">signal</code>, or any code that remains in the service that updates the value of <code class="inlineCode">currentWeather</code>.</p>
    <h3 id="_idParaDest-303" class="heading-3">Components from Observables to Signals</h3>
    <p class="normal">With the services updated, we can<a id="_idIndexMarker1076"/> now complete the refactor and update the components to use signals.</p>
    <p class="normal">Let’s start with <code class="inlineCode">CitySearchComponent</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">projects/signal-store/src/app/city-search/city-search.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-meta">@Component</span>({
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-city-search'</span>,
  ...
  <span class="code-highlight"><strong class="hljs-attr-slc">changeDetection</strong><strong class="hljs-slc">: </strong><strong class="hljs-title-slc">ChangeDetectionStrategy</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">OnPush</strong><strong class="hljs-slc">,</strong></span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CitySearchComponent</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> store = <span class="hljs-title">inject</span>(<span class="hljs-title">WeatherStore</span>)
  search = <span class="hljs-keyword">new</span> <span class="hljs-title">FormControl</span>(
    <span class="hljs-string">''</span>, 
    [<span class="hljs-title">Validators</span>.<span class="hljs-property">required</span>, <span class="hljs-title">Validators</span>.<span class="hljs-title">minLength</span>(<span class="hljs-number">2</span>)]
  )
  <span class="hljs-keyword">readonly</span> searchSignal = <span class="code-highlight"><strong class="hljs-title-slc">toSignal</strong></span>(
    <span class="hljs-variable">this</span>.<span class="hljs-property">search</span>.<span class="hljs-property">valueChanges</span>.<span class="hljs-title">pipe</span>(
      <span class="hljs-title">filter</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable">this</span>.<span class="hljs-property">search</span>.<span class="hljs-property">valid</span>),
      <span class="hljs-title">debounceTime</span>(<span class="hljs-number">1000</span>)
    )
  )
  <span class="hljs-title">constructor</span>() {
    <span class="hljs-title">effect</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable">this</span>.<span class="hljs-title">doSearch</span>(<span class="hljs-variable">this</span>.<span class="hljs-title">searchSignal</span>())
    })
  }
  <span class="hljs-title">doSearch</span>(<span class="hljs-params">searchValue?: </span><span class="hljs-built_in">string</span><span class="hljs-params"> | </span><span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> searchValue !== <span class="hljs-string">'string'</span>) <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">const</span> userInput = searchValue.<span class="hljs-title">split</span>(<span class="hljs-string">','</span>).<span class="hljs-title">map</span>(<span class="hljs-function">(</span><span class="hljs-params">s</span><span class="hljs-function">) =&gt;</span> s.<span class="hljs-title">trim</span>())
    <span class="hljs-keyword">const</span> searchText = userInput[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">const</span> country = userInput.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span> ? userInput[<span class="hljs-number">1</span>] : <span class="hljs-literal">undefined</span>
    <span class="hljs-variable">this</span>.<span class="hljs-property">store</span>.<span class="hljs-title">updateWeather</span>(searchText, country)
  }
}
</code></pre>
    <p class="normal">We first set the <code class="inlineCode">changeDetection</code> strategy to be <code class="inlineCode">OnPush</code>. Next, we wrap <code class="inlineCode">search.valueChanges</code> in a <code class="inlineCode">toSignal</code> function to convert the Observable to a signal. This is notably the only pipe remaining in the app. The main reason is because of the <code class="inlineCode">debounceTime</code> operator. See the tip box for more. We then use the <code class="inlineCode">effect</code> function to react to changes pushed to <code class="inlineCode">searchSignal</code>, which triggers <code class="inlineCode">doSearch</code>, which in turn calls <code class="inlineCode">store.updateWeather</code>. As we covered earlier, <code class="inlineCode">store.updateWeather</code> will end up updating the <code class="inlineCode">store.current</code> signal. Notably, we no longer reference <code class="inlineCode">WeatherService</code> from this component, and no template<a id="_idIndexMarker1077"/> changes were needed.</p>
    <div class="packt_tip">
      <p class="normal">Filter and debounce are the only RxJS operators left in LocalCast Weather. Currently, there aren’t operators for signals. You can check out how a debounced signal function might work in this Stack Overflow answer <a href="https://stackoverflow.com/a/76597576/178620"><span class="url">https://stackoverflow.com/a/76597576/178620</span></a>. However, as the author An Nguyen notes, it’s complicated code, and it’s better to use a well-tested library for now.</p>
    </div>
    <p class="normal">Next, let’s look at <code class="inlineCode">CurrentWeatherComponent</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">projects/signal-store/src/app/current-weather/</strong></span>
<span class="code-highlight"><strong class="hljs-slc">current-weather.</strong><strong class="hljs-property-slc">component</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">ts</strong></span>
<span class="hljs-meta">@Component</span>({
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-current-weather'</span>,
  ...
  <span class="hljs-attr">changeDetection</span>: <span class="hljs-title">ChangeDetectionStrategy</span>.<span class="hljs-property">OnPush</span>,
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CurrentWeatherComponent</span> {
  <span class="hljs-keyword">readonly</span> store = <span class="hljs-title">inject</span>(<span class="hljs-title">WeatherStore</span>)  
  ...
}
</code></pre>
    <p class="normal">The most remarkable change happens within <code class="inlineCode">CurrentWeatherComponent</code>. We set <code class="inlineCode">changeDetection</code> as before, but now we only have to inject <code class="inlineCode">WeatherStore</code>. That’s it:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc">projects/signal-store/src/app/current-weather/</strong></span>
<span class="code-highlight"><strong class="hljs-slc">current-weather.component.html</strong></span>
&lt;<span class="code-highlight"><strong class="hljs-name-slc">div</strong></span> <span class="code-highlight"><strong class="hljs-attr-slc">fxLayout</strong></span>=<span class="code-highlight"><strong class="hljs-string-slc">"row"</strong></span>&gt;
  &lt;<span class="hljs-name">div</span> <span class="hljs-attr">fxFlex</span>=<span class="hljs-string">"66%"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mat-headline-6</span> <span class="hljs-string">no-margin"</span> <span class="hljs-attr">data-testid</span>=<span class="hljs-string">"city"</span>&gt;
    {{ store.current().city }},
    {{ store.current().country }}
  &lt;/<span class="hljs-name">div</span>&gt;
  ...
</code></pre>
    <p class="normal">In the template, we can remove the null guard because the signal is always initialized. Then we simply bind to <code class="inlineCode">store.current()</code> signal. This, of course, requires a rather annoying refactoring of the template. We have to update every reference to <code class="inlineCode">current </code>with <code class="inlineCode">store.current()</code>. This could have been avoided by introducing a local variable named <code class="inlineCode">current</code> and then using an <code class="inlineCode">effect</code> to listen to updates on <code class="inlineCode">store.current()</code>. However, with that configuration, you wouldn’t get the benefits of the granular change detection that <code class="inlineCode">signal</code> and <code class="inlineCode">OnPush</code> offer.</p>
    <div class="packt_tip">
      <p class="normal">I expect when Signal-based components arrive, we will be able to write code similar to how async pipe works:</p>
      <pre class="programlisting code"><code class="hljs-code">@if (store.current() as current)
</code></pre>
      <p class="normal">This will be a tremendous help in avoiding annoying template rewrites.</p>
    </div>
    <p class="normal">And with the component updates done, the application refactor is complete. There are other subtle changes around the app code. You will notice a lot less imports and providers.</p>
    <p class="normal">In my opinion, the signal-only code<a id="_idIndexMarker1078"/> is easier to understand and maintain; far superior to the RxJS alternative. I hope you enjoyed this glimpse into Angular’s future.</p>
    <h1 id="_idParaDest-304" class="heading-1">Summary</h1>
    <p class="normal">In this chapter, we completed going over all major Angular app design considerations using router-first architecture, along with our recipes, to implement a line-of-business app easily. We reviewed how to edit existing users, leverage a resolve guard to load user data, and hydrate and reuse a component in different contexts.</p>
    <p class="normal">We implemented a master/detail view using auxiliary routes and demonstrated how to build data tables with pagination. We then learned how to implement NgRx/Store and NgRx/SignalStore using <strong class="keyWord">local-weather-app</strong>. We covered the available options within the NgRx ecosystem, including NgRx/Data, NgRx/ComponentStore, Akita, and Elf, and the differences between those options, so you can make informed decisions about what to include in your project.</p>
    <p class="normal">We also implemented a pre-loading animation, so your app looks responsive when loading in slow connections. We also implemented a global spinner within the app to handle data pop-in-related UX issues. Finally, we took a peek into Angular’s signal-based future by touring a full refactor of <strong class="keyWord">local-weather-app</strong> using SignalStore and developer preview features.</p>
    <p class="normal">Using the router-first design, architecture, and implementation approach, we tackled our application’s design with a high-level understanding of what we wanted to achieve. We saw the power of router orchestration by demonstrating the use of router outlets and reusing the same component in two different contexts. By identifying code reuse opportunities early on, we optimized our implementation strategy to implement reusable components ahead of time without running the risk of grossly over-engineering our solution.</p>
    <p class="normal">In the next chapter, we learn about containerization using Docker and deploying your apps to the cloud. Docker allows powerful workflows that can greatly improve development experiences while allowing you to implement your server configuration as code, putting the final nail in the coffin of the developer’s favorite excuse when their software breaks: “But it works on my machine!”</p>
    <h1 id="_idParaDest-305" class="heading-1">Exercises</h1>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Update <code class="inlineCode">UserTableComponent</code> and related services in <strong class="keyWord">lemon-mart</strong> to leverage Elf entities and pagination to enable optimized handling of requests.</li>
      <li class="numberedList">Follow the guide on <a href="https://ngneat.github.io/elf/docs/features/pagination"><span class="url">https://ngneat.github.io/elf/docs/features/pagination</span></a>.</li>
      <li class="numberedList">Rewrite your Angular app with NgRx/SignalStore to be nearly Observable and RxJS operator-free with zero subscribe calls or async pipes.</li>
      <li class="numberedList">If you think this is a hilarious exercise tacked on toward the end of the book, give me a shoutout on my GitHub profile at <a href="https://github.com/duluca"><span class="url">https://github.com/duluca</span></a>.</li>
    </ol>
    <h1 id="_idParaDest-306" class="heading-1">Further reading</h1>
    <ul>
      <li class="bulletList"><em class="italic">Testing Angular Components With @Input()</em>, Aiko Klostermann, 2017, available at <a href="https://medium.com/better-programming/testing-angular-components-with-input-3bd6c07cfaf6 "><span class="url">https://medium.com/better-programming/testing-angular-components-with-input-3bd6c07cfaf6</span></a></li>
      <li class="bulletList"><em class="italic">What is NgRx?</em>, 2020, available at <a href="https://ngrx.io/docs"><span class="url">https://ngrx.io/docs</span></a></li>
      <li class="bulletList"><em class="italic">NgRx Testing</em>, 2020, available at <a href="https://ngrx.io/guide/store/testing"><span class="url">https://ngrx.io/guide/store/testing</span></a></li>
      <li class="bulletList"><em class="italic">@ngrx/data</em>, 2020, available at <a href="https://ngrx.io/guide/data"><span class="url">https://ngrx.io/guide/data</span></a></li>
      <li class="bulletList"><em class="italic">NgRx: Action Creators redesigned</em>, Alex Okrushko, 2019, available at <a href="https://medium.com/angular-in-depth/ngrx-action-creators-redesigned-d396960e46da"><span class="url">https://medium.com/angular-in-depth/ngrx-action-creators-redesigned-d396960e46da</span></a></li>
      <li class="bulletList"><em class="italic">Simplifying Frontend State Management with Observable Store</em>, Dan Wahlin, 2019, available at <a href="https://blog.codewithdan.com/simplifying-front-end-state-management-with-observable-store/"><span class="url">https://blog.codewithdan.com/simplifying-front-end-state-management-with-observable-store/</span></a></li>
      <li class="bulletList"><em class="italic">Handling pagination with NgRx component stores</em>, Pierre Bouillon, 2023, <a href="https://dev.to/this-is-angular/handling-pagination-with-ngrx-component-stores-1j1p"><span class="url">https://dev.to/this-is-angular/handling-pagination-with-ngrx-component-stores-1j1p</span></a></li>
      <li class="bulletList"><em class="italic">Navigating the Nuances of toSignal in Angular: What to Know</em>, Netanel Basal, 2023, <a href="https://netbasal.com/navigating-the-nuances-of-tosignal-in-angular-what-to-know-e4d6a4b5dfaf"><span class="url">https://netbasal.com/navigating-the-nuances-of-tosignal-in-angular-what-to-know-e4d6a4b5dfaf</span></a></li>
      <li class="bulletList"><em class="italic">A Guide to Angular Signals With Practical Use Cases</em>, Arman Murzabulatov, 2023, <a href="https://hackernoon.com/a-guide-to-angular-signals-with-practical-use-cases-part-1"><span class="url">https://hackernoon.com/a-guide-to-angular-signals-with-practical-use-cases-part-1</span></a></li>
      <li class="bulletList"><em class="italic">The Power of @ngrx/signalstore: A Deep Dive Into Task Management</em>, Peter Eijgermans, 2024, <a href="https://dzone.com/articles/the-power-of-ngrxsignalstore-a-deep-dive-into-task"><span class="url">https://dzone.com/articles/the-power-of-ngrxsignalstore-a-deep-dive-into-task</span></a></li>
      <li class="bulletList"><em class="italic">How to Implement a Global Loader in Angular</em>, Faizan Shaikh , 2023, <a href="https://blog.bitsrc.io/how-to-implement-a-global-loader-in-angular-df111a2c43d9"><span class="url">https://blog.bitsrc.io/how-to-implement-a-global-loader-in-angular-df111a2c43d9</span></a></li>
      <li class="bulletList"><em class="italic">RxJS: Avoiding takeUntil Leaks</em>, Nicholas Jamieson, 2018, <a href="https://cartant.medium.com/rxjs-avoiding-takeuntil-leaks-fb5182d047ef"><span class="url">https://cartant.medium.com/rxjs-avoiding-takeuntil-leaks-fb5182d047ef</span></a></li>
      <li class="bulletList"><em class="italic">Comprehensive Guide to Higher-Order RxJS Mapping Operators: switchMap, mergeMap, concatMap (and exhaustMap)</em>, Angular University, 2023, <a href="https://blog.angular-university.io/rxjs-higher-order-mapping "><span class="url">https://blog.angular-university.io/rxjs-higher-order-mapping</span></a></li>
    </ul>
    <h1 id="_idParaDest-307" class="heading-1">Questions</h1>
    <p class="normal">Answer the following questions as best as possible to ensure you’ve understood the key concepts from this chapter without googling anything. Do you know if you got all the answers right? Visit <a href="https://angularforenterprise.com/self-assessment"><span class="url">https://angularforenterprise.com/self-assessment</span></a> for more:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">What is a resolve guard?</li>
      <li class="numberedList">What are the benefits of router orchestration?</li>
      <li class="numberedList">What is an auxiliary route?</li>
      <li class="numberedList">How does NgRx differ from using RxJS/Subject?</li>
      <li class="numberedList">What’s the value of NgRx Data?</li>
      <li class="numberedList">In <code class="inlineCode">UserTableComponent</code>, why do we use <code class="inlineCode">readonly</code> <code class="inlineCode">isLoadingResults$: BehaviorSubject&lt;Boolean&gt;</code> over a simple Boolean to drive the loading spinner?</li>
    </ol>
    <h1 class="heading-1">Join our community on Discord</h1>
    <p class="normal">Join our community’s Discord space for discussions with the authors and other readers:</p>
    <p class="normal"><a href="Chapter_9.xhtml"><span class="url">https://packt.link/AngularEnterpise3e</span></a></p>
    <p class="normal"><img src="../Images/QR_Code1116411172100421421.png" alt="" role="presentation"/></p>
  </div>
</body></html>