<html><head></head><body>
<div id="sbo-rt-content"><div class="Basic-Text-Frame" id="_idContainer219">
<h1 class="chapterNumber">17</h1>
<h1 class="chapterTitle" id="_idParaDest-295">Deploying to Production </h1>
<p class="normal">Now that you have completed your first React application, it is time to learn how to deploy it to the world. For this purpose, we will use<a id="_idIndexMarker904"/> the cloud service called <strong class="keyWord">DigitalOcean</strong>.</p>
<p class="normal">In this chapter, you will learn how to deploy your React application using Node.js and <code class="inlineCode">nginx</code> on an Ubuntu server from DigitalOcean. In a nutshell, we will cover the following topics:</p>
<ul>
<li class="bulletList">Creating a DigitalOcean Droplet and configuring it</li>
<li class="bulletList">Configuring nginx, PM2, and a domain</li>
<li class="bulletList">Implementing CircleCI for continuous integration</li>
</ul>
<h1 class="heading-1" id="_idParaDest-296">Technical requirements</h1>
<p class="normal">To complete this chapter, you will need the following:</p>
<ul>
<li class="bulletList">Node.js 19+</li>
<li class="bulletList">Visual Studio Code</li>
</ul>
<h1 class="heading-1" id="_idParaDest-297">Creating our first DigitalOcean Droplet</h1>
<p class="normal">I have used DigitalOcean for the last seven years, and I can<a id="_idIndexMarker905"/> say that it is one of the best cloud services I have tried, not just because of the affordable costs but also because it is super easy and fast to configure, and the community has a lot of updated documentation to fix most of the common issues related to server configuration.</p>
<p class="normal">At this point, you will need to invest some money to get this service. I will show you the cheapest way to do this, and if in the future you want to increase the power of your Droplets, you will be able to increase the capacity without redoing the configuration. </p>
<p class="normal">The lowest price for a very basic Droplet is $6.00 per month ($0.009 per hour). </p>
<p class="normal">We are going to use Ubuntu 20.04 (but feel free to use the latest version, 21.04); you will need to know some basic Linux commands<a id="_idIndexMarker906"/> to be able to configure your Droplet. If you’re a beginner using Linux, don’t worry—I’ll try to show you each step in a very easy way.</p>
<h2 class="heading-2" id="_idParaDest-298">Signing up to DigitalOcean</h2>
<p class="normal">If you don’t<a id="_idIndexMarker907"/> have a DigitalOcean account, you<a id="_idIndexMarker908"/> can sign up at <a href="https://cloud.digitalocean.com/registrations/new"><span class="url">https://cloud.digitalocean.com/registrations/new</span></a>. </p>
<p class="normal">You can sign up with your Google account or by registering manually. Once you register with Google, you will see the <strong class="screenText">Billing Info</strong> view, as follows:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" height="713" src="../Images/B18414_17_01.png" width="582"/></figure>
<p class="packt_figref">Figure 17.1: Billing Info</p>
<p class="normal">You can pay with your credit card or by using PayPal. Once you have configured your payment information, DigitalOcean will ask you for some information about your project<a id="_idIndexMarker909"/> so that it can configure your Droplet faster.</p>
<p class="packt_figref"><img alt="Graphical user interface, application  Description automatically generated" height="948" src="../Images/B18414_17_02.png" width="674"/></p>
<p class="packt_figref">Figure 17.2: First application</p>
<p class="normal">Let’s go on to create our first Droplet.</p>
<h2 class="heading-2" id="_idParaDest-299">Creating our first Droplet</h2>
<p class="normal">We will create a new Droplet<a id="_idIndexMarker910"/> from scratch. Follow these steps to do so:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">Select the <strong class="keyWord">New Droplet</strong> option, as shown in the following screenshot:</li>
</ol>
<figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" height="395" src="../Images/B18414_17_03.png" width="332"/></figure>
<p class="packt_figref">Figure 17.3: New Droplet</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="2">Choose <strong class="keyWord">Ubuntu 20.04 (LTS) x64</strong>, as follows:</li>
</ol>
<figure class="mediaobject"><img alt="Graphical user interface, application, Word  Description automatically generated" height="264" src="../Images/B18414_17_04.png" width="759"/></figure>
<p class="packt_figref">Figure 17.4: Choose an image</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3">Then, choose the <strong class="keyWord">Basic</strong> plan, as shown here:</li>
</ol>
<figure class="mediaobject"><img alt="Table  Description automatically generated with medium confidence" height="108" src="../Images/B18414_17_05.png" width="759"/></figure>
<p class="packt_figref">Figure 17.5: Choose a plan</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4">You can then choose <strong class="keyWord">$6/mo</strong> from the payment<a id="_idIndexMarker911"/> plan options:</li>
</ol>
<figure class="mediaobject"><img alt="" height="206" src="../Images/B18414_17_06.png" width="759"/></figure>
<p class="packt_figref">Figure 17.6: CPU options</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="5">Select a region. In this case, we will select the <strong class="keyWord">San Francisco</strong> region:<p class="packt_figref"><img alt="" height="315" src="../Images/B18414_17_07.png" width="759"/></p>
<p class="packt_figref">Figure 17.7: Choose Region</p>
</li>
<li class="numberedList">Create a root password, add the name of your Droplet, and then click on the <strong class="keyWord">Create Droplet</strong> button, as follows:<p class="packt_figref"><img alt="Graphical user interface, text, application, email  Description automatically generated" height="550" src="../Images/B18414_17_08.png" width="759"/></p>
<p class="packt_figref">Figure 17.8: Authentication</p>
</li>
<li class="numberedList">It will take around 30 seconds<a id="_idIndexMarker912"/> to create your Droplet. Once it has been created, you will be able to see it:</li>
</ol>
<figure class="mediaobject"><img alt="" height="87" src="../Images/B18414_17_09.png" width="759"/></figure>
<p class="packt_figref">Figure 17.9: My first Droplet</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="8">Now, in your Terminal, you can access the Droplet by using the following command:
        <pre class="programlisting con"><code class="hljs-con">ssh root@THE_DROPLET_IP
</code></pre>
</li>
<li class="numberedList">The first time you access it, you will be asked for a fingerprint. You just need to type <em class="italic">Yes</em>, and then it will require your password (the one you defined when you created your Droplet). </li>
</ol>
<p class="numberedList">This serves as a security feature specifically designed<a id="_idIndexMarker913"/> to prevent <em class="italic">man-in-the-middle</em> attacks. The server’s “fingerprint” acts as a distinctive digital signature that is unique to the server itself. When you observe a fingerprint that matches the expected one, you can proceed by typing <code class="inlineCode">yes</code> and pressing <em class="keystroke">Enter</em> to continue. Subsequently, the server will prompt you to enter your password. Provide the password you defined when you created your Droplet, and press <em class="keystroke">Enter</em>. Please note that, for security purposes, no characters will be displayed on the screen as you enter your password. Upon successful authentication, you will be logged in to your server, ready to initiate commands.</p>
<p class="packt_figref"><img alt="Text  Description automatically generated" height="698" src="../Images/B18414_17_10.png" width="754"/></p>
<p class="packt_figref">Figure 17.10: Connecting to Droplet</p>
<p class="normal">Now we are all set to install Node.js, which we will cover in the next section.</p>
<h2 class="heading-2" id="_idParaDest-300">Installing Node.js</h2>
<p class="normal">Now that you’re connected<a id="_idIndexMarker914"/> to your Droplet, let’s configure<a id="_idIndexMarker915"/> it. First, we need to install the latest version of Node.js using a Personal Package Archive. The current version of Node at the time of writing this book is 19.9.x. Follow these steps to install Node.js:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">If, when you are reading this paragraph, Node has a new version, change the version in the <code class="inlineCode">setup_19.x</code> command:
        <pre class="programlisting con"><code class="hljs-con">cd ~ 
curl -sL https://deb.nodesource.com/setup_19.x -o nodesource_setup.sh
</code></pre>
</li>
<li class="numberedList">Once you get the <code class="inlineCode">nodesource_setup.sh</code> file, run the following command:
        <pre class="programlisting con"><code class="hljs-con">sudo bash nodesource_setup.sh
</code></pre>
</li>
<li class="numberedList">Then, install Node by running the following command:
        <pre class="programlisting con"><code class="hljs-con">sudo apt install nodejs -y
</code></pre>
</li>
<li class="numberedList">If everything works fine, verify the installed version of Node and <code class="inlineCode">npm</code> with the following commands:
        <pre class="programlisting con"><code class="hljs-con">node -v 
v19.9.0 
npm -v 
9.6.3
</code></pre>
</li>
</ol>
<p class="normal">If you need<a id="_idIndexMarker916"/> a newer version<a id="_idIndexMarker917"/> of Node.js, you can always upgrade it.</p>
<h2 class="heading-2" id="_idParaDest-301">Configuring Git and GitHub</h2>
<p class="normal">I created a special repository<a id="_idIndexMarker918"/> to help you to deploy<a id="_idIndexMarker919"/> your first React application to production (<a href="https://github.com/FoggDev/production"><span class="url">https://github.com/FoggDev/production</span></a>).</p>
<p class="normal">In your Droplet, you<a id="_idIndexMarker920"/> need to clone this Git repository (or your own repository<a id="_idIndexMarker921"/> if you have your React application ready to be deployed). The production repository is public, but normally you will use a private repository; in this case, you need to add the SSH key of your Droplet to your GitHub account. </p>
<p class="normal">To create this key, follow these steps:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">Run the <code class="inlineCode">ssh-keygen</code> command and then press <em class="italic">Enter</em> three times without entering any passphrase:

    <figure class="mediaobject"><img alt="Text  Description automatically generated" height="450" src="../Images/B18414_17_11.png" width="737"/></figure>
<p class="packt_figref">Figure 17.11: ssh-keygen</p>
<p class="normal">If you leave your Terminal inactive for more than five minutes, your Droplet connection will probably be closed, and you will need to connect again. </p>
</li></ol><ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="2">Once you have created<a id="_idIndexMarker922"/> your Droplet<a id="_idIndexMarker923"/> SSH key, you can see<a id="_idIndexMarker924"/> it by running<a id="_idIndexMarker925"/> the following command:
        <pre class="programlisting con"><code class="hljs-con">vi /root/.ssh/id_rsa.pub
</code></pre>
<p class="normal">You will see something like this:</p>
<figure class="mediaobject"><img alt="Text  Description automatically generated" height="105" src="../Images/B18414_17_12.png" width="695"/></figure>
<p class="packt_figref">Figure 17.12: ssh-rsa</p>
</li></ol><ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3">Copy your SSH key and then visit your GitHub account. Go to <strong class="keyWord">Settings</strong> | <strong class="keyWord">SSH and GPG Keys</strong> (<a href="https://github.com/settings/ssh/new"><span class="url">https://github.com/settings/ssh/new</span></a>). Then, paste your key in to the text area and add your title to the key:</li>
</ol>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" height="420" src="../Images/B18414_17_13.png" width="759"/></figure>
<p class="packt_figref">Figure 17.13: Adding a new SSH key to GitHub</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4">Once you click<a id="_idIndexMarker926"/> on the <strong class="keyWord">Add SSH key</strong> button, you<a id="_idIndexMarker927"/> will see<a id="_idIndexMarker928"/> your SSH<a id="_idIndexMarker929"/> key, like so:</li>
</ol>
<figure class="mediaobject"><img alt="Text  Description automatically generated" height="97" src="../Images/B18414_17_14.png" width="759"/></figure>
<p class="packt_figref">Figure 17.14: SSH</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="5">Now you can clone our repository (or yours) using the following command:
        <pre class="programlisting con"><code class="hljs-con">git clone git@github.com:FoggDev/production.git
</code></pre>
</li>
<li class="numberedList">When you clone it for the first time, you will get a message asking you to allow the RSA key fingerprint:</li>
</ol>
<figure class="mediaobject"><img alt="Text  Description automatically generated" height="102" src="../Images/B18414_17_15.png" width="759"/></figure>
<p class="packt_figref">Figure 17.15: Cloning repository</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="7">You have to type <code class="inlineCode">Yes</code> and then hit <em class="keystroke">Enter</em> to be able to clone it:</li>
</ol>
<figure class="mediaobject"><img alt="Text  Description automatically generated" height="107" src="../Images/B18414_17_16.png" width="759"/></figure>
<p class="packt_figref">Figure 17.16: Known hosts</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="8">Then, you have to go<a id="_idIndexMarker930"/> to the production<a id="_idIndexMarker931"/> directory<a id="_idIndexMarker932"/> and install the <code class="inlineCode">npm</code><code class="inlineCode"><a id="_idIndexMarker933"/></code> packages:
        <pre class="programlisting con"><code class="hljs-con">cd production 
npm install
</code></pre>
</li>
<li class="numberedList">If you want to test the application, just run the <code class="inlineCode">start</code> script:
        <pre class="programlisting con"><code class="hljs-con">npm start
</code></pre>
</li>
<li class="numberedList">Then open your browser and go to your Droplet IP and add the port number. In my case, it is <code class="inlineCode">http://144.126.222.17:3000</code>:</li>
</ol>
<figure class="mediaobject"><img alt="A picture containing logo  Description automatically generated" height="121" src="../Images/B18414_17_17.png" width="626"/></figure>
<p class="packt_figref">Figure 17.17: Project running in development mode</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="11">This will run the project in development mode. If you want to run it in production mode, use the following command:
        <pre class="programlisting con"><code class="hljs-con">npm run start:production
</code></pre>
<p class="normal">You should see <strong class="keyWord">Production Process Manager</strong> (<strong class="keyWord">PM2</strong>)<a id="_idIndexMarker934"/> running, as shown<a id="_idIndexMarker935"/> in the<a id="_idIndexMarker936"/> following<a id="_idIndexMarker937"/> screenshot:</p>
<figure class="mediaobject"><img alt="Text  Description automatically generated" height="492" src="../Images/B18414_17_18.png" width="576"/></figure>
<p class="packt_figref">Figure 17.18: PM2</p>
</li> </ol><ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="12">If you run it and view the <strong class="keyWord">Network</strong> tab in your Chrome DevTools, you will see the bundles being loaded:</li>
</ol>
<figure class="mediaobject"><img alt="A screenshot of a computer  Description automatically generated with medium confidence" height="289" src="../Images/B18414_17_19.png" width="759"/></figure>
<p class="packt_figref">Figure 17.19: The Network tab</p>
<p class="normal">We now have our React<a id="_idIndexMarker938"/> application<a id="_idIndexMarker939"/> working in production, but let’s see<a id="_idIndexMarker940"/> what else<a id="_idIndexMarker941"/> we can do with DigitalOcean in the next section.</p>
<h2 class="heading-2" id="_idParaDest-302">Turning off our Droplet</h2>
<p class="normal">To turn off the Droplet, follow<a id="_idIndexMarker942"/> these steps:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">If you want to turn off your Droplet, you can go to the <strong class="screenText">Power</strong> section, or you can use the <strong class="keyWord">ON/OFF</strong> switch:</li>
</ol>
<figure class="mediaobject"><img alt="Text  Description automatically generated" height="93" src="../Images/B18414_17_20.png" width="759"/></figure>
<p class="packt_figref">Figure 17.20: Turning off the Droplet</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="2">DigitalOcean will charge you only when your Droplet is <strong class="screenText">ON</strong>. If you click on the <strong class="screenText">ON</strong> switch to turn it off, then you will get the following confirmation message:</li>
</ol>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" height="396" src="../Images/B18414_17_21.png" width="759"/></figure>
<p class="packt_figref">Figure 17.21: Turn off Droplet</p>
<p class="normal">In this way, you can control your Droplet<a id="_idIndexMarker943"/> and avoid paying unnecessarily when you’re not using your Droplet.</p>
<h1 class="heading-1" id="_idParaDest-303">Configuring nginx, PM2, and a domain</h1>
<p class="normal">Our Droplet is ready to be used for production, but as you can see, we are still using port <code class="inlineCode">3000</code>. We need to configure nginx and implement a proxy to redirect the traffic from port <code class="inlineCode">80</code> to <code class="inlineCode">3000</code>; this means we won’t need to specify the port directly anymore. </p>
<p class="normal"><strong class="keyWord">Node PM2</strong> will help us run the Node server<a id="_idIndexMarker944"/> in production securely. Generally, if we run Node directly with the <code class="inlineCode">node</code> or <code class="inlineCode">babel-node</code> commands, and there is an error in the app, then it will crash and will stop working. PM2 restarts the node server if an error occurs.</p>
<p class="normal">First, in your Droplet, you need to install PM2 globally:</p>
<pre class="programlisting con"><code class="hljs-con">npm install -g pm2
</code></pre>
<p class="normal">PM2 will help us to run our React app in a very easy way.</p>
<h2 class="heading-2" id="_idParaDest-304">Installing and configuring nginx</h2>
<p class="normal">To install nginx, you need<a id="_idIndexMarker945"/> to execute the following<a id="_idIndexMarker946"/> command:</p>
<pre class="programlisting con"><code class="hljs-con">sudo apt-get update 
sudo apt-get install nginx
</code></pre>
<p class="normal">After you have installed nginx, you can start the configuration:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">We need to adjust the firewall<a id="_idIndexMarker947"/> to allow the traffic for port <code class="inlineCode">80</code>. To list the available application<a id="_idIndexMarker948"/> configurations, you need to run the following command:
        <pre class="programlisting con"><code class="hljs-con">sudo ufw app list
Available applications:
Nginx Full
Nginx HTTP
Nginx HTTPS
OpenSSH
</code></pre>
</li>
<li class="numberedList"><code class="inlineCode">Nginx Full</code> means that it will allow the traffic from port <code class="inlineCode">80</code> (HTTP) and port <code class="inlineCode">443</code> (HTTPS). We haven’t configured any domain with SSL, so, for now, we should restrict the traffic to be sent just through port <code class="inlineCode">80</code> (HTTP):
        <pre class="programlisting con"><code class="hljs-con">sudo ufw allow 'Nginx HTTP'
Rules updated
Rules updated (v6)
</code></pre>
<p class="normal">If you try to access the Droplet IP, you should see nginx working:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" height="236" src="../Images/B18414_17_22.png" width="670"/></figure>
<p class="packt_figref">Figure 17.22: Welcome to nginx</p>
</li></ol> <ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3">You can manage the nginx process with these commands:
        <pre class="programlisting con"><code class="hljs-con">Start server: sudo systemctl start nginx
Stop server: sudo systemctl stop nginx
Restart server: sudo systemctl restart nginx
</code></pre>
</li>
</ol>
<p class="normal">Nginx is an amazing <a id="_idIndexMarker949"/>web server<a id="_idIndexMarker950"/> that is getting very popular nowadays.</p>
<h2 class="heading-2" id="_idParaDest-305">Setting up a reverse proxy server</h2>
<p class="normal">As I mentioned previously, we need to set up a reverse proxy server<a id="_idIndexMarker951"/> to send the traffic from port <code class="inlineCode">80</code> (HTTP) to port <code class="inlineCode">3000</code> (the React app). To do this, you need to open the following file:</p>
<pre class="programlisting con"><code class="hljs-con">sudo vi /etc/nginx/sites-available/default
</code></pre>
<p class="normal">The steps to set up the reverse proxy server are as follows:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">In the <code class="inlineCode">location /</code> block, you need to replace the code in the file with the following:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-section">location</span> / {
<span class="hljs-attribute">  proxy_pass</span> http://localhost:3000;
<span class="hljs-attribute">  proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;
<span class="hljs-attribute">  proxy_set_header</span> Upgrade <span class="hljs-variable">$http_upgrade</span>;
<span class="hljs-attribute">  proxy_set_header</span> Connection <span class="hljs-string">'upgrade'</span>; 
<span class="hljs-attribute">  proxy_set_header</span> Host <span class="hljs-variable">$host</span>; 
<span class="hljs-attribute">  proxy_cache_bypass</span> <span class="hljs-variable">$http_upgrade</span>;
 }
</code></pre>
</li>
<li class="numberedList">Once you have saved the file, you can verify whether there is a syntax error in the nginx configuration with the following command:
        <pre class="programlisting con"><code class="hljs-con">sudo nginx -t
</code></pre>
</li>
<li class="numberedList">If everything is fine, then you should see this:</li>
</ol>
<figure class="mediaobject"><img alt="Text  Description automatically generated" height="81" src="../Images/B18414_17_23.png" width="633"/></figure>
<p class="packt_figref">Figure 17.23: sudo ngnix-t</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4">Finally, you need to restart the nginx server:
        <pre class="programlisting con"><code class="hljs-con">sudo systemctl restart nginx
</code></pre>
</li>
</ol>
<p class="normal">Now, you should be able to access the React<a id="_idIndexMarker952"/> application without the port, as shown in the following screenshot:</p>
<figure class="mediaobject"><img alt="A picture containing text  Description automatically generated" height="115" src="../Images/B18414_17_24.png" width="526"/></figure>
<p class="packt_figref">Figure 17.24: The React application without the port</p>
<p class="normal">We are almost done! In the next section, we are going to add a domain to our Droplet.</p>
<h2 class="heading-2" id="_idParaDest-306">Adding a domain to our Droplet</h2>
<p class="normal">Using an IP to access a website<a id="_idIndexMarker953"/> is not nice; we always need to use a domain<a id="_idIndexMarker954"/> to help users find our website more easily. If you want to use a domain with your Droplet, you need to change the nameservers of your domain to point to the DigitalOcean DNS. I normally use GoDaddy to register my domains. </p>
<p class="normal">To do so using GoDaddy, follow these steps:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">Go to <a href="https://dcc.godaddy.com/manage/YOURDOMAIN.COM/dns"><span class="url">https://dcc.godaddy.com/manage/YOURDOMAIN.COM/dns</span></a>, and then go to the <strong class="keyWord">Nameservers</strong> section:</li>
</ol>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" height="219" src="../Images/B18414_17_25.png" width="302"/></figure>
<p class="packt_figref">Figure 17.25: Nameservers</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="2">Click on<a id="_idIndexMarker955"/> the <strong class="keyWord">Change</strong> button, select <strong class="keyWord">Custom</strong>, and then specify<a id="_idIndexMarker956"/> the DigitalOcean DNS:</li>
</ol>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" height="435" src="../Images/B18414_17_26.png" width="504"/></figure>
<p class="packt_figref">Figure 17.26: DigitalOcean Nameservers</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3">Normally, it takes between 15 and 30 minutes for the DNS changes to be reflected; for now, after<a id="_idIndexMarker957"/> you have updated your nameservers, go to your <strong class="keyWord">Droplet</strong> dashboard<a id="_idIndexMarker958"/> and then choose the <strong class="keyWord">Add a domain</strong> option:</li>
</ol>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" height="503" src="../Images/B18414_17_27.png" width="759"/></figure>
<p class="packt_figref">Figure 17.27: Add a domain</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4">Then, write your domain name, select your Droplet, and click on the <strong class="keyWord">Add Domain</strong> button:</li>
</ol>
<figure class="mediaobject"><img alt="Chart, radar chart  Description automatically generated" height="407" src="../Images/B18414_17_28.png" width="759"/></figure>
<p class="packt_figref">Figure 17.28: Networking </p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="5">Now, you must create a new record for <strong class="keyWord">CNAME</strong>. Select the <strong class="screenText">CNAME</strong> tab, and in <strong class="keyWord">HOSTNAME</strong>, type <code class="inlineCode">www</code>; in the alias<a id="_idIndexMarker959"/> field, write <code class="inlineCode">@;</code> by default, the TTL is <code class="inlineCode">43200</code>. All of this is to enable<a id="_idIndexMarker960"/> access to your domain using the <code class="inlineCode">www</code> prefix:</li>
</ol>
<figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" height="229" src="../Images/B18414_17_29.png" width="759"/></figure>
<p class="packt_figref">Figure 17.29: Create new record</p>
<p class="normal">If you did everything correctly, you should be able to access your domain and see the React application working. As I said before, this process can take up to 30 minutes, but in some cases, it can take up to 24 hours, depending on the DNS propagation speed:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" height="144" src="../Images/B18414_17_30.png" width="616"/></figure>
<p class="packt_figref">Figure 17.30: React application running on domain</p>
<p class="normal">Amazing. Now you have<a id="_idIndexMarker961"/> officially<a id="_idIndexMarker962"/> deployed your first React application to production!</p>
<h1 class="heading-1" id="_idParaDest-307">Implementing CircleCI for continuous integration</h1>
<p class="normal">I’ve been using CircleCI for a while, and I can tell you<a id="_idIndexMarker963"/> that it is one of the best CI solutions: it is free<a id="_idIndexMarker964"/> for personal use, giving you unlimited repositories and users; you have 1,000 build minutes per month, one container, and one concurrent job; if you need more, you can upgrade the plan with an initial price of $50 per month.</p>
<p class="normal">The first thing you need to do is sign up on the site using your GitHub account (or Bitbucket, if you prefer). </p>
<p class="normal">If you choose to use GitHub, you need to authorize CircleCI in your account, as shown in the following screenshot:</p>
<p class="packt_figref"><img alt="Graphical user interface, text, application  Description automatically generated" height="909" src="../Images/B18414_17_31.png" width="707"/></p>
<p class="packt_figref">Figure 17.31: Authorize CircleCI</p>
<p class="normal">In the next section, we are going to add our SSH key to CircleCI.</p>
<h2 class="heading-2" id="_idParaDest-308">Adding an SSH key to CircleCI</h2>
<p class="normal">Now that you have created<a id="_idIndexMarker965"/> your account, CircleCI needs a way to log<a id="_idIndexMarker966"/> in to your DigitalOcean Droplet to run the deploy script. Follow these steps to complete this task:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">Create a new SSH key inside your Droplet using the following command:
        <pre class="programlisting con"><code class="hljs-con">ssh-keygen -t rsa
# Then save the key as /root/.ssh/id_rsa_droplet with no password.
# After go to .ssh directory
cd /root/.ssh
</code></pre>
</li>
<li class="numberedList">After that, let’s add the key to our <code class="inlineCode">authorized_keys</code>:
        <pre class="programlisting con"><code class="hljs-con">cat id_rsa_droplet.pub &gt;&gt; authorized_keys
</code></pre>
</li>
<li class="numberedList">Now, you need to download<a id="_idIndexMarker967"/> the private key. To verify that you<a id="_idIndexMarker968"/> can log in with the new key, you need to copy it to your local machine, as follows:
        <pre class="programlisting con"><code class="hljs-con"># In your local machine do:
scp root@YOUR_DROPLET_IP:/root/.ssh/id_rsa_droplet ~/.ssh/
cd .ssh
ssh-add id_rsa_droplet
ssh -v root@YOUR_DROPLET_IP
</code></pre>
<p class="normal">If you did everything correctly, you should be able to log in to your Droplet without a password, and that means CircleCI can access our Droplet too.</p>
</li></ol><ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4">Copy the content of your <code class="inlineCode">id_rsa_droplet.pub</code> key and then go to your repository settings (<a href="https://app.circleci.com/settings/project/github/YOUR_GITHUB_USER/YOUR_REPOSITORY"><span class="url">https://app.circleci.com/settings/project/github/YOUR_GITHUB_USER/YOUR_REPOSITORY</span></a>):</li>
</ol>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" height="493" src="../Images/B18414_17_32.png" width="759"/></figure>
<p class="packt_figref">Figure 17.32: Project Settings</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="5">Go <a id="_idIndexMarker969"/>to <strong class="keyWord">SSH Keys</strong>, as<a id="_idIndexMarker970"/> follows:</li>
</ol>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" height="330" src="../Images/B18414_17_33.png" width="252"/></figure>
<p class="packt_figref">Figure 17.33: SSH Keys</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="6">You can also access the URL <a href="https://app.circleci.com/settings/project/github/YOUR_GITHUB_USER/YOUR_REPOSITORY/ssh"><span class="url">https://app.circleci.com/settings/project/github/YOUR_GITHUB_USER/YOUR_REPOSITORY/ssh</span></a>, and then click on the <strong class="keyWord">Add SSH Key</strong> button at the bottom:</li>
</ol>
<figure class="mediaobject"><img alt="Graphical user interface, application, email  Description automatically generated" height="623" src="../Images/B18414_17_34.png" width="759"/></figure>
<p class="packt_figref">Figure 17.34: Add an SSH key</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="7">Paste your private<a id="_idIndexMarker971"/> key, and then provide a name<a id="_idIndexMarker972"/> for the <strong class="keyWord">Hostname</strong> field; we will name it <code class="inlineCode">DigitalOcean</code>.</li>
</ol>
<p class="normal">Now let’s configure our CircleCI instance in the next section.</p>
<h2 class="heading-2" id="_idParaDest-309">Configuring CircleCI</h2>
<p class="normal">Now that you have configured<a id="_idIndexMarker973"/> access for CircleCI to your Droplet, you need to add a <code class="inlineCode">config</code> file to your project to specify the jobs you want to execute for the deployment process. </p>
<p class="normal">This process is shown in the following steps:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">For this, you need to create the <code class="inlineCode">.circleci</code> directory and add the following inside the <code class="inlineCode">config.yml</code> file:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-attribute">version</span><span class="hljs-punctuation">:</span> <span class="hljs-string">2.1</span>
<span class="hljs-attribute">jobs</span><span class="hljs-punctuation">:</span>
<span class="hljs-attribute">build</span><span class="hljs-punctuation">:</span>
<span class="hljs-attribute">working_directory</span><span class="hljs-punctuation">:</span> <span class="hljs-string">~/tmp</span>
<span class="hljs-attribute">docker</span><span class="hljs-punctuation">:</span>
<span class="hljs-bullet">  -</span> <span class="hljs-string">image: cimg/node:14.16.1</span>
<span class="hljs-attribute">steps</span><span class="hljs-punctuation">:</span>
<span class="hljs-bullet">  -</span> <span class="hljs-string">checkout</span>
<span class="hljs-bullet">  -</span> <span class="hljs-string">run: npm install</span>
<span class="hljs-bullet">  -</span> <span class="hljs-string">run: npm run lint</span>
<span class="hljs-bullet">  -</span> <span class="hljs-string">run: npm test</span>
<span class="hljs-bullet">  -</span> <span class="hljs-string">run: ssh -o StrictHostKeyChecking=no $DROPLET_USER@$DROPLET_IP 'cd production; git checkout master; git pull; npm install; npm run start:production;'</span>
 <span class="hljs-attribute">workflows</span><span class="hljs-punctuation">:</span>
 <span class="hljs-attribute">build-deploy</span><span class="hljs-punctuation">:</span>
 <span class="hljs-attribute">jobs</span><span class="hljs-punctuation">:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">build:</span>
 <span class="hljs-attribute">filters</span><span class="hljs-punctuation">:</span>
 <span class="hljs-attribute">branches</span><span class="hljs-punctuation">:</span>
 <span class="hljs-attribute">only</span><span class="hljs-punctuation">:</span> <span class="hljs-string">master</span>
</code></pre>
</li>
<li class="numberedList">When you have a <code class="inlineCode">.yml</code> file, you need to be careful with the indentation; it is similar to Python in that if you don’t use indents correctly, you will get an error. Let’s see how this file is structured.</li>
<li class="numberedList">Specify the CircleCI version we will use. In this instance, you are using version <code class="inlineCode">2.1</code> (the latest one at the time of writing this book):
        <pre class="programlisting code"><code class="hljs-code"> <span class="hljs-attribute">version</span>: <span class="hljs-number">2</span>.<span class="hljs-number">1</span>
</code></pre>
</li>
<li class="numberedList">Inside <code class="inlineCode">jobs</code>, we will specify that it needs to configure the container; we will create it using Docker and also outline the steps to follow for the deployment process.</li>
<li class="numberedList"><code class="inlineCode">working_directory</code> will be the temporal directory we will use to install the npm packages and run our deploy scripts. In this case, I decided to use the <code class="inlineCode">tmp</code> directory, as follows:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-symbol"> jobs:</span>
<span class="hljs-symbol"> build:</span>
<span class="hljs-symbol"> working_directory:</span> ~/tmp
</code></pre>
</li>
<li class="numberedList">As I said before, we will create a Docker container, and in this instance, I selected<a id="_idIndexMarker974"/> an existing image that includes <code class="inlineCode">node: 18.12.1</code>. If you want to know about all the available images, you can visit <a href="https://circleci.com/docs/2.0/circleci-images"><span class="url">https://circleci.com/docs/2.0/circleci-images</span></a>:
        <pre class="programlisting code"><code class="hljs-code"> <span class="hljs-attr">docker</span>:
 - <span class="hljs-attr">image</span>: cimg/<span class="hljs-attr">node</span>:<span class="hljs-number">18.12.1</span>
</code></pre>
</li>
<li class="numberedList">For the code case, first<a id="_idIndexMarker975"/> do a <code class="inlineCode">git checkout</code> to <code class="inlineCode">master</code>, then in each <code class="inlineCode">run</code> sentence, you need to specify the scripts you want to run:
        <pre class="programlisting con"><code class="hljs-con"> steps:
 - checkout
 - run: npm install
 - run: npm run lint
 - run: npm test
 - run: ssh -o StrictHostKeyChecking=no $DROPLET_USER@$DROPLET_IP 'cd production; git checkout master; git pull; npm install; npm run start:production;'
</code></pre>
</li>
</ol>
<p class="normal">Here is an explanation of the previous steps:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">First, you need to install the npm packages using <code class="inlineCode">npm install</code> to be able to perform the next tasks.</li>
<li class="numberedList">Execute the ESLint validation using <code class="inlineCode">npm run lint</code>. If it fails, it will break the deployment process; otherwise, it continues with the next run.</li>
<li class="numberedList">Execute the Jest validations using <code class="inlineCode">npm run test</code>; if it fails, it will break the deployment process. Otherwise, it continues with the next run.</li>
<li class="numberedList">In the last step, we connect to our DigitalOcean Droplet, passing the <code class="inlineCode">StrictHostKeyChecking=no</code> flag to disable the strict host key checking. We then use the <code class="inlineCode">$DROPLET_USER</code> and <code class="inlineCode">$DROPLET_IP</code> <code class="inlineCode">ENV</code> variables to connect to it (we will create those in the next step), and finally, we will specify all the commands we will perform inside our Droplet using single quotes. </li>
</ol>
<p class="numberedList">These commands are listed as follows: </p>
<ul>
<li class="bulletList"><strong class="keyWord">cd production:</strong> Grants access to the production (or your Git repository name).</li>
<li class="bulletList"><strong class="keyWord">git checkout master:</strong> This will check out the master branch.</li>
<li class="bulletList"><strong class="keyWord">git pull:</strong> Pulls the latest changes from our repository.</li>
<li class="bulletList"><strong class="keyWord">npm run start:production:</strong> This is the final step, which runs our project<a id="_idIndexMarker976"/> in production mode.</li>
</ul>
<p class="normal">Finally, let’s add some environment variables to our CircleCI.</p>
<h2 class="heading-2" id="_idParaDest-310">Creating environment variables variables in CircleCI</h2>
<p class="normal">As you saw previously, we are using<a id="_idIndexMarker977"/> the <strong class="keyWord">$DROPLET_USER</strong> and <strong class="keyWord">$DROPLET_IP</strong> variables, but how<a id="_idIndexMarker978"/> do we define those? Follow these steps:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">You need to go to your project settings again and select the <strong class="keyWord">Environment Variables</strong> option. Then, you need to create the <code class="inlineCode">DROPLET_USER</code> variable:</li>
</ol>
<figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" height="412" src="../Images/B18414_17_35.png" width="759"/></figure>
<p class="packt_figref">Figure 17.35: Add Environment Variable</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="2">Then, you need to create the <strong class="keyWord">DROPLET_IP</strong> variable using your Droplet IP:</li>
</ol>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" height="565" src="../Images/B18414_17_36.png" width="695"/></figure>
<p class="packt_figref">Figure 17.36: DROPLET_IP</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3">Now, you need to push the config file to your repository, and you will be ready<a id="_idIndexMarker979"/> for the magic. Now that CircleCI is connected to your repository, every time<a id="_idIndexMarker980"/> you push changes to master, it will fire a build.

    <p class="normal">Normally, the first two or three builds can fail due to syntax errors, indent errors in our config, or maybe because we have linter errors or unit test errors. If you have a failure, you will see something like this:</p>
<figure class="mediaobject"><img alt="Text  Description automatically generated with medium confidence" height="153" src="../Images/B18414_17_37.png" width="759"/></figure>
<p class="packt_figref">Figure 17.37: Build error</p>
</li></ol> <ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4">As you can see from the preceding screenshot, the first build failures at the bottom say <strong class="screenText">Build Error</strong>, and the second one says <code class="inlineCode">build-deploy</code> under WORKFLOW, as shown in <em class="italic">Figure 17.38</em>. This basically means that in the first build, I had a syntax error in the <code class="inlineCode">config.yml</code> file.</li>
<li class="numberedList">After you fix all the syntax<a id="_idIndexMarker981"/> errors in the <code class="inlineCode">config.yml</code> file<a id="_idIndexMarker982"/> and all the issues with the linter or the unit tests, you should see a <strong class="screenText">Success</strong> build like this:</li>
</ol>
<figure class="mediaobject"><img alt="" height="87" src="../Images/B18414_17_38.png" width="759"/></figure>
<p class="packt_figref">Figure 17.38: SUCCESS build</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="6">If you click on the build number, you can see all the steps that CircleCI executed before publishing the new changes in your Droplet:</li>
</ol>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" height="295" src="../Images/B18414_17_39.png" width="759"/></figure>
<p class="packt_figref">Figure 17.39: Steps executed by CircleCI</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="7">As you can see, the order of the steps is the same as we specified in our <code class="inlineCode">config.yml</code> file; you can even see the output of each step by clicking on it:</li>
</ol>
<figure class="mediaobject"><img alt="Graphical user interface, text  Description automatically generated" height="535" src="../Images/B18414_17_40.png" width="753"/></figure>
<p class="packt_figref">Figure 17.40: Lint and test steps</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="8">Now, let’s suppose you have<a id="_idIndexMarker983"/> an error on your linter validation<a id="_idIndexMarker984"/> or in some unit tests. Let’s see what happens in that case, as follows:</li>
</ol>
<figure class="mediaobject"><img alt="Text  Description automatically generated" height="650" src="../Images/B18414_17_41.png" width="761"/></figure>
<p class="packt_figref">Figure 17.41: Linter error</p>
<p class="normal">As you can see, once an error<a id="_idIndexMarker985"/> is detected, it will exit with code <code class="inlineCode">1</code>. This means<a id="_idIndexMarker986"/> it will abort the deployment and mark it as a failure. Notice that none of the steps after <code class="inlineCode">npm run lint</code> are executed.</p>
<p class="normal">Another cool thing is that if you now go to your GitHub repository and check your commits, you will see all the commits that had a successful build and all the commits that had a failed build:</p>
<p class="packt_figref"><img alt="Graphical user interface, application  Description automatically generated" height="276" src="../Images/B18414_17_42.png" width="401"/></p>
<p class="packt_figref">Figure 17.42: GitHub successful build</p>
<p class="normal">This is amazing: now you have your project<a id="_idIndexMarker987"/> configured to do deployments<a id="_idIndexMarker988"/> automatically, and it is connected to your GitHub repository.</p>
<h1 class="heading-1" id="_idParaDest-311">Summary</h1>
<p class="normal">Congratulations! We’ve reached the end of our journey through the deployment process, and you now have the knowledge and skills needed to deploy your React application to the world (production). You’ve also learned how to implement CircleCI for continuous integration, streamlining your development process and ensuring that your application remains performant and reliable.</p>
<p class="normal">By leveraging the strategies and best practices outlined in this chapter, you can confidently launch your application to a global audience, secure in the knowledge that it has been optimized for speed, scalability, and resilience. Thank you for joining me on this journey. I hope you’ve enjoyed reading my book.</p>
</div>
</div></body></html>