<html><head></head><body>
        <section>

            <header>
                </header><h1 class="header-title" id="calibre_pb_0">The MongoDB Deployment on mLab</h1>
            

            <article>
                
<p class="calibre2">We have come to the point where we need to start planning the deployment of our application. We have chosen MongoDB as our database. There are different approaches of using it for scaling--you can do everything on your own with your own servers (more time consuming and demanding) or you can use services that do replications/scaling for you, such as Database-as-a-Service providers.</p>
<p class="calibre2">In this chapter, we will cover the following topics:</p>
<ul class="calibre14">
<li class="calibre15">Creating an mLab account and creating a new MongoDB deployment</li>
<li class="calibre15">How a replica set works in MongoDB and how you can use it within mLab</li>
<li class="calibre15">Testing the replica set on a live demo (flip-flop from mLab)</li>
<li class="calibre15">Setting up the database user and password</li>
<li class="calibre15">Learning about what you need to prepare for deployment on AWS EC2</li>
</ul>


            </article>

            <footer class="calibre4">
                
            </footer>

        </section>
    

        <section>

            <header>
                </header><h1 class="header-title" id="calibre_pb_0">mLab overview </h1>
            

            <article>
                
<p class="calibre2">We will use mLab in our case in order to spend less time configuring the low-level stuff on MongoDB and more time building a robust scalable application.</p>
<p class="calibre2">If we go to <a href="http://www.mLab.com" class="calibre6"><span>www.mLab.com</span></a>, there is a free DB plan (that we will use in this chapter) and a paid DB plan:</p>
<div class="packt_figure"><img class="image-border79" src="../images/00084.jpeg"/></div>
<p class="calibre2">In general, mLab provides several interesting features such as the following:</p>
<ul class="calibre14">
<li class="calibre15"><strong class="calibre1">Tools for cloud automation</strong>: These provide on-demand provisioning (preparing) on AWS, Azure, or Google; replica sets (described in detail later in this chapter); and <strong class="calibre1">sharded clusters</strong>. These also provide seamless, zero-downtime scaling, and high availability via automatic failover.</li>
<li class="calibre15"><strong class="calibre1">Tools for backup and recovery</strong>: These provide automatic backups, which can help in later project stages in case of an emergency.</li>
<li class="calibre15"><strong class="calibre1">Tools for monitoring and alerts</strong>: For example, there is a <strong class="calibre1">slow queries</strong> tool that helps you to find slow queries, which can be optimized by adding an index.</li>
<li class="calibre15"><strong class="calibre1">Tools for online data browsing</strong>: You can browse the MongoDB's collection via the browser when you are logged into mLab's administration panel.</li>
</ul>


            </article>

            <footer class="calibre4">
                
            </footer>

        </section>
    

        <section>

            <header>
                </header><h1 class="header-title" id="calibre_pb_0">Replica set connections and high availability</h1>
            

            <article>
                
<p class="calibre2">In MongoDB, there is a feature that ensures high availability using automatic failover. In short, failover is a feature that ensures that if a primary server (that has the most important copy of your database) fails, then a secondary member's database becomes the primary one if the original primary server is unavailable.</p>
<p class="calibre2">A secondary member's database is a server that keeps the so-called <strong class="calibre1">read-only backup</strong> of your database.</p>
<p class="calibre2">The primary and the secondary databases very often replicate themselves in order to be in sync all the time. The secondary server is mostly for read operations.</p>
<p class="calibre2">This whole replica set feature is quite time-consuming to implement from scratch (without mLab), but mLab provides this feature in order to <em class="calibre21">abstract</em> this part so that our whole process will be more automated.</p>


            </article>

            <footer class="calibre4">
                
            </footer>

        </section>
    

        <section>

            <header>
                </header><h1 class="header-title" id="calibre_pb_0">MongoDB failover</h1>
            

            <article>
                
<p class="calibre2">mLab also provides a great tool for testing the failover scenario in our app, which is available at <a href="http://flip-flop.mlab.com" class="calibre6"><span>http://flip-flop.mlab.com</span></a>.</p>
<div class="packt_figure"><img class="image-border80" src="../images/00085.jpeg"/></div>
<p class="calibre2">Here, we can test how automatic failover with the MongoDB replica set works. As we can see in the preceding screenshot, there are three nodes: the replica's <strong class="calibre1">flip</strong> and <strong class="calibre1">flop</strong>, and an arbiter. In the flip-flop's demo, you can connect to the arbiter server, and the primary server will step down and the cluster will failover to the other node. You can experiment with it--try on your own and have fun!</p>
<p class="calibre2">You can find more documentation on how to play with the flip-flop's demo at <a href="http://docs.mlab.com/connecting/#replica-set-connections" class="calibre6"><span>http://docs.mlab.com/connecting/#replica-set-connections</span></a>.</p>


            </article>

            <footer class="calibre4">
                
            </footer>

        </section>
    

        <section>

            <header>
                </header><h1 class="header-title" id="calibre_pb_0">Free versus paid plan in mLab</h1>
            

            <article>
                
<p class="calibre2">In this book, we will guide you through the process of using mLab with a free plan. In mLab, the replica set is available in the paid plans (starting at $15/month), and, of course, you can use the flip-flop's demo for free in order to play with that very important feature of MongoDB.</p>


            </article>

            <footer class="calibre4">
                
            </footer>

        </section>
    

        <section>

            <header>
                </header><h1 class="header-title" id="calibre_pb_0">The new mLab's account and node </h1>
            

            <article>
                
<ol class="calibre17">
<li value="1" class="calibre15">Go to <a href="https://mlab.com/signup/" class="calibre6"><span>https://mlab.com/signup/</span></a>, as shown in the following screenshot:</li>
</ol>
<div class="packt_figure"><img class="image-border81" src="../images/00086.jpeg"/></div>
<ol start="2" class="calibre17">
<li value="2" class="calibre15">Verify your e-mail by clicking on the confirm link in your inbox.</li>
<li value="3" class="calibre15">Click on the <span>Create new</span> button, as shown in the following screenshot:</li>
</ol>
<div class="packt_figure"><img class="image-border82" src="../images/00087.jpeg"/></div>
<ol start="4" class="calibre17">
<li value="4" class="calibre15">You are on the <span>Create new deployment</span> page. Choose <span>Single-node</span> | <span>Sandbox (FREE)</span>, as shown in the following screenshot:</li>
</ol>
<div class="packt_figure"><img class="image-border83" src="../images/00088.jpeg"/></div>
<ol start="5" class="calibre17">
<li value="5" class="calibre15">While you are still at <a href="https://mlab.com/create" class="calibre6"><span>https://mlab.com/create</span></a> (<span>Create new deployment</span>), set the database name as <kbd class="calibre11">publishingapp</kbd> and click on the <span>Create new MongoDB deployment</span> button, as shown in the next screenshot:</li>
</ol>
<div class="packt_figure"><img class="image-border84" src="../images/00089.jpeg"/></div>
<ol start="6" class="calibre17">
<li value="6" class="calibre15">After following the preceding steps, you should be able to find the MongoDB deployment on the dashboard (<a href="https://mlab.com/home" class="calibre6"><span>https://mlab.com/home</span></a>), as shown in the following screenshot:</li>
</ol>
<div class="packt_figure"><img class="image-border85" src="../images/00090.jpeg"/></div>


            </article>

            <footer class="calibre4">
                
            </footer>

        </section>
    

        <section>

            <header>
                </header><h1 class="header-title" id="calibre_pb_0">Creating the database's user/password and other configurations</h1>
            

            <article>
                
<p class="calibre2">Right now, the database is ready for our publishing application, but it's still empty.</p>
<p class="calibre2">There are steps that we need to take in order to use it:</p>
<ol class="calibre17">
<li value="1" class="calibre15">Create a user/password combination. We need to click on the database that has been just created and find a tab called <span>Users</span>. After you click on it, click on the <span>Add new database</span> user button and then fill in the details on the form, as shown in the following screenshot:</li>
</ol>
<div class="packt_figure"><img class="image-border86" src="../images/00091.jpeg"/></div>
<ol start="2" class="calibre17">
<li value="2" class="calibre15">Let's assume for this book that our details are as follows:</li>
</ol>
<p class="calibre29">DB username: <kbd class="calibre11">usermlab</kbd></p>
<p class="calibre29">DB password: <kbd class="calibre11">pwdmlab</kbd></p>
<p class="calibre29">In the places where we will use the username and password, I will use these details.</p>
<ol start="3" class="calibre17">
<li value="3" class="calibre15">After that, we need to create the collections that are identical to our local MongoDB:</li>
</ol>
<div class="calibre30"><span>Collections</span> | <span>Add collection</span> | <span>articles</span></div>
<div class="calibre30"><span>Collections</span> | <span>Add collection</span> | <span>pubUsers</span></div>
<ol start="4" class="calibre17">
<li value="4" class="calibre15">After performing all the preceding steps, you should see something like the following screenshot:</li>
</ol>
<div class="packt_figure"><img class="image-border87" src="../images/00092.jpeg"/></div>
<ol start="5" class="calibre17">
<li value="5" class="calibre15">At this stage, the last thing is to write down the Mongo details from the following screenshot:</li>
</ol>
<div class="packt_figure"><img class="image-border88" src="../images/00093.jpeg"/></div>


            </article>

            <footer class="calibre4">
                
            </footer>

        </section>
    

        <section>

            <header>
                </header><h1 class="header-title" id="calibre_pb_0">Config wrap up</h1>
            

            <article>
                
<p class="calibre2">We need to keep and share all the information from mLab along with the AWS S3 details. The details will be useful in the next chapter when deploying our app on Amazon AWS EC2.</p>
<p class="calibre2">At this point in the book, there are details that we need to keep separately:</p>
<pre class="calibre22">
AWS_ACCESS_KEY_ID=&lt;&lt;access-key-obtained-in-previous-chapter&gt;&gt;<br class="title-page-name"/>AWS_SECRET_ACCESS_KEY=&lt;&lt;secret-key-obtained-in-previous-chapter&gt;&gt;<br class="title-page-name"/>AWS_BUCKET_NAME=publishing-app<br class="title-page-name"/>AWS_REGION_NAME=eu-central-1<br class="title-page-name"/>MONGO_USER=usermlab<br class="title-page-name"/>MONGO_PASS=pwdmlab<br class="title-page-name"/>MONGO_PORT=&lt;&lt;port-from-your-mlab-node&gt;&gt;<br class="title-page-name"/>MONGO_ENV=publishingapp<br class="title-page-name"/>MONGO_HOSTNAME=&lt;&lt;hostname-from-your-mlab-node&gt;&gt;
</pre>
<p class="calibre2">Make sure, that you have replaced the ports and the hostname to the correct one (as provided by mLab in the preceding screenshot).</p>
<p class="calibre2">All the Mongo <kbd class="calibre11">env</kbd> variables can be obtained from mLab, where you can find a link similar to the following (this is an example copied from the account created while writing this chapter):</p>
<pre class="calibre22">
<strong class="calibre1">mongo ds025762.mlab.com:25762/publishingapp -u &lt;dbuser&gt; -p &lt;dbpassword&gt;</strong>
</pre>


            </article>

            <footer class="calibre4">
                
            </footer>

        </section>
    

        <section>

            <header>
                </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
            

            <article>
                
<p class="calibre2">In the next chapter, we will start using those environment variables on our production server on the AWS EC2's platform. Keep all these details noted in an easily accessible, safe place, as we will use them soon.</p>
<p class="calibre2">The last thing is to check if the app is running correctly and to use the remote mLab MongoDB (instead of the local MongoDB that was run with the <kbd class="calibre11">mongd</kbd> command). You can do this by running it with <kbd class="calibre11">npm start</kbd>, and then you shall see the empty home page of the publishing app. Because we moved away from the local database and the remote is empty, you need to register a new user and try to publish a new article with mLab under the hood to store the data.</p>


            </article>

            <footer class="calibre4">
                
            </footer>

        </section>
    </body></html>