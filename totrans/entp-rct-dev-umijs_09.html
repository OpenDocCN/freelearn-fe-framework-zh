<html><head></head><body>
		<div id="_idContainer070">
			<h1 id="_idParaDest-82"><a id="_idTextAnchor114"/>Chapter 7: Single-Page Application Deployment</h1>
			<p>In the previous chapter, we discussed software testing and how to write a test and apply it during the development process to prevent errors and improve the software quality.</p>
			<p>The last step in the software development life cycle is deploying the application to online services. In this chapter, we'll create a simple mock server as your application's backend using the open source <strong class="bold">Mockachino</strong> service. You will learn how to build the application and the compiled source code files generated by Umi. You'll also learn how to deploy and configure your application on <strong class="bold">AWS Amplify</strong>.</p>
			<p>In this chapter, we'll cover the following main topics:</p>
			<ul>
				<li>Creating a mock server with Mockachino</li>
				<li>Compiling the application and setting environment variables</li>
				<li><a id="_idTextAnchor115"/>Hosting the application on AWS Amplify</li>
			</ul>
			<p>By the end of this chapter, you'll have learned how to build the application and the compiled source code files generated by Umi. You'll also know how to use the Mockachino service to create a mock server quickly. You'll also have learned how to deploy and configure single-page applications on AWS Amplify.</p>
			<h1 id="_idParaDest-83"><a id="_idTextAnchor116"/>Technical requirements</h1>
			<p>To complete this chapter's exercises, you only need a computer with any OS (I recommend Ubuntu 20.04 or higher) and the software installed in <a id="_idTextAnchor117"/><a href="B18503_01_Final_JM_ePub.xhtml#_idTextAnchor014"><em class="italic">Chapter 1</em></a><em class="italic">, Environment Setup and Introduction to UmiJS</em> (VS Code, Node.js, and Yarn).</p>
			<p>You can find the complete project in the <strong class="source-inline">Chapter07</strong> folder in the GitHub repository available at <a href="https://github.com/PacktPublishing/Enterprise-React-Development-with-UmiJs">https://github.com/PacktPublishing/Enterprise-React-Development-with-UmiJs</a>.</p>
			<h1 id="_idParaDest-84"><a id="_idTextAnchor118"/>Creating a mock server with Mockachino</h1>
			<p>In this section, we'll create a mock server using Mockachino to simulate the application's backend services.</p>
			<p>Our<a id="_idIndexMarker364"/> application is only the presentation layer of the CRM system, where users can visualize and input data. Before deploying it, we need online backend services our application can connect with for processing, storing, and receiving data.</p>
			<p>The backend services are APIs and microservices implemented by backend developers to securely and efficiently apply business logic and store information such as opportunities, activities, customers, and user information.</p>
			<p>As the objective of this book is to teach React development with UmiJS, we won't build backend services. We'll use <strong class="bold">Mockachino</strong> to simulate the backend.</p>
			<p>Mockachino is <a id="_idIndexMarker365"/>a straightforward service for creating a mock server. We only need to define an endpoint, and Mockachino will provide a space and a secret link to access the space whenever necessary.</p>
			<p>Let's start by creating the route to retrieve user information. Navigate to <a href="https://www.mockachino.com/">https://www.mockachino.com/</a> and follow<a id="_idIndexMarker366"/> these steps:</p>
			<ol>
				<li>In the <strong class="bold">HTTP Path</strong> field, type <strong class="source-inline">api/currentUser</strong>.</li>
				<li>Next, in the <strong class="bold">HTTP Response Body</strong> field, type the following JSON response:<p class="source-code">{</p><p class="source-code">  "company": "Umi Group",</p><p class="source-code">  "name": "Marry Doe",</p><p class="source-code">  "role": {</p><p class="source-code">    "id": 0,</p><p class="source-code">    "title": "Administrator"</p><p class="source-code">  },</p><p class="source-code">  "isLoggedIn": "true",</p><p class="source-code">  "id": "1"</p><p class="source-code">}</p></li>
				<li>Click on <strong class="bold">Create</strong>, and Mockachino will provide a secret link, as shown in the following screenshot:</li>
			</ol>
			<div>
				<div id="_idContainer058" class="IMG---Figure">
					<img src="image/Figure_7.01_B18503.jpg" alt="Figure 7.1 – Mockachino space secret link&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.1 – Mockachino space secret link</p>
			<p>By clicking<a id="_idIndexMarker367"/> on the endpoint route (<strong class="bold">GET /api/currentUser</strong>), you can edit endpoint attributes such as the path, HTTP response headers, and response body.</p>
			<p>To create a new route, click on <strong class="bold">Add Another Route</strong> and fill the fields with the content available in the <strong class="source-inline">mockachino.md</strong> file.</p>
			<p>For your convenience, I've created a markdown file named <strong class="source-inline">mockachino.md</strong> in the <strong class="source-inline">Chapter07</strong> folder in this book's GitHub repository. In this file, you will find all the routes and the responses you must create in Mockachino before going through the upcoming sections.</p>
			<p>In this section, we created a mock server using Mockachino to simulate the backend services. Next, let's learn how to bundle the application and set environment variable<a id="_idTextAnchor119"/>s.</p>
			<h1 id="_idParaDest-85"><a id="_idTextAnchor120"/>Compiling the application and setting environment variables</h1>
			<p>In this section, you'll learn what files Umi will generate and how to compile the application. We'll also set an environment variable to configure the URL for sending HTTP requests.</p>
			<p>We need to<a id="_idIndexMarker368"/> transform and compile our components and dependencies into a format that web browsers can interpret and render before deploying the application.</p>
			<p>Run the <strong class="source-inline">yarn build</strong> command configured in our package scripts. This command will compile the application and place the compiled source code files in the <strong class="source-inline">dist</strong> folder.</p>
			<div>
				<div id="_idContainer059" class="IMG---Figure">
					<img src="image/Figure_7.02_B18503.jpg" alt="Figure 7.2 – Compiled source code files&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.2 – Compiled source code files</p>
			<p>You will find three files in the <strong class="source-inline">dist</strong> folder:</p>
			<ul>
				<li><strong class="source-inline">index.html</strong>: This is the HTML document containing the entry point for our application.</li>
				<li><strong class="source-inline">umi.css</strong>: This is the compressed style sheet containing all the application styles generated by LESS files present in the project.</li>
				<li><strong class="source-inline">umi.js</strong>: This is the compressed file containing all the JavaScript code required to execute our application.</li>
			</ul>
			<p>Now, we <a id="_idIndexMarker369"/>need to host these files on a static server on the internet. When users navigate to the server's public address, the browser will request and receive the <strong class="source-inline">index.html</strong> document, the entry point for our application. We'll host our application on Amplify in the next section.</p>
			<p>Now, let's adjust your application to send requests to Mockachino.</p>
			<h2 id="_idParaDest-86"><a id="_idTextAnchor121"/>Configuring the API URL environment variable</h2>
			<p>As <a id="_idIndexMarker370"/>mentioned earlier, we don't have a mock server running alongside our application in production. We'll send HTTP requests to Mockachino, so we need to change the URL argument in all functions in the <strong class="source-inline">services</strong> folder. We'll do that by configuring an environment variable.</p>
			<p>Umi can read<a id="_idIndexMarker371"/> environment variables during the build process and use their values in our application; we only need to set the Umi <strong class="source-inline">define</strong> configuration option.</p>
			<p>Let's create an environment variable to set the API URL by following these steps:</p>
			<ol>
				<li value="1">Create a new file named <strong class="source-inline">.env</strong> in the project's root folder and create a variable called <strong class="source-inline">API_URL</strong> as follows:<p class="source-code"><strong class="bold">API_URL=https://www.mockachino.com/secret</strong></p></li>
			</ol>
			<p>Replace the value with the URL provided by Mockachino.</p>
			<ol>
				<li value="2">Add the <strong class="source-inline">define</strong> option to the configuration in the <strong class="source-inline">config.ts</strong> file as follows:<p class="source-code"><strong class="bold">define: {</strong></p><p class="source-code">   <strong class="bold">API_URL: process.env.API_HOST,</strong></p><p class="source-code"><strong class="bold">},</strong></p></li>
			</ol>
			<p>This configuration defines the <strong class="source-inline">API_URL</strong> variable in the project.</p>
			<ol>
				<li value="3">Now, let's create a file to export the variable and prevent TypeScript warnings. Create a new file called <strong class="source-inline">env.ts</strong> in the <strong class="source-inline">config</strong> folder and export the variable as follows:<p class="source-code"><strong class="bold">// @ts-nocheck</strong></p><p class="source-code"><strong class="bold">export default {</strong></p><p class="source-code">  <strong class="bold">API_URL: API_URL,</strong></p><p class="source-code"><strong class="bold">};</strong></p></li>
				<li>In the <strong class="source-inline">user.ts</strong> file in the <strong class="source-inline">src/services</strong> folder, import the <strong class="source-inline">env.ts</strong> file as follows:<p class="source-code"><strong class="bold">import env from '../../config/env';</strong></p></li>
				<li>Next, add<a id="_idIndexMarker372"/> <strong class="source-inline">API_URL</strong> to the first argument of the <strong class="source-inline">request</strong> function as follows:<p class="source-code">return request&lt;User&gt;(`<strong class="bold">${env.API_URL}</strong>/api/currentUser`, {</p><p class="source-code">  method: 'GET',</p><p class="source-code">  headers: { 'Content-Type': 'application/json' },</p><p class="source-code">  params: { context: contextId },</p><p class="source-code">});</p></li>
			</ol>
			<p>Follow the last <a id="_idIndexMarker373"/>two steps to change all the <strong class="source-inline">request</strong> functions in all files in the <strong class="source-inline">services</strong> folder.</p>
			<p>In this section, you learned how to compile our application's source code files and what files Umi generates during the build process. We also created an environment variable and changed the requests to use Mockachino as the backend.</p>
			<p>Now, we'll host our application on AWS using the Amplify Console services.</p>
			<h1 id="_idParaDest-87"><a id="_idTextAnchor122"/>Hosting the application on AWS Amplify</h1>
			<p>In this section, you'll learn how to <a id="_idIndexMarker374"/>deploy and configure single-page applications on <strong class="bold">Amazon Web Services</strong> (<strong class="bold">AWS</strong>) by hosting our application using Amplify Console.</p>
			<p><strong class="bold">AWS Amplify</strong> is<a id="_idIndexMarker375"/> a flexible set of tools for web and mobile frontend developers to create and deploy applications on AWS using various services. With Amplify, you can quickly build and deploy a full stack application without having to research and learn individual AWS services.</p>
			<p>We'll use Amplify<a id="_idIndexMarker376"/> only to host our application, but you can create backend services and add authentication, artificial intelligence, machine learning, and more using the Amplify framework and Amplify Studio. If you want to know more, visit the framework's documentation page<a id="_idIndexMarker377"/> at <a href="https://docs.amplify.aws/">https://docs.amplify.aws/</a>.</p>
			<p>Before proceeding to the following steps, you need to push the project to a new repository in your personal GitHub account. </p>
			<p>Also, you need to create a free AWS account. Visit <a href="https://aws.amazon.com/free">https://aws.amazon.com/free</a>, click on <strong class="bold">Create a Free Account</strong>, and fill in the form with the required information to create your account.</p>
			<p>Now, after pushing the code to a new repository and creating your AWS account, follow these steps to host our application on Amplify:</p>
			<ol>
				<li value="1">Navigate to <a href="http://console.aws.amazon.com/amplify/home">http://console.aws.amazon.com/amplify/home</a> and sign in to your AWS account.</li>
				<li>Click on the menu highlighted in the following screenshot and, after that, click on <strong class="bold">All apps</strong>:</li>
			</ol>
			<div>
				<div id="_idContainer060" class="IMG---Figure">
					<img src="image/Figure_7.03_B18503.jpg" alt="Figure 7.3 – Left-side menu&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.3 – Left-side menu</p>
			<ol>
				<li value="3">At the<a id="_idIndexMarker378"/> top <a id="_idIndexMarker379"/>right of the page, click on the <strong class="bold">New app</strong> dropdown and select <strong class="bold">Host web app</strong>:</li>
			</ol>
			<div>
				<div id="_idContainer061" class="IMG---Figure">
					<img src="image/Figure_7.04_B18503.jpg" alt="Figure 7.4 – Host web app option&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.4 – Host web app option</p>
			<ol>
				<li value="4">Now, select <strong class="bold">GitHub</strong> in the <strong class="bold">From your existing code</strong> section, click on <strong class="bold">Continue</strong>, and <a id="_idIndexMarker380"/>sign in to your GitHub<a id="_idIndexMarker381"/> account:</li>
			</ol>
			<div>
				<div id="_idContainer062" class="IMG---Figure">
					<img src="image/Figure_7.05_B18503.jpg" alt="Figure 7.5 – Selecting a source Git provider&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.5 – Selecting a source Git provider</p>
			<ol>
				<li value="5">Next, select<a id="_idIndexMarker382"/> the repository you created <a id="_idIndexMarker383"/>for our project and click on <strong class="bold">Next</strong>:</li>
			</ol>
			<div>
				<div id="_idContainer063" class="IMG---Figure">
					<img src="image/Figure_7.06_B18503.jpg" alt="Figure 7.6 – Selecting a GitHub repository&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.6 – Selecting a GitHub repository</p>
			<ol>
				<li value="6">In <strong class="bold">Step 2 Configure build settings</strong>, in the <strong class="bold">Build and test settings</strong> section, click <a id="_idIndexMarker384"/>on <strong class="bold">Edit</strong>, modify line 12 as follows, and <a id="_idIndexMarker385"/>click on <strong class="bold">Save</strong>:<p class="source-code"><strong class="bold">baseDirectory: /dist</strong></p></li>
			</ol>
			<p>This configuration will set where Amplify looks for source code when running the automated pipeline.</p>
			<div>
				<div id="_idContainer064" class="IMG---Figure">
					<img src="image/Figure_7.07_B18503.jpg" alt="Figure 7.7 – Configuring the source code base directory&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.7 – Configuring the source code base directory</p>
			<ol>
				<li value="7">Click<a id="_idIndexMarker386"/> on <strong class="bold">Advanced settings</strong> and, in the <strong class="bold">Environment variables</strong> section, create a <a id="_idIndexMarker387"/>new variable. In the <strong class="bold">Key</strong> field, type <strong class="source-inline">API_URL</strong>, and then paste the Mockachino secret link in the <strong class="bold">Value</strong> field:</li>
			</ol>
			<div>
				<div id="_idContainer065" class="IMG---Figure">
					<img src="image/Figure_7.08_B18503.jpg" alt="Figure 7.8 – Creating environment variables&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.8 – Creating environment variables</p>
			<ol>
				<li value="8">Now, click<a id="_idIndexMarker388"/> on <strong class="bold">Next</strong> and, in<a id="_idIndexMarker389"/> the next step, review the configurations and click on <strong class="bold">Save and deploy</strong>:</li>
			</ol>
			<div>
				<div id="_idContainer066" class="IMG---Figure">
					<img src="image/Figure_7.09_B18503.jpg" alt="Figure 7.9 – Reviewing and deploying the application&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.9 – Reviewing and deploying the application</p>
			<ol>
				<li value="9">Wait for <a id="_idIndexMarker390"/>the pipeline to succeed and click on<a id="_idIndexMarker391"/> the public address to access the application:</li>
			</ol>
			<div>
				<div id="_idContainer067" class="IMG---Figure">
					<img src="image/Figure_7.10_B18503.jpg" alt="Figure 7.10 – Application public address&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.10 – Application public address</p>
			<p>Now, let's take a <a id="_idIndexMarker392"/>closer look at more Amplify settings.</p>
			<h2 id="_idParaDest-88"><a id="_idTextAnchor123"/>Understanding more Amplify settings</h2>
			<p>When hosting<a id="_idIndexMarker393"/> a single-page application, it is necessary to configure the server to only respond to requests with the <strong class="source-inline">index.html</strong> page; otherwise, the server will respond with an error as other pages do not exist on the server.</p>
			<p>Amplify <a id="_idIndexMarker394"/>provides a default routing rule in the <strong class="bold">Rewrites and redirects</strong> configuration. The default rule routes all our application paths to the <strong class="source-inline">index.html</strong> file.</p>
			<div>
				<div id="_idContainer068" class="IMG---Figure">
					<img src="image/Figure_7.11_B18503.jpg" alt="Figure 7.11 – Rewrites and redirects configuration&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.11 – Rewrites and redirects configuration</p>
			<p>Amplify also<a id="_idIndexMarker395"/> provides a public address on the <strong class="source-inline">amplifyapp</strong> domain, but you can easily add your custom domain by accessing <strong class="bold">Domain management</strong> in the left-side menu.</p>
			<p>The domain can be<a id="_idIndexMarker396"/> from a hosted zone on AWS Route 53 or other providers, and AWS also provides a free SSL certificate to secure your application's domain.</p>
			<div>
				<div id="_idContainer069" class="IMG---Figure">
					<img src="image/Figure_7.12_B18503.jpg" alt="Figure 7.12 – Amplify Domain management"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.12 – Amplify Domain management</p>
			<p>In this section, you created a free AWS account and hosted your application on AWS by connecting Amplify with the repository in your GitHub account. You also learned how to configure rewrites and redirects and manage your custom domain on the Amplify Console.</p>
			<h1 id="_idParaDest-89"><a id="_idTextAnchor124"/>Summary</h1>
			<p>In this chapter, we created a mock server for our application using Mockachino, an open source project for quickly mocking servers. You also learned what files Umi generates during the build process for browsers to interpret and render the application. You created an environment variable to define the URL our application will use to send requests.</p>
			<p>You learned how to push your application to a repository in your personal GitHub account and created a free AWS account. Next, you hosted your application on AWS by connecting AWS Amplify to your GitHub repository. You also learned how to configure rewrites and redirects, and manage your custom domains on the Amplify Console.</p>
			<p>I hope this book has helped you learn how to use UmiJS combined with Ant Design to create robust and professional React applications that provide a great user experience. Keep practicing and exploring the techniques you've learned from this book.</p>
		</div>
	</body></html>